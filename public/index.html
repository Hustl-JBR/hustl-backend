
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Deployment: cdaa602 - Active job card improvements: start code display, button styles -->
  
  <!-- SEO: Primary Meta Tags -->
  <title>Hustl Jobs – Fast Local Help for Moving, Yard Work & More in Tennessee</title>
  <meta name="title" content="Hustl Jobs – Fast Local Help for Moving, Yard Work & More in Tennessee" />
  <meta name="description" content="Find local help fast for moving, mulching, power washing, junk removal, yard work, and more. Hire or get hired instantly anywhere in Tennessee through Hustl. Serving Knoxville, Nashville, Chattanooga, Memphis and all of TN." />
  <meta name="keywords" content="hustl, hustl jobs, hustl tennessee, hustl moving, moving help tennessee, yard work tennessee, dump runs near me, hire help knoxville, local jobs tennessee, hustler jobs knoxville, moving knoxville, power washing tennessee, junk removal TN, mulching service, handyman tennessee, local help near me, gig jobs tennessee, same day help, moving help nashville, yard work knoxville" />
  <meta name="author" content="Hustl Jobs" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow" />
  <link rel="canonical" href="https://hustljobs.com/" />
  
  <!-- SEO: Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://hustljobs.com/" />
  <meta property="og:title" content="Hustl Jobs – Fast Local Help for Moving, Yard Work & More in Tennessee" />
  <meta property="og:description" content="Find local help fast for moving, mulching, power washing, junk removal, yard work, and more. Hire or get hired instantly anywhere in Tennessee." />
  <meta property="og:image" content="https://hustljobs.com/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Hustl Jobs" />
  <meta property="og:locale" content="en_US" />
  
  <!-- SEO: Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://hustljobs.com/" />
  <meta name="twitter:title" content="Hustl Jobs – Fast Local Help in Tennessee" />
  <meta name="twitter:description" content="Find local help fast for moving, yard work, power washing & more. Hire or get hired instantly across Tennessee." />
  <meta name="twitter:image" content="https://hustljobs.com/og-image.png" />
  
  <!-- SEO: Favicon & App Icons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  <!-- SEO: Geographic targeting -->
  <meta name="geo.region" content="US-TN" />
  <meta name="geo.placename" content="Tennessee" />
  
  <!-- Mobile App Experience -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Hustl" />
  <meta name="application-name" content="Hustl Jobs" />
  <meta name="theme-color" content="#2563eb" />
  
  <!-- Performance: Preconnect to external resources -->
  <link rel="preconnect" href="https://hustl-production.up.railway.app" crossorigin />
  <link rel="dns-prefetch" href="https://hustl-production.up.railway.app" />
  
  <!-- SEO: LocalBusiness Schema Markup -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": "Hustl Jobs",
    "description": "On-demand local help marketplace for moving, yard work, power washing, junk removal, and more across Tennessee.",
    "url": "https://hustljobs.com",
    "logo": "https://hustljobs.com/logo.png",
    "image": "https://hustljobs.com/og-image.png",
    "telephone": "",
    "address": {
      "@type": "PostalAddress",
      "addressRegion": "TN",
      "addressCountry": "US"
    },
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": "35.5175",
      "longitude": "-86.5804"
    },
    "areaServed": [
      {
        "@type": "State",
        "name": "Tennessee"
      },
      {
        "@type": "City",
        "name": "Knoxville"
      },
      {
        "@type": "City",
        "name": "Nashville"
      },
      {
        "@type": "City",
        "name": "Chattanooga"
      },
      {
        "@type": "City",
        "name": "Memphis"
      }
    ],
    "priceRange": "$$",
    "openingHoursSpecification": {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
      "opens": "00:00",
      "closes": "23:59"
    },
    "sameAs": []
  }
  </script>
  
  <!-- SEO: WebSite Schema for Sitelinks -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Hustl Jobs",
    "url": "https://hustljobs.com",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://hustljobs.com/?search={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  
  <!-- SEO: Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Hustl Jobs",
    "url": "https://hustljobs.com",
    "logo": "https://hustljobs.com/logo.png",
    "description": "Tennessee's local help marketplace for moving, yard work, and more.",
    "foundingLocation": {
      "@type": "Place",
      "name": "Tennessee, USA"
    },
    "slogan": "Local help, real hustle"
  }
  </script>
  
  <!-- Mobile Optimizations CSS (load early for faster paint) -->
  <link rel="stylesheet" href="mobile-optimizations.css" />
  
  <!-- Preload critical scripts -->
  <link rel="modulepreload" href="app-core.js" />
  <link rel="modulepreload" href="mobile-core.js" />
  <style>
    :root {
      /* Clean Blue Light Theme */
      --bg: #f0f7ff;
      --bg-light: #ffffff;
      --card: rgba(255, 255, 255, 0.95);
      --card-solid: #ffffff;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.1);
      --primary-dark: #1d4ed8;
      --primary-glow: rgba(37, 99, 235, 0.3);
      --accent: #0ea5e9;
      --accent-soft: rgba(14, 165, 233, 0.1);
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --danger: #dc2626;
      --danger-soft: #fef2f2;
      --success: #059669;
      --success-soft: #ecfdf5;
      --warning: #d97706;
      --warning-soft: #fffbeb;
      --radius: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 16px rgba(37, 99, 235, 0.1);
      --shadow-lg: 0 12px 40px rgba(37, 99, 235, 0.15);
      --shadow-glow: 0 0 60px var(--primary-glow);
      --glass: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(37, 99, 235, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, #eff6ff 0%, #f0f9ff 50%, #f8fafc 100%);
      color: var(--text-main);
      min-height: auto;
      height: auto;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse 100% 60% at 50% 0%, rgba(37, 99, 235, 0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: -1;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      cursor: pointer;
      font-family: inherit;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: auto;
      justify-content: flex-start;
    }
    
    /* When logged in, hide auth section completely */
    body.logged-in #authSection {
      display: none !important;
    }

    /* CLEAN MODERN HEADER */
    header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(37, 99, 235, 0.1);
      padding: 0.875rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 100 !important; /* Below mobile menu (10002) */
      margin-bottom: 0 !important;
    }
    
    /* Remove any spacing below header */
    header + * {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-mark {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 1.2rem;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.5), 0 0 30px rgba(14, 165, 233, 0.3);
      flex-shrink: 0;
    }

    .logo-text-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .logo-text-main {
      font-weight: 800;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      color: var(--text-main);
      white-space: nowrap;
    }

    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Desktop nav tabs */
    .nav-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .nav-tab:hover {
      color: var(--text-main);
      background: var(--primary-soft);
    }

    .nav-tab.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 2px 10px var(--primary-glow);
    }

    /* Header auth buttons */
    .header-auth {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn-login-header {
      padding: 0.625rem 1.25rem;
      border: 1.5px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-main);
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-login-header:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .btn-signup-header {
      padding: 0.625rem 1.5rem;
      border: none;
      background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      color: #fff;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4), 0 0 20px rgba(14, 165, 233, 0.2);
    }

    .btn-signup-header:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5), 0 0 30px rgba(14, 165, 233, 0.3);
    }

    /* HAMBURGER MENU */
    .hamburger-btn {
      display: none;
      width: 44px;
      height: 44px;
      border: 1.5px solid var(--border);
      background: #fff;
      border-radius: 8px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10001 !important; /* Above mobile menu and bottom nav */
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }
    
    .hamburger-btn:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
    }

    .hamburger-btn span {
      display: block;
      width: 18px;
      height: 2px;
      background: var(--text-main);
      border-radius: 1px;
      transition: all 0.3s ease;
      opacity: 1;
    }

    .hamburger-btn.open span:nth-child(1),
    .hamburger-btn.open span:nth-child(2),
    .hamburger-btn.open span:nth-child(3) {
      opacity: 0;
    }
    
    .hamburger-btn.open .hamburger-close {
      display: block !important;
    }

    /* Mobile menu overlay */
    .mobile-menu {
      display: none;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: #ffffff !important;
      z-index: 10002 !important; /* Above header (100), below hamburger button (10001) */
      padding: 0;
      padding-top: 70px !important; /* Space for header */
      padding-left: 1rem;
      padding-right: 1rem;
      padding-bottom: 2rem;
      flex-direction: column;
      gap: 0.25rem;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      overscroll-behavior: contain; /* Prevent scroll chaining */
    }
    
    /* Prevent body scroll when menu is open */
    body.mobile-menu-open {
      overflow: hidden !important;
      position: fixed;
      width: 100%;
    }

    .mobile-menu.open {
      display: flex;
    }
    
    /* Mobile menu header with close button */
    .mobile-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1rem 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
    }
    
    /* Close button for mobile menu - in header, right side */
    .mobile-menu-close {
      width: 40px !important;
      height: 40px !important;
      border-radius: 8px !important;
      background: #f3f4f6 !important;
      border: 1.5px solid #e5e7eb !important;
      font-size: 1.5rem !important;
      font-weight: 700 !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      color: #374151 !important;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      pointer-events: auto !important;
      line-height: 1;
      padding: 0;
      margin: 0;
      flex-shrink: 0;
    }
    
    .mobile-menu-close:hover,
    .mobile-menu-close:active {
      background: #e5e7eb !important;
      color: #111827 !important;
      border-color: #d1d5db !important;
      transform: scale(0.95);
    }
    
    /* Always show close button when menu is open */
    .mobile-menu.open .mobile-menu-close {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Menu items container */
    .mobile-menu-items {
      flex: 1;
      overflow-y: auto;
      padding: 0 1rem;
    }

    .mobile-menu-item {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      text-align: left;
      border-radius: var(--radius);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mobile-menu-item:hover,
    .mobile-menu-item.active {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .mobile-menu .header-auth {
      margin-top: auto;
      flex-direction: column;
      width: 100%;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .mobile-menu .btn-login-header,
    .mobile-menu .btn-signup-header {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      z-index: 1;
      position: relative;
      opacity: 1 !important;
      visibility: visible !important;
      display: block !important;
    }
    
    .mobile-menu .btn-signup-header {
      background: var(--primary) !important;
      color: white !important;
      font-weight: 600;
    }
    
    /* Sign Out button specific styling */
    .mobile-menu .btn-signup-header[onclick*="handleSignOut"],
    .mobile-menu .btn-signup-header[onclick*="SignOut"] {
      background: #fee2e2 !important;
      color: #dc2626 !important;
      border: 2px solid #fca5a5 !important;
      font-weight: 600;
    }
    
    .mobile-menu .btn-login-header {
      background: white !important;
      color: var(--primary) !important;
      border: 2px solid var(--primary) !important;
      font-weight: 600;
    }

    /* Hide old auth pill */
    .auth-pill {
      display: none;
    }

    main {
      flex: 0 1 auto;
      padding: 0;
      padding-bottom: 1rem;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* Post job view - ensure form is visible */
    #view-post #jobFormCard {
      margin-top: 0 !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: auto !important;
      height: auto !important;
    }
    
    /* Profile view specific - no extra top spacing */
    #view-profile {
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    #view-profile > *:first-child {
      margin-top: 0 !important;
    }
    
    /* Remove all top margins from profile elements */
    #view-profile .profile-basic-info {
      margin-top: 0 !important;
    }
    
    #view-profile .profile-quick-stats {
      margin-top: 0 !important;
    }
    
    #view-profile .profile-tabs {
      margin-top: 0 !important;
    }
    
    /* Post job view - start at top */
    #view-post {
      padding-top: 0 !important;
      margin-top: 0 !important;
      padding: 1rem;
      padding-top: 0 !important;
      padding-bottom: 2rem !important;
      margin-bottom: 0 !important;
      display: none; /* Default hidden */
    }
    
    /* When post view is active, make it visible */
    #view-post[style*="display: block"],
    #view-post[style*="display:block"],
    body.viewing-post #view-post {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    #view-post > *:first-child {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    #view-post .card {
      margin-top: 0 !important;
      margin-bottom: 0 !important;
    }
    
    /* Main content starts at top - no padding */
    body.viewing-post main {
      padding-top: 0 !important;
    }
    
    /* Add padding inside the view sections instead */
    #view-home,
    #view-jobs,
    #view-profile,
    #view-messages,
    #view-post,
    #view-manage-jobs,
    #view-owner {
      padding: 1rem;
      padding-top: 0 !important;
      margin-top: 0 !important;
      margin-bottom: 0 !important;
    }
    
    /* Ensure all views start at the very top with no spacing */
    [id^="view-"] {
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    /* Remove any spacing from first child of views */
    [id^="view-"] > *:first-child {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* Hide authSection properly when logged in or not on home */
    body.logged-in #authSection,
    #authSection[style*="display: none"] {
      display: none !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden !important;
      visibility: hidden !important;
    }
    
    /* Ensure main doesn't have extra padding when auth is hidden */
    body.logged-in main > #authSection {
      display: none !important;
    }
    
    /* Hide bottom sign up CTA when logged in */
    body.logged-in #homeBottomSignUpCTA {
      display: none !important;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 1rem;
    }

    /* CLEAN CARDS */
    .card {
      background: var(--card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(37, 99, 235, 0.25);
    }

    /* Jobs view toggle buttons */
    .jobs-view-toggle.active {
      background: white !important;
      color: #111827 !important;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1) !important;
    }
    
    .jobs-view-toggle:not(.active) {
      background: transparent !important;
      color: #6b7280 !important;
    }
    
    .jobs-view-toggle:hover {
      opacity: 0.8;
    }
    
    /* Map container */
    #jobsMapContainer {
      position: relative;
    }
    
    /* Job markers on map - simplified, stationary */
    .job-marker {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .job-marker:hover {
      opacity: 0.9;
    }

    /* Mobile responsive for hamburger */
    @media (max-width: 768px) {
      .nav-tabs {
        display: none !important;
      }

      .header-auth.desktop-only {
        display: none !important;
      }

      .hamburger-btn {
        display: flex !important;
        height: 2.25rem; /* Match nav tab height */
      }
      
      /* Make sort dropdown smaller on mobile so toggle fits */
      .sort-dropdown-container {
        min-width: 100px !important;
      }
      
      #jobsSortSelect {
        font-size: 0.75rem !important;
        padding: 0.4rem 0.5rem !important;
      }
      
      /* Hide footer on mobile */
      footer {
        display: none !important;
      }
      
      /* Map container on mobile */
      #jobsMapContainer {
        height: calc(100vh - 250px) !important;
        min-height: 400px !important;
      }
      
      /* Mobile layout fixes: Account for fixed header and bottom nav */
      /* Header is sticky, add padding to main to prevent content from being hidden */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      /* Ensure header stays fixed/sticky and doesn't overlap content */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }
      
      /* Add padding-bottom to all view sections to account for bottom nav */
      /* Bottom nav is typically 60-70px tall, using 80px for safe spacing */
      #view-home,
      #view-jobs,
      #view-profile,
      #view-messages,
      #view-post,
      #view-manage-jobs,
      #view-owner {
        padding-bottom: 80px !important;
      }
      
      /* Ensure main content can scroll properly and isn't cut off */
      main {
        position: relative;
        overflow-x: hidden;
      }
      
      /* Ensure content can scroll properly */
      body {
        overflow-x: hidden;
        position: relative;
      }
      
      /* If there's a fixed bottom nav, ensure it doesn't overlap content */
      /* This assumes bottom nav exists - if it's injected by JS, the padding above will handle it */
      
      /* Mobile: Reduce font sizes globally */
      h1 { font-size: 1.4rem !important; }
      h2 { font-size: 1.2rem !important; }
      h3 { font-size: 1.1rem !important; }
      
      /* Mobile: More compact spacing */
      .card {
        padding: 1rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .field {
        margin-bottom: 0.75rem !important;
      }
      
      /* Mobile: Optimize buttons */
      .btn {
        padding: 0.7rem 1rem !important;
        font-size: 0.85rem !important;
        min-height: 44px; /* Touch target */
      }
      
      /* Mobile: Compact labels */
      .field label {
        font-size: 0.85rem !important;
        margin-bottom: 0.4rem !important;
      }
      
      /* Mobile: Section titles */
      .section-title {
        font-size: 0.95rem !important;
        margin-bottom: 0.5rem !important;
      }
    }

    /* Floating animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    /* Auth Modal Popup */
    .auth-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .auth-modal-overlay.open {
      display: flex;
    }

    .auth-modal {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      padding: 2.5rem;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Checkbox styling */
    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      padding: 0;
      padding-left: 0 !important;
      margin-left: 0 !important;
      border-radius: 8px;
      transition: background-color 0.2s;
      cursor: pointer;
    }
    
    .checkbox-field:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }

    .checkbox-field input[type="checkbox"] {
      width: 16px;
      height: 16px;
      min-width: 16px;
      min-height: 16px;
      margin: 0;
      padding: 0;
      accent-color: var(--primary);
      cursor: pointer;
      flex-shrink: 0;
      -webkit-appearance: checkbox;
      -moz-appearance: checkbox;
      appearance: checkbox;
    }
    
    .checkbox-field label,
    .checkbox-field div,
    .checkbox-field span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Mobile: Touch-friendly checkboxes with minimal spacing */
    @media (max-width: 768px) {
      .checkbox-field {
        gap: 0.4rem;
        padding: 0.25rem 0 !important;
        padding-left: 0 !important;
        margin-left: 0 !important;
        margin-bottom: 0.4rem;
        align-items: center;
        min-height: 36px; /* Smaller but still touchable */
      }
      
      .checkbox-field input[type="checkbox"] {
        width: 16px;
        height: 16px;
        min-width: 16px;
        min-height: 16px;
        margin: 0;
        padding: 0;
        cursor: pointer;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
        flex-shrink: 0;
      }
      
      .checkbox-field label,
      .checkbox-field div,
      .checkbox-field span {
        font-size: 0.8rem;
        line-height: 1.3;
        padding: 0;
        margin: 0;
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      /* All checkboxes in forms - compact on mobile */
      input[type="checkbox"] {
        width: 16px !important;
        height: 16px !important;
        min-width: 16px !important;
        min-height: 16px !important;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Labels with checkboxes - minimal padding */
      label:has(input[type="checkbox"]),
      label.checkbox-field {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0 !important;
        padding-left: 0 !important;
        margin-left: 0 !important;
        min-height: 36px;
        cursor: pointer;
      }
      
      /* Remove extra padding from checkbox containers */
      .field:has(input[type="checkbox"]) {
        margin-bottom: 0.5rem !important;
        padding-left: 0 !important;
        margin-left: 0 !important;
      }
    }

    /* Mobile UI Fix: Reduce checkbox and selectable card sizes on small screens */
    @media (max-width: 640px) {
      /* Reduce checkbox sizes in selectable cards - applies to all equipment checkboxes including post job form */
      .equipment-checkbox input[type="checkbox"],
      label.equipment-checkbox input[type="checkbox"],
      label[class*="equipment-checkbox"] input[type="checkbox"],
      #equipmentContent input[type="checkbox"],
      #equipmentContent label input[type="checkbox"] {
        width: 16px !important;
        height: 16px !important;
        min-width: 16px !important;
        min-height: 16px !important;
      }

      /* Reduce padding in selectable card labels - applies to all equipment checkboxes */
      .equipment-checkbox,
      label.equipment-checkbox,
      label[class*="equipment-checkbox"],
      #equipmentContent label[class*="equipment-checkbox"] {
        padding: 0.4rem 0.5rem !important;
        gap: 0.35rem !important;
        font-size: 0.85rem !important;
      }
      
      /* Fix grid gap for equipment cards in post job */
      #equipmentContent div[style*="grid-template-columns"] {
        gap: 0.35rem !important;
      }

      /* Reduce checkbox sizes in all checkbox fields */
      .checkbox-field input[type="checkbox"] {
        width: 18px !important;
        height: 18px !important;
        min-width: 18px !important;
        min-height: 18px !important;
      }

      /* Reduce padding in checkbox fields */
      .checkbox-field {
        gap: 0.4rem !important;
        padding: 0 !important;
        margin-bottom: 0.5rem !important;
      }

      /* Ensure text stays centered in selectable cards */
      .equipment-checkbox span,
      label.equipment-checkbox span {
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        flex: 1;
      }

      /* Reduce grid gap for equipment cards */
      div[style*="grid-template-columns"] {
        gap: 0.35rem !important;
      }

      /* Fix any other selectable cards with checkboxes */
      label[class*="checkbox"],
      label[style*="display: flex"][style*="align-items: center"] {
        padding: 0.4rem 0.5rem !important;
      }

      label[class*="checkbox"] input[type="checkbox"],
      label[style*="display: flex"] input[type="checkbox"] {
        width: 16px !important;
        height: 16px !important;
        min-width: 16px !important;
        min-height: 16px !important;
      }
    }

    .checkbox-field label {
      font-size: 0.875rem;
      line-height: 1.5;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      flex: 1;
      color: var(--text-muted);
      margin: 0;
      padding: 0;
    }
    
    /* Make entire checkbox field tappable */
    .checkbox-field label,
    .checkbox-field input[type="checkbox"] {
      pointer-events: auto;
    }

    .checkbox-field a {
      color: var(--primary);
      text-decoration: underline;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 8px;
      padding: 0.35rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      border: none;
      color: var(--text-muted);
      background: var(--border-light);
    }

    .badge.hot {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #dc2626;
    }

    .badge.status-open {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      color: #059669;
    }

    .badge.status-assigned {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--primary);
    }

    .badge.status-completed {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      color: #7c3aed;
    }
    
    .badge.status-in-progress {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: #d97706;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .hero-heading {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #0ea5e9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .hero-sub {
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .hero-cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      justify-content: center;
    }

    .btn {
      border-radius: 12px;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4), 0 0 20px rgba(14, 165, 233, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5), 0 0 40px rgba(14, 165, 233, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border);
      color: var(--text-main);
      backdrop-filter: blur(10px);
    }
    
    .btn-ghost:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }

    .step-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .step-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.8);
      padding: 1.25rem;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      font-size: 0.875rem;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .step-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .step-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .step-card:hover::before {
      opacity: 1;
    }

    .step-title {
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: var(--primary);
    }

    .step-emoji {
      display: block;
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .pill {
      border-radius: 20px;
      padding: 0.4rem 0.875rem;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.6);
      transition: all 0.2s ease;
    }
    
    .pill:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--primary-soft);
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .field {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-main);
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1.5px solid var(--border);
      padding: 0.875rem 1rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: #fff;
      color: var(--text-main);
      transition: all 0.2s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
      background: #fff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
      color: var(--text-main);
    }

    select option {
      background: #fff;
      color: var(--text-main);
    }

    .field-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }

    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    /* Only add scrollbar when there's content - use class instead of :has() for better compatibility */
    .jobs-list.has-content {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    .job-card {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 0.85rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      gap: 0;
      margin-bottom: 0.85rem;
    }

    .job-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .job-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.25rem;
    }

    .job-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .job-meta {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
    }
    
    @media (max-width: 768px) {
      .job-card {
        padding: 0.9rem;
        margin-bottom: 0.9rem;
        border-radius: 10px;
      }
      
      .job-title {
        font-size: 1.05rem;
        padding-right: 4.5rem !important;
        line-height: 1.3;
      }
      
      .job-card-price {
        font-size: 1rem !important;
        top: 0.8rem !important;
        right: 0.8rem !important;
      }
      
      .job-meta {
        font-size: 0.88rem;
      }
    }

    .job-card-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .small-btn {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
    }

    .small-btn.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease;
      pointer-events: auto !important; /* Ensure overlay is clickable */
    }
    

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg);
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
      }
      
      .modal-content {
        max-width: 100%;
        max-height: 95vh;
        border-radius: 16px 16px 0 0;
        animation: slideUpMobile 0.3s ease;
      }
      
      @keyframes slideUpMobile {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Smooth page transitions */
    [id^="view-"] {
      animation: fadeIn 0.2s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Better input focus for mobile */
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      transform: scale(1.01);
      transition: all 0.2s;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text);
      z-index: 10;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #fff;
      transform: scale(1.1);
    }

    .job-detail {
      margin-top: 0.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.75rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }
/* High-contrast styling just for the job detail panel */
.job-detail-contrast {
  background: #111827;           /* light dark slate */
  color: #e5e7eb;                /* light text */
  border-color: #0b1220;
  box-shadow: 0 16px 40px rgba(0,0,0,0.35);
}

/* labels & muted text inside the dark panel */
.job-detail-contrast .detail-label { 
  color: #93c5fd;                /* soft blue for labels */
}

.job-detail-contrast .muted {
  color: #cbd5e1;                /* lighter muted */
}

/* buttons inside the dark panel */
.job-detail-contrast .small-btn.outline {
  border-color: #334155;
  color: #e5e7eb;
  background: transparent;
}
.job-detail-contrast .small-btn {
  background: #1f2937;           /* subtle dark chip */
  color: #e5e7eb;
}

/* links inside the dark panel */
.job-detail-contrast .linkish {
  color: #93c5fd;
}

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .detail-value {
      font-weight: 500;
    }

    .chat-box {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      margin-top: 0.5rem;
      background: #fff;
    }

    .chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .chat-msg {
      font-size: 0.9rem;
      padding: 0.6rem 0.85rem;
      border-radius: 18px;
      max-width: 75%;
      word-wrap: break-word;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      display: block;
    }

    .chat-msg.me {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    
    .chat-msg.them {
      align-self: flex-start;
      background: #f0f0f0;
      color: var(--text-main);
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    
    .chat-msg-wrapper {
      display: flex;
      width: 100%;
      margin-bottom: 1.5rem;
      align-items: flex-end;
      gap: 0.75rem;
    }
    
    .chat-msg-wrapper.me {
      justify-content: flex-end;
    }
    
    .chat-msg-wrapper.them {
      justify-content: flex-start;
    }
    
    .chat-msg-timestamp {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
      padding: 0 0.5rem;
    }
    
    /* Modern Messages Layout */
    .messages-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
      height: calc(100vh - 150px);
      max-height: 700px;
    }
    
    .conversations-sidebar {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .conversations-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #eff6ff 0%, white 100%);
    }
    
    .unread-badge {
      background: #ef4444;
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      min-width: 20px;
      text-align: center;
    }
    
    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      background: #f8f9fa;
    }
    
    .conversation-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem 0.75rem;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid #e9ecef;
      background: white;
      position: relative;
    }
    
    .conversation-item:hover {
      background: #f1f3f5;
    }
    
    .conversation-item:hover .conversation-actions {
      opacity: 1;
    }
    
    .conversation-item.active {
      background: #e7f5ff;
      border-left: 3px solid var(--primary);
    }
    
    .conversation-item.active:hover {
      background: #d0ebff;
    }
    
    .conversation-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text-muted);
      flex-shrink: 0;
      font-size: 0.9rem;
    }
    
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    
    .conversation-name {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 0.125rem;
    }
    
    .conversation-preview {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .conversation-actions {
      display: flex;
      gap: 0.25rem;
      opacity: 0;
      transition: opacity 0.2s;
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: white;
      padding: 0.25rem;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .conversation-item:hover .conversation-actions {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .conversation-actions {
        opacity: 1;
        position: static;
        transform: none;
        box-shadow: none;
        background: transparent;
        padding: 0;
      }
    }
    
    .chat-area {
      background: white;
      border-radius: 0;
      border: none;
      border-left: 1px solid #e9ecef;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e9ecef;
      background: white;
    }
    
    .chat-messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      min-height: 0;
    }
    
    .chat-input-area {
      padding: 0.75rem 1rem;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 0.75rem;
      background: white;
    }
    
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1.5px solid var(--border);
      border-radius: 999px;
      font-size: 0.95rem;
      background: white;
      transition: all 0.2s;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .chat-send-btn {
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    @media (max-width: 768px) {
      .messages-layout {
        grid-template-columns: 1fr;
        height: calc(100vh - 120px);
        max-height: calc(100vh - 120px);
        position: relative;
      }
      
      /* Mobile: Show conversation list OR chat area, not both */
      .conversations-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        z-index: 1;
        display: flex;
        flex-direction: column;
        max-height: none;
        height: 100%;
        border-radius: 0;
      }
      
      .conversations-sidebar.hidden {
        display: none;
      }
      
      .chat-area {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        z-index: 2;
        display: none;
        flex-direction: column;
        min-height: 100%;
        height: 100%;
        border-left: none;
      }
      
      .chat-area.active {
        display: flex;
      }
      
      /* Back button in chat header on mobile */
      .chat-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
      }
      
      .chat-back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: transparent;
        border: none;
        font-size: 1.25rem;
        cursor: pointer;
        color: var(--text-main);
        flex-shrink: 0;
      }
      
      .chat-back-btn:hover {
        background: var(--bg-light);
      }
      
      .chat-header-content {
        flex: 1;
        min-width: 0;
      }
      
      /* Conversation list items - better mobile styling */
      .conversation-item {
        padding: 1rem !important;
        border-bottom: 1px solid #e5e7eb !important;
        border-radius: 0 !important;
        margin-bottom: 0 !important;
        min-height: 72px;
      }
      
      .conversation-item:active {
        background: #f3f4f6 !important;
      }
      
      /* Profile picture in conversation items */
      .conversation-avatar {
        width: 48px !important;
        height: 48px !important;
        flex-shrink: 0 !important;
      }
      
      .conversation-avatar img {
        width: 100% !important;
        height: 100% !important;
        border-radius: 50% !important;
        object-fit: cover !important;
      }
      
      /* Better message bubbles on mobile */
      .chat-msg-wrapper {
        margin-bottom: 1rem !important;
      }
      
      .chat-msg {
        max-width: 85% !important;
        padding: 0.75rem 1rem !important;
        font-size: 0.95rem !important;
        line-height: 1.5 !important;
        word-wrap: break-word !important;
      }
      
      .chat-msg.me {
        background: var(--primary) !important;
        color: white !important;
        border-radius: 18px 18px 4px 18px !important;
      }
      
      .chat-msg.them {
        background: #e5e7eb !important;
        color: var(--text-main) !important;
        border-radius: 18px 18px 18px 4px !important;
      }
      
      .chat-messages-container {
        padding: 1rem 0.75rem !important;
        gap: 0.75rem !important;
      }
      
      .chat-input-area {
        padding: 1rem !important;
        border-top: 1px solid #e5e7eb !important;
      }
      
      .chat-input {
        padding: 0.875rem 1.25rem !important;
        font-size: 1rem !important;
        border-radius: 24px !important;
      }
      
      .chat-send-btn {
        padding: 0.875rem 1.5rem !important;
        border-radius: 24px !important;
        font-weight: 600 !important;
      }
    }

    .chat-msg.them {
      align-self: flex-start;
      background: #e5e7eb;
      color: var(--text-main);
    }

    .chat-meta {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.4rem;
    }

    .chat-input-row input {
      flex: 1;
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.5rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-weight: 600;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      max-width: 72px;
      max-height: 72px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-muted);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      object-position: center;
    }
    
    /* Desktop: Limit avatar sizes - reduced to prevent zoom */
    @media (min-width: 769px) {
      .profile-avatar {
        max-width: 72px !important;
        max-height: 72px !important;
        width: auto !important;
        height: auto !important;
      }
      
      /* Ensure all avatars respect max size */
      [data-user-id] {
        max-width: 72px !important;
        max-height: 72px !important;
      }
      
      [data-user-id] img {
        max-width: 72px !important;
        max-height: 72px !important;
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
        object-position: center !important;
      }
    }
    
    /* Mobile: Keep smaller size */
    @media (max-width: 768px) {
      .profile-avatar {
        max-width: 72px;
        max-height: 72px;
      }
      
      [data-user-id] img {
        max-width: 72px !important;
        max-height: 72px !important;
      }
    }

    .profile-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    /* Enhanced Profile Page */
    .profile-hero-card {
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 50%, #db2777 100%);
      border-radius: 20px;
      padding: 1rem 1.25rem;
      color: white;
      box-shadow: 0 8px 32px rgba(37, 99, 235, 0.35);
      position: relative;
      overflow: hidden;
      margin-bottom: 0.75rem;
      min-height: auto;
    }
    
    /* Hide empty profile hero card */
    .profile-hero-card:empty {
      display: none !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .profile-hero-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
      pointer-events: none;
    }
    
    .profile-hero-top {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }
    
    .profile-hero-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 700;
      border: 2px solid rgba(255,255,255,0.4);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .profile-hero-avatar:hover {
      transform: scale(1.05);
    }
    
    .profile-hero-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-camera-icon {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .profile-hero-info {
      flex: 1;
    }
    
    .profile-hero-name {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 0.2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .profile-hero-email {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-bottom: 0.35rem;
    }
    
    .profile-hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    
    .profile-hero-location {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    /* Quick Stats Bar */
    .profile-quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin: 0 0 0.75rem 0;
    }
    
    /* Hide empty quick stats */
    .profile-quick-stats:empty {
      display: none !important;
      height: 0 !important;
      margin: 0 !important;
    }
    
    .quick-stat-card {
      background: white;
      border-radius: 8px;
      padding: 0.5rem;
      text-align: center;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .quick-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .quick-stat-icon {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }
    
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-main);
    }
    
    .quick-stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    /* Profile Tabs */
    .profile-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.4rem;
    }
    
    .profile-tab {
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: none;
      border-radius: 10px 10px 0 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .profile-tab:hover {
      background: var(--bg-light);
      color: var(--text-main);
    }
    
    .profile-tab.active {
      background: var(--primary-soft);
      color: var(--primary);
      border-bottom: 4px solid var(--primary);
      margin-bottom: -2px;
      font-weight: 700;
      font-size: 0.95rem;
    }
    
    /* Manage tabs styled like filter chips - desktop */
    .manage-tab {
      padding: 0.65rem 1.25rem !important;
      border: 1.5px solid var(--border) !important;
      border-radius: 24px !important;
      font-size: 0.9rem !important;
      background: white !important;
      color: var(--text-main) !important;
      cursor: pointer !important;
      white-space: nowrap !important;
      transition: all 0.2s !important;
      font-weight: 500 !important;
      display: flex !important;
      align-items: center !important;
      gap: 0.4rem !important;
      border-bottom: 1.5px solid var(--border) !important;
      margin-bottom: 0 !important;
    }
    
    /* Active manage tab - filter chip style */
    .manage-tab.active {
      background: var(--primary) !important;
      color: white !important;
      border: 1.5px solid var(--primary) !important;
      font-weight: 600 !important;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2) !important;
    }
    
    /* Inactive manage tabs - muted filter chip style */
    .manage-tab:not(.active) {
      color: var(--text-muted) !important;
      font-weight: 500 !important;
      opacity: 0.8 !important;
      background: white !important;
    }
    
    .manage-tab:not(.active):hover {
      opacity: 1 !important;
      color: var(--text-main) !important;
      background: var(--bg-light) !important;
      border-color: var(--primary) !important;
    }
    
    /* Remove the tab indicator for manage tabs (using filter chip style instead) */
    .manage-tab .tab-indicator {
      display: none !important;
    }
    
    /* Profile tabs container for manage tabs - remove border bottom */
    .profile-tabs:has(.manage-tab) {
      border-bottom: none !important;
      padding-bottom: 0 !important;
      margin-bottom: 1rem !important;
    }
    
    .profile-tab-content {
      display: none;
    }
    
    .profile-tab-content.active {
      display: block;
    }
    
    .profile-section-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .profile-settings-card {
      border: 1px solid var(--border);
    }
    
    /* Preferences */
    .preference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .preference-item:last-child {
      border-bottom: none;
    }
    
    .preference-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-main);
    }
    
    .preference-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.3s;
      border-radius: 28px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    @media (max-width: 768px) {
      .profile-quick-stats {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
      }
      
      .quick-stat-card {
        padding: 0.4rem;
      }
      
      .quick-stat-icon {
        font-size: 1rem;
        margin-bottom: 0.15rem;
      }
      
      .quick-stat-value {
        font-size: 0.95rem;
      }
      
      .quick-stat-label {
        font-size: 0.65rem;
      }
      
      .profile-section-grid {
        grid-template-columns: 1fr;
      }
      
      .profile-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .profile-tab {
        white-space: nowrap;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
      
      .profile-hero-card {
        padding: 0.875rem 1rem;
        margin-bottom: 0.5rem;
      }
      
      .profile-hero-avatar {
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
        border: 2px solid rgba(255,255,255,0.4);
      }
      
      .profile-hero-name {
        font-size: 1.2rem;
      }
      
      .profile-hero-email {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
      }
      
      .profile-hero-badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }
      
      .profile-hero-location {
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
    }

   .linkish {
  color: var(--primary);
  font-size: 0.75rem;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
  text-decoration-thickness: 1.5px;
  font-weight: 600;
}
.linkish:hover {
  text-decoration-thickness: 2px;
  color: var(--primary-dark);
}

    .job-status-group {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-status-group span {
      margin-right: 0.35rem;
      cursor: pointer;
    }

    .job-status-group span.active {
      color: var(--primary);
      font-weight: 600;
    }

    .feedback-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .about-text {
      font-size: 0.8rem;
      color: var(--text-main);
      line-height: 1.45;
      white-space: pre-line;
    }

    .legal-subtitle {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.6rem;
    }

    .legal-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    footer {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      font-size: 0.65rem;
      background: #000000;
      color: #ffffff;
    }
    
    footer .footer-links span {
      color: #ffffff;
    }

    .footer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    .footer-links span {
      cursor: pointer;
    }

    .footer-links a {
      color: #ffffff !important;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      text-decoration: underline;
      color: #93c5fd !important;
    }
    
    /* About view styling - better fonts and design */
    #view-about {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #1f2937;
      line-height: 1.7;
    }
    
    #view-about .card {
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    #view-about .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    #view-about .card-header {
      border-bottom: 1px solid #e5e7eb;
      padding: 1.75rem 2rem;
    }
    
    #view-about .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.01em;
    }
    
    #view-about h3 {
      font-size: 1.15rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.75rem;
      letter-spacing: -0.01em;
    }
    
    #view-about p {
      color: #374151;
      font-size: 1rem;
      line-height: 1.75;
    }
    
    #view-about a[href^="mailto:"]:hover,
    #view-about a[href^="https://"]:hover {
      background: var(--primary-soft) !important;
      border-color: var(--primary) !important;
      transform: translateX(4px);
    }
    
    #view-about input:focus,
    #view-about textarea:focus {
      outline: none;
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: #111827;
      color: #f9fafb;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-size: 0.75rem;
      z-index: 9999;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      max-width: 300px;
      word-wrap: break-word;
      visibility: hidden;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      visibility: visible;
    }

    .age-gate-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.84);
      display: none; /* Hidden by default - age gate disabled */
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .age-gate-card {
      background: #ffffff;
      padding: 1.2rem;
      border-radius: 14px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }

    .age-gate-card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    .age-gate-card p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.7rem;
    }

    .age-gate-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.3rem;
    }

@media (max-width: 800px) {
      header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .jobs-list {
        max-height: none; /* let the page scroll instead of tiny inner scroll */
      }
    }
    
    /* ========== COMPREHENSIVE MOBILE RESPONSIVE FIXES ========== */
    
    /* Phone (up to 480px) - Comprehensive Mobile Optimizations */
    @media (max-width: 480px) {
      main {
        padding: 0 0.75rem 0.75rem 0.75rem !important;
        padding-top: 0 !important;
      }
      
      .card {
        padding: 1rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .card-title {
        font-size: 1rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .muted, .card-subtitle {
        font-size: 0.8rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .btn {
        padding: 0.7rem 1rem !important;
        font-size: 0.85rem !important;
        min-height: 44px; /* Touch target */
      }
      
      .field {
        margin-bottom: 0.75rem !important;
      }
      
      .field label {
        font-size: 0.85rem !important;
        margin-bottom: 0.4rem !important;
      }
      
      input, textarea, select {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 0.7rem !important;
        min-height: 44px; /* Touch target */
      }
      
      /* Section titles - smaller on mobile */
      .section-title {
        font-size: 0.95rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .profile-hero-card {
        padding: 0.875rem 1rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .profile-hero-avatar {
        width: 48px !important;
        height: 48px !important;
        font-size: 1.1rem !important;
      }
      
      .profile-hero-name {
        font-size: 1.1rem !important;
      }
      
      .profile-quick-stats {
        gap: 0.5rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .quick-stat-card {
        padding: 0.6rem !important;
        font-size: 0.8rem !important;
      }
      
      .profile-tabs {
        gap: 0.75rem !important;
        margin-bottom: 0.75rem !important;
        padding-bottom: 0.5rem !important;
      }
      
      /* More spacing for manage tabs specifically on mobile */
      .manage-tab {
        margin-right: 0.5rem !important;
        padding: 0.75rem 1rem !important;
      }
      
      .profile-tab {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8rem !important;
        min-height: 44px; /* Touch target */
      }
      
      /* Manage tabs styled like filter chips on mobile - prevent overlap */
      .profile-tabs:has(.manage-tab) {
        border-bottom: none !important;
        padding-bottom: 0 !important;
        gap: 0.5rem !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: none !important;
        -ms-overflow-style: none !important;
        justify-content: flex-start !important;
      }
      
      .profile-tabs:has(.manage-tab)::-webkit-scrollbar {
        display: none !important;
      }
      
      .manage-tab {
        padding: 0.7rem 1rem !important;
        margin: 0.25rem 0.25rem !important;
        font-size: 0.85rem !important;
        flex: 0 0 auto !important;
        min-width: fit-content !important;
        width: calc(25% - 0.5rem) !important;
        max-width: calc(25% - 0.5rem) !important;
        border-radius: 24px !important;
        border: 1.5px solid var(--border) !important;
        background: white !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        box-sizing: border-box !important;
      }
      
      .manage-tab.active {
        background: var(--primary) !important;
        color: white !important;
        border-color: var(--primary) !important;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3) !important;
      }
      
      .manage-tab:not(.active) {
        color: var(--text-muted) !important;
        opacity: 0.8 !important;
      }
      
      /* Remove excessive white space */
      #view-profile {
        padding-top: 0 !important;
        margin-top: 0 !important;
      }
      
      #view-profile > *:first-child {
        margin-top: 0 !important;
      }
      
      /* Job cards - more compact */
      .job-card, [class*="job-card"] {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      /* Headers - smaller */
      h1 { font-size: 1.3rem !important; }
      h2 { font-size: 1.1rem !important; }
      h3 { font-size: 1rem !important; }
      
      /* Text content - more compact */
      p, div[style*="font-size"] {
        font-size: 0.85rem !important;
        line-height: 1.4 !important;
      }
    }
    
    /* Tablet (481px to 768px) */
    @media (min-width: 481px) and (max-width: 768px) {
      main {
        padding: 0 1rem 1rem 1rem !important;
        padding-top: 0 !important;
      }
      
      .card {
        padding: 1.25rem !important;
      }
      
      .profile-hero-card {
        padding: 1rem 1.25rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .profile-hero-avatar {
        width: 52px !important;
        height: 52px !important;
        font-size: 1.3rem !important;
      }
      
      .profile-hero-name {
        font-size: 1.3rem !important;
      }
    }
    
    /* Desktop (769px and up) */
    @media (min-width: 769px) {
      main {
        padding: 0 1.5rem 1.5rem 1.5rem !important;
        padding-top: 0 !important;
      }
      
      .card {
        padding: 1.5rem !important;
      }
    }
    
    /* Fix white space on all devices */
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      height: auto !important;
      overflow-x: hidden;
      overflow-y: auto; /* Only show scrollbar when content exceeds viewport */
    }
    
    /* Prevent unnecessary scrolling - only scroll when there's actual content */
    body {
      overflow-y: auto;
      min-height: 100vh;
    }
    
    /* Remove scrolling from empty views */
    #view-home:empty,
    #view-jobs:empty,
    #view-post:empty,
    #view-messages:empty,
    #view-profile:empty {
      overflow: hidden;
      height: auto;
    }
    
    /* Make sure post view is visible when displayed */
    #view-post[style*="display: block"],
    #view-post[style*="display:block"] {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Remove duplicate spacing */
    #view-profile .profile-basic-info:empty,
    #view-profile .profile-quick-stats:empty {
      display: none !important;
      height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* Profile Basic Info Styles */
    .profile-basic-info {
      margin-bottom: 1.5rem;
    }
    
    .profile-basic-info .card {
      transition: all 0.2s ease;
    }
    
    .profile-basic-info input,
    .profile-basic-info textarea,
    .profile-basic-info select {
      transition: all 0.2s ease;
    }
    
    .profile-basic-info input:focus,
    .profile-basic-info textarea:focus,
    .profile-basic-info select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* ========== COMPREHENSIVE MOBILE FIXES - COMPACT VERSION ========== */
    
    /* Mobile First: Base styles for phones - COMPACT */
    @media (max-width: 767px) {
      /* Prevent horizontal scroll */
      * {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      html, body {
        overflow-x: hidden !important;
        width: 100% !important;
        position: relative;
      }
      
      /* Job details summary grid - single column with better spacing on mobile */
      .job-details-summary-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
        padding: 0.5rem 0 !important;
      }
      
      .job-details-summary-grid > div {
        padding: 0.75rem 0 !important;
        border-bottom: 1px solid var(--border) !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 0.25rem !important;
      }
      
      .job-details-summary-grid > div:last-child {
        border-bottom: none !important;
      }
      
      /* Header fixes - COMPACT */
      header {
        padding: 0.5rem 0.75rem !important;
        flex-wrap: nowrap !important;
        gap: 0.5rem !important;
        min-height: auto !important;
      }
      
      .logo-mark {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.9rem !important;
      }
      
      .logo-text-main {
        font-size: 0.9rem !important;
        line-height: 1.2 !important;
      }
      
      .logo-sub {
        font-size: 0.6rem !important;
        line-height: 1.2 !important;
      }
      
      .logo-text-container {
        gap: 0.25rem !important;
      }
      
      .hamburger-btn {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        min-height: 36px !important;
        padding: 0 !important;
      }
      
      .hamburger-btn span {
        width: 18px !important;
        height: 2px !important;
      }
      
      /* Main content - COMPACT */
      main {
        padding: 0 0.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* View sections - COMPACT */
      #view-home,
      #view-jobs,
      #view-post,
      #view-messages,
      #view-profile,
      #view-owner {
        padding: 0.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Cards - COMPACT */
      .card {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 10px !important;
      }
      
      /* Job cards - COMPACT */
      .job-card {
        padding: 1rem !important;
        width: 100% !important;
        max-width: 100% !important;
        margin-bottom: 1rem !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        gap: 0.5rem !important;
        min-height: auto !important;
      }
      
      .job-card-top {
        flex-wrap: wrap !important;
        gap: 0.5rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .job-title {
        font-size: 0.9rem !important;
        line-height: 1.3 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        margin: 0 0 0.5rem 0 !important;
        padding-right: 50% !important; /* More space for "Hustler suggests price" on mobile */
      }
      
      /* Price on mobile - smaller and wraps */
      .job-card-price {
        font-size: 0.7rem !important;
        line-height: 1.2 !important;
        max-width: 48% !important;
        word-wrap: break-word !important;
        white-space: normal !important;
        padding: 0.25rem 0.5rem !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 6px !important;
      }
      
      .job-meta {
        font-size: 0.8rem !important;
        line-height: 1.4 !important;
        word-wrap: break-word !important;
        margin: 0.25rem 0 !important;
        padding-right: 3rem !important; /* Space for countdown in bottom right */
      }
      
      /* Price positioning on mobile */
      .job-card-price {
        top: 0.75rem !important;
        right: 0.75rem !important;
        font-size: 0.9rem !important;
        padding: 0.25rem 0.5rem !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 6px !important;
      }
      
      /* Filters, Sort, and Toggle Row - all on same line on mobile */
      .filters-sort-row {
        gap: 0.5rem !important;
        flex-wrap: nowrap !important;
      }
      
      /* Make filters button smaller on mobile */
      .filters-btn-mobile {
        padding: 0.4rem 0.7rem !important;
        height: 2rem !important;
        font-size: 0.75rem !important;
        gap: 0.35rem !important;
      }
      
      .filters-btn-mobile span:first-of-type {
        font-size: 0.75rem !important;
      }
      
      /* Sort and toggle container - keep together on mobile */
      .sort-and-toggle-container {
        flex-wrap: nowrap !important;
        gap: 0.4rem !important;
      }
      
      .sort-dropdown-container {
        min-width: 90px !important;
        flex: 1 !important;
      }
      
      /* Make sort select smaller on mobile */
      .sort-select-mobile {
        padding: 0.4rem 0.5rem !important;
        height: 2rem !important;
        font-size: 0.75rem !important;
      }
      
      /* Make toggle smaller on mobile */
      .toggle-container-mobile {
        padding: 0.15rem !important;
      }
      
      .sort-and-toggle-container .jobs-view-toggle {
        padding: 0.3rem 0.5rem !important;
        font-size: 0.7rem !important;
      }
      
      .sort-and-toggle-container > div:last-child {
        flex-shrink: 0 !important;
      }
      
      /* Countdown positioning on mobile */
      .countdown-timer {
        bottom: 0.75rem !important;
        right: 0.75rem !important;
        font-size: 0.75rem !important;
        padding: 0.25rem 0.5rem !important;
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 6px !important;
      }
      
      .job-card-actions {
        margin-top: 0.375rem !important;
        gap: 0.375rem !important;
        flex-wrap: wrap !important;
      }
      
      /* Buttons - COMPACT but touch-friendly */
      button,
      .btn {
        min-height: 40px !important;
        min-width: 40px !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.85rem !important;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(37, 99, 235, 0.2);
        margin: 0 !important;
      }
      
      .small-btn {
        min-height: 32px !important;
        min-width: 32px !important;
        padding: 0.375rem 0.625rem !important;
        font-size: 0.75rem !important;
      }
      
      .btn-primary,
      .btn-signup-header {
        padding: 0.625rem 1rem !important;
        font-size: 0.9rem !important;
        font-weight: 600 !important;
      }
      
      .nav-tab {
        padding: 0.375rem 0.75rem !important;
        font-size: 0.8rem !important;
        min-height: 32px !important;
      }
      
      /* Inputs and forms - COMPACT */
      input,
      textarea,
      select {
        font-size: 16px !important; /* Prevents iOS zoom */
        padding: 0.625rem 0.75rem !important;
        min-height: 40px !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        -webkit-appearance: none;
        appearance: none;
        border-radius: 8px !important;
        margin: 0 !important;
        color: var(--text-main) !important;
      }
      
      textarea {
        min-height: 80px !important;
        resize: vertical;
        padding: 0.625rem !important;
      }
      
      .field {
        margin-bottom: 0.875rem !important;
        width: 100% !important;
      }
      
      .field label {
        font-size: 0.85rem !important;
        margin-bottom: 0.375rem !important;
      }
      
      .field-inline {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      /* Modals - COMPACT */
      .modal-overlay {
        padding: 0 !important;
        align-items: flex-end !important;
      }
      
      .modal-content {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 90vh !important;
        border-radius: 16px 16px 0 0 !important;
        padding: 1rem 0.75rem !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      .modal-close {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        min-height: 36px !important;
        font-size: 1.1rem !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
      }
      
      /* Job form - COMPACT */
      #jobFormCard {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0.75rem !important;
        margin: 0 !important;
      }
      
      #jobFormCard .field {
        width: 100% !important;
        margin-bottom: 0.875rem !important;
      }
      
      #jobFormCard input,
      #jobFormCard textarea,
      #jobFormCard select {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Location section - Mobile optimized */
      #approximateLocationMap {
        height: 350px !important;
        min-height: 350px !important;
      }
      
      #useCurrentLocationBtn,
      #approximateLocationSearch {
        font-size: 1rem !important; /* Prevent zoom on iOS */
        min-height: 48px !important; /* Larger touch target */
        padding: 1rem !important;
      }
      
      #useCurrentLocationBtn:active {
        background: var(--primary-soft) !important;
        transform: scale(0.98);
      }
      
      /* Jobs list - COMPACT */
      .jobs-list {
        width: 100% !important;
        max-width: 100% !important;
        gap: 0.5rem !important;
      }
      
      /* Header auth buttons - COMPACT */
      .header-auth {
        gap: 0.375rem !important;
      }
      
      .btn-login-header,
      .btn-signup-header {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8rem !important;
        min-height: 36px !important;
      }
      
      /* Profile elements - COMPACT */
      .profile-hero-card {
        padding: 0.75rem !important;
        flex-wrap: wrap !important;
        margin-bottom: 0.75rem !important;
      }
      
      .profile-hero-avatar {
        width: 44px !important;
        height: 44px !important;
        font-size: 1.1rem !important;
      }
      
      .profile-hero-name {
        font-size: 1.1rem !important;
      }
      
      .profile-quick-stats {
        flex-wrap: wrap !important;
        gap: 0.5rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .quick-stat-card {
        min-width: calc(50% - 0.25rem) !important;
        flex: 1 1 calc(50% - 0.25rem) !important;
        padding: 0.5rem !important;
      }
      
      /* Badges - COMPACT */
      .badge {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.75rem !important;
        min-height: 24px !important;
        line-height: 1.2 !important;
      }
      
      /* Text sizing - COMPACT */
      h1 {
        font-size: 1.25rem !important;
        line-height: 1.3 !important;
        margin: 0.5rem 0 !important;
      }
      
      h2 {
        font-size: 1.1rem !important;
        line-height: 1.3 !important;
        margin: 0.5rem 0 !important;
      }
      
      h3 {
        font-size: 1rem !important;
        line-height: 1.3 !important;
        margin: 0.5rem 0 !important;
      }
      
      .card-title {
        font-size: 1rem !important;
        line-height: 1.3 !important;
        margin: 0 0 0.5rem 0 !important;
      }
      
      p {
        font-size: 0.875rem !important;
        line-height: 1.4 !important;
        margin: 0.5rem 0 !important;
      }
      
      /* Prevent text overflow */
      * {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* Layout grid - COMPACT */
      .layout-grid {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      /* Fix any fixed widths */
      [style*="width:"] {
        max-width: 100% !important;
      }
      
      /* Tables - make scrollable */
      table {
        display: block !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        width: 100% !important;
        font-size: 0.8rem !important;
      }
      
      /* Images */
      img {
        max-width: 100% !important;
        height: auto !important;
      }
      
      /* Remove hover effects on mobile */
      .job-card:hover {
        transform: none !important;
      }
      
      .card:hover {
        transform: none !important;
      }
      
      /* Fix overlapping elements */
      .iconBadge {
        flex-shrink: 0 !important;
        margin-right: 0.5rem !important;
      }
      
      /* Fix header row spacing */
      .headerRow {
        gap: 0.5rem !important;
        align-items: flex-start !important;
      }
      
      /* Fix pay display in job cards */
      .job-card .pay {
        font-size: 0.9rem !important;
        white-space: normal !important;
        word-break: break-word !important;
        margin: 0 !important;
      }
      
      /* Fix title row in job cards */
      .titleRow {
        flex-wrap: wrap !important;
        gap: 0.375rem !important;
        align-items: flex-start !important;
      }
      
      /* Reduce spacing in text content */
      .textContent {
        min-width: 0 !important;
        flex: 1 !important;
      }
      
      /* Fix equipment badges */
      .equipmentRow {
        gap: 0.25rem !important;
        margin-top: 0.375rem !important;
      }
      
      /* Fix actions row */
      .job-card-actions .left,
      .job-card-actions .right {
        gap: 0.375rem !important;
      }
    }
    
    /* Small phones (up to 360px) - EXTRA COMPACT */
    @media (max-width: 360px) {
      header {
        padding: 0.375rem 0.5rem !important;
      }
      
      .logo-text-container {
        flex-direction: column !important;
        gap: 0.125rem !important;
      }
      
      .logo-sub {
        font-size: 0.55rem !important;
      }
      
      main {
        padding: 0 0.375rem !important;
      }
      
      #view-home,
      #view-jobs,
      #view-post,
      #view-messages,
      #view-profile {
        padding: 0.375rem !important;
      }
      
      .card {
        padding: 0.625rem !important;
        margin-bottom: 0.625rem !important;
      }
      
      .job-card {
        padding: 0.625rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      button,
      .btn {
        padding: 0.5rem 0.625rem !important;
        font-size: 0.8rem !important;
        min-height: 36px !important;
      }
      
      .small-btn {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.7rem !important;
        min-height: 28px !important;
      }
    }
    
    /* Landscape phones - COMPACT */
    @media (max-width: 767px) and (orientation: landscape) {
      .modal-content {
        max-height: 85vh !important;
        padding: 0.75rem !important;
      }
      
      header {
        padding: 0.375rem 0.75rem !important;
      }
      
      main {
        padding: 0 0.5rem !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-row">
        <div class="logo-mark">H</div>
        <div class="logo-text-container">
          <div class="logo-text-main">Hustl</div>
          <div class="logo-sub">Real Hustle. All of Tennessee.</div>
        </div>
      </div>
      
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="home">Home</button>
        <button class="nav-tab" data-view="jobs">Browse Jobs</button>
        <button class="nav-tab" data-view="post">Post a Job</button>
        <button class="nav-tab" data-view="manage-jobs" id="manageJobsTab">📋 Manage Jobs</button>
        <button class="nav-tab" data-view="messages">Messages</button>
        <button class="nav-tab" data-view="profile">Profile</button>
        <button class="nav-tab" data-view="owner" id="ownerTab" style="display:none;">Owner</button>
      </nav>
      
      <div class="header-auth desktop-only" id="headerAuthDesktop">
        <button class="btn-login-header" id="headerLoginBtn" onclick="if(typeof window.openAuthModal === 'function') window.openAuthModal('login')">Log In</button>
        <button class="btn-signup-header" id="headerSignupBtn" onclick="if(typeof window.openAuthModal === 'function') window.openAuthModal('create')">Sign Up Free</button>
      </div>
      
      <!-- Hamburger for mobile -->
      <button class="hamburger-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
        <span class="hamburger-close" style="display: none; position: absolute; font-size: 1.2rem; font-weight: 700; color: var(--text-main);">✕</span>
      </button>
      
      <!-- Old auth pill (hidden but kept for JS compatibility) -->
      <div class="auth-pill" id="authPill" style="display:none;">
        Not signed in
        <button id="openAuthButton">Sign in / Create account</button>
      </div>
    </header>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
      <!-- Menu header with close button -->
      <div class="mobile-menu-header">
        <h2 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);">Menu</h2>
        <button class="mobile-menu-close" id="mobileMenuClose" aria-label="Close menu">
          ✕
        </button>
      </div>
      <!-- Menu items will be populated dynamically by updateHeaderAuth() -->
      <div class="mobile-menu-items" id="mobileMenuItems">
        <!-- Menu items will be populated here -->
      </div>
      <div class="header-auth" id="mobileMenuAuth">
        <!-- Auth buttons will be populated dynamically -->
      </div>
    </div>

    <main>
      <!-- AUTH CARD -->
      <section id="authSection" class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--card-glass) 100%); display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
          <div>
            <div class="card-title" id="authCardTitle" style="font-size: 1.3rem; margin-bottom: 0.25rem;">🚀 Join Hustl</div>
            <div style="color: var(--text-muted); font-size: 0.85rem;">Start earning or get help today</div>
          </div>
          <div id="authModeToggle">
            <span class="linkish" data-auth-mode="login" style="background: var(--bg-light); padding: 0.5rem 1rem; border-radius: 999px; font-weight: 500; color: var(--text-main); cursor: pointer; border: 1px solid var(--border);">Log in</span>
          </div>
        </div>
        
        <div id="authBodyCreate">
          <!-- Step indicator -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <div style="flex: 1; height: 4px; background: var(--primary); border-radius: 2px;"></div>
            <div style="flex: 1; height: 4px; background: var(--border); border-radius: 2px;"></div>
          </div>
          
          <div class="field">
            <label for="createName">Your Name</label>
            <input id="createName" type="text" placeholder="John Smith" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="createEmail">Email Address</label>
            <input id="createEmail" type="email" placeholder="john@example.com" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="createPassword">Create Password</label>
            <input id="createPassword" type="password" placeholder="At least 8 characters" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <div class="field" style="flex: 2;">
              <label for="createCity">Your City</label>
              <input id="createCity" type="text" placeholder="Knoxville" style="font-size: 1rem; padding: 0.75rem;" />
            </div>
            <div class="field" style="flex: 1;">
              <label for="createZip">ZIP</label>
              <input id="createZip" type="text" placeholder="37901" maxlength="5" pattern="[0-9]{5}" style="font-size: 1rem; padding: 0.75rem;" />
            </div>
          </div>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin: -0.5rem 0 0.75rem 0;">
            📍 Your home base for "Near Me" - you can still see jobs anywhere in TN
          </p>
          
          <div class="field" style="display: none;">
            <label for="createRole">I want to</label>
            <select id="createRole" style="font-size: 1rem; padding: 0.75rem;">
              <option value="both" selected>Do both - Post jobs & earn money</option>
              <option value="customer">Only post jobs (Customer)</option>
              <option value="hustler">Only earn money (Hustler)</option>
            </select>
          </div>
          
          <!-- Hidden fields for backwards compatibility -->
          <div style="display: none;">
            <select id="createPayoutMethod"><option value="">Choose one</option></select>
            <input id="createPayoutHandle" type="text" />
            <input id="createPayoutName" type="text" />
          </div>
          
          <!-- Required Checkboxes -->
          <div style="margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 10px;">
            <div class="checkbox-field">
              <input type="checkbox" id="ageCheckbox" required />
              <label for="ageCheckbox" style="cursor: pointer; user-select: none; -webkit-user-select: none;">I confirm I am <strong>18 years or older</strong></label>
            </div>
            <div class="checkbox-field">
              <input type="checkbox" id="termsCheckbox" required />
              <label for="termsCheckbox" style="cursor: pointer; user-select: none; -webkit-user-select: none;">I agree to the <a href="/terms.html" target="_blank" style="color: var(--primary); text-decoration: underline;">Terms of Use</a> and <a href="/privacy.html" target="_blank" style="color: var(--primary); text-decoration: underline;">Privacy Policy</a></label>
            </div>
          </div>
          
          <button class="btn btn-primary" id="createAccountButton" style="width: 100%; padding: 0.9rem; font-size: 1rem;">
            Create Free Account
          </button>
          
          <p class="muted" style="text-align: center; margin-top: 0.75rem; font-size: 0.75rem;">
            <span style="color: var(--success);">✓ Free to join</span> • <span style="color: var(--success);">✓ No monthly fees</span> • <span style="color: var(--success);">✓ Cancel anytime</span>
          </p>
        </div>

        <div id="authBodyLogin" style="display:none;">
          <div style="text-align: center; margin-bottom: 1rem;">
            <span style="font-size: 2rem;">👋</span>
            <div style="font-weight: 600; margin-top: 0.25rem;">Welcome back!</div>
          </div>
          
          <div class="field">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="you@example.com" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="Your password" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <button class="btn btn-primary" id="loginButton" style="width: 100%; padding: 0.9rem; font-size: 1rem;">
            Log In →
          </button>
          
          <div style="text-align: center; margin-top: 0.75rem;">
            <button class="btn btn-ghost" id="forgotPasswordLoginBtn" style="font-size: 0.85rem; color: var(--primary); padding: 0.5rem; text-decoration: underline; background: none; border: none; cursor: pointer;">
              Forgot password?
            </button>
          </div>
          
          <p class="muted" style="text-align: center; margin-top: 0.75rem; font-size: 0.8rem;">
            Don't have an account? <span class="linkish" data-auth-mode="create" onclick="if(typeof window.openAuthModal === 'function') window.openAuthModal('create'); else if(typeof setMode === 'function') setMode('create');" style="cursor: pointer; text-decoration: underline;">Sign up free</span>
          </p>
        </div>
      </section>

      <!-- HOME VIEW - CLEAN HERO -->
      <section id="view-home">
        <!-- Hero Section -->
        <div style="text-align: center; padding: 2rem 1rem; max-width: 600px; margin: 0 auto;">
          
          <!-- Briefcase Icon -->
          <div style="width: 80px; height: 80px; margin: 1.5rem auto 1.25rem; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
          </div>
          
          <!-- Main Headline -->
          <h1 style="font-size: 2rem; font-weight: 700; line-height: 1.2; margin: 0 0 0.75rem; color: var(--text-main);">
            Need help or want to make extra cash?
          </h1>
          
          <!-- Subheadline -->
          <p style="font-size: 1rem; color: var(--text-muted); margin: 0 0 1.5rem; line-height: 1.5;">
            Hustl connects you with locals for simple jobs and everyday tasks.
          </p>
          
          <!-- CTA Buttons -->
          <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <button class="btn btn-primary" id="homeCtaPost" style="padding: 0.875rem 1.75rem; font-size: 1rem; font-weight: 600; border-radius: 10px; background: var(--primary); border: none; color: white;">
              Post a Job
            </button>
            <button class="btn btn-ghost" id="homeCtaBrowse" style="padding: 0.875rem 1.75rem; font-size: 1rem; font-weight: 600; border-radius: 10px; background: white; border: 1px solid var(--border); color: var(--text-main);">
              Browse Jobs
            </button>
          </div>
          
          <!-- Trust badges -->
          <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-muted);">
            <span>✓ Free to join</span>
            <span>✓ Secure payments</span>
            <span>✓ Instant payouts</span>
          </div>
        </div>
        
        <!-- How It Works Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          
          <!-- Card 1: Post -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(251, 191, 36, 0.3); background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">📝</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: #fbbf24;">1. Post Your Job</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Describe what you need, set your price. Takes 30 seconds.</p>
          </div>
          
          <!-- Card 2: Connect -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">💪</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--primary);">2. Get Offers</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Local hustlers apply. Compare, chat, and pick your favorite.</p>
          </div>
          
          <!-- Card 3: Pay -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(34, 197, 94, 0.3); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">💰</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--success);">3. Pay Securely</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Pay through Stripe. Hustler gets paid instantly to their bank.</p>
          </div>
        </div>
        
        <!-- SEO: Local Services Section -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2); background: white;">
          <h2 style="font-size: 1.2rem; margin: 0 0 1rem; color: var(--text-main);">
            🏠 Local Help Across Tennessee
          </h2>
          <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin: 0 0 1rem;">
            Fast, simple local help across Tennessee — built to support people who need tasks done and people looking to earn.
          </p>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Knoxville, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Nashville, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Chattanooga, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Memphis, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 All of Tennessee</span>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🚚 Moving</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🌿 Yard Work</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">💦 Power Washing</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🗑️ Junk Removal</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🎨 Painting</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🔧 Handyman</span>
          </div>
          <button type="button" id="seeMoreCategoriesBtn" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('allCategoriesExpanded').style.display = document.getElementById('allCategoriesExpanded').style.display === 'none' ? 'block' : 'none'; this.textContent = this.textContent === 'See More Categories' ? 'Show Less' : 'See More Categories';">
            See More Categories
          </button>
          <div id="allCategoriesExpanded" style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🔧 Furniture Assembly</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🌳 Landscaping</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🐕 Pet Care</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🚚 Delivery</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🚿 Car Cleaning</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🎪 Event Setup</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">❄️ Snow Removal</span>
            </div>
          </div>
        </div>
        
        <!-- Why Stripe Section -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(99, 91, 255, 0.3);">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #635bff 0%, #a855f7 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 1.5rem;">💳</span>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.1rem;">Powered by Stripe</h3>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem;">Secure payments trusted by Uber, DoorDash, Lyft, Instacart</p>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; margin-top: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">✓</span> Fast payouts
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">✓</span> Protected payments
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">✓</span> Bank-level security
            </div>
          </div>
        </div>
        
        <!-- Quick Info -->
        <div class="card" style="background: var(--card-glass);">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
            <span style="font-size: 1.25rem;">📍</span>
            <span style="font-weight: 600;">Currently serving Tennessee</span>
          </div>
          <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
            <li>• All of Tennessee — Knoxville, Nashville, Memphis & more</li>
            <li>• Hustl takes only 12% — the rest goes to hustlers</li>
            <li>• Chat with hustlers before you hire</li>
            <li>• You must be 18+ to use Hustl</li>
          </ul>
          </div>
        </div>
        
        <!-- Bottom CTA: Sign Up (only show when not logged in) -->
        <div id="homeBottomSignUpCTA" class="card" style="text-align: center; padding: 2rem 1.5rem; margin-top: 2rem; background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(14, 165, 233, 0.1) 100%); border: 2px solid rgba(37, 99, 235, 0.3);">
          <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.75rem; color: var(--text-main);">Ready to get started?</h2>
          <p style="color: var(--text-muted); font-size: 1rem; margin: 0 0 1.5rem; line-height: 1.5;">Join Hustl today and start posting jobs or earning money.</p>
          <button class="btn btn-primary" id="homeBottomSignUpBtn" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 10px; background: var(--primary); border: none; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
            Sign Up Free →
          </button>
        </div>
      </section>

      <!-- POST JOB VIEW (separate page) -->
      <section id="view-post" style="display:none;">
        <!-- Job Stats Section removed - user requested removal -->
        
        <div class="card" id="jobFormCard" style="padding: 2.5rem;">
          <div class="card-header">
            <div class="card-title">Post a job</div>
          </div>
          <div class="muted" style="margin-bottom:0.5rem;">
            Post your job and hustlers will see it.
          </div>

          <div class="field">
            <label for="jobTitle" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>Job title</span>
              <span style="color: #dc2626; font-size: 0.9rem;">*</span>
              <span style="color: var(--text-muted); font-size: 0.85rem;">(max 5 words)</span>
            </label>
            <input id="jobTitle" type="text" placeholder="Example: Dump run from West Nashville" maxlength="60" />
            <div id="jobTitleError" style="display: none; color: #dc2626; font-size: 0.8rem; margin-top: 0.25rem;">Job title must be 5 words or less</div>
          </div>

          <!-- Category Selection - Mobile-friendly -->
          <div class="field">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span>📂 What do you need help with?</span>
              <span style="color: #dc2626; font-size: 0.9rem;">*</span>
            </label>
            
            <!-- Hidden select for form submission -->
            <select id="jobCategory" style="display: none;">
              <option value="">Select...</option>
              <option value="moving">Moving / Hauling</option>
              <option value="yard-work">Yard Work</option>
              <option value="dump-run">Dump Run</option>
              <option value="cleaning">Cleaning</option>
              <option value="power-washing">Power Washing</option>
              <option value="furniture-assembly">Furniture Assembly</option>
              <option value="painting">Painting</option>
              <option value="handyman">Handyman</option>
              <option value="landscaping">Landscaping</option>
              <option value="pet-care">Pet Care</option>
              <option value="delivery">Delivery</option>
              <option value="car-cleaning">Car Cleaning</option>
              <option value="event-setup">Event Setup</option>
              <option value="snow-removal">Snow Removal</option>
              <option value="other">Other</option>
            </select>

            <!-- Popular Categories - Big tappable chips -->
            <div id="categoryChips" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
              <button type="button" class="category-chip" data-value="moving" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🚚 Moving
              </button>
              <button type="button" class="category-chip" data-value="yard-work" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🌿 Yard Work
              </button>
              <button type="button" class="category-chip" data-value="dump-run" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🗑️ Dump Run
              </button>
              <button type="button" class="category-chip" data-value="cleaning" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🧹 Cleaning
              </button>
              <button type="button" class="category-chip" data-value="power-washing" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                💦 Power Wash
              </button>
              <button type="button" class="category-chip" data-value="furniture-assembly" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🔧 Assembly
              </button>
            </div>
            
            <!-- See More Categories -->
            <div id="moreCategoriesSection">
              <button type="button" id="showMoreCategoriesBtn" style="width: 100%; padding: 0.6rem; border: 1px dashed var(--border); background: transparent; border-radius: 8px; color: var(--primary); font-size: 0.9rem; cursor: pointer; transition: all 0.2s;">
                + See all categories
              </button>
              
              <div id="allCategoriesGrid" style="display: none; margin-top: 0.75rem;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                  <button type="button" class="category-chip" data-value="painting" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🎨 Painting</button>
                  <button type="button" class="category-chip" data-value="handyman" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🔨 Handyman</button>
                  <button type="button" class="category-chip" data-value="landscaping" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🌳 Landscaping</button>
                  <button type="button" class="category-chip" data-value="pet-care" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🐕 Pet Care</button>
                  <button type="button" class="category-chip" data-value="delivery" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🚚 Delivery</button>
                  <button type="button" class="category-chip" data-value="car-cleaning" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🚿 Car Cleaning</button>
                  <button type="button" class="category-chip" data-value="event-setup" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🎪 Event Setup</button>
                  <button type="button" class="category-chip" data-value="snow-removal" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">❄️ Snow Removal</button>
                  <button type="button" class="category-chip" data-value="other" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left; grid-column: span 2;">✨ Other / Custom Job</button>
                </div>
              </div>
            </div>
            
            <!-- Selected category display -->
            <div id="selectedCategoryDisplay" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: var(--primary-soft); border: 2px solid var(--primary); border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="selectedCategoryText" style="font-weight: 600; color: var(--primary);"></span>
                <button type="button" id="changeCategoryBtn" style="padding: 0.25rem 0.5rem; background: transparent; border: 1px solid var(--primary); border-radius: 4px; color: var(--primary); font-size: 0.8rem; cursor: pointer;">Change</button>
              </div>
            </div>
          </div>

          <!-- Custom category input (shown when "Other" is selected) -->
          <div class="field" id="customCategoryField" style="display: none;">
            <label for="customCategory">Describe your job type</label>
            <input id="customCategory" type="text" placeholder="What kind of help do you need?" />
          </div>

          <!-- Sub-tags (shown based on category) -->
          <div id="subTagsContainer" class="field" style="display: none;">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span>🏷️ More details</span>
              <span class="muted" style="font-weight: 400;">(optional)</span>
            </label>
            <div id="subTagsGrid" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <!-- Dynamically populated -->
            </div>
          </div>

          <div class="field" style="margin-bottom: 1.5rem;">
            <label for="jobDescription" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600; font-size: 1rem;">
              <span>📝 Job Description</span>
              <span style="color: #dc2626; font-size: 0.9rem;">*</span>
            </label>
            <textarea 
              id="jobDescription" 
              rows="8" 
              style="min-height: 180px; width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; line-height: 1.6; resize: vertical; font-family: inherit; -webkit-appearance: none; touch-action: manipulation;" 
              placeholder="Describe your job in detail. The more specific, the better!"
            ></textarea>
            
            <!-- Detailed guidance (collapsible) -->
            <div style="margin-top: 0.75rem;">
              <button 
                type="button" 
                id="descriptionGuidanceToggle" 
                style="width: 100%; padding: 0.875rem; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; color: #0369a1; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: space-between; min-height: 48px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
              >
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                  <span>📋</span>
                  <span>What to include in your description</span>
                </span>
                <span id="descriptionGuidanceIcon" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
              </button>
              
              <div id="descriptionGuidanceContent" style="display: none; margin-top: 0.75rem; padding: 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border: 2px solid #3b82f6;">
                <div style="font-weight: 700; font-size: 1rem; color: #1e40af; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                  <span>✨</span>
                  <span>Make your description crystal clear!</span>
          </div>
          
                <div style="display: flex; flex-direction: column; gap: 0.875rem;">
                  <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.875rem; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.25rem; flex-shrink: 0;">🚛</span>
                    <div>
                      <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">Truck / Vehicle Needed</div>
                      <div style="font-size: 0.9rem; color: #1e3a8a; line-height: 1.5;">Do they need to rent a U-Haul or bring a big truck? What size? (e.g., "Need U-Haul 15ft truck", "Pickup truck required") Will you give money for the U-Haul or supply it yourself?</div>
                    </div>
          </div>
          
                  <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.875rem; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.25rem; flex-shrink: 0;">👥</span>
                    <div>
                      <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">How Many People</div>
                      <div style="font-size: 0.9rem; color: #1e3a8a; line-height: 1.5;">How many workers do you need? (You'll also set this below, but mention it here too for clarity)</div>
              </div>
              </div>
                  
                  <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.875rem; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.25rem; flex-shrink: 0;">📍</span>
                    <div>
                      <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">Another Location?</div>
                      <div style="font-size: 0.9rem; color: #1e3a8a; line-height: 1.5;">Is there a pickup AND dropoff location? Moving from one place to another? Mention both addresses.</div>
            </div>
          </div>
          
                  <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.875rem; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.25rem; flex-shrink: 0;">⏰</span>
                    <div>
                      <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">How Many Hours</div>
                      <div style="font-size: 0.9rem; color: #1e3a8a; line-height: 1.5;">How long do you think this will take? (e.g., "About 3-4 hours", "Half day job")</div>
          </div>
          </div>
          
                  <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.875rem; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.25rem; flex-shrink: 0;">🧹</span>
                    <div>
                      <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem;">What Needs to be Cleaned?</div>
                      <div style="font-size: 0.9rem; color: #1e3a8a; line-height: 1.5;">Be specific! (e.g., "Everything - all rooms, bathrooms, kitchen, windows", "Just the garage", "Deep clean bathrooms only")</div>
                    </div>
          </div>

                  <div style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.875rem; background: white; border-radius: 8px; border-left: 4px solid #10b981;">
                    <span style="font-size: 1.25rem; flex-shrink: 0;">💡</span>
                    <div>
                      <div style="font-weight: 600; color: #059669; margin-bottom: 0.25rem;">Other Important Details</div>
                      <div style="font-size: 0.9rem; color: #047857; line-height: 1.5;">Stairs? Heavy items? Tight spaces? Access codes? Parking? Pets? Anything else hustlers should know!</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- When Section - Simplified: Default to flexible deadline -->
          <input type="hidden" id="jobWhen" value="no_deadline" />
          <input type="hidden" id="preferredTime" value="anytime" />
          <input type="hidden" id="jobDuration" value="30" />

          <!-- Equipment Needed Section (Collapsible) -->
          <div style="margin-bottom: 1.5rem;">
            <button 
              type="button" 
              id="equipmentSectionToggle" 
              style="width: 100%; padding: 0.875rem; background: #f9fafb; border: 2px solid var(--border); border-radius: 12px; color: var(--text-main); font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: space-between; min-height: 48px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
            >
              <span style="display: flex; align-items: center; gap: 0.5rem;">
                <span>🔧</span>
                <span>Equipment Needed</span>
                <span class="muted" style="font-weight: 400; font-size: 0.85rem;">(optional)</span>
              </span>
              <span id="equipmentSectionIcon" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
            </button>
            
            <div id="equipmentSectionContent" style="display: none; margin-top: 0.75rem; padding: 1rem; background: #f9fafb; border-radius: 12px; border: 2px solid var(--border);">
              <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); line-height: 1.5;">Does the hustler need to bring any equipment? Tap to select.</p>
              
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="truck"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🚛 Truck
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="pickup-truck"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🚚 Pick up truck
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="trailer"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🚗 Trailer
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="straps"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🪢 Moving Straps
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="dolly"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🛒 Dolly
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="tools"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🧰 Tools
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="lawnmower"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🌿 Lawn Mower
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="pressure-washer"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  💦 Pressure Washer
                </button>
                <button 
                  type="button" 
                  class="equipment-chip" 
                  data-equipment="ladder"
                  style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  🪜 Ladder
                </button>
              </div>
              
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <button 
                  type="button" 
                  id="customEquipmentToggle" 
                  style="width: 100%; padding: 0.75rem; border: 1px dashed var(--border); background: transparent; border-radius: 8px; color: var(--primary); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
                >
                  + Other equipment
                </button>
                <div id="customEquipmentField" style="display: none; margin-top: 0.75rem;">
                  <input 
                    id="customEquipment" 
                    type="text" 
                    placeholder="Describe other equipment needed..." 
                    style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; min-height: 52px; -webkit-appearance: none; touch-action: manipulation;"
                  />
              </div>
              </div>
            </div>
          </div>

          <!-- Workers Needed -->
          <div class="field" style="margin-bottom: 1.5rem;">
            <label for="workersNeeded" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600; font-size: 1rem;">
              <span>👥 Workers needed</span>
              <span style="color: #dc2626; font-size: 0.9rem;">*</span>
            </label>
            <select 
              id="workersNeeded" 
              style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; background: white; min-height: 52px; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23334155%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polyline points=%226 9 12 15 18 9%22></polyline></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.5rem; padding-right: 3.5rem; touch-action: manipulation; cursor: pointer;"
            >
              <option value="1">1 person</option>
              <option value="2">2 people</option>
              <option value="3">3 people</option>
              <option value="4">4 people</option>
              <option value="5">5 people</option>
              <option value="6">6 people</option>
              <option value="company">Company</option>
            </select>
            </div>

          <div class="section-title" style="margin-top: 1rem; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-main); font-size: 1.1rem;">📍 Approximate Location</div>

          <!-- Approximate Location Map -->
          <div style="margin-bottom: 1.5rem;">
            <div class="field" style="margin-bottom: 0.75rem;">
              <label for="approximateLocationMap">Tap the map to set approximate location <span style="color: #dc2626;">*</span></label>
              
              <!-- Location helpers (not stored, just for navigation) - Mobile optimized -->
              <div style="margin-bottom: 0.75rem;">
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <button 
                    type="button"
                    id="useCurrentLocationBtn" 
                    style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: white; color: var(--text-main); cursor: pointer; font-weight: 500; transition: all 0.2s; min-height: 44px; -webkit-tap-highlight-color: transparent; touch-action: manipulation;"
                  >
                    📍 Current Location
                  </button>
                  <input 
                    type="text" 
                    id="approximateLocationSearch" 
                    placeholder="🔍 Or search address"
                    style="width: 100%; padding: 0.875rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; min-height: 44px; -webkit-appearance: none; touch-action: manipulation;"
                    autocomplete="off"
                  />
            </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.4;">
                  These help you find the area on the map. Your exact location is never stored.
            </div>
          </div>

              <div id="approximateLocationMap" style="width: 100%; height: 300px; min-height: 300px; border: 2px solid var(--border); border-radius: 8px; position: relative; background: #f3f4f6; cursor: crosshair; touch-action: pan-x pan-y pinch-zoom; pointer-events: auto !important; z-index: 1;"></div>
              <input type="hidden" id="approximateLat" />
              <input type="hidden" id="approximateLng" />
              <div id="locationStatus" style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                Tap the map to place your approximate location
          </div>
            </div>

            <!-- Privacy Notice -->
            <div style="padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 4px solid var(--primary); margin-top: 1rem;">
              <p style="margin: 0; font-size: 0.9rem; color: #1e40af; line-height: 1.5;">
                <strong>🔒 Privacy Protection:</strong> This location is approximate and visible to hustlers. Do not place this marker on your exact address. It is only meant to give hustlers a general idea of where the job is. Your exact address will only be shared with the hustler you accept.
              </p>
            </div>
            </div>

          <!-- Pricing Section (Collapsible) -->
          <div style="margin-bottom: 1.5rem;">
            <button 
              type="button" 
              id="pricingSectionToggle" 
              style="width: 100%; padding: 1rem; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; color: #0369a1; font-size: 1.05rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: space-between; min-height: 56px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; margin-bottom: 0.75rem;"
            >
              <span style="display: flex; align-items: center; gap: 0.5rem;">
                <span>💰</span>
                <span>Pricing</span>
              </span>
              <span id="pricingSectionIcon" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
            </button>
            
            <div id="pricingSectionContent" style="display: none;">
          <!-- Pricing Option -->
              <div class="field" style="margin-bottom: 1rem;">
                <label for="pricingOption" style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  <span>How do you want to set the price?</span>
                  <span style="color: #dc2626; font-size: 0.9rem;">*</span>
                </label>
                <select 
                  id="pricingOption" 
                  style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; background: white; min-height: 52px; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23334155%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polyline points=%226 9 12 15 18 9%22></polyline></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.5rem; padding-right: 3.5rem; touch-action: manipulation; cursor: pointer;"
                >
              <option value="set_price">I want to set a price</option>
              <option value="hustlers_quote">Let hustlers give their own price</option>
            </select>
          </div>
          
          <!-- Price Setting Fields (shown when "set_price" is selected) -->
          <div id="priceSettingFields">
              <div class="field" style="margin-bottom: 1rem;">
                <label for="paymentType" style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  <span>Payment type</span>
                  <span style="color: #dc2626; font-size: 0.9rem;">*</span>
                </label>
                <select 
                  id="paymentType" 
                  style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; background: white; min-height: 52px; -webkit-appearance: none; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%23334155%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polyline points=%226 9 12 15 18 9%22></polyline></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1.5rem; padding-right: 3.5rem; touch-action: manipulation; cursor: pointer;"
                >
                  <option value="flat">Flat amount (one-time)</option>
                  <option value="hourly">Hourly + max hours</option>
                </select>
              </div>
              
              <div class="field" id="flatAmountField" style="margin-bottom: 1rem;">
                <label for="flatAmount" style="font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  <span>Pay amount ($)</span>
                  <span style="color: #dc2626; font-size: 0.9rem;">*</span>
                </label>
                <input 
                  id="flatAmount" 
                  type="number" 
                  min="0" 
                  step="1" 
                  value="80" 
                  style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1.25rem; font-weight: 600; min-height: 52px; -webkit-appearance: none; touch-action: manipulation; text-align: center;"
                />
            </div>

            <div id="hourlyFields" style="display:none;">
              <div style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 0.75rem;">Hourly Pay</div>
                
                <div class="field" style="margin-bottom: 0.75rem;">
                  <label for="hourlyRate" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Total hourly rate:</label>
                  <input id="hourlyRate" type="number" min="0" step="1" value="20" style="width: 100%;" />
                  <span style="font-size: 0.85rem; color: var(--text-muted); margin-left: 0.5rem;">/hr</span>
                </div>
                
                <div class="field" style="margin-bottom: 0.75rem;">
                  <label for="maxHours" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Max hours:</label>
                  <input id="maxHours" type="number" min="1" step="1" value="3" style="width: 100%;" />
                </div>
                
                <div id="hourlyRateCalculation" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px;">
                  <div style="font-size: 0.85rem; color: var(--text-main); margin-bottom: 0.5rem; font-weight: 600;">Split between workers</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    Example: <span id="exampleWorkers">2</span> workers → $<span id="examplePerPerson">10</span>/hr each
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Note when hustlers quote -->
              <div id="hustlersQuoteNote" style="display: none; padding: 1rem; background: #fef3c7; border-radius: 12px; border-left: 4px solid #f59e0b; margin-top: 1rem;">
                <p style="margin: 0; font-size: 0.95rem; color: #92400e; line-height: 1.5;">
                  <strong>💡</strong> Hustlers will propose their own prices. You can accept, decline, or negotiate.
                </p>
              </div>
            </div>
          </div>

          <!-- Extra Notes (Collapsible) -->
          <div style="margin-bottom: 1.5rem;">
            <button 
              type="button" 
              id="extraNotesToggle" 
              style="width: 100%; padding: 0.875rem; background: #f9fafb; border: 2px solid var(--border); border-radius: 12px; color: var(--text-main); font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: space-between; min-height: 48px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;"
            >
              <span style="display: flex; align-items: center; gap: 0.5rem;">
                <span>📝</span>
                <span>Extra notes (optional)</span>
              </span>
              <span id="extraNotesIcon" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
            </button>
            
            <div id="extraNotesContent" style="display: none; margin-top: 0.75rem;">
              <textarea 
                id="jobNotes" 
                placeholder="Parking instructions, gate codes, equipment details, pets, any special requests..." 
                style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; line-height: 1.6; resize: vertical; min-height: 120px; font-family: inherit; -webkit-appearance: none; touch-action: manipulation;"
              ></textarea>
            </div>
          </div>

          <div class="field">
            <label for="jobPhoto">📸 Optional photos</label>
            <input id="jobPhoto" type="file" accept="image/*" multiple />
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">You can select multiple photos</div>
          </div>

          <button class="btn btn-primary" id="postJobButton">Post job to Hustl</button>

          <div class="muted" style="margin-top:0.4rem;">
            Your job will be posted and visible to hustlers across Tennessee.
          </div>
        </div>
      </section>

      <!-- JOBS VIEW -->
      <section id="view-jobs" style="display:none;">
        <!-- Filter Button & Sort Row -->
        <div class="card" style="margin-bottom: 0.75rem; padding: 1rem 1rem; display: flex; justify-content: flex-start; align-items: center; min-height: auto;">
          <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap; width: 100%;" class="filters-sort-row">
            <!-- Filters Button with Badge -->
            <button id="filtersToggleBtn" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.9rem; height: 2.25rem; background: white; border: 1.5px solid var(--primary); border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: var(--primary); cursor: pointer; position: relative; box-sizing: border-box; flex-shrink: 0;" class="filters-btn-mobile">
              <span>Filters</span>
              <span id="filtersBadge" style="display: none; background: var(--primary); color: white; border-radius: 12px; padding: 0.15rem 0.5rem; font-size: 0.75rem; font-weight: 600; min-width: 20px; text-align: center;">0</span>
              <span>▾</span>
            </button>
            
            <!-- Sort Dropdown and List/Map Toggle Container -->
            <div style="display: flex; gap: 0.5rem; align-items: center; flex: 1; min-width: 0;" class="sort-and-toggle-container">
            <!-- Sort Dropdown -->
              <div style="min-width: 120px; flex: 1; min-width: 0;" class="sort-dropdown-container">
                <select id="jobsSortSelect" style="width: 100%; padding: 0.5rem; height: 2.25rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; background: white; cursor: pointer; box-sizing: border-box;" class="sort-select-mobile">
                <option value="newest">Newest</option>
                <option value="highest_paid">Highest Paid</option>
                <option value="lowest_paid">Lowest Paid</option>
                <option value="closest">Closest</option>
                <option value="soonest">Soonest Deadline</option>
              </select>
            </div>
            
            <!-- List/Map Toggle -->
              <div style="display: flex; background: #f3f4f6; border-radius: 6px; padding: 0.2rem; border: 1px solid #e5e7eb; flex-shrink: 0;" class="toggle-container-mobile">
              <button id="jobsViewListBtn" class="jobs-view-toggle active" style="padding: 0.4rem 0.75rem; background: white; border: none; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #111827; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: all 0.2s;">
                📋 List
              </button>
              <button id="jobsViewMapBtn" class="jobs-view-toggle" style="padding: 0.4rem 0.75rem; background: transparent; border: none; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.2s;">
                🗺️ Map
              </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Slide-up Filter Panel -->
        <div id="filtersPanel" style="position: fixed; bottom: -100%; left: 0; right: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 1000; max-height: 85vh; overflow-y: auto; transition: bottom 0.3s ease-out; -webkit-overflow-scrolling: touch; visibility: hidden; pointer-events: none;">
          <!-- Panel Header -->
          <div style="position: sticky; top: 0; background: white; border-bottom: 1px solid var(--border); padding: 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 10;">
            <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text-main);">Filters</h3>
            <button id="filtersCloseBtn" style="background: transparent; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0.25rem 0.5rem;">✕</button>
          </div>
          
          <!-- Panel Content -->
          <div style="padding: 1.25rem 1.5rem 1.5rem;">
            <!-- Category Filter -->
            <div style="margin-bottom: 2rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <span style="font-size: 1.1rem;">🏷️</span>
                <div style="font-size: 1rem; font-weight: 700; color: var(--text-main);">Category</div>
              </div>
              <div id="categoryFilterContainer" style="overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: thin; margin-bottom: 0.75rem;">
                <div id="categoryFilterChips" style="display: flex; gap: 0.6rem; flex-wrap: wrap; padding-bottom: 0.5rem;">
                  <!-- Categories will be populated dynamically -->
                </div>
              </div>
              <button id="categoryViewMoreBtn" style="display: none; padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--border); border-radius: 20px; font-size: 0.85rem; color: var(--primary); cursor: pointer; margin-top: 0.5rem;">➕ Show More</button>
              <div id="categoryMoreOptions" style="display: none; margin-top: 0.75rem; gap: 0.6rem; flex-wrap: wrap;"></div>
            </div>
            
            <!-- Price Type Filter -->
            <div style="margin-bottom: 2rem; padding-top: 1.75rem; border-top: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <span style="font-size: 1.1rem;">💰</span>
                <div style="font-size: 1rem; font-weight: 700; color: var(--text-main);">Price Type</div>
              </div>
              <div style="display: flex; gap: 0.6rem; flex-wrap: wrap;">
                <button class="filter-chip price-chip" data-price-type="flat" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">💵 Flat</button>
                <button class="filter-chip price-chip" data-price-type="hourly" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">⏱️ Hourly</button>
                <button class="filter-chip price-chip" data-price-type="hustler_sets" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">💬 Hustler Sets Price</button>
              </div>
            </div>
            
            <!-- Workers Filter -->
            <div style="margin-bottom: 2rem; padding-top: 1.75rem; border-top: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <span style="font-size: 1.1rem;">👥</span>
                <div style="font-size: 1rem; font-weight: 700; color: var(--text-main);">Workers</div>
              </div>
              <div style="display: flex; gap: 0.6rem; flex-wrap: wrap;">
                <button class="filter-chip workers-chip" data-workers="1" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">👤 1 worker</button>
                <button class="filter-chip workers-chip" data-workers="2" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">👥 2 workers</button>
                <button class="filter-chip workers-chip" data-workers="3" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">👥 3+ workers</button>
                <button class="filter-chip workers-chip" data-workers="company" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;">🏢 Company</button>
              </div>
            </div>
            
            <!-- Location Permission & Distance Filter -->
            <div style="margin-bottom: 2rem; padding-top: 1.75rem; border-top: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                <span style="font-size: 1.1rem;">📍</span>
                <div style="font-size: 1rem; font-weight: 700; color: var(--text-main);">Distance (from your location)</div>
              </div>
              
              <!-- Location Status -->
              <div id="locationStatusContainer" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 12px; border: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem;">
                  <div style="font-size: 0.9rem; color: var(--text-main); font-weight: 500;">
                    <span id="locationStatusText">📍 Location not set</span>
                  </div>
                  <button id="requestLocationBtn" style="padding: 0.6rem 1.25rem; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;">Get My Location</button>
                </div>
              </div>
              
              <!-- Distance Filter Chips (hidden until location is set) -->
              <div id="distanceFilterContainer" style="display: none;">
                <div style="display: flex; gap: 0.6rem; flex-wrap: wrap;">
                  <button class="filter-chip distance-chip" data-distance="5" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500;">5 mi</button>
                  <button class="filter-chip distance-chip" data-distance="10" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500;">10 mi</button>
                  <button class="filter-chip distance-chip" data-distance="20" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500;">20 mi</button>
                  <button class="filter-chip distance-chip" data-distance="30" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500;">30 mi</button>
                  <button class="filter-chip distance-chip" data-distance="50" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500;">50 mi</button>
                  <button class="filter-chip distance-chip" data-distance="statewide" style="padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500;">Statewide</button>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="position: sticky; bottom: 0; background: white; padding-top: 1.5rem; border-top: 2px solid #e5e7eb; margin-top: 1rem; display: flex; gap: 0.75rem; padding-bottom: 0.5rem;">
              <button id="clearFiltersBtn" style="flex: 1; padding: 1rem; background: white; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; font-weight: 700; color: var(--text-main); cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">Clear All</button>
              <button id="applyFiltersBtn" style="flex: 2; padding: 1rem; background: var(--primary); border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">Apply Filters</button>
            </div>
          </div>
        </div>
        
        <!-- Panel Overlay (for closing on backdrop click) -->
        <div id="filtersOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none !important; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease-out;"></div>
        
        <!-- Jobs Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0 0.25rem;">
          <div>
            <h2 style="margin: 0; font-size: 1.1rem; color: var(--text-main); font-weight: 600;" id="jobsCardTitle">Jobs near you</h2>
            <span class="muted" id="jobsFilterSummary" style="font-size: 0.8rem;"></span>
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button id="refreshJobsBtn" style="padding: 0.4rem 0.65rem; background: transparent; border: 1px solid var(--border); border-radius: 8px; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;">
              🔄 Refresh
            </button>
          </div>
        </div>
        
        <!-- Jobs List View -->
        <div class="jobs-list" id="jobsList" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        
        <!-- Jobs Map View -->
        <div id="jobsMapContainer" style="display: none; width: 100%; height: calc(100vh - 300px); min-height: 500px; max-height: 800px; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb; background: #f3f4f6; position: relative; margin-bottom: 1rem;">
          <div id="jobsMap" style="width: 100%; height: 100%;"></div>
          <div id="jobsMapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1rem 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; color: #111827; z-index: 10;">
            Loading map...
          </div>
        </div>
        
        <!-- Load More Button -->
        <div id="loadMoreSection" style="text-align: center; padding: 1rem; display: none;">
          <button id="loadMoreJobsBtn" style="padding: 0.75rem 2rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Load More Jobs
          </button>
        </div>
      </section>

      <!-- MESSAGES VIEW -->
      <section id="view-messages" style="display:none;">
        <div class="messages-layout">
          <!-- Conversations List -->
          <div class="conversations-sidebar">
            <div class="conversations-header">
              <h3 style="margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                💬 Messages
              </h3>
              <span id="unreadBadge" class="unread-badge" style="display: none;">0</span>
            </div>
            <!-- Conversation Tabs -->
            <div class="conversation-tabs" style="display: flex; border-bottom: 1px solid #e9ecef; padding: 0 0.75rem; background: white;">
              <button class="conversation-tab active" data-conv-tab="active" style="flex: 1; padding: 0.75rem; background: transparent; border: none; border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;">
                Active
              </button>
              <button class="conversation-tab" data-conv-tab="deleted" style="flex: 1; padding: 0.75rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 500; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;">
                Deleted
              </button>
            </div>
            <div class="conversations-list" id="conversationList"></div>
          </div>
          
          <!-- Chat Area -->
          <div class="chat-area">
            <div class="chat-header">
              <button class="chat-back-btn" id="chatBackBtn" style="display: none;">←</button>
              <div class="chat-header-content">
              <div id="conversationTitle" style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">Select a conversation</div>
              <div id="conversationJobSummary" style="font-size: 0.8rem; color: var(--text-muted);"></div>
              </div>
            </div>
            <div class="chat-messages-container" id="conversationMessages">
              <div class="empty-chat" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">💬</div>
                <div style="font-weight: 600; margin-bottom: 0.5rem;">No conversation selected</div>
                <div style="font-size: 0.9rem;">Pick a job from the list to start chatting</div>
              </div>
            </div>
            <div class="chat-input-area">
              <input id="conversationInput" type="text" placeholder="Type a message..." class="chat-input" />
              <button class="btn btn-primary chat-send-btn" id="conversationSendButton">
                <span>Send</span>
                <span style="margin-left: 0.25rem;">→</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- MANAGE JOBS VIEW -->
      <section id="view-manage-jobs" style="display:none;">
        <div style="padding: 1rem; max-width: 1200px; margin: 0 auto;">
          <h1 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1.5rem 0; color: var(--text-main);">📋 Manage Jobs</h1>
          
          <!-- Tabs with blue highlighting -->
          <div class="profile-tabs" style="margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
            <button class="profile-tab active manage-tab" data-manage-tab="posted" style="position: relative;">
              📋 Posted
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: block;"></span>
            </button>
            <button class="profile-tab manage-tab" data-manage-tab="active" style="position: relative;">
              🟡 Active
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: none;"></span>
            </button>
            <button class="profile-tab manage-tab" data-manage-tab="completed" style="position: relative;">
              ✅ Completed
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: none;"></span>
            </button>
            <button class="profile-tab manage-tab" data-manage-tab="applied" style="position: relative; display: none;" id="appliedJobsTab">
              📝 Applied
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: none;"></span>
            </button>
          </div>
          
          <!-- Posted Jobs Tab -->
          <div id="manageTabPosted" class="profile-tab-content active">
            <div style="margin-bottom: 1.5rem;">
              <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">📋 Posted</h2>
              <div style="color: var(--text-muted); font-size: 0.9rem;">Manage your job postings, review applicants, and track activity</div>
            </div>
            <div id="managePostedJobsList" style="display: grid; gap: 1.5rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Active Jobs Tab -->
          <div id="manageTabActive" class="profile-tab-content" style="display: none;">
            <div style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">Jobs currently happening. View details, message, navigate to map, mark started/finished, or cancel.</div>
            <div id="manageActiveJobsList" style="display: grid; gap: 1rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Completed Jobs Tab -->
          <div id="manageTabCompleted" class="profile-tab-content" style="display: none;">
            <div style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">All finished jobs. View final pay, rate the worker, view reviews, re-hire, or favorite.</div>
            <div id="manageCompletedJobsList" style="display: grid; gap: 1rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Applied Jobs Tab (Hustler only) -->
          <div id="manageTabApplied" class="profile-tab-content" style="display: none;">
            <div style="margin-bottom: 1.5rem;">
              <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">📝 Applied</h2>
              <div style="color: var(--text-muted); font-size: 0.9rem;">Track your applications and see their status</div>
            </div>
            <div id="manageAppliedJobsList" style="display: grid; gap: 1.5rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" style="display:none;">
        <!-- Basic Info Section -->
        <div id="profileBasicInfo" class="profile-basic-info">
          <div style="padding: 2rem; text-align: center; color: var(--text-muted);">Loading profile...</div>
        </div>
        
        <!-- Quick Stats -->
        <div id="profileQuickStats" class="profile-quick-stats"></div>
        
        <!-- Tab Navigation (styled like manage jobs tabs) -->
        <div class="profile-tabs" style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.75rem;">
          <button class="profile-tab manage-tab active" data-tab="settings" style="position: relative;">⚙️ Settings</button>
          <button class="profile-tab manage-tab" data-tab="ratings" style="position: relative;">⭐ View Ratings</button>
          <button class="profile-tab manage-tab" data-tab="jobs" style="position: relative;">📋 Jobs</button>
        </div>
        
        <!-- Settings Tab -->
        <div id="profileTabSettings" class="profile-tab-content active">
          <div class="profile-section-grid">
            <!-- Left Column -->
            <div>
              <!-- Preferences -->
              <div class="card profile-settings-card" style="margin-top: 1rem;">
                <div class="card-header">
                  <div class="card-title">🔔 Preferences</div>
                </div>
                <div id="profilePreferences">
                  <div class="preference-item">
                    <div>
                      <div class="preference-label">Email Notifications</div>
                      <div class="preference-desc">Get notified about new jobs and messages</div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="prefEmailNotif">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  <div class="preference-item">
                    <div>
                      <div class="preference-label">Job Alerts</div>
                      <div class="preference-desc">Get alerts for jobs near you</div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="prefJobAlerts">
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right Column -->
            <div>
              <!-- Payment Setup -->
              <div class="card profile-settings-card" id="stripeConnectSection">
                <div class="card-header">
                  <div class="card-title" style="color: #16a34a;">💳 Payment Setup</div>
                </div>
                <div id="stripeConnectContent"></div>
              </div>
              
              <!-- Account Actions -->
              <div class="card profile-settings-card" style="margin-top: 1rem;">
                <div class="card-header">
                  <div class="card-title">🔐 Account</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <button class="btn btn-ghost" id="changePasswordBtn" style="width: 100%; justify-content: flex-start; gap: 0.5rem;">
                    🔑 Change Password
                  </button>
                  <button class="btn btn-ghost" id="profileSignOutBtn" data-action="signout" style="width: 100%; justify-content: flex-start; gap: 0.5rem; color: #dc2626; border-color: #fecaca;">
                    🚪 Sign Out
                  </button>
                  <button class="btn btn-ghost" id="deleteAccountBtn" style="width: 100%; justify-content: flex-start; gap: 0.5rem; color: #dc2626; border-color: #dc2626; margin-top: 0.5rem;">
                    🗑️ Delete Account
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ratings Tab -->
        <div id="profileTabRatings" class="profile-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">⭐ Your Ratings & Reviews</div>
            </div>
            <div id="profileRatingsContent" style="padding: 1.5rem;">
              <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">⭐</div>
                <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;" id="profileRatingValue">
                  ${user.ratingAvg ? user.ratingAvg.toFixed(1) : (user.ratingCount > 0 ? '0.0' : '0.0')}
                </div>
                <div style="color: var(--text-muted); margin-bottom: 1.5rem;" id="profileRatingCount">
                  Based on ${user.ratingCount || 0} ${user.ratingCount === 1 ? 'review' : 'reviews'}
                </div>
                <div id="profileReviewsList" style="text-align: left; margin-top: 2rem;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Jobs Tab -->
        <div id="profileTabJobs" class="profile-tab-content" style="display: none;">
          <div id="profileJobsList" style="padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
            <div style="text-align: center; padding: 2rem; color: #64748b; font-family: inherit;">Loading...</div>
          </div>
        </div>
        
      </section>

      <!-- OWNER VIEW -->
      <section id="view-owner" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Owner dashboard (demo)</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Shows paid jobs, your 12% fee, and whether you've sent the Hustler their payout.
            </div>
            <div id="ownerPaidList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Assigned but not paid yet</div>
            </div>
            <div id="ownerAssignedList"></div>
          </div>
        </div>
      </section>

      <!-- FEEDBACK VIEW -->
      <section id="view-feedback" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Send feedback to Hustl</div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            This isn’t a public review wall. It’s a private way to send feedback directly to the Hustl team
            (<strong>team.hustlapp@outlook.com</strong>) about bugs, ideas, or issues.
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="feedbackName">Name (optional)</label>
              <input id="feedbackName" type="text" placeholder="Your name or leave blank" />
            </div>
            <div class="field">
              <label for="feedbackEmailOld">Email (optional)</label>
              <input id="feedbackEmailOld" type="email" placeholder="So we can reply if needed" />
            </div>
          </div>
          <div class="field">
            <label for="feedbackMessage">Feedback</label>
            <textarea id="feedbackMessage" placeholder="Tell us what’s working, what’s confusing, or what you’d love to see."></textarea>
          </div>
          <button class="btn btn-primary" id="feedbackButton">Send feedback</button>
          <div class="feedback-note">
            Your feedback will be sent to the Hustl team. We read every message!
          </div>
        </div>
      </section>

          <!-- ABOUT / LEGAL VIEW -->
      <section id="view-about" style="display:none;">
        <!-- Hero Section -->
        <div style="text-align: center; padding: 2rem 1rem; max-width: 600px; margin: 0 auto;">
          
          <!-- Icon -->
          <div style="width: 80px; height: 80px; margin: 1.5rem auto 1.25rem; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          
          <!-- Main Headline -->
          <h1 style="font-size: 2rem; font-weight: 700; line-height: 1.2; margin: 0 0 0.75rem; color: var(--text-main);">
            About Hustl
          </h1>
          
          <!-- Subheadline -->
          <p style="font-size: 1rem; color: var(--text-muted); margin: 0 0 1.5rem; line-height: 1.5;">
            Founded in Brentwood, TN – built to make it easier for people to help each other and make real money on the side.
          </p>
        </div>
        
        <!-- About Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          
          <!-- Card 1: For Customers -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(251, 191, 36, 0.3); background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">👥</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: #fbbf24;">For Customers</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0; line-height: 1.5;">If you need help – moving, yard work, errands – describe the job, set a fair price, and connect with someone local who's ready to work.</p>
          </div>
          
          <!-- Card 2: For Hustlers -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">💪</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--primary);">For Hustlers</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0; line-height: 1.5;">Turn your time, truck, or muscle into extra cash on your own schedule. No long-term commitments – just clear jobs and clear payouts.</p>
          </div>
          
          <!-- Card 3: Our Mission -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(34, 197, 94, 0.3); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">🎯</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--success);">Our Mission</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0; line-height: 1.5;">Supporting small, local businesses and solo operators. Help people build regular clients, repeat work, and real side-income in the community.</p>
          </div>
        </div>
        
        <!-- Main Message Card -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(37, 99, 235, 0.2); background: white; text-align: center; padding: 2rem 1.5rem;">
          <p style="margin: 0; font-weight: 600; color: var(--primary); font-size: 1.125rem; line-height: 1.6;">
            Post a job, apply to one, show up, do solid work, and get paid – that's the heart of Hustl.
          </p>
          <p style="margin: 1rem 0 0 0; font-size: 1.25rem; font-weight: 600; color: var(--primary);">
            Just keep hustling. 💪
          </p>
        </div>
        
        <!-- Contact & Social -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2); background: white;">
          <h2 style="font-size: 1.2rem; margin: 0 0 1rem; color: var(--text-main);">
            📞 Get in Touch
          </h2>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <a href="mailto:team.hustlapp@outlook.com" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; text-decoration: none; color: var(--text-main); border: 1px solid var(--border); transition: all 0.2s;">
              <div style="font-size: 1.5rem;">📧</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem; color: var(--text-main);">Email Us</div>
                <div style="color: var(--primary); font-size: 0.85rem; font-weight: 500;">team.hustlapp@outlook.com</div>
              </div>
            </a>
            <a href="https://instagram.com/team.hustlapp" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; text-decoration: none; color: var(--text-main); border: 1px solid var(--border); transition: all 0.2s;">
              <div style="font-size: 1.5rem;">📷</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem; color: var(--text-main);">Follow Us</div>
                <div style="color: var(--primary); font-size: 0.85rem; font-weight: 500;">@team.hustlapp</div>
              </div>
            </a>
          </div>
        </div>
        
        <!-- Feedback Form -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2); background: white;">
          <h2 style="font-size: 1.2rem; margin: 0 0 1rem; color: var(--text-main);">
            💬 Send Feedback
          </h2>
          <form id="feedbackForm">
            <div class="field" style="margin-bottom: 1rem;">
              <label for="feedbackEmail" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main); font-size: 0.9rem;">Your Email <span style="font-weight: 400; color: var(--text-muted);">(optional)</span></label>
              <input type="email" id="feedbackEmail" placeholder="your@email.com" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: border-color 0.2s;" />
            </div>
            <div class="field" style="margin-bottom: 1rem;">
              <label for="feedbackMessage" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main); font-size: 0.9rem;">Your Feedback</label>
              <textarea id="feedbackMessage" rows="5" placeholder="Tell us what you think, report a bug, or suggest a feature..." required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical; transition: border-color 0.2s; line-height: 1.6;"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 0.95rem; font-weight: 600;">Send Feedback</button>
          </form>
        </div>
        
        <!-- Terms and Conditions -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2); background: white;">
          <h2 style="font-size: 1.2rem; margin: 0 0 1rem; color: var(--text-main);">
            📋 Terms and Conditions
          </h2>
          <p style="margin-bottom: 1rem; font-size: 0.95rem; line-height: 1.6; color: var(--text-muted);">
            By using Hustl, you agree to our <strong style="color: var(--text-main); font-weight: 600;">Terms and Conditions</strong>. Last updated: January 20, 2025.
          </p>
          <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem;">
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                User Responsibilities
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                You are responsible for all content you post, all jobs you accept, and all payments you make or receive through the platform.
              </p>
            </div>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                Payment Terms
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                Payments are processed securely through Stripe. Hustl charges a 12% platform fee. All jobs must be paid through the platform.
              </p>
            </div>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                Tennessee-Only Service
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                Hustl operates exclusively in Tennessee. You must be 18+ and all jobs must take place within Tennessee.
              </p>
            </div>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                Prohibited Content
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                Illegal activities, adult services, or off-platform payments are strictly prohibited and will result in account termination.
              </p>
            </div>
          </div>
          <div style="text-align: center; margin-top: 1rem;">
            <a href="terms.html" target="_blank" class="btn btn-primary" style="display: inline-block; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem;">Read Full Terms →</a>
          </div>
        </div>
        
        <!-- Privacy Policy -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2); background: white;">
          <h2 style="font-size: 1.2rem; margin: 0 0 1rem; color: var(--text-main);">
            🔒 Privacy Policy
          </h2>
          <p style="margin-bottom: 1rem; font-size: 0.95rem; line-height: 1.6; color: var(--text-muted);">
            Your privacy is important to us. This <strong style="color: var(--text-main); font-weight: 600;">Privacy Policy</strong> explains how we collect, use, and protect your information. Last updated: January 20, 2025.
          </p>
          <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem;">
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                Information We Collect
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                Account info (name, email, profile), job and transaction data, payment info (processed by Stripe), and automatic data (device, IP, location).
              </p>
            </div>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                How We Use Your Information
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                To operate the platform, process payments, communicate with you, ensure safety and security, and comply with legal obligations.
              </p>
            </div>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                Data Security & Storage
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                We use encryption, secure cloud storage in the U.S., and industry-standard security measures. Payment data is handled by PCI-DSS compliant processors.
              </p>
            </div>
            <div style="background: #f9fafb; padding: 1rem; border-radius: 8px; border-left: 3px solid var(--primary);">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: var(--text-main); font-size: 0.9rem;">
                Your Privacy Rights
              </p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                You can access, correct, or delete your account information. We honor Tennessee Information Protection Act (TIPA) principles. Contact us to exercise your rights.
              </p>
            </div>
          </div>
          <div style="text-align: center; margin-top: 1rem;">
            <a href="privacy.html" target="_blank" class="btn btn-primary" style="display: inline-block; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem;">Read Full Privacy Policy →</a>
          </div>
        </div>
      </section>

    </main>

    <footer>
      <div class="footer-row">
        <div>© 2025 Hustl. All rights reserved.</div>
        <div class="footer-links">
          <a href="#" onclick="setView('about'); return false;" id="footerAboutLink">About Us</a>
          <span>•</span>
          <a href="terms.html" id="footerTermsLink" style="color: #ffffff !important;">Terms of Use</a>
          <span>•</span>
          <a href="privacy.html" id="footerPrivacyLink" style="color: #ffffff !important;">Privacy Policy</a>
          <span>•</span>
          <a href="mailto:team.hustlapp@outlook.com" style="color: #ffffff !important;">team.hustlapp@outlook.com</a>
          <span>·</span>
          <a href="#" onclick="setView('messages'); return false;" style="color: #ffffff !important;">Messages</a>
          <span>·</span>
          <a href="https://instagram.com/team.hustlapp" target="_blank" rel="noopener noreferrer" style="color: #ffffff !important;">@team.hustlapp</a>
        </div>
      </div>
    </footer>

       <div class="toast" id="toast"></div>

    <!-- Age gate disabled: popup hidden -->
    <div class="age-gate-overlay" id="ageGate" style="display:none;">
      <div class="age-gate-card">
        <h2>Are you 18 or older?</h2>
        <p>
          Hustl is for adults only. By continuing, you confirm that you are at least 18 years old.
        </p>
        <div class="age-gate-buttons">
          <button class="btn btn-primary" id="ageYesButton">Yes, I’m 18+</button>
          <button class="btn btn-ghost" id="ageNoButton">No</button>
        </div>
        <div class="muted" style="margin-top:0.4rem;">
          If you tap “No”, we’ll just hide the app. You can come back when you’re older.
        </div>
      </div>
    </div>
  </div>

<!-- Backend API Configuration -->
<script>
  // Set your Railway backend URL here
  window.HUSTL_CONFIG = {
    API_URL: 'https://hustl-production.up.railway.app' // Railway backend URL
  };
  
  // Auto-detect localhost for development
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.HUSTL_CONFIG.API_URL = 'http://localhost:4000';
  }
</script>
<script src="/api-integration.js?v=3"></script>
<script>
  // Simple stub functions - will be replaced when real functions are defined
  // The stub actually works as a fallback to ensure navigation always functions
  window.setView = async function(view) {
    console.log("⚠️ setView stub called, using fallback for view:", view);
    // Fallback implementation - manually switch views
    if (typeof window.activeView !== 'undefined') {
      window.activeView = view;
    }
    // Hide all views
    document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
    // Show target view
    const target = document.getElementById("view-" + view);
    if (target) {
      target.style.display = "block";
      window.scrollTo({ top: 0, behavior: 'instant' });
    }
    // Update nav tabs
    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.classList.toggle("active", tab.dataset.view === view);
    });
    
    // Initialize map when post view is shown
    if (view === 'post') {
      setTimeout(async () => {
        if (typeof initApproximateLocationMap === 'function') {
          await initApproximateLocationMap();
          
          // CRITICAL: Ensure map is clickable after initialization - add backup handler
          setTimeout(() => {
            const mapContainer = document.getElementById('approximateLocationMap');
            if (mapContainer && typeof approximateLocationMap !== 'undefined' && approximateLocationMap) {
              mapContainer.style.pointerEvents = 'auto';
              mapContainer.style.cursor = 'crosshair';
              
              // Force re-attach click handler as backup
              try {
                approximateLocationMap.off('click'); // Remove any existing
                approximateLocationMap.on('click', (e) => {
                  console.log('Backup map click handler triggered:', e.lngLat);
                  const { lng, lat } = e.lngLat;
                  const latInput = document.getElementById('approximateLat');
                  const lngInput = document.getElementById('approximateLng');
                  if (latInput) latInput.value = lat;
                  if (lngInput) lngInput.value = lng;
                  
                  const statusDiv = document.getElementById('locationStatus');
                  if (statusDiv) {
                    statusDiv.textContent = `Location set: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    statusDiv.style.color = 'var(--primary)';
                  }
                  
                  // Update or create marker
                  if (typeof approximateLocationMarker !== 'undefined' && approximateLocationMarker) {
                    approximateLocationMarker.setLngLat([lng, lat]);
                    if (typeof updateApproximateCircle === 'function') {
                      updateApproximateCircle(lng, lat);
                    }
                  } else {
                    // Create marker if it doesn't exist
                    if (typeof mapboxgl !== 'undefined') {
                      approximateLocationMarker = new mapboxgl.Marker({
                        color: '#2563eb',
                        draggable: true
                      })
                        .setLngLat([lng, lat])
                        .addTo(approximateLocationMap);
                      if (typeof updateApproximateCircle === 'function') {
                        updateApproximateCircle(lng, lat);
                      }
                    }
                  }
                });
                console.log('✅ Backup click handler attached to map');
              } catch (err) {
                console.warn('Could not attach backup click handler:', err);
              }
            }
          }, 500);
        }
      }, 300);
    }
    
    // Initialize manage jobs tabs when manage-jobs view is shown
    if (view === 'manage-jobs') {
      setTimeout(() => {
        // Initialize tab switching
        const manageTabs = document.querySelectorAll('.manage-tab[data-manage-tab]');
        manageTabs.forEach(tab => {
          // Remove existing listeners to avoid duplicates
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          newTab.addEventListener('click', (e) => {
            e.preventDefault();
            const tabName = newTab.dataset.manageTab;
            
            // Hide all tab contents
            document.querySelectorAll('.profile-tab-content').forEach(content => {
              content.style.display = 'none';
              content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.manage-tab[data-manage-tab]').forEach(t => {
              t.classList.remove('active');
              const indicator = t.querySelector('.tab-indicator');
              if (indicator) indicator.style.display = 'none';
            });
            
            // Show selected tab content
            const tabContent = document.getElementById(`manageTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (tabContent) {
              tabContent.style.display = 'block';
              tabContent.classList.add('active');
            }
            
            // Add active class to clicked tab
            newTab.classList.add('active');
            const indicator = newTab.querySelector('.tab-indicator');
            if (indicator) indicator.style.display = 'block';
            
            // Load appropriate data
            console.log("🔵 Tab clicked:", tabName);
            if (tabName === 'posted') {
              console.log("🔵 Loading posted jobs");
              if (typeof loadPostedJobs === 'function') loadPostedJobs();
            } else if (tabName === 'active') {
              console.log("🔵 Loading active jobs");
              if (typeof loadActiveJobs === 'function') loadActiveJobs();
            } else if (tabName === 'completed') {
              console.log("🔵 Loading completed jobs");
              if (typeof loadCompletedJobs === 'function') {
                console.log("🔵 loadCompletedJobs function exists, calling...");
                loadCompletedJobs(true);
              } else {
                console.error("❌ loadCompletedJobs function not found!");
              }
            } else if (tabName === 'applied') {
              console.log("🔵 Loading applied jobs");
              if (typeof loadAppliedJobs === 'function') loadAppliedJobs();
            }
          });
        });
        
        // Load default tab (posted)
        const defaultTab = document.querySelector('.manage-tab[data-manage-tab="posted"]');
        if (defaultTab) {
          defaultTab.click();
        } else if (typeof loadPostedJobs === 'function') {
          loadPostedJobs();
        }
      }, 100);
    }
    
    // Call renderAll if available
    if (typeof window.renderAll === 'function') {
      setTimeout(async () => {
        try {
          await window.renderAll();
        } catch (err) {
          console.error("Error in stub renderAll:", err);
        }
      }, 50);
    }
  };
  window.openAuthModal = function(mode) {
    console.warn("openAuthModal not ready yet, mode:", mode);
  };
  window.closeAuthModal = function() {
    console.warn("closeAuthModal not ready yet");
  };
  // Stub will be replaced by real function below
  window.handleSignOut = function() {
    console.warn("handleSignOut not ready yet - please wait for page to load");
  };
  
  // Backend API configuration - using Express API with PostgreSQL database
  // Works with Railway PostgreSQL or any PostgreSQL provider
  // Deploy v2.1 - Fixed button handlers
  
  const STORAGE_KEY = "hustl_state_v3";
    // Get backend URL from config or default
    const BACKEND_URL = (window.HUSTL_CONFIG && window.HUSTL_CONFIG.API_URL) || 
                        (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                          ? 'http://localhost:4000' 
                          : 'https://hustl-production.up.railway.app');
    // API base for direct fetch calls (no /api prefix needed)
    const API_BASE = BACKEND_URL;
    
    // ============================================
    // CENTRALIZED REVIEW SYSTEM - Single Source of Truth
    // ============================================
    // All reviews come from backend API - never stored locally
    // This ensures consistency across all displays
    
    /**
     * Load reviews for a user with pagination support
     * @param {string} userId - User ID to load reviews for
     * @param {number} limit - Number of reviews to load (default: 6)
     * @param {number} offset - Offset for pagination (default: 0)
     * @returns {Promise<{reviews: Array, total: number, hasMore: boolean}>}
     */
    window.loadUserReviews = async function(userId, limit = 6, offset = 0) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/reviews/user/${userId}?limit=${limit}&offset=${offset}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!response.ok) {
          throw new Error('Failed to load reviews');
        }
        
        const data = await response.json();
        
        // Handle both old format (array) and new format (object with reviews array)
        if (Array.isArray(data)) {
          return {
            reviews: data,
            total: data.length,
            hasMore: data.length >= limit,
          };
        }
        
        return {
          reviews: data.reviews || [],
          total: data.total || 0,
          hasMore: data.hasMore || false,
        };
      } catch (error) {
        console.error('[REVIEWS] Error loading reviews:', error);
        return {
          reviews: [],
          total: 0,
          hasMore: false,
        };
      }
    };
    
    /**
     * Render reviews list HTML with "Load more" support
     * @param {Array} reviews - Array of review objects
     * @param {string} containerId - ID of container element
     * @param {string} userId - User ID for loading more reviews
     * @param {number} currentOffset - Current offset for pagination
     * @param {number} total - Total number of reviews
     * @param {boolean} hasMore - Whether more reviews are available
     */
    window.renderReviewsList = function(reviews, containerId, userId, currentOffset = 0, total = 0, hasMore = false) {
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`[REVIEWS] Container ${containerId} not found`);
        return;
      }
      
      if (reviews.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No reviews yet. Complete jobs to get reviews!</div>';
        return;
      }
      
      // Clear container and render reviews with consistent styling
      container.innerHTML = '';
      
      reviews.forEach(review => {
        const reviewItem = document.createElement("div");
        reviewItem.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.75rem;";
        
        const reviewerInfo = document.createElement("div");
        reviewerInfo.style.cssText = "display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;";
        
        const reviewerPic = document.createElement("img");
        reviewerPic.style.cssText = "width: 32px; height: 32px; border-radius: 50%; object-fit: cover;";
        reviewerPic.src = review.reviewer?.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(review.reviewer?.name || "User") + "&background=6366f1&color=fff&size=128";
        reviewerPic.alt = review.reviewer?.name || "Reviewer";
        
        const reviewerName = document.createElement("span");
        reviewerName.style.cssText = "font-size: 0.9rem; font-weight: 600; color: var(--text-main);";
        reviewerName.textContent = review.reviewer?.name || "Anonymous";
        
        const reviewStars = document.createElement("span");
        reviewStars.style.cssText = "margin-left: auto; font-size: 0.9rem; color: #fbbf24;";
        reviewStars.textContent = "★".repeat(review.stars || review.rating || 0);
        
        reviewerInfo.appendChild(reviewerPic);
        reviewerInfo.appendChild(reviewerName);
        reviewerInfo.appendChild(reviewStars);
        reviewItem.appendChild(reviewerInfo);
        
        const reviewTextContent = review.text || review.comment;
        if (reviewTextContent) {
          const reviewText = document.createElement("p");
          reviewText.style.cssText = "margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-main); line-height: 1.5; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;";
          reviewText.textContent = reviewTextContent;
          reviewItem.appendChild(reviewText);
        }
        
        container.appendChild(reviewItem);
      });
      
      // Add "Load more" button if there are more reviews
      if (hasMore) {
        const loadMoreBtn = document.createElement("button");
        loadMoreBtn.id = 'loadMoreReviewsBtn';
        loadMoreBtn.className = "btn btn-ghost";
        loadMoreBtn.style.cssText = "width: 100%; padding: 0.75rem; margin-top: 1rem;";
        loadMoreBtn.textContent = `Load More Reviews (${total - currentOffset - reviews.length} remaining)`;
        container.appendChild(loadMoreBtn);
      }
      
      // Attach "Load more" handler
      if (hasMore) {
        const loadMoreBtn = document.getElementById('loadMoreReviewsBtn');
        if (loadMoreBtn) {
          loadMoreBtn.addEventListener('click', async () => {
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';
            
            const nextOffset = currentOffset + reviews.length;
            const result = await window.loadUserReviews(userId, 6, nextOffset);
            
            // Append new reviews
            const newReviews = result.reviews;
            if (newReviews.length > 0) {
              const newHtml = newReviews.map(review => `
                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border);">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                    <div>
                      <div style="font-weight: 600; color: var(--text-main);">${review.reviewer?.name || 'Anonymous'}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${new Date(review.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div style="font-size: 1.25rem; color: #fbbf24;">${'★'.repeat(review.stars || review.rating || 0)}</div>
                  </div>
                  ${review.text ? `<div style="color: var(--text-main); line-height: 1.5; margin-bottom: 0.5rem;">${review.text}</div>` : ''}
                  ${review.job ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${review.job.title || 'Untitled Job'}</div>` : ''}
                </div>
              `).join('');
              
              loadMoreBtn.insertAdjacentHTML('beforebegin', newHtml);
              
              // Update button or remove if no more
              if (result.hasMore) {
                loadMoreBtn.disabled = false;
                loadMoreBtn.textContent = `Load More Reviews (${result.total - nextOffset - newReviews.length} remaining)`;
              } else {
                loadMoreBtn.remove();
              }
            } else {
              loadMoreBtn.remove();
            }
          });
        }
      }
    };
    
    /**
     * Get user rating display (avg rating + count)
     * Always uses backend data (ratingAvg, ratingCount) - single source of truth
     * @param {Object} user - User object with ratingAvg and ratingCount
     * @returns {string} HTML string for rating display
     */
    window.getUserRatingDisplay = function(user) {
      const ratingAvg = user.ratingAvg || 0;
      const ratingCount = user.ratingCount || 0;
      
      if (ratingCount === 0) {
        return '<span style="color: var(--text-muted);">⭐ No reviews yet</span>';
      }
      
      return `⭐ <strong>${Number(ratingAvg).toFixed(1)}</strong> <span style="color: var(--text-muted);">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>`;
    };

    // 🔔 Auto-complete after 72 hours of no customer response
    const AUTO_COMPLETE_HOURS = 72;
    const AUTO_COMPLETE_MS = AUTO_COMPLETE_HOURS * 60 * 60 * 1000;

    let state = {
      users: [],
      currentUserId: null,
      jobs: [],
      feedback: [],
    };

    let activeView = "home";
    // Expose activeView on window for fallback access
    window.activeView = activeView;
    // Browse Jobs only shows OPEN jobs - no status filter needed
    let activeJobsStatusFilter = "open";
    
    // Location and filter state
    let userLocation = null; // { lat, lng } for distance calculation
    let locationWatchId = null; // ID for continuous location watching
    let userLocationMarker = null; // Map marker for user's location
    let activeDistanceFilter = null; // 5, 10, 20, 30, 50, statewide
    let activeConversationJobId = null;
    let activeConversationThreadId = null;
    let messagePollInterval = null;
    
    // Pagination state
    let currentJobsPage = 1;
    let jobsPagination = { hasMore: false };
    let allLoadedJobs = []; // Always initialize as empty array

    /* ---------- Utilities ---------- */

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
        }
      } catch (e) {
        console.error("Error loading state", e);
      }
    }

    function getCurrentUser() {
      return state.users.find((u) => u.id === state.currentUserId) || null;
    }

    function generateId(prefix) {
      return (
        prefix +
        "_" +
        Date.now().toString(36) +
        "_" +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function formatMoney(amount) {
      const n = Number(amount) || 0;
      return "$" + n.toFixed(2);
    }
    
    // Render user avatar with fallback to initials
    function renderUserAvatar(user, size = 40, options = {}) {
      // Helper to get initials from name
      function getInitials(name) {
        if (!name || typeof name !== 'string') return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length >= 2) {
          // First letter of first name + first letter of last name
          return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        } else if (parts.length === 1 && parts[0].length > 0) {
          // Just first letter if single name
          return parts[0][0].toUpperCase();
        }
        return '?';
      }
      
      if (!user || (!user.name && !user.username)) {
        const initials = '?';
        const bgColor = '#6366f1';
        const styleStr = `width: ${size}px; height: ${size}px; border-radius: 50%; background: ${bgColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: ${size * 0.4}px; flex-shrink: 0; ${options.style || ''}`;
        let attrs = '';
        if (options.className) attrs += ` class="${options.className}"`;
        if (options['data-user-id']) attrs += ` data-user-id="${options['data-user-id']}"`;
        return `<div style="${styleStr}" ${attrs}>${initials}</div>`;
      }
      
      const photoUrl = user.photoUrl;
      const name = user.name || user.username || 'User';
      const initials = getInitials(name);
      const bgColor = '#6366f1';
      
      // Build style string for fallback
      let fallbackStyleStr = `width: ${size}px; height: ${size}px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: ${size * 0.4}px; flex-shrink: 0; background: ${bgColor};`;
      
      // Build style string for image
      let imageStyleStr = `width: 100%; height: 100%; border-radius: 50%; object-fit: cover; flex-shrink: 0;`;
      
      // Add border if specified
      if (options.showBorder) {
        const borderStyle = `border: ${options.borderWidth || '2px'} solid ${options.borderColor || '#e5e7eb'};`;
        fallbackStyleStr += ` ${borderStyle}`;
        imageStyleStr += ` ${borderStyle}`;
      }
      
      // Add custom style if provided
      if (options.style) {
        imageStyleStr += ` ${options.style}`;
      }
      
      // Build attributes
      let attrs = '';
      if (options.className) {
        attrs += ` class="${options.className}"`;
      }
      if (options['data-user-id']) {
        attrs += ` data-user-id="${options['data-user-id']}"`;
      } else if (user.id) {
        attrs += ` data-user-id="${user.id}"`;
      }
      
      // Check if photoUrl is valid
      const hasValidPhoto = photoUrl && 
                           typeof photoUrl === 'string' && 
                           photoUrl.trim() !== '' && 
                           photoUrl !== 'null' && 
                           photoUrl !== 'undefined' &&
                           (photoUrl.startsWith('http://') || photoUrl.startsWith('https://') || photoUrl.startsWith('data:'));
      
      if (hasValidPhoto) {
        const avatarUrl = photoUrl.trim();
        // Use a wrapper div to handle image errors gracefully
        // Create a more robust error handler that works with innerHTML
        const uniqueId = 'avatar_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        return `<div style="position: relative; width: ${size}px; height: ${size}px; flex-shrink: 0;" ${attrs}>
          <img id="${uniqueId}_img" src="${avatarUrl}" alt="${name}" style="${imageStyleStr}" onerror="this.onerror=null; this.style.display='none'; const fallback = document.getElementById('${uniqueId}_fallback'); if (fallback) fallback.style.display='flex';" onload="const fallback = document.getElementById('${uniqueId}_fallback'); if (fallback) fallback.style.display='none';" />
          <div id="${uniqueId}_fallback" style="${fallbackStyleStr} position: absolute; top: 0; left: 0; display: none;">${initials}</div>
        </div>`;
      } else {
        // No photo, use initials
        return `<div style="${fallbackStyleStr}" ${attrs}>${initials}</div>`;
      }
    }
    
    // Expose renderUserAvatar globally
    window.renderUserAvatar = renderUserAvatar;

    function timeAgo(timestamp) {
      if (!timestamp) return "Recently";
      // Handle both Date objects and timestamps
      let timeMs;
      if (timestamp instanceof Date) {
        timeMs = timestamp.getTime();
      } else if (typeof timestamp === 'string') {
        timeMs = new Date(timestamp).getTime();
      } else if (typeof timestamp === 'number') {
        timeMs = timestamp;
      } else {
        return "Recently";
      }
      
      // Check if valid date
      if (isNaN(timeMs)) return "Recently";
      
      const now = Date.now();
      const diffMs = now - timeMs;
      if (diffMs < 0) return "Recently"; // Future date
      
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return diffMin + (diffMin === 1 ? " min ago" : " mins ago");
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return diffHr + (diffHr === 1 ? " hr ago" : " hrs ago");
      const diffDay = Math.floor(diffHr / 24);
      if (diffDay === 1) return "1 day ago";
      if (diffDay < 7) return diffDay + " days ago";
      const diffWeek = Math.floor(diffDay / 7);
      if (diffWeek < 4) return diffWeek + (diffWeek === 1 ? " week ago" : " weeks ago");
      const diffMonth = Math.floor(diffDay / 30);
      return diffMonth + (diffMonth === 1 ? " month ago" : " months ago");
    }

    let toastTimeout = null;
    // Show popup modal for price suggestion
    window.showPriceSuggestionPopup = function(jobId, payType, priceInput, priceNegotiationSection, priceCheckbox) {
      try {
        // Create modal overlay
        const popupOverlay = document.createElement("div");
        popupOverlay.id = `pricePopupOverlay_${jobId}`;
        popupOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
        
        const popupModal = document.createElement("div");
        popupModal.style.cssText = "background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
        
        const isHourly = payType === 'hourly';
        popupModal.innerHTML = `
          <div style="margin-bottom: 1.5rem;">
            <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--text-main); margin: 0 0 0.5rem 0;">💵 Suggest a Different Price</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin: 0;">Enter the price you'd like to propose for this job.</p>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Your Proposed ${isHourly ? 'Hourly' : 'Flat'} Rate</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 2rem; font-weight: 700; color: var(--primary); z-index: 1;">$</span>
              <input type="number" id="popupPriceInput_${jobId}" placeholder="${isHourly ? 'e.g., 25.00' : 'e.g., 150.00'}" step="0.01" min="0" style="width: 100%; padding: 2rem 1.5rem 2rem 3.5rem; border: 4px solid var(--primary); border-radius: 16px; font-size: 2.5rem; font-weight: 700; text-align: left; background: #f0fdf4; color: var(--text-main); min-height: 80px; box-sizing: border-box; font-family: inherit;">
              ${isHourly ? '<span style="position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.5rem; font-weight: 600; color: var(--text-muted); z-index: 1;">/hr</span>' : ''}
            </div>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button id="cancelPricePopup_${jobId}" class="btn btn-ghost" style="flex: 1; padding: 0.75rem; font-weight: 600;">Cancel</button>
            <button id="confirmPricePopup_${jobId}" class="btn btn-primary" style="flex: 1; padding: 0.75rem; font-weight: 600;">Confirm</button>
          </div>
        `;
        
        popupOverlay.appendChild(popupModal);
        document.body.appendChild(popupOverlay);
        
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
          const popupPriceInput = document.getElementById(`popupPriceInput_${jobId}`);
          if (popupPriceInput) {
            popupPriceInput.focus();
          }
          
          // Cancel button
          const cancelBtn = document.getElementById(`cancelPricePopup_${jobId}`);
          if (cancelBtn) {
            cancelBtn.addEventListener("click", () => {
              if (document.body.contains(popupOverlay)) {
                document.body.removeChild(popupOverlay);
              }
              if (priceCheckbox) priceCheckbox.checked = false;
            });
          }
          
          // Confirm button
          const confirmBtn = document.getElementById(`confirmPricePopup_${jobId}`);
          if (confirmBtn) {
            confirmBtn.addEventListener("click", () => {
              const input = document.getElementById(`popupPriceInput_${jobId}`);
              const proposedPrice = input ? parseFloat(input.value) : null;
              if (!proposedPrice || proposedPrice <= 0) {
                showToast("Please enter a valid price.");
                return;
              }
              
              // Set the price in the hidden input and show the section
              if (priceInput) {
                priceInput.value = proposedPrice;
              }
              if (priceNegotiationSection) {
                priceNegotiationSection.style.display = "block";
              }
              
              if (document.body.contains(popupOverlay)) {
                document.body.removeChild(popupOverlay);
              }
            });
          }
          
          // Close on overlay click
          popupOverlay.addEventListener("click", (e) => {
            if (e.target === popupOverlay) {
              if (document.body.contains(popupOverlay)) {
                document.body.removeChild(popupOverlay);
              }
              if (priceCheckbox) priceCheckbox.checked = false;
            }
          });
        }, 10);
      } catch (error) {
        console.error('Error in showPriceSuggestionPopup:', error);
        // Fallback: show inline input
        if (priceNegotiationSection) {
          priceNegotiationSection.style.display = "block";
        }
        if (priceInput) {
          priceInput.focus();
        }
      }
    };

    function showToast(msg, duration = 2000) {
      const el = document.getElementById("toast");
      if (!el) {
        console.warn('[Toast] Toast element not found');
        return;
      }
      
      // Clear any existing timeout
      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
      
      // Remove show class first to reset animation
      el.classList.remove("show");
      
      // Set the message
      el.textContent = msg;
      
      // Force a reflow to ensure the class removal is processed
      void el.offsetWidth;
      
      // Add show class to display toast
      el.classList.add("show");
      
      // Always auto-dismiss after 2 seconds (2000ms) for consistent UX
      toastTimeout = setTimeout(() => {
        if (el) {
          el.classList.remove("show");
          toastTimeout = null;
        }
      }, 2000);
    }

    // ⏱ Auto-complete checker: if Hustler marked finished and no dispute + no response in time
    function checkAutoCompleteJobs() {
      const now = Date.now();
      let changed = false;

      state.jobs.forEach((job) => {
        if (
          job &&
          job.status === "assigned" &&
          job.completionRequestedAt &&
          !job.dispute &&
          !job.autoCompleted
        ) {
          if (now - job.completionRequestedAt >= AUTO_COMPLETE_MS) {
            job.status = "completed"; // If there's a hustler, this will now appear in Owner payout queue
            if (job.acceptedHustlerId) {
              console.log("Job moved to payout queue:", job.id);
            }
            job.autoCompleted = true;
            changed = true;
          }
        }
      });

      if (changed) {
        saveState();
        renderAll();
      }
    }

    /* ---------- Age gate (disabled) ---------- */

    function checkAgeGate() {
      // Always keep it hidden
      const overlay = document.getElementById("ageGate");
      if (overlay) overlay.style.display = "none";
    }

    function initAgeGate() {
      // No-op – age gate disabled
    }

    /* ---------- View navigation ---------- */

    async function setView(view) {
      // Protected views that require authentication
      const protectedViews = ['profile', 'messages', 'post'];
      
      // Check auth for protected views
      if (protectedViews.includes(view)) {
        let user = null;
        try {
          user = await window.hustlAPI.auth.getCurrentUser();
        } catch (e) {
          // Ignore errors, user will be null
        }
        
        if (!user) {
          // Not authenticated - redirect to home and show login
          showToast("Please log in to access this page");
          view = 'home';
          // Open login modal
          setTimeout(() => {
            if (window.openAuthModal && typeof window.openAuthModal === 'function') {
              window.openAuthModal('login');
            }
          }, 300);
        }
      }
      
      activeView = view;
      // Update window.activeView for fallback access
      window.activeView = view;
      
      // Hide ALL sections first including auth section
      document
        .querySelectorAll("[id^='view-']")
        .forEach((sec) => (sec.style.display = "none"));
      
      // Check if user is logged in to determine if auth section should show
      let user = null;
      try {
        user = await window.hustlAPI.auth.getCurrentUser();
      } catch (e) {
        // Ignore errors
      }
      
      // Hide auth section when not on home OR when logged in
      const authSection = document.getElementById("authSection");
      if (authSection) {
        const shouldShow = !user && view === 'home';
        authSection.style.display = shouldShow ? 'block' : 'none';
        if (!shouldShow) {
          authSection.style.height = '0';
          authSection.style.padding = '0';
          authSection.style.margin = '0';
        }
      }
      
      const target = document.getElementById("view-" + view);
      if (target) {
        target.style.display = "block";
        // Scroll to top immediately for all views to remove white space
        window.scrollTo({ top: 0, behavior: 'instant' });
        // Remove any padding/margin from the view
        target.style.marginTop = '0';
        target.style.paddingTop = '0';
        // Scroll to top and remove padding for post view
        if (view === 'post') {
          document.body.classList.add('viewing-post');
          const jobFormCard = document.getElementById("jobFormCard");
          if (jobFormCard) {
            jobFormCard.style.marginTop = '0';
            jobFormCard.style.paddingTop = '0';
          }
        } else {
          document.body.classList.remove('viewing-post');
        }
        
        // Initialize jobs view toggle when jobs view is shown
        if (view === 'jobs') {
          // Use multiple attempts to ensure buttons are in DOM
          setTimeout(() => {
            initJobsViewToggle();
            // Ensure correct view is shown
            toggleJobsView(currentJobsView);
          }, 100);
          
          // Also try after a longer delay in case DOM isn't ready
          setTimeout(() => {
            const listBtn = document.getElementById('jobsViewListBtn');
            const mapBtn = document.getElementById('jobsViewMapBtn');
            if (listBtn && mapBtn && !listBtn.hasAttribute('data-listener-added')) {
              initJobsViewToggle();
              listBtn.setAttribute('data-listener-added', 'true');
              mapBtn.setAttribute('data-listener-added', 'true');
            }
          }, 500);
        }
        
        // Render profile stats when profile view is shown
        if (view === 'profile') {
          setTimeout(async () => {
            await renderProfileStats();
          }, 100);
        }
        
        // Also refresh profile stats periodically when on profile view (every 30 seconds)
        if (view === 'profile') {
          // Clear any existing interval
          if (window.profileStatsInterval) {
            clearInterval(window.profileStatsInterval);
          }
          // Set up periodic refresh
          window.profileStatsInterval = setInterval(async () => {
            if (activeView === 'profile' && typeof renderProfileStats === 'function') {
              await renderProfileStats();
            }
          }, 30000); // Refresh every 30 seconds
        } else {
          // Clear interval when leaving profile view
          if (window.profileStatsInterval) {
            clearInterval(window.profileStatsInterval);
            window.profileStatsInterval = null;
          }
        }
      }
      
      // Don't re-initialize hamburger menu - it uses event delegation and doesn't need re-initialization
      // Re-initializing causes infinite loops
      
      // Update active state for nav tabs (don't re-initialize - that causes infinite loops)
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.view === view);
      });
      
      // Update mobile bottom nav active state if it exists
      if (window.mobileCore && window.mobileCore.bottomNav) {
        window.mobileCore.bottomNav.updateActiveTab(view);
      }

      await renderAll();
    }
    // Expose setView globally immediately after definition
    window.setView = setView;
    
    // Render profile stats (Jobs Done, Earned, Rating)
    async function renderProfileStats() {
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) return;
        
        // Fetch fresh user data with stats
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/users/me`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!response.ok) {
          console.error('Failed to fetch user stats:', response.status, response.statusText);
          return;
        }
        
        const userData = await response.json();
        console.log('[PROFILE STATS] Raw API response:', userData);
        
        // Update profile basic info
        const profileBasicInfo = document.getElementById('profileBasicInfo');
        if (profileBasicInfo) {
          profileBasicInfo.innerHTML = `
            <div style="padding: 2rem; text-align: center; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 16px; margin-bottom: 1.5rem;">
              <img src="${userData.photoUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userData.name || 'User') + '&background=6366f1&color=fff&size=128'}" 
                   alt="${userData.name || 'User'}" 
                   style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid white; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <h2 style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: var(--text-main);">${userData.name || 'User'}</h2>
              <div style="font-size: 0.95rem; color: var(--text-muted);">${userData.city || ''} ${userData.zip || ''}</div>
            </div>
          `;
        }
        
        // Update profile quick stats
        const profileQuickStats = document.getElementById('profileQuickStats');
        if (profileQuickStats) {
          // Get stats from API response (default to 0 if not present)
          const jobsCompleted = Number(userData.jobsCompleted) || 0;
          const totalEarned = Number(userData.totalEarned) || 0;
          const ratingAvg = Number(userData.ratingAvg) || 0;
          
          console.log('[PROFILE STATS] Rendering stats from API:', { 
            jobsCompleted, 
            totalEarned, 
            ratingAvg, 
            rawData: {
              jobsCompleted: userData.jobsCompleted,
              totalEarned: userData.totalEarned,
              ratingAvg: userData.ratingAvg
            }
          });
          
          // Format display values
          const jobsDisplay = jobsCompleted > 0 ? jobsCompleted : 0;
          const earnedDisplay = totalEarned > 0 ? `$${totalEarned.toFixed(2)}` : '$0.00';
          // Use ratingAvg from API, only show 0.0 if there are no reviews (ratingCount === 0)
          // If ratingAvg is null/undefined but there are reviews, calculate from reviews
          const ratingCount = Number(userData.ratingCount) || 0;
          let finalRating = ratingAvg;
          if (ratingAvg === 0 && ratingCount > 0) {
            // Rating might be 0 but there are reviews - this shouldn't happen, but handle it
            finalRating = 0;
          } else if (ratingAvg === 0 && ratingCount === 0) {
            // No reviews yet - show 0.0
            finalRating = 0;
          }
          const ratingDisplay = finalRating > 0 ? finalRating.toFixed(1) : '0.0';
          
          profileQuickStats.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem; width: 100%;">
              <div style="padding: 2rem; background: white; border-radius: 12px; border: 2px solid #e5e7eb; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; min-width: 0;">
                <div style="font-size: 3rem; margin-bottom: 0.75rem;">✅</div>
                <div style="font-size: 3rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">${jobsDisplay}</div>
                <div style="font-size: 1.1rem; color: var(--text-muted); font-weight: 600;">Jobs Done</div>
              </div>
              <div style="padding: 2rem; background: white; border-radius: 12px; border: 2px solid #e5e7eb; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; min-width: 0;">
                <div style="font-size: 3rem; margin-bottom: 0.75rem;">⭐</div>
                <div style="font-size: 3rem; font-weight: 700; color: #fbbf24; margin-bottom: 0.5rem;">${ratingDisplay}</div>
                <div style="font-size: 1.1rem; color: var(--text-muted); font-weight: 600;">Rating</div>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error rendering profile stats:', error);
      }
    }
    
    // Expose renderProfileStats globally
    window.renderProfileStats = renderProfileStats;

    /* ---------- Auth visibility ---------- */

    async function renderAuthSectionVisibility() {
  const authSection = document.getElementById("authSection");
  const user = await window.hustlAPI.auth.getCurrentUser();
  // Only show auth section on home view AND when not logged in
  const shouldShow = !user && activeView === 'home';
  authSection.style.display = shouldShow ? "block" : "none";
}

    
/* ---------- Auth ---------- */

async function renderAuthPill() {
  const pill = document.getElementById("authPill");
  const user = await window.hustlAPI.auth.getCurrentUser();

  if (!user) {
    pill.innerHTML =
      'Not signed in <button id="openAuthButton">Sign in / Create account</button>';

    const openBtn = document.getElementById("openAuthButton");
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        document
          .getElementById("authSection")
          .scrollIntoView({ behavior: "smooth" });
      });
    }
  } else {
    const displayName = user.name || user.email;
    const role = user.roles && user.roles.length > 0 ? user.roles[0].toLowerCase() : "user";
    pill.innerHTML =
      `Signed in as <strong>${displayName}</strong> · ${role}` +
      '<button id="logoutButton">Log out</button>';

    const logoutBtn = document.getElementById("logoutButton");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        if (typeof window.handleSignOut === 'function') {
          await window.handleSignOut();
        } else {
          // Fallback if handleSignOut not ready
          await window.hustlAPI.auth.signOut();
          showToast("Logged out.");
          renderAll();
        }
      });
    }
  }
}

function initAuthCard() {
  const authTitle = document.getElementById("authCardTitle");
  const authToggle = document.getElementById("authModeToggle");
  const authBodyCreate = document.getElementById("authBodyCreate");
  const authBodyLogin = document.getElementById("authBodyLogin");
  let mode = "create";

  function wireToggle() {
    const span = authToggle.querySelector("span.linkish");
    if (span) {
      span.addEventListener("click", (e) => {
        const m = e.target.dataset.authMode;
        setMode(m);
      });
    }
  }

  function setMode(next) {
    mode = next;
    if (mode === "create") {
      authTitle.textContent = "Create account";
      authBodyCreate.style.display = "";
      authBodyLogin.style.display = "none";
      authToggle.innerHTML =
        'Already have an account? <span class="linkish" data-auth-mode="login">Log in</span>';
    } else {
      authTitle.textContent = "Log in";
      authBodyCreate.style.display = "none";
      authBodyLogin.style.display = "";
      authToggle.innerHTML =
        'Need a new account? <span class="linkish" data-auth-mode="create">Create one</span>';
    }
    wireToggle();
  }

  setMode("create");
  
  // Wire up "Sign up free" link in login view
  function wireSignUpFreeLink() {
    // Use event delegation to handle dynamically added links
    document.addEventListener('click', (e) => {
      const signUpLink = e.target.closest('span.linkish[data-auth-mode="create"]');
      if (signUpLink && e.target.textContent.includes('Sign up free')) {
        e.preventDefault();
        e.stopPropagation();
        // Switch to create mode
        setMode('create');
        // Also call openAuthModal if available
        if (window.openAuthModal && typeof window.openAuthModal === 'function') {
          window.openAuthModal('create');
        }
      }
    });
  }
  
  wireSignUpFreeLink();

document.getElementById("createAccountButton").addEventListener("click", async () => {
  const name = document.getElementById("createName").value.trim();
  const email = document.getElementById("createEmail").value.trim();
  const password = document.getElementById("createPassword").value.trim();
  const city = document.getElementById("createCity").value.trim();
  const zip = document.getElementById("createZip").value.trim();
  const role = document.getElementById("createRole").value;

  // Get checkbox values
  const ageCheckbox = document.getElementById("ageCheckbox");
  const termsCheckbox = document.getElementById("termsCheckbox");

  if (!name || !email || !password) {
    showToast("Please fill name, email, and password.");
    return;
  }
  if (!city) {
    showToast("Please enter your city.");
    return;
  }
  if (!zip || !/^\d{5}$/.test(zip)) {
    showToast("Please enter a valid 5-digit ZIP code.");
    return;
  }
  if (password.length < 8) {
    showToast("Password should be at least 8 characters.");
    return;
  }
  if (ageCheckbox && !ageCheckbox.checked) {
    showToast("You must be 18 or older to use Hustl.");
    return;
  }
  if (termsCheckbox && !termsCheckbox.checked) {
    showToast("Please agree to the Terms of Use and Privacy Policy.");
    return;
  }

  // Generate username from email (take part before @, make alphanumeric)
  let username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
  // Ensure it's at least 3 characters
  if (username.length < 3) {
    username = 'user' + username;
  }
  // Add random suffix for uniqueness
  const randomSuffix = Math.floor(Math.random() * 10000);
  username = username + randomSuffix;
  // Max 20 characters total
  if (username.length > 20) {
    username = username.substring(0, 20);
  }

  try {
    // Use backend API for signup with city and zip
    const result = await window.hustlAPI.auth.signUp(
      email,
      password,
      name,
      username,
      city,
      zip,
      role
    );

    // Check if email verification is required (backend returns requiresEmailVerification)
    if (result.requiresEmailVerification || !result.user?.emailVerified) {
      showToast("✅ Check your email for a verification code!");
      // Show verification input
      showEmailVerification(email);
    } else {
      showToast("✅ Account created successfully!");
      await updateHeaderAuth();
      const authSection = document.getElementById("authSection");
      if (authSection) authSection.style.display = 'none';
      setView("home");
      await renderAll();
    }
  } catch (error) {
    console.error("Sign up error:", error);
    let errorMsg = error.message || "Unknown error";
    showToast("Sign up error: " + errorMsg);
  }
});

// Email verification function
function showEmailVerification(email) {
  const authBodyCreate = document.getElementById("authBodyCreate");
  if (!authBodyCreate) return;
  
  authBodyCreate.innerHTML = `
    <div style="text-align: center; padding: 1rem;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">📧</div>
      <h3 style="margin: 0 0 0.5rem 0; color: var(--text-main);">Check Your Email</h3>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        We sent a 6-digit code to<br><strong>${email}</strong>
      </p>
      
      <div class="field">
        <label for="verificationCode">Enter Verification Code</label>
        <input 
          id="verificationCode" 
          type="text" 
          placeholder="000000" 
          maxlength="6" 
          pattern="[0-9]{6}"
          style="font-size: 1.5rem; text-align: center; letter-spacing: 0.5em; padding: 1rem; font-family: monospace;"
        />
      </div>
      
      <button class="btn btn-primary" id="verifyEmailButton" style="width: 100%; padding: 0.9rem; font-size: 1rem; margin-top: 1rem;">
        Verify Email
      </button>
      
      <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
        Didn't receive the code? <span class="linkish" id="resendCodeBtn">Resend</span>
      </p>
    </div>
  `;
  
  // Add verification button listener
  document.getElementById("verifyEmailButton").addEventListener("click", async () => {
    const code = document.getElementById("verificationCode").value.trim();
    if (!code || code.length !== 6) {
      showToast("Please enter the 6-digit code.");
      return;
    }
    
    try {
      // Clean the code - remove any spaces or non-digits
      const cleanCode = code.replace(/\D/g, '').trim();
      if (cleanCode.length !== 6) {
        showToast("Please enter a valid 6-digit code.");
        return;
      }
      
      const result = await window.hustlAPI.auth.verifyEmail(email, cleanCode);
      
      if (result && result.error) {
        // Show specific error message from backend
        showToast(result.message || result.error || "Invalid code. Please try again.");
        return;
      }
      
      showToast("✅ Email verified successfully!");
      
      // Update header immediately
      await updateHeaderAuth();
      
      // Hide auth section
      const authSection = document.getElementById("authSection");
      if (authSection) authSection.style.display = 'none';
      
      // Close auth modal if open
      if (window.closeAuthModal && typeof window.closeAuthModal === 'function') {
        window.closeAuthModal();
      }
      
      // Redirect to profile (logged-in dashboard) - NOT home
      if (window.setView && typeof window.setView === 'function') {
        window.setView("profile");
      } else {
        setView("profile");
      }
      await renderAll();
    } catch (error) {
      console.error("Verification error:", error);
      const errorMessage = error.message || error.error || "Invalid code. Please try again.";
      showToast(errorMessage);
    }
  });
  
  // Add resend button listener
  document.getElementById("resendCodeBtn").addEventListener("click", async () => {
    try {
      await window.hustlAPI.auth.resendVerification(email);
      showToast("New code sent! Check your email.");
    } catch (error) {
      showToast("Could not resend code. Please try again.");
    }
  });
}

// Show verification success screen with options
window.showVerificationSuccess = function() {
  const authBodyCreate = document.getElementById("authBodyCreate");
  if (!authBodyCreate) {
    // If auth section is hidden, show a modal instead
    window.showWelcomeModal();
    return;
  }
  
  authBodyCreate.innerHTML = `
    <div style="text-align: center; padding: 1.5rem;">
      <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 2.5rem;">✓</span>
      </div>
      
      <h2 style="margin: 0 0 0.5rem 0; color: var(--success); font-size: 1.5rem;">
        🎉 Verification Successful!
      </h2>
      
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.5;">
        Congratulations! Your email is verified and your account is ready to go.
      </p>
      
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 1rem; margin: 1rem 0; border: 1px solid #f59e0b;">
        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #92400e;">💡 Want to earn money?</p>
        <p style="margin: 0; font-size: 0.9rem; color: #78350f;">
          Connect your Stripe account to apply for jobs and get paid instantly!
        </p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem;">
        <button class="btn btn-primary" onclick="goToStripeSetup()" style="padding: 1rem; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
          <span>💳</span> Connect Stripe & Start Earning
        </button>
        
        <button class="btn btn-ghost" onclick="startExploring()" style="padding: 0.875rem; font-size: 1rem;">
          Browse Jobs First →
        </button>
      </div>
      
      <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted);">
        You can always connect Stripe later in your Profile
      </p>
    </div>
  `;
};

// Show welcome modal (for when auth section is hidden)
window.showWelcomeModal = function() {
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'welcomeModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; max-width: 400px; width: 100%; padding: 2rem; text-align: center; animation: slideUp 0.3s ease;">
      <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 2.5rem; color: white;">✓</span>
      </div>
      
      <h2 style="margin: 0 0 0.5rem 0; color: #059669; font-size: 1.5rem;">
        🎉 Verification Successful!
      </h2>
      
      <p style="color: #64748b; margin-bottom: 1.5rem; line-height: 1.5;">
        Congratulations! Your account is ready. What would you like to do?
      </p>
      
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 1rem; margin: 1rem 0; border: 1px solid #f59e0b;">
        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #92400e;">💡 Want to earn money?</p>
        <p style="margin: 0; font-size: 0.9rem; color: #78350f;">
          Connect Stripe to apply for jobs and get paid instantly!
        </p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem;">
        <button class="btn btn-primary" onclick="goToStripeSetup(); closeWelcomeModal();" style="padding: 1rem; font-size: 1rem; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
          <span>💳</span> Connect Stripe & Start Earning
        </button>
        
        <button class="btn" onclick="startExploring(); closeWelcomeModal();" style="padding: 0.875rem; font-size: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
          Browse Jobs First →
        </button>
      </div>
      
      <p style="margin-top: 1rem; font-size: 0.8rem; color: #94a3b8;">
        You can connect Stripe anytime in your Profile
      </p>
    </div>
  `;
  
  document.body.appendChild(modal);
};

window.closeWelcomeModal = function() {
  const modal = document.getElementById('welcomeModal');
  if (modal) modal.remove();
};

// Show password reset form when user clicks link from email
window.showPasswordResetModal = function showPasswordResetModal(token) {
  // Check if modal already exists
  const existingModal = document.getElementById('passwordResetModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  const modal = document.createElement('div');
  modal.id = 'passwordResetModal';
  modal.style.cssText = `
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 1rem;
  `;
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);">Reset Your Password</h2>
        <button id="closePasswordResetModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      </div>
      
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
        Enter your new password below. It must be at least 8 characters long.
      </p>
      
      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">New Password</label>
          <input type="password" id="resetNewPassword" placeholder="At least 8 characters" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;" />
        </div>
        
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main);">Confirm New Password</label>
          <input type="password" id="resetConfirmPassword" placeholder="Re-enter new password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;" />
        </div>
      </div>
      
      <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
        <button class="btn btn-ghost" id="cancelPasswordReset" style="flex: 1;">Cancel</button>
        <button class="btn btn-primary" id="submitPasswordReset" style="flex: 1;">Reset Password</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  
  // Close handlers
  const closeModal = () => {
    modal.remove();
    document.body.style.overflow = '';
    // Redirect to home/login
    if (typeof setView === 'function') {
      setView('home');
    }
  };
  
  modal.querySelector('#closePasswordResetModal').addEventListener('click', closeModal);
  modal.querySelector('#cancelPasswordReset').addEventListener('click', closeModal);
  
  // Submit handler
  modal.querySelector('#submitPasswordReset').addEventListener('click', async () => {
    const newPassword = modal.querySelector('#resetNewPassword').value;
    const confirmPassword = modal.querySelector('#resetConfirmPassword').value;
    
    if (!newPassword || !confirmPassword) {
      showToast("Please fill in all fields.");
      return;
    }
    
    if (newPassword.length < 8) {
      showToast("Password must be at least 8 characters.");
      return;
    }
    
    if (newPassword !== confirmPassword) {
      showToast("Passwords don't match.");
      return;
    }
    
    const submitBtn = modal.querySelector('#submitPasswordReset');
    submitBtn.disabled = true;
    submitBtn.textContent = "Resetting...";
    
    try {
      const response = await fetch(`${API_BASE}/auth/reset-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          token: token,
          newPassword: newPassword
        })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showToast("✅ Password reset successfully! Please log in with your new password.");
        closeModal();
        
        // Show login modal after a short delay
        setTimeout(() => {
          if (typeof showLoginModal === 'function') {
            showLoginModal();
          }
        }, 500);
      } else {
        showToast(data.error || "Failed to reset password. The link may have expired.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Reset Password";
      }
    } catch (error) {
      console.error("Password reset error:", error);
      showToast("Error resetting password. Please try again.");
      submitBtn.disabled = false;
      submitBtn.textContent = "Reset Password";
    }
  });
  
  // Allow Enter key to submit
  modal.querySelector('#resetNewPassword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      modal.querySelector('#resetConfirmPassword').focus();
    }
  });
  
  modal.querySelector('#resetConfirmPassword').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      modal.querySelector('#submitPasswordReset').click();
    }
  });
};

window.goToStripeSetup = function() {
  window.closeWelcomeModal();
  if (typeof setView === 'function') setView('profile');
  if (typeof renderAll === 'function') renderAll();
  // Scroll to Stripe section after a short delay
  setTimeout(() => {
    const stripeSection = document.getElementById('stripeConnectSection');
    if (stripeSection) {
      stripeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 300);
};

window.startExploring = function() {
  window.closeWelcomeModal();
  if (typeof setView === 'function') setView('jobs');
  if (typeof renderAll === 'function') renderAll();
};

// Change Password Modal
window.showChangePasswordModal = function showChangePasswordModal() {
  // Remove existing modal if it exists
  const existingModal = document.getElementById('changePasswordModal');
  if (existingModal) {
    existingModal.remove();
    document.body.style.overflow = '';
  }
  
  const modal = document.createElement('div');
  modal.id = 'changePasswordModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0; font-size: 1.5rem;">🔑 Change Password</h2>
        <button id="closeChangePasswordModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
      </div>
      
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
        Enter your current password and choose a new one. Your new password must be at least 8 characters.
      </p>
      
      <div class="field" style="margin-bottom: 1rem;">
        <label for="currentPassword">Current Password</label>
        <input id="currentPassword" type="password" placeholder="Enter current password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" />
      </div>
      
      <div class="field" style="margin-bottom: 1rem;">
        <label for="newPassword">New Password</label>
        <input id="newPassword" type="password" placeholder="At least 8 characters" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" />
      </div>
      
      <div class="field" style="margin-bottom: 1.5rem;">
        <label for="confirmPassword">Confirm New Password</label>
        <input id="confirmPassword" type="password" placeholder="Re-enter new password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" />
      </div>
      
      <div style="display: flex; gap: 0.75rem;">
        <button class="btn btn-ghost" id="cancelChangePassword" style="flex: 1;">Cancel</button>
        <button class="btn btn-primary" id="submitChangePassword" style="flex: 1;">Change Password</button>
      </div>
      
      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <button class="btn btn-ghost" id="forgotPasswordBtn" style="width: 100%; font-size: 0.9rem; color: var(--primary);">
          📧 Forgot password? Send reset email
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  
  // Close handlers
  const closeModal = () => {
    modal.remove();
    document.body.style.overflow = '';
  };
  
  modal.querySelector('#closeChangePasswordModal').addEventListener('click', closeModal);
  modal.querySelector('#cancelChangePassword').addEventListener('click', closeModal);
  modal.querySelector('#forgotPasswordBtn').addEventListener('click', async () => {
    try {
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user || !user.email) {
        showToast("Unable to find your email. Please contact support.");
        return;
      }
      
      // Call password reset endpoint (if it exists)
      const token = localStorage.getItem('hustl_token');
      const response = await fetch('/auth/forgot-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        body: JSON.stringify({ email: user.email })
      });
      
      if (response.ok) {
        showToast("✅ Password reset email sent! Check your inbox.");
        closeModal();
      } else {
        showToast("Could not send reset email. Please try again later.");
      }
    } catch (error) {
      showToast("Error sending reset email. Please contact support.");
    }
  });
  
  // Submit handler
  modal.querySelector('#submitChangePassword').addEventListener('click', async () => {
    const currentPassword = modal.querySelector('#currentPassword').value;
    const newPassword = modal.querySelector('#newPassword').value;
    const confirmPassword = modal.querySelector('#confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
      showToast("Please fill in all fields.");
      return;
    }
    
    if (newPassword.length < 8) {
      showToast("New password must be at least 8 characters.");
      return;
    }
    
    if (newPassword !== confirmPassword) {
      showToast("New passwords don't match.");
      return;
    }
    
    if (currentPassword === newPassword) {
      showToast("New password must be different from current password.");
      return;
    }
    
    try {
      const token = localStorage.getItem('hustl_token');
      const apiBase = window.API_BASE || API_BASE || 'https://hustl-production.up.railway.app';
      console.log('[CHANGE PASSWORD] Calling API:', `${apiBase}/auth/change-password`);
      
      const response = await fetch(`${apiBase}/auth/change-password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          currentPassword,
          newPassword
        })
      });
      
      console.log('[CHANGE PASSWORD] Response status:', response.status);
      
      let data;
      try {
        data = await response.json();
        console.log('[CHANGE PASSWORD] Response data:', data);
      } catch (parseError) {
        console.error('[CHANGE PASSWORD] Failed to parse response:', parseError);
        const text = await response.text();
        console.error('[CHANGE PASSWORD] Response text:', text);
        throw new Error('Invalid response from server');
      }
      
      if (!response.ok) {
        console.error('[CHANGE PASSWORD] Error response:', data);
        const errorMsg = data.message || data.error || 'Failed to change password';
        console.error('[CHANGE PASSWORD] Error details:', data.details);
        throw new Error(errorMsg);
      }
      
      showToast("✅ Password changed successfully!");
      closeModal();
    } catch (error) {
      console.error('[CHANGE PASSWORD] Error:', error);
      showToast("Error: " + (error.message || "Could not change password. Please try again."));
    }
  });
}

  document
    .getElementById("loginButton")
    .addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password =
        document.getElementById("loginPassword").value.trim();
      if (!email || !password)
        return showToast("Enter email and password.");

      try {
        const result = await window.hustlAPI.auth.signIn(email, password);
        showToast("✅ Logged in successfully!", 1750); // Auto-dismiss after 1.75 seconds
        
        // Update header immediately
        await updateHeaderAuth();
        
        // Hide auth section
        const authSection = document.getElementById("authSection");
        if (authSection) authSection.style.display = 'none';
        
        // Close auth modal if open
        if (window.closeAuthModal && typeof window.closeAuthModal === 'function') {
          window.closeAuthModal();
        }
        
        // Redirect to profile (logged-in dashboard) - NOT home
        if (window.setView && typeof window.setView === 'function') {
          window.setView("profile");
        } else {
          setView("profile");
        }
        await renderAll();
      } catch (error) {
        showToast("Login error: " + (error.message || "Unknown error"));
      }
    });
    
    // Forgot password button handler
    const forgotPasswordBtn = document.getElementById('forgotPasswordLoginBtn');
    if (forgotPasswordBtn) {
      forgotPasswordBtn.addEventListener('click', async () => {
        const email = document.getElementById("loginEmail").value.trim();
        if (!email) {
          showToast("Please enter your email address first.");
          return;
        }
        
        try {
          const response = await fetch('/auth/forgot-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
          });
          
          const data = await response.json();
          
          if (response.ok) {
            showToast("✅ Password reset email sent! Check your inbox. You will need to use the link in the email to reset your password.");
            // IMPORTANT: Do NOT auto-login - user must use the reset link from email
            // Stay on login page - user will click the link in their email
          } else {
            showToast(data.error || "Could not send reset email. Please try again.");
          }
        } catch (error) {
          showToast("Error sending reset email. Please try again later.");
        }
      });
    }
}

    /* ---------- Jobs ---------- */

    // Global variable to track if we're editing a job
    let editingJobId = null;
    
    // Load job data into form for editing
    async function loadJobForEdit(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!response.ok) {
          throw new Error('Failed to fetch job');
        }
        
        const job = await response.json();
        
        // Check if job is editable (must be OPEN)
        if (job.status !== 'OPEN') {
          showToast('Can only edit jobs that are currently open');
          return;
        }
        
        // Set editing mode
        editingJobId = jobId;
        
        // Populate form fields
        if (document.getElementById("jobTitle")) {
          document.getElementById("jobTitle").value = job.title || "";
        }
        if (document.getElementById("jobCategory")) {
          document.getElementById("jobCategory").value = job.category || "";
        }
        if (document.getElementById("jobDescription")) {
          document.getElementById("jobDescription").value = job.description || "";
        }
        
        // Populate address fields from requirements
        const requirements = job.requirements || {};
        if (document.getElementById("pickupCity")) {
          document.getElementById("pickupCity").value = requirements.pickup_city || requirements.pickupCity || "";
        }
        if (document.getElementById("pickupZip")) {
          document.getElementById("pickupZip").value = requirements.pickup_zip || "";
        }
        if (document.getElementById("pickupAddress")) {
          document.getElementById("pickupAddress").value = requirements.pickup_address || "";
        }
        if (document.getElementById("pickupApt")) {
          document.getElementById("pickupApt").value = requirements.pickup_apt || "";
        }
        if (document.getElementById("pickupLat")) {
          document.getElementById("pickupLat").value = requirements.pickup_lat || "";
        }
        if (document.getElementById("pickupLng")) {
          document.getElementById("pickupLng").value = requirements.pickup_lng || "";
        }
        
        // Set on-site only
        if (document.getElementById("jobOnSiteOnly")) {
          document.getElementById("jobOnSiteOnly").checked = requirements.on_site_only || requirements.onSiteOnly || false;
          // Trigger change event to show/hide dropoff fields
          document.getElementById("jobOnSiteOnly").dispatchEvent(new Event('change'));
        }
        
        // Populate dropoff fields
        if (document.getElementById("dropoffCity")) {
          document.getElementById("dropoffCity").value = requirements.dropoff_city || requirements.dropoffCity || "";
        }
        if (document.getElementById("dropoffZip")) {
          document.getElementById("dropoffZip").value = requirements.dropoff_zip || "";
        }
        if (document.getElementById("dropoffAddress")) {
          document.getElementById("dropoffAddress").value = requirements.dropoff_address || "";
        }
        if (document.getElementById("dropoffApt")) {
          document.getElementById("dropoffApt").value = requirements.dropoff_apt || "";
        }
        if (document.getElementById("dropoffLat")) {
          document.getElementById("dropoffLat").value = requirements.dropoff_lat || "";
        }
        if (document.getElementById("dropoffLng")) {
          document.getElementById("dropoffLng").value = requirements.dropoff_lng || "";
        }
        
        // Set payment type and amount
        if (document.getElementById("paymentType")) {
          document.getElementById("paymentType").value = job.payType || "flat";
          document.getElementById("paymentType").dispatchEvent(new Event('change'));
        }
        if (document.getElementById("flatAmount")) {
          document.getElementById("flatAmount").value = job.amount || "80";
        }
        if (document.getElementById("hourlyRate")) {
          document.getElementById("hourlyRate").value = job.hourlyRate || "20";
        }
        if (document.getElementById("maxHours")) {
          document.getElementById("maxHours").value = job.estHours || "3";
        }
        
        // Set workers needed
        const teamSize = job.teamSize || 1;
        if (document.getElementById("workersNeeded")) {
          if (teamSize === 0) {
            document.getElementById("workersNeeded").value = "company";
          } else if (teamSize >= 1 && teamSize <= 6) {
            document.getElementById("workersNeeded").value = String(teamSize);
          } else {
            // If teamSize > 6, default to 6 (max available option)
            document.getElementById("workersNeeded").value = "6";
          }
          document.getElementById("workersNeeded").dispatchEvent(new Event('change'));
        }
        
        // Set date and time
        if (job.date) {
          const jobDate = new Date(job.date);
          const dateStr = jobDate.toISOString().split('T')[0];
          if (document.getElementById("jobDate")) {
            document.getElementById("jobDate").value = dateStr;
          }
        }
        if (job.startTime) {
          const startTime = new Date(job.startTime);
          const timeStr = startTime.toTimeString().slice(0, 5);
          if (document.getElementById("jobStartTime")) {
            document.getElementById("jobStartTime").value = timeStr;
          }
        }
        if (job.endTime) {
          const endTime = new Date(job.endTime);
          const timeStr = endTime.toTimeString().slice(0, 5);
          if (document.getElementById("jobEndTime")) {
            document.getElementById("jobEndTime").value = timeStr;
          }
        }
        
        // Set deadline preference
        const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
        if (document.getElementById("deadlinePreference")) {
          document.getElementById("deadlinePreference").value = deadlinePreference || "flexible";
          document.getElementById("deadlinePreference").dispatchEvent(new Event('change'));
        }
        
        // Set notes
        if (document.getElementById("jobNotes")) {
          document.getElementById("jobNotes").value = requirements.notes || "";
        }
        
        // Set keep active for
        if (requirements.keepActiveFor && document.getElementById("jobDuration")) {
          document.getElementById("jobDuration").value = String(requirements.keepActiveFor);
        }
        
        // Update form title and button
        const formTitle = document.querySelector('#jobFormCard .card-title');
        if (formTitle) {
          formTitle.textContent = 'Edit Job';
        }
        const postButton = document.getElementById("postJobButton");
        if (postButton) {
          postButton.textContent = "💾 Update Job";
        }
        
        // Navigate to post view
        setView('post');
        
        // Scroll to top
        window.scrollTo(0, 0);
        
      } catch (error) {
        console.error("Error loading job for edit:", error);
        showToast("Error loading job. Please try again.");
      }
    }
    
    // Update job function
    async function updateJob(jobId) {
      try {
        // Collect all form data (same as post job)
        const titleInput = document.getElementById("jobTitle");
        const title = titleInput.value.trim();
        
        // Validate title is 5 words or less
        const titleWords = title.split(/\s+/).filter(word => word.length > 0);
        if (titleWords.length > 5) {
          const errorDiv = document.getElementById("jobTitleError");
          if (errorDiv) {
            errorDiv.style.display = "block";
          }
          showToast("Job title must be 5 words or less. Please shorten it.");
          titleInput.focus();
          return;
        } else {
          const errorDiv = document.getElementById("jobTitleError");
          if (errorDiv) {
            errorDiv.style.display = "none";
          }
        }
        const category = document.getElementById("jobCategory").value;
        const desc = document.getElementById("jobDescription").value.trim();
        
        // Get approximate location (required)
        const approximateLat = parseFloat(document.getElementById("approximateLat")?.value);
        const approximateLng = parseFloat(document.getElementById("approximateLng")?.value);
        
        if (!approximateLat || !approximateLng || isNaN(approximateLat) || isNaN(approximateLng)) {
          return showToast("Please tap the map to set your approximate location.");
        }
        
        // For now, use a generic address string (will be replaced with exact address after acceptance)
        const address = "Approximate location (exact address shared after acceptance)";
        
        const paymentType = document.getElementById("paymentType").value;
        const flatAmount = parseFloat(document.getElementById("flatAmount").value) || 0;
        const hourlyRate = parseFloat(document.getElementById("hourlyRate").value) || 0;
        const maxHours = parseInt(document.getElementById("maxHours").value) || 0;
        const pricingOption = document.getElementById("pricingOption")?.value || "set_price";
        const notes = document.getElementById("jobNotes").value.trim();
        const workersNeededValue = document.getElementById("workersNeeded")?.value || "1";
        let workersNeeded = 1;
        if (workersNeededValue === "company") {
          workersNeeded = 0;
        } else {
          workersNeeded = Number(workersNeededValue) || 1;
        }
        const jobDuration = document.getElementById("jobDuration")?.value || "3";
        const keepActiveFor = parseInt(jobDuration) || 3;
        
        // Collect equipment
        const equipmentNeeded = [];
        document.querySelectorAll('input[name="equipment"]:checked').forEach(cb => {
          equipmentNeeded.push(cb.value);
        });
        // Add custom equipment if provided
        const customEquipment = document.getElementById("customEquipment")?.value.trim();
        if (customEquipment) {
          equipmentNeeded.push(customEquipment);
        }
        
        // Get date/time
        const jobWhen = document.getElementById("jobWhen")?.value || document.getElementById("deadlinePreference")?.value || "today_asap";
        const now = new Date();
        let date, startTime, endTime, deadlinePreference;
        
        if (jobWhen === "today") {
          // Today - deadline is today, expires at end of today
          date = now.toISOString().split('T')[0];
          startTime = new Date(now);
          startTime.setHours(now.getHours(), 0, 0, 0);
          endTime = new Date(now);
          endTime.setHours(23, 59, 59, 999); // End of today
          deadlinePreference = "today";
        } else if (jobWhen === "today_asap") {
          // ASAP - deadline is today, expires in 3 days
          date = now.toISOString().split('T')[0];
          startTime = new Date(now);
          startTime.setHours(now.getHours(), 0, 0, 0);
          endTime = new Date(now);
          endTime.setHours(23, 59, 59, 999); // End of today
          deadlinePreference = "today_asap";
        } else if (jobWhen === "no_deadline") {
          const futureDate = new Date(now);
          futureDate.setFullYear(futureDate.getFullYear() + 1);
          date = futureDate.toISOString().split('T')[0];
          startTime = new Date(futureDate);
          startTime.setHours(9, 0, 0, 0);
          endTime = new Date(futureDate);
          endTime.setHours(17, 0, 0, 0);
          deadlinePreference = "no_deadline";
        } else if (jobWhen === "flexible_week") {
          const endOfWeek = new Date(now);
          endOfWeek.setDate(endOfWeek.getDate() + (7 - endOfWeek.getDay()));
          date = endOfWeek.toISOString().split('T')[0];
          startTime = new Date(now);
          startTime.setHours(9, 0, 0, 0);
          endTime = new Date(endOfWeek);
          endTime.setHours(17, 0, 0, 0);
          deadlinePreference = "flexible_week";
        } else if (jobWhen === "specific_date") {
          const customDate = document.getElementById("customDate")?.value;
          const customTime = document.getElementById("customTime")?.value || "morning";
          if (!customDate) {
            return showToast("Please select a date for your specific deadline.");
          }
          date = customDate;
          const selectedDate = new Date(customDate);
          const today = new Date();
          const isToday = selectedDate.toDateString() === today.toDateString();
          
          if (customTime === "morning") {
            startTime = new Date(selectedDate);
            startTime.setHours(8, 0, 0, 0);
            endTime = new Date(selectedDate);
            endTime.setHours(12, 0, 0, 0);
          } else if (customTime === "afternoon") {
            startTime = new Date(selectedDate);
            startTime.setHours(12, 0, 0, 0);
            endTime = new Date(selectedDate);
            endTime.setHours(17, 0, 0, 0);
          } else if (customTime === "evening") {
            startTime = new Date(selectedDate);
            startTime.setHours(17, 0, 0, 0);
            endTime = new Date(selectedDate);
            endTime.setHours(21, 0, 0, 0);
          } else {
            startTime = new Date(selectedDate);
            startTime.setHours(21, 0, 0, 0);
            endTime = new Date(selectedDate);
            endTime.setHours(23, 0, 0, 0);
          }
          
          deadlinePreference = "specific_date";
        } else if (jobWhen === "tomorrow") {
          const targetDate = new Date(now);
          targetDate.setDate(targetDate.getDate() + 1);
          date = targetDate.toISOString().split('T')[0];
          startTime = new Date(targetDate);
          startTime.setHours(8, 0, 0, 0);
          endTime = new Date(targetDate);
          endTime.setHours(21, 0, 0, 0);
          deadlinePreference = "tomorrow";
        } else {
          // Default to ASAP
          date = now.toISOString().split('T')[0];
          startTime = new Date(now);
          startTime.setHours(now.getHours(), 0, 0, 0);
          endTime = new Date(now);
          endTime.setHours(23, 59, 59, 999);
          deadlinePreference = "today_asap";
        }
        
        // Calculate expiresAt based on deadline preference
        let expiresAt = null;
        if (deadlinePreference === "today") {
          // Today → expires at end of today (11:59 PM local time)
          expiresAt = new Date(now);
          expiresAt.setHours(23, 59, 59, 999);
        } else if (deadlinePreference === "today_asap") {
          // ASAP → expires in 3 days at 11:59 PM local time
          expiresAt = new Date(now);
          expiresAt.setDate(expiresAt.getDate() + 3);
          expiresAt.setHours(23, 59, 59, 999);
        } else if (deadlinePreference === "flexible_week") {
          // This week → expires in 7 days at 11:59 PM
          expiresAt = new Date(now);
          expiresAt.setDate(expiresAt.getDate() + 7);
          expiresAt.setHours(23, 59, 59, 999);
        } else if (deadlinePreference === "specific_date" && startTime) {
          // Specific date → expires at end of that day (11:59 PM local time)
          expiresAt = new Date(startTime);
          expiresAt.setHours(23, 59, 59, 999);
        } else if (deadlinePreference === "no_deadline") {
          // Until done → expires in 1 month
          expiresAt = new Date(now);
          expiresAt.setMonth(expiresAt.getMonth() + 1);
          expiresAt.setHours(23, 59, 59, 999);
        }
        
        // Build payment data
        const payType = paymentType || 'flat';
        let amount = 0;
        let hourlyRateValue = null;
        let estHoursValue = null;
        
        if (pricingOption === "set_price") {
          if (payType === 'flat') {
            amount = flatAmount;
          } else {
            amount = hourlyRate * maxHours;
            hourlyRateValue = hourlyRate;
            estHoursValue = maxHours;
          }
        } else {
          amount = 50;
        }
        
        // Build update data
        const updateData = {
          title,
          category,
          description: desc,
          address, // Generic address string for now
          approximateLat,
          approximateLng,
          date,
          startTime: startTime.toISOString(),
          endTime: endTime.toISOString(),
          expiresAt: expiresAt ? expiresAt.toISOString() : null, // Expiration date/time
          payType,
          amount,
          teamSize: workersNeeded || 1, // Backend will move this to requirements
          keepActiveFor,
          requirements: {
            teamSize: workersNeeded || 1, // Also include in requirements
            equipmentNeeded: equipmentNeeded.length > 0 ? equipmentNeeded : null, // Use camelCase
            equipment_needed: equipmentNeeded.length > 0 ? equipmentNeeded : null, // Also include snake_case for compatibility
            customEquipment: customEquipment || null, // Use camelCase
            custom_equipment: customEquipment || null, // Also include snake_case for compatibility
            notes: notes || null,
            pricing_option: pricingOption,
            deadline_preference: deadlinePreference || jobWhen,
            preferredTime: document.getElementById("preferredTime")?.value || requirements.preferredTime || "anytime",
          },
        };
        
        if (hourlyRateValue && hourlyRateValue > 0) {
          updateData.hourlyRate = hourlyRateValue;
        }
        if (estHoursValue && estHoursValue > 0) {
          updateData.estHours = estHoursValue;
        }
        
        // Call update API (PATCH, not POST)
        const result = await window.hustlAPI.jobs.update(jobId, updateData);
        
        showToast("✅ Job updated successfully!");
        
        // Reset editing mode
        editingJobId = null;
        clearJobForm();
        
        // Update form title and button
        const formTitle = document.querySelector('#jobFormCard .card-title');
        if (formTitle) {
          formTitle.textContent = 'Post a job';
        }
        const postButton = document.getElementById("postJobButton");
        if (postButton) {
          postButton.textContent = "Post job to Hustl";
        }
        
        // Navigate to manage jobs
        setView('manage-jobs');
        // Reload posted jobs to show updated job
        setTimeout(() => {
          loadPostedJobs();
        }, 100);
        
      } catch (error) {
        console.error("Error updating job:", error);
        showToast(error.message || "Error updating job. Please try again.");
      }
    }
    
    function clearJobForm() {
      // Reset editing mode
      editingJobId = null;
      
      document.getElementById("jobTitle").value = "";
      document.getElementById("jobCategory").value = "";
      document.getElementById("jobDescription").value = "";
      document.getElementById("pickupCity").value = "";
      document.getElementById("pickupZip").value = "";
      document.getElementById("pickupAddress").value = "";
      document.getElementById("jobOnSiteOnly").checked = false;
      document.getElementById("dropoffCity").value = "";
      document.getElementById("dropoffZip").value = "";
      document.getElementById("dropoffAddress").value = "";
      if (document.getElementById("pricingOption")) {
        document.getElementById("pricingOption").value = "set_price";
      }
      document.getElementById("paymentType").value = "flat";
      document.getElementById("flatAmount").value = "80";
      document.getElementById("hourlyRate").value = "20";
      document.getElementById("maxHours").value = "3";
      document.getElementById("jobNotes").value = "";
      document.getElementById("jobPhoto").value = "";
      if (document.getElementById("priceSettingFields")) {
        document.getElementById("priceSettingFields").style.display = "block";
      }
      if (document.getElementById("hustlersQuoteNote")) {
        document.getElementById("hustlersQuoteNote").style.display = "none";
      }
      document.getElementById("flatAmountField").style.display = "block";
      document.getElementById("hourlyFields").style.display = "none";
      document.getElementById("dropoffFields").style.display = "block";
      
      // Reset new fields
      if (document.getElementById("customCategory")) {
        document.getElementById("customCategory").value = "";
        document.getElementById("customCategoryField").style.display = "none";
      }
      if (document.getElementById("workersNeeded")) {
        document.getElementById("workersNeeded").value = "1";
      }
      if (document.getElementById("customEquipment")) {
        document.getElementById("customEquipment").value = "";
        document.getElementById("customEquipmentField").style.display = "none";
        document.getElementById("customEquipmentToggle").checked = false;
      }
      // Reset equipment section
      const equipmentContent = document.getElementById("equipmentContent");
      const equipmentToggleIcon = document.getElementById("equipmentToggleIcon");
      if (equipmentContent) equipmentContent.style.display = "none";
      if (equipmentToggleIcon) equipmentToggleIcon.style.transform = "rotate(0deg)";
      
      // Reset equipment checkboxes
      document.querySelectorAll('input[name="equipment"]').forEach(cb => {
        cb.checked = false;
        const label = cb.closest('.equipment-checkbox');
        if (label) {
          label.style.background = '#fff';
          label.style.borderColor = 'var(--border)';
        }
      });
      
      // Reset sub-tags
      const subTagsContainer = document.getElementById("subTagsContainer");
      const subTagsGrid = document.getElementById("subTagsGrid");
      if (subTagsContainer) subTagsContainer.style.display = "none";
      if (subTagsGrid) subTagsGrid.innerHTML = "";
    }
    // Initialize Mapbox Places Autocomplete
    async function initMapboxAutocomplete() {
      // Always try to fetch from backend first (Railway environment variable)
      let MAPBOX_TOKEN = '';
      
      try {
        const response = await fetch(`${API_BASE}/jobs/mapbox-token`);
        if (response.ok) {
          const data = await response.json();
          MAPBOX_TOKEN = data.token;
          console.log('✅ Mapbox token loaded from backend');
        } else {
          console.warn('⚠️ Could not fetch Mapbox token from backend:', response.status);
        }
      } catch (e) {
        console.warn('⚠️ Could not fetch Mapbox token from backend:', e);
      }
      
      // Fallback to config or window variable
      if (!MAPBOX_TOKEN) {
        MAPBOX_TOKEN = window.HUSTL_CONFIG?.MAPBOX_TOKEN || window.MAPBOX_TOKEN || '';
        if (MAPBOX_TOKEN) {
          console.log('✅ Mapbox token loaded from frontend config');
        }
      }
      
      if (!MAPBOX_TOKEN) {
        console.warn('❌ Mapbox token not configured. Address autocomplete will not work.');
        console.warn('💡 Make sure MAPBOX_TOKEN is set in Railway environment variables.');
        return;
      }
      
      // Store token globally for map initialization
      window.MAPBOX_TOKEN = MAPBOX_TOKEN;
      
      // Helper function to extract address components from Mapbox result
      function extractAddressComponents(feature) {
        const context = feature.context || [];
        let zip = null;
        let city = null;
        let state = null;
        let neighborhood = null;
        let street = feature.text || '';
        
        // For place types (cities), the main text is often the city name
        if (feature.place_type && feature.place_type.includes('place')) {
          city = feature.text || '';
        }
        
        for (const item of context) {
          const id = item.id || '';
          if (id.startsWith('postcode')) {
            zip = item.text;
          } else if (id.startsWith('place')) {
            city = item.text || city;
          } else if (id.startsWith('region')) {
            state = item.text;
          } else if (id.startsWith('neighborhood') || id.startsWith('locality')) {
            neighborhood = item.text;
          }
        }
        
        return { street, city, state, zip, neighborhood, fullAddress: feature.place_name };
      }
      
      // Initialize pickup address autocomplete
      const pickupAddressInput = document.getElementById('pickupAddress');
      if (pickupAddressInput && typeof MapboxGeocoder !== 'undefined') {
        // Create a container for the geocoder (it will replace the input)
        const pickupContainer = document.createElement('div');
        pickupContainer.id = 'pickupAddressContainer';
        pickupContainer.style.cssText = 'position: relative; width: 100%;';
        pickupAddressInput.parentNode.insertBefore(pickupContainer, pickupAddressInput);
        pickupAddressInput.style.display = 'none'; // Hide original input
        
        // Add CSS to add space before the search icon in Mapbox geocoder input
        const geocoderStyle = document.createElement('style');
        geocoderStyle.textContent = `
          #pickupAddressContainer .mapboxgl-ctrl-geocoder input,
          #dropoffAddressContainer .mapboxgl-ctrl-geocoder input {
            padding-left: 2.5rem !important;
          }
          #pickupAddressContainer .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon-search,
          #dropoffAddressContainer .mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon-search {
            left: 0.75rem !important;
          }
        `;
        document.head.appendChild(geocoderStyle);
        
        const pickupGeocoder = new MapboxGeocoder({
          accessToken: MAPBOX_TOKEN,
          types: 'address',
          countries: 'us',
          bbox: [-90.3, 34.98, -81.65, 36.68], // Tennessee bounding box (west, south, east, north)
          placeholder: 'Start typing address...',
          proximity: { longitude: -86.7816, latitude: 36.1627 }, // Nashville center
        });
        
        pickupGeocoder.addTo('#pickupAddressContainer');
        
        pickupGeocoder.on('result', (e) => {
          const feature = e.result;
          const [lng, lat] = feature.center;
          const components = extractAddressComponents(feature);
          
          // Store coordinates
          const latInput = document.getElementById('pickupLat');
          const lngInput = document.getElementById('pickupLng');
          if (latInput) latInput.value = lat;
          if (lngInput) lngInput.value = lng;
          
          // Autofill fields - update the hidden input and visible fields
          if (components.street) {
            pickupAddressInput.value = components.street;
          }
          if (components.city) {
            const cityInput = document.getElementById('pickupCity');
            if (cityInput) {
              // Format: "City, State" or just "City"
              cityInput.value = components.city + (components.state ? ', ' + components.state : '');
            }
          }
          if (components.zip) {
            const zipInput = document.getElementById('pickupZip');
            if (zipInput) zipInput.value = components.zip;
          }
        });
        
        // Handle clear event
        pickupGeocoder.on('clear', () => {
          pickupAddressInput.value = '';
          document.getElementById('pickupLat').value = '';
          document.getElementById('pickupLng').value = '';
        });
      }
      
      // Initialize dropoff address autocomplete
      const dropoffAddressInput = document.getElementById('dropoffAddress');
      if (dropoffAddressInput && typeof MapboxGeocoder !== 'undefined') {
        // Create a container for the geocoder (it will replace the input)
        const dropoffContainer = document.createElement('div');
        dropoffContainer.id = 'dropoffAddressContainer';
        dropoffContainer.style.cssText = 'position: relative; width: 100%;';
        dropoffAddressInput.parentNode.insertBefore(dropoffContainer, dropoffAddressInput);
        dropoffAddressInput.style.display = 'none'; // Hide original input
        
        const dropoffGeocoder = new MapboxGeocoder({
          accessToken: MAPBOX_TOKEN,
          types: 'address',
          countries: 'us',
          bbox: [-90.3, 34.98, -81.65, 36.68], // Tennessee bounding box (west, south, east, north)
          placeholder: 'Start typing address...',
          proximity: { longitude: -86.7816, latitude: 36.1627 }, // Nashville center
        });
        
        dropoffGeocoder.addTo('#dropoffAddressContainer');
        
        dropoffGeocoder.on('result', (e) => {
          const feature = e.result;
          const [lng, lat] = feature.center;
          const components = extractAddressComponents(feature);
          
          // Store coordinates
          const latInput = document.getElementById('dropoffLat');
          const lngInput = document.getElementById('dropoffLng');
          if (latInput) latInput.value = lat;
          if (lngInput) lngInput.value = lng;
          
          // Autofill fields - update the hidden input and visible fields
          if (components.street) {
            dropoffAddressInput.value = components.street;
          }
          if (components.neighborhood) {
            if (areaInput) areaInput.value = components.neighborhood;
          }
          if (components.city) {
            const cityInput = document.getElementById('dropoffCity');
            if (cityInput) {
              // Format: "City, State" or just "City"
              cityInput.value = components.city + (components.state ? ', ' + components.state : '');
            }
          }
          if (components.zip) {
            const zipInput = document.getElementById('dropoffZip');
            if (zipInput) zipInput.value = components.zip;
          }
        });
        
        // Handle clear event
        dropoffGeocoder.on('clear', () => {
          dropoffAddressInput.value = '';
          document.getElementById('dropoffLat').value = '';
          document.getElementById('dropoffLng').value = '';
        });
      }
      
    }
    
    // Initialize Approximate Location Map
    let approximateLocationMap = null;
    let approximateLocationMarker = null;
    let approximateLocationCircle = null;
    
    async function initApproximateLocationMap() {
      const mapContainer = document.getElementById('approximateLocationMap');
      if (!mapContainer) {
        console.log('Map container not found');
        return;
      }
      
      // Check if container is visible
      const containerParent = mapContainer.closest('#view-post');
      if (containerParent && containerParent.style.display === 'none') {
        console.log('Post view not visible, will initialize when shown');
        return;
      }
      
      // If map already exists, remove it first
      if (approximateLocationMap) {
        try {
          approximateLocationMap.remove();
        } catch (e) {
          console.warn('Error removing existing map:', e);
        }
        approximateLocationMap = null;
        approximateLocationMarker = null;
        approximateLocationCircle = null;
      }
      
      // Wait for Mapbox token
      let MAPBOX_TOKEN = window.MAPBOX_TOKEN;
      if (!MAPBOX_TOKEN) {
        // Try to fetch it
        try {
          const response = await fetch(`${API_BASE}/jobs/mapbox-token`);
          if (response.ok) {
            const data = await response.json();
            MAPBOX_TOKEN = data.token;
            window.MAPBOX_TOKEN = MAPBOX_TOKEN;
          }
        } catch (e) {
          console.warn('Could not fetch Mapbox token:', e);
        }
      }
      
      // Check if mapboxgl is loaded - wait up to 5 seconds
      let attempts = 0;
      const maxAttempts = 10;
      const checkMapbox = () => {
        if (typeof mapboxgl !== 'undefined') {
          return true;
        }
        attempts++;
        if (attempts >= maxAttempts) {
          mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626; padding: 1rem; text-align: center;">Map library failed to load. Please refresh the page.</div>';
          return false;
        }
        return false;
      };
      
      if (!checkMapbox()) {
        mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); padding: 1rem; text-align: center;">Loading map library...</div>';
        // Wait and check again
        const interval = setInterval(() => {
          if (checkMapbox()) {
            clearInterval(interval);
            initApproximateLocationMap();
          }
        }, 500);
        return;
      }
      
      if (!MAPBOX_TOKEN) {
        mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626; padding: 1rem; text-align: center;">Map token not available. Please check configuration.</div>';
        return;
      }
      
      try {
        mapboxgl.accessToken = MAPBOX_TOKEN;
        
        // Initialize map centered on Tennessee (Nashville area)
        // CRITICAL: Ensure map is always interactive
        approximateLocationMap = new mapboxgl.Map({
          container: 'approximateLocationMap',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [-86.7816, 36.1627], // Nashville center
          zoom: 11,
          interactive: true, // Explicitly enable interactivity
          boxZoom: true,
          doubleClickZoom: true,
          dragRotate: false,
          dragPan: true,
          keyboard: true,
          scrollZoom: true,
          touchZoomRotate: true,
          touchPitch: true
        });
        
        // CRITICAL: Add click handler immediately (don't wait for load event)
        // This ensures clicks work even if load event has issues
        let clickHandlerAttached = false;
        const attachClickHandler = () => {
          if (clickHandlerAttached || !approximateLocationMap) return;
          
          // Remove any existing click handlers first
          approximateLocationMap.off('click');
          
          // Add click handler
          approximateLocationMap.on('click', (e) => {
            console.log('Map clicked:', e.lngLat);
            const { lng, lat } = e.lngLat;
            
            // Store coordinates
            const latInput = document.getElementById('approximateLat');
            const lngInput = document.getElementById('approximateLng');
            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;
            
            // Update status
            const statusDiv = document.getElementById('locationStatus');
            if (statusDiv) {
              statusDiv.textContent = `Location set: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
              statusDiv.style.color = 'var(--primary)';
            }
            
            // Remove existing marker and circle
            if (approximateLocationMarker) {
              try {
                approximateLocationMarker.remove();
              } catch (e) {
                console.warn('Error removing marker:', e);
              }
              approximateLocationMarker = null;
            }
            
            // Always try to remove circle layers and source (regardless of flag)
            try {
              if (approximateLocationMap.getLayer('approximate-circle-outline')) {
                approximateLocationMap.removeLayer('approximate-circle-outline');
              }
            } catch (e) {
              // Layer might not exist, ignore
            }
            
            try {
              if (approximateLocationMap.getLayer('approximate-circle')) {
                approximateLocationMap.removeLayer('approximate-circle');
              }
            } catch (e) {
              // Layer might not exist, ignore
            }
            
            try {
              if (approximateLocationMap.getSource('approximate-circle')) {
                approximateLocationMap.removeSource('approximate-circle');
              }
            } catch (e) {
              // Source might not exist, ignore
            }
            
            approximateLocationCircle = null;
            
            // Add marker
            approximateLocationMarker = new mapboxgl.Marker({
              color: '#2563eb',
              draggable: true
            })
              .setLngLat([lng, lat])
              .addTo(approximateLocationMap);
            
            // Handle marker drag
            approximateLocationMarker.on('dragend', () => {
              const markerLngLat = approximateLocationMarker.getLngLat();
              if (latInput) latInput.value = markerLngLat.lat;
              if (lngInput) lngInput.value = markerLngLat.lng;
              
              // Update circle
              updateApproximateCircle(markerLngLat.lng, markerLngLat.lat);
              
              if (statusDiv) {
                statusDiv.textContent = `Location set: ${markerLngLat.lat.toFixed(6)}, ${markerLngLat.lng.toFixed(6)}`;
              }
            });
            
            // Add 0.25 mile radius circle (0.25 miles = ~402 meters)
            updateApproximateCircle(lng, lat);
          });
          
          clickHandlerAttached = true;
          console.log('✅ Map click handler attached');
        };
        
        // Attach click handler immediately
        attachClickHandler();
        
        // Also attach on load event (backup)
        approximateLocationMap.once('load', () => {
          console.log('Map loaded successfully');
          attachClickHandler(); // Re-attach to ensure it's there
          
          // Initialize address search (for navigation only, not stored)
          initApproximateLocationSearch();
          
          // Initialize current location button
          initCurrentLocationButton();
        });
        
        // Also attach on style.load (another backup)
        approximateLocationMap.once('style.load', () => {
          attachClickHandler();
        });
        
        // Handle map errors
        approximateLocationMap.on('error', (e) => {
          console.error('Map error:', e);
          mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626; padding: 1rem; text-align: center;">Map failed to load. Please refresh the page.</div>';
        });
        
        // Ensure map container is always clickable
        if (mapContainer) {
          mapContainer.style.pointerEvents = 'auto';
          mapContainer.style.cursor = 'crosshair';
          mapContainer.style.touchAction = 'pan-x pan-y pinch-zoom';
          
          // Remove any overlays that might block clicks
          const overlays = mapContainer.querySelectorAll('[style*="pointer-events: none"]');
          overlays.forEach(overlay => {
            overlay.style.pointerEvents = 'none';
          });
        }
      } catch (error) {
        console.error('Error initializing map:', error);
        mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626; padding: 1rem; text-align: center;">Error loading map. Please refresh the page.</div>';
      }
    }
    
    function updateApproximateCircle(lng, lat) {
      if (!approximateLocationMap) return;
      
      // Wait for map to be loaded before adding sources/layers
      if (!approximateLocationMap.loaded()) {
        approximateLocationMap.once('load', () => {
          updateApproximateCircle(lng, lat);
        });
        return;
      }
      
      // Always remove existing circle layers and source (regardless of flag)
      try {
        if (approximateLocationMap.getLayer('approximate-circle-outline')) {
          approximateLocationMap.removeLayer('approximate-circle-outline');
        }
      } catch (e) {
        // Layer might not exist, ignore
      }
      
      try {
        if (approximateLocationMap.getLayer('approximate-circle')) {
          approximateLocationMap.removeLayer('approximate-circle');
        }
      } catch (e) {
        // Layer might not exist, ignore
      }
      
      try {
        if (approximateLocationMap.getSource('approximate-circle')) {
          approximateLocationMap.removeSource('approximate-circle');
        }
      } catch (e) {
        // Source might not exist, ignore
      }
      
      // 0.25 miles = 402.336 meters
      const radiusMeters = 402.336;
      
      // Create circle using Turf.js (if available) or manual calculation
      const circle = createCircle([lng, lat], radiusMeters);
      
      try {
        approximateLocationMap.addSource('approximate-circle', {
          type: 'geojson',
          data: circle
        });
        
        approximateLocationMap.addLayer({
          id: 'approximate-circle',
          type: 'fill',
          source: 'approximate-circle',
          paint: {
            'fill-color': '#2563eb',
            'fill-opacity': 0.1
          }
        });
        
        approximateLocationMap.addLayer({
          id: 'approximate-circle-outline',
          type: 'line',
          source: 'approximate-circle',
          paint: {
            'line-color': '#2563eb',
            'line-width': 2,
            'line-opacity': 0.5
          }
        });
        
        approximateLocationCircle = true;
      } catch (e) {
        console.error('Error adding circle to map:', e);
        // If source already exists, try to update it instead
        try {
          const source = approximateLocationMap.getSource('approximate-circle');
          if (source && source.setData) {
            source.setData(circle);
            approximateLocationCircle = true;
          }
        } catch (e2) {
          console.error('Error updating circle source:', e2);
        }
      }
    }
    
    // Initialize address search for map navigation (address not stored)
    function initApproximateLocationSearch() {
      const searchInput = document.getElementById('approximateLocationSearch');
      if (!searchInput || !approximateLocationMap) return;
      
      const MAPBOX_TOKEN = window.MAPBOX_TOKEN;
      if (!MAPBOX_TOKEN || typeof MapboxGeocoder === 'undefined') {
        // If geocoder not available, use simple search with Enter key
        searchInput.addEventListener('keypress', async (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;
            
            // Use Mapbox Geocoding API directly
            try {
              const response = await fetch(
                `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&country=us&limit=1`
              );
              const data = await response.json();
              
              if (data.features && data.features.length > 0) {
                const [lng, lat] = data.features[0].center;
                approximateLocationMap.flyTo({
                  center: [lng, lat],
                  zoom: 14,
                  duration: 1000
                });
                searchInput.value = ''; // Clear after search
              } else {
                showToast('Address not found. Try a different search.');
              }
            } catch (error) {
              console.error('Geocoding error:', error);
              showToast('Error searching address. Please try again.');
            }
          }
        });
        return;
      }
      
      // Use Mapbox Geocoder if available
      const geocoder = new MapboxGeocoder({
        accessToken: MAPBOX_TOKEN,
        types: 'address,poi',
        countries: 'us',
        placeholder: '🔍 Search address to navigate map (optional)',
        bbox: [-90.3, 34.98, -81.65, 36.68], // Tennessee bounding box
        proximity: { longitude: -86.7816, latitude: 36.1627 }, // Nashville center
      });
      
      // Add geocoder to search input container
      const searchContainer = document.createElement('div');
      searchContainer.id = 'approximateLocationSearchContainer';
      searchContainer.style.cssText = 'position: relative; width: 100%;';
      searchInput.parentNode.insertBefore(searchContainer, searchInput);
      searchInput.style.display = 'none';
      
      geocoder.addTo('#approximateLocationSearchContainer');
      
      // When address is selected, center map but don't set location
      geocoder.on('result', (e) => {
        const [lng, lat] = e.result.center;
        // Center map on the address
        approximateLocationMap.flyTo({
          center: [lng, lat],
          zoom: 14,
          duration: 1000
        });
        // Clear the search input
        searchInput.value = '';
        // Show message that they still need to click
        const statusDiv = document.getElementById('locationStatus');
        if (statusDiv) {
          statusDiv.textContent = 'Map centered. Now tap the map to set your approximate location.';
          statusDiv.style.color = 'var(--text-muted)';
        }
      });
      
      // Clear search when cleared
      geocoder.on('clear', () => {
        searchInput.value = '';
      });
    }
    
    // Initialize current location button (mobile-friendly)
    function initCurrentLocationButton() {
      const currentLocationBtn = document.getElementById('useCurrentLocationBtn');
      if (!currentLocationBtn || !approximateLocationMap) {
        // Try again after a short delay if map isn't ready
        setTimeout(() => {
          if (approximateLocationMap) {
            initCurrentLocationButton();
          }
        }, 500);
        return;
      }
      
      currentLocationBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!navigator.geolocation) {
          showToast('Geolocation is not supported by your browser.');
          return;
        }
        
        // Show loading state
        const originalText = currentLocationBtn.textContent;
        currentLocationBtn.textContent = '📍 Getting location...';
        currentLocationBtn.disabled = true;
        currentLocationBtn.style.opacity = '0.6';
        currentLocationBtn.style.cursor = 'wait';
        currentLocationBtn.style.pointerEvents = 'none';
        
        // Mobile-friendly geolocation options (less strict for better mobile compatibility)
        const geoOptions = {
          enableHighAccuracy: false, // Set to false for mobile - high accuracy can fail on mobile
          timeout: 15000, // Longer timeout for mobile
          maximumAge: 60000 // Accept cached location up to 1 minute old
        };
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            try {
              const { latitude, longitude } = position.coords;
              
              if (!latitude || !longitude || isNaN(latitude) || isNaN(longitude)) {
                throw new Error('Invalid coordinates');
              }
              
              // Center map on current location
              approximateLocationMap.flyTo({
                center: [longitude, latitude],
                zoom: 14,
                duration: 1000
              });
              
              // Update status message
              const statusDiv = document.getElementById('locationStatus');
              if (statusDiv) {
                statusDiv.textContent = 'Map centered on your location. Now tap the map to set your approximate location (not your exact address).';
                statusDiv.style.color = 'var(--text-muted)';
              }
            } catch (err) {
              console.error('Error processing location:', err);
              showToast('Got your location but had trouble centering the map. Please try again.');
            } finally {
              // Reset button
              currentLocationBtn.textContent = originalText;
              currentLocationBtn.disabled = false;
              currentLocationBtn.style.opacity = '1';
              currentLocationBtn.style.cursor = 'pointer';
              currentLocationBtn.style.pointerEvents = 'auto';
            }
          },
          (error) => {
            console.error('Geolocation error:', error);
            let errorMessage = '';
            
            // Better error messages for mobile
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'Location access denied. Please allow location access in your browser settings and try again.';
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'Location unavailable. Make sure GPS is enabled on your device.';
                break;
              case error.TIMEOUT:
                errorMessage = 'Location request timed out. Please try again.';
                break;
              default:
                errorMessage = 'Unable to get your location. Please try again or use the address search instead.';
                break;
            }
            
            showToast(errorMessage);
            
            // Reset button
            currentLocationBtn.textContent = originalText;
            currentLocationBtn.disabled = false;
            currentLocationBtn.style.opacity = '1';
            currentLocationBtn.style.cursor = 'pointer';
            currentLocationBtn.style.pointerEvents = 'auto';
          },
          geoOptions
        );
      });
    }
    
    // Simple circle creation (approximation)
    function createCircle(center, radiusMeters) {
      const points = 64;
      const coordinates = [];
      
      for (let i = 0; i < points; i++) {
        const angle = (i * 360) / points;
        const rad = (angle * Math.PI) / 180;
        
        // Convert meters to degrees (approximate)
        const latOffset = radiusMeters / 111320; // meters per degree latitude
        const lngOffset = radiusMeters / (111320 * Math.cos(center[1] * Math.PI / 180));
        
        const lat = center[1] + latOffset * Math.cos(rad);
        const lng = center[0] + lngOffset * Math.sin(rad);
        
        coordinates.push([lng, lat]);
      }
      
      // Close the circle
      coordinates.push(coordinates[0]);
      
      return {
        type: 'Feature',
        geometry: {
          type: 'Polygon',
          coordinates: [coordinates]
        }
      };
    }
    
    function initJobsForm() {
      // Note: jobOnSiteOnly and dropoffFields were removed in Step 2 (simplified form)
      // Only initialize if elements exist (for backward compatibility)
      const jobOnSiteOnly = document.getElementById("jobOnSiteOnly");
      const dropoffFields = document.getElementById("dropoffFields");
      if (jobOnSiteOnly && dropoffFields) {
      jobOnSiteOnly.addEventListener("change", () => {
        const isChecked = jobOnSiteOnly.checked;
        dropoffFields.style.display = isChecked ? "none" : "block";
        // Update required attribute on dropoff address
        const dropoffAddressInput = document.getElementById("dropoffAddress");
        if (dropoffAddressInput) {
          dropoffAddressInput.required = !isChecked;
        }
      });
      }
      
      // Initialize Mapbox autocomplete after form is ready
      // Also ensure token is loaded for maps
      setTimeout(async () => {
        await initMapboxAutocomplete();
        // If token wasn't loaded yet, try to initialize mapboxgl
        if (window.MAPBOX_TOKEN && window.mapboxgl) {
          mapboxgl.accessToken = window.MAPBOX_TOKEN;
        }
        // Initialize approximate location map
        await initApproximateLocationMap();
      }, 500);

      // Pricing option toggle
      const pricingOptionSelect = document.getElementById("pricingOption");
      const priceSettingFields = document.getElementById("priceSettingFields");
      const hustlersQuoteNote = document.getElementById("hustlersQuoteNote");
      if (pricingOptionSelect && priceSettingFields && hustlersQuoteNote) {
        pricingOptionSelect.addEventListener("change", () => {
          if (pricingOptionSelect.value === "set_price") {
            priceSettingFields.style.display = "block";
            hustlersQuoteNote.style.display = "none";
          } else {
            priceSettingFields.style.display = "none";
            hustlersQuoteNote.style.display = "block";
          }
        });
      }
      
      // Toggle handlers for collapsible sections
      const descriptionGuidanceToggle = document.getElementById("descriptionGuidanceToggle");
      const descriptionGuidanceContent = document.getElementById("descriptionGuidanceContent");
      const descriptionGuidanceIcon = document.getElementById("descriptionGuidanceIcon");
      if (descriptionGuidanceToggle && descriptionGuidanceContent) {
        descriptionGuidanceToggle.addEventListener("click", () => {
          const isOpen = descriptionGuidanceContent.style.display !== "none";
          descriptionGuidanceContent.style.display = isOpen ? "none" : "block";
          if (descriptionGuidanceIcon) {
            descriptionGuidanceIcon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
          }
        });
      }
      
      const pricingSectionToggle = document.getElementById("pricingSectionToggle");
      const pricingSectionContent = document.getElementById("pricingSectionContent");
      const pricingSectionIcon = document.getElementById("pricingSectionIcon");
      if (pricingSectionToggle && pricingSectionContent) {
        // Default to collapsed (clean start)
        pricingSectionContent.style.display = "none";
        if (pricingSectionIcon) {
          pricingSectionIcon.style.transform = "rotate(0deg)";
        }
        
        pricingSectionToggle.addEventListener("click", () => {
          const isOpen = pricingSectionContent.style.display !== "none";
          pricingSectionContent.style.display = isOpen ? "none" : "block";
          if (pricingSectionIcon) {
            pricingSectionIcon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
          }
        });
      }
      
      const extraNotesToggle = document.getElementById("extraNotesToggle");
      const extraNotesContent = document.getElementById("extraNotesContent");
      const extraNotesIcon = document.getElementById("extraNotesIcon");
      if (extraNotesToggle && extraNotesContent) {
        extraNotesToggle.addEventListener("click", () => {
          const isOpen = extraNotesContent.style.display !== "none";
          extraNotesContent.style.display = isOpen ? "none" : "block";
          if (extraNotesIcon) {
            extraNotesIcon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
          }
        });
      }
      
      // Equipment section toggle
      const equipmentSectionToggle = document.getElementById("equipmentSectionToggle");
      const equipmentSectionContent = document.getElementById("equipmentSectionContent");
      const equipmentSectionIcon = document.getElementById("equipmentSectionIcon");
      if (equipmentSectionToggle && equipmentSectionContent) {
        equipmentSectionToggle.addEventListener("click", () => {
          const isOpen = equipmentSectionContent.style.display !== "none";
          equipmentSectionContent.style.display = isOpen ? "none" : "block";
          if (equipmentSectionIcon) {
            equipmentSectionIcon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
          }
        });
      }
      
      // Equipment chip selection (like category chips)
      const equipmentChips = document.querySelectorAll('.equipment-chip');
      const selectedEquipment = new Set();
      
      equipmentChips.forEach(chip => {
        chip.addEventListener('click', () => {
          const equipmentValue = chip.dataset.equipment;
          const isSelected = selectedEquipment.has(equipmentValue);
          
          if (isSelected) {
            selectedEquipment.delete(equipmentValue);
            chip.style.background = '#fff';
            chip.style.borderColor = 'var(--border)';
            chip.style.color = 'var(--text-main)';
            // Remove hidden checkbox if it exists
            const hiddenCheckbox = chip.querySelector('input[type="checkbox"]');
            if (hiddenCheckbox) hiddenCheckbox.checked = false;
          } else {
            selectedEquipment.add(equipmentValue);
            chip.style.background = 'var(--primary-soft)';
            chip.style.borderColor = 'var(--primary)';
            chip.style.color = 'var(--primary)';
            // Create hidden checkbox if it doesn't exist
            let hiddenCheckbox = chip.querySelector('input[type="checkbox"]');
            if (!hiddenCheckbox) {
              hiddenCheckbox = document.createElement('input');
              hiddenCheckbox.type = 'checkbox';
              hiddenCheckbox.name = 'equipment';
              hiddenCheckbox.value = equipmentValue;
              hiddenCheckbox.style.display = 'none';
              chip.appendChild(hiddenCheckbox);
            }
            hiddenCheckbox.checked = true;
          }
        });
      });
      
      // Custom equipment toggle
      const customEquipmentToggle = document.getElementById("customEquipmentToggle");
      const customEquipmentField = document.getElementById("customEquipmentField");
      if (customEquipmentToggle && customEquipmentField) {
        customEquipmentToggle.addEventListener("click", () => {
          const isOpen = customEquipmentField.style.display !== "none";
          customEquipmentField.style.display = isOpen ? "none" : "block";
          if (!isOpen) {
            const input = document.getElementById("customEquipment");
            if (input) setTimeout(() => input.focus(), 100);
          }
        });
      }
      
      const paymentTypeSelect = document.getElementById("paymentType");
      const flatField = document.getElementById("flatAmountField");
      const hourlyFields = document.getElementById("hourlyFields");
      const hourlyRateCalculation = document.getElementById("hourlyRateCalculation");
      
      // Update hourly rate calculation when rate, hours, or workers change
      function updateHourlyRateCalculation() {
        if (!hourlyRateCalculation || !paymentTypeSelect || paymentTypeSelect.value !== "hourly") {
          if (hourlyRateCalculation) hourlyRateCalculation.style.display = "none";
          return;
        }
        const hourlyRate = parseFloat(document.getElementById("hourlyRate")?.value || 0);
        const workersNeeded = document.getElementById("workersNeeded");
        let workersCount = 1;
        if (workersNeeded) {
          const workersValue = workersNeeded.value;
          if (workersValue === "company") {
            workersCount = 0; // Company option - don't calculate hourly rate
            hourlyRateCalculation.style.display = "none";
            return;
          } else {
            workersCount = parseInt(workersValue || 1);
          }
        }
        if (workersCount > 0 && hourlyRate > 0) {
          // hourlyRate is now the TOTAL rate, not per person
          const totalRate = hourlyRate; // Total rate entered by user
          const perPersonRate = totalRate / workersCount; // Calculate per person
          const exampleWorkers = document.getElementById("exampleWorkers");
          const examplePerPerson = document.getElementById("examplePerPerson");
          
          if (exampleWorkers) exampleWorkers.textContent = workersCount;
          if (examplePerPerson) examplePerPerson.textContent = perPersonRate.toFixed(workersCount > 1 ? 2 : 0);
          
          hourlyRateCalculation.style.display = "block";
        } else {
          hourlyRateCalculation.style.display = "none";
        }
      }
      
      if (paymentTypeSelect && flatField && hourlyFields) {
        paymentTypeSelect.addEventListener("change", () => {
          if (paymentTypeSelect.value === "flat") {
            flatField.style.display = "block";
            hourlyFields.style.display = "none";
            if (hourlyRateCalculation) hourlyRateCalculation.style.display = "none";
          } else {
            flatField.style.display = "none";
            hourlyFields.style.display = "grid";
            if (hourlyRateCalculation) hourlyRateCalculation.style.display = "block";
            updateHourlyRateCalculation();
          }
        });
      }
      
      // Add event listeners for hourly rate calculation
      const hourlyRateInput = document.getElementById("hourlyRate");
      const workersNeededSelect = document.getElementById("workersNeeded");
      if (hourlyRateInput) hourlyRateInput.addEventListener("input", updateHourlyRateCalculation);
      if (workersNeededSelect) {
        workersNeededSelect.addEventListener("change", () => {
          updateHourlyRateCalculation();
        });
      }
      
      // Custom date selection - show immediately when selected
      const jobWhenSelect = document.getElementById("jobWhen");
      const customDateFields = document.getElementById("customDateFields");
      const flexibleDeadlineNote = document.getElementById("flexibleDeadlineNote");
      if (jobWhenSelect) {
        jobWhenSelect.addEventListener("change", () => {
          const todayNote = document.getElementById("todayNote");
          const todayAsapNote = document.getElementById("todayAsapNote");
          const tomorrowNote = document.getElementById("tomorrowNote");
          
          if (jobWhenSelect.value === "specific_date") {
            if (customDateFields) customDateFields.style.display = "block";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayNote) todayNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
            // Focus on date input immediately
            setTimeout(() => {
              const customDateInput = document.getElementById("customDate");
              if (customDateInput) customDateInput.focus();
            }, 100);
          } else if (jobWhenSelect.value === "today") {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayNote) todayNote.style.display = "block";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
          } else if (jobWhenSelect.value === "today_asap") {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayNote) todayNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "block";
            if (tomorrowNote) tomorrowNote.style.display = "none";
          } else if (jobWhenSelect.value === "tomorrow") {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayNote) todayNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "block";
          } else if (jobWhenSelect.value === "flexible_week") {
            if (customDateFields) customDateFields.style.display = "none";
            if (todayNote) todayNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
            if (flexibleDeadlineNote) {
              flexibleDeadlineNote.style.display = "block";
              const noteText = document.getElementById("flexibleDeadlineNoteText");
              if (noteText) {
                noteText.innerHTML = '<strong>⏰ Flexible (This Week):</strong> This job will stay active for 7 days after posting.';
              }
            }
          } else if (jobWhenSelect.value === "no_deadline") {
            if (customDateFields) customDateFields.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
            if (flexibleDeadlineNote) {
              flexibleDeadlineNote.style.display = "block";
              const noteText = document.getElementById("flexibleDeadlineNoteText");
              if (noteText) {
                noteText.innerHTML = '<strong>⏰ Flexible Deadline:</strong> This job will stay active until someone completes it. No rush!';
              }
            }
          } else {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
          }
          
          // Auto-set keepActiveFor based on When selection
          const jobDurationField = document.getElementById("jobDurationField");
          const jobDurationSelect = document.getElementById("jobDuration");
          if (jobDurationSelect) {
            if (jobWhenSelect.value === "today_asap") {
              jobDurationSelect.value = "1"; // 1 day for today
            } else if (jobWhenSelect.value === "tomorrow") {
              jobDurationSelect.value = "1"; // 1 day for tomorrow
            } else if (jobWhenSelect.value === "flexible_week") {
              jobDurationSelect.value = "7"; // 1 week
            } else if (jobWhenSelect.value === "no_deadline") {
              jobDurationSelect.value = "30"; // 1 month
            } else {
              jobDurationSelect.value = "3"; // Default 3 days
            }
          }
        });
      }

      // Sub-tags data based on category
      const subTagsData = {
        'power-washing': ['Siding', 'Driveway', 'Roof', 'Deck', 'Patio', 'Fence'],
        'yard-work': ['Mowing', 'Leaf Removal', 'Weeding', 'Trimming', 'Edging'],
        'landscaping': ['Planting', 'Garden Bed', 'Rock/Stone', 'Sod'],
        'snow-removal': ['Driveway', 'Sidewalk', 'Salting'],
        'moving': ['Full Move', 'Load Only', 'Unload Only', 'Packing Help'],
        'dump-run': ['Furniture', 'Yard Waste', 'Construction', 'Appliances'],
        'cleaning': ['Deep Clean', 'Move-out', 'Organizing', 'Regular'],
        'furniture-assembly': ['IKEA', 'Bed Frame', 'Shelving', 'Desk'],
        'painting': ['Interior', 'Exterior', 'Fence', 'Deck'],
        'handyman': ['Repairs', 'Mounting', 'Drywall', 'Plumbing'],
        'car-cleaning': ['Exterior', 'Interior', 'Full Detail'],
        'pet-care': ['Walking', 'Sitting', 'Transport'],
        'delivery': ['Pickup', 'Drop-off', 'Store Run'],
        'event-setup': ['Tables/Chairs', 'Tent', 'Cleanup'],
      };

      // Category names for display
      const categoryNames = {
        'moving': '🚚 Moving / Hauling',
        'yard-work': '🌿 Yard Work',
        'dump-run': '🗑️ Dump Run',
        'cleaning': '🧹 Cleaning',
        'power-washing': '💦 Power Washing',
        'furniture-assembly': '🔧 Furniture Assembly',
        'painting': '🎨 Painting',
        'handyman': '🔨 Handyman',
        'landscaping': '🌳 Landscaping',
        'pet-care': '🐕 Pet Care',
        'delivery': '🚚 Delivery',
        'car-cleaning': '🚿 Car Cleaning',
        'event-setup': '🎪 Event Setup',
        'snow-removal': '❄️ Snow Removal',
        'other': '✨ Other'
      };

      // Category chip selection handler
      const jobCategory = document.getElementById("jobCategory");
      const customCategoryField = document.getElementById("customCategoryField");
      const subTagsContainer = document.getElementById("subTagsContainer");
      const subTagsGrid = document.getElementById("subTagsGrid");
      const selectedCategoryDisplay = document.getElementById("selectedCategoryDisplay");
      const selectedCategoryText = document.getElementById("selectedCategoryText");
      const categoryChips = document.getElementById("categoryChips");
      const moreCategoriesSection = document.getElementById("moreCategoriesSection");
      const showMoreCategoriesBtn = document.getElementById("showMoreCategoriesBtn");
      const allCategoriesGrid = document.getElementById("allCategoriesGrid");
      const changeCategoryBtn = document.getElementById("changeCategoryBtn");

      // Handle "See all categories" toggle
      if (showMoreCategoriesBtn && allCategoriesGrid) {
        showMoreCategoriesBtn.addEventListener("click", () => {
          const isHidden = allCategoriesGrid.style.display === "none";
          allCategoriesGrid.style.display = isHidden ? "block" : "none";
          showMoreCategoriesBtn.textContent = isHidden ? "− Show less" : "+ See all categories";
        });
      }

      // Handle category chip clicks
      function selectCategory(value) {
        // Update hidden select
        if (jobCategory) jobCategory.value = value;
        
        // Hide chips, show selected
        if (categoryChips) categoryChips.style.display = "none";
        if (moreCategoriesSection) moreCategoriesSection.style.display = "none";
        if (selectedCategoryDisplay) {
          selectedCategoryDisplay.style.display = "block";
          if (selectedCategoryText) {
            selectedCategoryText.textContent = categoryNames[value] || value;
          }
        }
        
        // Show/hide custom category field
        if (customCategoryField) {
          customCategoryField.style.display = value === "other" ? "block" : "none";
        }
        
        // Show sub-tags if available
        if (subTagsContainer && subTagsGrid) {
          const tags = subTagsData[value];
          if (tags && tags.length > 0) {
            subTagsGrid.innerHTML = tags.map(tag => `
              <label class="sub-tag-chip" style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 0.75rem; background: #fff; border: 1.5px solid var(--border); border-radius: 999px; cursor: pointer; transition: all 0.2s; font-size: 0.85rem;">
                <input type="checkbox" name="subTags" value="${tag.toLowerCase().replace(/\s+/g, '-')}" style="display: none;" />
                <span>${tag}</span>
              </label>
            `).join('');
            subTagsContainer.style.display = "block";
            
            // Add toggle effect for sub-tag chips
            subTagsGrid.querySelectorAll('.sub-tag-chip').forEach(chip => {
              chip.addEventListener('click', () => {
                const cb = chip.querySelector('input');
                cb.checked = !cb.checked;
                if (cb.checked) {
                  chip.style.background = 'var(--primary-soft)';
                  chip.style.borderColor = 'var(--primary)';
                  chip.style.color = 'var(--primary)';
                } else {
                  chip.style.background = '#fff';
                  chip.style.borderColor = 'var(--border)';
                  chip.style.color = 'inherit';
                }
              });
            });
          } else {
            subTagsContainer.style.display = "none";
            subTagsGrid.innerHTML = "";
          }
        }
      }

      // Handle change category button
      if (changeCategoryBtn) {
        changeCategoryBtn.addEventListener("click", () => {
          if (categoryChips) categoryChips.style.display = "flex";
          if (moreCategoriesSection) moreCategoriesSection.style.display = "block";
          if (selectedCategoryDisplay) selectedCategoryDisplay.style.display = "none";
          if (subTagsContainer) subTagsContainer.style.display = "none";
          if (customCategoryField) customCategoryField.style.display = "none";
          if (jobCategory) jobCategory.value = "";
        });
      }

      // Add click handlers to all category chips
      document.querySelectorAll('.category-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          selectCategory(chip.dataset.value);
        });
      });

      // Equipment section toggle
      const equipmentToggle = document.getElementById("equipmentToggle");
      const equipmentContent = document.getElementById("equipmentContent");
      const equipmentToggleIcon = document.getElementById("equipmentToggleIcon");
      if (equipmentToggle && equipmentContent) {
        equipmentToggle.addEventListener("click", () => {
          const isOpen = equipmentContent.style.display !== "none";
          equipmentContent.style.display = isOpen ? "none" : "block";
          equipmentToggleIcon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
        });
      }
      
      // Workers needed - handle change for hourly rate calculation
      const workersNeededSelect2 = document.getElementById("workersNeeded");
      if (workersNeededSelect2) {
        workersNeededSelect2.addEventListener("change", () => {
          // Update hourly rate calculation when workers change
          if (typeof updateHourlyRateCalculation === 'function') {
            updateHourlyRateCalculation();
          }
        });
      }

      // Job title validation - limit to 5 words
      const jobTitleInput = document.getElementById("jobTitle");
      if (jobTitleInput) {
        jobTitleInput.addEventListener("input", () => {
          const title = jobTitleInput.value.trim();
          const titleWords = title.split(/\s+/).filter(word => word.length > 0);
          const errorDiv = document.getElementById("jobTitleError");
          
          if (titleWords.length > 5) {
            if (errorDiv) {
              errorDiv.style.display = "block";
            }
            // Truncate to 5 words
            const truncated = titleWords.slice(0, 5).join(' ');
            jobTitleInput.value = truncated;
            showToast("Job title limited to 5 words");
          } else {
            if (errorDiv) {
              errorDiv.style.display = "none";
            }
          }
        });
      }

      // Equipment checkbox hover effects
      document.querySelectorAll('.equipment-checkbox').forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              label.style.background = 'var(--primary-soft)';
              label.style.borderColor = 'var(--primary)';
            } else {
              label.style.background = '#fff';
              label.style.borderColor = 'var(--border)';
            }
          });
        }
      });

      document
        .getElementById("postJobButton")
        .addEventListener("click", async () => {
          const user = await window.hustlAPI.auth.getCurrentUser();
          if (!user)
            return showToast("Please log in to post a job.");
          
          // Check if we're editing an existing job
          if (editingJobId) {
            await updateJob(editingJobId);
            return;
          }

          const titleInput = document.getElementById("jobTitle");
          const title = titleInput.value.trim();
          
          // Validate title is 5 words or less
          const titleWords = title.split(/\s+/).filter(word => word.length > 0);
          if (titleWords.length > 5) {
            const errorDiv = document.getElementById("jobTitleError");
            if (errorDiv) {
              errorDiv.style.display = "block";
            }
            showToast("Job title must be 5 words or less. Please shorten it.");
            titleInput.focus();
            return;
          } else {
            const errorDiv = document.getElementById("jobTitleError");
            if (errorDiv) {
              errorDiv.style.display = "none";
            }
          }
          const category = document.getElementById("jobCategory").value;
          const desc = document.getElementById("jobDescription").value.trim();
          
          // Pricing option
          const pricingOption = document.getElementById("pricingOption")?.value || "set_price";
          
          let paymentType = null;
          let flatAmount = null;
          let hourlyRate = null;
          let maxHours = null;
          
          if (pricingOption === "set_price") {
            paymentType = document.getElementById("paymentType").value;
            flatAmount = Number(document.getElementById("flatAmount").value);
            hourlyRate = Number(document.getElementById("hourlyRate").value);
            maxHours = Number(document.getElementById("maxHours").value);
          } else {
            // If hustlers_quote, use default values (backend requires these fields)
            paymentType = 'flat';
            flatAmount = 50; // Default placeholder amount
            hourlyRate = null;
            maxHours = null;
          }
          
          const notes = document
            .getElementById("jobNotes")
            ?.value.trim() || '';
          
          // Content moderation - check for prohibited content (after notes is declared)
          const allContent = `${title} ${desc} ${notes}`;
          const moderationResult = checkContentModeration(allContent);
          
          if (!moderationResult.allowed) {
            const violationText = moderationResult.violations.join(', ');
            showToast(`❌ Your post contains prohibited content: ${violationText}. Please remove this content and try again. All payments must go through Hustl for your protection.`, 8000);
            return;
          }

          // Collect new fields
          const customCategory = document.getElementById("customCategory")?.value.trim() || "";
          const workersNeededValue = document.getElementById("workersNeeded")?.value || "1";
          let workersNeeded = 1;
          if (workersNeededValue === "company") {
            workersNeeded = 0; // Special value for "Company" (insured company/crew)
          } else {
            workersNeeded = Number(workersNeededValue) || 1;
          }
          
          // Upload photos if provided
          const photoInput = document.getElementById("jobPhoto");
          const photos = [];
          if (photoInput && photoInput.files && photoInput.files.length > 0) {
            try {
              for (let i = 0; i < photoInput.files.length; i++) {
                const file = photoInput.files[i];
                const formData = new FormData();
                formData.append('file', file);
                
                const token = localStorage.getItem('hustl_token');
                const uploadResponse = await fetch(`${API_BASE}/r2/upload`, {
                  method: 'POST',
                  headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                  body: formData
                });
                
                if (uploadResponse.ok) {
                  const uploadData = await uploadResponse.json();
                  photos.push(uploadData.publicUrl);
                } else {
                  console.error('Photo upload failed:', await uploadResponse.text());
                }
              }
            } catch (error) {
              console.error('Error uploading photos:', error);
              showToast('Some photos failed to upload, but job will still be posted.');
            }
          }
          // Collect equipment
          const equipmentNeeded = [];
          document.querySelectorAll('input[name="equipment"]:checked').forEach(cb => {
            equipmentNeeded.push(cb.value);
          });
          // Add custom equipment if provided
          const customEquipment = document.getElementById("customEquipment")?.value.trim() || "";
          if (customEquipment) {
            equipmentNeeded.push(customEquipment);
          }
          
          // Collect keepActiveFor (jobDuration)
          const jobDuration = document.getElementById("jobDuration")?.value || "3";
          const keepActiveFor = parseInt(jobDuration) || 3; // Days to keep job active

          // Collect sub-tags
          const subTags = [];
          document.querySelectorAll('input[name="subTags"]:checked').forEach(cb => {
            subTags.push(cb.value);
          });

          // Determine final category
          const finalCategory = category === "other" && customCategory ? customCategory : category;

          if (!title || !category || !desc)
            return showToast(
              "Please fill title, category, and description."
            );

          // Validate approximate location
          const approximateLat = parseFloat(document.getElementById("approximateLat")?.value);
          const approximateLng = parseFloat(document.getElementById("approximateLng")?.value);
          
          if (!approximateLat || !approximateLng || isNaN(approximateLat) || isNaN(approximateLng)) {
            return showToast("Please tap the map to set your approximate location.");
          }

          // Validate payment if set_price
          if (pricingOption === "set_price") {
            if (paymentType === "flat") {
              if (!flatAmount || flatAmount <= 0)
                return showToast("Flat amount must be > 0.");
            } else {
              if (!hourlyRate || hourlyRate <= 0 || !maxHours || maxHours <= 0)
                return showToast("Hourly rate and max hours must be valid.");
            }
          }

          try {
            // Use generic address string (exact address shared after acceptance)
            const address = "Approximate location (exact address shared after acceptance)";
            
            // Simplified date/time - default to flexible deadline (no_deadline)
            const now = new Date();
              const futureDate = new Date(now);
            futureDate.setFullYear(futureDate.getFullYear() + 1); // 1 year from now
            const date = futureDate.toISOString().split('T')[0];
            const startTime = new Date(futureDate);
              startTime.setHours(9, 0, 0, 0);
            const endTime = new Date(futureDate);
              endTime.setHours(17, 0, 0, 0);
            const deadlinePreference = "no_deadline";
            
            // Set expiration to 1 month from now (30 days)
            const expiresAt = new Date(now);
            expiresAt.setDate(expiresAt.getDate() + 30);
              expiresAt.setHours(23, 59, 59, 999);
            
            // Get preferred time (default to anytime if field removed)
            const preferredTime = document.getElementById("preferredTime")?.value || "anytime";
            
            // Transform payment data to backend format
            const payType = paymentType || 'flat';
            let amount = 0;
            let hourlyRateValue = null;
            let estHoursValue = null;
            
            if (pricingOption === "set_price") {
              if (payType === 'flat') {
                amount = flatAmount; // Already in dollars
              } else {
                amount = hourlyRate * maxHours; // Total estimated amount
                hourlyRateValue = hourlyRate;
                estHoursValue = maxHours;
              }
            } else {
              // hustlers_quote - use placeholder amount (backend requires amount field)
              amount = 50; // Placeholder, hustlers will propose their own price
            }
            
            // Validate required fields
            if (!title || title.trim().length === 0) {
              return showToast("❌ Please enter a job title.");
            }
            
            if (!desc || desc.trim().length === 0) {
              return showToast("❌ Please enter a job description.");
            }
            
            if (!date) {
              return showToast("❌ Please select a job date.");
            }
            
            // Ensure amount is valid
            if (!amount || amount <= 0 || isNaN(amount)) {
              return showToast("❌ Please set a valid price amount.");
            }
            
            // Build job data - only include hourlyRate/estHours if they have values
            const jobData = {
              title,
              category: finalCategory,
              description: desc,
              photos: photos.length > 0 ? photos : [], // Include uploaded photos
              address, // Generic address string
              approximateLat,
              approximateLng,
              date, // Backend expects ISO date string
              startTime: startTime.toISOString(), // Backend expects ISO datetime
              endTime: endTime.toISOString(), // Backend expects ISO datetime
              expiresAt: expiresAt ? expiresAt.toISOString() : null, // Expiration date/time
              payType: payType, // Backend expects 'flat' or 'hourly'
              amount: amount, // Backend expects dollar amount (not cents)
              teamSize: workersNeeded || 1,
              keepActiveFor: keepActiveFor, // Days to keep job active
              preferredTime: preferredTime, // morning, afternoon, evening, anytime
              requirements: {
                sub_tags: subTags.length > 0 ? subTags : null,
                notes: notes || null,
                pricing_option: pricingOption, // Store for future use
                deadline_preference: deadlinePreference, // Store deadline preference
                preferredTime: preferredTime, // morning, afternoon, evening, anytime
                // Include equipment data
                equipmentNeeded: equipmentNeeded.length > 0 ? equipmentNeeded : null,
                equipment_needed: equipmentNeeded.length > 0 ? equipmentNeeded : null,
                customEquipment: customEquipment || null,
                custom_equipment: customEquipment || null,
              },
            };
            
            // Only add hourlyRate and estHours if they have valid values
            if (hourlyRateValue && hourlyRateValue > 0) {
              jobData.hourlyRate = hourlyRateValue;
            }
            if (estHoursValue && estHoursValue > 0) {
              jobData.estHours = estHoursValue;
            }

            console.log("Posting job with data:", JSON.stringify(jobData, null, 2));
            let result;
            try {
              result = await window.hustlAPI.jobs.create(jobData);
              console.log("Job posted successfully:", result);
            } catch (error) {
              console.error("Full error object:", error);
              console.error("Error message:", error.message);
              console.error("Error stack:", error.stack);
              throw error;
            }

            // Show success message with details
            const successMessage = result?.message || "✅ Job posted successfully! Hustlers nearby will begin applying soon. Go to Manage Jobs to choose your favorite.";
            
            // Make button green and show congratulations popup
            const postButton = document.getElementById("postJobButton");
            if (postButton) {
              postButton.style.background = "#10b981";
              postButton.style.borderColor = "#10b981";
              postButton.textContent = "✅ Job Posted Successfully!";
              postButton.disabled = true;
              
              // Reset button after 5 seconds
              setTimeout(() => {
                postButton.style.background = "";
                postButton.style.borderColor = "";
                postButton.textContent = "Post job to Hustl";
                postButton.disabled = false;
              }, 5000);
            }
            
            // Show congratulations popup
            const congratsModal = document.createElement("div");
            congratsModal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.6);
              z-index: 10001;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 1rem;
            `;
            congratsModal.innerHTML = `
              <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 0 0 0.5rem 0;">Congratulations!</h2>
                <p style="color: var(--text-muted); margin: 0 0 1.5rem 0; line-height: 1.6;">
                  Your job has been posted successfully! Hustlers nearby will begin applying soon.
                </p>
                <button id="congratsGotItBtn" style="
                  padding: 0.75rem 2rem;
                  background: var(--primary);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  font-weight: 600;
                  cursor: pointer;
                ">Got it!</button>
              </div>
            `;
            document.body.appendChild(congratsModal);
            
            // Handle "Got it!" button - navigate to Manage Jobs
            const gotItBtn = congratsModal.querySelector('#congratsGotItBtn');
            if (gotItBtn) {
              gotItBtn.addEventListener('click', () => {
                congratsModal.remove();
                // Navigate to Manage Jobs view
                if (typeof setView === 'function') {
                  setView('manage-jobs');
                } else if (window.setView && typeof window.setView === 'function') {
                  window.setView('manage-jobs');
                }
              });
            }
            
            // Also close modal when clicking outside and navigate to Manage Jobs
            congratsModal.addEventListener('click', (e) => {
              if (e.target === congratsModal) {
                congratsModal.remove();
                if (typeof setView === 'function') {
                  setView('manage-jobs');
                } else if (window.setView && typeof window.setView === 'function') {
                  window.setView('manage-jobs');
                }
              }
            });
            
            showToast(successMessage);
            
            // Hide job stats card if it's visible
            const statsCard = document.getElementById('jobStatsCard');
            if (statsCard) {
              statsCard.style.display = 'none';
            }
            
            // Clear the form after posting
            const jobForm = document.getElementById('jobForm');
            if (jobForm) {
              jobForm.reset();
              // Also clear any custom fields
              const titleInput = document.getElementById('jobTitle');
              const descriptionInput = document.getElementById('jobDescription');
              const amountInput = document.getElementById('jobAmount');
              if (titleInput) titleInput.value = '';
              if (descriptionInput) descriptionInput.value = '';
              if (amountInput) amountInput.value = '';
            }
            
            // Refresh the Manage Jobs view if it's loaded
            if (activeView === 'manage-jobs') {
              loadPostedJobs();
            }
            
            // Also refresh jobs list
            renderJobs(true);
          } catch (error) {
            console.error("Post job error:", error);
            console.error("Error details:", error.message, error.stack);
            const errorMsg = error.message || "Unknown error";
            showToast("Failed to post job: " + errorMsg);
          }
        });
    }
    
    // showJobStats function removed - user requested removal of job stats popup

    
// Global filter state
let activeCategoryFilter = 'all'; // Legacy - kept for compatibility
let activeSortBy = 'newest'; // Legacy - kept for compatibility

// New multi-select filter state
let activeCategoryFilters = new Set(); // Multi-select categories
let activePriceTypeFilters = new Set(); // flat, hourly, hustler_sets
let activeTimeFilters = new Set(); // asap, tomorrow, this_week, scheduled, flexible
let activeWorkersFilters = new Set(); // 1, 2, 3+

// Background polling system
let backgroundPollInterval = null;
let isUserInteracting = false; // Track if user is typing/interacting
let lastPollTime = 0;
const POLL_INTERVAL = 4500; // 4.5 seconds (between 3-6 seconds)
const POLLABLE_VIEWS = ['jobs', 'manage-jobs', 'messages'];

// Map view state
let currentJobsView = 'list'; // 'list' or 'map'
let jobsMap = null; // Mapbox map instance
let mapMarkers = []; // Array of map markers
let mapboxToken = null; // Mapbox access token

// Request cache to avoid duplicate calls
const requestCache = new Map();
const CACHE_TTL = 30000; // 30 seconds

// Retry utility with exponential backoff
async function fetchWithRetry(url, options = {}, maxRetries = 2, timeout = 10000) {
  const cacheKey = `${url}_${JSON.stringify(options)}`;
  const cached = requestCache.get(cacheKey);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (response.ok) {
        const data = await response.json();
        // Cache successful responses
        requestCache.set(cacheKey, { data, timestamp: Date.now() });
        return data;
      } else if (response.status >= 500 && attempt < maxRetries) {
        // Retry on server errors
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        continue;
      } else if (response.status === 401) {
        // Don't retry on 401 - return error response
        try {
          const errorData = await response.json();
          return errorData;
        } catch (e) {
          return { error: 'Unauthorized', status: 401 };
        }
      }
      
      // For other errors, try to parse JSON but don't throw
      try {
      return await response.json();
      } catch (e) {
        return { error: `Request failed with status ${response.status}`, status: response.status };
      }
    } catch (error) {
      if (error.name === 'AbortError') {
        if (attempt < maxRetries) {
          await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
          continue;
        }
        throw new Error('Request timeout');
      }
      
      if (attempt < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        continue;
      }
      
      console.warn(`Fetch failed after ${maxRetries + 1} attempts:`, error);
      throw error;
    }
  }
}

// Safe fetch wrapper that never throws - returns null on error
async function safeFetch(url, options = {}) {
  try {
    return await fetchWithRetry(url, options, 1, 8000);
  } catch (error) {
    console.warn('Safe fetch failed:', error);
    return null;
  }
}

// Format location for public display: Street name + City + ZIP (NO house number, NO apartment)
function formatPublicLocation(job, requirements, showExactAddress = false) {
  const req = requirements || job.requirements || {};
  const hidePickupAddress = req.hide_pickup_address_until_assigned || req.hidePickupAddressUntilAssigned;
  const pickupAddress = req.pickup_address || '';
  const pickupCity = req.pickup_city || req.pickupCity || '';
  const pickupZip = req.pickup_zip || '';
  
  // Helper function to remove apartment/unit numbers more thoroughly
  function removeApartmentNumber(address) {
    if (!address) return address;
    // Remove common apartment/unit patterns (more comprehensive)
    // Matches: Apt, Unit, #, Suite, Ste, Apt., Unit., Apartment, APT, etc. followed by numbers/letters
    return address.replace(/\s*(?:Apt|Unit|#|Suite|Ste|Apt\.|Unit\.|Apartment|APT|UNIT|SUITE|#\s*)\s*[A-Z0-9-]+/gi, '').trim();
  }
  
  // If exact address should be shown (assigned hustler), show full address but remove apartment/unit
  if (showExactAddress && pickupAddress) {
    const cleanedAddress = removeApartmentNumber(pickupAddress);
    if (cleanedAddress && pickupCity) {
      return pickupZip ? `${cleanedAddress}, ${pickupCity} ${pickupZip}` : `${cleanedAddress}, ${pickupCity}`;
    }
  }
  
  // If address is NOT hidden: show full street address + ZIP (remove apartment/unit)
  if (!hidePickupAddress && pickupAddress) {
    const cleanedAddress = removeApartmentNumber(pickupAddress);
    if (cleanedAddress && pickupCity) {
      return pickupZip ? `${cleanedAddress}, ${pickupCity} ${pickupZip}` : `${cleanedAddress}, ${pickupCity}`;
    }
  }
  
  // If address IS hidden: show street name ONLY (no house number) + ZIP
  if (hidePickupAddress && pickupAddress) {
    // Remove apartment/unit numbers first
    let cleanedAddress = removeApartmentNumber(pickupAddress);
    // Extract street name (remove house number) - match pattern like "123 Main St" -> "Main St"
    const streetMatch = cleanedAddress.match(/^\d+\s+(.+)$/);
    const streetName = streetMatch ? streetMatch[1] : cleanedAddress;
    if (streetName && pickupCity) {
      return pickupZip ? `${streetName}, ${pickupCity} ${pickupZip}` : `${streetName}, ${pickupCity}`;
    }
  }
  
  // Fallback: City + ZIP
  if (pickupCity) {
    return pickupZip ? `${pickupCity} ${pickupZip}` : pickupCity;
  }
  
  return 'Location TBD';
}

// Format dropoff location with same privacy rules as pickup
function formatDropoffLocation(job, requirements, showExactAddress = false) {
  const req = requirements || job.requirements || {};
  const hideDropoffAddress = req.hide_dropoff_address_until_assigned || req.hideDropoffAddressUntilAssigned;
  const dropoffAddress = req.dropoff_address || '';
  const dropoffCity = req.dropoff_city || req.dropoffCity || '';
  const dropoffZip = req.dropoff_zip || '';
  
  // Helper function to remove apartment/unit numbers more thoroughly
  function removeApartmentNumber(address) {
    if (!address) return address;
    // Remove common apartment/unit patterns (more comprehensive)
    return address.replace(/\s*(?:Apt|Unit|#|Suite|Ste|Apt\.|Unit\.|Apartment|APT|UNIT|SUITE|#\s*)\s*[A-Z0-9-]+/gi, '').trim();
  }
  
  // If exact address should be shown (assigned hustler), show full address but remove apartment/unit
  if (showExactAddress && dropoffAddress) {
    const cleanedAddress = removeApartmentNumber(dropoffAddress);
    if (cleanedAddress && dropoffCity) {
      return dropoffZip ? `${cleanedAddress}, ${dropoffCity} ${dropoffZip}` : `${cleanedAddress}, ${dropoffCity}`;
    }
  }
  
  // If address is NOT hidden: show full street address + ZIP (remove apartment/unit)
  if (!hideDropoffAddress && dropoffAddress) {
    const cleanedAddress = removeApartmentNumber(dropoffAddress);
    if (cleanedAddress && dropoffCity) {
      return dropoffZip ? `${cleanedAddress}, ${dropoffCity} ${dropoffZip}` : `${cleanedAddress}, ${dropoffCity}`;
    }
  }
  
  // If address IS hidden: show street name ONLY (no house number) + ZIP
  if (hideDropoffAddress && dropoffAddress) {
    // Remove apartment/unit numbers first
    let cleanedAddress = removeApartmentNumber(dropoffAddress);
    // Extract street name (remove house number) - match pattern like "123 Main St" -> "Main St"
    const streetMatch = cleanedAddress.match(/^\d+\s+(.+)$/);
    const streetName = streetMatch ? streetMatch[1] : cleanedAddress;
    if (streetName && dropoffCity) {
      return dropoffZip ? `${streetName}, ${dropoffCity} ${dropoffZip}` : `${streetName}, ${dropoffCity}`;
    }
  }
  
  // Fallback: City + ZIP
  if (dropoffCity) {
    return dropoffZip ? `${dropoffCity} ${dropoffZip}` : dropoffCity;
  }
  
  return 'Location TBD';
}

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 3959; // Earth's radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// Content moderation - check for prohibited content
function checkContentModeration(text) {
  if (!text || typeof text !== 'string') return { allowed: true, violations: [] };
  
  const contentToCheck = text.toLowerCase();
  const prohibitedPatterns = [
    // Sexual content
    { pattern: /\b(sex|sexual|hookup|escort|prostitute|nude|naked|porn|xxx|adult services)\b/i, category: 'sexual content' },
    // Drug-related
    { pattern: /\b(drug|marijuana|weed|cocaine|heroin|meth|pills|prescription|illegal substance|dealer)\b/i, category: 'drug-related content' },
    // Illegal activities
    { pattern: /\b(illegal|steal|theft|robbery|fraud|scam|counterfeit|black market)\b/i, category: 'illegal activities' },
    // Off-app payment
    { pattern: /\b(cash only|venmo|cashapp|zelle|paypal|pay outside|off app|direct payment|avoid fee|skip fee|no fee|pay me directly|pay outside app|pay cash|under the table|bypass platform)\b/i, category: 'off-app payment requests' }
  ];
  
  const violations = [];
  prohibitedPatterns.forEach(({ pattern, category }) => {
    if (pattern.test(contentToCheck)) {
      violations.push(category);
    }
  });
  
  return {
    allowed: violations.length === 0,
    violations: [...new Set(violations)] // Remove duplicates
  };
}

// Format distance for display
function formatDistance(miles) {
  if (miles < 0.1) return '< 0.1 mi away';
  if (miles < 1) return `${miles.toFixed(1)} mi away`;
  return `${miles.toFixed(1)} mi away`;
}

// Get Mapbox token
async function getMapboxToken() {
  if (mapboxToken) return mapboxToken;
  try {
    const data = await safeFetch(`${API_BASE}/jobs/mapbox-token`);
    if (data && data.token) {
      mapboxToken = data.token;
      return mapboxToken;
    }
  } catch (e) {
    console.warn('Failed to get Mapbox token:', e);
  }
  return null;
}

// Initialize Mapbox map
async function initJobsMap() {
  const mapContainer = document.getElementById('jobsMap');
  const mapLoading = document.getElementById('jobsMapLoading');
  if (!mapContainer) return;
  
  // Check if map already initialized
  if (jobsMap) {
    return jobsMap;
  }
  
  try {
    const token = await getMapboxToken();
    if (!token) {
      if (mapLoading) mapLoading.textContent = 'Map unavailable - token not configured';
      return null;
    }
    
    // Load Mapbox GL JS if not already loaded
    if (typeof mapboxgl === 'undefined') {
      // Add Mapbox GL JS CSS
      if (!document.querySelector('link[href*="mapbox-gl.css"]')) {
        const link = document.createElement('link');
        link.href = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css';
        link.rel = 'stylesheet';
        document.head.appendChild(link);
      }
      
      // Add Mapbox GL JS script
      if (!document.querySelector('script[src*="mapbox-gl.js"]')) {
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
    }
    
    mapboxgl.accessToken = token;
    
    // Initialize map centered on Tennessee (default)
    jobsMap = new mapboxgl.Map({
      container: 'jobsMap',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-86.7816, 35.7471], // Tennessee center
      zoom: 7
    });
    
    jobsMap.on('load', () => {
      if (mapLoading) mapLoading.style.display = 'none';
      // Map is ready, but we'll render when renderJobs is called
      
      // Add user location marker if location is available
      if (userLocation && userLocation.lat && userLocation.lng) {
        if (typeof addUserLocationMarker === 'function') {
          addUserLocationMarker(userLocation.lat, userLocation.lng);
        }
      }
    });
    
    jobsMap.on('error', (e) => {
      console.error('Map error:', e);
      if (mapLoading) mapLoading.textContent = 'Error loading map';
    });
    
    return jobsMap;
  } catch (error) {
    console.error('Failed to initialize map:', error);
    if (mapLoading) mapLoading.textContent = 'Failed to load map';
    return null;
  }
}

// Function to add user location marker to map (make it globally accessible)
function addUserLocationMarker(lat, lng) {
  if (!jobsMap || !jobsMap.loaded()) return;
  
  // Remove existing marker if any
  if (window.userLocationMarker) {
    window.userLocationMarker.remove();
  }
  
  // Create person icon element
  const el = document.createElement('div');
  el.className = 'user-location-marker';
  el.style.cssText = `
    width: 28px;
    height: 28px;
    background: #dc2626;
    border: 2px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    cursor: pointer;
    z-index: 10;
  `;
  el.innerHTML = '👤';
  el.title = 'Your location';
  
  // Create marker
  window.userLocationMarker = new mapboxgl.Marker({
    element: el,
    anchor: 'center'
  })
    .setLngLat([lng, lat])
    .addTo(jobsMap);
}

// Render jobs on map - SIMPLIFIED and STABLE
async function renderJobsOnMap(jobs) {
  if (!jobsMap) {
    console.warn('[renderJobsOnMap] Map not initialized');
    return;
  }
  
  console.log(`[renderJobsOnMap] Rendering ${jobs ? jobs.length : 0} jobs on map`);
  
  // Fetch user's applied jobs if not already available
  let userAppliedJobIds = new Set();
  try {
    const token = localStorage.getItem('hustl_token');
    const user = await window.hustlAPI?.auth?.getCurrentUser();
    if (token && user) {
      const offers = await safeFetch(`${API_BASE}/offers/user/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (offers && Array.isArray(offers)) {
        const relevantOffers = offers.filter(offer => 
          offer.status === 'PENDING' || 
          (offer.status === 'ACCEPTED' && offer.job && (offer.job.status === 'SCHEDULED' || offer.job.status === 'ASSIGNED') && !offer.job.startCodeVerified)
        );
        userAppliedJobIds = new Set(relevantOffers.map(offer => offer.jobId).filter(Boolean));
        console.log(`[renderJobsOnMap] User has applied to ${userAppliedJobIds.size} jobs`);
      }
    }
  } catch (e) {
    console.warn("[renderJobsOnMap] Could not fetch user's applied jobs:", e);
  }
  
  // Wait for map to be fully loaded
  if (!jobsMap.loaded()) {
    jobsMap.once('load', async () => {
      await renderJobsOnMap(jobs);
    });
    return;
  }
  
  // Add user location marker if available
  if (userLocation && userLocation.lat && userLocation.lng) {
    addUserLocationMarker(userLocation.lat, userLocation.lng);
  }
  
  if (!jobs || jobs.length === 0) {
    // Center on Tennessee if no jobs
    jobsMap.flyTo({
      center: [-86.7816, 35.7471],
      zoom: 7
    });
    return;
  }
  
  // Clear ALL existing markers and circles first (Step 3)
  mapMarkers.forEach(marker => {
    try {
      marker.remove();
    } catch (e) {
      // Ignore errors when removing
    }
  });
  mapMarkers = [];
  
  // Remove all job circles
  if (window.jobCircleIds && jobsMap && jobsMap.loaded()) {
    window.jobCircleIds.forEach(circleId => {
      try {
        if (jobsMap.getLayer(circleId)) {
          jobsMap.removeLayer(circleId);
        }
        if (jobsMap.getSource(circleId)) {
          jobsMap.removeSource(circleId);
        }
      } catch (e) {
        // Ignore errors
      }
    });
  }
  window.jobCircleIds = [];
  
  // Deduplicate jobs by ID to ensure one marker per job
  const uniqueJobs = [];
  const seenIds = new Set();
  jobs.forEach(job => {
    if (job.id && !seenIds.has(job.id)) {
      seenIds.add(job.id);
      uniqueJobs.push(job);
    }
  });
  
  // Get user location for distance
  const userLoc = userLocation || null;
  
  // Process each unique job
  const validJobs = [];
  
  uniqueJobs.forEach((job, index) => {
    const requirements = job.requirements || {};
    
    // Determine address visibility and if user is assigned hustler
    const hidePickupAddress = requirements.hide_pickup_address_until_assigned || requirements.hidePickupAddressUntilAssigned;
    let isAreaBased = false;
    let showExactAddress = false;
    
    if (hidePickupAddress) {
      try {
        const user = window.hustlAPI?.auth?.getCurrentUserSync?.() || (window.currentUser || null);
        if (user) {
          // Check if user is the assigned hustler
          const isAssignedHustler = job.hustlerId && job.hustlerId === user.id && 
                                     (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'IN_PROGRESS');
          showExactAddress = isAssignedHustler;
          // If address is hidden and user is not assigned hustler, use street-level
          isAreaBased = !isAssignedHustler;
        } else {
          // No user logged in, use street-level
          isAreaBased = true;
        }
      } catch (e) {
        // Default to street-level if error
        isAreaBased = true;
      }
    }
    
    // Get approximate coordinates (Step 3: Use approximate location only)
    // Priority: approximateLat/approximateLng, fallback to lat/lng for backward compatibility
    let lat = null;
    let lng = null;
    
    // Use approximate location if available
    if (job.approximateLat !== null && job.approximateLat !== undefined && 
        job.approximateLng !== null && job.approximateLng !== undefined) {
      lat = parseFloat(job.approximateLat);
      lng = parseFloat(job.approximateLng);
    } else if (job.lat && job.lng) {
      // Fallback to lat/lng for jobs created before Step 2
      lat = parseFloat(job.lat);
      lng = parseFloat(job.lng);
    }
    
    // All jobs now use approximate location (no exact pins)
    // Validate coordinates and add to validJobs
    if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng) && 
        lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
      validJobs.push({
        job: job,
        lat: lat,
        lng: lng,
        isApproximate: true // All locations are approximate now
      });
    }
  });
  
  if (validJobs.length === 0) {
    const mapLoading = document.getElementById('jobsMapLoading');
    if (mapLoading) {
      mapLoading.style.display = 'block';
      mapLoading.textContent = 'No jobs with location data';
    }
    return;
  }
  
  // Hide loading
  const mapLoading = document.getElementById('jobsMapLoading');
  if (mapLoading) mapLoading.style.display = 'none';
  
  // Calculate bounds and fit map
  if (validJobs.length > 0) {
    const lats = validJobs.map(j => j.lat);
    const lngs = validJobs.map(j => j.lng);
    const bounds = [
      [Math.min(...lngs), Math.min(...lats)],
      [Math.max(...lngs), Math.max(...lats)]
    ];
    
    jobsMap.fitBounds(bounds, {
      padding: { top: 50, bottom: 50, left: 50, right: 50 },
      maxZoom: 14
    });
  }
  
  // Create ONE marker per job with 0.25 mile radius circle (Step 3: Approximate location only)
  validJobs.forEach(({ job, lat, lng, isApproximate }) => {
    const requirements = job.requirements || {};
    
    // Distance calculation (approximate)
    let distanceText = '';
    if (userLoc && userLoc.lat && userLoc.lng) {
      const distance = calculateDistance(userLoc.lat, userLoc.lng, lat, lng);
      distanceText = `~${formatDistance(distance)}`; // Add ~ to indicate approximate
    }
    
    // Location text - no exact address shown (Step 3)
    const locationText = 'Approximate location (exact address shared after acceptance)';
    
    // Popup content (mobile-friendly)
    const popupContent = document.createElement('div');
    popupContent.style.cssText = 'padding: 0.875rem; min-width: 220px; max-width: 280px;';
    popupContent.innerHTML = `
      <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; color: #111827; line-height: 1.3;">${job.title || 'Untitled Job'}</div>
      ${distanceText ? `<div style="font-size: 0.875rem; color: #3b82f6; margin-bottom: 0.375rem; font-weight: 500;">📍 ${distanceText} away</div>` : ''}
      <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.5rem; line-height: 1.4;">${locationText}</div>
      <div style="font-weight: 700; font-size: 0.95rem; color: #059669; margin-bottom: 0.5rem;">
        ${job.payType === 'hourly' ? `$${parseFloat(job.hourlyRate || 0).toFixed(0)}/hr` : `$${parseFloat(job.amount || 0).toFixed(0)} flat`}
      </div>
      <button class="view-job-map-btn" data-job-id="${job.id}" style="margin-top: 0.5rem; padding: 0.625rem 1rem; width: 100%; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; min-height: 44px; touch-action: manipulation;">
        View Details
      </button>
    `;
    
    // Check if user has applied to this job
    const hasApplied = userAppliedJobIds && userAppliedJobIds.has(job.id);
    const markerColor = hasApplied ? '#10b981' : '#3b82f6'; // Green for applied, blue for not applied
    
    // Create marker element - always use circle (no exact pins, Step 3)
    const el = document.createElement('div');
    el.className = 'job-marker';
      el.style.cssText = `
        width: 20px;
        height: 20px;
        background: ${hasApplied ? 'rgba(16, 185, 129, 0.6)' : 'rgba(59, 130, 246, 0.6)'};
      border: 2px solid ${hasApplied ? 'rgba(16, 185, 129, 0.9)' : 'rgba(59, 130, 246, 0.9)'};
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        position: absolute;
        pointer-events: auto;
      z-index: 1;
      `;
    
    el.title = job.title || 'Job';
    
    // Click handler - opens job details
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      if (typeof openJobDetails === 'function') {
        openJobDetails(job.id);
      }
    });
    
    // Create marker - NO animations, completely stationary
    const marker = new mapboxgl.Marker({
      element: el,
      anchor: 'center',
      draggable: false
    })
      .setLngLat([lng, lat])
      .setPopup(new mapboxgl.Popup({ 
        offset: 12,
        anchor: 'bottom',
        closeOnClick: false
      }).setDOMContent(popupContent))
      .addTo(jobsMap);
    
    // Add 0.25 mile radius circle for approximate location (Step 3)
    // 0.25 miles = 402.336 meters
    const radiusMeters = 402.336;
    const circleId = `job-circle-${job.id}`;
    
    try {
      // Create circle geometry
      const circle = createCircle([lng, lat], radiusMeters);
      
      // Add circle source and layer if map is loaded
      if (jobsMap.loaded()) {
        jobsMap.addSource(circleId, {
          type: 'geojson',
          data: circle
        });
        
        jobsMap.addLayer({
          id: circleId,
          type: 'fill',
          source: circleId,
          paint: {
            'fill-color': hasApplied ? '#10b981' : '#3b82f6', // Green for applied, blue for not applied
            'fill-opacity': 0.1
          }
        });
        
        jobsMap.addLayer({
          id: `${circleId}-outline`,
          type: 'line',
          source: circleId,
          paint: {
            'line-color': hasApplied ? '#10b981' : '#3b82f6', // Green for applied, blue for not applied
            'line-width': 2,
            'line-opacity': 0.4
          }
        });
      } else {
        // Wait for map to load
        jobsMap.once('load', () => {
          jobsMap.addSource(circleId, {
            type: 'geojson',
            data: circle
          });
          
          jobsMap.addLayer({
            id: circleId,
            type: 'fill',
            source: circleId,
            paint: {
              'fill-color': hasApplied ? '#10b981' : '#3b82f6', // Green for applied, blue for not applied
              'fill-opacity': 0.1
            }
          });
          
          jobsMap.addLayer({
            id: `${circleId}-outline`,
            type: 'line',
            source: circleId,
            paint: {
              'line-color': hasApplied ? '#10b981' : '#3b82f6', // Green for applied, blue for not applied
              'line-width': 2,
              'line-opacity': 0.4
            }
          });
        });
      }
    } catch (e) {
      console.warn('Error adding circle for job:', job.id, e);
    }
    
    // Popup button handler
    setTimeout(() => {
      const btn = popupContent.querySelector('.view-job-map-btn');
      if (btn) {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          if (typeof openJobDetails === 'function') {
            openJobDetails(job.id);
          }
        });
      }
    }, 50);
    
    mapMarkers.push(marker);
  });
  
  // Store circle IDs for cleanup
  if (!window.jobCircleIds) {
    window.jobCircleIds = [];
  }
  validJobs.forEach(({ job }) => {
    window.jobCircleIds.push(`job-circle-${job.id}`);
    window.jobCircleIds.push(`job-circle-${job.id}-outline`);
  });
}

// Toggle between List and Map view
async function toggleJobsView(view) {
  currentJobsView = view;
  const listBtn = document.getElementById('jobsViewListBtn');
  const mapBtn = document.getElementById('jobsViewMapBtn');
  const listContainer = document.getElementById('jobsList');
  const mapContainer = document.getElementById('jobsMapContainer');
  
  if (view === 'list') {
    if (listBtn) {
      listBtn.classList.add('active');
      listBtn.style.background = 'white';
      listBtn.style.color = '#111827';
    }
    if (mapBtn) {
      mapBtn.classList.remove('active');
      mapBtn.style.background = 'transparent';
      mapBtn.style.color = '#6b7280';
    }
    if (listContainer) listContainer.style.display = 'flex';
    if (mapContainer) mapContainer.style.display = 'none';
  } else {
    if (listBtn) {
      listBtn.classList.remove('active');
      listBtn.style.background = 'transparent';
      listBtn.style.color = '#6b7280';
    }
    if (mapBtn) {
      mapBtn.classList.add('active');
      mapBtn.style.background = 'white';
      mapBtn.style.color = '#111827';
    }
    if (listContainer) listContainer.style.display = 'none';
    if (mapContainer) mapContainer.style.display = 'block';
    
    // Initialize map if not already done, then render jobs
    if (!jobsMap) {
      console.log('Initializing map...');
      initJobsMap().then(async () => {
        console.log('Map initialized, rendering jobs...');
        // Get current filtered jobs and render them directly on map
        if (allLoadedJobs && allLoadedJobs.length > 0) {
          // Re-apply filters to get current filtered jobs
          const filtered = allLoadedJobs.filter((j) => {
            if (!j || !j.id) return false;
            const status = (j.status || '').toUpperCase();
            if (status === "EXPIRED") return false;
            if (status !== "OPEN") return false;
            
            const now = new Date();
            if (j.expiresAt) {
              try {
                const expirationDate = new Date(j.expiresAt);
                if (!isNaN(expirationDate.getTime()) && expirationDate <= now) return false;
              } catch (e) {}
            }
            return true;
          });
          
          // Apply category filters if set
          let finalFiltered = filtered;
          if (activeCategoryFilters.size > 0) {
            finalFiltered = filtered.filter((j) => {
              const jobCategory = (j.category || 'other').toLowerCase();
              return activeCategoryFilters.has(jobCategory);
            });
          }
          
          console.log(`[toggleJobsView] Rendering ${finalFiltered.length} jobs on map`);
          if (finalFiltered.length > 0 && typeof renderJobsOnMap === 'function') {
            await renderJobsOnMap(finalFiltered);
          }
        }
      });
    } else {
      // Map already initialized, just render jobs directly
      console.log('Map already initialized, rendering jobs...');
      if (allLoadedJobs && allLoadedJobs.length > 0) {
        // Re-apply filters and render directly on map
        const filtered = allLoadedJobs.filter((j) => {
          if (!j || !j.id) return false;
          const status = (j.status || '').toUpperCase();
          if (status === "EXPIRED") return false;
          if (status !== "OPEN") return false;
          
          const now = new Date();
          if (j.expiresAt) {
            try {
              const expirationDate = new Date(j.expiresAt);
              if (!isNaN(expirationDate.getTime()) && expirationDate <= now) return false;
            } catch (e) {}
          }
          return true;
        });
        
        // Apply category filters if set
        let finalFiltered = filtered;
        if (activeCategoryFilters.size > 0) {
          finalFiltered = filtered.filter((j) => {
            const jobCategory = (j.category || 'other').toLowerCase();
            return activeCategoryFilters.has(jobCategory);
          });
        }
        
        console.log(`[toggleJobsView] Rendering ${finalFiltered.length} jobs on map (map already exists)`);
        if (finalFiltered.length > 0 && typeof renderJobsOnMap === 'function') {
          await renderJobsOnMap(finalFiltered);
        }
      }
    }
  }
}

// Initialize view toggle buttons
let toggleInitialized = false;
function initJobsViewToggle() {
  const listBtn = document.getElementById('jobsViewListBtn');
  const mapBtn = document.getElementById('jobsViewMapBtn');
  
  if (!listBtn || !mapBtn) {
    console.warn('Toggle buttons not found, retrying...');
    if (!toggleInitialized) {
      setTimeout(initJobsViewToggle, 200);
    }
    return;
  }
  
  // Only initialize once
  if (toggleInitialized && listBtn.hasAttribute('data-initialized')) {
    return;
  }
  
  // Add event listeners directly
  listBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('List button clicked');
    toggleJobsView('list');
  });
  
  mapBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('Map button clicked');
    toggleJobsView('map');
  });
  
  // Mark as initialized
  listBtn.setAttribute('data-initialized', 'true');
  mapBtn.setAttribute('data-initialized', 'true');
  toggleInitialized = true;
  console.log('Jobs view toggle initialized');
}

// Make functions globally accessible
window.initJobsViewToggle = initJobsViewToggle;
window.toggleJobsView = toggleJobsView;

// Function to update countdown timers on job cards
function updateCountdownTimers() {
  try {
    const timers = document.querySelectorAll('.countdown-timer[data-expires-at]');
    const now = new Date();
    
    timers.forEach(timer => {
      try {
        const expiresAt = timer.getAttribute('data-expires-at');
        const jobId = timer.getAttribute('data-job-id');
        if (!expiresAt) return;
        
        const expiresDate = new Date(expiresAt);
        const timeLeft = expiresDate - now;
        
        // Check if job has accepted hustler - if so, hide countdown
        const jobCard = timer.closest('.job-card');
        if (jobCard) {
          const jobData = jobCard.dataset.jobData ? JSON.parse(jobCard.dataset.jobData) : null;
          if (jobData && (jobData.hustlerId || jobData.status === 'SCHEDULED' || jobData.status === 'ASSIGNED' || jobData.status === 'IN_PROGRESS')) {
            timer.style.display = 'none';
            return;
          }
        }
        
        if (timeLeft > 0) {
          const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
          const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          if (days > 0) {
            timer.textContent = `⏱️ Expires in ${days}d ${hours}h`;
          } else if (hours > 0) {
            timer.textContent = `⏱️ Expires in ${hours}h`;
          } else {
            timer.textContent = `⏱️ Expires soon`;
          }
          timer.style.color = '#dc2626';
        } else {
          timer.textContent = `⏱️ Expired`;
          timer.style.color = '#991b1b';
        }
      } catch (e) {
        console.warn('Error updating countdown timer:', e);
      }
    });
  } catch (e) {
    console.warn('Error in updateCountdownTimers:', e);
  }
}

// Initialize countdown timer updates
function initCountdownTimers() {
  if (typeof setInterval === 'undefined' || typeof document === 'undefined') return;
  
  // Update every minute
  setInterval(() => {
    updateCountdownTimers();
  }, 60000);
  
  // Also update after a short delay
  setTimeout(() => {
    updateCountdownTimers();
  }, 2000);
}

// Initialize when DOM is ready
if (typeof document !== 'undefined') {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCountdownTimers);
  } else {
    initCountdownTimers();
  }
}

async function renderJobs(reset = false) {
  console.log('🔵 NEW RENDERJOBS VERSION LOADED - v3.0');
  const jobsList = document.getElementById("jobsList");
  const jobsCardTitle = document.getElementById("jobsCardTitle");
  const jobsFilterSummary = document.getElementById("jobsFilterSummary");
  
  // Ensure toggle is initialized when rendering jobs
  if (activeView === 'jobs') {
    setTimeout(() => {
      if (typeof initJobsViewToggle === 'function') {
        initJobsViewToggle();
      }
    }, 50);
  }

  // Reset pagination if needed
  if (reset) {
    currentJobsPage = 1;
    allLoadedJobs = [];
    if (jobsList) jobsList.innerHTML = ""; // Clear existing jobs
  }
  
  // Fetch user's applied jobs to show "Applied" indicator
  let userAppliedJobIds = new Set();
  let userAppliedOffers = new Map(); // jobId -> offer object (for status checking)
  try {
    const token = localStorage.getItem('hustl_token');
    const user = await window.hustlAPI?.auth?.getCurrentUser();
    if (token && user) {
      const offers = await safeFetch(`${API_BASE}/offers/user/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (offers && Array.isArray(offers)) {
        // Filter out DECLINED offers - only track PENDING and ACCEPTED
        const relevantOffers = offers.filter(offer => 
          offer.status === 'PENDING' || 
          (offer.status === 'ACCEPTED' && offer.job && (offer.job.status === 'SCHEDULED' || offer.job.status === 'ASSIGNED') && !offer.job.startCodeVerified)
        );
        userAppliedJobIds = new Set(relevantOffers.map(offer => offer.jobId).filter(Boolean));
        // Store offer details for status checking
        relevantOffers.forEach(offer => {
          if (offer.jobId) {
            userAppliedOffers.set(offer.jobId, offer);
          }
        });
        console.log("🔵 User has applied to jobs:", Array.from(userAppliedJobIds), "Total offers:", relevantOffers.length);
      }
    }
  } catch (e) {
    console.warn("Could not fetch user's applied jobs:", e);
  }

  try {
    // Get location filters
    const locationZipFilter = document.getElementById("locationZipFilter");
    const locationRadiusFilter = document.getElementById("locationRadiusFilter");
    const zip = locationZipFilter ? locationZipFilter.value.trim() : '';
    const radius = locationRadiusFilter ? parseInt(locationRadiusFilter.value) : 25;
    
    // Build filters for API
    // CRITICAL: Always request OPEN status for Browse Jobs
    const filters = {
      page: currentJobsPage,
      limit: 20,
      sortBy: activeSortBy,
      status: 'OPEN' // Explicitly request OPEN jobs only
    };
    
    if (zip && zip.length === 5) {
      filters.zip = zip;
    }
    
    if (radius && radius !== 25) {
      filters.radius = radius;
    }
    
    // Add category filter if not "all"
    if (activeCategoryFilter && activeCategoryFilter !== 'all') {
      filters.category = activeCategoryFilter;
    }

    // Load jobs from API (use window.hustlAPI if available, otherwise fallback)
    let response;
    try {
      if (window.hustlAPI && window.hustlAPI.jobs && typeof window.hustlAPI.jobs.list === 'function') {
        response = await window.hustlAPI.jobs.list(filters);
        console.log('[renderJobs] API response from hustlAPI.jobs.list:', response);
      } else {
        // Fallback: Try direct API call
        const params = new URLSearchParams();
        if (filters.page) params.append('page', filters.page);
        if (filters.limit) params.append('limit', filters.limit);
        if (filters.zip) params.append('zip', filters.zip);
        if (filters.category) params.append('category', filters.category);
        
        const apiUrl = `${BACKEND_URL}/api/jobs?${params.toString()}`;
        console.log('[renderJobs] Fetching from:', apiUrl);
        
        response = await safeFetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        console.log('[renderJobs] Direct API response:', response);
        
        if (!response) {
          console.warn('[renderJobs] No response from API, using empty response');
          // If fetch fails, use empty response instead of crashing
          response = { jobs: [], pagination: { hasMore: false, total: 0 } };
        } else if (response.error) {
          console.error('[renderJobs] API returned error:', response.error);
          response = { jobs: [], pagination: { hasMore: false, total: 0 } };
        }
      }
    } catch (apiError) {
      console.error("[renderJobs] API call failed:", apiError);
      // If API fails, use empty response instead of crashing
      response = { jobs: [], pagination: { hasMore: false, total: 0 } };
    }
    
    // Handle paginated response - ensure we always have an array
    let newJobs = [];
    if (response) {
      console.log('[renderJobs] Response type:', typeof response, 'Is array:', Array.isArray(response));
      // New API format: response has jobs and pagination properties
      if (response.jobs && Array.isArray(response.jobs)) {
        newJobs = response.jobs;
        if (response.pagination) {
          jobsPagination = response.pagination;
        }
        console.log('[renderJobs] Using response.jobs, length:', newJobs.length);
      } else if (Array.isArray(response)) {
        // Old format: response is directly an array
        newJobs = response;
        console.log('[renderJobs] Using response as array, length:', newJobs.length);
      } else if (Array.isArray(response.data)) {
        // Alternative format: response.data is an array
        newJobs = response.data;
        console.log('[renderJobs] Using response.data, length:', newJobs.length);
      } else {
        console.warn('[renderJobs] Unexpected response format:', response);
      }
    } else {
      console.warn('[renderJobs] No response received');
    }
    
    console.log('[renderJobs] newJobs is array:', Array.isArray(newJobs), 'length:', newJobs.length);
    
    if (newJobs.length > 0) {
      console.log('[renderJobs] Sample job:', newJobs[0]);
    }
    
    const pagination = (response && response.pagination) || jobsPagination || { hasMore: false };
    
    // Ensure allLoadedJobs is always an array
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('[renderJobs] allLoadedJobs was not an array, resetting');
      allLoadedJobs = [];
    }
    
    // Ensure newJobs is an array before spreading
    if (!Array.isArray(newJobs)) {
      console.warn('[renderJobs] newJobs was not an array, resetting');
      newJobs = [];
    }
    
    // Append new jobs to existing list (deduplicate by ID)
    const existingIds = new Set(allLoadedJobs.map(j => j.id).filter(Boolean));
    const uniqueNewJobs = newJobs.filter(j => j && j.id && !existingIds.has(j.id));
    allLoadedJobs = [...allLoadedJobs, ...uniqueNewJobs];
    console.log('[renderJobs] allLoadedJobs after append, length:', allLoadedJobs.length, 'is array:', Array.isArray(allLoadedJobs), 'unique new jobs added:', uniqueNewJobs.length);
    jobsPagination = pagination;

    // Filter by status (client-side) - ensure filteredJobs is always an array
    // Double-check allLoadedJobs is an array before filtering
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('allLoadedJobs is not an array, resetting to empty array');
      allLoadedJobs = [];
    }
    
    // Browse Jobs only shows OPEN jobs that haven't expired
    // Be more lenient with status checking - accept both uppercase and lowercase
    let filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => {
      if (!j || !j.id) {
        console.warn('[renderJobs] Skipping invalid job:', j);
        return false; // Skip invalid jobs
      }
      
      // Filter out EXPIRED status jobs
      const status = (j.status || '').toUpperCase();
      if (status === "EXPIRED") return false;
      
      // Only show OPEN jobs (case-insensitive)
      if (status !== "OPEN") {
        // Log non-OPEN jobs for debugging (but don't show them)
        if (status && status !== 'SCHEDULED' && status !== 'ASSIGNED' && status !== 'IN_PROGRESS' && status !== 'PAID' && status !== 'COMPLETED') {
          console.log('[renderJobs] Filtering out job with status:', status, 'job ID:', j.id);
        }
        return false;
      }
      
      // Filter out expired jobs (check both expiresAt field and requirements.expiresAt)
      const now = new Date();
      if (j.expiresAt) {
        try {
        const expirationDate = new Date(j.expiresAt);
          if (!isNaN(expirationDate.getTime()) && expirationDate <= now) {
            console.log('[renderJobs] Filtering out expired job:', j.id, 'expired at:', j.expiresAt);
            return false; // Expired
          }
        } catch (e) {
          // Invalid date, continue
        }
      } else if (j.requirements?.expiresAt) {
        // Fallback to requirements.expiresAt for backward compatibility
        try {
          const expirationDate = new Date(j.requirements.expiresAt);
          if (!isNaN(expirationDate.getTime()) && expirationDate <= now) {
            console.log('[renderJobs] Filtering out expired job (from requirements):', j.id);
            return false; // Expired
          }
        } catch (e) {
          // Invalid date, continue
        }
      }
      
      // Don't filter out applied jobs - show them with "Applied" badge instead
      return true;
    }) : [];
    
    console.log('[renderJobs] Filtered jobs count:', filteredJobs.length, 'out of', allLoadedJobs.length, 'total loaded jobs');
    
    // Apply category filters
    if (activeCategoryFilters.size > 0) {
      filteredJobs = filteredJobs.filter((j) => {
        const jobCategory = (j.category || 'other').toLowerCase();
        return activeCategoryFilters.has(jobCategory);
      });
    }
    
    // Apply price type filters
    if (activePriceTypeFilters.size > 0) {
      filteredJobs = filteredJobs.filter((j) => {
        if (activePriceTypeFilters.has('flat') && j.payType === 'flat') return true;
        if (activePriceTypeFilters.has('hourly') && j.payType === 'hourly') return true;
        if (activePriceTypeFilters.has('hustler_sets')) {
          const pricingOption = j.requirements?.pricing_option;
          if (pricingOption === 'hustlers_quote' || pricingOption === 'hustler_sets') return true;
        }
        return false;
      });
    }
    
    // Apply workers filters
    if (activeWorkersFilters.size > 0) {
      filteredJobs = filteredJobs.filter((j) => {
        // Get teamSize and convert to number for comparison
        const rawTeamSize = j.teamSize || j.requirements?.teamSize || j.requirements?.team_size || 1;
        const teamSize = typeof rawTeamSize === 'string' ? parseInt(rawTeamSize, 10) : Number(rawTeamSize) || 1;
        const isCompany = j.requirements?.teamSize === 'company' || j.requirements?.team_size === 'company' || j.teamSize === 'company' || teamSize === 0;
        
        if (activeWorkersFilters.has('1') && teamSize === 1 && !isCompany) return true;
        if (activeWorkersFilters.has('2') && teamSize === 2 && !isCompany) return true;
        if (activeWorkersFilters.has('3') && teamSize >= 3 && !isCompany) return true;
        if (activeWorkersFilters.has('company') && isCompany) return true;
        return false;
      });
    }
    
    // Apply distance filter if location is set and filter is active (Step 3: Use approximate location)
    if (activeDistanceFilter && userLocation) {
      const maxDistance = activeDistanceFilter === 'statewide' ? Infinity : parseInt(activeDistanceFilter);
      filteredJobs = filteredJobs.filter((j) => {
        if (activeDistanceFilter === 'statewide') return true;
        
        // Use approximate location for distance calculation
        const jobLat = j.approximateLat !== null && j.approximateLat !== undefined 
          ? parseFloat(j.approximateLat) 
          : (j.lat ? parseFloat(j.lat) : null);
        const jobLng = j.approximateLng !== null && j.approximateLng !== undefined 
          ? parseFloat(j.approximateLng) 
          : (j.lng ? parseFloat(j.lng) : null);
        
        if (!jobLat || !jobLng) return false;
        
        // Calculate distance using Haversine formula
        const R = 3959; // Earth's radius in miles
        const dLat = (jobLat - userLocation.lat) * Math.PI / 180;
        const dLng = (jobLng - userLocation.lng) * Math.PI / 180;
        const a = 
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(userLocation.lat * Math.PI / 180) * Math.cos(jobLat * Math.PI / 180) *
          Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c;
        
        return distance <= maxDistance;
      });
    }
    
    // Apply sorting
    if (activeSortBy === 'newest') {
      filteredJobs.sort((a, b) => {
        const dateA = new Date(a.createdAt || a.created_at || 0);
        const dateB = new Date(b.createdAt || b.created_at || 0);
        return dateB - dateA; // Newest first
      });
    } else if (activeSortBy === 'highest_paid') {
      filteredJobs.sort((a, b) => {
        const amountA = Number(a.amount) || 0;
        const amountB = Number(b.amount) || 0;
        return amountB - amountA; // Highest first
      });
    } else if (activeSortBy === 'lowest_paid') {
      filteredJobs.sort((a, b) => {
        const amountA = Number(a.amount) || 0;
        const amountB = Number(b.amount) || 0;
        return amountA - amountB; // Lowest first
      });
    } else if (activeSortBy === 'closest' && userLocation) {
      filteredJobs.sort((a, b) => {
        // Use approximate location for sorting (Step 3)
        const aLat = a.approximateLat !== null && a.approximateLat !== undefined 
          ? parseFloat(a.approximateLat) 
          : (a.lat ? parseFloat(a.lat) : null);
        const aLng = a.approximateLng !== null && a.approximateLng !== undefined 
          ? parseFloat(a.approximateLng) 
          : (a.lng ? parseFloat(a.lng) : null);
        const bLat = b.approximateLat !== null && b.approximateLat !== undefined 
          ? parseFloat(b.approximateLat) 
          : (b.lat ? parseFloat(b.lat) : null);
        const bLng = b.approximateLng !== null && b.approximateLng !== undefined 
          ? parseFloat(b.approximateLng) 
          : (b.lng ? parseFloat(b.lng) : null);
        
        if (!aLat || !aLng) return 1;
        if (!bLat || !bLng) return -1;
        
        const R = 3959;
        const distA = (() => {
          const dLat = (aLat - userLocation.lat) * Math.PI / 180;
          const dLng = (aLng - userLocation.lng) * Math.PI / 180;
          const calc = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(userLocation.lat * Math.PI / 180) * Math.cos(aLat * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
          return R * 2 * Math.atan2(Math.sqrt(calc), Math.sqrt(1 - calc));
        })();
        const distB = (() => {
          const dLat = (bLat - userLocation.lat) * Math.PI / 180;
          const dLng = (bLng - userLocation.lng) * Math.PI / 180;
          const calc = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(userLocation.lat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) *
            Math.sin(dLng / 2) * Math.sin(dLng / 2);
          return R * 2 * Math.atan2(Math.sqrt(calc), Math.sqrt(1 - calc));
        })();
        return distA - distB;
      });
    } else if (activeSortBy === 'soonest') {
      filteredJobs.sort((a, b) => {
        const dateA = a.startTime ? new Date(a.startTime) : new Date(a.date || a.createdAt || 0);
        const dateB = b.startTime ? new Date(b.startTime) : new Date(b.date || b.createdAt || 0);
        return dateA - dateB; // Soonest first
      });
    }
    
    // Final safety check
    if (!Array.isArray(filteredJobs)) {
      console.warn('filteredJobs is not an array, resetting to empty array');
      filteredJobs = [];
    }

    // Get user role and ID for card title and "Your job" badge
    let role = null;
    let currentUserId = null;
    try {
      if (window.hustlAPI && window.hustlAPI.auth) {
        const user = await window.hustlAPI.auth.getCurrentUser();
        role = user?.roles?.[0] || null;
        currentUserId = user?.id || null;
      }
    } catch (e) {
      console.error("Error getting user role:", e);
    }
    
    // Update card title - always "Jobs near you"
    let cardTitle = "Jobs near you";
    if (jobsCardTitle) jobsCardTitle.textContent = cardTitle;

    // Update summary
    if (jobsFilterSummary) {
      jobsFilterSummary.textContent = filteredJobs.length === 0 
        ? "No jobs yet." 
        : `Showing ${filteredJobs.length} job(s)${pagination.total ? ` of ${pagination.total}` : ''}`;
    }
    
    // Update filter badge (if function exists)
    if (typeof window.updateFilterBadge === 'function') {
      window.updateFilterBadge();
    }

    if (filteredJobs.length === 0 && currentJobsPage === 1) {
      if (jobsList) {
        jobsList.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem 1.5rem; text-align: center; min-height: 300px;">
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">🔍</div>
            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: var(--text-main);">No jobs found</h3>
            <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted); max-width: 400px;">Try adjusting your filters or check back later for new opportunities.</p>
          </div>
        `;
        jobsList.classList.remove('has-content'); // Remove scrollbar when empty
      }
      return;
    }

    // Render each job card (only new ones if not resetting)
    filteredJobs.forEach((job) => {
      // Check if job card already exists
      if (!reset) {
        const existingCard = jobsList?.querySelector(`[data-job-id="${job.id}"]`);
        if (existingCard) return; // Skip if already rendered
      }

      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;
      // Set position relative for absolute positioning of price and countdown
      if (!card.style.position) {
        card.style.position = "relative";
      }

      // Category icon mapping
      const categoryIcons = {
        'moving': '🚚', 'yard-work': '🌿', 'dump-run': '🗑️', 'cleaning': '🧹',
        'power-washing': '💦', 'furniture-assembly': '🔧', 'painting': '🎨',
        'handyman': '🔨', 'landscaping': '🌳', 'pet-care': '🐕', 'delivery': '📦',
        'car-cleaning': '🚿', 'event-setup': '🎪', 'snow-removal': '❄️', 'other': '✨',
        'yard': '🌿', 'furniture': '🔧'
      };
      const categoryNames = {
        'moving': 'Moving', 'yard-work': 'Yard Work', 'dump-run': 'Dump Run',
        'cleaning': 'Cleaning', 'power-washing': 'Power Wash', 'furniture-assembly': 'Assembly',
        'painting': 'Painting', 'handyman': 'Handyman', 'landscaping': 'Landscaping',
        'pet-care': 'Pet Care', 'delivery': 'Delivery', 'car-cleaning': 'Car Clean',
        'event-setup': 'Event Setup', 'snow-removal': 'Snow Removal', 'other': 'Other',
        'yard': 'Yard Work', 'furniture': 'Assembly'
      };
      
      const jobCategory = (job.category || 'other').toLowerCase();
      const catIcon = categoryIcons[jobCategory] || '⭐';
      const catName = categoryNames[jobCategory] || job.category || 'Job';
      
      // Simplified job card structure
      const textContent = document.createElement("div");
      textContent.style.cssText = "flex: 1; min-width: 0;";
      
      // Check if this is the user's posted job
      const isUserJob = currentUserId && job.customerId === currentUserId;
      
      // Background colors: yellow for your jobs, subtle gray for others
      if (isUserJob) {
        card.style.background = "#fef3c7"; // Yellow background
        card.style.border = "2px solid #f59e0b"; // Yellow border
      } else {
        card.style.background = "#f8f9fa"; // Subtle gray background for viewed jobs
        card.style.border = "1px solid #e9ecef"; // Lighter border
      }

      // 1. Job title (larger and bolder)
      const titleEl = document.createElement("div");
      titleEl.className = "job-title";
      titleEl.style.cssText = "font-size: 1.1rem; font-weight: 700; line-height: 1.35; margin-bottom: 0.5rem; color: var(--text-main); padding-right: 5rem; word-wrap: break-word; overflow-wrap: break-word;";
      
      const titleText = document.createElement("span");
      titleText.textContent = job.title;
      titleEl.appendChild(titleText);
      textContent.appendChild(titleEl);

      // 2. Category (simplified - no time posted)
      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.style.cssText = "margin-bottom: 0.45rem; font-size: 0.9rem; color: var(--text-muted); font-weight: 500;";
      meta.textContent = `${catIcon} ${catName}`;
      textContent.appendChild(meta);
      
      // 3. Workers needed + Applicants count
      const teamSize = job.teamSize || job.requirements?.teamSize || job.requirements?.team_size || 1;
      const workersBadge = document.createElement("div");
      workersBadge.style.cssText = "margin-bottom: 0.45rem; font-size: 0.9rem; color: var(--text-muted); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;";
      
      // Workers needed
      const workersText = document.createElement("span");
      if (teamSize === 0 || teamSize === 'company') {
        workersText.textContent = "👥 Company/crew";
      } else if (teamSize > 1) {
        workersText.textContent = `👥 ${teamSize} workers`;
      } else {
        workersText.textContent = "👥 1 worker";
      }
      workersBadge.appendChild(workersText);
      
      // Applicants count
      const offersCount = job._count?.offers || job.offersCount || 0;
      if (offersCount > 0) {
        const applicantsText = document.createElement("span");
        applicantsText.style.cssText = "font-weight: 600; color: var(--primary);";
        applicantsText.textContent = `📋 ${offersCount} ${offersCount === 1 ? 'applicant' : 'applicants'}`;
        workersBadge.appendChild(applicantsText);
      }
      
        textContent.appendChild(workersBadge);
      
      // 4. Approximate location (no exact address)
      let distanceText = '';
      if (userLocation && userLocation.lat && userLocation.lng) {
        const jobLat = job.approximateLat !== null && job.approximateLat !== undefined 
          ? parseFloat(job.approximateLat) 
          : (job.lat ? parseFloat(job.lat) : null);
        const jobLng = job.approximateLng !== null && job.approximateLng !== undefined 
          ? parseFloat(job.approximateLng) 
          : (job.lng ? parseFloat(job.lng) : null);
        
        if (jobLat && jobLng && !isNaN(jobLat) && !isNaN(jobLng)) {
          const distance = calculateDistance(userLocation.lat, userLocation.lng, jobLat, jobLng);
          distanceText = `~${formatDistance(distance)}`;
        }
      }
      
        const loc = document.createElement("div");
        loc.className = "job-meta";
      loc.style.cssText = "margin-bottom: 0.45rem; font-size: 0.9rem; color: var(--text-muted);";
      if (distanceText) {
        loc.textContent = `📍 Approximate • ${distanceText} away`;
      } else {
        loc.textContent = `📍 Approximate location`;
      }
      textContent.appendChild(loc);
      
      // 5. Price (flat/hourly) - positioned in top right
      const requirements = job.requirements || {};
      const pricingOption = requirements.pricing_option;
      const pay = document.createElement("div");
      pay.className = "job-card-price";
      pay.style.cssText = "position: absolute; top: 0.75rem; right: 0.75rem; font-weight: 700; color: var(--success); font-size: 1.05rem; z-index: 10; line-height: 1.2;";
      
      if (pricingOption === "hustlers_quote") {
        pay.textContent = "💰 Quote";
        pay.style.color = "#f59e0b";
      } else if (job.payType === "flat") {
        const total = Number(job.amount) || 0;
        pay.textContent = `$${total.toFixed(0)}`;
      } else if (job.payType === "hourly") {
        const hr = Number(job.hourlyRate) || 0;
        pay.textContent = `$${hr.toFixed(0)}/hr`;
      } else {
        const total = Number(job.amount) || 0;
        pay.textContent = `$${total.toFixed(0)}`;
      }
      card.appendChild(pay);
      
      // 6. Applied badge - positioned below price
      const hasApplied = userAppliedJobIds && userAppliedJobIds.has(job.id);
      if (hasApplied) {
        const statusBadge = document.createElement("div");
        statusBadge.style.cssText = "position: absolute; top: 2.75rem; right: 0.75rem; font-weight: 700; font-size: 0.75rem; z-index: 10; padding: 0.25rem 0.5rem; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; background: #d1fae5; color: #065f46; border: 1px solid #10b981;";
        statusBadge.textContent = "✓ Applied";
        card.appendChild(statusBadge);
      }
      
      // Add textContent to card
      card.appendChild(textContent);

      // Customer info (profile pic + name) - simple and clean
      if (job.customer) {
        const customerInfo = document.createElement("div");
        customerInfo.style.cssText = "display: flex; align-items: center; gap: 0.6rem; margin-top: 0.6rem; padding-top: 0.6rem; border-top: 1px solid var(--border);";
        
        // Profile picture
        const profilePic = document.createElement("img");
        profilePic.style.cssText = "width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1.5px solid var(--border); flex-shrink: 0;";
        profilePic.src = job.customer.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(job.customer.name || "User") + "&background=6366f1&color=fff&size=128";
        profilePic.alt = job.customer.name || "Customer";
        profilePic.onerror = function() {
          this.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(job.customer.name || "User") + "&background=6366f1&color=fff&size=128";
        };
        
        // Customer name
        const customerName = document.createElement("span");
        customerName.style.cssText = "font-size: 0.9rem; color: var(--text-main); font-weight: 600;";
        customerName.textContent = job.customer.name || "Posted by customer";
        
        customerInfo.appendChild(profilePic);
        customerInfo.appendChild(customerName);
        textContent.appendChild(customerInfo);
      }

      // Actions row
      const actions = document.createElement("div");
      actions.className = "job-card-actions";

      const right = document.createElement("div");
      right.style.cssText = "display: flex; gap: 0.5rem; align-items: center;";
      
      const viewBtn = document.createElement("button");
      viewBtn.className = "small-btn outline";
      viewBtn.textContent = "View";
      viewBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        console.log("View button clicked, opening details for job:", job.id);
        if (typeof window.openJobDetails === 'function') {
          window.openJobDetails(job.id);
        } else if (typeof openJobDetails === 'function') {
        openJobDetails(job.id);
        } else {
          console.error("openJobDetails function not found!");
          showToast("Unable to open job details. Please refresh the page.");
        }
      });
      right.appendChild(viewBtn);
      actions.appendChild(right);

      card.appendChild(actions);

      // Clicking the whole card opens details
      card.addEventListener("click", () => {
        console.log("Job card clicked, opening details for job:", job.id);
        if (typeof window.openJobDetails === 'function') {
          window.openJobDetails(job.id);
        } else if (typeof openJobDetails === 'function') {
          openJobDetails(job.id);
        } else {
          console.error("openJobDetails function not found!");
          showToast("Unable to open job details. Please refresh the page.");
        }
      });

      if (jobsList) {
        jobsList.appendChild(card);
        jobsList.classList.add('has-content'); // Add scrollbar when there's content
      }
    });

    // Render on map if in map view - only render when map is ready
    if (currentJobsView === 'map') {
      if (jobsMap) {
        // Map exists, render jobs (will check if loaded inside function)
        await renderJobsOnMap(filteredJobs);
      } else {
        // Initialize map if not already done
        initJobsMap().then(async () => {
          if (jobsMap && filteredJobs.length > 0) {
            await renderJobsOnMap(filteredJobs);
          }
        });
      }
    }

    // Add "Load More" button if there are more pages
    const existingLoadMore = jobsList?.querySelector("#loadMoreJobsBtn");
    if (existingLoadMore) {
      existingLoadMore.remove();
    }

    // Show "Load More" if there are more pages OR if we have 20+ jobs loaded
    const shouldShowLoadMore = pagination.hasMore || (allLoadedJobs.length >= 20);
    
    if (shouldShowLoadMore && jobsList) {
      const loadMoreBtn = document.createElement("button");
      loadMoreBtn.id = "loadMoreJobsBtn";
      loadMoreBtn.className = "btn btn-primary";
      loadMoreBtn.style.width = "100%";
      loadMoreBtn.style.marginTop = "1rem";
      loadMoreBtn.style.padding = "1rem";
      loadMoreBtn.style.fontSize = "1rem";
      loadMoreBtn.style.fontWeight = "600";
      loadMoreBtn.textContent = `Load More Jobs (${allLoadedJobs.length} loaded)`;
      
      let isLoading = false;
      loadMoreBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (isLoading) return;
        isLoading = true;
        
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = "Loading...";
        currentJobsPage++;
        
        try {
          await renderJobs(false); // Don't reset, just append
          loadMoreBtn.textContent = `Load More Jobs (${allLoadedJobs.length} loaded)`;
        } catch (error) {
          console.error("Error loading more jobs:", error);
          showToast("Failed to load more jobs. Please try again.");
          loadMoreBtn.textContent = "Load More Jobs";
        } finally {
          loadMoreBtn.disabled = false;
          isLoading = false;
        }
      });
      jobsList.appendChild(loadMoreBtn);
    }
    
    // Update countdown timers after rendering
    setTimeout(() => {
      if (typeof updateCountdownTimers === 'function') {
        updateCountdownTimers();
      }
    }, 200);

  } catch (error) {
    console.error("Error loading jobs:", error);
    if (jobsList) {
      // Show a more helpful error message
      const errorMsg = error.message || "Unknown error";
      jobsList.innerHTML = `
        <div class='muted' style='padding: 2rem; text-align: center;'>
          <div style='margin-bottom: 1rem; font-size: 1.1rem;'>⚠️ Unable to load jobs</div>
          <div style='margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;'>${errorMsg}</div>
          <button id="retryJobsBtn" style='padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 600;' onclick="if(typeof renderJobs === 'function') renderJobs(true);">
            🔄 Try Again
          </button>
        </div>
      `;
    }
  }
}

    // Open job details modal - complete mobile-friendly view
    // Define at global scope
    window.openJobDetails = async function openJobDetails(jobId) {
      console.log("openJobDetails called with jobId:", jobId);
      
      // Get user's current location for the map (do this first, before try block)
      let currentUserLocation = null;
      if (typeof userLocation !== 'undefined' && userLocation && userLocation.lat && userLocation.lng) {
        currentUserLocation = userLocation;
      } else {
        // Try to get location from navigator if not already set
        try {
          if (navigator.geolocation) {
            await new Promise((resolve) => {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  currentUserLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                  };
                  resolve();
                },
                () => resolve(), // Fail silently if location unavailable
                { timeout: 5000, maximumAge: 60000 }
              );
            });
          }
        } catch (e) {
          console.log("Could not get user location:", e);
        }
      }
      
      try {
        // Fetch job details
        const token = localStorage.getItem("hustl_token");
        console.log("Fetching job details from:", `${API_BASE}/jobs/${jobId}`);
        const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        
        if (!response.ok) {
          console.error("Failed to fetch job details:", response.status);
          showToast("Unable to load job details. Please try again.");
          return;
        }
        
        const job = await response.json();
        console.log("Job details loaded:", job);
        console.log("Job requirements (raw):", JSON.stringify(job.requirements, null, 2));
        const requirements = job.requirements || {};
        
        // Handle requirements if it's a string (JSON.parse if needed)
        let parsedRequirements = requirements;
        if (typeof requirements === 'string') {
          try {
            parsedRequirements = JSON.parse(requirements);
          } catch (e) {
            console.warn("Could not parse requirements as JSON:", e);
            parsedRequirements = {};
          }
        }
        console.log("Parsed requirements:", parsedRequirements);
        
        // Get current user early (needed for timer extension button and price change UI)
        let user = null;
        let isOwner = false;
        let isHustler = false;
        let isCustomer = false;
        try {
          if (window.hustlAPI && window.hustlAPI.auth) {
            user = await window.hustlAPI.auth.getCurrentUser();
            if (user) {
              isOwner = job.customerId === user.id;
              // Check for hustler role in multiple ways
              isHustler = (user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'HUSTLER')) || 
                         (user.role && user.role.toUpperCase() === 'HUSTLER') ||
                         (user.isHustler === true);
              // Check for customer role
              isCustomer = job.customerId === user.id || 
                          (user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'CUSTOMER')) ||
                          (user.role && user.role.toUpperCase() === 'CUSTOMER');
            }
          }
        } catch (e) {
          console.warn("Error getting current user for timer:", e);
        }
        
        // Create modal overlay - full screen on mobile
        const modalOverlay = document.createElement("div");
        modalOverlay.id = "jobDetailModal";
        modalOverlay.className = "modal-overlay";
        modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: flex-start; justify-content: center; padding: 0; overflow-y: auto;";
        
        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";
        // Mobile: full screen positioned below blue header, Desktop: centered modal
        if (window.innerWidth <= 768) {
          // Position content below browser header (approximately 120px for status bar + browser UI)
          const headerOffset = 120;
          modalContent.style.cssText = `background: white; border-radius: 0; max-width: 100%; width: 100%; min-height: calc(100vh - ${headerOffset}px); overflow-y: auto; position: relative; margin: 0; margin-top: ${headerOffset}px; box-shadow: none;`;
        } else {
          modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 95vh; overflow-y: auto; position: relative; margin: 2rem auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
        }
        
        // Close button - positioned to align with header content (below blue header)
        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "×";
        if (window.innerWidth <= 768) {
          closeBtn.style.cssText = "position: absolute; top: 1.5rem; right: 1.25rem; width: 36px; height: 36px; border-radius: 50%; background: rgba(0, 0, 0, 0.6); border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; z-index: 10002; line-height: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: 300;";
        } else {
          closeBtn.style.cssText = "position: absolute; top: 0.75rem; right: 0.75rem; width: 36px; height: 36px; border-radius: 50%; background: rgba(0, 0, 0, 0.7); border: 2px solid white; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; z-index: 10001; line-height: 1; box-shadow: 0 2px 8px rgba(0,0,0,0.3);";
        }
        closeBtn.addEventListener("click", () => {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
          // Clear flags when closing
          window._viewingFromPostedTab = false;
          window._currentViewingOffer = null;
        });
        modalContent.appendChild(closeBtn); // Add to content so it's positioned relative to the modal
        
        // Create one box for all job details
        const jobDetailsBox = document.createElement("div");
        jobDetailsBox.style.cssText = "padding: 1rem; margin-bottom: 1rem; background: white; border-radius: 12px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);";
        
        // 1. JOB TITLE
        const header = document.createElement("div");
        header.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb;";
        
        const title = document.createElement("h1");
        title.style.cssText = "margin: 0; font-size: 1.35rem; font-weight: 700; color: var(--text-main); line-height: 1.3;";
        title.textContent = job.title || "Job Details";
        header.appendChild(title);
        jobDetailsBox.appendChild(header);
        
        // 2. CUSTOMER PROFILE (who posted) - at top
        if (job.customer) {
          const customerSection = document.createElement("div");
          customerSection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem;";
          
          const profilePic = document.createElement("img");
          profilePic.style.cssText = "width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); flex-shrink: 0; cursor: pointer;";
          profilePic.src = job.customer.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(job.customer.name || "User") + "&background=6366f1&color=fff&size=128";
          profilePic.alt = job.customer.name || "Customer";
          profilePic.onerror = function() {
            this.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(job.customer.name || "User") + "&background=6366f1&color=fff&size=128";
          };
          profilePic.addEventListener("click", () => {
            if (job.customer && job.customer.id) {
              window.showHustlerProfilePopup(job.customer.id);
            }
          });
          
          const customerInfo = document.createElement("div");
          customerInfo.style.cssText = "flex: 1; display: flex; align-items: center; justify-content: space-between; gap: 1rem;";
          
          const customerInfoLeft = document.createElement("div");
          customerInfoLeft.style.cssText = "flex: 1;";
          
          const customerLabel = document.createElement("div");
          customerLabel.style.cssText = "font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;";
          customerLabel.textContent = "Posted by";
          
          const customerName = document.createElement("div");
          customerName.style.cssText = "font-size: 1.1rem; color: var(--text-main); font-weight: 600; cursor: pointer;";
          customerName.textContent = job.customer.name || "Customer";
          customerName.addEventListener("click", () => {
            if (job.customer && job.customer.id) {
              window.showHustlerProfilePopup(job.customer.id);
            }
          });
          
          customerInfoLeft.appendChild(customerLabel);
          customerInfoLeft.appendChild(customerName);
          
          // View Profile button
          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "btn btn-secondary";
          viewProfileBtn.textContent = "View Profile";
          viewProfileBtn.style.cssText = "padding: 0.5rem 1rem; font-size: 0.9rem; white-space: nowrap; flex-shrink: 0;";
          viewProfileBtn.addEventListener("click", () => {
            if (job.customer && job.customer.id) {
              window.showHustlerProfilePopup(job.customer.id);
            }
          });
          
          customerInfo.appendChild(customerInfoLeft);
          customerInfo.appendChild(viewProfileBtn);
          
          customerSection.appendChild(profilePic);
          customerSection.appendChild(customerInfo);
          jobDetailsBox.appendChild(customerSection);
        }
        
        // 3. JOB CATEGORY
        const categoryIcons = {
          'moving': '🚚', 'yard-work': '🌿', 'dump-run': '🗑️', 'cleaning': '🧹',
          'power-washing': '💦', 'furniture-assembly': '🔧', 'painting': '🎨',
          'handyman': '🔨', 'landscaping': '🌳', 'pet-care': '🐕', 'delivery': '📦',
          'car-cleaning': '🚿', 'event-setup': '🎪', 'snow-removal': '❄️', 'other': '✨'
        };
        const categoryNames = {
          'moving': 'Moving', 'yard-work': 'Yard Work', 'dump-run': 'Dump Run',
          'cleaning': 'Cleaning', 'power-washing': 'Power Wash', 'furniture-assembly': 'Assembly',
          'painting': 'Painting', 'handyman': 'Handyman', 'landscaping': 'Landscaping',
          'pet-care': 'Pet Care', 'delivery': 'Delivery', 'car-cleaning': 'Car Clean',
          'event-setup': 'Event Setup', 'snow-removal': 'Snow Removal', 'other': 'Other'
        };
        const jobCategory = (job.category || 'other').toLowerCase();
        const catIcon = categoryIcons[jobCategory] || '⭐';
        const catName = categoryNames[jobCategory] || job.category || 'Job';
        
        const categorySection = document.createElement("div");
        categorySection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb;";
        
        const categoryLabel = document.createElement("div");
        categoryLabel.style.cssText = "font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;";
        categoryLabel.textContent = "Job Category";
        
        const category = document.createElement("div");
        category.style.cssText = "font-size: 0.95rem; color: var(--text-main); font-weight: 600;";
        category.textContent = `${catIcon} ${catName}`;
        
        categorySection.appendChild(categoryLabel);
        categorySection.appendChild(category);
        jobDetailsBox.appendChild(categorySection);
        
        // 4. DESCRIPTION
        const descriptionSection = document.createElement("div");
        descriptionSection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb;";
        
        const descTitle = document.createElement("h2");
        descTitle.style.cssText = "margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 700; color: var(--text-main);";
        descTitle.textContent = "Description";
        descriptionSection.appendChild(descTitle);
        
        const description = document.createElement("div");
        description.style.cssText = "font-size: 0.95rem; color: var(--text-main); line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;";
        description.textContent = job.description || "No description provided.";
        descriptionSection.appendChild(description);
        jobDetailsBox.appendChild(descriptionSection);
        
        // 5. PRICING - Hourly Pay Breakdown
        const pricingSection = document.createElement("div");
        pricingSection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; background: #f8f9fa; padding: 0.75rem; border-radius: 8px;";
        
        const pricingTitle = document.createElement("h2");
        pricingTitle.style.cssText = "margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700; color: var(--text-main);";
        pricingTitle.textContent = "💰 Pricing";
        pricingSection.appendChild(pricingTitle);
        
        const pricingOption = requirements.pricing_option;
        const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
        
        if (pricingOption === "hustlers_quote") {
          const quoteText = document.createElement("div");
          quoteText.style.cssText = "font-size: 1rem; color: #f59e0b; font-weight: 600;";
          quoteText.textContent = "Hustler suggests price";
          pricingSection.appendChild(quoteText);
        } else if (job.payType === "hourly") {
          const hourlyRate = Number(job.hourlyRate) || 0;
          const maxHours = Number(job.estHours) || Number(requirements.maxHours) || 0;
          const maxTotal = hourlyRate * maxHours;
          
          const breakdown = document.createElement("div");
          breakdown.style.cssText = "display: flex; flex-direction: column; gap: 0.75rem;";
          
          // Main pricing display - clear and prominent
          const mainPriceRow = document.createElement("div");
          mainPriceRow.style.cssText = "padding: 0.625rem; background: white; border-radius: 6px; border: 2px solid var(--success);";
          const mainPriceLabel = document.createElement("div");
          mainPriceLabel.style.cssText = "font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 600;";
          mainPriceLabel.textContent = "PAY RATE";
          const mainPriceValue = document.createElement("div");
          mainPriceValue.style.cssText = "font-size: 1.25rem; font-weight: 700; color: var(--success); line-height: 1.2; margin-bottom: 0.375rem;";
          if (maxHours > 0) {
            mainPriceValue.textContent = `$${hourlyRate.toFixed(0)}/hr (maximum ${maxHours} hours = $${maxTotal.toFixed(0)} total)`;
          } else {
            mainPriceValue.textContent = `$${hourlyRate.toFixed(0)}/hr`;
          }
          const maxNote = document.createElement("div");
          maxNote.style.cssText = "font-size: 0.75rem; color: var(--text-muted); font-style: italic; line-height: 1.2;";
          maxNote.textContent = "Note: This is the maximum you're willing to pay. You may only pay for actual hours worked (up to this maximum).";
          mainPriceRow.appendChild(mainPriceLabel);
          mainPriceRow.appendChild(mainPriceValue);
          mainPriceRow.appendChild(maxNote);
          breakdown.appendChild(mainPriceRow);
          
          // Total per person per hour
          if (teamSize > 0 && teamSize !== 'company') {
            const perPersonRate = hourlyRate / teamSize;
            const perPersonRow = document.createElement("div");
            perPersonRow.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;";
            const perPersonLabel = document.createElement("span");
            perPersonLabel.style.cssText = "font-size: 0.9rem; color: var(--text-muted);";
            perPersonLabel.textContent = "Per person per hour:";
            const perPersonValue = document.createElement("span");
            perPersonValue.style.cssText = "font-size: 0.95rem; font-weight: 600; color: var(--text-main);";
            perPersonValue.textContent = `$${perPersonRate.toFixed(0)}/hr`;
            perPersonRow.appendChild(perPersonLabel);
            perPersonRow.appendChild(perPersonValue);
            breakdown.appendChild(perPersonRow);
          }
          
          const workersRow = document.createElement("div");
          workersRow.style.cssText = "display: flex; justify-content: space-between; align-items: center;";
          const workersLabel = document.createElement("span");
          workersLabel.style.cssText = "font-size: 0.95rem; color: var(--text-main);";
          workersLabel.textContent = "Workers needed:";
          const workersValue = document.createElement("span");
          workersValue.style.cssText = "font-size: 0.95rem; font-weight: 600; color: var(--text-main);";
          if (teamSize === 0 || teamSize === 'company') {
            workersValue.textContent = "Company/crew";
          } else {
            workersValue.textContent = `${teamSize}`;
          }
          workersRow.appendChild(workersLabel);
          workersRow.appendChild(workersValue);
          breakdown.appendChild(workersRow);
          
          pricingSection.appendChild(breakdown);
        } else {
          // Flat rate
          const total = Number(job.amount) || 0;
          const flatRate = document.createElement("div");
          flatRate.style.cssText = "display: flex; flex-direction: column; gap: 0.75rem;";
          
          // Main pricing display - clear and prominent
          const mainPriceRow = document.createElement("div");
          mainPriceRow.style.cssText = "padding: 0.625rem; background: white; border-radius: 6px; border: 2px solid var(--success);";
          const mainPriceLabel = document.createElement("div");
          mainPriceLabel.style.cssText = "font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 600;";
          mainPriceLabel.textContent = "PAY RATE";
          const mainPriceValue = document.createElement("div");
          mainPriceValue.style.cssText = "font-size: 1.25rem; font-weight: 700; color: var(--success); line-height: 1.2;";
          mainPriceValue.textContent = `$${total.toFixed(0)} total (flat rate)`;
          mainPriceRow.appendChild(mainPriceLabel);
          mainPriceRow.appendChild(mainPriceValue);
          flatRate.appendChild(mainPriceRow);
          
          const workersRow = document.createElement("div");
          workersRow.style.cssText = "display: flex; justify-content: space-between; align-items: center;";
          const workersLabel = document.createElement("span");
          workersLabel.style.cssText = "font-size: 0.95rem; color: var(--text-main);";
          workersLabel.textContent = "Workers needed:";
          const workersValue = document.createElement("span");
          workersValue.style.cssText = "font-size: 0.95rem; font-weight: 600; color: var(--text-main);";
          if (teamSize === 0 || teamSize === 'company') {
            workersValue.textContent = "Company/crew";
          } else {
            workersValue.textContent = `${teamSize}`;
          }
          workersRow.appendChild(workersLabel);
          workersRow.appendChild(workersValue);
          flatRate.appendChild(workersRow);
          
          pricingSection.appendChild(flatRate);
        }
        
        jobDetailsBox.appendChild(pricingSection);
        
        // 5.5. HOURLY JOB TIMER & EXTENSION (for hourly jobs in progress)
        // Check status in multiple formats (IN_PROGRESS, in_progress, etc.)
        console.log('[TIMER DEBUG] Job check - payType:', job.payType, 'status:', job.status, 'startCodeVerified:', job.startCodeVerified, 'hasStartedAt:', !!parsedRequirements.startedAt);
        const isInProgress = (job.status === 'IN_PROGRESS' || job.status === 'in_progress' || (job.status && job.status.toUpperCase() === 'IN_PROGRESS'));
        const shouldShowTimer = job.payType === 'hourly' && isInProgress && job.startCodeVerified;
        console.log('[TIMER DEBUG] shouldShowTimer:', shouldShowTimer, 'isInProgress:', isInProgress);
        
        if (shouldShowTimer) {
          console.log('[TIMER] Showing timer for hourly job:', job.id, 'status:', job.status, 'startCodeVerified:', job.startCodeVerified);
          const timerSection = document.createElement("div");
          timerSection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb; background: #fef3c7; padding: 1rem; border-radius: 8px; border: 2px solid #fbbf24;";
          
          const timerTitle = document.createElement("h2");
          timerTitle.style.cssText = "margin: 0 0 0.5rem 0; font-size: 0.95rem; font-weight: 700; color: #92400e;";
          timerTitle.textContent = "⏱️ Job Timer";
          timerSection.appendChild(timerTitle);
          
          // Show extension indicator (how many hours have been added) - right after title
          const extensionIndicator = document.createElement("div");
          extensionIndicator.id = `extensionIndicator-${job.id}`;
          extensionIndicator.style.cssText = "font-size: 0.8rem; color: #059669; font-weight: 600; margin-bottom: 0.75rem; padding: 0.375rem 0.625rem; background: #d1fae5; border-radius: 6px; border: 1px solid #10b981; display: none;";
          
          // Check if extensions exist
          const extensionPaymentIntents = parsedRequirements.extensionPaymentIntents || [];
          const totalHoursAdded = extensionPaymentIntents.reduce((sum, ext) => sum + (Number(ext.hours) || 0), 0);
          if (totalHoursAdded > 0) {
            extensionIndicator.textContent = totalHoursAdded === 1 
              ? `✅ Added 1 hour` 
              : `✅ Added ${totalHoursAdded} hours`;
            extensionIndicator.style.display = 'block';
          }
          timerSection.appendChild(extensionIndicator);
          
          // Get startedAt from requirements
          const startedAtStr = parsedRequirements.startedAt;
          console.log('[TIMER] startedAtStr:', startedAtStr, 'parsedRequirements:', parsedRequirements);
          if (startedAtStr) {
            const timerDisplay = document.createElement("div");
            timerDisplay.id = `jobTimer-${job.id}`;
            timerDisplay.style.cssText = "font-size: 1.5rem; font-weight: 700; color: #92400e; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;";
            
            const updateTimer = () => {
              const startedAt = new Date(startedAtStr);
              const now = new Date();
              const elapsedMs = now.getTime() - startedAt.getTime();
              const hours = Math.floor(elapsedMs / (1000 * 60 * 60));
              const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
              const seconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
              
              let timerText = '';
              if (hours > 0) {
                timerText = `${hours}h ${minutes}m ${seconds}s`;
              } else if (minutes > 0) {
                timerText = `${minutes}m ${seconds}s`;
              } else {
                timerText = `${seconds}s`;
              }
              
              timerDisplay.textContent = timerText;
              
              // Check if approaching max hours (show extension option)
              const currentHours = elapsedMs / (1000 * 60 * 60);
              const maxHours = job.estHours || 0;
              const hoursRemaining = maxHours - currentHours;
              const minutesRemaining = hoursRemaining * 60;
              
              console.log('[TIMER] Extension check - currentHours:', currentHours.toFixed(2), 'maxHours:', maxHours, 'minutesRemaining:', minutesRemaining.toFixed(1), 'isOwner:', isOwner);
              
              // Show extension button if within 30 minutes of max OR even after max reached (within 6 minutes)
              // Allow extension even closer to/at the end of the job
              const buttonExists = !!document.getElementById(`extendHoursBtn-${job.id}`);
              const shouldShowExtension = (minutesRemaining <= 30 && minutesRemaining > -6) && isOwner;
              const canExtend = shouldShowExtension && !buttonExists;
              console.log('[TIMER] canExtend:', canExtend, 'button exists:', buttonExists, 'shouldShowExtension:', shouldShowExtension);
              if (canExtend) {
                console.log('[TIMER] Showing extension button');
                const hourlyRate = Number(job.hourlyRate) || 0;
                
                // Remove any existing warnings/errors first
                const existingWarning = document.getElementById(`timerWarning-${job.id}`);
                if (existingWarning) existingWarning.remove();
                const existingError = document.getElementById(`timerError-${job.id}`);
                if (existingError) existingError.remove();
                
                // Show warning message
                const warning = document.createElement("div");
                warning.id = `timerWarning-${job.id}`;
                warning.style.cssText = "font-size: 0.9rem; color: #dc2626; font-weight: 700; margin-top: 0.75rem; margin-bottom: 0.75rem; padding: 0.75rem; background: #fee2e2; border-radius: 6px; border: 2px solid #dc2626;";
                let warningText = '';
                if (minutesRemaining > 0) {
                  const minsLeft = Math.ceil(minutesRemaining);
                  warningText = `⚠️ <strong>You have ${minsLeft} minute${minsLeft === 1 ? '' : 's'} left!</strong><br>Add more hours to continue. You will be charged for the full hour.`;
                } else {
                  const minsOver = Math.ceil(Math.abs(minutesRemaining));
                  warningText = `⚠️ <strong>Max hours reached (${minsOver} minute${minsOver === 1 ? '' : 's'} over)!</strong><br>Add more hours immediately to continue. You will be charged for the full hour.`;
                }
                warning.innerHTML = warningText;
                timerSection.appendChild(warning);
                
                const extendBtn = document.createElement("button");
                extendBtn.id = `extendHoursBtn-${job.id}`;
                extendBtn.className = "btn btn-primary";
                extendBtn.textContent = `Extend by 1 hour (+$${hourlyRate.toFixed(0)})`;
                extendBtn.style.cssText = "width: 100%; padding: 0.875rem; font-weight: 700; margin-top: 0.5rem; background: #f59e0b; border: none; border-radius: 8px; font-size: 1rem; color: white; cursor: pointer;";
                extendBtn.addEventListener("click", async (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  if (confirm(`Extend job by 1 hour? This will authorize an additional $${hourlyRate.toFixed(2)}. You will be charged for the full hour even if you finish early.`)) {
                    extendBtn.disabled = true;
                    extendBtn.textContent = "Processing...";
                    try {
                      const token = localStorage.getItem("hustl_token");
                      const response = await fetch(`${API_BASE}/verification/job/${job.id}/extend-hours`, {
                        method: 'POST',
                        headers: {
                          'Authorization': `Bearer ${token}`,
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ hours: 1 })
                      });
                      
                      if (response.ok) {
                        const data = await response.json();
                        // Update job.estHours in current scope
                        job.estHours = data.newMaxHours;
                        
                        // Update parsedRequirements to include new extension
                        if (!parsedRequirements.extensionPaymentIntents) {
                          parsedRequirements.extensionPaymentIntents = [];
                        }
                        parsedRequirements.extensionPaymentIntents.push({
                          hours: 1,
                          paymentIntentId: data.paymentIntentId,
                          createdAt: new Date().toISOString()
                        });
                        
                        // Update max hours display
                        if (maxHoursInfo) {
                          maxHoursInfo.textContent = `Max hours: ${data.newMaxHours} hours`;
                        }
                        
                        // Update extension indicator
                        const extensionIndicator = document.getElementById(`extensionIndicator-${job.id}`);
                        if (extensionIndicator) {
                          const totalHoursAdded = parsedRequirements.extensionPaymentIntents.reduce((sum, ext) => sum + (Number(ext.hours) || 0), 0);
                          if (totalHoursAdded === 1) {
                            extensionIndicator.textContent = `✅ Added 1 hour`;
                          } else {
                            extensionIndicator.textContent = `✅ Added ${totalHoursAdded} hours`;
                          }
                          extensionIndicator.style.display = 'block';
                        }
                        
                        // Calculate new time remaining
                        const newMaxHours = data.newMaxHours;
                        const newHoursRemaining = newMaxHours - currentHours;
                        const newMinutesRemaining = newHoursRemaining * 60;
                        const newHours = Math.floor(newMinutesRemaining / 60);
                        const newMins = Math.floor(newMinutesRemaining % 60);
                        
                        // Show success message with new time
                        let successMsg = `✅ Hours extended! You now have `;
                        if (newHours > 0) {
                          successMsg += `${newHours} hour${newHours === 1 ? '' : 's'}`;
                          if (newMins > 0) {
                            successMsg += ` and ${newMins} minute${newMins === 1 ? '' : 's'}`;
                          }
                        } else {
                          successMsg += `${newMins} minute${newMins === 1 ? '' : 's'}`;
                        }
                        successMsg += ` remaining.`;
                        showToast(successMsg);
                        
                        // Remove button and warning
                        extendBtn.remove();
                        if (warning) warning.remove();
                      } else {
                        const error = await response.json();
                        showToast(error.error || "Failed to extend hours");
                        extendBtn.disabled = false;
                        extendBtn.textContent = `Extend by 1 hour (+$${hourlyRate.toFixed(0)})`;
                      }
                    } catch (error) {
                      console.error("Error extending hours:", error);
                      showToast("Failed to extend hours. Please try again.");
                      extendBtn.disabled = false;
                      extendBtn.textContent = `Extend by 1 hour (+$${hourlyRate.toFixed(0)})`;
                    }
                  }
                });
                timerSection.appendChild(extendBtn);
              }
              
              // Show error if max hours exceeded significantly (more than 6 minutes past)
              // Only show if extension button isn't already showing
              if (hoursRemaining < -0.1 && !document.getElementById(`extendHoursBtn-${job.id}`)) {
                const errorMsg = document.createElement("div");
                errorMsg.id = `timerError-${job.id}`;
                errorMsg.style.cssText = "font-size: 0.85rem; color: #dc2626; font-weight: 700; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 6px; border: 2px solid #dc2626;";
                errorMsg.textContent = `❌ Max hours exceeded! Job must be completed or hours extended immediately.`;
                if (!document.getElementById(`timerError-${job.id}`)) {
                  timerSection.appendChild(errorMsg);
                }
              }
            };
            
            // Show max hours info
            const maxHoursInfo = document.createElement("div");
            maxHoursInfo.style.cssText = "font-size: 0.85rem; color: #92400e; margin-top: 0.5rem;";
            maxHoursInfo.textContent = `Max hours: ${job.estHours || 0} hours`;
            timerSection.appendChild(maxHoursInfo);
            
            // Show informational message about extending hours (calculate once outside updateTimer)
            const startedAt = new Date(startedAtStr);
            const now = new Date();
            const elapsedMs = now.getTime() - startedAt.getTime();
            const currentHours = elapsedMs / (1000 * 60 * 60);
            const maxHours = job.estHours || 0;
            const hoursRemaining = maxHours - currentHours;
            const minutesRemaining = hoursRemaining * 60;
            
            // Show info message for both customers and hustlers
            if (minutesRemaining > 30) {
              const infoMsg = document.createElement("div");
              infoMsg.id = `timerInfo-${job.id}`;
              infoMsg.style.cssText = "font-size: 0.8rem; color: #78350f; margin-top: 0.75rem; padding: 0.625rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24; line-height: 1.4;";
              if (isOwner) {
                infoMsg.innerHTML = `ℹ️ <strong>Tip:</strong> You can add more hours within the last 30 minutes if needed.`;
              } else {
                infoMsg.innerHTML = `ℹ️ <strong>Tip:</strong> The customer can add more hours within the last 30 minutes if needed.`;
              }
              timerSection.appendChild(infoMsg);
            }
            
            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);
            
            // Clear interval when modal closes
            modalOverlay.addEventListener('click', (e) => {
              if (e.target === modalOverlay) {
                clearInterval(timerInterval);
              }
            });
            closeBtn.addEventListener('click', () => {
              clearInterval(timerInterval);
            });
            
            timerSection.appendChild(timerDisplay);
          }
          
          jobDetailsBox.appendChild(timerSection);
        }
        
        // 6. TOOLS/EQUIPMENT NEEDED (always show, even if empty)
        const toolsSection = document.createElement("div");
        toolsSection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb;";
        
        const toolsTitle = document.createElement("h2");
        toolsTitle.style.cssText = "margin: 0 0 0.375rem 0; font-size: 0.95rem; font-weight: 700; color: var(--text-main);";
        toolsTitle.textContent = "🔧 Tools / Equipment Needed";
        toolsSection.appendChild(toolsTitle);
        
        // Check both camelCase and snake_case field names - try multiple paths
        let equipmentNeeded = parsedRequirements.equipmentNeeded || parsedRequirements.equipment_needed || [];
        let customEquipment = parsedRequirements.customEquipment || parsedRequirements.custom_equipment || '';
        
        // Also check if it's stored directly in requirements object (fallback)
        if (!equipmentNeeded || (Array.isArray(equipmentNeeded) && equipmentNeeded.length === 0)) {
          equipmentNeeded = requirements.equipmentNeeded || requirements.equipment_needed || [];
        }
        if (!customEquipment || !customEquipment.trim()) {
          customEquipment = requirements.customEquipment || requirements.custom_equipment || '';
        }
        
        // Also check the raw job.requirements if it's different
        if ((!equipmentNeeded || (Array.isArray(equipmentNeeded) && equipmentNeeded.length === 0)) && job.requirements) {
          const rawReq = typeof job.requirements === 'string' ? JSON.parse(job.requirements) : job.requirements;
          equipmentNeeded = rawReq.equipmentNeeded || rawReq.equipment_needed || equipmentNeeded || [];
          customEquipment = rawReq.customEquipment || rawReq.custom_equipment || customEquipment || '';
        }
        
        console.log("[EQUIPMENT DEBUG] Equipment needed found:", equipmentNeeded, "Type:", typeof equipmentNeeded);
        console.log("[EQUIPMENT DEBUG] Custom equipment found:", customEquipment);
        console.log("[EQUIPMENT DEBUG] Full parsedRequirements:", JSON.stringify(parsedRequirements, null, 2));
        console.log("[EQUIPMENT DEBUG] Raw job.requirements:", JSON.stringify(job.requirements, null, 2));
        
        // Ensure equipmentNeeded is an array
        let equipmentArray = [];
        if (Array.isArray(equipmentNeeded)) {
          equipmentArray = equipmentNeeded;
        } else if (equipmentNeeded && typeof equipmentNeeded === 'string') {
          // Try to parse if it's a JSON string
          try {
            const parsed = JSON.parse(equipmentNeeded);
            equipmentArray = Array.isArray(parsed) ? parsed : [parsed];
          } catch (e) {
            equipmentArray = [equipmentNeeded];
          }
        } else if (equipmentNeeded) {
          equipmentArray = [equipmentNeeded];
        }
        
        // Filter out empty/null values
        equipmentArray = equipmentArray.filter(tool => tool && String(tool).trim());
        
        console.log("Final equipment array:", equipmentArray);
        
        if (equipmentArray.length > 0) {
          const toolsList = document.createElement("div");
          toolsList.style.cssText = "display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;";
          equipmentArray.forEach(tool => {
            const toolStr = String(tool).trim();
            if (toolStr) {
              const toolChip = document.createElement("span");
              toolChip.style.cssText = "padding: 0.5rem 0.75rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem; color: var(--text-main); font-weight: 500;";
              toolChip.textContent = toolStr;
              toolsList.appendChild(toolChip);
            }
          });
          if (toolsList.children.length > 0) {
            toolsSection.appendChild(toolsList);
          }
        }
        
        if (customEquipment && String(customEquipment).trim()) {
          const customTool = document.createElement("div");
          customTool.style.cssText = "font-size: 0.95rem; color: var(--text-main); line-height: 1.5; margin-bottom: 0.75rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px;";
          customTool.textContent = String(customEquipment).trim();
          toolsSection.appendChild(customTool);
        }
        
        // Show "no tools" message only if both are empty
        const hasEquipment = equipmentArray.length > 0 || (customEquipment && String(customEquipment).trim());
        if (!hasEquipment) {
          const noTools = document.createElement("div");
          noTools.style.cssText = "font-size: 0.95rem; color: var(--text-muted); font-style: italic;";
          noTools.textContent = "No specific tools or equipment required.";
          toolsSection.appendChild(noTools);
        }
        
        jobDetailsBox.appendChild(toolsSection);
        
        // 7. LOCATION MAP
        const locationSection = document.createElement("div");
        locationSection.style.cssText = "margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e5e7eb;";
        
        const locTitle = document.createElement("h2");
        locTitle.style.cssText = "margin: 0 0 0.375rem 0; font-size: 0.95rem; font-weight: 700; color: var(--text-main);";
        locTitle.textContent = "📍 Location";
        locationSection.appendChild(locTitle);
        
        const locNote = document.createElement("div");
        locNote.style.cssText = "font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; padding: 0.375rem; background: #f3f4f6; border-radius: 6px; line-height: 1.3;";
        locNote.textContent = "This is an approximate location. Exact address will be shared after you're accepted.";
        locationSection.appendChild(locNote);
        
        // Map container
        const mapContainer = document.createElement("div");
        mapContainer.id = `jobDetailMap-${job.id}`;
        mapContainer.style.cssText = "width: 100%; height: 140px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;";
        locationSection.appendChild(mapContainer);
        
        // Zoom Out button
        const zoomOutBtn = document.createElement("button");
        zoomOutBtn.textContent = "Zoom Out";
        zoomOutBtn.style.cssText = "margin-top: 0.5rem; padding: 0.5rem 1rem; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; font-weight: 500; color: var(--text-main); cursor: pointer; transition: all 0.2s; width: 100%;";
        zoomOutBtn.addEventListener("mouseenter", () => {
          zoomOutBtn.style.background = "#e5e7eb";
        });
        zoomOutBtn.addEventListener("mouseleave", () => {
          zoomOutBtn.style.background = "#f3f4f6";
        });
        zoomOutBtn.addEventListener("click", () => {
          // Find the map instance and zoom out to show both user and job locations
          const mapElement = document.getElementById(`jobDetailMap-${job.id}`);
          if (mapElement && mapElement._mapboxglMap) {
            const map = mapElement._mapboxglMap;
            
            // Get job location from stored reference
            const jobLoc = mapElement._jobLocation;
            const userLoc = mapElement._userLocation;
            
            // If both locations are available, fit bounds to show both
            if (jobLoc && jobLoc.lat && jobLoc.lng && !isNaN(jobLoc.lat) && !isNaN(jobLoc.lng) &&
                userLoc && userLoc.lat && userLoc.lng && !isNaN(userLoc.lat) && !isNaN(userLoc.lng)) {
              // Calculate bounds to include both points
              const bounds = [
                [Math.min(jobLoc.lng, userLoc.lng), Math.min(jobLoc.lat, userLoc.lat)], // Southwest
                [Math.max(jobLoc.lng, userLoc.lng), Math.max(jobLoc.lat, userLoc.lat)]  // Northeast
              ];
              
              map.fitBounds(bounds, {
                padding: { top: 50, bottom: 50, left: 50, right: 50 },
                maxZoom: 14,
                duration: 1000
              });
            } else if (jobLoc && jobLoc.lat && jobLoc.lng && !isNaN(jobLoc.lat) && !isNaN(jobLoc.lng)) {
              // If only job location, just zoom out
              const currentZoom = map.getZoom();
              map.zoomTo(Math.max(10, currentZoom - 2), { duration: 500 });
            }
          }
        });
        locationSection.appendChild(zoomOutBtn);
        
        jobDetailsBox.appendChild(locationSection);
        
        // 8. EXTRA NOTES
        if (requirements.notes) {
          const notesSection = document.createElement("div");
          notesSection.style.cssText = "margin-bottom: 0; padding-bottom: 0;";
          
          const notesTitle = document.createElement("h2");
          notesTitle.style.cssText = "margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 700; color: var(--text-main);";
          notesTitle.textContent = "📝 Extra Notes";
          notesSection.appendChild(notesTitle);
          
          const notes = document.createElement("div");
          notes.style.cssText = "font-size: 0.95rem; color: var(--text-main); line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;";
          notes.textContent = requirements.notes;
          notesSection.appendChild(notes);
          jobDetailsBox.appendChild(notesSection);
        }
        
        // Add the job details box to modal
        modalContent.appendChild(jobDetailsBox);
        
        // 8.5. PRICE CHANGE PROPOSAL UI (for hustler to accept/decline when job is scheduled/assigned)
        // Note: requirements and parsedRequirements are already declared above
        const proposedPriceChangeHustler = parsedRequirements?.proposedPriceChange;
        console.log('[PRICE CHANGE] Checking conditions:', {
          isHustler,
          hustlerId: job.hustlerId,
          userId: user?.id,
          status: job.status,
          startCodeVerified: job.startCodeVerified,
          proposedPriceChange: proposedPriceChangeHustler,
          statusCheck: proposedPriceChangeHustler?.status
        });
        // Show price change proposal to CUSTOMER (hustler proposed, customer needs to accept/decline)
        if (isCustomer && job.customerId === user?.id && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified && proposedPriceChangeHustler && proposedPriceChangeHustler.status === 'PENDING') {
          console.log('[PRICE CHANGE] Showing price change proposal to customer');
          const priceChangeSectionCustomer = document.createElement("div");
          priceChangeSectionCustomer.style.cssText = "margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;";
          
          const currentPrice = job.payType === 'hourly' 
            ? (Number(job.hourlyRate || 0) * Number(job.estHours || 0))
            : Number(job.amount || 0);
          
          let proposedPriceText = '';
          let newPrice = currentPrice;
          if (job.payType === 'hourly') {
            const newRate = proposedPriceChangeHustler.hourlyRate !== null ? proposedPriceChangeHustler.hourlyRate : job.hourlyRate;
            const newHours = proposedPriceChangeHustler.estHours !== null ? proposedPriceChangeHustler.estHours : job.estHours;
            newPrice = newRate * newHours;
            proposedPriceText = `$${newRate.toFixed(2)}/hr × ${newHours} hours = $${newPrice.toFixed(2)}`;
          } else {
            newPrice = proposedPriceChangeHustler.amount !== null ? proposedPriceChangeHustler.amount : job.amount;
            proposedPriceText = `$${newPrice.toFixed(2)}`;
          }
          
          const priceDifference = newPrice - currentPrice;
          const priceDifferenceText = priceDifference > 0 
            ? `+$${priceDifference.toFixed(2)} (you'll pay more)`
            : priceDifference < 0 
            ? `$${Math.abs(priceDifference).toFixed(2)} (you'll be refunded)`
            : 'No change';
          
          priceChangeSectionCustomer.innerHTML = `
            <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 0.75rem; font-weight: 700;">💰 Price Change Proposal from Hustler</div>
            <div style="font-size: 0.8rem; color: #1e3a8a; margin-bottom: 0.75rem; padding: 0.625rem; background: #eff6ff; border-radius: 6px; border: 1px solid #93c5fd;">
              <strong>What happens next:</strong> If you accept, payment will be updated automatically. If you decline, the job continues at the original price. You can also unassign the hustler if you disagree.
            </div>
            <div style="margin-bottom: 0.75rem;">
              <div style="font-size: 0.85rem; color: #1e3a8a; margin-bottom: 0.25rem;">Current Price:</div>
              <div style="font-size: 1.25rem; font-weight: 700; color: #1e3a8a;">$${currentPrice.toFixed(2)}</div>
            </div>
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid #3b82f6;">
              <div style="font-size: 0.85rem; color: #1e40af; margin-bottom: 0.25rem; font-weight: 600;">Proposed New Price:</div>
              <div style="font-size: 1.5rem; font-weight: 700; color: #1e3a8a;">${proposedPriceText}</div>
              <div style="font-size: 0.8rem; color: ${priceDifference > 0 ? '#dc2626' : priceDifference < 0 ? '#10b981' : '#6b7280'}; margin-top: 0.5rem;">
                ${priceDifferenceText}
              </div>
            </div>
            <div style="display: flex; gap: 0.75rem;">
              <button id="acceptPriceChangeBtn-${job.id}" class="btn btn-primary" style="flex: 1; padding: 0.875rem; font-weight: 700; background: #10b981; border: none; border-radius: 8px; color: white; cursor: pointer;">
                ✓ Accept ${priceDifference > 0 ? '& Pay Difference' : priceDifference < 0 ? '& Get Refund' : ''}
              </button>
              <button id="declinePriceChangeBtn-${job.id}" class="btn btn-ghost" style="flex: 1; padding: 0.875rem; font-weight: 700; background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; color: #dc2626; cursor: pointer;">
                ✗ Decline
              </button>
            </div>
            <div style="font-size: 0.75rem; color: #1e40af; margin-top: 0.75rem; text-align: center;">
              ${priceDifference > 0 ? `⚠️ Accepting will require payment authorization for the difference.` : priceDifference < 0 ? `✅ Accepting will automatically refund you the difference.` : `No price change.`}
            </div>
          `;
          
          modalContent.appendChild(priceChangeSectionCustomer);
          
          // Attach event handlers immediately after appending (buttons are in innerHTML)
          const acceptBtn = priceChangeSectionCustomer.querySelector(`#acceptPriceChangeBtn-${job.id}`);
          const declineBtn = priceChangeSectionCustomer.querySelector(`#declinePriceChangeBtn-${job.id}`);
          
          console.log('[PRICE CHANGE] Looking for buttons:', `acceptPriceChangeBtn-${job.id}`, acceptBtn, declineBtn);
          console.log('[PRICE CHANGE] Button elements found:', { acceptBtn: !!acceptBtn, declineBtn: !!declineBtn });
          
          if (acceptBtn && declineBtn) {
            attachPriceChangeHandlers(acceptBtn, declineBtn, job);
          } else {
            // Fallback: try after a short delay
            setTimeout(() => {
              const retryAcceptBtn = priceChangeSectionCustomer.querySelector(`#acceptPriceChangeBtn-${job.id}`) || document.getElementById(`acceptPriceChangeBtn-${job.id}`);
              const retryDeclineBtn = priceChangeSectionCustomer.querySelector(`#declinePriceChangeBtn-${job.id}`) || document.getElementById(`declinePriceChangeBtn-${job.id}`);
              console.log('[PRICE CHANGE] Retry - buttons found:', { acceptBtn: !!retryAcceptBtn, declineBtn: !!retryDeclineBtn });
              if (retryAcceptBtn && retryDeclineBtn) {
                attachPriceChangeHandlers(retryAcceptBtn, retryDeclineBtn, job);
              } else {
                console.error('[PRICE CHANGE] Buttons still not found after retry');
              }
            }, 100);
          }
          
          // Helper function to attach event handlers
          function attachPriceChangeHandlers(acceptBtn, declineBtn, job) {
            
            acceptBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              e.stopPropagation();
                console.log('[PRICE CHANGE] Accept button clicked for job:', job.id);
                acceptBtn.disabled = true;
                acceptBtn.textContent = 'Processing...';
                try {
                  const token = localStorage.getItem('hustl_token');
                  const apiBase = window.API_BASE || API_BASE || 'https://hustl-production.up.railway.app';
                  console.log('[PRICE CHANGE] Calling API:', `${apiBase}/jobs/${job.id}/accept-price-change`);
                  const response = await fetch(`${apiBase}/jobs/${job.id}/accept-price-change`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  const data = await response.json();
                  
                  if (response.ok) {
                    // If price increased, show payment modal for the difference
                    if (data.requiresPayment && data.clientSecret) {
                      acceptBtn.disabled = false;
                      acceptBtn.textContent = '✓ Accept & Pay Difference';
                      
                      // Show payment modal for the difference
                      await showStripePaymentModal(
                        data.clientSecret,
                        job.id,
                        async (paymentIntentId) => {
                          // After payment authorized, finalize the price change
                          try {
                            const finalizeResponse = await fetch(`${apiBase}/jobs/${job.id}/finalize-price-change`, {
                              method: 'POST',
                              headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                              },
                              body: JSON.stringify({ paymentIntentId })
                            });
                            
                            if (finalizeResponse.ok) {
                              showToast('✅ Price change accepted! Payment authorized.');
                              // Close modal and refresh
                              const existingModal = document.getElementById('jobDetailModal');
                              if (existingModal) {
                                document.body.removeChild(existingModal);
                                document.body.style.overflow = '';
                              }
                              setTimeout(() => {
                                window.openJobDetails(job.id);
                              }, 100);
                            } else {
                              const error = await finalizeResponse.json();
                              showToast(error.error || 'Failed to finalize price change');
                            }
                          } catch (error) {
                            console.error('Error finalizing price change:', error);
                            showToast('Error finalizing price change. Please try again.');
                          }
                        },
                        data.amount
                      );
                    } else if (data.refund && data.refund.refunded) {
                      // Price decreased - show refund success popup
                      showToast(`✅ Price change accepted! ${data.refund.message}`, 8000);
                      // Close modal and refresh
                      const existingModal = document.getElementById('jobDetailModal');
                      if (existingModal) {
                        document.body.removeChild(existingModal);
                        document.body.style.overflow = '';
                      }
                      setTimeout(() => {
                        window.openJobDetails(job.id);
                      }, 100);
                    } else {
                      showToast('✅ Price change accepted!');
                      // Close modal and refresh
                      const existingModal = document.getElementById('jobDetailModal');
                      if (existingModal) {
                        document.body.removeChild(existingModal);
                        document.body.style.overflow = '';
                      }
                      setTimeout(() => {
                        window.openJobDetails(job.id);
                      }, 100);
                    }
                  } else {
                    showToast(data.error || 'Failed to accept price change');
                    acceptBtn.disabled = false;
                    acceptBtn.textContent = '✓ Accept & Pay Difference';
                  }
                } catch (error) {
                  console.error('Error accepting price change:', error);
                  showToast('Error accepting price change. Please try again.');
                  acceptBtn.disabled = false;
                  acceptBtn.textContent = '✓ Accept Updated Price';
                }
              });
            
            declineBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              e.stopPropagation();
                if (!confirm('Are you sure you want to decline this price change? The job will remain at the original price.')) {
                  return;
                }
                console.log('[PRICE CHANGE] Decline button clicked for job:', job.id);
                declineBtn.disabled = true;
                declineBtn.textContent = 'Processing...';
                try {
                  const token = localStorage.getItem('hustl_token');
                  const apiBase = window.API_BASE || API_BASE || 'https://hustl-production.up.railway.app';
                  console.log('[PRICE CHANGE] Calling API:', `${apiBase}/jobs/${job.id}/decline-price-change`);
                  const response = await fetch(`${apiBase}/jobs/${job.id}/decline-price-change`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  console.log('[PRICE CHANGE] Response status:', response.status);
                  if (response.ok) {
                    const result = await response.json();
                    console.log('[PRICE CHANGE] Decline success:', result);
                    showToast('Price change declined. Job remains at original price.');
                    // Close existing modal first
                    const existingModal = document.getElementById('jobDetailModal');
                    if (existingModal) {
                      document.body.removeChild(existingModal);
                      document.body.style.overflow = '';
                    }
                    // Small delay to ensure modal is closed, then reopen with fresh data
                    setTimeout(() => {
                      window.openJobDetails(job.id);
                    }, 100);
                  } else {
                    const error = await response.json();
                    console.error('[PRICE CHANGE] Decline error:', error);
                    showToast(error.error || 'Failed to decline price change');
                    declineBtn.disabled = false;
                    declineBtn.textContent = '✗ Decline';
                  }
                } catch (error) {
                  console.error('[PRICE CHANGE] Error declining price change:', error);
                  showToast('Error declining price change. Please try again.');
                  declineBtn.disabled = false;
                  declineBtn.textContent = '✗ Decline';
                }
              });
          }
        }
        
        // 8.6. PRICE CHANGE PROPOSAL UI (for HUSTLER to propose price changes)
        // Note: requirements and parsedRequirements are already declared above
        const proposedPriceChange = parsedRequirements?.proposedPriceChange;
        const isAssignedHustler = job.hustlerId && job.hustlerId === user?.id && 
                                 (job.status === 'SCHEDULED' || job.status === 'ASSIGNED');
        // Show price change section if hustler is assigned and start code not verified
        if (isAssignedHustler && !job.startCodeVerified) {
          const priceChangeSection = document.createElement("div");
          priceChangeSection.style.cssText = "margin-bottom: 1rem; padding: 1rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf24;";
          
          if (proposedPriceChange && proposedPriceChange.status === 'PENDING') {
            priceChangeSection.innerHTML = `
              <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.75rem; font-weight: 700;">💰 Price Change Proposal Pending</div>
              <div style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.75rem;">
                Waiting for customer to accept or decline your price change proposal.
              </div>
              <div style="padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #fbbf24;">
                <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.25rem;">Proposed Price:</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #78350f;">
                  ${job.payType === 'hourly' 
                    ? `$${proposedPriceChange.hourlyRate?.toFixed(2) || job.hourlyRate}/hr × ${proposedPriceChange.estHours || job.estHours} hours = $${((proposedPriceChange.hourlyRate || job.hourlyRate) * (proposedPriceChange.estHours || job.estHours)).toFixed(2)}`
                    : `$${proposedPriceChange.amount?.toFixed(2) || job.amount}`
                  }
                </div>
              </div>
            `;
          } else if (proposedPriceChange && proposedPriceChange.status === 'DECLINED' && !localStorage.getItem(`priceDeclineDismissed_${job.id}`)) {
            priceChangeSection.style.background = "#fee2e2";
            priceChangeSection.style.borderColor = "#dc2626";
            priceChangeSection.innerHTML = `
              <div style="font-size: 0.9rem; color: #991b1b; margin-bottom: 0.75rem; font-weight: 700;">❌ Price Change Declined</div>
              <div style="font-size: 0.85rem; color: #7f1d1d; margin-bottom: 1rem;">
                The customer declined your price change proposal. The job will remain at the original agreed price.
              </div>
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                <button id="leaveJobAfterDeclineBtn-${job.id}" class="btn btn-primary" style="flex: 1; min-width: 120px; padding: 0.875rem; font-weight: 700; background: #dc2626; border: none; border-radius: 8px; color: white; cursor: pointer;">
                  Leave Job
                </button>
                <button id="continueAfterDeclineBtn-${job.id}" class="btn btn-ghost" style="flex: 1; min-width: 120px; padding: 0.875rem; font-weight: 700; border: 2px solid #10b981; color: #10b981; border-radius: 8px; background: white; cursor: pointer;">
                  Continue
                </button>
                <button id="proposeNewPriceBtn-${job.id}" class="btn btn-ghost" style="flex: 1; min-width: 120px; padding: 0.875rem; font-weight: 700; border: 2px solid #3b82f6; color: #3b82f6; border-radius: 8px; background: white; cursor: pointer;">
                  💰 Propose New Price
                </button>
              </div>
            `;
            
            setTimeout(() => {
              const leaveBtn = document.getElementById(`leaveJobAfterDeclineBtn-${job.id}`);
              const continueBtn = document.getElementById(`continueAfterDeclineBtn-${job.id}`);
              const proposeBtn = document.getElementById(`proposeNewPriceBtn-${job.id}`);
              
              if (leaveBtn) {
                leaveBtn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('[PRICE DECLINE] Leave button clicked for job:', job.id);
                  if (!confirm('Are you sure you want to leave this job? The customer will receive a full refund.')) {
                    return;
                  }
                  leaveBtn.disabled = true;
                  leaveBtn.textContent = 'Leaving...';
                  try {
                    const token = localStorage.getItem('hustl_token');
                    const apiBase = window.API_BASE || API_BASE || 'https://hustl-production.up.railway.app';
                    const response = await fetch(`${apiBase}/jobs/${job.id}/leave`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (response.ok) {
                      showToast('You have left the job. The customer will receive a full refund.');
                      // Close modal and refresh
                      const existingModal = document.getElementById('jobDetailModal');
                      if (existingModal) {
                        document.body.removeChild(existingModal);
                        document.body.style.overflow = '';
                      }
                      // Refresh the page or navigate away
                      setTimeout(() => {
                        window.location.reload();
                      }, 1000);
                    } else {
                      const error = await response.json();
                      showToast(error.error || 'Failed to leave job');
                      leaveBtn.disabled = false;
                      leaveBtn.textContent = 'Leave Job';
                    }
                  } catch (error) {
                    console.error('Error leaving job:', error);
                    showToast('Error leaving job. Please try again.');
                    leaveBtn.disabled = false;
                    leaveBtn.textContent = 'Leave Job';
                  }
                });
              }
              
              if (continueBtn) {
                continueBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('[PRICE DECLINE] Continue button clicked for job:', job.id);
                  
                  // Mark as dismissed in localStorage so it doesn't show again
                  localStorage.setItem(`priceDeclineDismissed_${job.id}`, 'true');
                  
                  // Replace with the normal "Propose New Price" section
                  priceChangeSection.style.background = "#fef3c7";
                  priceChangeSection.style.borderColor = "#fbbf24";
                  priceChangeSection.innerHTML = `
                    <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.75rem; font-weight: 700;">💰 Adjust Price</div>
                    <div style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.75rem; line-height: 1.5;">
                      Need to change the price? Propose a new price to the customer. They must accept before the price changes.
                    </div>
                    <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                      <strong>⚠️ Before proposing:</strong> Message the customer first to discuss why you need a price change. If they disagree, they can unassign you or you can leave the job (customer gets full refund).
                    </div>
                    <button id="proposePriceChangeBtn-${job.id}" class="btn btn-primary" style="width: 100%; padding: 0.875rem; font-weight: 700; background: #f59e0b; border: none; border-radius: 8px; color: white; cursor: pointer;">
                      ✏️ Propose Price Change
                    </button>
                  `;
                  
                  showToast('Continuing with job at original price. You can propose a new price if needed.');
                  
                  // Attach event handler to the new propose button (reuse existing logic from else block)
                  setTimeout(() => {
                    const proposeBtn = priceChangeSection.querySelector(`#proposePriceChangeBtn-${job.id}`);
                    if (proposeBtn) {
                      proposeBtn.addEventListener('click', async () => {
                        // Show confirmation with messaging reminder
                        if (!confirm('⚠️ Important: Only propose a price change if necessary and after discussing with the customer via messages. Proceed with price change proposal?')) {
                          return;
                        }
                        
                        // Show inline form in the job popup instead of separate modal
                        const existingForm = priceChangeSection.querySelector('.priceProposalForm');
                        if (existingForm) {
                          existingForm.style.display = existingForm.style.display === 'none' ? 'block' : 'none';
                          return;
                        }
                        
                        // Create inline price proposal form
                        const payType = job.payType || 'flat';
                        const hourlyRate = parseFloat(job.hourlyRate || 0);
                        const maxHours = Number(job.estHours) || Number(parsedRequirements.maxHours) || 0;
                        const jobAmount = parseFloat(job.amount || 0);
                        const currentAmount = payType === 'hourly' ? (hourlyRate * maxHours) : jobAmount;
                        
                        // Hide the button and show the form inline
                        proposeBtn.style.display = 'none';
                        
                        const proposalForm = document.createElement('div');
                        proposalForm.className = 'priceProposalForm';
                        proposalForm.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px solid #f59e0b;';
                        // Calculate hustler earnings (job amount - 12% platform fee)
                        const currentHustlerEarnings = currentAmount * 0.88;
                        
                        proposalForm.innerHTML = `
                          <h4 style="font-size: 1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: #92400e;">💰 Propose New Price</h4>
                          <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.5;">
                            <strong>Current Price:</strong> $${currentAmount.toFixed(2)} (You earn: $${currentHustlerEarnings.toFixed(2)} after 12% platform fee)
                          </div>
                          
                          <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; font-weight: 600;">New Price</label>
                              ${payType === 'hourly' ? `
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem;">
                                  <div>
                                    <input type="number" id="newHourlyRate-${job.id}" placeholder="Hourly rate" min="1" step="0.01" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${hourlyRate || ''}">
                                  </div>
                                  <div>
                                    <input type="number" id="newMaxHours-${job.id}" placeholder="Max hours" min="1" step="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${maxHours || ''}">
                                  </div>
                                </div>
                              ` : `
                                <input type="number" id="newAmount-${job.id}" placeholder="Total amount" min="1" step="0.01" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${jobAmount || ''}">
                              `}
                              <div style="margin-top: 0.75rem; font-size: 0.8rem; color: #6b7280;">
                                <div id="pricePreview-${job.id}" style="padding: 0.5rem; background: white; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #e5e7eb;">
                                  <div>Proposed Price: <span id="newTotalPreview-${job.id}" style="font-weight: 600;">$0.00</span></div>
                                  <div style="margin-top: 0.25rem; font-size: 0.75rem;">
                                    <span id="priceChangePreview-${job.id}" style="color: #6b7280;">Enter new price</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            
                            <div style="display: flex; gap: 0.75rem;">
                              <button class="btn btn-primary savePriceBtn-${job.id}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Send Proposal</button>
                              <button class="btn btn-ghost cancelPriceBtn-${job.id}" style="flex: 1; padding: 0.75rem;">Cancel</button>
                            </div>
                          </div>
                        `;
                        priceChangeSection.appendChild(proposalForm);
                        
                        // Add real-time price preview (showing hustler earnings)
                        const updatePricePreview = () => {
                          let newAmount = 0;
                          if (payType === 'hourly') {
                            const newRate = parseFloat(document.getElementById(`newHourlyRate-${job.id}`)?.value || 0);
                            const newHours = parseInt(document.getElementById(`newMaxHours-${job.id}`)?.value || 0);
                            newAmount = newRate * newHours;
                          } else {
                            newAmount = parseFloat(document.getElementById(`newAmount-${job.id}`)?.value || 0);
                          }
                          
                          if (newAmount > 0) {
                            // Calculate hustler earnings (job amount - 12% platform fee)
                            const newHustlerEarnings = newAmount * 0.88;
                            const difference = newAmount - currentAmount;
                            const earningsDifference = newHustlerEarnings - currentHustlerEarnings;
                            
                            document.getElementById(`newTotalPreview-${job.id}`).textContent = `$${newAmount.toFixed(2)}`;
                            if (difference > 0) {
                              document.getElementById(`priceChangePreview-${job.id}`).innerHTML = `You'll earn: <strong style="color: #16a34a;">$${newHustlerEarnings.toFixed(2)}</strong> ($${earningsDifference.toFixed(2)} more after 12% platform fee)`;
                            } else if (difference < 0) {
                              document.getElementById(`priceChangePreview-${job.id}`).innerHTML = `You'll earn: <strong style="color: #dc2626;">$${newHustlerEarnings.toFixed(2)}</strong> ($${Math.abs(earningsDifference).toFixed(2)} less after 12% platform fee)`;
                            } else {
                              document.getElementById(`priceChangePreview-${job.id}`).innerHTML = `You'll earn: <strong>$${newHustlerEarnings.toFixed(2)}</strong> (same as current after 12% platform fee)`;
                            }
                          } else {
                            document.getElementById(`newTotalPreview-${job.id}`).textContent = '$0.00';
                            document.getElementById(`priceChangePreview-${job.id}`).textContent = 'Enter new price';
                          }
                        };
                        
                        // Attach preview updates
                        if (payType === 'hourly') {
                          document.getElementById(`newHourlyRate-${job.id}`)?.addEventListener('input', updatePricePreview);
                          document.getElementById(`newMaxHours-${job.id}`)?.addEventListener('input', updatePricePreview);
                        } else {
                          document.getElementById(`newAmount-${job.id}`)?.addEventListener('input', updatePricePreview);
                        }
                        
                        // Cancel button
                        proposalForm.querySelector(`.cancelPriceBtn-${job.id}`).addEventListener('click', () => {
                          proposalForm.remove();
                          proposeBtn.style.display = 'block';
                        });
                        
                        // Save button
                        proposalForm.querySelector(`.savePriceBtn-${job.id}`).addEventListener('click', async () => {
                          const token = localStorage.getItem('hustl_token');
                          const apiBase = window.API_BASE || API_BASE || 'https://hustl-production.up.railway.app';
                          
                          let proposalData = {};
                          if (payType === 'hourly') {
                            const newRate = parseFloat(document.getElementById(`newHourlyRate-${job.id}`).value);
                            const newHours = parseInt(document.getElementById(`newMaxHours-${job.id}`).value);
                            if (!newRate || !newHours) {
                              showToast('Please enter both hourly rate and estimated hours.');
                              return;
                            }
                            proposalData = { hourlyRate: newRate, estHours: newHours };
                          } else {
                            const newAmount = parseFloat(document.getElementById(`newAmount-${job.id}`).value);
                            if (!newAmount || newAmount <= 0) {
                              showToast('Please enter a valid price amount.');
                              return;
                            }
                            proposalData = { amount: newAmount };
                          }
                          
                          const submitBtn = proposalForm.querySelector(`.savePriceBtn-${job.id}`);
                          submitBtn.disabled = true;
                          submitBtn.textContent = 'Sending...';
                          
                          try {
                            const response = await fetch(`${apiBase}/jobs/${job.id}/propose-price-change`, {
                              method: 'POST',
                              headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                              },
                              body: JSON.stringify(proposalData)
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                              // Clear the dismissed flag since a new proposal was sent
                              localStorage.removeItem(`priceDeclineDismissed_${job.id}`);
                              showToast('✅ Price change proposal sent! Waiting for customer response.');
                              const existingModal = document.getElementById('jobDetailModal');
                              if (existingModal) {
                                document.body.removeChild(existingModal);
                                document.body.style.overflow = '';
                              }
                              setTimeout(() => {
                                window.openJobDetails(job.id);
                              }, 100);
                            } else {
                              showToast(result.error || 'Failed to send proposal');
                              submitBtn.disabled = false;
                              submitBtn.textContent = 'Send Proposal';
                            }
                          } catch (error) {
                            console.error('Error sending proposal:', error);
                            showToast('Error sending proposal. Please try again.');
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Send Proposal';
                          }
                        });
                      });
                    }
                  }, 100);
                });
              }
              
              if (proposeBtn) {
                proposeBtn.addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log('[PRICE DECLINE] Propose New Price button clicked for job:', job.id);
                  // Replace the declined section with the "propose new price" section inline (same as Continue)
                  priceChangeSection.style.background = "#fef3c7";
                  priceChangeSection.style.borderColor = "#fbbf24";
                  priceChangeSection.innerHTML = `
                    <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.75rem; font-weight: 700;">💰 Adjust Price</div>
                    <div style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.75rem; line-height: 1.5;">
                      Need to change the price? Propose a new price to the customer. They must accept before the price changes.
                    </div>
                    <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                      <strong>⚠️ Before proposing:</strong> Message the customer first to discuss why you need a price change. If they disagree, they can unassign you or you can leave the job (customer gets full refund).
                    </div>
                    <button id="proposePriceChangeBtn-${job.id}" class="btn btn-primary" style="width: 100%; padding: 0.875rem; font-weight: 700; background: #f59e0b; border: none; border-radius: 8px; color: white; cursor: pointer;">
                      ✏️ Propose Price Change
                    </button>
                  `;
                  
                  // Attach event handler to the new propose button
                  setTimeout(() => {
                    const newProposeBtn = priceChangeSection.querySelector(`#proposePriceChangeBtn-${job.id}`);
                    if (newProposeBtn) {
                      newProposeBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!confirm('⚠️ Important: Only propose a price change if necessary and after discussing with the customer via messages. Proceed with price change proposal?')) {
                          return;
                        }
                        
                        const existingForm = priceChangeSection.querySelector('.priceProposalForm');
                        if (existingForm) {
                          existingForm.style.display = existingForm.style.display === 'none' ? 'block' : 'none';
                          return;
                        }
                        
                        // Create inline form
                        const form = document.createElement('div');
                        form.className = 'priceProposalForm';
                        form.style.cssText = 'margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 2px solid #fbbf24;';
                        
                        if (job.payType === 'hourly') {
                          form.innerHTML = `
                            <div style="margin-bottom: 1rem;">
                              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">New Hourly Rate</label>
                              <input type="number" id="newHourlyRate_${job.id}" step="0.01" min="0" value="${job.hourlyRate || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid #fbbf24; border-radius: 6px; font-size: 1rem;">
                            </div>
                            <div style="margin-bottom: 1rem;">
                              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">New Estimated Hours</label>
                              <input type="number" id="newEstHours_${job.id}" step="1" min="1" value="${job.estHours || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid #fbbf24; border-radius: 6px; font-size: 1rem;">
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                              <button id="cancelProposalBtn_${job.id}" class="btn btn-ghost" style="flex: 1; padding: 0.75rem;">Cancel</button>
                              <button id="submitProposalBtn_${job.id}" class="btn btn-primary" style="flex: 1; padding: 0.75rem; background: #f59e0b; border: none; color: white; font-weight: 700;">Send Proposal</button>
                            </div>
                          `;
                        } else {
                          form.innerHTML = `
                            <div style="margin-bottom: 1rem;">
                              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">New Flat Rate</label>
                              <input type="number" id="newAmount_${job.id}" step="0.01" min="0" value="${job.amount || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid #fbbf24; border-radius: 6px; font-size: 1rem;">
                            </div>
                            <div style="display: flex; gap: 0.75rem;">
                              <button id="cancelProposalBtn_${job.id}" class="btn btn-ghost" style="flex: 1; padding: 0.75rem;">Cancel</button>
                              <button id="submitProposalBtn_${job.id}" class="btn btn-primary" style="flex: 1; padding: 0.75rem; background: #f59e0b; border: none; color: white; font-weight: 700;">Send Proposal</button>
                            </div>
                          `;
                        }
                        
                        priceChangeSection.appendChild(form);
                        
                        form.querySelector(`#cancelProposalBtn_${job.id}`).addEventListener('click', (e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          form.remove();
                        });
                        
                        form.querySelector(`#submitProposalBtn_${job.id}`).addEventListener('click', async (e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          const token = localStorage.getItem('hustl_token');
                          const apiBase = window.API_BASE || API_BASE || 'https://hustl-production.up.railway.app';
                          
                          let proposalData = {};
                          if (job.payType === 'hourly') {
                            const newRate = parseFloat(form.querySelector(`#newHourlyRate_${job.id}`).value);
                            const newHours = parseInt(form.querySelector(`#newEstHours_${job.id}`).value);
                            if (!newRate || !newHours) {
                              showToast('Please enter both hourly rate and estimated hours.');
                              return;
                            }
                            proposalData = { hourlyRate: newRate, estHours: newHours };
                          } else {
                            const newAmount = parseFloat(form.querySelector(`#newAmount_${job.id}`).value);
                            if (!newAmount || newAmount <= 0) {
                              showToast('Please enter a valid price amount.');
                              return;
                            }
                            proposalData = { amount: newAmount };
                          }
                          
                          const submitBtn = form.querySelector(`#submitProposalBtn_${job.id}`);
                          submitBtn.disabled = true;
                          submitBtn.textContent = 'Sending...';
                          
                          try {
                            const response = await fetch(`${apiBase}/jobs/${job.id}/propose-price-change`, {
                              method: 'POST',
                              headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                              },
                              body: JSON.stringify(proposalData)
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                              showToast('✅ Price change proposal sent! Waiting for customer response.');
                              const existingModal = document.getElementById('jobDetailModal');
                              if (existingModal) {
                                document.body.removeChild(existingModal);
                                document.body.style.overflow = '';
                              }
                              setTimeout(() => {
                                window.openJobDetails(job.id);
                              }, 100);
                            } else {
                              showToast(result.error || 'Failed to send proposal');
                              submitBtn.disabled = false;
                              submitBtn.textContent = 'Send Proposal';
                            }
                          } catch (error) {
                            console.error('Error sending proposal:', error);
                            showToast('Error sending proposal. Please try again.');
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Send Proposal';
                          }
                        });
                      });
                    }
                  }, 100);
                });
              }
            }, 100);
          } else {
            // No proposal yet - show button to propose price change (for HUSTLER)
            priceChangeSection.innerHTML = `
              <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.75rem; font-weight: 700;">💰 Adjust Price</div>
              <div style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.75rem; line-height: 1.5;">
                Need to change the price? Propose a new price to the customer. They must accept before the price changes.
              </div>
              <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                <strong>⚠️ Before proposing:</strong> Message the customer first to discuss why you need a price change. If they disagree, they can unassign you or you can leave the job (customer gets full refund).
              </div>
              <button id="proposePriceChangeBtn-${job.id}" class="btn btn-primary" style="width: 100%; padding: 0.875rem; font-weight: 700; background: #f59e0b; border: none; border-radius: 8px; color: white; cursor: pointer;">
                ✏️ Propose Price Change
              </button>
            `;
            
            setTimeout(() => {
              const proposeBtn = document.getElementById(`proposePriceChangeBtn-${job.id}`);
              if (proposeBtn) {
                proposeBtn.addEventListener('click', async () => {
                  // Show confirmation with messaging reminder
                  if (!confirm('⚠️ Important: Only propose a price change if necessary and after discussing with the customer via messages. Proceed with price change proposal?')) {
                    return;
                  }
                  
                  // Show inline form in the job popup instead of separate modal
                  const existingForm = priceChangeSection.querySelector('.priceProposalForm');
                  if (existingForm) {
                    existingForm.style.display = existingForm.style.display === 'none' ? 'block' : 'none';
                    return;
                  }
                  
                  // Create inline price proposal form
                  const payType = job.payType || 'flat';
                  const hourlyRate = parseFloat(job.hourlyRate || 0);
                  const maxHours = Number(job.estHours) || Number(parsedRequirements.maxHours) || 0;
                  const jobAmount = parseFloat(job.amount || 0);
                  const currentAmount = payType === 'hourly' ? (hourlyRate * maxHours) : jobAmount;
                  const currentTotal = currentAmount + (currentAmount * 0.065);
                  
                  // Hide the button and show the form inline
                  proposeBtn.style.display = 'none';
                  
                  const proposalForm = document.createElement('div');
                  proposalForm.className = 'priceProposalForm';
                  proposalForm.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 2px solid #f59e0b;';
                  // Calculate hustler earnings (job amount - 12% platform fee)
                  const currentHustlerEarnings = currentAmount * 0.88;
                  
                  proposalForm.innerHTML = `
                    <h4 style="font-size: 1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: #92400e;">💰 Propose New Price</h4>
                    <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.5;">
                      <strong>Current Price:</strong> $${currentAmount.toFixed(2)} (You earn: $${currentHustlerEarnings.toFixed(2)} after 12% platform fee)
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; font-weight: 600;">New Price</label>
                        ${payType === 'hourly' ? `
                          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem;">
                            <div>
                              <input type="number" id="newHourlyRate-${job.id}" placeholder="Hourly rate" min="1" step="0.01" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${hourlyRate || ''}">
                            </div>
                            <div>
                              <input type="number" id="newMaxHours-${job.id}" placeholder="Max hours" min="1" step="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${maxHours || ''}">
                            </div>
                          </div>
                        ` : `
                          <input type="number" id="newAmount-${job.id}" placeholder="Total amount" min="1" step="0.01" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${jobAmount || ''}">
                        `}
                        <div style="margin-top: 0.75rem; font-size: 0.8rem; color: #6b7280;">
                          <div id="pricePreview-${job.id}" style="padding: 0.5rem; background: white; border-radius: 6px; margin-top: 0.5rem; border: 1px solid #e5e7eb;">
                            <div>Proposed Price: <span id="newTotalPreview-${job.id}" style="font-weight: 600;">$0.00</span></div>
                            <div style="margin-top: 0.25rem; font-size: 0.75rem;">
                              <span id="priceChangePreview-${job.id}" style="color: #6b7280;">Enter new price</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      
                      <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-primary savePriceBtn-${job.id}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Send Proposal</button>
                        <button class="btn btn-ghost cancelPriceBtn-${job.id}" style="flex: 1; padding: 0.75rem;">Cancel</button>
                      </div>
                    </div>
                  `;
                  priceChangeSection.appendChild(proposalForm);
                  
                  // Add real-time price preview (showing hustler earnings)
                  const updatePricePreview = () => {
                    let newAmount = 0;
                    if (payType === 'hourly') {
                      const newRate = parseFloat(document.getElementById(`newHourlyRate-${job.id}`)?.value || 0);
                      const newHours = parseInt(document.getElementById(`newMaxHours-${job.id}`)?.value || 0);
                      newAmount = newRate * newHours;
                    } else {
                      newAmount = parseFloat(document.getElementById(`newAmount-${job.id}`)?.value || 0);
                    }
                    
                    if (newAmount > 0) {
                      // Calculate hustler earnings (job amount - 12% platform fee)
                      const newHustlerEarnings = newAmount * 0.88;
                      const earningsDifference = newHustlerEarnings - currentHustlerEarnings;
                      
                      document.getElementById(`newTotalPreview-${job.id}`).textContent = `$${newAmount.toFixed(2)}`;
                      
                      if (Math.abs(earningsDifference) < 0.01) {
                        document.getElementById(`priceChangePreview-${job.id}`).textContent = `You'll earn: $${newHustlerEarnings.toFixed(2)} (same as current, after 12% platform fee)`;
                        document.getElementById(`priceChangePreview-${job.id}`).style.color = '#6b7280';
                      } else if (earningsDifference > 0) {
                        document.getElementById(`priceChangePreview-${job.id}`).textContent = `You'll earn: $${newHustlerEarnings.toFixed(2)} ($${earningsDifference.toFixed(2)} more after 12% platform fee)`;
                        document.getElementById(`priceChangePreview-${job.id}`).style.color = '#10b981';
                      } else {
                        document.getElementById(`priceChangePreview-${job.id}`).textContent = `You'll earn: $${newHustlerEarnings.toFixed(2)} ($${Math.abs(earningsDifference).toFixed(2)} less after 12% platform fee)`;
                        document.getElementById(`priceChangePreview-${job.id}`).style.color = '#dc2626';
                      }
                    } else {
                      document.getElementById(`newTotalPreview-${job.id}`).textContent = '$0.00';
                      document.getElementById(`priceChangePreview-${job.id}`).textContent = 'Enter new price';
                      document.getElementById(`priceChangePreview-${job.id}`).style.color = '#6b7280';
                    }
                  };
                  
                  // Add event listeners for real-time preview
                  if (payType === 'hourly') {
                    document.getElementById(`newHourlyRate-${job.id}`)?.addEventListener('input', updatePricePreview);
                    document.getElementById(`newMaxHours-${job.id}`)?.addEventListener('input', updatePricePreview);
                  } else {
                    document.getElementById(`newAmount-${job.id}`)?.addEventListener('input', updatePricePreview);
                  }
                  
                  // Initial preview
                  setTimeout(updatePricePreview, 100);
                  
                  proposalForm.querySelector(`.cancelPriceBtn-${job.id}`)?.addEventListener('click', () => {
                    proposalForm.remove();
                    proposeBtn.style.display = 'block';
                  });
                  proposalForm.querySelector(`.savePriceBtn-${job.id}`)?.addEventListener('click', async () => {
                    try {
                      const token = localStorage.getItem('hustl_token');
                      const proposalData = {};
                      if (payType === 'hourly') {
                        const newRate = parseFloat(document.getElementById(`newHourlyRate-${job.id}`)?.value);
                        const newHours = parseInt(document.getElementById(`newMaxHours-${job.id}`)?.value);
                        if (newRate && newRate > 0) proposalData.hourlyRate = newRate;
                        if (newHours && newHours > 0) proposalData.estHours = newHours;
                      } else {
                        const newAmount = parseFloat(document.getElementById(`newAmount-${job.id}`)?.value);
                        if (newAmount && newAmount > 0) proposalData.amount = newAmount;
                      }
                      
                      if (Object.keys(proposalData).length === 0) {
                        showToast('Please enter a valid price');
                        return;
                      }
                      
                      const saveBtn = proposalForm.querySelector(`.savePriceBtn-${job.id}`);
                      saveBtn.disabled = true;
                      saveBtn.textContent = 'Sending...';
                      
                      const response = await fetch(`${API_BASE}/jobs/${job.id}/propose-price-change`, {
                        method: 'POST',
                        headers: {
                          'Authorization': `Bearer ${token}`,
                          'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(proposalData)
                      });
                      
                      if (response.ok) {
                        showToast('Price change proposal sent! The customer must accept it before the price changes.');
                        // Close job details modal and reopen to refresh
                        const existingModal = document.getElementById('jobDetailModal');
                        if (existingModal) {
                          document.body.removeChild(existingModal);
                          document.body.style.overflow = '';
                        }
                        setTimeout(() => {
                          if (typeof window.openJobDetails === 'function') {
                            window.openJobDetails(job.id);
                          }
                        }, 100);
                      } else {
                        const error = await response.json();
                        showToast(error.error || 'Failed to propose price change');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Send Proposal';
                      }
                    } catch (error) {
                      console.error('Error proposing price change:', error);
                      showToast('Error proposing price change. Please try again.');
                      const saveBtn = proposalForm.querySelector(`.savePriceBtn-${job.id}`);
                      saveBtn.disabled = false;
                      saveBtn.textContent = 'Send Proposal';
                    }
                  });
                });
              }
            }, 100);
          }
          
          modalContent.appendChild(priceChangeSection);
        }
        
        // 9. APPLY AREA (with why you're a good fit) - Always show for hustlers
        const actionsSection = document.createElement("div");
        actionsSection.style.cssText = "padding: 1rem; background: #f8f9fa; border-radius: 12px; border: 1px solid #e5e7eb;";
        
        // Get current user from API (async) - user, isOwner, and isHustler already defined above for timer and price change UI
        // Note: token is already declared at line 9701 in this function
        
        console.log("Apply area check - user:", user, "isHustler:", isHustler, "isOwner:", isOwner, "token:", token ? "present" : "missing");
        
        // Check if viewing from Applied section (has stored offer)
        const viewingOffer = window._currentViewingOffer;
        const isViewingApplied = viewingOffer && viewingOffer.jobId === job.id;
        
        // Check if viewing from Posted tab (job owner viewing their own job)
        const isViewingFromPosted = window._viewingFromPostedTab && isOwner;
        
        // Check if user has already applied to this job
        let userHasApplied = false;
        let userOffer = null;
        if (user && token) {
          try {
            const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
              headers: { "Authorization": `Bearer ${token}` }
            });
            if (offersResponse.ok) {
              const offers = await offersResponse.json();
              if (Array.isArray(offers)) {
                userOffer = offers.find(o => o.hustlerId === user.id);
                if (userOffer && (userOffer.status === 'PENDING' || userOffer.status === 'ACCEPTED')) {
                  userHasApplied = true;
                }
                // If denied, allow re-apply (userHasApplied stays false)
              }
            }
          } catch (e) {
            console.warn("Error checking if user applied:", e);
          }
        }
        
        // Show apply area for hustlers OR if not logged in (show login prompt)
        // Always show apply area unless user is the owner
        // Check both user object and token to ensure user is logged in
        // BUT if viewing from Applied section, show their offer instead
        // BUT if viewing from Posted tab, show applicants instead
        // BUT if user already applied (and not denied), show "Already Applied"
        if (isViewingFromPosted) {
          // Show applicants section for job owner
          const applicantsSection = document.createElement("div");
          applicantsSection.style.cssText = "padding: 1rem; background: #f8f9fa; border-radius: 12px; border: 1px solid #e5e7eb;";
          
          const applicantsTitle = document.createElement("div");
          applicantsTitle.style.cssText = "font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 1rem;";
          applicantsTitle.textContent = "👥 Applicants";
          applicantsSection.appendChild(applicantsTitle);
          
          // Fetch applicants/offers for this job
          try {
            const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
              headers: token ? { "Authorization": `Bearer ${token}` } : {}
            });
            
            if (offersResponse.ok) {
              const offers = await offersResponse.json();
              const pendingOffers = Array.isArray(offers) ? offers.filter(o => o.status === 'PENDING') : [];
              
              if (pendingOffers.length === 0) {
                const noApplicants = document.createElement("div");
                noApplicants.style.cssText = "text-align: center; padding: 2rem; color: var(--text-muted);";
                noApplicants.textContent = "No applicants yet";
                applicantsSection.appendChild(noApplicants);
              } else {
                // Show each applicant
                for (const offer of pendingOffers) {
                  const applicantCard = document.createElement("div");
                  applicantCard.style.cssText = "padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.75rem;";
                  
                  // Applicant info
                  const applicantInfo = document.createElement("div");
                  applicantInfo.style.cssText = "display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;";
                  
                  // Profile picture
                  const profilePic = document.createElement("img");
                  profilePic.style.cssText = "width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border); flex-shrink: 0; cursor: pointer;";
                  const hustler = offer.hustler || {};
                  profilePic.src = hustler.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(hustler.name || "User") + "&background=6366f1&color=fff&size=128";
                  profilePic.alt = hustler.name || "Applicant";
                  profilePic.onerror = function() {
                    this.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(hustler.name || "User") + "&background=6366f1&color=fff&size=128";
                  };
                  profilePic.addEventListener("click", () => {
                    if (hustler.id) {
                      window.showHustlerProfilePopup(hustler.id);
                    }
                  });
                  
                  const applicantDetails = document.createElement("div");
                  applicantDetails.style.cssText = "flex: 1;";
                  
                  const applicantName = document.createElement("div");
                  applicantName.style.cssText = "font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.25rem; cursor: pointer;";
                  applicantName.textContent = hustler.name || "Unknown";
                  applicantName.addEventListener("click", () => {
                    if (hustler.id) {
                      window.showHustlerProfilePopup(hustler.id);
                    }
                  });
                  
                  const applicantRating = document.createElement("div");
                  applicantRating.style.cssText = "font-size: 0.85rem; color: var(--text-muted);";
                  if (hustler.ratingAvg) {
                    applicantRating.textContent = `⭐ ${hustler.ratingAvg.toFixed(1)} (${hustler.ratingCount || 0} reviews)`;
                  } else {
                    applicantRating.textContent = "No reviews yet";
                  }
                  
                  applicantDetails.appendChild(applicantName);
                  applicantDetails.appendChild(applicantRating);
                  
                  applicantInfo.appendChild(profilePic);
                  applicantInfo.appendChild(applicantDetails);
                  
                  // View Profile button
                  const viewProfileBtn = document.createElement("button");
                  viewProfileBtn.className = "btn btn-secondary";
                  viewProfileBtn.textContent = "View Profile";
                  viewProfileBtn.style.cssText = "padding: 0.5rem 1rem; font-size: 0.9rem; white-space: nowrap; flex-shrink: 0;";
                  viewProfileBtn.addEventListener("click", () => {
                    if (hustler.id) {
                      window.showHustlerProfilePopup(hustler.id);
                    }
                  });
                  
                  applicantInfo.appendChild(viewProfileBtn);
                  applicantCard.appendChild(applicantInfo);
                  
                  // Proposed price if they suggested one (show first)
                  if (offer.proposedAmount) {
                    const priceSection = document.createElement("div");
                    priceSection.style.cssText = "margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;";
                    const priceLabel = document.createElement("div");
                    priceLabel.style.cssText = "font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.25rem;";
                    priceLabel.textContent = "Proposed price:";
                    priceSection.appendChild(priceLabel);
                    const priceText = document.createElement("div");
                    priceText.style.cssText = "font-size: 1rem; font-weight: 700; color: var(--primary);";
                    if (job.payType === 'hourly') {
                      priceText.textContent = `$${Number(offer.proposedAmount).toFixed(0)}/hr`;
                    } else {
                      priceText.textContent = `$${Number(offer.proposedAmount).toFixed(0)} flat`;
                    }
                    priceSection.appendChild(priceText);
                    applicantCard.appendChild(priceSection);
                  }
                  
                  // Why they're a good fit (show second)
                  if (offer.note) {
                    const whyFitSection = document.createElement("div");
                    whyFitSection.style.cssText = "margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;";
                    const whyFitLabel = document.createElement("div");
                    whyFitLabel.style.cssText = "font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;";
                    whyFitLabel.textContent = "Why they're a good fit:";
                    whyFitSection.appendChild(whyFitLabel);
                    const whyFitText = document.createElement("div");
                    whyFitText.style.cssText = "font-size: 0.9rem; color: var(--text-main); line-height: 1.5;";
                    whyFitText.textContent = offer.note;
                    whyFitSection.appendChild(whyFitText);
                    applicantCard.appendChild(whyFitSection);
                  }
                  
                  // Accept and Deny buttons (show last at bottom)
                  const actionButtons = document.createElement("div");
                  actionButtons.style.cssText = "display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 2px solid #e5e7eb;";
                  
                  // Price acceptance message
                  if (offer.proposedAmount) {
                    const priceAcceptanceMsg = document.createElement("div");
                    priceAcceptanceMsg.style.cssText = "font-size: 0.85rem; color: var(--text-muted); text-align: center; padding: 0.5rem; background: #fef3c7; border-radius: 6px; margin-bottom: 0.5rem;";
                    priceAcceptanceMsg.textContent = "If you accept this hustler, you accept the price.";
                    actionButtons.appendChild(priceAcceptanceMsg);
                  }
                  
                  const buttonRow = document.createElement("div");
                  buttonRow.style.cssText = "display: flex; gap: 0.75rem;";
                  
                  const acceptBtn = document.createElement("button");
                  acceptBtn.className = "btn btn-primary";
                  acceptBtn.textContent = "✅ Accept";
                  acceptBtn.style.cssText = "flex: 1; padding: 0.75rem; font-weight: 600; border-radius: 8px;";
                  acceptBtn.dataset.offerId = offer.id;
                  acceptBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    const offerId = e.target.dataset.offerId;
                    if (confirm(`Accept ${hustler.name || 'this applicant'} for this job?`)) {
                      try {
                        acceptBtn.disabled = true;
                        acceptBtn.textContent = "Processing...";
                        
                        // Step 1: Create payment intent
                        const intentRes = await fetch(`${API_BASE}/payments/create-intent/offer/${offerId}`, {
                          method: 'POST',
                          headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                          }
                        });
                        
                        if (!intentRes.ok) {
                          const error = await intentRes.json();
                          throw new Error(error.error || 'Failed to create payment');
                        }
                        
                        const paymentData = await intentRes.json();
                        console.log('[PAYMENT] Payment intent created:', paymentData);
                        
                        // Step 2: Show payment modal with amount breakdown from payment intent
                        await showStripePaymentModal(
                          paymentData.clientSecret, 
                          job.id, 
                          async (paymentIntentId) => {
                            // Step 3: Accept offer
                            try {
                              const acceptRes = await fetch(`${API_BASE}/offers/${offerId}/accept`, {
                                method: 'POST',
                                headers: {
                                  'Authorization': `Bearer ${token}`,
                                  'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                  paymentIntentId: paymentIntentId
                                })
                              });
                              
                              if (!acceptRes.ok) {
                                const error = await acceptRes.json();
                                throw new Error(error.error || 'Failed to accept applicant');
                              }
                              
                              showToast('✅ Applicant accepted!');
                              // Close modal and refresh
                              document.body.removeChild(modalOverlay);
                              document.body.style.overflow = "";
                              window._viewingFromPostedTab = false;
                              // Refresh posted jobs
                              if (typeof loadPostedJobs === 'function') {
                                loadPostedJobs();
                              }
                            } catch (error) {
                              console.error('Error accepting offer:', error);
                              showToast(error.message || 'Failed to accept applicant');
                            }
                          },
                          paymentData.amount // Pass amount breakdown from payment intent
                        );
                        
                        acceptBtn.disabled = false;
                        acceptBtn.textContent = "✅ Accept";
                      } catch (error) {
                        console.error('Error accepting applicant:', error);
                        showToast(error.message || 'Failed to accept applicant');
                        acceptBtn.disabled = false;
                        acceptBtn.textContent = "✅ Accept";
                      }
                    }
                  });
                  
                  const denyBtn = document.createElement("button");
                  denyBtn.className = "btn btn-ghost";
                  denyBtn.textContent = "❌ Deny";
                  denyBtn.style.cssText = "flex: 1; padding: 0.75rem; font-weight: 600; border-radius: 8px; color: #dc2626; border-color: #fecaca;";
                  denyBtn.dataset.offerId = offer.id;
                  denyBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    const offerId = e.target.dataset.offerId;
                    if (confirm(`Deny ${hustler.name || 'this applicant'}? They will be notified.`)) {
                      try {
                        denyBtn.disabled = true;
                        denyBtn.textContent = "Denying...";
                        const response = await fetch(`${API_BASE}/offers/${offerId}/decline`, {
                          method: 'POST',
                          headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                          }
                        });
                        
                        if (!response.ok) {
                          const error = await response.json();
                          throw new Error(error.error || 'Failed to deny applicant');
                        }
                        
                        showToast('❌ Applicant denied');
                        // Refresh the applicants list
                        document.body.removeChild(modalOverlay);
                        document.body.style.overflow = "";
                        window._viewingFromPostedTab = true;
                        window.openJobDetails(job.id);
                      } catch (error) {
                        console.error('Error denying applicant:', error);
                        showToast(error.message || 'Failed to deny applicant');
                        denyBtn.disabled = false;
                        denyBtn.textContent = "❌ Deny";
                      }
                    }
                  });
                  
                  buttonRow.appendChild(acceptBtn);
                  buttonRow.appendChild(denyBtn);
                  actionButtons.appendChild(buttonRow);
                  applicantCard.appendChild(actionButtons);
                  
                  applicantsSection.appendChild(applicantCard);
                }
              }
            } else {
              const errorMsg = document.createElement("div");
              errorMsg.style.cssText = "text-align: center; padding: 1rem; color: var(--text-muted);";
              errorMsg.textContent = "Unable to load applicants";
              applicantsSection.appendChild(errorMsg);
            }
          } catch (error) {
            console.error("Error fetching applicants:", error);
            const errorMsg = document.createElement("div");
            errorMsg.style.cssText = "text-align: center; padding: 1rem; color: var(--text-muted);";
            errorMsg.textContent = "Error loading applicants";
            applicantsSection.appendChild(errorMsg);
          }
          
          actionsSection.appendChild(applicantsSection);
          
          // Clear the flag after using it
          window._viewingFromPostedTab = false;
        } else if (userHasApplied && !isViewingApplied) {
          // User has already applied - show "Already Applied" message
          const appliedSection = document.createElement("div");
          appliedSection.style.cssText = "padding: 1rem; background: #f0f9ff; border-radius: 12px; border: 1px solid #bae6fd;";
          
          const appliedTitle = document.createElement("div");
          appliedTitle.style.cssText = "font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem;";
          appliedTitle.textContent = "✅ Already Applied";
          appliedSection.appendChild(appliedTitle);
          
          const appliedMessage = document.createElement("div");
          appliedMessage.style.cssText = "font-size: 0.9rem; color: var(--text-muted);";
          if (userOffer && userOffer.status === 'ACCEPTED') {
            appliedMessage.textContent = "Your application has been accepted! Check your Active Jobs tab.";
          } else {
            appliedMessage.textContent = "You've already applied to this job. The customer will review your application.";
          }
          appliedSection.appendChild(appliedMessage);
          
          actionsSection.appendChild(appliedSection);
        } else if (isViewingApplied) {
          // Show their application/offer instead of apply form
          const offerSection = document.createElement("div");
          offerSection.style.cssText = "padding: 1rem; background: #f0f9ff; border-radius: 12px; border: 1px solid #bae6fd;";
          
          const offerTitle = document.createElement("div");
          offerTitle.style.cssText = "font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.75rem;";
          offerTitle.textContent = "Your Application";
          offerSection.appendChild(offerTitle);
          
          // Show their "why you're a good fit" response
          if (viewingOffer.note) {
            const whyFitSection = document.createElement("div");
            whyFitSection.style.cssText = "margin-bottom: 1rem;";
            const whyFitLabel = document.createElement("div");
            whyFitLabel.style.cssText = "font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;";
            whyFitLabel.textContent = "Why you're a good fit:";
            whyFitSection.appendChild(whyFitLabel);
            const whyFitText = document.createElement("div");
            whyFitText.style.cssText = "font-size: 0.95rem; color: var(--text-main); line-height: 1.5; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;";
            whyFitText.textContent = viewingOffer.note;
            whyFitSection.appendChild(whyFitText);
            offerSection.appendChild(whyFitSection);
          }
          
          // Show their proposed price if they suggested one
          if (viewingOffer.proposedAmount) {
            const priceSection = document.createElement("div");
            priceSection.style.cssText = "margin-bottom: 1rem;";
            const priceLabel = document.createElement("div");
            priceLabel.style.cssText = "font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem;";
            priceLabel.textContent = "Your proposed price:";
            priceSection.appendChild(priceLabel);
            const priceText = document.createElement("div");
            priceText.style.cssText = "font-size: 1.1rem; font-weight: 700; color: var(--primary);";
            if (job.payType === 'hourly') {
              priceText.textContent = `$${Number(viewingOffer.proposedAmount).toFixed(0)}/hr`;
            } else {
              priceText.textContent = `$${Number(viewingOffer.proposedAmount).toFixed(0)} flat`;
            }
            priceSection.appendChild(priceText);
            offerSection.appendChild(priceSection);
          }
          
          // Show status
          const statusSection = document.createElement("div");
          statusSection.style.cssText = "padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb;";
          const statusLabel = document.createElement("div");
          statusLabel.style.cssText = "font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.25rem;";
          statusLabel.textContent = "Status:";
          statusSection.appendChild(statusLabel);
          const statusText = document.createElement("div");
          let statusColor = '#6b7280';
          let statusDisplay = viewingOffer.status || 'Pending';
          if (viewingOffer.status === 'ACCEPTED') {
            statusColor = '#10b981';
            statusDisplay = '✅ Accepted';
          } else if (viewingOffer.status === 'PENDING') {
            statusColor = '#f59e0b';
            statusDisplay = '⏳ Pending Review';
          } else if (viewingOffer.status === 'DECLINED') {
            statusColor = '#ef4444';
            statusDisplay = '❌ Declined';
          }
          statusText.style.cssText = `font-size: 0.95rem; font-weight: 600; color: ${statusColor};`;
          statusText.textContent = statusDisplay;
          statusSection.appendChild(statusText);
          offerSection.appendChild(statusSection);
          
          actionsSection.appendChild(offerSection);
          
          // Clear the stored offer after using it
          window._currentViewingOffer = null;
        } else if (!isOwner && (user || token)) {
          // Why you're a good fit textarea
          const whyFitLabel = document.createElement("label");
          whyFitLabel.style.cssText = "display: block; font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;";
          whyFitLabel.textContent = "Why are you a good fit for this job?";
          actionsSection.appendChild(whyFitLabel);
          
          const whyFitTextarea = document.createElement("textarea");
          whyFitTextarea.id = `applyWhyFit-${job.id}`;
          whyFitTextarea.placeholder = "Describe your experience and why you're the right person for this job...";
          whyFitTextarea.maxLength = 500;
          whyFitTextarea.rows = 4;
          whyFitTextarea.style.cssText = "width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical; margin-bottom: 1rem; box-sizing: border-box;";
          actionsSection.appendChild(whyFitTextarea);
          
          const charCount = document.createElement("div");
          charCount.id = `charCount-${job.id}`;
          charCount.style.cssText = "font-size: 0.8rem; color: var(--text-muted); text-align: right; margin-bottom: 1rem;";
          charCount.textContent = "0/500";
          actionsSection.appendChild(charCount);
          
          whyFitTextarea.addEventListener("input", () => {
            charCount.textContent = `${whyFitTextarea.value.length}/500`;
          });
          
          // Price option toggle - simple buttons
          const priceOptionContainer = document.createElement("div");
          priceOptionContainer.style.cssText = "margin-bottom: 1rem;";
          
          const priceOptions = document.createElement("div");
          priceOptions.style.cssText = "display: flex; flex-direction: column; gap: 0.75rem;";
          
          // Check pricing option
          const pricingOption = requirements.pricing_option;
          const isHustlerQuote = pricingOption === "hustlers_quote" || pricingOption === "hustler_sets";
          
          // Track selected option
          let selectedPriceOption = isHustlerQuote ? "suggest" : "accept";
          
          // Proposed price input (create before event listeners so it can be referenced)
          const proposedPriceContainer = document.createElement("div");
          proposedPriceContainer.id = `proposedPriceContainer-${job.id}`;
          proposedPriceContainer.style.cssText = "display: none; margin-top: 0.75rem;";
          
          const proposedPriceLabel = document.createElement("label");
          proposedPriceLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;";
          proposedPriceLabel.textContent = "Your suggested price ($)";
          proposedPriceContainer.appendChild(proposedPriceLabel);
          
          const proposedPriceInput = document.createElement("input");
          proposedPriceInput.type = "number";
          proposedPriceInput.id = `proposedPrice-${job.id}`;
          proposedPriceInput.placeholder = "Enter amount";
          proposedPriceInput.min = "1";
          proposedPriceInput.step = "1";
          proposedPriceInput.style.cssText = "width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.95rem; box-sizing: border-box;";
          proposedPriceContainer.appendChild(proposedPriceInput);
          
          // Only show "Accept listed price" if NOT hustler quote
          if (!isHustlerQuote) {
            let listedPriceText = "";
            if (job.payType === "flat") {
              const total = Number(job.amount) || 0;
              listedPriceText = `$${total.toFixed(0)} flat`;
            } else if (job.payType === "hourly") {
              const hr = Number(job.hourlyRate) || 0;
              listedPriceText = `$${hr.toFixed(0)}/hr`;
            } else {
              const total = Number(job.amount) || 0;
              listedPriceText = `$${total.toFixed(0)}`;
            }
            
            // Accept listed price option - checkbox style
            const acceptPriceLabel = document.createElement("label");
            acceptPriceLabel.style.cssText = "display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem; background: #f9fafb; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; transition: all 0.2s; width: 100%; box-sizing: border-box;";
            
            const acceptCheckbox = document.createElement("div");
            acceptCheckbox.id = `acceptCheckbox-${job.id}`;
            acceptCheckbox.style.cssText = "width: 24px; height: 24px; border-radius: 50%; border: 2px solid #10b981; background: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s;";
            const acceptCheckmark = document.createElement("div");
            acceptCheckmark.style.cssText = "width: 12px; height: 12px; border-radius: 50%; background: #10b981; display: block;";
            acceptCheckbox.appendChild(acceptCheckmark);
            
            const acceptPriceText = document.createElement("span");
            acceptPriceText.style.cssText = "font-size: 0.95rem; color: var(--text-main); flex: 1;";
            acceptPriceText.textContent = `Accept listed price: ${listedPriceText}`;
            
            acceptPriceLabel.appendChild(acceptCheckbox);
            acceptPriceLabel.appendChild(acceptPriceText);
            priceOptions.appendChild(acceptPriceLabel);
            
            acceptPriceLabel.addEventListener("click", () => {
              selectedPriceOption = "accept";
              acceptCheckmark.style.display = "block";
              acceptCheckbox.style.borderColor = "#10b981";
              suggestCheckmark.style.display = "none";
              suggestCheckbox.style.borderColor = "#6b7280";
              acceptPriceLabel.style.borderColor = "#10b981";
              suggestPriceLabel.style.borderColor = "#d1d5db";
              proposedPriceContainer.style.display = "none";
            });
          }
          
          // Suggest own price option - checkbox style (always show)
          const suggestPriceLabel = document.createElement("label");
          suggestPriceLabel.style.cssText = "display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem; background: #f9fafb; border: 2px solid #d1d5db; border-radius: 8px; cursor: pointer; transition: all 0.2s; width: 100%; box-sizing: border-box;";
          
          const suggestCheckbox = document.createElement("div");
          suggestCheckbox.id = `suggestCheckbox-${job.id}`;
          suggestCheckbox.style.cssText = `width: 24px; height: 24px; border-radius: 50%; border: 2px solid ${isHustlerQuote ? "#10b981" : "#6b7280"}; background: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s;`;
          const suggestCheckmark = document.createElement("div");
          suggestCheckmark.style.cssText = `width: 12px; height: 12px; border-radius: 50%; background: ${isHustlerQuote ? "#10b981" : "#6b7280"}; display: ${isHustlerQuote ? "block" : "none"};`;
          suggestCheckbox.appendChild(suggestCheckmark);
          
          const suggestPriceText = document.createElement("span");
          suggestPriceText.style.cssText = "font-size: 0.95rem; color: var(--text-main); flex: 1;";
          suggestPriceText.textContent = "Suggest my own price";
          
          suggestPriceLabel.appendChild(suggestCheckbox);
          suggestPriceLabel.appendChild(suggestPriceText);
          priceOptions.appendChild(suggestPriceLabel);
          
          // If hustler quote, auto-select suggest and show input
          if (isHustlerQuote) {
            suggestPriceLabel.style.borderColor = "#10b981";
            proposedPriceContainer.style.display = "block";
          }
          
          suggestPriceLabel.addEventListener("click", () => {
            selectedPriceOption = "suggest";
            suggestCheckmark.style.display = "block";
            suggestCheckbox.style.borderColor = "#10b981";
            if (!isHustlerQuote) {
              const acceptCheckboxEl = document.getElementById(`acceptCheckbox-${job.id}`);
              if (acceptCheckboxEl) {
                const acceptCheckmark = acceptCheckboxEl.querySelector("div");
                if (acceptCheckmark) acceptCheckmark.style.display = "none";
                acceptCheckboxEl.style.borderColor = "#6b7280";
              }
              const acceptPriceLabelEl = priceOptions.querySelector("label:first-child");
              if (acceptPriceLabelEl) acceptPriceLabelEl.style.borderColor = "#d1d5db";
            }
            suggestPriceLabel.style.borderColor = "#10b981";
            proposedPriceContainer.style.display = "block";
            proposedPriceInput.focus();
          });
          
          priceOptionContainer.appendChild(priceOptions);
          priceOptionContainer.appendChild(proposedPriceContainer);
          actionsSection.appendChild(priceOptionContainer);
          
          const applyBtn = document.createElement("button");
          applyBtn.className = "btn btn-primary";
          applyBtn.textContent = "Apply for Job";
          applyBtn.style.cssText = "width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 700; border-radius: 12px;";
          applyBtn.addEventListener("click", async () => {
            const whyFit = whyFitTextarea.value.trim();
            if (!whyFit) {
              showToast("Please explain why you're a good fit for this job.");
              whyFitTextarea.focus();
              return;
            }
            
            // Get selected price option
            let proposedAmount = null;
            
            if (selectedPriceOption === "suggest") {
              const proposedPrice = parseFloat(proposedPriceInput.value);
              if (!proposedPrice || proposedPrice <= 0) {
                showToast("Please enter a valid suggested price.");
                proposedPriceInput.focus();
                return;
              }
              proposedAmount = proposedPrice;
            }
            
            // Get token fresh to ensure it's available
            const authToken = localStorage.getItem('hustl_token');
            if (!authToken) {
              showToast("Please log in to apply for jobs.");
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              setView("login");
              return;
            }
            
            // Disable button during submission
            applyBtn.disabled = true;
            applyBtn.textContent = "Applying...";
            
            try {
              // Submit application directly via API
              const response = await fetch(`${API_BASE}/offers/${job.id}`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${authToken}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  note: whyFit,
                  proposedAmount: proposedAmount
                })
              });
              
              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || errorData.message || 'Failed to submit application');
              }
              
              const result = await response.json();
              
              // Close detail modal
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              
              showToast("✅ Application submitted successfully!");
              
              // Refresh user's applied jobs list and re-render jobs to show "Applied" badge
              try {
                const token = localStorage.getItem('hustl_token');
                if (token) {
                  const offersResponse = await fetch(`${API_BASE}/offers/user/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (offersResponse.ok) {
                    const offers = await offersResponse.json();
                    const relevantOffers = Array.isArray(offers) ? offers.filter(o => o.status === 'PENDING' || o.status === 'ACCEPTED') : [];
                    userAppliedJobIds = new Set(relevantOffers.map(offer => offer.jobId).filter(Boolean));
                    userAppliedOffers.clear();
                    relevantOffers.forEach(offer => {
                      if (offer.jobId) {
                        userAppliedOffers.set(offer.jobId, offer);
                      }
                    });
                  }
                }
              } catch (e) {
                console.warn("Could not refresh applied jobs:", e);
              }
              
              // Re-render jobs to show "Applied" badge
              if (typeof renderJobs === 'function') {
                await renderJobs(false); // Don't reset, just re-render
              }
            } catch (error) {
              console.error("Error submitting application:", error);
              showToast(error.message || "Error submitting application. Please try again.");
              applyBtn.disabled = false;
              applyBtn.textContent = "Apply for Job";
            }
          });
          actionsSection.appendChild(applyBtn);
        } else if (!user && !token) {
          // Not logged in - show login prompt
          const loginPrompt = document.createElement("div");
          loginPrompt.style.cssText = "text-align: center; margin-bottom: 1rem;";
          loginPrompt.innerHTML = '<div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.75rem;">Please log in to apply for this job</div>';
          actionsSection.appendChild(loginPrompt);
          
          const loginBtn = document.createElement("button");
          loginBtn.className = "btn btn-primary";
          loginBtn.textContent = "Log In to Apply";
          loginBtn.style.cssText = "width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 700; border-radius: 12px;";
          loginBtn.addEventListener("click", () => {
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            setView("login");
          });
          actionsSection.appendChild(loginBtn);
        } else {
          const closeBtn2 = document.createElement("button");
          closeBtn2.className = "btn btn-ghost";
          closeBtn2.textContent = "Close";
          closeBtn2.style.cssText = "width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;";
          closeBtn2.addEventListener("click", () => {
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
          });
          actionsSection.appendChild(closeBtn2);
        }
        
        modalContent.appendChild(actionsSection);
        
        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);
        document.body.style.overflow = "hidden";
        
        // Initialize map after modal is added to DOM (pass user location)
        setTimeout(() => {
          initJobDetailMap(job, mapContainer.id, currentUserLocation);
        }, 100);
        
      } catch (error) {
        console.error("Error opening job details:", error);
        showToast("Unable to load job details. Please try again.");
      }
    }
    
    // Initialize map for job detail modal
    function initJobDetailMap(job, containerId, userLoc = null) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      // Use approximate location
      const lat = job.approximateLat !== null && job.approximateLat !== undefined 
        ? parseFloat(job.approximateLat) 
        : (job.lat ? parseFloat(job.lat) : null);
      const lng = job.approximateLng !== null && job.approximateLng !== undefined 
        ? parseFloat(job.approximateLng) 
        : (job.lng ? parseFloat(job.lng) : null);
      
      if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">📍 Location not available</div>';
        return;
      }
      
      const mapboxToken = window.HUSTL_CONFIG?.MAPBOX_TOKEN || window.MAPBOX_TOKEN;
      if (!mapboxToken) {
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Map not available</div>';
        return;
      }
      
      try {
        mapboxgl.accessToken = mapboxToken;
        
        // Center map between job and user location if both available
        let centerLng = lng;
        let centerLat = lat;
        let zoom = 14;
        
        if (userLoc && userLoc.lat && userLoc.lng) {
          // Center between both points
          centerLng = (lng + userLoc.lng) / 2;
          centerLat = (lat + userLoc.lat) / 2;
          zoom = 13; // Zoom out a bit to show both
        }
        
        const map = new mapboxgl.Map({
          container: containerId,
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [centerLng, centerLat],
          zoom: zoom,
          interactive: true
        });
        
        // Store map reference and locations on container element for zoom out button
        const containerElement = document.getElementById(containerId);
        if (containerElement) {
          containerElement._mapboxglMap = map;
          containerElement._jobLocation = { lat, lng };
          containerElement._userLocation = userLoc;
        }
        
        // Add job location marker (blue)
        new mapboxgl.Marker({ color: '#3b82f6' })
          .setLngLat([lng, lat])
          .addTo(map);
        
        // Add user's location marker (red person icon) if available
        if (userLoc && userLoc.lat && userLoc.lng) {
          // Create a custom person icon marker (smaller size)
          const personIcon = document.createElement('div');
          personIcon.style.cssText = 'width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: white; border-radius: 50%; border: 2px solid #dc2626; box-shadow: 0 2px 4px rgba(0,0,0,0.3);';
          personIcon.innerHTML = '👤';
          personIcon.style.fontSize = '16px';
          
          new mapboxgl.Marker({ element: personIcon, anchor: 'center' })
            .setLngLat([userLoc.lng, userLoc.lat])
            .addTo(map);
        }
        
        // Add 0.25 mile radius circle
        const radiusMeters = 402.336; // 0.25 miles
        const circle = createCircle([lng, lat], radiusMeters);
        
        map.on('load', () => {
          const circleId = `detail-circle-${job.id}`;
          map.addSource(circleId, {
            type: 'geojson',
            data: circle
          });
          
          map.addLayer({
            id: circleId,
            type: 'fill',
            source: circleId,
            paint: {
              'fill-color': '#3b82f6',
              'fill-opacity': 0.1
            }
          });
          
          map.addLayer({
            id: `${circleId}-outline`,
            type: 'line',
            source: circleId,
            paint: {
              'line-color': '#3b82f6',
              'line-width': 2,
              'line-opacity': 0.4
            }
          });
        });
        
      } catch (error) {
        console.error("Error initializing job detail map:", error);
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Map unavailable</div>';
      }
    }
    
    // Function is already assigned to window.openJobDetails above

    // Show Hustler Profile Popup - lightweight quick-view
    // Standardized profile popup - works for all users (hustlers, customers, etc.)
    window.showHustlerProfilePopup = async function showHustlerProfilePopup(userId) {
      if (!userId) {
        console.error("No user ID provided");
        return;
      }
      
      // Also support being called with "hustlerId" parameter name for backward compatibility
      const targetUserId = userId;

      try {
        const token = localStorage.getItem("hustl_token");
        
        // Fetch user profile
        const profileResponse = await fetch(`${API_BASE}/users/${targetUserId}`, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        
        if (!profileResponse.ok) {
          showToast("Unable to load profile.");
          return;
        }
        
        const profile = await profileResponse.json();
        
        // Fetch latest 3 reviews
        const reviewsResponse = await fetch(`${API_BASE}/reviews?userId=${targetUserId}&limit=3&offset=0`, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        
        let reviews = [];
        let totalReviews = 0;
        if (reviewsResponse.ok) {
          const reviewsData = await reviewsResponse.json();
          reviews = reviewsData.reviews || [];
          totalReviews = reviewsData.total || 0;
        }
        
        // Create modal overlay
        const modalOverlay = document.createElement("div");
        modalOverlay.id = "hustlerProfileModal";
        modalOverlay.className = "modal-overlay";
        modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;";
        
        const modalContent = document.createElement("div");
        modalContent.className = "modal-content";
        if (window.innerWidth <= 768) {
          modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 100%; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
        } else {
          modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
        }
        // Ensure modal is scrollable
        modalContent.style.overflowY = "auto";
        
        // Close button
        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "×";
        closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10;";
        closeBtn.addEventListener("click", () => {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
        });
        modalContent.appendChild(closeBtn);
        
        // Profile Picture
        const profileSection = document.createElement("div");
        profileSection.style.cssText = "padding: 2rem 1.5rem 1.5rem; text-align: center; border-bottom: 1px solid #e5e7eb;";
        
        const profilePic = document.createElement("img");
        profilePic.style.cssText = "width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block;";
        profilePic.src = profile.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(profile.name || "User") + "&background=6366f1&color=fff&size=128";
        profilePic.alt = profile.name || "Profile";
        profilePic.onerror = function() {
          this.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(profile.name || "User") + "&background=6366f1&color=fff&size=128";
        };
        profileSection.appendChild(profilePic);
        
        // Name
        const name = document.createElement("h2");
        name.style.cssText = "margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);";
        name.textContent = profile.name || "User";
        profileSection.appendChild(name);
        
        // Average Rating
        if (profile.ratingAvg && profile.ratingCount > 0) {
          const rating = document.createElement("div");
          rating.style.cssText = "display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;";
          const stars = "★".repeat(Math.round(profile.ratingAvg));
          rating.innerHTML = `<span style="font-size: 1.1rem; color: #fbbf24;">${stars}</span> <span style="font-size: 1rem; font-weight: 600; color: var(--text-main);">${profile.ratingAvg.toFixed(1)}</span> <span style="font-size: 0.9rem; color: var(--text-muted);">(${profile.ratingCount})</span>`;
          profileSection.appendChild(rating);
        }
        
        modalContent.appendChild(profileSection);
        
        // Bio
        if (profile.bio) {
          const bioSection = document.createElement("div");
          bioSection.style.cssText = "padding: 1.5rem; border-bottom: 1px solid #e5e7eb;";
          const bioTitle = document.createElement("h3");
          bioTitle.style.cssText = "margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; color: var(--text-main);";
          bioTitle.textContent = "About";
          bioSection.appendChild(bioTitle);
          const bio = document.createElement("p");
          bio.style.cssText = "margin: 0; font-size: 0.95rem; color: var(--text-main); line-height: 1.6;";
          bio.textContent = profile.bio;
          bioSection.appendChild(bio);
          modalContent.appendChild(bioSection);
        }
        
        // Gender
        if (profile.gender) {
          const genderSection = document.createElement("div");
          genderSection.style.cssText = "padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.5rem;";
          const genderLabel = document.createElement("span");
          genderLabel.style.cssText = "font-size: 0.9rem; color: var(--text-muted);";
          genderLabel.textContent = "Gender:";
          const genderValue = document.createElement("span");
          genderValue.style.cssText = "font-size: 0.95rem; color: var(--text-main); font-weight: 500;";
          genderValue.textContent = profile.gender;
          genderSection.appendChild(genderLabel);
          genderSection.appendChild(genderValue);
          modalContent.appendChild(genderSection);
        }
        
        // Tools Section (always show, right below gender)
        const toolsSection = document.createElement("div");
        toolsSection.style.cssText = "padding: 1.5rem; border-bottom: 1px solid #e5e7eb;";
        const toolsTitle = document.createElement("h3");
        toolsTitle.style.cssText = "margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; color: var(--text-main);";
        toolsTitle.textContent = "🔧 Tools Available";
        toolsSection.appendChild(toolsTitle);
        
        // Tools is stored as a STRING, not an array
        if (profile.tools && typeof profile.tools === 'string' && profile.tools.trim()) {
          const toolsText = document.createElement("div");
          toolsText.style.cssText = "font-size: 0.95rem; color: var(--text-main); line-height: 1.6; padding: 0.75rem; background: #f9fafb; border-radius: 8px; white-space: pre-wrap;";
          toolsText.textContent = profile.tools.trim();
          toolsSection.appendChild(toolsText);
        } else if (profile.tools && Array.isArray(profile.tools) && profile.tools.length > 0) {
          // Fallback: if it's an array (shouldn't happen, but handle it)
          const toolsList = document.createElement("div");
          toolsList.style.cssText = "display: flex; flex-wrap: wrap; gap: 0.5rem;";
          profile.tools.forEach(tool => {
            const toolChip = document.createElement("span");
            toolChip.style.cssText = "padding: 0.5rem 0.75rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem; color: var(--text-main);";
            toolChip.textContent = tool;
            toolsList.appendChild(toolChip);
          });
          toolsSection.appendChild(toolsList);
        } else {
          const noTools = document.createElement("div");
          noTools.style.cssText = "font-size: 0.9rem; color: var(--text-muted);";
          noTools.textContent = "No tools listed";
          toolsSection.appendChild(noTools);
        }
        modalContent.appendChild(toolsSection);
        
        // Reviews Section
        const reviewsSection = document.createElement("div");
        reviewsSection.style.cssText = "padding: 1.5rem; max-height: 400px; overflow-y: auto;";
        const reviewsTitle = document.createElement("h3");
        reviewsTitle.style.cssText = "margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: var(--text-main);";
        reviewsTitle.textContent = `Reviews (${totalReviews})`;
        reviewsSection.appendChild(reviewsTitle);
        
        // Track current offset for pagination
        let currentOffset = reviews.length;
        let hasMoreReviews = totalReviews > reviews.length;
        console.log('[PROFILE REVIEWS] Initial load - reviews:', reviews.length, 'totalReviews:', totalReviews, 'currentOffset:', currentOffset, 'hasMoreReviews:', hasMoreReviews);
        
        // Helper function to create a review item element (must be accessible to click handler)
        window.createProfileReviewItem = function(review) {
          const reviewItem = document.createElement("div");
          reviewItem.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;";
          
          // Reviewer info
          const reviewerInfo = document.createElement("div");
          reviewerInfo.style.cssText = "display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;";
          
          const reviewerPic = document.createElement("img");
          reviewerPic.style.cssText = "width: 32px; height: 32px; border-radius: 50%; object-fit: cover;";
          reviewerPic.src = review.reviewer?.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(review.reviewer?.name || "User") + "&background=6366f1&color=fff&size=128";
          reviewerPic.alt = review.reviewer?.name || "Reviewer";
          
          const reviewerName = document.createElement("span");
          reviewerName.style.cssText = "font-size: 0.9rem; font-weight: 600; color: var(--text-main);";
          reviewerName.textContent = review.reviewer?.name || "Anonymous";
          
          const reviewStars = document.createElement("span");
          reviewStars.style.cssText = "margin-left: auto; font-size: 0.9rem; color: #fbbf24;";
          reviewStars.textContent = "★".repeat(review.stars || review.rating || 0);
          
          reviewerInfo.appendChild(reviewerPic);
          reviewerInfo.appendChild(reviewerName);
          reviewerInfo.appendChild(reviewStars);
          reviewItem.appendChild(reviewerInfo);
          
          // Review text
          if (review.comment || review.text) {
            const reviewText = document.createElement("p");
            reviewText.style.cssText = "margin: 0; font-size: 0.9rem; color: var(--text-main); line-height: 1.5;";
            reviewText.textContent = review.comment || review.text;
            reviewItem.appendChild(reviewText);
          }
          
          // Job info with tools/equipment
          if (review.job) {
            const jobInfo = document.createElement("div");
            jobInfo.style.cssText = "margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;";
            
            const jobTitle = document.createElement("div");
            jobTitle.style.cssText = "font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;";
            jobTitle.textContent = review.job.title || "Job";
            jobInfo.appendChild(jobTitle);
            
            // Show tools/equipment if available
            const jobRequirements = review.job.requirements || {};
            let parsedReq = jobRequirements;
            if (typeof jobRequirements === 'string') {
              try {
                parsedReq = JSON.parse(jobRequirements);
              } catch (e) {
                parsedReq = {};
              }
            }
            
            let equipmentNeeded = parsedReq.equipmentNeeded || parsedReq.equipment_needed || [];
            let customEquipment = parsedReq.customEquipment || parsedReq.custom_equipment || '';
            
            // Ensure equipmentNeeded is an array
            let equipmentArray = [];
            if (Array.isArray(equipmentNeeded)) {
              equipmentArray = equipmentNeeded;
            } else if (equipmentNeeded && typeof equipmentNeeded === 'string') {
              try {
                const parsed = JSON.parse(equipmentNeeded);
                equipmentArray = Array.isArray(parsed) ? parsed : [parsed];
              } catch (e) {
                equipmentArray = [equipmentNeeded];
              }
            } else if (equipmentNeeded) {
              equipmentArray = [equipmentNeeded];
            }
            
            equipmentArray = equipmentArray.filter(tool => tool && String(tool).trim());
            
            if (equipmentArray.length > 0 || (customEquipment && String(customEquipment).trim())) {
              const toolsLabel = document.createElement("div");
              toolsLabel.style.cssText = "font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 600;";
              toolsLabel.textContent = "🔧 Tools/Equipment:";
              jobInfo.appendChild(toolsLabel);
              
              const toolsList = document.createElement("div");
              toolsList.style.cssText = "display: flex; flex-wrap: wrap; gap: 0.375rem;";
              
              equipmentArray.forEach(tool => {
                const toolStr = String(tool).trim();
                if (toolStr) {
                  const toolChip = document.createElement("span");
                  toolChip.style.cssText = "padding: 0.25rem 0.5rem; background: #f3f4f6; border-radius: 6px; font-size: 0.75rem; color: var(--text-main);";
                  toolChip.textContent = toolStr;
                  toolsList.appendChild(toolChip);
                }
              });
              
              if (customEquipment && String(customEquipment).trim()) {
                const customChip = document.createElement("span");
                customChip.style.cssText = "padding: 0.25rem 0.5rem; background: #f3f4f6; border-radius: 6px; font-size: 0.75rem; color: var(--text-main);";
                customChip.textContent = String(customEquipment).trim();
                toolsList.appendChild(customChip);
              }
              
              if (toolsList.children.length > 0) {
                jobInfo.appendChild(toolsList);
              }
            }
            
            reviewItem.appendChild(jobInfo);
          }
          
          return reviewItem;
        };
        
        // Always create reviewsList container for pagination to work
        const reviewsList = document.createElement("div");
        reviewsList.style.cssText = "display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem;";
        reviewsList.id = "profileReviewsList";
        
        if (reviews.length > 0) {
          reviews.forEach(review => {
            const reviewItem = window.createProfileReviewItem(review);
            reviewsList.appendChild(reviewItem);
          });
        } else {
          const noReviews = document.createElement("div");
          noReviews.style.cssText = "padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;";
          noReviews.textContent = "No reviews yet";
          reviewsList.appendChild(noReviews);
        }
        
        reviewsSection.appendChild(reviewsList);
        
        // Load more reviews button (if more than 3)
        console.log('[PROFILE REVIEWS] Checking if button should show - hasMoreReviews:', hasMoreReviews, 'totalReviews:', totalReviews, 'currentOffset:', currentOffset);
        if (hasMoreReviews) {
          console.log('[PROFILE REVIEWS] Creating Load More button');
          const loadMoreBtn = document.createElement("button");
          loadMoreBtn.className = "btn btn-secondary";
          loadMoreBtn.id = "profileLoadMoreReviewsBtn";
          loadMoreBtn.textContent = `Load more reviews (${totalReviews - currentOffset} more)`;
          loadMoreBtn.style.cssText = "width: 100%; padding: 0.75rem; font-size: 0.95rem; margin-top: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;";
          loadMoreBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('[PROFILE REVIEWS] Load More button clicked! currentOffset:', currentOffset);
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = "Loading...";
            
            try {
              // Calculate how many reviews are remaining
              const remaining = totalReviews - currentOffset;
              const limitToLoad = Math.min(remaining, 6); // Load up to 6, or remaining if less
              console.log('[PROFILE REVIEWS] Calling loadUserReviews with:', targetUserId, limitToLoad, currentOffset, 'remaining:', remaining);
              const result = await window.loadUserReviews(targetUserId, limitToLoad, currentOffset);
              console.log('[PROFILE REVIEWS] Got result:', result);
              
              if (result.reviews && result.reviews.length > 0) {
                // Find the reviewsList - make sure we're getting the right one
                const modal = document.getElementById("hustlerProfileModal");
                const reviewsList = modal ? modal.querySelector("#profileReviewsList") : document.getElementById("profileReviewsList");
                console.log('[PROFILE REVIEWS] reviewsList element:', reviewsList ? 'found' : 'NOT FOUND', 'modal:', modal ? 'found' : 'NOT FOUND');
                if (reviewsList) {
                  console.log('[PROFILE REVIEWS] Current list has', reviewsList.children.length, 'children before adding new reviews');
                  // Log all current children to see what's there
                  console.log('[PROFILE REVIEWS] Current children:', Array.from(reviewsList.children).map(c => c.tagName + (c.textContent ? ' - ' + c.textContent.substring(0, 50) : '')));
                  // Remove "No reviews yet" message if it exists
                  const noReviewsMsg = reviewsList.querySelector('div[style*="No reviews yet"]');
                  if (noReviewsMsg) {
                    console.log('[PROFILE REVIEWS] Removing "No reviews yet" message');
                    noReviewsMsg.remove();
                  }
                  
                  let firstNewReview = null;
                  console.log('[PROFILE REVIEWS] Appending', result.reviews.length, 'new reviews');
                  console.log('[PROFILE REVIEWS] createProfileReviewItem available:', typeof window.createProfileReviewItem);
                  result.reviews.forEach((review, index) => {
                    if (!window.createProfileReviewItem) {
                      console.error('[PROFILE REVIEWS] createProfileReviewItem not found!');
                      return;
                    }
                    console.log(`[PROFILE REVIEWS] Creating review item ${index + 1} of ${result.reviews.length}`);
                    const reviewItem = window.createProfileReviewItem(review);
                    console.log('[PROFILE REVIEWS] Review item created:', reviewItem ? 'yes' : 'no');
                    reviewsList.appendChild(reviewItem);
                    console.log('[PROFILE REVIEWS] Review item appended. List now has', reviewsList.children.length, 'children');
                    if (!firstNewReview) {
                      firstNewReview = reviewItem;
                    }
                  });
                  console.log('[PROFILE REVIEWS] Final list has', reviewsList.children.length, 'children after all appends');
                  
                  // Scroll to show newly loaded reviews
                  setTimeout(() => {
                    if (firstNewReview) {
                      firstNewReview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    // Also scroll the reviews section to show new content
                    const reviewsSection = reviewsList.closest('div[style*="padding: 1.5rem"]');
                    if (reviewsSection) {
                      reviewsSection.scrollTop = reviewsSection.scrollHeight;
                    }
                  }, 150);
                }
                
                currentOffset += result.reviews.length;
                hasMoreReviews = result.hasMore && (currentOffset < result.total);
                console.log('[PROFILE REVIEWS] Updated - currentOffset:', currentOffset, 'hasMoreReviews:', hasMoreReviews, 'result.total:', result.total);
                
                if (hasMoreReviews) {
                  loadMoreBtn.disabled = false;
                  loadMoreBtn.textContent = `Load more reviews (${result.total - currentOffset} more)`;
                  console.log('[PROFILE REVIEWS] Button updated, remaining:', result.total - currentOffset);
                } else {
                  console.log('[PROFILE REVIEWS] No more reviews, removing button');
                  loadMoreBtn.remove();
                }
              } else {
                console.log('[PROFILE REVIEWS] No reviews in result, removing button');
                loadMoreBtn.remove();
              }
            } catch (error) {
              console.error("Error loading more reviews:", error);
              showToast("Failed to load more reviews. Please try again.");
              loadMoreBtn.disabled = false;
              loadMoreBtn.textContent = `Load more reviews (${totalReviews - currentOffset} more)`;
            }
          });
          reviewsSection.appendChild(loadMoreBtn);
        }
        
        modalContent.appendChild(reviewsSection);
        
        modalOverlay.appendChild(modalContent);
        document.body.appendChild(modalOverlay);
        document.body.style.overflow = "hidden";
        
        // Close on overlay click
        modalOverlay.addEventListener("click", (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            // Clear flags when closing
            window._viewingFromPostedTab = false;
            window._currentViewingOffer = null;
          }
        });
        
      } catch (error) {
        console.error("Error showing hustler profile:", error);
        showToast("Unable to load profile.");
      }
    };

    // Show "Apply for Job" popup modal
    async function showApplyJobModal(job) {
      const user = getCurrentUser();
      if (!user) {
        showToast("Please log in to apply for jobs.");
        return;
      }

      // Check if already applied
      let hasApplied = false;
      try {
        const token = localStorage.getItem("hustl_token");
        const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        if (offersResponse.ok) {
          const offers = await offersResponse.json();
          hasApplied = Array.isArray(offers) && offers.some(o => o.hustlerId === user.id);
        }
      } catch (e) {
        console.error("Error checking applications:", e);
      }

      if (hasApplied) {
        showToast("You've already applied for this job.");
        return;
      }

      // Check Stripe connection
      const hasStripe = user.stripeAccountId && user.stripePayoutsEnabled;

      // Create modal overlay
      const modalOverlay = document.createElement("div");
      modalOverlay.id = "applyJobModal";
      modalOverlay.className = "modal-overlay";
      modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
      
      const modalContent = document.createElement("div");
      modalContent.className = "modal-content";
      modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";

      // Close button
      const closeBtn = document.createElement("button");
      closeBtn.innerHTML = "×";
      closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10;";
      closeBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });

      // Job Summary Section
      const jobSummary = document.createElement("div");
      jobSummary.style.cssText = "padding: 1.5rem; border-bottom: 1px solid #e5e7eb;";
      
      const jobTitle = document.createElement("h2");
      jobTitle.style.cssText = "margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);";
      jobTitle.textContent = "Apply for This Job";
      jobSummary.appendChild(jobTitle);

      // Get requirements for additional fields
      const requirements = job.requirements || {};
      const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
      const rawTeamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
      const teamSize = typeof rawTeamSize === 'string' ? parseInt(rawTeamSize, 10) : Number(rawTeamSize) || 1;
      const pricingOption = requirements.pricing_option;
      
      // Format location - use formatPublicLocation and formatDropoffLocation
      const hidePickupAddressUntilAssigned = requirements.hide_pickup_address_until_assigned || requirements.hidePickupAddressUntilAssigned;
      const hideDropoffAddressUntilAssigned = requirements.hide_dropoff_address_until_assigned || requirements.hideDropoffAddressUntilAssigned;
      let showExactAddress = false;
      
      // Check if user is assigned hustler (can see exact address)
      if (hidePickupAddressUntilAssigned || hideDropoffAddressUntilAssigned) {
        try {
          const user = window.hustlAPI?.auth?.getCurrentUserSync?.() || (window.currentUser || null);
          if (user) {
            const isAssignedHustler = job.hustlerId && job.hustlerId === user.id && 
                               (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'IN_PROGRESS');
            showExactAddress = isAssignedHustler;
          }
        } catch (e) {
          showExactAddress = false;
        }
      }
      
      let locationDisplay = formatPublicLocation(job, requirements, showExactAddress);
      const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
      
      // Handle dropoff for multi-location jobs - use formatDropoffLocation
      if (!onSiteOnly) {
        const dropoffLocationText = formatDropoffLocation(job, requirements, showExactAddress);
        if (dropoffLocationText && dropoffLocationText !== 'Location TBD') {
          locationDisplay += ` → ${dropoffLocationText}`;
        }
      } else if (onSiteOnly) {
        locationDisplay += ' (Single location)';
      }
      
      // Format timing
      let timingDisplay = '';
      if (deadlinePreference === 'until_completed') {
        timingDisplay = 'Until completed (no strict deadline)';
      } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
        timingDisplay = 'Flexible this week';
      } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
        timingDisplay = 'Today – ASAP';
      } else if (deadlinePreference === 'tomorrow') {
        timingDisplay = 'Tomorrow';
      } else if (job.startTime) {
        const deadlineDate = new Date(job.startTime);
        timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } else {
        timingDisplay = 'Not specified';
      }
      
      // Format price
      const jobAmount = Number(job.amount) || 0;
      const jobHourlyRate = Number(job.hourlyRate) || 0;
      let price = '';
      if (pricingOption === 'hustlers_quote') {
        price = 'Hustler suggests price';
      } else if (job.payType === "flat" || job.paymentType === "flat") {
        price = `$${jobAmount.toFixed(2)} flat`;
      } else if (jobHourlyRate > 0) {
        price = `$${jobHourlyRate.toFixed(2)}/hr${job.estHours ? ` (max ${job.estHours} hrs)` : ''}`;
      } else {
        price = `$${jobAmount.toFixed(2)}`;
      }
      
      // Format workers
      let workersDisplay = '';
      if (teamSize === 0) {
        workersDisplay = 'Company/crew job';
      } else if (teamSize === 1) {
        workersDisplay = '1 worker';
      } else {
        workersDisplay = `${teamSize} workers needed`;
      }

      const summaryInfo = document.createElement("div");
      summaryInfo.style.cssText = "display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.9rem; color: var(--text-muted);";
      
      const jobTitleRow = document.createElement("div");
      jobTitleRow.style.cssText = "font-weight: 600; color: var(--text-main); font-size: 1rem;";
      jobTitleRow.innerHTML = `<strong>Job:</strong> ${job.title || 'Untitled Job'}`;
      summaryInfo.appendChild(jobTitleRow);

      const timingRow = document.createElement("div");
      timingRow.innerHTML = `<strong>⏰ Timing:</strong> ${timingDisplay}`;
      summaryInfo.appendChild(timingRow);

      const locationRow = document.createElement("div");
      locationRow.innerHTML = `<strong>📍 Location:</strong> ${locationDisplay}`;
      summaryInfo.appendChild(locationRow);

      const workersRow = document.createElement("div");
      workersRow.innerHTML = `<strong>👥 Workers:</strong> ${workersDisplay}`;
      summaryInfo.appendChild(workersRow);

      const priceRow = document.createElement("div");
      priceRow.style.cssText = "font-weight: 600; color: var(--primary); font-size: 1rem;";
      priceRow.innerHTML = `<strong>💰 Price:</strong> ${price}`;
      summaryInfo.appendChild(priceRow);

      if (job.date) {
        const dateRow = document.createElement("div");
        const jobDate = new Date(job.date);
        dateRow.innerHTML = `<strong>📅 Scheduled:</strong> ${jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        summaryInfo.appendChild(dateRow);
      }
      
      if (requirements.notes) {
        const notesRow = document.createElement("div");
        notesRow.style.cssText = "padding: 0.75rem; background: #fef3c7; border-radius: 8px; margin-top: 0.5rem;";
        notesRow.innerHTML = `<strong>📝 Notes:</strong><br><span style="font-size: 0.85rem;">${requirements.notes}</span>`;
        summaryInfo.appendChild(notesRow);
      }

      jobSummary.appendChild(summaryInfo);
      modalContent.appendChild(jobSummary);

      // Form Section
      const formSection = document.createElement("div");
      formSection.style.cssText = "padding: 1.5rem;";

      // Why are you a good fit
      const whyFitLabel = document.createElement("label");
      whyFitLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      whyFitLabel.innerHTML = "Why Are You a Good Fit? <span style='color: #ef4444;'>*</span>";
      formSection.appendChild(whyFitLabel);

      const whyFitTextarea = document.createElement("textarea");
      whyFitTextarea.id = "applyWhyFit";
      whyFitTextarea.placeholder = "Write a short message...";
      whyFitTextarea.maxLength = 500;
      whyFitTextarea.rows = 5;
      whyFitTextarea.style.cssText = "width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical; margin-bottom: 0.5rem;";
      // Pre-fill if coming from job detail modal
      if (job._prefilledWhyFit) {
        whyFitTextarea.value = job._prefilledWhyFit;
      }
      formSection.appendChild(whyFitTextarea);

      const charCount = document.createElement("div");
      charCount.style.cssText = "font-size: 0.75rem; color: #6b7280; text-align: right; margin-bottom: 1rem;";
      charCount.textContent = `${whyFitTextarea.value.length} / 500 characters`;
      formSection.appendChild(charCount);

      whyFitTextarea.addEventListener("input", () => {
        charCount.textContent = `${whyFitTextarea.value.length} / 500 characters`;
      });

      // Price Negotiation Section
      const priceSection = document.createElement("div");
      priceSection.style.cssText = "margin-bottom: 1rem;";
      
      const priceLabel = document.createElement("label");
      priceLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      priceLabel.textContent = "Price";
      formSection.appendChild(priceLabel);

      const priceOptions = document.createElement("div");
      priceOptions.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;";
      
      // Accept listed price option
      const acceptPriceLabel = document.createElement("label");
      acceptPriceLabel.style.cssText = "display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;";
      
      // Check if prefilled proposed amount exists (from job detail modal)
      const hasPrefilledPrice = job._prefilledProposedAmount && job._prefilledProposedAmount > 0;
      
      const acceptPriceRadio = document.createElement("input");
      acceptPriceRadio.type = "radio";
      acceptPriceRadio.name = "priceOption";
      acceptPriceRadio.value = "accept";
      acceptPriceRadio.checked = !hasPrefilledPrice; // Check accept if no prefilled price
      acceptPriceRadio.style.accentColor = "var(--primary)";
      
      const acceptPriceText = document.createElement("span");
      acceptPriceText.textContent = `Accept listed price: ${price}`;
      acceptPriceLabel.appendChild(acceptPriceRadio);
      acceptPriceLabel.appendChild(acceptPriceText);
      priceOptions.appendChild(acceptPriceLabel);

      // Negotiate price option
      const negotiatePriceLabel = document.createElement("label");
      negotiatePriceLabel.style.cssText = "display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;";
      
      const negotiatePriceRadio = document.createElement("input");
      negotiatePriceRadio.type = "radio";
      negotiatePriceRadio.name = "priceOption";
      negotiatePriceRadio.value = "negotiate";
      negotiatePriceRadio.checked = hasPrefilledPrice; // Check negotiate if prefilled price exists
      negotiatePriceRadio.style.accentColor = "var(--primary)";
      
      const negotiatePriceText = document.createElement("span");
      negotiatePriceText.textContent = "Propose a different price";
      negotiatePriceLabel.appendChild(negotiatePriceRadio);
      negotiatePriceLabel.appendChild(negotiatePriceText);
      priceOptions.appendChild(negotiatePriceLabel);

      formSection.appendChild(priceOptions);

      // Proposed price input (shown when negotiate is selected)
      const proposedPriceContainer = document.createElement("div");
      proposedPriceContainer.id = "proposedPriceContainer";
      proposedPriceContainer.style.cssText = hasPrefilledPrice ? "display: block; margin-bottom: 1rem;" : "display: none; margin-bottom: 1rem;";
      
      const proposedPriceLabel = document.createElement("label");
      proposedPriceLabel.style.cssText = "display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      proposedPriceLabel.textContent = "Your Proposed Price";
      proposedPriceContainer.appendChild(proposedPriceLabel);

      const proposedPriceInput = document.createElement("input");
      proposedPriceInput.type = "number";
      proposedPriceInput.id = "proposedPriceInput";
      proposedPriceInput.min = "1";
      proposedPriceInput.step = "0.01";
      proposedPriceInput.placeholder = job.payType === "hourly" ? "Enter hourly rate" : "Enter total amount";
      proposedPriceInput.style.cssText = "width: 100%; padding: 1.25rem; border: 2px solid var(--primary); border-radius: 10px; font-size: 1.25rem; font-weight: 600; text-align: center; background: #f0fdf4; min-height: 50px; box-sizing: border-box;";
      // Pre-fill if coming from job detail modal
      if (hasPrefilledPrice) {
        proposedPriceInput.value = job._prefilledProposedAmount;
      }
      proposedPriceContainer.appendChild(proposedPriceInput);

      const priceTypeLabel = document.createElement("div");
      priceTypeLabel.style.cssText = "margin-top: 0.25rem; font-size: 0.75rem; color: #6b7280;";
      priceTypeLabel.textContent = job.payType === "hourly" ? "Per hour" : "Total amount";
      proposedPriceContainer.appendChild(priceTypeLabel);

      formSection.appendChild(proposedPriceContainer);

      // Show/hide proposed price input based on radio selection
      const priceRadios = [acceptPriceRadio, negotiatePriceRadio];
      priceRadios.forEach(radio => {
        radio.addEventListener("change", (e) => {
          const isNegotiate = e.target.value === "negotiate";
          proposedPriceContainer.style.display = isNegotiate ? "block" : "none";
          if (isNegotiate) {
            // Focus and set default value when showing
            setTimeout(() => {
              proposedPriceInput.focus();
              // Set default value to job amount if empty
              if (!proposedPriceInput.value) {
                const defaultAmount = job.payType === "hourly" ? (job.hourlyRate || job.amount || 0) : (job.amount || 0);
                proposedPriceInput.value = defaultAmount > 0 ? defaultAmount.toString() : '';
              }
            }, 100);
          } else {
            proposedPriceInput.value = "";
          }
        });
      });
      
      // Also handle clicks on the label containers
      negotiatePriceLabel.addEventListener("click", (e) => {
        if (e.target !== negotiatePriceRadio && e.target !== negotiatePriceText) {
          negotiatePriceRadio.checked = true;
          negotiatePriceRadio.dispatchEvent(new Event('change'));
        }
      });

      // Optional Add-Ons
      const addOnsLabel = document.createElement("label");
      addOnsLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      addOnsLabel.textContent = "Optional Add-Ons";
      formSection.appendChild(addOnsLabel);

      const addOnsContainer = document.createElement("div");
      addOnsContainer.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;";
      
      const addOns = [
        { value: "truck", label: "🚚 I have my own truck" },
        { value: "helper", label: "👥 I can bring another helper" },
        { value: "same_day", label: "⚡ I can come same-day" }
      ];

      addOns.forEach(addon => {
        const label = document.createElement("label");
        label.style.cssText = "display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "applyAddOns";
        checkbox.value = addon.value;
        checkbox.style.cssText = "width: 20px; height: 20px; min-width: 20px; min-height: 20px; margin: 0; padding: 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;";
        
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(addon.label));
        addOnsContainer.appendChild(label);
      });

      formSection.appendChild(addOnsContainer);

      // Stripe Requirement
      const stripeSection = document.createElement("div");
      stripeSection.style.cssText = "padding: 1rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fbbf24; margin-bottom: 1rem;";
      
      const stripeNote = document.createElement("div");
      stripeNote.style.cssText = "font-size: 0.85rem; color: #92400e; margin-bottom: 0.75rem;";
      stripeNote.textContent = "Note: You must have a connected Stripe account to apply for jobs.";
      stripeSection.appendChild(stripeNote);

      if (!hasStripe) {
        const connectStripeBtn = document.createElement("button");
        connectStripeBtn.className = "btn btn-primary";
        connectStripeBtn.textContent = "Connect Stripe to Apply";
        connectStripeBtn.style.cssText = "width: 100%; padding: 0.75rem;";
        connectStripeBtn.addEventListener("click", () => {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
          setView("profile");
          // Scroll to Stripe section
          setTimeout(() => {
            const stripeSection = document.querySelector('[style*="Stripe"]');
            if (stripeSection) {
              stripeSection.scrollIntoView({ behavior: 'smooth' });
            }
          }, 300);
        });
        stripeSection.appendChild(connectStripeBtn);
      } else {
        const stripeConnected = document.createElement("div");
        stripeConnected.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #059669;";
        stripeConnected.innerHTML = "✅ Stripe account connected";
        stripeSection.appendChild(stripeConnected);
      }

      formSection.appendChild(stripeSection);

      // Buttons
      const buttonsContainer = document.createElement("div");
      buttonsContainer.style.cssText = "display: flex; gap: 0.75rem; margin-top: 1.5rem;";

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "btn btn-ghost";
      cancelBtn.textContent = "Cancel";
      cancelBtn.style.cssText = "flex: 1; padding: 0.75rem;";
      cancelBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });
      buttonsContainer.appendChild(cancelBtn);

      const submitBtn = document.createElement("button");
      submitBtn.className = "btn btn-primary";
      submitBtn.textContent = "Submit Application";
      submitBtn.style.cssText = "flex: 1; padding: 0.75rem;";
      submitBtn.disabled = !hasStripe;
      
      if (!hasStripe) {
        submitBtn.style.opacity = "0.5";
        submitBtn.style.cursor = "not-allowed";
      }

      submitBtn.addEventListener("click", async () => {
        if (!hasStripe) {
          showToast("Please connect your Stripe account first.");
          return;
        }

        const whyFit = whyFitTextarea.value.trim();
        if (!whyFit) {
          showToast("Please explain why you're a good fit for this job.");
          whyFitTextarea.focus();
          return;
        }

        // Get price option
        const selectedPriceOption = document.querySelector('input[name="priceOption"]:checked')?.value || "accept";
        let proposedAmount = null;
        
        if (selectedPriceOption === "negotiate") {
          const proposedPrice = parseFloat(proposedPriceInput.value);
          if (!proposedPrice || proposedPrice <= 0) {
            showToast("Please enter a valid proposed price.");
            proposedPriceInput.focus();
            return;
          }
          proposedAmount = proposedPrice;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></span> Submitting...';
        
        try {
          // Collect add-ons
          const addOnsChecked = Array.from(document.querySelectorAll('input[name="applyAddOns"]:checked')).map(cb => cb.value);
          
          // Submit application
          const token = localStorage.getItem("hustl_token");
          const offerData = {
            jobId: job.id,
            note: whyFit,
            addOns: addOnsChecked
          };
          
          // Add proposed amount if negotiating
          if (proposedAmount !== null) {
            offerData.proposedAmount = proposedAmount;
          }
          
          const response = await fetch(`${API_BASE}/offers`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(offerData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to submit application');
          }

          // Success - close application modal
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
          
          // Show success confirmation modal
          const successOverlay = document.createElement("div");
          successOverlay.className = "modal-overlay";
          successOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
          
          const successModal = document.createElement("div");
          successModal.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
          
          successModal.innerHTML = `
            <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
            <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Application Sent!</h2>
            <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
              You've successfully applied to this job.<br>
              The customer will review your proposal and respond soon.
            </p>
            <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem;">
              You can manage this application in:<br>
              <strong style="color: var(--text-main);">Manage → Applied Jobs</strong>
            </p>
            <button class="btn btn-primary" id="gotItBtn" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
              Got it
            </button>
          `;
          
          successOverlay.appendChild(successModal);
          document.body.appendChild(successOverlay);
          
          // Handle "Got it" button - navigate to Applied Jobs tab
          successOverlay.querySelector('#gotItBtn').addEventListener('click', () => {
            document.body.removeChild(successOverlay);
            document.body.style.overflow = "";
            
            // Navigate to Manage Jobs → Applied Jobs tab
            setView('manage');
            setTimeout(() => {
              const appliedTab = document.getElementById('appliedJobsTab');
              if (appliedTab) {
                appliedTab.click();
                // Load applied jobs
                if (typeof loadAppliedJobs === 'function') {
                  loadAppliedJobs();
                }
              }
            }, 100);
          });
          
          // Also allow clicking outside to close
          successOverlay.addEventListener('click', (e) => {
            if (e.target === successOverlay) {
              document.body.removeChild(successOverlay);
              document.body.style.overflow = "";
              // Still navigate to Applied Jobs
              setView('manage');
              setTimeout(() => {
                const appliedTab = document.getElementById('appliedJobsTab');
                if (appliedTab) {
                  appliedTab.click();
                  if (typeof loadAppliedJobs === 'function') {
                    loadAppliedJobs();
                  }
                }
              }, 100);
            }
          });
          
          // Refresh jobs list
          renderJobs();
        } catch (error) {
          console.error("Error submitting application:", error);
          showToast("Failed to submit application: " + (error.message || "Unknown error"));
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Application";
        }
      });

      buttonsContainer.appendChild(submitBtn);
      formSection.appendChild(buttonsContainer);

      modalContent.appendChild(closeBtn);
      modalContent.appendChild(formSection);
      modalOverlay.appendChild(modalContent);
      
      // Close on overlay click
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
        }
      });

      document.body.appendChild(modalOverlay);
      document.body.style.overflow = "hidden";
      
      // Focus on textarea
      setTimeout(() => {
        whyFitTextarea.focus();
      }, 100);
    }

    // Show Stripe Payment Modal for accepting hustler
    async function showStripePaymentModal(clientSecret, jobId, onSuccessCallback, amountBreakdown = null) {
      // Check if Stripe.js is loaded
      if (typeof Stripe === 'undefined') {
        showToast("Payment system loading... Please try again in a moment.");
        return;
      }

      // Fetch Stripe publishable key from API
      let publishableKey = null;
      try {
        const configResponse = await fetch(`${API_BASE}/payments/config`);
        if (configResponse.ok) {
          const config = await configResponse.json();
          publishableKey = config.publishableKey;
        }
      } catch (e) {
        console.error("Error fetching Stripe config:", e);
      }

      if (!publishableKey) {
        showToast("Payment system not configured. Please contact support.");
        return;
      }

      // Use amount breakdown from payment intent if provided, otherwise fetch from job
      let jobAmount = 0;
      let customerFee = 0;
      let totalAmount = 0;
      
      console.log('[PAYMENT MODAL] amountBreakdown received:', amountBreakdown);
      
      if (amountBreakdown && typeof amountBreakdown === 'object' && amountBreakdown.jobAmount !== undefined) {
        // Use amounts from payment intent (most accurate)
        jobAmount = Number(amountBreakdown.jobAmount);
        customerFee = Number(amountBreakdown.customerFee);
        totalAmount = Number(amountBreakdown.total);
        console.log('[PAYMENT MODAL] ✅ Using amounts from payment intent:', { jobAmount, customerFee, totalAmount });
      } else {
        // Fallback: fetch from job (may be stale)
        console.warn('[PAYMENT MODAL] ⚠️ No amount breakdown provided, fetching from job (may be incorrect)');
        try {
          const token = localStorage.getItem('hustl_token');
          const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
          });
          if (jobResponse.ok) {
            const job = await jobResponse.json();
            if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
              jobAmount = Number(job.hourlyRate) * parseInt(job.estHours);
            } else {
              jobAmount = Number(job.amount) || 0;
            }
            customerFee = jobAmount * 0.065;
            totalAmount = jobAmount + customerFee;
            console.log('[PAYMENT MODAL] ⚠️ Using amounts from job fetch (fallback):', { jobAmount, customerFee, totalAmount, jobAmountFromDB: job.amount });
          }
        } catch (e) {
          console.error("Error fetching job details:", e);
        }
      }

      const stripe = Stripe(publishableKey);
      
      const modalOverlay = document.createElement("div");
      modalOverlay.id = "stripePaymentModal";
      modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;";
      
      const modalContent = document.createElement("div");
      modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 480px; width: 100%; max-height: 90vh; padding: 1.5rem; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); overflow-y: auto; margin: auto;";
      
      const closeBtn = document.createElement("button");
      closeBtn.innerHTML = "×";
      closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10;";
      closeBtn.addEventListener("click", () => {
        if (modalOverlay.parentNode) {
          document.body.removeChild(modalOverlay);
        }
        document.body.style.overflow = "";
      });
      modalContent.appendChild(closeBtn);
      
      const title = document.createElement("h2");
      title.style.cssText = "margin: 0 0 1rem 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);";
      title.textContent = "Complete Payment";
      modalContent.appendChild(title);
      
      // Payment breakdown
      if (totalAmount > 0) {
        const breakdownDiv = document.createElement("div");
        breakdownDiv.style.cssText = "background: #f9fafb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;";
        breakdownDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: #6b7280;">
            <span>Job Amount:</span>
            <span>$${jobAmount.toFixed(2)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem; color: #6b7280;">
            <span>Service Fee (6.5%):</span>
            <span>$${customerFee.toFixed(2)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 1rem; font-weight: 600; color: var(--text-main); padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
            <span>Total:</span>
            <span>$${totalAmount.toFixed(2)}</span>
          </div>
        `;
        modalContent.appendChild(breakdownDiv);
      }
      
      // Refund policy notice - check if hourly job
      let isHourlyJob = false;
      let hourlyRate = 0;
      let estHours = 0;
      try {
        const token = localStorage.getItem('hustl_token');
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (jobResponse.ok) {
          const job = await jobResponse.json();
          isHourlyJob = job.payType === 'hourly';
          hourlyRate = Number(job.hourlyRate || 0);
          estHours = parseInt(job.estHours || 0);
        }
      } catch (e) {
        console.error("Error fetching job for refund notice:", e);
      }
      
      const refundNotice = document.createElement("div");
      refundNotice.style.cssText = "padding: 0.75rem; background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; color: #1e40af; line-height: 1.5;";
      refundNotice.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 0.25rem;">🛡️ Fully Refundable</div>
        <div>${isHourlyJob ? `For hourly jobs, any hours and money not used will be automatically refunded back to you. Your payment is fully refundable until the hustler enters the start code. Once work begins, payment is held in escrow until job completion.` : `Your payment is fully refundable until the hustler enters the start code. Once work begins, payment is held in escrow until job completion.`}</div>
      `;
      modalContent.appendChild(refundNotice);
      
      // Add test mode indicator and test card instructions
      const isTestMode = publishableKey && publishableKey.startsWith('pk_test_');
      if (isTestMode) {
        const testModeNotice = document.createElement("div");
        testModeNotice.style.cssText = "padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; margin-bottom: 1rem; font-size: 0.8rem;";
        testModeNotice.innerHTML = `
          <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">🧪 Test Mode</div>
          <div style="color: #78350f; line-height: 1.4;">
            <strong>Test Card:</strong> <code style="background: white; padding: 2px 6px; border-radius: 4px;">4242 4242 4242 4242</code><br>
            Use any future expiry (12/34) and any CVC (123)
          </div>
        `;
        modalContent.appendChild(testModeNotice);
      }
      
      const paymentElement = document.createElement("div");
      paymentElement.id = "stripe-payment-element";
      paymentElement.style.cssText = "margin-bottom: 1rem;";
      modalContent.appendChild(paymentElement);
      
      const submitBtn = document.createElement("button");
      submitBtn.className = "btn btn-primary";
      submitBtn.textContent = totalAmount > 0 ? `Pay $${totalAmount.toFixed(2)} & Accept` : "Pay & Accept Hustler";
      submitBtn.style.cssText = "width: 100%; padding: 0.875rem; margin-top: 0.5rem; font-size: 0.95rem; font-weight: 600;";
      submitBtn.disabled = true;
      modalContent.appendChild(submitBtn);
      
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);
      document.body.style.overflow = "hidden";
      
      // Initialize Stripe Elements
      const elements = stripe.elements({ 
        clientSecret,
        appearance: {
          theme: 'stripe',
        }
      });
      const paymentElementInstance = elements.create('payment', {
        layout: 'tabs'
      });
      
      let mounted = false;
      paymentElementInstance.mount('#stripe-payment-element');
      
      paymentElementInstance.on('ready', () => {
        mounted = true;
        submitBtn.disabled = false;
      });
      
      paymentElementInstance.on('loading', () => {
        submitBtn.disabled = true;
        submitBtn.textContent = "Loading...";
      });
      
      paymentElementInstance.on('change', (event) => {
        if (event.complete && mounted) {
          submitBtn.disabled = false;
        }
      });
      
      submitBtn.addEventListener("click", async () => {
        if (!mounted) {
          showToast("Payment form is still loading. Please wait...");
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";
        
        try {
          const { error, paymentIntent } = await stripe.confirmPayment({
            elements,
            confirmParams: {
              return_url: `${window.location.origin}/?payment_success=true&jobId=${jobId}`
            },
            redirect: 'if_required'
          });
          
          if (error) {
            showToast("Payment failed: " + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = totalAmount > 0 ? `Pay $${totalAmount.toFixed(2)} & Accept` : "Pay & Accept Hustler";
          } else if (paymentIntent && (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_capture')) {
            // Payment succeeded or is pre-authorized (held in escrow)
            showToast("✅ Payment successful! Processing...");
            if (modalOverlay.parentNode) {
              document.body.removeChild(modalOverlay);
            }
            document.body.style.overflow = "";
            
            // Call the callback with paymentIntentId if provided
            if (onSuccessCallback && typeof onSuccessCallback === 'function') {
              await onSuccessCallback(paymentIntent.id);
            } else {
              // Default behavior: refresh job details
              openJobDetails(jobId);
              renderJobs();
            }
          }
        } catch (err) {
          console.error("Payment error:", err);
          showToast("Payment error: " + (err.message || "Unknown error"));
          submitBtn.disabled = false;
          submitBtn.textContent = totalAmount > 0 ? `Pay $${totalAmount.toFixed(2)} & Accept` : "Pay & Accept Hustler";
        }
      });
      
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          if (modalOverlay.parentNode) {
            document.body.removeChild(modalOverlay);
          }
          document.body.style.overflow = "";
        }
      });
    }

    async function openJobDetails(jobId, options = {}) {
      // Try to find job in state.jobs first, then allLoadedJobs
      let job = state.jobs.find((j) => j.id === jobId);
      if (!job && typeof allLoadedJobs !== 'undefined' && Array.isArray(allLoadedJobs)) {
        job = allLoadedJobs.find((j) => j.id === jobId);
      }
      
      // If still not found, try to fetch from API
      if (!job) {
        try {
          const token = localStorage.getItem("hustl_token");
          const response = await fetch(`${BACKEND_URL}/api/jobs/${jobId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (response.ok) {
            job = await response.json();
            // Add to state for future use
            if (job && !state.jobs.find(j => j.id === jobId)) {
              state.jobs.push(job);
            }
          }
        } catch (error) {
          console.error("Error fetching job details:", error);
        }
      }
      
      const user = getCurrentUser();
      if (!job) {
        console.error("Job not found:", jobId);
        showToast("Job not found. Please try again.");
        return;
      }

      // Create modal overlay - CENTERED
      let modalOverlay = document.getElementById("jobDetailModal");
      if (modalOverlay) {
        document.body.removeChild(modalOverlay);
      }
      
      modalOverlay = document.createElement("div");
      modalOverlay.id = "jobDetailModal";
      modalOverlay.className = "modal-overlay";
      modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;";
      // Mobile-specific padding
      if (window.innerWidth <= 768) {
        modalOverlay.style.padding = "0.5rem";
        modalOverlay.style.alignItems = "flex-start";
        modalOverlay.style.paddingTop = "2rem";
      }
      document.body.appendChild(modalOverlay);
      
      const modalContent = document.createElement("div");
      modalContent.className = "modal-content";
      modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 95vh; height: 95vh; overflow: hidden; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); margin: auto; display: flex; flex-direction: column;";
      // Mobile-specific styling
      if (window.innerWidth <= 768) {
        modalContent.style.maxHeight = "95vh";
        modalContent.style.height = "auto";
        modalContent.style.borderRadius = "16px 16px 0 0";
        modalContent.style.maxWidth = "100%";
      }
      
      // Close button (X) - top right
      const closeBtn = document.createElement("button");
      closeBtn.innerHTML = "×";
      closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10; transition: all 0.2s;";
      closeBtn.addEventListener("mouseenter", () => {
        closeBtn.style.background = "#e5e7eb";
        closeBtn.style.color = "#374151";
      });
      closeBtn.addEventListener("mouseleave", () => {
        closeBtn.style.background = "#f3f4f6";
        closeBtn.style.color = "#6b7280";
      });
      closeBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });
      modalContent.appendChild(closeBtn);

      // Job Summary Section - Top of Modal (not scrollable, more compact)
      const summarySection = document.createElement("div");
      summarySection.style.cssText = "padding: 1.25rem 2rem 1rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #f9fafb;";
      // Mobile-specific padding
      if (window.innerWidth <= 768) {
        summarySection.style.padding = "1rem 1rem 1rem 1rem";
        summarySection.style.paddingTop = "3rem"; // Space for close button
      }
      
      // Job Title (more compact)
      const jobTitle = document.createElement("h2");
      jobTitle.style.cssText = "margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main); line-height: 1.3;";
      jobTitle.textContent = job.title || "Untitled Job";
      summarySection.appendChild(jobTitle);

      // Summary Grid (more compact, 2 columns on larger screens)
      const summaryGrid = document.createElement("div");
      summaryGrid.style.cssText = "display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem 1rem; font-size: 0.8rem;";
      
      // Category
      const categoryRow = document.createElement("div");
      categoryRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      const categoryEmoji = job.category === "moving" ? "🚚" : job.category === "yard" ? "🌿" : job.category === "cleaning" ? "🧹" : job.category === "furniture" ? "🛠" : "⭐";
      const categoryText = job.category === "moving" ? "Moving / Hauling" : job.category === "yard" ? "Yard / Outdoor" : job.category === "cleaning" ? "Cleaning / Organizing" : job.category === "furniture" ? "Furniture / Setup" : "Other";
      categoryRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Category:</span> <span style="color: var(--text-muted);">${categoryEmoji} ${categoryText}</span>`;
      summaryGrid.appendChild(categoryRow);

      // Pay/Rate
      const payRow = document.createElement("div");
      payRow.style.cssText = "display: flex; align-items: center; gap: 0.5rem;";
      let payText = "";
      if (job.payType === "flat" || !job.payType) {
        const amount = Number(job.flatAmount || job.amount || 0);
        payText = formatMoney(amount) + " flat";
      } else {
        const hourlyRate = Number(job.hourlyRate || 0);
        const maxHours = Number(job.maxHours || job.estHours || 0);
        payText = formatMoney(hourlyRate) + "/hr total";
        if (maxHours > 0) {
          payText += ` (Max ${maxHours} hrs)`;
        }
      }
      payRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Pay:</span> <span style="color: var(--text-muted);">${payText}</span>`;
      summaryGrid.appendChild(payRow);
      
      // Hourly Pay Breakdown Section (if hourly)
      if (job.payType === "hourly") {
        const hourlyBreakdownSection = document.createElement("div");
        hourlyBreakdownSection.style.cssText = "grid-column: 1 / -1; margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 3px solid #3b82f6;";
        
        const breakdownTitle = document.createElement("div");
        breakdownTitle.style.cssText = "font-weight: 700; font-size: 0.95rem; color: #1e40af; margin-bottom: 0.75rem;";
        breakdownTitle.textContent = "💰 Hourly Pay Breakdown";
        hourlyBreakdownSection.appendChild(breakdownTitle);
        
        const hourlyRate = Number(job.hourlyRate || 0);
        const maxHours = Number(job.maxHours || job.estHours || 0);
        const teamSize = job.teamSize || 1;
        const perPersonRate = teamSize > 0 ? hourlyRate / teamSize : hourlyRate;
        
        const breakdownList = document.createElement("div");
        breakdownList.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; color: var(--text-main);";
        
        breakdownList.innerHTML = `
          <div><strong>Total hourly rate:</strong> $${hourlyRate.toFixed(0)}/hr</div>
          ${maxHours > 0 ? `<div><strong>Max hours:</strong> ${maxHours} hours</div>` : ''}
          <div><strong>Workers needed:</strong> ${teamSize}</div>
          ${teamSize > 1 ? `<div><strong>Each worker earns:</strong> $${perPersonRate.toFixed(0)}/hr (before platform fees)</div>` : ''}
        `;
        
        hourlyBreakdownSection.appendChild(breakdownList);
        summaryGrid.appendChild(hourlyBreakdownSection);
      }

      // Status
      const statusRow = document.createElement("div");
      statusRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      let statusText = "Open";
      let statusColor = "#059669";
      if (job.status === "OPEN" || job.status === "open") {
        statusText = "Open";
        statusColor = "#059669";
      } else if (job.status === "ASSIGNED" || job.status === "assigned" || job.status === "SCHEDULED" || job.status === "scheduled") {
        // SCHEDULED/ASSIGNED = Hustler accepted, waiting for start code (not active yet)
        statusText = job.status === "SCHEDULED" || job.status === "scheduled" ? "Scheduled" : "Assigned";
        statusColor = "#2563eb";
      } else if (job.status === "IN_PROGRESS" || job.status === "in_progress") {
        // IN_PROGRESS = Start code entered, job is actively being worked on
        statusText = "In Progress";
        statusColor = "#7c3aed";
        
        // Add count-up timer for IN_PROGRESS jobs
        if (job.startCodeVerified && job.updatedAt) {
          const startTime = new Date(job.updatedAt);
          const now = new Date();
          const elapsed = Math.floor((now - startTime) / 1000); // seconds
          
          const hours = Math.floor(elapsed / 3600);
          const minutes = Math.floor((elapsed % 3600) / 60);
          const seconds = elapsed % 60;
          
          let timerText = '';
          if (hours > 0) {
            timerText = `${hours}h ${minutes}m ${seconds}s`;
          } else if (minutes > 0) {
            timerText = `${minutes}m ${seconds}s`;
          } else {
            timerText = `${seconds}s`;
          }
          
          statusText = `In Progress ⏱️ ${timerText}`;
          
          // Update timer every second
          const timerInterval = setInterval(() => {
            const now = new Date();
            const elapsed = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            let timerText = '';
            if (hours > 0) {
              timerText = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
              timerText = `${minutes}m ${seconds}s`;
            } else {
              timerText = `${seconds}s`;
            }
            
            const statusSpan = statusRow.querySelector('span:last-child');
            if (statusSpan) {
              statusSpan.textContent = `In Progress ⏱️ ${timerText}`;
            } else {
              clearInterval(timerInterval);
            }
          }, 1000);
        }
      } else if (job.status === "PAID" || job.status === "paid") {
        statusText = "Completed";
        statusColor = "#9333ea";
      } else if (job.status === "COMPLETED" || job.status === "completed") {
        statusText = "Completed";
        statusColor = "#9333ea";
      } else {
        statusText = job.status || "Open";
      }
      statusRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Status:</span> <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>`;
      summaryGrid.appendChild(statusRow);

      // Time Posted - Fix NaN bug
      const timeRow = document.createElement("div");
      timeRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      let postedTime = "Recently";
      if (job.createdAt) {
        const createdDate = typeof job.createdAt === 'string' ? new Date(job.createdAt) : (job.createdAt instanceof Date ? job.createdAt : new Date(job.createdAt));
        postedTime = timeAgo(createdDate);
      }
      timeRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Posted:</span> <span style="color: var(--text-muted);">${postedTime}</span>`;
      summaryGrid.appendChild(timeRow);

      // Job Date / Scheduled Date
      if (job.date || job.startTime) {
        const dateRow = document.createElement("div");
        dateRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
        try {
          const jobDate = job.startTime ? new Date(job.startTime) : new Date(job.date);
          if (!isNaN(jobDate.getTime())) {
            const dateStr = jobDate.toLocaleDateString('en-US', { 
              weekday: 'short',
              month: 'short', 
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            dateRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Date:</span> <span style="color: var(--text-muted);">${dateStr}</span>`;
            summaryGrid.appendChild(dateRow);
          }
        } catch (e) {
          console.warn("Error formatting job date:", e);
        }
      }

      // Done By - show text labels matching job cards
      const deadlineRow = document.createElement("div");
      deadlineRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      try {
        const requirements = job.requirements || {};
        const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
        
        // Check deadline preference first to show text labels
        if (deadlinePreference === "today") {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 Today (needs done today)</span>`;
        } else if (deadlinePreference === "today_asap") {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 ASAP (needs done in the next 3 days)</span>`;
        } else if (deadlinePreference === "flexible_week") {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 This week</span>`;
        } else if (deadlinePreference === "no_deadline" || deadlinePreference === "until_completed" || deadlinePreference === "whenever" || deadlinePreference === "flexible") {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #f59e0b; font-weight: 600;">⏰ Until done</span>`;
        } else if (deadlinePreference === "specific_date" && job.endTime) {
          // For specific date, show the actual date/time
          const deadlineDate = new Date(job.endTime);
          if (!isNaN(deadlineDate.getTime())) {
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 ${deadlineStr}</span>`;
          } else {
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
          }
        } else if (job.endTime) {
          // Fallback: use endTime if available
          const deadlineDate = new Date(job.endTime);
          if (!isNaN(deadlineDate.getTime())) {
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 ${deadlineStr}</span>`;
          } else {
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
          }
        } else if (job.startTime) {
          // Fallback: use startTime
          const deadlineDate = new Date(job.startTime);
          if (!isNaN(deadlineDate.getTime())) {
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 ${deadlineStr}</span>`;
          } else {
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
          }
        } else if (job.date) {
          // Fallback: use job.date
          const deadlineDate = new Date(job.date);
          if (!isNaN(deadlineDate.getTime())) {
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric'
            });
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: #059669; font-weight: 600;">📅 ${deadlineStr}</span>`;
          } else {
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
          }
        } else {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
        }
        summaryGrid.appendChild(deadlineRow);
      } catch (e) {
        console.warn("Error formatting deadline:", e);
        deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Done By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
        summaryGrid.appendChild(deadlineRow);
      }

      // Location
      const locationRow = document.createElement("div");
      locationRow.style.cssText = "display: flex; align-items: flex-start; gap: 0.4rem; grid-column: 1 / -1;";
      const fullAddress = job.address || (job.requirements?.pickup_address ? `${job.requirements.pickup_address}, ${job.requirements.pickup_city || ''} ${job.requirements.pickup_area || ''}`.trim() : "Location TBD");
      locationRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Location:</span> <span style="color: var(--text-muted);">${fullAddress}</span>`;
      summaryGrid.appendChild(locationRow);

      // Posted By - Make clickable to view customer profile
      let poster = state.users?.find((u) => u.id === job.postedByUserId) || job.postedBy || job.customer;
      if (!poster && job.postedByUserId) {
        // Try to fetch customer from API
        try {
          const token = localStorage.getItem("hustl_token");
          const userResponse = await fetch(`${API_BASE}/users/${job.postedByUserId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (userResponse.ok) {
            poster = await userResponse.json();
          }
        } catch (e) {
          console.error("Error fetching customer:", e);
        }
      }
      
      if (poster) {
        const postedByRow = document.createElement("div");
        postedByRow.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; margin-top: 0.4rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; transition: background 0.2s; grid-column: 1 / -1;";
        postedByRow.addEventListener("mouseenter", () => {
          postedByRow.style.background = "#f3f4f6";
        });
        postedByRow.addEventListener("mouseleave", () => {
          postedByRow.style.background = "#f9fafb";
        });
        postedByRow.addEventListener("click", (e) => {
          e.stopPropagation();
          if (poster.id) {
            // Close job modal first
            if (modalOverlay && modalOverlay.parentNode) {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
            }
            // Open user profile using standardized popup
            if (typeof window.showHustlerProfilePopup === 'function') {
              setTimeout(() => {
                window.showHustlerProfilePopup(poster.id);
              }, 100);
            } else {
              // Fallback: navigate to profile view
              if (typeof setView === 'function') {
                setView('profile');
              }
            }
          }
        });
        
        const posterAvatar = document.createElement("div");
        posterAvatar.innerHTML = renderUserAvatar(poster, 32);
        postedByRow.appendChild(posterAvatar);
        
        const posterInfo = document.createElement("div");
        posterInfo.style.cssText = "flex: 1; min-width: 0;";
        
        const posterName = document.createElement("div");
        posterName.style.cssText = "font-weight: 600; color: var(--text-main); margin-bottom: 0.15rem; font-size: 0.85rem;";
        posterName.textContent = poster.name || poster.username || poster.email?.split('@')[0] || "Unknown";
        posterInfo.appendChild(posterName);
        
        // Use centralized rating display - always from backend (single source of truth)
        const posterRating = document.createElement("div");
        posterRating.style.cssText = "font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.25rem;";
        posterRating.innerHTML = window.getUserRatingDisplay(poster);
        posterInfo.appendChild(posterRating);
        
        postedByRow.appendChild(posterInfo);
        
        const viewProfileBtn = document.createElement("div");
        viewProfileBtn.style.cssText = "font-size: 0.75rem; color: var(--primary); font-weight: 600; white-space: nowrap;";
        viewProfileBtn.textContent = "View Profile →";
        postedByRow.appendChild(viewProfileBtn);
        
        summaryGrid.appendChild(postedByRow);
      }

      summarySection.appendChild(summaryGrid);
      modalContent.appendChild(summarySection);
      
      // Close on overlay click
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
        }
      });
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = "hidden";
      
      // Append modal content to overlay
      modalOverlay.appendChild(modalContent);

      // Content Section (scrollable) - CREATE FIRST
      const contentSection = document.createElement("div");
      contentSection.style.cssText = "padding: 1.5rem 2rem; flex: 1 1 0; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; min-height: 0; position: relative;";
      
      // Additional Details Section
      if (job.requirements) {
        const detailsSection = document.createElement("div");
        detailsSection.style.cssText = "margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;";
        
        const detailsTitle = document.createElement("div");
        detailsTitle.style.cssText = "font-weight: 600; font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.75rem;";
        detailsTitle.textContent = "Additional Details";
        detailsSection.appendChild(detailsTitle);
        
        const detailsList = document.createElement("div");
        detailsList.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);";
        
        // Check if address should be hidden based on customer preference
        const hidePickupAddressUntilAssigned = job.requirements?.hide_pickup_address_until_assigned || job.requirements?.hidePickupAddressUntilAssigned;
        let showFullPickupAddressDetails = true;
        
        if (hidePickupAddressUntilAssigned) {
          try {
            const user = window.hustlAPI?.auth?.getCurrentUserSync?.() || (window.currentUser || null);
            if (user) {
              const isHustler = user && !user.roles?.includes('CUSTOMER');
              const jobAccepted = job.hustlerId && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'IN_PROGRESS' || job.status === 'COMPLETED_BY_HUSTLER');
              showFullPickupAddressDetails = !isHustler || jobAccepted;
            }
          } catch (e) {
            showFullPickupAddressDetails = true;
          }
        }
        
        const hideDropoffAddressUntilAssigned = job.requirements?.hide_dropoff_address_until_assigned || job.requirements?.hideDropoffAddressUntilAssigned;
        let showFullDropoffAddressDetails = true;
        
        if (hideDropoffAddressUntilAssigned) {
          try {
            const user = window.hustlAPI?.auth?.getCurrentUserSync?.() || (window.currentUser || null);
            if (user) {
              const isHustler = user && !user.roles?.includes('CUSTOMER');
              const jobAccepted = job.hustlerId && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'IN_PROGRESS' || job.status === 'COMPLETED_BY_HUSTLER');
              showFullDropoffAddressDetails = !isHustler || jobAccepted;
            }
          } catch (e) {
            showFullDropoffAddressDetails = true;
          }
        }
        
        if (job.requirements.pickup_address || job.requirements.pickup_city) {
          const pickupDetail = document.createElement("div");
          let pickupText = '';
          if (showFullPickupAddressDetails && job.requirements.pickup_address) {
            const apt = job.requirements.pickup_apt ? ', ' + job.requirements.pickup_apt : '';
            pickupText = `${job.requirements.pickup_address}${apt}, ${job.requirements.pickup_city || ''} ${job.requirements.pickup_zip || ''}`.trim();
          } else {
            pickupText = `${job.requirements.pickup_area || ''} ${job.requirements.pickup_city || ''} ${job.requirements.pickup_zip || ''}`.trim();
            if (!showFullPickupAddressDetails) {
              pickupText += ' (Address will be provided after assignment)';
            }
          }
          pickupDetail.innerHTML = `<strong>Pickup:</strong> ${pickupText}`;
          detailsList.appendChild(pickupDetail);
        }
        
        if (job.requirements.dropoff_address && !job.requirements.on_site_only) {
          const dropoffDetail = document.createElement("div");
          let dropoffText = '';
          if (showFullDropoffAddressDetails && job.requirements.dropoff_address) {
            const apt = job.requirements.dropoff_apt ? ', ' + job.requirements.dropoff_apt : '';
            dropoffText = `${job.requirements.dropoff_address}${apt}, ${job.requirements.dropoff_city || ''} ${job.requirements.dropoff_zip || ''}`.trim();
          } else {
            dropoffText = `${job.requirements.dropoff_area || ''} ${job.requirements.dropoff_city || ''} ${job.requirements.dropoff_zip || ''}`.trim();
            if (!showFullDropoffAddressDetails) {
              dropoffText += ' (Address will be provided after assignment)';
            }
          }
          dropoffDetail.innerHTML = `<strong>Dropoff:</strong> ${dropoffText}`;
          detailsList.appendChild(dropoffDetail);
        }
        
        if (job.requirements.equipment_needed && Array.isArray(job.requirements.equipment_needed) && job.requirements.equipment_needed.length > 0) {
          const equipmentDetail = document.createElement("div");
          equipmentDetail.innerHTML = `<strong>Equipment Needed:</strong> ${job.requirements.equipment_needed.join(', ')}`;
          detailsList.appendChild(equipmentDetail);
        }
        
        // Team Size / Workers Needed - VERY IMPORTANT
        // Get teamSize from multiple possible locations and ensure it's a number
        const rawTeamSize = job.teamSize || job.workersNeeded || job.requirements?.teamSize || job.requirements?.team_size || 1;
        const teamSize = typeof rawTeamSize === 'string' ? parseInt(rawTeamSize, 10) : Number(rawTeamSize) || 1;
        
        if (teamSize && teamSize > 0) {
          const teamSizeDetail = document.createElement("div");
          teamSizeDetail.style.cssText = "font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px; border-left: 3px solid #3b82f6;";
          if (teamSize === 1) {
            teamSizeDetail.innerHTML = `👤 <strong>Workers Needed:</strong> 1 person`;
          } else {
            teamSizeDetail.innerHTML = `👥 <strong>Workers Needed:</strong> ${teamSize} people<br><span style="font-size: 0.85rem; color: #1e40af; font-weight: 500;">💡 Bring some friends! This job requires ${teamSize} ${teamSize === 2 ? 'people' : 'people'} to complete.</span>`;
          }
          detailsList.appendChild(teamSizeDetail);
        }
        
        if (detailsList.children.length > 0) {
          detailsSection.appendChild(detailsList);
          contentSection.appendChild(detailsSection);
        }
      }

      // Full Job Description Section
      const descSection = document.createElement("div");
      descSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
      
      const descTitle = document.createElement("div");
      descTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
      descTitle.textContent = "Job Description";
      descSection.appendChild(descTitle);
      
      const desc = document.createElement("div");
      desc.style.cssText = "color: var(--text-main); font-size: 1rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;";
      // Get full description from job object
      const fullDescription = job.description || job.requirements?.notes || job.notes || "No description provided.";
      desc.textContent = fullDescription;
      descSection.appendChild(desc);
      
      // Job Photos (if any)
      if (job.photos && Array.isArray(job.photos) && job.photos.length > 0) {
        const photosSection = document.createElement("div");
        photosSection.style.cssText = "margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;";
        job.photos.forEach(photoUrl => {
          const photo = document.createElement("img");
          photo.src = photoUrl;
          photo.style.cssText = "width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;";
          photo.addEventListener("click", () => {
            window.open(photoUrl, '_blank');
          });
          photosSection.appendChild(photo);
        });
        descSection.appendChild(photosSection);
      }
      
      contentSection.appendChild(descSection);
      
      // Location with Map Preview
      const locationSection = document.createElement("div");
      locationSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
      
      const locationTitle = document.createElement("div");
      locationTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
      locationTitle.textContent = "📍 Location";
      locationSection.appendChild(locationTitle);
      
      // Get requirements for location formatting
      const requirements = job.requirements || {};
      
      // Use formatPublicLocation for consistent display
      const locationDisplay = formatPublicLocation(job, requirements, false);
      const locationText = document.createElement("div");
      locationText.style.cssText = "color: var(--text-main); font-size: 0.95rem; margin-bottom: 1rem; line-height: 1.5;";
      locationText.textContent = locationDisplay;
      locationSection.appendChild(locationText);
      
      // Map preview (Mapbox) - use exact coordinates if user is assigned hustler, otherwise use street-level for hidden addresses
      let lat = null;
      let lng = null;
      
      if (showExactAddress) {
        // Assigned hustler: use exact coordinates
      const reqLat = requirements.pickup_lat || requirements.pickupLat;
      const reqLng = requirements.pickup_lng || requirements.pickupLng;
      const jobLat = job.lat;
      const jobLng = job.lng;
        lat = reqLat || jobLat;
        lng = reqLng || jobLng;
      } else if (hidePickupAddressUntilAssigned && requirements.pickup_address) {
        // Hidden address: would need to geocode street name, but for preview use existing coords with note
        const reqLat = requirements.pickup_lat || requirements.pickupLat;
        const reqLng = requirements.pickup_lng || requirements.pickupLng;
        const jobLat = job.lat;
        const jobLng = job.lng;
        lat = reqLat || jobLat;
        lng = reqLng || jobLng;
      } else {
        // Not hidden: use exact coordinates
        const reqLat = requirements.pickup_lat || requirements.pickupLat;
        const reqLng = requirements.pickup_lng || requirements.pickupLng;
        const jobLat = job.lat;
        const jobLng = job.lng;
        lat = reqLat || jobLat;
        lng = reqLng || jobLng;
      }
      
      if (lat && lng && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
        const mapContainer = document.createElement("div");
        const mapId = `map-${job.id}-${Date.now()}`;
        mapContainer.id = mapId;
        mapContainer.style.cssText = "width: 100%; height: 200px; border-radius: 8px; overflow: hidden; border: 2px solid var(--border); cursor: pointer; position: relative; margin-top: 0.75rem; background: #f3f4f6;";
        locationSection.appendChild(mapContainer);
        
        // Loading indicator
        const loadingDiv = document.createElement("div");
        loadingDiv.style.cssText = "position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.85rem; z-index: 1;";
        loadingDiv.textContent = "Loading map...";
        mapContainer.appendChild(loadingDiv);
        
        // Initialize Mapbox map after a short delay
        setTimeout(async () => {
          // Check if container exists in DOM before initializing
          const containerElement = document.getElementById(mapId);
          if (!containerElement || !document.body.contains(containerElement)) {
            return;
          }
          
          try {
            const token = await getMapboxToken();
            if (!token || !window.mapboxgl) {
              loadingDiv.textContent = "Map unavailable";
              return;
            }
            
            mapboxgl.accessToken = token;
            const map = new mapboxgl.Map({
              container: mapId,
              style: 'mapbox://styles/mapbox/streets-v12',
              center: [parseFloat(lng), parseFloat(lat)],
              zoom: 14,
              interactive: false // Static preview
            });
            
            map.on('load', () => {
              // Remove loading indicator
              if (loadingDiv.parentNode) {
                loadingDiv.remove();
              }
              
              // Add marker
              new mapboxgl.Marker({
                color: '#3b82f6',
                anchor: 'center'
              })
                .setLngLat([parseFloat(lng), parseFloat(lat)])
                .addTo(map);
            });
            
            // Click to open Google Maps
            mapContainer.addEventListener('click', () => {
              // Open Google Maps with job location
              const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(parseFloat(lat))},${encodeURIComponent(parseFloat(lng))}`;
              window.open(googleMapsUrl, '_blank');
            });
          } catch (mapError) {
            console.warn('Could not initialize Mapbox map:', mapError);
            loadingDiv.textContent = "Map unavailable";
            // Fallback to Google Maps link
            const mapLink = document.createElement("a");
            mapLink.href = `https://maps.google.com/?q=${encodeURIComponent(locationDisplay)}`;
            mapLink.target = "_blank";
            mapLink.style.cssText = "display: block; padding: 1rem; text-align: center; color: var(--primary); text-decoration: none; font-weight: 600;";
            mapLink.textContent = "🗺️ View on Google Maps";
            if (loadingDiv.parentNode) {
              loadingDiv.remove();
            }
            mapContainer.appendChild(mapLink);
          }
        }, 200);
      }
      
      // Add click hint text below map
      if (lat && lng) {
        const mapHint = document.createElement("div");
        mapHint.style.cssText = "margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted); text-align: center;";
        mapHint.textContent = "Click to view full map";
        locationSection.appendChild(mapHint);
      }
      
      contentSection.appendChild(locationSection);
      
      // Tools/Equipment Needed
      const equipment = job.requirements?.equipment || job.requirements?.equipment_needed || [];
      if (equipment.length > 0) {
        const equipmentSection = document.createElement("div");
        equipmentSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
        
        const equipmentTitle = document.createElement("div");
        equipmentTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
        equipmentTitle.textContent = "🔧 Tools & Equipment Needed";
        equipmentSection.appendChild(equipmentTitle);
        
        const equipmentList = document.createElement("div");
        equipmentList.style.cssText = "display: flex; flex-wrap: wrap; gap: 0.5rem;";
        equipment.forEach(eq => {
          const badge = document.createElement("span");
          badge.style.cssText = "padding: 0.5rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; color: var(--text-main);";
          badge.textContent = eq;
          equipmentList.appendChild(badge);
        });
        equipmentSection.appendChild(equipmentList);
        contentSection.appendChild(equipmentSection);
      }
      
      // Maximum Time/Difficulty
      if (job.estHours || job.maxHours || job.difficulty) {
        const timeSection = document.createElement("div");
        timeSection.style.cssText = "margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;";
        
        if (job.estHours || job.maxHours) {
          const timeInfo = document.createElement("div");
          timeInfo.style.cssText = "font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.5rem;";
          timeInfo.textContent = `⏱️ Maximum Time: ${job.estHours || job.maxHours} ${(job.estHours || job.maxHours) === 1 ? 'hour' : 'hours'}`;
          timeSection.appendChild(timeInfo);
          
          // Add maximum payment amount info
          const maxPaymentInfo = document.createElement("div");
          maxPaymentInfo.style.cssText = "font-size: 0.9rem; color: var(--text-main); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;";
          let maxPaymentText = "";
          if (job.payType === "flat" || !job.payType) {
            const amount = Number(job.flatAmount || job.amount || 0);
            maxPaymentText = `The person is willing to pay a maximum amount of ${formatMoney(amount)} flat`;
          } else {
            const hourlyRate = Number(job.hourlyRate || 0);
            const maxHours = Number(job.maxHours || job.estHours || 0);
            if (maxHours > 0) {
              const maxTotal = hourlyRate * maxHours;
              maxPaymentText = `The person is willing to pay a maximum amount of ${formatMoney(maxTotal)} (${formatMoney(hourlyRate)}/hr × ${maxHours} hours)`;
            } else {
              maxPaymentText = `The person is willing to pay a maximum amount of ${formatMoney(hourlyRate)}/hr`;
            }
          }
          maxPaymentInfo.textContent = maxPaymentText;
          timeSection.appendChild(maxPaymentInfo);
        }
        
        if (job.difficulty) {
          const difficultyInfo = document.createElement("div");
          difficultyInfo.style.cssText = "font-size: 0.9rem; color: var(--text-main);";
          difficultyInfo.textContent = `📊 Difficulty: ${job.difficulty}`;
          timeSection.appendChild(difficultyInfo);
        }
        
        contentSection.appendChild(timeSection);
      }

      // Apply Now Button Section (moved here, right after Tools & Equipment)
      // Check if user is logged in (check token first, then get user)
      const token = localStorage.getItem("hustl_token");
      const isLoggedIn = !!token;
      
      // Use the user variable from earlier in the function, or get it again
      const currentUser = user || getCurrentUser();
      
      // Check if job is open (case-insensitive)
      const jobStatusUpper = (job.status || "").toUpperCase();
      const isOpen = jobStatusUpper === "OPEN" || jobStatusUpper === "";
      const isNotPoster = currentUser ? (job.postedByUserId !== currentUser.id) : true; // If no user object, assume not poster
      
      // Show apply section if: user is logged in (has token) and job is open
      // We'll check if user is poster inside the form and show appropriate message
      console.log("Apply section visibility check:", { isLoggedIn, isOpen, isNotPoster, jobStatus: job.status, hasToken: !!token });
      if (isLoggedIn && isOpen) {
        // Check if already applied
        let hasApplied = false;
        try {
          const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (offersResponse.ok) {
            const offers = await offersResponse.json();
            // Get user ID from currentUser or fetch from API
            let userId = currentUser?.id;
            if (!userId && token) {
              try {
                const userResponse = await fetch(`${API_BASE}/users/me`, {
                  headers: { "Authorization": `Bearer ${token}` }
                });
                if (userResponse.ok) {
                  const userData = await userResponse.json();
                  userId = userData.id;
                }
              } catch (e) {
                console.error("Error getting user ID:", e);
              }
            }
            hasApplied = userId && Array.isArray(offers) && offers.some(o => o.hustlerId === userId);
          }
        } catch (e) {
          console.error("Error checking applications:", e);
        }
        
        const applySection = document.createElement("div");
        applySection.style.cssText = "margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 12px;";
        
        // Check job status for hustler
        const jobStatusUpper = (job.status || "OPEN").toUpperCase();
        
        if (hasApplied) {
          let statusText = "✓ Applied — Waiting for customer to accept offer";
          let statusBg = "#dcfce7";
          let statusColor = "#059669";
          
          // Check if accepted
          if (job.hustlerId === currentUser.id || job.acceptedHustlerId === currentUser.id) {
            const hasStartCode = job.arrivalCode && !job.arrivalCodeVerified;
            const isInProgress = job.arrivalCodeVerified && !job.completionCodeVerified;
            const isCompleted = job.completionCodeVerified;
            
            if (hasStartCode) {
              statusText = "✓ Accepted — Waiting for Start Code";
              statusBg = "#fef3c7";
              statusColor = "#d97706";
            } else if (isInProgress) {
              statusText = "✓ Job Active — In Progress";
              statusBg = "#dbeafe";
              statusColor = "#2563eb";
            } else if (isCompleted) {
              statusText = "✓ Completed";
              statusBg = "#e9d5ff";
              statusColor = "#9333ea";
            } else {
              statusText = "✓ Accepted — Waiting for Start Code";
              statusBg = "#fef3c7";
              statusColor = "#d97706";
            }
          }
          
          const appliedBadge = document.createElement("div");
          appliedBadge.style.cssText = `padding: 1rem; background: ${statusBg}; border-radius: 8px; text-align: center; color: ${statusColor}; font-weight: 600;`;
          appliedBadge.textContent = statusText;
          applySection.appendChild(appliedBadge);
        } else {
          // Check if this is a hustler-suggested-price job
          const pricingOption = job.requirements?.pricing_option;
          const isHustlerSuggestedPrice = pricingOption === "hustlers_quote";
          
          // Apply form directly in the modal
          const applyTitle = document.createElement("div");
          applyTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 1rem;";
          applyTitle.textContent = "Apply for This Job";
          applySection.appendChild(applyTitle);
          
          // Why you're a good fit textarea
          const whyFitLabel = document.createElement("label");
          whyFitLabel.style.cssText = "display: block; font-weight: 600; font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.5rem;";
          whyFitLabel.textContent = "Why are you a good fit for this job? *";
          applySection.appendChild(whyFitLabel);
          
          const whyFitTextarea = document.createElement("textarea");
          whyFitTextarea.id = `whyFitTextarea_${job.id}`;
          whyFitTextarea.placeholder = "Tell the customer why you're right for this job. Include your experience, tools, availability, etc.";
          whyFitTextarea.maxLength = 400;
          whyFitTextarea.required = true;
          whyFitTextarea.style.cssText = "width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical; margin-bottom: 0.5rem;";
          whyFitTextarea.addEventListener("input", (e) => {
            const remaining = 400 - e.target.value.length;
            charCounter.textContent = `${remaining} characters remaining`;
            if (remaining < 50) {
              charCounter.style.color = "#dc2626";
            } else {
              charCounter.style.color = "var(--text-muted)";
            }
          });
          applySection.appendChild(whyFitTextarea);
          
          const charCounter = document.createElement("div");
          charCounter.style.cssText = "font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; text-align: right;";
          charCounter.textContent = "400 characters remaining";
          applySection.appendChild(charCounter);
          
          // For hustler-suggested-price jobs, show price input directly (required)
          // For customer-set-price jobs, price negotiation is removed
          
          // Price negotiation fields (only for hustler-suggested-price jobs)
          if (isHustlerSuggestedPrice) {
            const priceNegotiationSection = document.createElement("div");
            priceNegotiationSection.id = `priceNegotiationSection_${job.id}`;
            priceNegotiationSection.style.cssText = "margin-top: 1rem; padding: 1rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px;";
            
            const priceLabel = document.createElement("label");
            priceLabel.style.cssText = "display: block; font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
            priceLabel.textContent = "Your Proposed Price *";
            priceNegotiationSection.appendChild(priceLabel);
            
            // Price input container with dollar sign
            const priceInputWrapper = document.createElement("div");
            priceInputWrapper.style.cssText = "position: relative; margin-bottom: 1rem;";
            
            const dollarSign = document.createElement("span");
            dollarSign.style.cssText = "position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 2.5rem; font-weight: 700; color: var(--primary); z-index: 1;";
            dollarSign.textContent = "$";
            priceInputWrapper.appendChild(dollarSign);
            
            const priceInput = document.createElement("input");
            priceInput.type = "number";
            priceInput.id = `proposedPrice_${job.id}`;
            priceInput.placeholder = job.payType === "flat" ? "e.g., 150.00" : "e.g., 25.00";
            priceInput.min = "0";
            priceInput.step = "0.01";
            priceInput.required = true;
            priceInput.style.cssText = "width: 100%; padding: 2rem 1.5rem 2rem 4rem; border: 4px solid var(--primary); border-radius: 16px; font-size: 2.5rem; font-weight: 700; text-align: left; background: #f0fdf4; color: var(--text-main); min-height: 85px; box-sizing: border-box; transition: all 0.2s; font-family: inherit;";
            priceInputWrapper.appendChild(priceInput);
            
            // Add /hr suffix for hourly rates (initial state)
            if (job.payType === "hourly") {
              const hrSuffix = document.createElement("span");
              hrSuffix.className = "hr-suffix";
              hrSuffix.style.cssText = "position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.75rem; font-weight: 600; color: var(--text-muted); z-index: 1;";
              hrSuffix.textContent = "/hr";
              priceInputWrapper.appendChild(hrSuffix);
              priceInput.placeholder = "e.g., 60.00 (total for all workers)";
            }
            
            priceNegotiationSection.appendChild(priceInputWrapper);
            
            // Price type selector - always visible, allows switching between flat and hourly
            const priceTypeSelect = document.createElement("select");
            priceTypeSelect.id = `proposedPriceType_${job.id}`;
            priceTypeSelect.style.cssText = "width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; font-weight: 600; font-family: inherit; background: white; margin-bottom: 0.75rem;";
            priceTypeSelect.innerHTML = `
              <option value="flat">Flat Rate (one-time payment)</option>
              <option value="hourly">Per Hour (total hourly rate)</option>
            `;
            // Set default to match job pay type
            priceTypeSelect.value = job.payType || "flat";
            
            // Update input placeholder and /hr suffix when type changes
            priceTypeSelect.addEventListener("change", () => {
              const existingHrSuffix = priceInputWrapper.querySelector('.hr-suffix');
              if (priceTypeSelect.value === "hourly") {
                priceInput.placeholder = "e.g., 60.00 (total for all workers)";
                // Show /hr suffix if not already there
                if (!existingHrSuffix) {
                  const hrSuffix = document.createElement("span");
                  hrSuffix.className = "hr-suffix";
                  hrSuffix.style.cssText = "position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.75rem; font-weight: 600; color: var(--text-muted); z-index: 1;";
                  hrSuffix.textContent = "/hr";
                  priceInputWrapper.appendChild(hrSuffix);
                }
              } else {
                priceInput.placeholder = "e.g., 150.00";
                // Remove /hr suffix
                if (existingHrSuffix) existingHrSuffix.remove();
              }
            });
            
            priceNegotiationSection.appendChild(priceTypeSelect);
            
            const priceHint = document.createElement("div");
            priceHint.style.cssText = "padding: 0.75rem; background: #dbeafe; border-radius: 8px; font-size: 0.85rem; color: #1e40af;";
            priceHint.textContent = `💡 The customer will see your proposed price and compare it with other hustlers' proposals to decide who's the best fit.`;
            priceNegotiationSection.appendChild(priceHint);
            
            applySection.appendChild(priceNegotiationSection);
          }
          
          
          // Stripe requirement check - TEMPORARILY DISABLED FOR SANDBOX MODE
          // const stripeCheck = document.createElement("div");
          // stripeCheck.style.cssText = "padding: 0.75rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);";
          // 
          // let hasStripe = false;
          // try {
          //   const token = localStorage.getItem("hustl_token");
          //   const userResponse = await fetch(`${API_BASE}/users/me`, {
          //     headers: token ? { "Authorization": `Bearer ${token}` } : {}
          //   });
          //   if (userResponse.ok) {
          //     const userData = await userResponse.json();
          //     hasStripe = !!(userData.stripeAccountId || userData.stripeConnectAccountId);
          //   }
          // } catch (e) {
          //   console.error("Error checking Stripe:", e);
          // }
          // 
          // if (!hasStripe) {
          //   stripeCheck.innerHTML = `
          //     <div style="margin-bottom: 0.5rem; color: #dc2626; font-weight: 600;">⚠️ Stripe Account Required</div>
          //     <div style="margin-bottom: 0.75rem;">You must have a connected Stripe account to apply for jobs.</div>
          //     <button id="connectStripeBtn_${job.id}" class="btn btn-primary" style="width: 100%; padding: 0.6rem; font-size: 0.9rem;">
          //       Connect Stripe to Apply
          //     </button>
          //   `;
          //   const connectBtn = stripeCheck.querySelector(`#connectStripeBtn_${job.id}`);
          //   if (connectBtn) {
          //     connectBtn.addEventListener("click", () => {
          //       document.body.removeChild(modalOverlay);
          //       document.body.style.overflow = "";
          //       setView("profile");
          //       setTimeout(() => {
          //         const stripeSection = document.getElementById("stripeConnectSection");
          //         if (stripeSection) {
          //           stripeSection.scrollIntoView({ behavior: "smooth", block: "center" });
          //         }
          //       }, 300);
          //     });
          //   }
          // } else {
          //   stripeCheck.innerHTML = `<div style="color: #059669; font-weight: 600;">✅ Stripe account connected</div>`;
          // }
          // applySection.appendChild(stripeCheck);
          
          // Apply button
          const applyNowBtn = document.createElement("button");
          applyNowBtn.className = "btn btn-primary";
          applyNowBtn.textContent = "Submit Application";
          applyNowBtn.style.cssText = "width: 100%; padding: 1rem; font-size: 1rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); border: none; border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;";
          // Stripe requirement temporarily disabled for sandbox mode
          // applyNowBtn.disabled = !hasStripe;
          // if (!hasStripe) {
          //   applyNowBtn.style.opacity = "0.5";
          //   applyNowBtn.style.cursor = "not-allowed";
          // }
          
          applyNowBtn.addEventListener("mouseenter", () => {
            if (!applyNowBtn.disabled) {
              applyNowBtn.style.transform = "translateY(-2px)";
              applyNowBtn.style.boxShadow = "0 6px 16px rgba(59, 130, 246, 0.5)";
            }
          });
          applyNowBtn.addEventListener("mouseleave", () => {
            applyNowBtn.style.transform = "translateY(0)";
            applyNowBtn.style.boxShadow = "0 4px 12px rgba(59, 130, 246, 0.4)";
          });
          
          applyNowBtn.addEventListener("click", async () => {
            const whyFit = whyFitTextarea.value.trim();
            if (!whyFit) {
              showToast("Please explain why you're a good fit for this job.");
              whyFitTextarea.focus();
              return;
            }
            
            // Stripe requirement temporarily disabled for sandbox mode
            // if (!hasStripe) {
            //   showToast("Please connect your Stripe account first.");
            //   return;
            // }
            
            try {
              applyNowBtn.disabled = true;
              applyNowBtn.textContent = "Submitting...";
              
              // Get proposed price if checkbox is checked and value is entered
              const requestBody = {
                note: whyFit
              };
              
              // For hustler-suggested-price jobs, price is always required
              // For customer-set-price jobs, price is only required if checkbox is checked
              const pricingOption = job.requirements?.pricing_option;
              const isHustlerSuggestedPrice = pricingOption === "hustlers_quote";
              
              if (isHustlerSuggestedPrice) {
                // Price is required for hustler-suggested-price jobs
                const proposedPrice = priceInput && priceInput.value ? parseFloat(priceInput.value) : null;
                if (!proposedPrice || proposedPrice <= 0) {
                  showToast("Please enter your proposed price.");
                  applyNowBtn.disabled = false;
                  applyNowBtn.textContent = "Submit Application";
                  return;
                }
                requestBody.proposedAmount = proposedPrice;
                requestBody.proposedPriceType = priceTypeSelect ? priceTypeSelect.value : (job.payType || "flat");
              } else {
                // For customer-set-price jobs, price negotiation is no longer available
                // Do not include proposedAmount or proposedPriceType
              }
              
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/offers/${job.id}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(requestBody)
              });
              
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || "Failed to submit application");
              }
              
              showToast("✅ Application Submitted!");
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              renderJobs();
            } catch (error) {
              console.error("Error submitting application:", error);
              showToast("Failed to submit application: " + (error.message || "Unknown error"));
              applyNowBtn.disabled = false;
              applyNowBtn.textContent = "Submit Application";
            }
          });
          applySection.appendChild(applyNowBtn);
        }
        
        // Append apply section to contentSection (inside scrollable area, after Tools & Equipment)
        contentSection.appendChild(applySection);
      } else if (isLoggedIn && !isOpen) {
        // Job is not open - show message (inside contentSection)
        const closedSection = document.createElement("div");
        closedSection.style.cssText = "margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: #f3f4f6; border-radius: 12px; border: 1px solid #e5e7eb;";
        const closedMessage = document.createElement("div");
        closedMessage.style.cssText = "text-align: center; color: var(--text-muted); font-weight: 600;";
        closedMessage.textContent = `This job is ${job.status || 'closed'}. Applications are no longer being accepted.`;
        closedSection.appendChild(closedMessage);
        contentSection.appendChild(closedSection);
      } else if (!isLoggedIn) {
        // Not logged in - show login prompt (inside contentSection)
        const loginSection = document.createElement("div");
        loginSection.style.cssText = "margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 1px solid #e5e7eb;";
        const loginMessage = document.createElement("div");
        loginMessage.style.cssText = "text-align: center;";
        loginMessage.innerHTML = `<div style="margin-bottom: 0.75rem; color: var(--text-main); font-weight: 600;">Log in to apply for this job</div><button class="btn btn-primary" id="loginToApplyBtn" style="width: 100%; padding: 0.75rem;">Log In / Sign Up</button>`;
        loginSection.appendChild(loginMessage);
        const loginBtn = loginMessage.querySelector("#loginToApplyBtn");
        if (loginBtn) {
          loginBtn.addEventListener("click", () => {
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            if (window.openAuthModal) {
              window.openAuthModal('login');
            }
          });
        }
        contentSection.appendChild(loginSection);
      }
      
      // Now append contentSection to modalContent (after all content including apply section is added)
      modalContent.appendChild(contentSection);

      // Customer view: Show start code if hustler is accepted but not started (NOT for completed jobs)
      // Check if there's a pending price proposal - if so, hide start code section
      const hasPendingPriceProposal = parsedRequirements?.proposedPriceChange && 
                                      parsedRequirements.proposedPriceChange.status === 'PENDING';
      
      if (user && user.id === job.postedByUserId && job.hustlerId && job.startCode && !job.startCodeVerified && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && job.status !== 'PAID') {
        // If there's a pending price proposal, show a message instead of the start code
        if (hasPendingPriceProposal) {
          const priceProposalNotice = document.createElement("div");
          priceProposalNotice.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b;";
          
          const noticeTitle = document.createElement("div");
          noticeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #92400e; margin-bottom: 0.75rem; text-align: center;";
          noticeTitle.textContent = "💰 Hustler Proposed a New Price";
          priceProposalNotice.appendChild(noticeTitle);
          
          const noticeMessage = document.createElement("div");
          noticeMessage.style.cssText = "font-size: 0.95rem; color: #92400e; text-align: center; line-height: 1.5; margin-bottom: 1rem;";
          noticeMessage.textContent = "Please accept or decline the price change proposal above. Once you respond, the start code will be available.";
          priceProposalNotice.appendChild(noticeMessage);
          
          contentSection.appendChild(priceProposalNotice);
        } else {
          // No pending proposal - show start code as normal
          const startCodeSection = document.createElement("div");
          startCodeSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf24;";
          
          const startCodeTitle = document.createElement("div");
          startCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #92400e; margin-bottom: 0.75rem;";
          startCodeTitle.textContent = "🔐 Start Code (Give to Hustler)";
          startCodeSection.appendChild(startCodeTitle);
          
          const startCodeDisplay = document.createElement("div");
          startCodeDisplay.style.cssText = "font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #92400e; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;";
          startCodeDisplay.textContent = job.startCode;
          startCodeSection.appendChild(startCodeDisplay);
          
          // Safety warning
          const safetyWarning = document.createElement("div");
          safetyWarning.style.cssText = "padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;";
          safetyWarning.innerHTML = `<div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">⚠️ Safety Warning</div><div style="font-size: 0.85rem; color: #991b1b;">Do not give the Start Code until the hustler is physically there and ready to begin the job.</div>`;
          startCodeSection.appendChild(safetyWarning);
          
          // Price lock notice
          const payType = job.payType || 'flat';
          // Use payment.amount if available (negotiated price), otherwise use job.amount (original price)
          let currentAmount = 0;
          if (payType === 'hourly') {
            currentAmount = parseFloat(job.hourlyRate || 0) * parseFloat(job.estHours || 0);
          } else {
            // For flat jobs, use payment.amount if it exists (negotiated price), otherwise job.amount
            currentAmount = job.payment && job.payment.amount ? parseFloat(job.payment.amount) : parseFloat(job.amount || 0);
          }
          
          if (currentAmount > 0) {
            const serviceFee = currentAmount * 0.065;
            const finalPrice = currentAmount + serviceFee;
            
            // Final price breakdown
            const priceBreakdown = document.createElement("div");
            priceBreakdown.style.cssText = "padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #fbbf24; margin-bottom: 0.75rem;";
            const hourlyRate = parseFloat(job.hourlyRate || 0);
            const estHours = parseInt(job.estHours || 0);
            // Use currentAmount which already accounts for payment.amount
            const displayAmount = currentAmount;
            const displayServiceFee = serviceFee;
            const displayFinalPrice = finalPrice;
            priceBreakdown.innerHTML = `
              <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; font-size: 0.85rem;">💰 Final Price You've Already Paid</div>
              <div style="font-size: 0.8rem; color: #78350f; line-height: 1.5;">
                ${payType === 'hourly' && hourlyRate > 0 ? `
                <div style="margin-bottom: 0.25rem;">Hourly Rate: <strong>$${hourlyRate.toFixed(2)}/hour</strong></div>
                <div style="margin-bottom: 0.25rem;">Estimated Hours: <strong>${estHours} hours</strong></div>
                <div style="margin-bottom: 0.25rem;">Estimated Total: <strong>$${displayAmount.toFixed(2)}</strong></div>
                <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${displayServiceFee.toFixed(2)}</strong></div>
                <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                  Total Paid: <strong style="color: #059669;">$${displayFinalPrice.toFixed(2)}</strong>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #dcfce7; border-radius: 4px; font-size: 0.75rem; color: #059669; font-weight: 600;">
                  💚 Any hours and money not used will be automatically refunded back to you.
                </div>
                ` : `
                <div style="margin-bottom: 0.25rem;">Job Amount: <strong>$${displayAmount.toFixed(2)}</strong></div>
                <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${displayServiceFee.toFixed(2)}</strong></div>
                <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                  Total: <strong style="color: #059669;">$${displayFinalPrice.toFixed(2)}</strong>
                </div>
                `}
              </div>
            `;
            startCodeSection.appendChild(priceBreakdown);
            
            // Price lock notice
            const priceLockNotice = document.createElement("div");
            priceLockNotice.style.cssText = "padding: 0.75rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; margin-bottom: 0.75rem;";
            priceLockNotice.innerHTML = `
              <div style="font-size: 0.8rem; color: #78350f; line-height: 1.4; font-weight: 600;">
                Once verified, price is locked. Refunds via <strong>team.hustlapp@outlook.com</strong>.
              </div>
            `;
            startCodeSection.appendChild(priceLockNotice);
          }
          
          const startCodeInstructions = document.createElement("div");
          startCodeInstructions.style.cssText = "font-size: 0.9rem; color: #92400e; line-height: 1.5; margin-bottom: 0.75rem;";
          const expiresAt = job.startCodeExpiresAt ? new Date(job.startCodeExpiresAt) : null;
          const hoursLeft = expiresAt ? Math.max(0, Math.floor((expiresAt - new Date()) / (1000 * 60 * 60))) : 78;
          startCodeInstructions.innerHTML = `
            <div style="margin-bottom: 0.5rem;">Share this 6-digit code with your hustler when they arrive to start the job.</div>
            <div style="font-weight: 600;">⏰ Code expires in ${hoursLeft} hours. If not used, job will be cancelled and you'll be refunded.</div>
          `;
          startCodeSection.appendChild(startCodeInstructions);
          
          // Regenerate button
          const regenerateBtn = document.createElement("button");
          regenerateBtn.className = "btn btn-ghost";
          regenerateBtn.textContent = "🔄 Regenerate Code";
          regenerateBtn.style.cssText = "width: 100%; padding: 0.5rem; font-size: 0.85rem;";
          regenerateBtn.addEventListener("click", async () => {
            if (!confirm("Regenerate the start code? The old code will no longer work.")) return;
            try {
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/regenerate-start-code`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                }
              });
              if (!response.ok) throw new Error("Failed to regenerate");
              showToast("✅ Start code regenerated!");
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              openJobDetails(job.id);
            } catch (error) {
              showToast("Error regenerating code: " + error.message);
            }
          });
          startCodeSection.appendChild(regenerateBtn);
          
          contentSection.appendChild(startCodeSection);
        }
      }
      
      // Customer view: Show completion code after job is started (IN_PROGRESS, NOT for completed jobs)
      if (user && user.id === job.postedByUserId && job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified) {
        const completionCodeSection = document.createElement("div");
        completionCodeSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #dcfce7; border-radius: 12px; border: 2px solid #16a34a;";
        
        const completionCodeTitle = document.createElement("div");
        completionCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #166534; margin-bottom: 0.75rem;";
        completionCodeTitle.textContent = "🔐 Completion Code (For Hustler)";
        completionCodeSection.appendChild(completionCodeTitle);
        
        const completionCodeDisplay = document.createElement("div");
        completionCodeDisplay.style.cssText = "font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #166534; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;";
        completionCodeDisplay.textContent = job.completionCode;
        completionCodeSection.appendChild(completionCodeDisplay);
        
        // Safety warning
        const safetyWarning = document.createElement("div");
        safetyWarning.style.cssText = "padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;";
        safetyWarning.innerHTML = `<div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">⚠️ Safety Warning</div><div style="font-size: 0.85rem; color: #991b1b;">Only give the Completion Code after the job is fully done and you are satisfied with the work.</div>`;
        completionCodeSection.appendChild(safetyWarning);
        
        const completionInstructions = document.createElement("div");
        completionInstructions.style.cssText = "font-size: 0.9rem; color: #166534; margin-bottom: 0.75rem;";
        completionInstructions.textContent = "The hustler will enter this code when the job is complete. Do not share it until you are satisfied with the work.";
        completionCodeSection.appendChild(completionInstructions);
        
        // Show refund estimate for hourly jobs
        if (job.payType === 'hourly' && job.hourlyRate && job.estHours && parsedRequirements && parsedRequirements.startedAt) {
          try {
            const startedAt = new Date(parsedRequirements.startedAt);
            const now = new Date();
            const elapsedMs = now.getTime() - startedAt.getTime();
            const actualHours = elapsedMs / (1000 * 60 * 60);
            const hourlyRate = Number(job.hourlyRate || 0);
            const maxHours = Number(job.estHours || 0);
            
            const originalAuthorized = hourlyRate * maxHours;
            const actualCharge = hourlyRate * actualHours;
            const refundAmount = originalAuthorized - actualCharge;
            
            if (refundAmount > 0) {
              const refundInfo = document.createElement("div");
              refundInfo.style.cssText = "padding: 0.75rem; background: #dcfce7; border-left: 4px solid #10b981; border-radius: 6px; margin-bottom: 0.75rem;";
              refundInfo.innerHTML = `
                <div style="font-weight: 600; color: #059669; margin-bottom: 0.25rem; font-size: 0.85rem;">💚 Refund Estimate</div>
                <div style="font-size: 0.8rem; color: #047857; line-height: 1.4;">
                  If the job is completed right now (${actualHours.toFixed(2)} hours worked), you'll be automatically refunded <strong>$${refundAmount.toFixed(2)}</strong> for the unused time.
                </div>
              `;
              completionCodeSection.appendChild(refundInfo);
            }
          } catch (e) {
            console.error('Error calculating refund estimate:', e);
          }
        }
        
        // Regenerate button
        const regenerateBtn = document.createElement("button");
        regenerateBtn.className = "btn btn-ghost";
        regenerateBtn.textContent = "🔄 Regenerate Code";
        regenerateBtn.style.cssText = "width: 100%; padding: 0.5rem; font-size: 0.85rem;";
        regenerateBtn.addEventListener("click", async () => {
          if (!confirm("Regenerate the completion code? The old code will no longer work.")) return;
          try {
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/regenerate-completion-code`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              }
            });
            if (!response.ok) throw new Error("Failed to regenerate");
            showToast("✅ Completion code regenerated!");
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            openJobDetails(job.id);
          } catch (error) {
            showToast("Error regenerating code: " + error.message);
          }
        });
        completionCodeSection.appendChild(regenerateBtn);
        
        contentSection.appendChild(completionCodeSection);
      }
      
      // Hustler view: Show start code input if accepted but not started (NOT for completed jobs)
      if (user && user.id === job.hustlerId && job.startCode && !job.startCodeVerified && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && job.status !== 'PAID') {
        const startCodeInputSection = document.createElement("div");
        startCodeInputSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #dbeafe; border-radius: 12px; border: 2px solid #3b82f6;";
        
        const startCodeTitle = document.createElement("div");
        startCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;";
        startCodeTitle.textContent = "🔐 Enter Start Code";
        startCodeInputSection.appendChild(startCodeTitle);
        
        const startCodeInstructions = document.createElement("div");
        startCodeInstructions.style.cssText = "font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;";
        startCodeInstructions.textContent = "Ask the customer for the 6-digit start code to begin the job.";
        startCodeInputSection.appendChild(startCodeInstructions);
        
        const codeInput = document.createElement("input");
        codeInput.type = "text";
        codeInput.id = `startCodeInput_${job.id}`;
        codeInput.placeholder = "Enter 6-digit code";
        codeInput.maxLength = 6;
        codeInput.style.cssText = "width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;";
        codeInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
        });
        startCodeInputSection.appendChild(codeInput);
        
        const verifyBtn = document.createElement("button");
        verifyBtn.className = "btn btn-primary";
        verifyBtn.textContent = "Verify & Start Job";
        verifyBtn.style.cssText = "width: 100%; padding: 0.75rem;";
        verifyBtn.addEventListener("click", async () => {
          const code = codeInput.value.trim();
          if (code.length !== 6) {
            showToast("Please enter a 6-digit code");
            return;
          }
          
          try {
            verifyBtn.disabled = true;
            verifyBtn.textContent = "Verifying...";
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-start`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ code })
            });
            
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.error || "Verification failed");
            }
            
            showToast("✅ Start code verified! Job is now active.");
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            openJobDetails(job.id);
            renderJobs();
          } catch (error) {
            showToast("Error: " + (error.message || "Failed to verify"));
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify & Start Job";
          }
        });
        startCodeInputSection.appendChild(verifyBtn);
        
        contentSection.appendChild(startCodeInputSection);
      }
      
      // Hustler view: Show completion code input if job is IN_PROGRESS (NOT for completed jobs)
      if (user && user.id === job.hustlerId && job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified) {
        const completionCodeInputSection = document.createElement("div");
        completionCodeInputSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #dbeafe; border-radius: 12px; border: 2px solid #3b82f6;";
        
        const completionCodeTitle = document.createElement("div");
        completionCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;";
        completionCodeTitle.textContent = "🔐 Enter Completion Code";
        completionCodeInputSection.appendChild(completionCodeTitle);
        
        const completionCodeInstructions = document.createElement("div");
        completionCodeInstructions.style.cssText = "font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;";
        completionCodeInstructions.textContent = "Ask the customer for the 6-digit completion code to finish the job and release payment.";
        completionCodeInputSection.appendChild(completionCodeInstructions);
        
        // Show payout estimate for hourly jobs
        if (job.payType === 'hourly' && job.hourlyRate && job.estHours && parsedRequirements && parsedRequirements.startedAt) {
          try {
            const startedAt = new Date(parsedRequirements.startedAt);
            const now = new Date();
            const elapsedMs = now.getTime() - startedAt.getTime();
            const actualHours = elapsedMs / (1000 * 60 * 60);
            const hourlyRate = Number(job.hourlyRate || 0);
            
            // Calculate actual job amount (capped at max hours)
            const maxHours = Number(job.estHours || 0);
            const actualJobAmount = Math.min(hourlyRate * actualHours, hourlyRate * maxHours);
            const platformFee = actualJobAmount * 0.12;
            const payoutAmount = actualJobAmount - platformFee;
            
            const payoutInfo = document.createElement("div");
            payoutInfo.style.cssText = "padding: 0.75rem; background: #dcfce7; border-left: 4px solid #10b981; border-radius: 6px; margin-bottom: 1rem;";
            payoutInfo.innerHTML = `
              <div style="font-weight: 600; color: #059669; margin-bottom: 0.25rem; font-size: 0.85rem;">💰 Payout Estimate</div>
              <div style="font-size: 0.8rem; color: #047857; line-height: 1.4;">
                If completed now (${actualHours.toFixed(2)} hrs): Job amount $${actualJobAmount.toFixed(2)} - Platform fee (12%) $${platformFee.toFixed(2)} = <strong>$${payoutAmount.toFixed(2)}</strong> will be released to your account.
              </div>
            `;
            completionCodeInputSection.appendChild(payoutInfo);
          } catch (e) {
            console.error('Error calculating payout estimate:', e);
          }
        }
        
        const codeInput = document.createElement("input");
        codeInput.type = "text";
        codeInput.id = `completionCodeInput_${job.id}`;
        codeInput.placeholder = "Enter 6-digit code";
        codeInput.maxLength = 6;
        codeInput.style.cssText = "width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;";
        codeInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
        });
        completionCodeInputSection.appendChild(codeInput);
        
        const verifyBtn = document.createElement("button");
        verifyBtn.className = "btn btn-primary";
        verifyBtn.textContent = "Verify & Complete Job";
        verifyBtn.style.cssText = "width: 100%; padding: 0.75rem;";
        verifyBtn.addEventListener("click", async () => {
          const code = codeInput.value.trim();
          if (code.length !== 6) {
            showToast("Please enter a 6-digit code");
            return;
          }
          
          try {
            verifyBtn.disabled = true;
            verifyBtn.textContent = "Verifying...";
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ code })
            });
            
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.error || "Verification failed");
            }
            
            // Show completion success modal with actual payment data
            if (data.success && data.paymentReleased) {
              showCompletionSuccessModal(job.id, {
                customerId: data.customerId,
                hustlerId: data.hustlerId,
                actualJobAmount: data.actualJobAmount || 0,
                hustlerPayout: data.hustlerPayout || 0,
                actualHours: data.actualHours || null,
                platformFee: data.platformFee || 0
              });
            } else {
              showToast("✅ Completion code verified! Job is now complete.");
            }
            
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            if (typeof loadActiveJobs === 'function') loadActiveJobs();
            if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
            renderJobs();
          } catch (error) {
            showToast("Error: " + (error.message || "Failed to verify"));
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify & Complete Job";
          }
        });
        completionCodeInputSection.appendChild(verifyBtn);
        
        contentSection.appendChild(completionCodeInputSection);
      }
      

      // Customer view: Show applicants if job is posted by current user
      if (user && user.id === job.postedByUserId && (job.status === "OPEN" || job.status === "open")) {
        // Fetch offers from API
        let offers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (offersResponse.ok) {
            offers = await offersResponse.json();
            if (!Array.isArray(offers)) offers = [];
          }
        } catch (e) {
          console.error("Error fetching offers:", e);
        }

        if (offers.length > 0) {
          const applicantsSection = document.createElement("div");
          applicantsSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
          
          const applicantsTitle = document.createElement("div");
          applicantsTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 1rem;";
          applicantsTitle.textContent = `Applicants (${offers.length})`;
          applicantsSection.appendChild(applicantsTitle);

          offers.forEach((offer) => {
            const hustler = offer.hustler || state.users.find((x) => x.id === offer.hustlerId);
            if (!hustler) {
              // Try to fetch hustler from API
              (async () => {
                try {
                  const token = localStorage.getItem("hustl_token");
                  const userResponse = await fetch(`${API_BASE}/users/${offer.hustlerId}`, {
                    headers: token ? { "Authorization": `Bearer ${token}` } : {}
                  });
                  if (userResponse.ok) {
                    const fetchedHustler = await userResponse.json();
                    // Re-render this section with the fetched hustler
                    openJobDetails(job.id);
                  }
                } catch (e) {
                  console.error("Error fetching hustler:", e);
                }
              })();
              return;
            }

            const applicantCard = document.createElement("div");
            applicantCard.style.cssText = "padding: 1.25rem; background: white; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #e5e7eb; transition: all 0.2s;";
            applicantCard.addEventListener("mouseenter", () => {
              applicantCard.style.borderColor = "var(--primary)";
              applicantCard.style.boxShadow = "0 4px 12px rgba(37, 99, 235, 0.1)";
            });
            applicantCard.addEventListener("mouseleave", () => {
              applicantCard.style.borderColor = "#e5e7eb";
              applicantCard.style.boxShadow = "none";
            });

            // Top row: Avatar, Name, Rating
            const topRow = document.createElement("div");
            topRow.style.cssText = "display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;";

            const avatar = document.createElement("div");
            avatar.innerHTML = renderUserAvatar(hustler, 60, { 
              showBorder: true, 
              borderWidth: '2px',
              borderColor: 'var(--primary-soft)',
              style: 'cursor: pointer;'
            });
            avatar.addEventListener("click", () => {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              if (typeof window.showHustlerProfilePopup === 'function') {
                window.showHustlerProfilePopup(hustler.id);
              }
            });
            topRow.appendChild(avatar);

            const nameRating = document.createElement("div");
            nameRating.style.cssText = "flex: 1; min-width: 0;";
            
            const name = document.createElement("div");
            name.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem; cursor: pointer;";
            name.textContent = hustler.name || hustler.username || hustler.email?.split('@')[0] || "Unknown User";
            name.addEventListener("click", () => {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              if (typeof window.showHustlerProfilePopup === 'function') {
                window.showHustlerProfilePopup(hustler.id);
              }
            });
            nameRating.appendChild(name);

            const rating = document.createElement("div");
            rating.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted);";
            const ratingValue = hustler.ratingAvg || hustler.rating || 5.0;
            const ratingCount = hustler.ratingCount || hustler.reviewCount || 0;
            rating.innerHTML = `⭐ <strong>${Number(ratingValue).toFixed(1)}</strong>`;
            if (ratingCount > 0) {
              rating.innerHTML += ` <span>(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>`;
            } else {
              rating.innerHTML += ` <span style="color: #9ca3af;">(No reviews yet)</span>`;
            }
            nameRating.appendChild(rating);
            topRow.appendChild(nameRating);

            applicantCard.appendChild(topRow);

            // Hustler Bio (if available)
            if (hustler.bio) {
              const bioBox = document.createElement("div");
              bioBox.style.cssText = "padding: 0.75rem; background: #f0f9ff; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--text-main); line-height: 1.5; border-left: 3px solid var(--primary);";
              bioBox.textContent = hustler.bio;
              applicantCard.appendChild(bioBox);
            }

            // Tools & Equipment (if available)
            if (hustler.tools) {
              const toolsBox = document.createElement("div");
              toolsBox.style.cssText = "padding: 0.75rem; background: #fef3c7; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.85rem; color: #92400e;";
              toolsBox.innerHTML = `<strong>🔧 Tools & Equipment:</strong> ${hustler.tools}`;
              applicantCard.appendChild(toolsBox);
            }

            // Their Pitch/Note
            if (offer.note) {
              const messageBox = document.createElement("div");
              messageBox.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.95rem; color: var(--text-main); line-height: 1.6; border: 1px solid #e5e7eb;";
              const pitchLabel = document.createElement("div");
              pitchLabel.style.cssText = "font-weight: 600; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;";
              pitchLabel.textContent = "💬 Why I'm a good fit:";
              messageBox.appendChild(pitchLabel);
              const pitchText = document.createElement("div");
              pitchText.style.cssText = "white-space: pre-wrap;";
              pitchText.textContent = offer.note;
              messageBox.appendChild(pitchText);
              applicantCard.appendChild(messageBox);
            }
            
            // Show proposed price
            const priceBox = document.createElement("div");
            priceBox.style.cssText = "padding: 0.75rem; background: #dcfce7; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.95rem; font-weight: 600;";
            const jobPrice = job.payType === "flat" ? Number(job.amount || job.flatAmount || 0) : Number(job.hourlyRate || 0);
            const proposedPrice = offer.proposedAmount ? Number(offer.proposedAmount) : jobPrice;
            
            if (offer.proposedAmount && proposedPrice !== jobPrice) {
              priceBox.style.background = "#fef3c7";
              priceBox.style.color = "#92400e";
              priceBox.innerHTML = `💰 <strong>Proposed: ${formatMoney(proposedPrice)}${job.payType === 'hourly' ? '/hr' : ''}</strong> <span style="font-weight: normal; font-size: 0.85rem; color: #78350f;">(Original: ${formatMoney(jobPrice)}${job.payType === 'hourly' ? '/hr' : ''})</span>`;
            } else {
              priceBox.style.color = "#166534";
              priceBox.innerHTML = `💰 <strong>Price: ${formatMoney(proposedPrice)}${job.payType === 'hourly' ? '/hr' : ''}</strong> <span style="font-weight: normal; font-size: 0.85rem; color: #15803d;">(Accepting listed price)</span>`;
            }
            applicantCard.appendChild(priceBox);

            const actionsRow = document.createElement("div");
            actionsRow.style.cssText = "display: flex; gap: 0.5rem;";

            const viewProfileBtn = document.createElement("button");
            viewProfileBtn.className = "btn btn-ghost";
            viewProfileBtn.textContent = "View Profile";
            viewProfileBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
            viewProfileBtn.addEventListener("click", () => {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              if (typeof window.showHustlerProfilePopup === 'function') {
                window.showHustlerProfilePopup(hustler.id);
              }
            });
            actionsRow.appendChild(viewProfileBtn);

            if (!job.hustlerId && !job.acceptedHustlerId) {
              // Check if job was posted as "hustlers decide their price"
              const pricingOption = job.requirements?.pricing_option;
              const isHustlersQuoteJob = pricingOption === "hustlers_quote";
              
              // Check if hustler suggested a price (proposedAmount exists and differs from job amount)
              const hustlerSuggestedPrice = offer.proposedAmount && 
                Math.abs(parseFloat(offer.proposedAmount) - parseFloat(job.amount || 0)) > 0.01;
              
              // If job is NOT hustlers_quote OR hustler suggested price, only show Accept/Deny (no counter-offer)
              // Only hustlers_quote jobs allow customer to negotiate
              if (!isHustlersQuoteJob || hustlerSuggestedPrice) {
                const acceptBtn = document.createElement("button");
                acceptBtn.className = "btn btn-primary";
                acceptBtn.textContent = "Accept Hustler";
                acceptBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
                acceptBtn.addEventListener("click", async () => {
                acceptBtn.disabled = true;
                acceptBtn.textContent = "Accepting...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  
                  // First, try to accept the offer
                  let response = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });

                  if (!response.ok) {
                    const errorData = await response.json();
                    
                    // If payment is required, create payment intent and show payment modal
                    if (errorData.requiresPayment) {
                      acceptBtn.disabled = false;
                      acceptBtn.textContent = "Accept Hustler";
                      
                      // Create payment intent
                      const paymentResponse = await fetch(`${API_BASE}/payments/create-intent/offer/${offer.id}`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        }
                      });
                      
                      if (!paymentResponse.ok) {
                        const paymentError = await paymentResponse.json();
                        throw new Error(paymentError.error || "Failed to create payment");
                      }
                      
                      const paymentData = await paymentResponse.json();
                      
                      // Close job modal first
                      document.body.removeChild(modalOverlay);
                      document.body.style.overflow = "";
                      
                      // Show Stripe payment modal with amount breakdown
                      await showStripePaymentModal(
                        paymentData.clientSecret, 
                        job.id, 
                        async (paymentIntentId) => {
                          // After payment succeeds, accept the offer with paymentIntentId
                        try {
                          const acceptResponse = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                            method: 'POST',
                            headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ paymentIntentId })
                          });
                          
                          if (!acceptResponse.ok) {
                            const acceptError = await acceptResponse.json();
                            throw new Error(acceptError.error || "Failed to accept offer");
                          }
                          
                          showToast("✅ Hustler accepted! You can now message them.");
                          openJobDetails(job.id);
                          renderJobs();
                        } catch (acceptError) {
                          showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                        }
                      },
                      paymentData.amount // Pass amount breakdown
                    );
                      
                      return;
                    }
                    
                    throw new Error(errorData.error || 'Failed to accept hustler');
                  }

                  const data = await response.json();
                  
                  showToast("✅ Hustler accepted! You can now message them.");
                  document.body.removeChild(modalOverlay);
                  document.body.style.overflow = "";
                  openJobDetails(job.id);
                  renderJobs();
                } catch (error) {
                  console.error("Error accepting hustler:", error);
                  showToast("Failed to accept hustler: " + (error.message || "Unknown error"));
                  acceptBtn.disabled = false;
                  acceptBtn.textContent = "Accept Hustler";
                }
              });
              actionsRow.appendChild(acceptBtn);
              
              // Add Deny button when hustler suggested price
              const denyBtn = document.createElement("button");
              denyBtn.className = "btn btn-ghost";
              denyBtn.textContent = "Deny";
              denyBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem; color: #dc2626; border-color: #fecaca;";
              denyBtn.addEventListener("click", async () => {
                if (!confirm("Are you sure you want to deny this hustler's application?")) {
                  return;
                }
                
                denyBtn.disabled = true;
                denyBtn.textContent = "Denying...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  const response = await fetch(`${API_BASE}/offers/${offer.id}/decline`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });
                  
                  if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to deny hustler');
                  }
                  
                  showToast("Hustler application denied.");
                  document.body.removeChild(modalOverlay);
                  document.body.style.overflow = "";
                  openJobDetails(job.id);
                  renderJobs();
                } catch (error) {
                  console.error("Error denying hustler:", error);
                  showToast("Failed to deny hustler: " + (error.message || "Unknown error"));
                  denyBtn.disabled = false;
                  denyBtn.textContent = "Deny";
                }
              });
              actionsRow.appendChild(denyBtn);
              } else {
                // Job IS hustlers_quote AND hustler didn't suggest price - show Accept button (customer can negotiate if needed)
                const acceptBtnNoPrice = document.createElement("button");
                acceptBtnNoPrice.className = "btn btn-primary";
                acceptBtnNoPrice.textContent = "Accept Hustler";
                acceptBtnNoPrice.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
                acceptBtnNoPrice.addEventListener("click", async () => {
                  acceptBtnNoPrice.disabled = true;
                  acceptBtnNoPrice.textContent = "Accepting...";
                  
                  try {
                    const token = localStorage.getItem("hustl_token");
                    
                    // First, try to accept the offer
                    let response = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                      }
                    });

                    if (!response.ok) {
                      const errorData = await response.json();
                      
                      // If payment is required, create payment intent and show payment modal
                      if (errorData.requiresPayment) {
                        acceptBtnNoPrice.disabled = false;
                        acceptBtnNoPrice.textContent = "Accept Hustler";
                        
                        // Create payment intent
                        const paymentResponse = await fetch(`${API_BASE}/payments/create-intent/offer/${offer.id}`, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                          }
                        });
                        
                        if (!paymentResponse.ok) {
                          const paymentError = await paymentResponse.json();
                          throw new Error(paymentError.error || "Failed to create payment");
                        }
                        
                        const paymentData = await paymentResponse.json();
                        
                        // Close job modal first
                        document.body.removeChild(modalOverlay);
                        document.body.style.overflow = "";
                        
                        // Show Stripe payment modal with amount breakdown
                        await showStripePaymentModal(
                          paymentData.clientSecret, 
                          job.id, 
                          async (paymentIntentId) => {
                          // After payment succeeds, accept the offer with paymentIntentId
                          try {
                            const acceptResponse = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                              method: 'POST',
                              headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                              },
                              body: JSON.stringify({ paymentIntentId })
                            });
                            
                            if (!acceptResponse.ok) {
                              const acceptError = await acceptResponse.json();
                              throw new Error(acceptError.error || "Failed to accept offer");
                            }
                            
                            showToast("✅ Hustler accepted! You can now message them.");
                            openJobDetails(job.id);
                            renderJobs();
                          } catch (acceptError) {
                            showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                          }
                        });
                        
                        return;
                      }
                      
                      throw new Error(errorData.error || 'Failed to accept hustler');
                    }

                    const data = await response.json();
                    
                    showToast("✅ Hustler accepted! You can now message them.");
                    document.body.removeChild(modalOverlay);
                    document.body.style.overflow = "";
                    openJobDetails(job.id);
                    renderJobs();
                  } catch (error) {
                    console.error("Error accepting hustler:", error);
                    showToast("Failed to accept hustler: " + (error.message || "Unknown error"));
                    acceptBtnNoPrice.disabled = false;
                    acceptBtnNoPrice.textContent = "Accept Hustler";
                  }
                });
                actionsRow.appendChild(acceptBtnNoPrice);
              }
            }

            applicantCard.appendChild(actionsRow);
            applicantsSection.appendChild(applicantCard);
          });

          contentSection.appendChild(applicantsSection);
        }
      }

      // Old code removed - keeping only essential parts
      if (false) {
        // Check if user already applied
        let userOffer = null;
        let allOffers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const response = await fetch(`/offers/${jobId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (response.ok) {
            const offersData = await response.json();
            allOffers = Array.isArray(offersData) ? offersData : [];
            userOffer = allOffers.find(o => o.hustlerId === user?.id);
          }
        } catch (error) {
          console.error("Error fetching offers:", error);
        }

        const applySection = document.createElement("div");
        applySection.style.marginTop = "1.5rem";
        applySection.style.padding = "1rem";
        applySection.style.background = "#f0f9ff";
        applySection.style.borderRadius = "8px";
        applySection.style.border = "1px solid #bae6fd";

        if (userOffer) {
          const appliedTitle = document.createElement("h3");
          appliedTitle.style.margin = "0 0 0.5rem 0";
          appliedTitle.style.fontSize = "1.1rem";
          appliedTitle.textContent = "You've Applied";
          applySection.appendChild(appliedTitle);

          const appliedStatus = document.createElement("div");
          appliedStatus.className = "muted";
          appliedStatus.style.marginBottom = "0.5rem";
          const offerStatus = (userOffer.status || "PENDING").toUpperCase();
          if (offerStatus === "ACCEPTED") {
            appliedStatus.textContent = "✓ Your application was accepted!";
            appliedStatus.style.color = "#059669";
          } else if (offerStatus === "DECLINED") {
            appliedStatus.textContent = "Your application was declined.";
            appliedStatus.style.color = "#dc2626";
          } else {
            appliedStatus.textContent = "Waiting for customer to accept offer";
          }
          applySection.appendChild(appliedStatus);

          if (userOffer.note) {
            const note = document.createElement("div");
            note.style.marginTop = "0.5rem";
            note.style.padding = "0.75rem";
            note.style.background = "#fff";
            note.style.borderRadius = "6px";
            note.style.fontSize = "0.9rem";
            note.textContent = userOffer.note;
            applySection.appendChild(note);
          }
          
          // Add message button if accepted
          if (offerStatus === "ACCEPTED" && job.customerId) {
            const messageBtn = document.createElement("button");
            messageBtn.className = "btn btn-primary";
            messageBtn.style.marginTop = "0.75rem";
            messageBtn.style.width = "100%";
            messageBtn.textContent = "💬 Message Customer";
            messageBtn.addEventListener("click", async () => {
              // Set active conversation and switch to messages view
              activeConversationJobId = job.id;
              overlay.remove();
              document.body.style.overflow = "";
              
              // Switch to messages view
              if (window.setView && typeof window.setView === 'function') {
                const funcStr = window.setView.toString();
                const isStub = funcStr.includes('not ready yet');
                if (!isStub) {
                  await window.setView("messages");
                } else {
                  // Use fallback
                  activeView = "messages";
                  window.activeView = "messages";
                  document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
                  const target = document.getElementById("view-messages");
                  if (target) target.style.display = "block";
                  document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === "messages"));
                  await renderAll();
                }
              }
              
              // Small delay to ensure messages view is rendered, then open conversation
              setTimeout(async () => {
                await renderMessagesView();
                // Find and click the conversation for this job
                const conversationItems = document.querySelectorAll('[data-job-id]');
                conversationItems.forEach(item => {
                  if (item.dataset.jobId === job.id) {
                    item.click();
                  }
                });
              }, 300);
            });
            applySection.appendChild(messageBtn);
            
            // Hustler verification codes section
            const hustlerVerifySection = document.createElement("div");
            hustlerVerifySection.style.marginTop = "1rem";
            
            const arrivalVerified = job.arrivalCodeVerified;
            const completionCode = job.completionCode;
            const completionVerified = job.completionCodeVerified;
            
            if (!arrivalVerified) {
              // Hustler needs to enter arrival code from customer
              hustlerVerifySection.innerHTML = `
                <div style="padding: 0.75rem; background: #fef3c7; border-radius: 8px; border: 2px solid #f59e0b;">
                  <div style="font-weight: 600; font-size: 0.9rem; color: #92400e; margin-bottom: 0.5rem;">🔐 Step 1: Enter Arrival Code</div>
                  <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.5rem;">When you arrive, ask the customer for their 4-digit arrival code.</div>
                  <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="hustlerArrivalInput_${job.id}" placeholder="Enter code" maxlength="4"
                      style="flex: 1; padding: 0.75rem; font-size: 1.25rem; text-align: center; letter-spacing: 0.2em; border: 2px solid #f59e0b; border-radius: 8px; font-family: 'Courier New', monospace;" />
                    <button id="verifyArrivalBtn_${job.id}" class="btn" style="padding: 0.75rem 1rem; background: #f59e0b; color: white; border: none;">I Arrived</button>
                  </div>
                </div>
              `;
            } else if (completionCode && !completionVerified) {
              // Hustler gives completion code to customer
              hustlerVerifySection.innerHTML = `
                <div style="padding: 0.75rem; background: #dcfce7; border-radius: 8px; border: 2px solid #16a34a; margin-bottom: 0.5rem;">
                  <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem;">✅ Arrival Confirmed!</div>
                  <div style="font-size: 0.85rem; color: #166534;">You can now start the job.</div>
                </div>
                <div style="padding: 0.75rem; background: #dbeafe; border-radius: 8px; border: 2px solid #3b82f6;">
                  <div style="font-weight: 600; font-size: 0.9rem; color: #1e40af; margin-bottom: 0.5rem;">🔐 Step 2: Completion Code</div>
                  <div style="font-size: 0.8rem; color: #1e3a8a; margin-bottom: 0.5rem;">When job is done, give this code to the customer to release payment:</div>
                  <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #1e40af; text-align: center; font-family: 'Courier New', monospace; padding: 0.5rem; background: white; border-radius: 8px;">
                    ${completionCode}
                  </div>
                </div>
              `;
            } else if (completionVerified) {
              hustlerVerifySection.innerHTML = `
                <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; border: 2px solid #16a34a; text-align: center;">
                  <div style="font-weight: 600; font-size: 1rem; color: #166534;">✅ Job Complete!</div>
                  <div style="font-size: 0.85rem; color: #166534; margin-top: 0.25rem;">Payment has been released to you.</div>
                </div>
              `;
            }
            
            applySection.appendChild(hustlerVerifySection);
            
            // Add event listener for arrival code verification
            if (!arrivalVerified) {
              const verifyBtn = document.getElementById(`verifyArrivalBtn_${job.id}`);
              const codeInput = document.getElementById(`hustlerArrivalInput_${job.id}`);
              if (verifyBtn && codeInput) {
                verifyBtn.addEventListener("click", async () => {
                  const code = codeInput.value.trim();
                  if (!code || code.length !== 4) {
                    showToast("Please enter a 4-digit code");
                    return;
                  }
                  try {
                    verifyBtn.disabled = true;
                    verifyBtn.textContent = "...";
                    const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-start`, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${authToken}`
                      },
                      body: JSON.stringify({ code })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                      throw new Error(data.error || "Verification failed");
                    }
                    showToast("✅ Arrival verified! Start the job.");
                    overlay.remove();
                    document.body.style.overflow = "";
                    openJobDetails(job.id); // Refresh
                  } catch (error) {
                    showToast("Error: " + (error.message || "Failed to verify"));
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "I Arrived";
                  }
                });
                codeInput.addEventListener("keypress", (e) => {
                  if (e.key === "Enter") verifyBtn.click();
                });
              }
            }
          }
        } else {
          const applyTitle = document.createElement("h3");
          applyTitle.style.margin = "0 0 1rem 0";
          applyTitle.style.fontSize = "1.1rem";
          applyTitle.style.display = "flex";
          applyTitle.style.alignItems = "center";
          applyTitle.style.gap = "0.5rem";
          applyTitle.innerHTML = "🎯 Apply for this Job";
          applySection.appendChild(applyTitle);

          const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
          const originalAmount = job.payType === "flat" 
            ? Number(job.amount || 0)
            : (Number(job.hourlyRate || 0) * Number(job.estHours || 0) * teamSize);
          
          // Check if this is a hustler-suggested-price job
          const pricingOption = job.requirements?.pricing_option;
          const isHustlerSuggestedPrice = pricingOption === "hustlers_quote";
          
          // Enhanced Price Section - Uber-style
          const pricingSection = document.createElement("div");
          pricingSection.style.cssText = `
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
          `;

          // Show suggested price box only if hustler suggests price
          if (isHustlerSuggestedPrice) {
            const suggestedPriceBox = document.createElement("div");
            suggestedPriceBox.style.cssText = `
              background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
              border: 2px solid #f59e0b;
              border-radius: 12px;
              padding: 1rem;
              margin-bottom: 1rem;
              text-align: center;
            `;
            suggestedPriceBox.innerHTML = `
              <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.5rem; font-weight: 600;">💰 Suggested Price</div>
              <div style="font-size: 1.75rem; font-weight: 700; color: #78350f;">$${originalAmount.toFixed(0)}</div>
              <div style="font-size: 0.85rem; color: #92400e; margin-top: 0.25rem;">You can suggest your own price below</div>
            `;
            pricingSection.appendChild(suggestedPriceBox);
          }

          // Customer's offered price (only show if not hustler-suggested-price)
          if (!isHustlerSuggestedPrice) {
            const customerOffer = document.createElement("div");
            customerOffer.style.cssText = `
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-bottom: 0.75rem;
              padding-bottom: 0.75rem;
              border-bottom: 1px solid #bae6fd;
            `;
            
            let priceDisplay = "";
            if (job.payType === "hourly") {
              const hourlyRate = Number(job.hourlyRate || 0);
              const estHours = job.estHours || 0;
              priceDisplay = `$${hourlyRate.toFixed(0)}/hr`;
              if (teamSize > 1) {
                priceDisplay += ` × ${teamSize} people`;
              }
              priceDisplay += ` · ${estHours}h max`;
            } else {
              priceDisplay = `$${originalAmount.toFixed(0)}`;
            }
            
            customerOffer.innerHTML = `
              <div>
                <div style="font-size: 0.8rem; color: #0369a1; margin-bottom: 0.25rem;">💰 Customer's Offer</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #0c4a6e;">${priceDisplay}</div>
              </div>
              <div style="text-align: right;">
                <span style="background: #0ea5e9; color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">
                  ${job.payType === "hourly" ? "HOURLY" : "FLAT RATE"}
                </span>
              </div>
            `;
            pricingSection.appendChild(customerOffer);
          }

          // PRICE CHANGE PROPOSAL UI (for hustler to accept/decline)
          const requirements = job.requirements || {};
          const proposedPriceChange = requirements.proposedPriceChange;
          if (proposedPriceChange && proposedPriceChange.status === 'PENDING' && isHustler && job.hustlerId === user?.id) {
            const priceChangeBox = document.createElement("div");
            priceChangeBox.style.cssText = `
              background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
              border: 2px solid #f59e0b;
              border-radius: 12px;
              padding: 1.25rem;
              margin-bottom: 1rem;
            `;
            
            const currentPrice = job.payType === 'hourly' 
              ? (Number(job.hourlyRate || 0) * Number(job.estHours || 0))
              : Number(job.amount || 0);
            
            let proposedPriceText = '';
            let newPrice = currentPrice;
            if (job.payType === 'hourly') {
              const newRate = proposedPriceChange.hourlyRate !== null ? proposedPriceChange.hourlyRate : job.hourlyRate;
              const newHours = proposedPriceChange.estHours !== null ? proposedPriceChange.estHours : job.estHours;
              newPrice = newRate * newHours;
              proposedPriceText = `$${newRate.toFixed(2)}/hr × ${newHours} hours = $${newPrice.toFixed(2)}`;
            } else {
              newPrice = proposedPriceChange.amount !== null ? proposedPriceChange.amount : job.amount;
              proposedPriceText = `$${newPrice.toFixed(2)}`;
            }
            
            priceChangeBox.innerHTML = `
              <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.75rem; font-weight: 700;">💰 Price Change Proposal</div>
              <div style="margin-bottom: 0.75rem;">
                <div style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.25rem;">Current Price:</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #78350f;">$${currentPrice.toFixed(2)}</div>
              </div>
              <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 8px; border: 2px solid #fbbf24;">
                <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.25rem; font-weight: 600;">Proposed New Price:</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #78350f;">${proposedPriceText}</div>
              </div>
              <div style="display: flex; gap: 0.75rem;">
                <button id="acceptPriceChangeBtn" class="btn btn-primary" style="flex: 1; padding: 0.875rem; font-weight: 700; background: #10b981; border: none; border-radius: 8px; color: white; cursor: pointer;">
                  ✓ Accept Updated Price
                </button>
                <button id="declinePriceChangeBtn" class="btn btn-ghost" style="flex: 1; padding: 0.875rem; font-weight: 700; background: #fee2e2; border: 2px solid #dc2626; border-radius: 8px; color: #dc2626; cursor: pointer;">
                  ✗ Decline
                </button>
              </div>
              <div style="font-size: 0.75rem; color: #92400e; margin-top: 0.75rem; text-align: center;">
                ⚠️ If you decline, the customer may unassign you and select another hustler.
              </div>
            `;
            pricingSection.appendChild(priceChangeBox);
            
            // Add event listeners after appending
            setTimeout(() => {
              const acceptBtn = priceChangeBox.querySelector('#acceptPriceChangeBtn');
              const declineBtn = priceChangeBox.querySelector('#declinePriceChangeBtn');
              
              if (acceptBtn) {
                acceptBtn.addEventListener('click', async () => {
                  acceptBtn.disabled = true;
                  acceptBtn.textContent = 'Processing...';
                  try {
                    const token = localStorage.getItem('hustl_token');
                    const response = await fetch(`${API_BASE}/jobs/${job.id}/accept-price-change`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (response.ok) {
                      showToast('✅ Price change accepted! Payment authorization updated.');
                      // Refresh job details
                      window.openJobDetails(job.id);
                    } else {
                      const error = await response.json();
                      showToast(error.error || 'Failed to accept price change');
                      acceptBtn.disabled = false;
                      acceptBtn.textContent = '✓ Accept Updated Price';
                    }
                  } catch (error) {
                    console.error('Error accepting price change:', error);
                    showToast('Error accepting price change. Please try again.');
                    acceptBtn.disabled = false;
                    acceptBtn.textContent = '✓ Accept Updated Price';
                  }
                });
              }
              
              if (declineBtn) {
                declineBtn.addEventListener('click', async () => {
                  if (!confirm('Are you sure you want to decline this price change? The customer may unassign you.')) {
                    return;
                  }
                  declineBtn.disabled = true;
                  declineBtn.textContent = 'Processing...';
                  try {
                    const token = localStorage.getItem('hustl_token');
                    const response = await fetch(`${API_BASE}/jobs/${job.id}/decline-price-change`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (response.ok) {
                      showToast('Price change declined. Job remains at original price.');
                      // Refresh job details
                      window.openJobDetails(job.id);
                    } else {
                      const error = await response.json();
                      showToast(error.error || 'Failed to decline price change');
                      declineBtn.disabled = false;
                      declineBtn.textContent = '✗ Decline';
                    }
                  } catch (error) {
                    console.error('Error declining price change:', error);
                    showToast('Error declining price change. Please try again.');
                    declineBtn.disabled = false;
                    declineBtn.textContent = '✗ Decline';
                  }
                });
              }
            }, 100);
          }

          // Your Price section
          const yourPrice = document.createElement("div");
          
          // Price toggle tabs
          yourPrice.innerHTML = `
            <div style="font-size: 0.85rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;">
              💵 Your Price
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
              <button type="button" id="acceptPriceBtn" class="price-toggle-btn" style="flex: 1; padding: 0.6rem; border: 2px solid #10b981; background: #ecfdf5; color: #059669; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                ✓ Accept $${job.payType === "hourly" ? Number(job.hourlyRate || 0).toFixed(0) : originalAmount.toFixed(0)}
              </button>
              <button type="button" id="counterPriceBtn" class="price-toggle-btn" style="flex: 1; padding: 0.6rem; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                💬 Counter Offer
              </button>
            </div>
            <div id="counterOfferSection" style="display: none;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem; color: #0f172a;">$</span>
                <input type="number" id="proposedAmount" value="${job.payType === "hourly" ? Number(job.hourlyRate || 0).toFixed(2) : originalAmount.toFixed(2)}" 
                  style="flex: 1; padding: 0.75rem; font-size: 1.25rem; font-weight: 600; border: 2px solid #3b82f6; border-radius: 8px; text-align: center;"
                  min="0" step="0.01" />
                <span style="font-size: 0.85rem; color: #64748b;">${job.payType === "hourly" ? "/hr" : "total"}</span>
              </div>
              <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #64748b; text-align: center;">
                Customer will see your suggested price
              </p>
            </div>
          `;
          pricingSection.appendChild(yourPrice);
          applySection.appendChild(pricingSection);

          // Hidden checkbox for compatibility with existing logic
          const negotiateCheckbox = document.createElement("input");
          negotiateCheckbox.type = "checkbox";
          negotiateCheckbox.id = "negotiatePrice";
          negotiateCheckbox.style.display = "none";
          applySection.appendChild(negotiateCheckbox);
          
          const proposedAmountField = document.getElementById("proposedAmount") || document.querySelector('#proposedAmount');

          // Add click handlers for price toggle buttons
          setTimeout(() => {
            const acceptBtn = document.getElementById("acceptPriceBtn");
            const counterBtn = document.getElementById("counterPriceBtn");
            const counterSection = document.getElementById("counterOfferSection");
            const negotiateCheck = document.getElementById("negotiatePrice");
            
            if (acceptBtn && counterBtn) {
              acceptBtn.addEventListener("click", () => {
                acceptBtn.style.border = "2px solid #10b981";
                acceptBtn.style.background = "#ecfdf5";
                acceptBtn.style.color = "#059669";
                counterBtn.style.border = "2px solid #e2e8f0";
                counterBtn.style.background = "white";
                counterBtn.style.color = "#64748b";
                counterSection.style.display = "none";
                if (negotiateCheck) negotiateCheck.checked = false;
              });
              
              counterBtn.addEventListener("click", () => {
                counterBtn.style.border = "2px solid #3b82f6";
                counterBtn.style.background = "#eff6ff";
                counterBtn.style.color = "#2563eb";
                acceptBtn.style.border = "2px solid #e2e8f0";
                acceptBtn.style.background = "white";
                acceptBtn.style.color = "#64748b";
                counterSection.style.display = "block";
                if (negotiateCheck) negotiateCheck.checked = true;
                const amtField = document.getElementById("proposedAmount");
                if (amtField) amtField.focus();
              });
            }
          }, 0);

          // "Why I'm a Good Fit" Section - Mini Application
          const applicationSection = document.createElement("div");
          applicationSection.style.cssText = `
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
          `;
          
          applicationSection.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="font-size: 1.25rem;">📝</span>
              <h4 style="margin: 0; font-size: 1rem; color: var(--text-main);">Your Application</h4>
            </div>
            
            <!-- Why I'm a Good Fit -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Why are you a good fit for this job? <span style="color: #ef4444;">*</span>
              </label>
              <textarea id="applyNoteField" rows="4" placeholder="Tell the customer about your experience, skills, and why you're perfect for this job..."
                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 100px;"></textarea>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                <span style="font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">💡 Mention your experience</span>
                <span style="font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">🚚 List equipment you have</span>
                <span style="font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">📅 When you're available</span>
              </div>
            </div>
            
            <!-- Equipment You Have -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                What equipment do you have? <span style="color: #6b7280; font-weight: 400;">(optional)</span>
              </label>
              <div id="hustlerEquipmentChecks" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="truck" style="width: 20px; height: 20px; min-width: 20px; min-height: 20px; margin: 0; padding: 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;" />
                  🚛 Truck
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="trailer" style="width: 20px; height: 20px; min-width: 20px; min-height: 20px; margin: 0; padding: 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;" />
                  🚛 Trailer
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="straps" style="width: 20px; height: 20px; min-width: 20px; min-height: 20px; margin: 0; padding: 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;" />
                  🔗 Moving Straps
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="dolly" style="width: 20px; height: 20px; min-width: 20px; min-height: 20px; margin: 0; padding: 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;" />
                  🛒 Dolly
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="tools" style="width: 20px; height: 20px; min-width: 20px; min-height: 20px; margin: 0; padding: 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0;" />
                  🔧 Tools
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="mower" style="accent-color: var(--primary);" />
                  🌿 Lawn Mower
                </label>
              </div>
            </div>
            
            <!-- Estimated Time -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Estimated time to complete <span style="color: #6b7280; font-weight: 400;">(optional)</span>
              </label>
              <select id="estimatedTime" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem; background: white;">
                <option value="">Select estimated time...</option>
                <option value="30min">30 minutes</option>
                <option value="1hr">1 hour</option>
                <option value="2hr">2 hours</option>
                <option value="3hr">3 hours</option>
                <option value="4hr">4 hours</option>
                <option value="half-day">Half day (4-6 hours)</option>
                <option value="full-day">Full day (6-8 hours)</option>
                <option value="multi-day">Multiple days</option>
              </select>
            </div>
            
            <!-- Price Reason (only shown when counter offer) -->
            <div id="priceReasonSection" style="display: none; margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Why are you suggesting a different price? <span style="color: #ef4444;">*</span>
              </label>
              <textarea id="priceReasonField" rows="2" placeholder="Explain why your price is different (e.g., more equipment needed, extra distance, etc.)"
                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical;"></textarea>
            </div>
          `;
          applySection.appendChild(applicationSection);
          
          // Show/hide price reason based on counter offer selection
          setTimeout(() => {
            const counterBtn = document.getElementById("counterPriceBtn");
            const acceptBtn = document.getElementById("acceptPriceBtn");
            const priceReasonSection = document.getElementById("priceReasonSection");
            
            if (counterBtn && priceReasonSection) {
              counterBtn.addEventListener("click", () => {
                priceReasonSection.style.display = "block";
              });
            }
            if (acceptBtn && priceReasonSection) {
              acceptBtn.addEventListener("click", () => {
                priceReasonSection.style.display = "none";
              });
            }
          }, 10);

          // Review Profile button
          const reviewProfileBtn = document.createElement("button");
          reviewProfileBtn.className = "small-btn outline";
          reviewProfileBtn.textContent = "👤 Review Customer Profile";
          reviewProfileBtn.style.width = "100%";
          reviewProfileBtn.style.marginBottom = "0.75rem";
          reviewProfileBtn.style.padding = "0.6rem";
          reviewProfileBtn.style.fontSize = "0.9rem";
          reviewProfileBtn.addEventListener("click", () => {
            if (typeof window.showHustlerProfilePopup === 'function') {
              window.showHustlerProfilePopup(job.customerId);
            }
          });
          applySection.appendChild(reviewProfileBtn);

          // Hidden noteField for compatibility - we'll populate it with structured data
          const noteField = document.createElement("textarea");
          noteField.id = "applyNoteFieldHidden";
          noteField.style.display = "none";
          applySection.appendChild(noteField);

          const applyBtn = document.createElement("button");
          applyBtn.className = "btn btn-primary";
          applyBtn.textContent = "Apply as Hustler";
          applyBtn.style.width = "100%";
          applyBtn.style.minHeight = "48px"; // Better touch target
          applyBtn.style.fontSize = "1rem";
          applyBtn.style.fontWeight = "600";
          
          // Handle both click and touch events for better mobile support
          const handleApply = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // NOTE: We do NOT validate hustler's profile zip code
            // Hustlers can apply to any job in Tennessee, regardless of their profile location
            // The backend validates that the JOB is in Tennessee (via pickupZip)
            
            // Get "Why I'm a Good Fit" text
            const whyFitField = document.getElementById("applyNoteField");
            const whyFit = whyFitField ? whyFitField.value.trim() : "";
            if (!whyFit) {
              showToast("Please explain why you're a good fit for this job.");
              if (whyFitField) whyFitField.focus();
              return;
            }
            
            // Get equipment the hustler has
            const equipmentChecks = document.querySelectorAll('input[name="hustlerEquipment"]:checked');
            const equipment = Array.from(equipmentChecks).map(cb => cb.value);
            
            // Get estimated time
            const estTimeSelect = document.getElementById("estimatedTime");
            const estimatedTime = estTimeSelect ? estTimeSelect.value : "";
            
            // Get proposed amount if negotiating (counter offer)
            let proposedAmount = null;
            let priceReason = "";
            const negotiateCheck = document.getElementById("negotiatePrice");
            const amtField = document.getElementById("proposedAmount");
            const priceReasonField = document.getElementById("priceReasonField");
            
            if (negotiateCheck && negotiateCheck.checked && amtField) {
              proposedAmount = parseFloat(amtField.value);
              if (isNaN(proposedAmount) || proposedAmount <= 0) {
                showToast("Please enter a valid proposed amount.");
                amtField.focus();
                return;
              }
              // Require price reason when counter offering
              priceReason = priceReasonField ? priceReasonField.value.trim() : "";
              if (!priceReason) {
                showToast("Please explain why you're suggesting a different price.");
                if (priceReasonField) priceReasonField.focus();
                return;
              }
            }
            
            // Build structured note with all application info
            let structuredNote = whyFit;
            if (equipment.length > 0) {
              structuredNote += `\n\n📦 Equipment I have: ${equipment.join(", ")}`;
            }
            if (estimatedTime) {
              const timeLabels = {
                "30min": "30 minutes",
                "1hr": "1 hour",
                "2hr": "2 hours",
                "3hr": "3 hours",
                "4hr": "4 hours",
                "half-day": "Half day (4-6 hours)",
                "full-day": "Full day (6-8 hours)",
                "multi-day": "Multiple days"
              };
              structuredNote += `\n\n⏱️ Estimated time: ${timeLabels[estimatedTime] || estimatedTime}`;
            }
            if (priceReason) {
              structuredNote += `\n\n💰 Price reason: ${priceReason}`;
            }
            
            const note = structuredNote;
            
            // Disable button and show loading state
            applyBtn.disabled = true;
            applyBtn.style.opacity = "0.6";
            applyBtn.style.cursor = "not-allowed";
            applyBtn.textContent = "Applying...";

            try {
              const token = localStorage.getItem("hustl_token");
              if (!token) {
                showToast("You must be logged in to apply for jobs.");
                applyBtn.disabled = false;
                applyBtn.style.opacity = "1";
                applyBtn.style.cursor = "pointer";
                applyBtn.textContent = "Apply as Hustler";
                return;
              }
              
              console.log("Creating offer for job:", job.id, "with note:", note, "proposedAmount:", proposedAmount);
              
              const response = await fetch(`/offers/${job.id}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                  note,
                  proposedAmount: proposedAmount ? Number(proposedAmount) : null
                })
              });
              
              const result = await response.json();
              
              if (!response.ok) {
                throw new Error(result.error || `Failed to apply: ${response.statusText}`);
              }
              
              console.log("Offer created successfully:", result);
              
              // Show success confirmation modal
              const successOverlay = document.createElement("div");
              successOverlay.className = "modal-overlay";
              successOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
              
              const successModal = document.createElement("div");
              successModal.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
              
              successModal.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Application Sent!</h2>
                <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
                  You've successfully applied to this job.<br>
                  The customer will review your proposal and respond soon.
                </p>
                <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem;">
                  You can manage this application in:<br>
                  <strong style="color: var(--text-main);">Manage → Applied Jobs</strong>
                </p>
                <button class="btn btn-primary" id="gotItBtn2" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
                  Got it
                </button>
              `;
              
              successOverlay.appendChild(successModal);
              document.body.appendChild(successOverlay);
              
              // Handle "Got it" button
              successOverlay.querySelector('#gotItBtn2').addEventListener('click', () => {
                document.body.removeChild(successOverlay);
                setView('manage');
                setTimeout(() => {
                  const appliedTab = document.getElementById('appliedJobsTab');
                  if (appliedTab) {
                    appliedTab.click();
                    if (typeof loadAppliedJobs === 'function') {
                      loadAppliedJobs();
                    }
                  }
                }, 100);
              });
              
              successOverlay.addEventListener('click', (e) => {
                if (e.target === successOverlay) {
                  document.body.removeChild(successOverlay);
                  setView('manage');
                  setTimeout(() => {
                    const appliedTab = document.getElementById('appliedJobsTab');
                    if (appliedTab) {
                      appliedTab.click();
                      if (typeof loadAppliedJobs === 'function') {
                        loadAppliedJobs();
                      }
                    }
                  }, 100);
                }
              });
              
              // Small delay before closing to show success
              setTimeout(() => {
                overlay.remove();
                document.body.style.overflow = "";
                renderJobs();
              }, 500);
            } catch (error) {
              console.error("Error applying for job:", error);
              let errorMsg = error.message || error.toString() || "Failed to apply. Please try again.";
              
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // Check if it's a Stripe requirement error
              /*
              if \(errorMsg.includes\("Stripe"\) \|\| errorMsg.includes\("stripe"\) \|\| error\.requiresStripe\) \{
                errorMsg = "You must connect your Stripe account before applying to jobs. Go to your Profile to set it up.";
                showToast\("âš ï¸ " + errorMsg, 5000\);
                // Close modal and redirect to profile after a moment
                setTimeout\(\(\) => \{
                  overlay\.remove\(\);
                  document\.body\.style\.overflow = "";
                  setView\("profile"\);
                  renderAll\(\);
                  // Scroll to Stripe section
                  setTimeout\(\(\) => \{
                    const stripeSection = document\.querySelector\('\[id\*="stripe"\], \[class\*="stripe"\]'\);
                    if \(stripeSection\) \{
                      stripeSection\.scrollIntoView\(\{ behavior: "smooth", block: "center" \}\);
                    \}
                  \}, 500\);
                \}, 2000\);
                applyBtn\.disabled = false;
                applyBtn\.style\.opacity = "1";
                applyBtn\.style\.cursor = "pointer";
                applyBtn\.textContent = "Apply as Hustler";
                return;
              \}
              \*/
              
              // Show error message
              showToast("Error: " + errorMsg);
              
              applyBtn.disabled = false;
              applyBtn.style.opacity = "1";
              applyBtn.style.cursor = "pointer";
              applyBtn.textContent = "Apply as Hustler";
            }
          };
          
          applyBtn.addEventListener("click", handleApply);
          applyBtn.addEventListener("touchend", handleApply); // Mobile touch support
          applySection.appendChild(applyBtn);
        }

        contentSection.appendChild(applySection);
      }

      // Action Buttons Section
      const actionsSection = document.createElement("div");
      actionsSection.style.marginTop = "1.5rem";
      actionsSection.style.paddingTop = "1.5rem";
      actionsSection.style.borderTop = "1px solid var(--border)";

      // Customer Actions: Payment, Delete/Cancel job
      if (user && user.id === job.customerId && userMode === "customer") {
        
        // Show Applications Section (when job is OPEN and no hustler assigned yet)
        if (!job.hustlerId && (job.status || "").toUpperCase() === "OPEN") {
          const applicationsSection = document.createElement("div");
          applicationsSection.style.cssText = `
            margin-top: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 1px solid #bae6fd;
          `;
          
          // Fetch offers for this job
          let offers = [];
          try {
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`/offers/${jobId}`, {
              headers: token ? { "Authorization": `Bearer ${token}` } : {}
            });
            if (response.ok) {
              offers = await response.json();
            }
          } catch (error) {
            console.error("Error fetching offers:", error);
          }
          
          const pendingOffers = offers.filter(o => o.status === "PENDING");
          
          const sectionHeader = document.createElement("div");
          sectionHeader.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
          `;
          sectionHeader.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">📬</span>
              <div>
                <h3 style="margin: 0; font-size: 1.1rem; color: #0f172a;">Applications</h3>
                <div style="font-size: 0.8rem; color: #64748b;">${pendingOffers.length} ${pendingOffers.length === 1 ? 'hustler' : 'hustlers'} applied</div>
              </div>
            </div>
          `;
          applicationsSection.appendChild(sectionHeader);
          
          if (pendingOffers.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.style.cssText = `
              text-align: center;
              padding: 2rem 1rem;
              color: #64748b;
            `;
            emptyState.innerHTML = `
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">⏳</div>
              <div style="font-weight: 500;">No applications yet</div>
              <div style="font-size: 0.85rem; margin-top: 0.25rem;">Hustlers will start applying soon!</div>
            `;
            applicationsSection.appendChild(emptyState);
          } else {
            // Display each application as a card
            const applicationsGrid = document.createElement("div");
            applicationsGrid.style.cssText = `
              display: flex;
              flex-direction: column;
              gap: 1rem;
            `;
            
            for (const offer of pendingOffers) {
              const hustler = offer.hustler || {};
              const offerCard = document.createElement("div");
              offerCard.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 2px solid transparent;
                transition: all 0.2s;
              `;
              
              // Parse the note for structured data
              const noteText = offer.note || "";
              const hasEquipment = noteText.includes("📦 Equipment I have:");
              const hasEstTime = noteText.includes("⏱️ Estimated time:");
              const hasPriceReason = noteText.includes("💰 Price reason:");
              
              // Extract main message (before structured data)
              let mainMessage = noteText.split("\n\n📦")[0].split("\n\n⏱️")[0].split("\n\n💰")[0];
              
              // Extract equipment
              let equipment = "";
              if (hasEquipment) {
                const eqMatch = noteText.match(/📦 Equipment I have: ([^\n]+)/);
                if (eqMatch) equipment = eqMatch[1];
              }
              
              // Extract estimated time
              let estTime = "";
              if (hasEstTime) {
                const timeMatch = noteText.match(/⏱️ Estimated time: ([^\n]+)/);
                if (timeMatch) estTime = timeMatch[1];
              }
              
              // Extract price reason
              let priceReason = "";
              if (hasPriceReason) {
                const priceMatch = noteText.match(/💰 Price reason: ([^\n]+)/);
                if (priceMatch) priceReason = priceMatch[1];
              }
              
              // Price comparison
              const originalAmount = job.payType === "flat" 
                ? Number(job.amount || 0)
                : (Number(job.hourlyRate || 0) * Number(job.estHours || 0));
              const proposedAmount = offer.proposedAmount ? Number(offer.proposedAmount) : null;
              const isCounterOffer = proposedAmount && Math.abs(proposedAmount - originalAmount) > 0.01;
              
              offerCard.innerHTML = `
                <!-- Hustler Header -->
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                  <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                    ${(hustler.name || "H")[0].toUpperCase()}
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 1rem;">${hustler.name || hustler.username || "Hustler"}</div>
                    <div style="font-size: 0.8rem; color: #64748b;">
                      ${hustler.ratingAvg > 0 ? `⭐ ${Number(hustler.ratingAvg).toFixed(1)} (${hustler.ratingCount || 0} reviews)` : "New hustler"}
                      ${hustler.jobsCompleted > 0 ? ` · ${hustler.jobsCompleted} jobs done` : ""}
                    </div>
                  </div>
                  <button class="view-profile-btn" data-hustler-id="${offer.hustlerId}" style="padding: 0.4rem 0.75rem; background: transparent; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.8rem; color: #374151; cursor: pointer;">
                    View Profile
                  </button>
                </div>
                
                <!-- Price Section -->
                <div style="padding: 0.75rem; background: ${isCounterOffer ? '#fef3c7' : '#dcfce7'}; border-radius: 8px; margin-bottom: 0.75rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 0.75rem; color: ${isCounterOffer ? '#92400e' : '#059669'}; margin-bottom: 0.25rem;">
                        ${isCounterOffer ? '💬 Counter Offer' : '✓ Accepts Your Price'}
                      </div>
                      <div style="font-size: 1.5rem; font-weight: 700; color: ${isCounterOffer ? '#92400e' : '#059669'};">
                        $${proposedAmount ? proposedAmount.toFixed(0) : originalAmount.toFixed(0)}
                        ${job.payType === "hourly" ? '/hr' : ''}
                      </div>
                    </div>
                    ${isCounterOffer ? `
                      <div style="text-align: right;">
                        <div style="font-size: 0.7rem; color: #92400e;">Your offer: $${originalAmount.toFixed(0)}</div>
                        <div style="font-size: 0.75rem; color: ${proposedAmount > originalAmount ? '#dc2626' : '#059669'}; font-weight: 600;">
                          ${proposedAmount > originalAmount ? '+' : ''}$${(proposedAmount - originalAmount).toFixed(0)}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                  ${priceReason ? `
                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid ${isCounterOffer ? '#fcd34d' : '#86efac'}; font-size: 0.85rem; color: ${isCounterOffer ? '#92400e' : '#166534'};">
                      <strong>Reason:</strong> ${priceReason}
                    </div>
                  ` : ''}
                </div>
                
                <!-- Why I'm a Good Fit -->
                <div style="margin-bottom: 0.75rem;">
                  <div style="font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">📝 Why I'm a Good Fit</div>
                  <div style="font-size: 0.9rem; color: #1f2937; line-height: 1.5; padding: 0.5rem; background: #f9fafb; border-radius: 6px;">
                    ${mainMessage || "No message provided"}
                  </div>
                </div>
                
                <!-- Equipment & Time -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                  ${equipment ? `
                    <div style="padding: 0.4rem 0.75rem; background: #e0f2fe; border-radius: 6px; font-size: 0.8rem; color: #0369a1;">
                      📦 ${equipment}
                    </div>
                  ` : ''}
                  ${estTime ? `
                    <div style="padding: 0.4rem 0.75rem; background: #f3e8ff; border-radius: 6px; font-size: 0.8rem; color: #7c3aed;">
                      ⏱️ ${estTime}
                    </div>
                  ` : ''}
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.5rem;">
                  <button class="accept-offer-btn" data-offer-id="${offer.id}" style="flex: 1; padding: 0.75rem; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer;">
                    ✓ Accept ${hustler.name ? hustler.name.split(' ')[0] : 'Hustler'}
                  </button>
                  <button class="decline-offer-btn" data-offer-id="${offer.id}" style="padding: 0.75rem 1rem; background: transparent; color: #dc2626; border: 1px solid #fca5a5; border-radius: 8px; font-weight: 500; cursor: pointer;">
                    ✗
                  </button>
                </div>
              `;
              
              applicationsGrid.appendChild(offerCard);
            }
            
            applicationsSection.appendChild(applicationsGrid);
          }
          
          actionsSection.appendChild(applicationsSection);
          
          // Add event handlers for application actions
          setTimeout(() => {
            // View Profile buttons
            applicationsSection.querySelectorAll('.view-profile-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const hustlerId = btn.dataset.hustlerId;
                if (hustlerId && typeof window.showHustlerProfilePopup === 'function') {
                  window.showHustlerProfilePopup(hustlerId);
                }
              });
            });
            
            // Accept buttons
            applicationsSection.querySelectorAll('.accept-offer-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const offerId = btn.dataset.offerId;
                if (!offerId) return;
                
                btn.disabled = true;
                btn.textContent = "Accepting...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  
                  // First, try to accept the offer
                  let response = await fetch(`/offers/${offerId}/accept`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${token}`
                    }
                  });
                  
                  if (!response.ok) {
                    const errorData = await response.json();
                    
                    // If payment is required, create payment intent and show payment modal
                    if (errorData.requiresPayment) {
                      btn.disabled = false;
                      btn.textContent = "✓ Accept";
                      
                      // Create payment intent
                      const paymentResponse = await fetch(`/payments/create-intent/offer/${offerId}`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        }
                      });
                      
                      if (!paymentResponse.ok) {
                        const paymentError = await paymentResponse.json();
                        throw new Error(paymentError.error || "Failed to create payment");
                      }
                      
                      const paymentData = await paymentResponse.json();
                      
                      // Show Stripe payment modal
                      await showStripePaymentModal(paymentData.clientSecret, jobId, async (paymentIntentId) => {
                        // After payment succeeds, accept the offer with paymentIntentId
                        try {
                          const acceptResponse = await fetch(`/offers/${offerId}/accept`, {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              "Authorization": `Bearer ${token}`
                            },
                            body: JSON.stringify({ paymentIntentId })
                          });
                          
                          if (!acceptResponse.ok) {
                            const acceptError = await acceptResponse.json();
                            throw new Error(acceptError.error || "Failed to accept offer");
                          }
                          
                          showToast("✓ Hustler accepted! You can now message them.");
                          overlay.remove();
                          document.body.style.overflow = "";
                          openJobDetails(jobId); // Refresh
                        } catch (acceptError) {
                          showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                        }
                      },
                      paymentData.amount // Pass amount breakdown
                    );
                      
                      return;
                    }
                    
                    throw new Error(errorData.error || "Failed to accept");
                  }
                  
                  showToast("✓ Hustler accepted! You can now message them.");
                  overlay.remove();
                  document.body.style.overflow = "";
                  openJobDetails(jobId); // Refresh
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to accept"));
                  btn.disabled = false;
                  btn.textContent = "✓ Accept";
                }
              });
            });
            
            // Decline buttons
            applicationsSection.querySelectorAll('.decline-offer-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const offerId = btn.dataset.offerId;
                if (!offerId) return;
                
                const card = btn.closest('div[style*="background: white"]');
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  await fetch(`/offers/${offerId}/reject`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${token}`
                    }
                  });
                  
                  if (card) {
                    card.style.opacity = "0.5";
                    card.style.transform = "scale(0.95)";
                    setTimeout(() => card.remove(), 300);
                  }
                  showToast("Application declined");
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to decline"));
                }
              });
            });
          }, 0);
        }
        
        // Show accepted hustler info if one is assigned
        if (job.hustlerId && job.hustler) {
          const hustlerInfo = document.createElement("div");
          hustlerInfo.style.marginBottom = "1rem";
          hustlerInfo.style.padding = "1rem";
          hustlerInfo.style.background = "#dcfce7";
          hustlerInfo.style.borderRadius = "8px";
          hustlerInfo.style.border = "1px solid #86efac";
          
          const statusUpper = (job.status || "").toUpperCase();
          let statusText = "";
          // Simplified status messages with verification flow
          if (statusUpper === "SCHEDULED" || statusUpper === "ASSIGNED") {
            if (!job.startCodeVerified) {
              statusText = "Give the start code to the hustler when they arrive and are ready to begin.";
            } else if (!job.completionCodeVerified) {
              statusText = "Job in progress. Enter completion code when done.";
            } else {
              statusText = "Job verified. Payment released!";
            }
          } else if (statusUpper === "PAID") {
            statusText = "Job is complete. Payment released!";
          } else if (statusUpper === "COMPLETED_BY_HUSTLER" || statusUpper === "AWAITING_CUSTOMER_CONFIRM") {
            statusText = "Hustler marked job as complete. Please confirm completion.";
          } else {
            statusText = "Job status: " + (statusUpper === "OPEN" ? "Open" : statusUpper === "CANCELLED" ? "Cancelled" : statusUpper);
          }
          
          // Check for hustler status update
          // requirements already declared above at line 4066, reuse it
          const hustlerStatus = requirements.hustlerStatus;
          const statusUpdatedAt = requirements.hustlerStatusUpdatedAt;
          
          let statusUpdateDisplay = "";
          if (hustlerStatus) {
            const statusMessages = {
              on_the_way: "🚗 On the way",
              starting: "🏁 Starting the job",
              almost_done: "⚡ Almost done",
              just_finished: "✅ Just finished",
            };
            const statusMsg = statusMessages[hustlerStatus] || hustlerStatus;
            const updatedTime = statusUpdatedAt ? timeAgo(new Date(statusUpdatedAt).getTime()) : "recently";
            statusUpdateDisplay = `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 4px; border: 1px solid #86efac;">
                <div style="font-weight: 600; font-size: 0.85rem; color: #059669; margin-bottom: 0.25rem;">📱 Hustler Status:</div>
                <div style="font-size: 0.9rem; color: #047857; font-weight: 600;">${statusMsg}</div>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Updated ${updatedTime}</div>
              </div>
            `;
          }
          
          // Uber-style verification codes
          let verificationCodeDisplay = "";
          const arrivalCode = job.arrivalCode;
          const arrivalVerified = job.arrivalCodeVerified;
          const completionCode = job.completionCode;
          const completionVerified = job.completionCodeVerified;
          
          // Customer sees: arrival code to give to hustler, then completion code input
          if (statusUpper === "ASSIGNED" && arrivalCode) {
            if (!arrivalVerified) {
              // Step 1: Customer gives arrival code to hustler
              verificationCodeDisplay = `
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dbeafe; border-radius: 6px; border: 2px solid #3b82f6;">
                  <div style="font-weight: 600; font-size: 0.85rem; color: #1e40af; margin-bottom: 0.5rem;">🔐 Step 1: Arrival Code</div>
                  <div style="font-size: 0.8rem; color: #1e3a8a; margin-bottom: 0.5rem;">Give this code to the hustler when they arrive to verify their identity.</div>
                  <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #1e40af; text-align: center; font-family: 'Courier New', monospace; padding: 0.5rem; background: white; border-radius: 8px;">
                    ${arrivalCode}
                  </div>
                  <div style="font-size: 0.75rem; color: #dc2626; text-align: center; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 4px; font-weight: 600;">
                    ⚠️ Only share when the hustler arrives in person
                  </div>
                </div>
              `;
            } else if (!completionVerified) {
              // Step 2: Hustler arrived, now awaiting completion code
              verificationCodeDisplay = `
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dcfce7; border-radius: 6px; border: 2px solid #16a34a;">
                  <div style="font-weight: 600; font-size: 0.85rem; color: #166534; margin-bottom: 0.5rem;">✅ Hustler Arrived!</div>
                  <div style="font-size: 0.8rem; color: #166534; margin-bottom: 0.75rem;">Job in progress. When complete, the hustler will give you a completion code.</div>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 2px solid #f59e0b;">
                  <div style="font-weight: 600; font-size: 0.85rem; color: #92400e; margin-bottom: 0.5rem;">🔐 Step 2: Enter Completion Code</div>
                  <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.5rem;">When the job is done, enter the code from the hustler to release payment.</div>
                  <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="completionCodeInput_${job.id}" placeholder="Enter 4-digit code" maxlength="4" 
                      style="flex: 1; padding: 0.75rem; font-size: 1.25rem; text-align: center; letter-spacing: 0.2em; border: 2px solid #f59e0b; border-radius: 8px; font-family: 'Courier New', monospace;" />
                    <button id="verifyCompletionBtn_${job.id}" class="btn btn-primary" style="padding: 0.75rem 1rem; background: #f59e0b; border: none;">Verify</button>
                  </div>
                </div>
              `;
            } else {
              // Both verified!
              verificationCodeDisplay = `
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dcfce7; border-radius: 6px; border: 2px solid #16a34a;">
                  <div style="font-weight: 600; font-size: 1rem; color: #166534; text-align: center;">✅ Job Complete!</div>
                  <div style="font-size: 0.85rem; color: #166534; text-align: center; margin-top: 0.25rem;">Payment has been released to the hustler.</div>
                </div>
              `;
            }
          }
          
          hustlerInfo.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #059669;">✓ Hustler Assigned</div>
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
              <strong>${job.hustler.name || job.hustler.username || "Hustler"}</strong>
              ${job.hustler.ratingAvg > 0 ? ` · ⭐ ${job.hustler.ratingAvg.toFixed(1)} (${job.hustler.ratingCount})` : ''}
            </div>
            <div style="font-size: 0.85rem; color: #047857;">
              ${statusText}
            </div>
            ${statusUpdateDisplay}
            ${verificationCodeDisplay}
          `;
          
          // Add message button for customer to message hustler
          const messageBtnRow = document.createElement("div");
          messageBtnRow.style.display = "flex";
          messageBtnRow.style.gap = "0.5rem";
          messageBtnRow.style.marginTop = "0.75rem";
          
          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-primary";
          messageBtn.style.flex = "1";
          messageBtn.textContent = "💬 Message Hustler";
          messageBtn.addEventListener("click", async () => {
            // Set active conversation and switch to messages view
            activeConversationJobId = job.id;
            overlay.remove();
            document.body.style.overflow = "";
            
            // Switch to messages view
            if (window.setView && typeof window.setView === 'function') {
              const funcStr = window.setView.toString();
              const isStub = funcStr.includes('not ready yet');
              if (!isStub) {
                await window.setView("messages");
              } else {
                // Use fallback
                activeView = "messages";
                window.activeView = "messages";
                document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
                const target = document.getElementById("view-messages");
                if (target) target.style.display = "block";
                document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === "messages"));
                await renderAll();
              }
            }
            
            // Small delay to ensure messages view is rendered, then open conversation
            setTimeout(async () => {
              await renderMessagesView();
              // Find and click the conversation for this job
              const conversationItems = document.querySelectorAll('[data-job-id]');
              conversationItems.forEach(item => {
                if (item.dataset.jobId === job.id) {
                  item.click();
                }
              });
            }, 300);
          });
          messageBtnRow.appendChild(messageBtn);
          
          // Add view profile button
          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "btn";
          viewProfileBtn.style.background = "#fff";
          viewProfileBtn.style.color = "#059669";
          viewProfileBtn.style.border = "1px solid #86efac";
          viewProfileBtn.style.flex = "1";
          viewProfileBtn.textContent = "View Profile & Reviews";
          viewProfileBtn.addEventListener("click", () => {
            overlay.remove();
            document.body.style.overflow = "";
            if (typeof window.showHustlerProfilePopup === 'function') {
              window.showHustlerProfilePopup(job.hustlerId);
            }
          });
          messageBtnRow.appendChild(viewProfileBtn);
          
          hustlerInfo.appendChild(messageBtnRow);
          actionsSection.appendChild(hustlerInfo);
          
          // Add completion code verification handler
          if (verificationCodeDisplay && !completionVerified && arrivalVerified) {
            const verifyBtn = document.getElementById(`verifyCompletionBtn_${job.id}`);
            const codeInput = document.getElementById(`completionCodeInput_${job.id}`);
            if (verifyBtn && codeInput) {
              verifyBtn.addEventListener("click", async () => {
                const code = codeInput.value.trim();
                if (!code || code.length !== 4) {
                  showToast("Please enter a 4-digit code");
                  return;
                }
                try {
                  verifyBtn.disabled = true;
                  verifyBtn.textContent = "...";
                  const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ code })
                  });
                  const data = await response.json();
                  if (!response.ok) {
                    throw new Error(data.error || "Verification failed");
                  }
                  
                  overlay.remove();
                  document.body.style.overflow = "";
                  
                  // Show congratulations modal, then force review
                  showJobCompletionFlow(data.jobId, data.customerId, data.hustlerId);
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to verify"));
                  verifyBtn.disabled = false;
                  verifyBtn.textContent = "Verify";
                }
              });
              // Allow Enter key
              codeInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") verifyBtn.click();
              });
            }
          }
        }
        
        // Check if payment is needed (job is assigned but payment not completed)
        const jobStatusCheck = (job.status || "").toUpperCase();
        if (job.hustlerId && (jobStatusCheck === "ASSIGNED" || jobStatusCheck === "OPEN")) {
          // Check payment status
          let paymentNeeded = false;
          let paymentStatus = null;
          try {
            const payment = await window.hustlAPI.payments.getByJobId(job.id);
            paymentStatus = payment?.status;
            if (!payment || payment.status === "PREAUTHORIZED") {
              paymentNeeded = true;
            }
          } catch (error) {
            // Payment might not exist yet, so payment is needed
            paymentNeeded = true;
          }
          
          if (paymentNeeded) {
            const payBtn = document.createElement("button");
            payBtn.className = "btn btn-primary";
            payBtn.textContent = "Complete Payment";
            payBtn.style.marginBottom = "0.5rem";
            payBtn.addEventListener("click", async () => {
              try {
                // For now, show message - payment flow will be implemented
                showToast("Payment processing will be available soon. The job is assigned and ready to proceed.");
              } catch (error) {
                showToast("Error: " + (error.message || "Cannot process payment"));
              }
            });
            actionsSection.appendChild(payBtn);
            
            const paymentNote = document.createElement("div");
            paymentNote.className = "muted";
            paymentNote.style.fontSize = "0.85rem";
            paymentNote.style.marginBottom = "0.5rem";
            paymentNote.textContent = "Complete payment to finalize the job assignment.";
            actionsSection.appendChild(paymentNote);
          }
        }
        
        // Customer confirmation when hustler marked job complete
        const customerStatusCheck = (job.status || "").toUpperCase();
        if ((customerStatusCheck === "COMPLETED_BY_HUSTLER" || customerStatusCheck === "AWAITING_CUSTOMER_CONFIRM") && user && user.id === job.customerId) {
          const confirmBanner = document.createElement("div");
          confirmBanner.style.padding = "1rem";
          confirmBanner.style.marginBottom = "1rem";
          confirmBanner.style.background = "#fef3c7";
          confirmBanner.style.borderRadius = "8px";
          confirmBanner.style.border = "2px solid #fbbf24";
          
          const bannerTitle = document.createElement("div");
          bannerTitle.style.fontWeight = "600";
          bannerTitle.style.fontSize = "1rem";
          bannerTitle.style.marginBottom = "0.5rem";
          bannerTitle.textContent = "✓ Hustler marked job as complete!";
          confirmBanner.appendChild(bannerTitle);
          
          const bannerText = document.createElement("div");
          bannerText.style.fontSize = "0.9rem";
          bannerText.style.marginBottom = "0.75rem";
          bannerText.innerHTML = `
            <div style="margin-bottom: 0.5rem;">Please confirm that the job was completed to your satisfaction.</div>
            <div style="font-weight: 600; color: #059669;">Once you confirm, payment will be immediately released to the hustler.</div>
          `;
          confirmBanner.appendChild(bannerText);
          
          // Verification code input
          const verificationCode = job.requirements?.verificationCode;
          if (verificationCode) {
            const codeSection = document.createElement("div");
            codeSection.style.marginTop = "0.75rem";
            codeSection.style.marginBottom = "0.75rem";
            codeSection.style.padding = "0.75rem";
            codeSection.style.background = "#dbeafe";
            codeSection.style.borderRadius = "6px";
            codeSection.style.border = "1px solid #93c5fd";
            
            const codeLabel = document.createElement("div");
            codeLabel.style.fontSize = "0.85rem";
            codeLabel.style.fontWeight = "600";
            codeLabel.style.marginBottom = "0.5rem";
            codeLabel.textContent = "🔐 Enter Verification Code:";
            codeSection.appendChild(codeLabel);
            
            const codeInput = document.createElement("input");
            codeInput.type = "text";
            codeInput.placeholder = "Enter 6-digit code from hustler";
            codeInput.maxLength = 6;
            codeInput.style.width = "100%";
            codeInput.style.padding = "0.75rem";
            codeInput.style.fontSize = "1.2rem";
            codeInput.style.textAlign = "center";
            codeInput.style.letterSpacing = "0.2em";
            codeInput.style.border = "2px solid #93c5fd";
            codeInput.style.borderRadius = "6px";
            codeInput.style.fontWeight = "600";
            codeInput.addEventListener("input", (e) => {
              e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
            });
            codeSection.appendChild(codeInput);
            
            const codeHint = document.createElement("div");
            codeHint.style.fontSize = "0.8rem";
            codeHint.style.marginTop = "0.5rem";
            codeHint.style.color = "#64748b";
            codeHint.textContent = "The hustler should have shared this code with you. It confirms you're both on the same page.";
            codeSection.appendChild(codeHint);
            
            confirmBanner.appendChild(codeSection);
            
            // Store code input for use in confirm button
            confirmBanner.codeInput = codeInput;
          }
          
          // Show completion photos only if there's an issue (optional)
          if (job.requirements && job.requirements.completionPhotos && job.requirements.completionPhotos.length > 0) {
            const photosDiv = document.createElement("div");
            photosDiv.style.marginTop = "0.75rem";
            photosDiv.style.marginBottom = "0.75rem";
            photosDiv.style.padding = "0.75rem";
            photosDiv.style.background = "#fff";
            photosDiv.style.borderRadius = "6px";
            photosDiv.style.border = "1px solid #e5e7eb";
            
            const photosLabel = document.createElement("div");
            photosLabel.style.fontSize = "0.85rem";
            photosLabel.style.fontWeight = "600";
            photosLabel.style.marginBottom = "0.5rem";
            photosLabel.textContent = "📸 Photos from hustler (optional):";
            photosDiv.appendChild(photosLabel);
            
            const photosGrid = document.createElement("div");
            photosGrid.style.display = "grid";
            photosGrid.style.gridTemplateColumns = "repeat(auto-fill, minmax(100px, 1fr))";
            photosGrid.style.gap = "0.5rem";
            
            job.requirements.completionPhotos.forEach(photoUrl => {
              const img = document.createElement("img");
              img.src = photoUrl;
              img.style.width = "100%";
              img.style.height = "100px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "4px";
              img.style.cursor = "pointer";
              img.addEventListener("click", () => {
                window.open(photoUrl, "_blank");
              });
              photosGrid.appendChild(img);
            });
            
            photosDiv.appendChild(photosGrid);
            confirmBanner.appendChild(photosDiv);
          }
          
          const buttonRow = document.createElement("div");
          buttonRow.style.display = "flex";
          buttonRow.style.gap = "0.5rem";
          
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "btn btn-primary";
          confirmBtn.style.flex = "1";
          confirmBtn.textContent = "✓ Confirm & Release Payment";
          confirmBtn.addEventListener("click", async () => {
            const codeInput = confirmBanner.codeInput;
            let enteredCode = codeInput ? codeInput.value.trim() : null;
            
            // Remove any non-digit characters
            if (enteredCode) {
              enteredCode = enteredCode.replace(/\D/g, '');
            }
            
            if (verificationCode && (!enteredCode || enteredCode.length !== 6)) {
              showToast("Please enter the 6-digit verification code from the hustler.");
              if (codeInput) codeInput.focus();
              return;
            }
            
            if (!confirm("Confirm that the job was completed successfully? Payment will be released to the hustler.")) return;
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Confirming...";
            
            try {
              const result = await window.hustlAPI.jobs.confirmComplete(job.id, enteredCode);
              
              // Close the job details modal first
              overlay.remove();
              document.body.style.overflow = "";
              
              // Refresh jobs list and profile to show updated status (COMPLETED with purple badge)
              renderJobs();
              renderProfile();
              
              // Show completion success modal with payment data (same as hustler gets)
              if (result && result.payment) {
                const actualJobAmount = result.payment.amount || job.amount || 0;
                const platformFee = result.payment.feeHustler || (actualJobAmount * 0.12);
                const hustlerPayout = actualJobAmount - platformFee;
                const actualHours = result.requirements?.actualHours || null;
                
                showCompletionSuccessModal(job.id, {
                  customerId: job.customerId,
                  hustlerId: job.hustlerId,
                  actualJobAmount: actualJobAmount,
                  hustlerPayout: hustlerPayout,
                  actualHours: actualHours,
                  platformFee: platformFee
                });
              } else {
                // Fallback: show review modal if completion modal data not available
                if (job.hustlerId) {
                  setTimeout(() => {
                    showReviewModal(job.id, job.hustlerId, job.hustler?.name || "Hustler");
                  }, 300);
                }
              }
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to confirm completion"));
              confirmBtn.disabled = false;
              confirmBtn.textContent = "✓ Confirm & Release Payment";
            }
          });
          buttonRow.appendChild(confirmBtn);
          
          // Report issue button
          const reportBtn = document.createElement("button");
          reportBtn.className = "btn";
          reportBtn.style.background = "#fee2e2";
          reportBtn.style.color = "#991b1b";
          reportBtn.style.border = "1px solid #fecaca";
          reportBtn.textContent = "⚠ Report Issue";
          reportBtn.addEventListener("click", () => {
            const reason = prompt("What's the issue? (e.g., job not done, poor quality, wrong work)");
            if (reason) {
              showToast("Issue reported. Our team will review this. Payment is on hold until resolved.");
              // In production, this would call an API endpoint to create a dispute
            }
          });
          buttonRow.appendChild(reportBtn);
          
          confirmBanner.appendChild(buttonRow);
          actionsSection.appendChild(confirmBanner);
        }
        
        // Show review button for completed jobs (PAID status)
        if (job.status === 'PAID' && user) {
          const isCustomer = user.id === job.customerId;
          const isHustler = user.id === job.hustlerId;
          
          if (isCustomer || isHustler) {
            const reviewSection = document.createElement("div");
            reviewSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f0f9ff; border-radius: 12px; border: 2px solid #3b82f6;";
            
            const reviewTitle = document.createElement("div");
            reviewTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;";
            reviewTitle.textContent = "⭐ Rate Your Experience";
            reviewSection.appendChild(reviewTitle);
            
            const reviewText = document.createElement("div");
            reviewText.style.cssText = "font-size: 0.9rem; color: #1e3a8a; margin-bottom: 1rem; line-height: 1.5;";
            reviewText.textContent = `Help others by sharing your experience. Your feedback helps build trust in the Hustl community.`;
            reviewSection.appendChild(reviewText);
            
            const reviewButton = document.createElement("button");
            reviewButton.className = "btn btn-primary";
            reviewButton.style.cssText = "width: 100%; padding: 0.875rem; font-weight: 700; font-size: 1rem; background: #3b82f6; border: none; border-radius: 8px; color: white; cursor: pointer;";
            reviewButton.textContent = isCustomer ? "⭐ Rate Hustler" : "⭐ Rate Customer";
            reviewButton.addEventListener("click", () => {
              const targetUserId = isCustomer ? job.hustlerId : job.customerId;
              const targetUserName = isCustomer ? (job.hustler?.name || "Hustler") : (job.customer?.name || "Customer");
              
              // Close job details modal
              const modalOverlay = document.getElementById('jobDetailModal') || document.querySelector('.modal-overlay');
              if (modalOverlay) {
                modalOverlay.remove();
                document.body.style.overflow = "";
              }
              
              // Show review modal
              if (typeof window.showReviewModal === 'function') {
                window.showReviewModal(job.id, targetUserId, targetUserName);
              } else if (typeof showReviewModal === 'function') {
                showReviewModal(job.id, targetUserId, targetUserName);
              } else {
                showToast("Review feature is loading...");
              }
            });
            reviewSection.appendChild(reviewButton);
            
            actionsSection.appendChild(reviewSection);
          }
        }
        
        const canDelete = job.status === "OPEN" && !job.hustlerId;
        
        if (canDelete) {
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.style.marginLeft = "0.5rem";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          btnRow.appendChild(deleteBtn);

          contentSection.appendChild(btnRow);
        } else if (
          job.status === "open" &&
          job.paymentStatus !== "paid"
        ) {
          const deleteRow = document.createElement("div");
          deleteRow.style.marginTop = "0.4rem";
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          deleteRow.appendChild(deleteBtn);
          contentSection.appendChild(deleteRow);
        }
      }

            // Applicants & accept button (customer) - Enhanced view
      if (user && user.id === job.postedByUserId) {
        const appsBox = document.createElement("div");
        appsBox.className = "stat-card";
        appsBox.style.marginTop = "0.5rem";

        // Fetch offers from API
        let offers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (offersResponse.ok) {
            offers = await offersResponse.json();
            if (!Array.isArray(offers)) offers = [];
          }
        } catch (e) {
          console.error("Error fetching offers:", e);
        }

        if (!offers || offers.length === 0) {
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div><div class='muted'>No Hustlers have applied yet.</div>";
        } else {
          const hasAccepted = !!job.hustlerId || !!job.acceptedHustlerId;
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div>" +
            (hasAccepted
              ? "<div class='muted' style='margin-bottom: 1rem;'>You've already accepted a Hustler for this job.</div>"
              : "<div class='muted' style='margin-bottom: 1rem;'>Review applicants and select the best fit.</div>");

          offers.forEach((offer) => {
            const hustler = offer.hustler || state.users.find((x) => x.id === offer.hustlerId);
            if (!hustler) return;
            
            const isAccepted = (job.hustlerId === offer.hustlerId) || (job.acceptedHustlerId === offer.hustlerId);

            const applicantCard = document.createElement("div");
            applicantCard.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #e5e7eb;";

            // Top row: Avatar + Name + Rating
            const topRow = document.createElement("div");
            topRow.style.cssText = "display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;";

            // Avatar
            const avatar = document.createElement("div");
            avatar.innerHTML = renderUserAvatar(hustler, 50, { 
              style: 'cursor: pointer;'
            });
            avatar.addEventListener("click", () => {
              if (typeof window.showHustlerProfilePopup === 'function') {
                window.showHustlerProfilePopup(hustler.id);
              }
            });
            topRow.appendChild(avatar);

            // Name and Rating
            const nameRating = document.createElement("div");
            nameRating.style.cssText = "flex: 1;";
            
            const name = document.createElement("div");
            name.style.cssText = "font-weight: 600; color: var(--text-main); margin-bottom: 0.25rem; cursor: pointer;";
            name.textContent = hustler.name || hustler.username || hustler.email?.split('@')[0] || "Unknown User";
            name.addEventListener("click", () => {
              if (typeof window.showHustlerProfilePopup === 'function') {
                window.showHustlerProfilePopup(hustler.id);
              }
            });
            nameRating.appendChild(name);

            // Use centralized rating display - always from backend (single source of truth)
            const rating = document.createElement("div");
            rating.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);";
            rating.innerHTML = window.getUserRatingDisplay(hustler);
            if (hustler.ratingCount > 0) {
              rating.innerHTML += ` <span>(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>`;
            } else {
              rating.innerHTML += ` <span style='color: #9ca3af;'>(No reviews yet)</span>`;
            }
            nameRating.appendChild(rating);
            topRow.appendChild(nameRating);

            applicantCard.appendChild(topRow);

            // Message from hustler
            if (offer.note) {
              const messageBox = document.createElement("div");
              messageBox.style.cssText = "padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.75rem; border: 1px solid #e5e7eb;";
              messageBox.innerHTML = `<div style="font-size: 0.85rem; color: var(--text-main); line-height: 1.5;">${offer.note}</div>`;
              applicantCard.appendChild(messageBox);
            }

            // Action buttons
            const actionsRow = document.createElement("div");
            actionsRow.style.cssText = "display: flex; gap: 0.5rem;";

            const viewProfileBtn = document.createElement("button");
            viewProfileBtn.className = "btn btn-ghost";
            viewProfileBtn.textContent = "View Profile";
            viewProfileBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
            viewProfileBtn.addEventListener("click", () => {
              if (typeof window.showHustlerProfilePopup === 'function') {
                window.showHustlerProfilePopup(hustler.id);
              }
            });
            actionsRow.appendChild(viewProfileBtn);

            if (isAccepted) {
              const acceptedBadge = document.createElement("div");
              acceptedBadge.style.cssText = "flex: 1; padding: 0.6rem; background: #dcfce7; color: #059669; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; justify-content: center;";
              acceptedBadge.textContent = "✓ Accepted";
              actionsRow.appendChild(acceptedBadge);
            } else if (!hasAccepted) {
              const acceptBtn = document.createElement("button");
              acceptBtn.className = "btn btn-primary";
              acceptBtn.textContent = "Accept Hustler";
              acceptBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
              acceptBtn.addEventListener("click", async () => {
                acceptBtn.disabled = true;
                acceptBtn.textContent = "Accepting...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  
                  // First, try to accept the offer
                  let response = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });

                  if (!response.ok) {
                    const errorData = await response.json();
                    
                    // If payment is required, create payment intent and show payment modal
                    if (errorData.requiresPayment) {
                      acceptBtn.disabled = false;
                      acceptBtn.textContent = "Accept Hustler";
                      
                      // Create payment intent
                      const paymentResponse = await fetch(`${API_BASE}/payments/create-intent/offer/${offer.id}`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        }
                      });
                      
                      if (!paymentResponse.ok) {
                        const paymentError = await paymentResponse.json();
                        throw new Error(paymentError.error || "Failed to create payment");
                      }
                      
                      const paymentData = await paymentResponse.json();
                      
                      // Show Stripe payment modal with amount breakdown
                      await showStripePaymentModal(
                        paymentData.clientSecret, 
                        job.id, 
                        async (paymentIntentId) => {
                          // After payment succeeds, accept the offer with paymentIntentId
                        try {
                          const acceptResponse = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                            method: 'POST',
                            headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ paymentIntentId })
                          });
                          
                          if (!acceptResponse.ok) {
                            const acceptError = await acceptResponse.json();
                            throw new Error(acceptError.error || "Failed to accept offer");
                          }
                          
                          showToast("✅ Hustler accepted for this job!");
                          openJobDetails(job.id);
                          renderJobs();
                        } catch (acceptError) {
                          showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                        }
                      },
                      paymentData.amount // Pass amount breakdown
                    );
                      
                      return;
                    }
                    
                    throw new Error(errorData.error || 'Failed to accept hustler');
                  }

                  const data = await response.json();
                  
                  showToast("✅ Hustler accepted for this job!");
                  openJobDetails(job.id);
                  renderJobs();
                } catch (error) {
                  console.error("Error accepting hustler:", error);
                  showToast("Failed to accept hustler: " + (error.message || "Unknown error"));
                  acceptBtn.disabled = false;
                  acceptBtn.textContent = "Accept Hustler";
                }
              });
              actionsRow.appendChild(acceptBtn);
            }

            applicantCard.appendChild(actionsRow);
            appsBox.appendChild(applicantCard);
          });
        }
        contentSection.appendChild(appsBox);
      }


      // Apply area (hustler)
      if (
        user &&
        user.role === "hustler" &&
        job.status === "open" &&
        job.postedByUserId !== user.id
      ) {
        const already = job.applicants?.some((a) => a.userId === user.id);
        const applyBox = document.createElement("div");
        applyBox.className = "stat-card";
        applyBox.style.marginTop = "0.5rem";

        if (already) {
          applyBox.innerHTML =
            "<div class='stat-label'>Your application</div><div class='muted'>You’ve already applied. Use job chat to send updates.</div>";
        } else {
          applyBox.innerHTML =
            "<div class='stat-label'>Apply for this job</div>";
          const msgField = document.createElement("textarea");
          msgField.placeholder =
            "Tell them when you can do it, if you have a truck, etc.";
          msgField.style.marginTop = "0.25rem";

          const priceField = document.createElement("input");
          priceField.type = "number";
          priceField.min = "0";
          priceField.step = "1";
          priceField.placeholder = "Suggested flat price (optional)";
          priceField.style.marginTop = "0.25rem";

          const btn = document.createElement("button");
          btn.className = "btn btn-primary";
          btn.style.marginTop = "0.4rem";
          btn.textContent = "Apply as a Hustler";
          btn.addEventListener("click", () => {
            const msg = msgField.value.trim();
            const suggestedPrice = Number(priceField.value) || null;
            job.applicants = job.applicants || [];
            job.applicants.push({
              userId: user.id,
              message: msg,
              suggestedPrice,
              createdAt: Date.now(),
            });
            saveState();
            showToast("Applied for job.");
            renderAll();
            openJobDetails(job.id);
          });

          applyBox.appendChild(msgField);
          applyBox.appendChild(priceField);
          applyBox.appendChild(btn);
        }

        contentSection.appendChild(applyBox);

        if (options.focusApply) {
          setTimeout(() => {
            applyBox.scrollIntoView({ behavior: "smooth" });
          }, 50);
        }
      }


      // Hustler actions around completion
      if (
        user &&
        job.status === "assigned" &&
        user.id === job.acceptedHustlerId
      ) {
        const hustlerRow = document.createElement("div");
        hustlerRow.style.marginTop = "0.45rem";

        if (!job.completionRequestedAt && !job.dispute) {
          const markFinishedBtn = document.createElement("button");
          markFinishedBtn.className = "small-btn";
          markFinishedBtn.textContent = "Mark job finished";
          markFinishedBtn.addEventListener("click", () => {
            job.completionRequestedAt = Date.now();
            job.completionRequesterId = user.id;
            job.autoCompleted = false;
            saveState();
            showToast("Marked finished. Customer will be asked to confirm or report a problem.");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(markFinishedBtn);
        } else if (job.completionRequestedAt && !job.dispute) {
          const nudge = document.createElement("div");
          nudge.className = "muted";
          nudge.style.marginBottom = "0.25rem";
          nudge.textContent =
            "Waiting for the customer to confirm. If it has been a while, you can flag an issue.";
          hustlerRow.appendChild(nudge);

          const disputeBtn = document.createElement("button");
          disputeBtn.className = "small-btn outline";
          disputeBtn.textContent = "Customer won’t confirm completion";
          disputeBtn.addEventListener("click", () => {
            const reason = prompt(
              "Briefly describe the issue (for example, 'Customer not responding')."
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "hustler",
              reason: reason || "Customer not confirming completion",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(disputeBtn);
        }

        if (hustlerRow.children.length > 0) {
          contentSection.appendChild(hustlerRow);
        }
      }

      // Complete / dispute buttons (customer)
      if (
        user &&
        user.id === job.postedByUserId &&
        job.status === "assigned"
      ) {
        const completeRow = document.createElement("div");
        completeRow.style.marginTop = "0.45rem";

        if (job.completionRequestedAt && !job.dispute) {
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "small-btn";
          confirmBtn.textContent = "Confirm completion";
          confirmBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(confirmBtn);

          const problemBtn = document.createElement("button");
          problemBtn.className = "small-btn outline";
          problemBtn.style.marginLeft = "0.4rem";
          problemBtn.textContent = "Problem with job";
          problemBtn.addEventListener("click", () => {
            const reason = prompt(
              "What went wrong? (e.g., not done, poor quality, other)"
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "customer",
              reason: reason || "Issue with job",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(problemBtn);
        } else if (!job.dispute) {
          const completeBtn = document.createElement("button");
          completeBtn.className = "small-btn";
          completeBtn.textContent = "Mark job complete";
          completeBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(completeBtn);
        }

        if (completeRow.children.length > 0) {
          contentSection.appendChild(completeRow);
        }
      }

      modalContent.appendChild(contentSection);
      modalOverlay.appendChild(modalContent);
    }
    // Demo-only: no real Stripe redirect handling in this prototype
    function handleStripeReturn() {
      // In a real app, you'd look at URL params from Stripe here.
      // For this demo, we do nothing so the rest of the app can run.
    }

   
    /* ---------- Messages view ---------- */

    async function renderMessagesView() {
      console.log('[MESSAGES] renderMessagesView called');
      // Use API-based authentication instead of state-based
      let user = null;
      try {
        if (window.hustlAPI && window.hustlAPI.auth && typeof window.hustlAPI.auth.getCurrentUser === 'function') {
          user = await window.hustlAPI.auth.getCurrentUser();
        } else {
          // Fallback: try to get user from token
          const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
          if (token) {
            const response = await fetch(`${API_BASE}/users/me`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              user = await response.json();
            }
          }
        }
      } catch (error) {
        console.error('[MESSAGES] Error getting current user:', error);
      }
      console.log('[MESSAGES] User:', user ? user.id : 'not logged in');
      
      const convList = document.getElementById("conversationList");
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      
      console.log('[MESSAGES] Elements found:', {
        convList: !!convList,
        convTitle: !!convTitle,
        convSummary: !!convSummary,
        convMessages: !!convMessages
      });
      
      if (!convList) {
        console.error('[MESSAGES] conversationList element not found!');
        return;
      }

      // Not logged in: nothing to show
      if (!user) {
        convList.innerHTML =
          "<div class='muted'>Log in to see your job conversations.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        activeConversationThreadId = null;
        return;
      }

      // Fetch threads from API (only for ASSIGNED jobs)
      convList.innerHTML = "<div class='muted'>Loading conversations...</div>";
      
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          throw new Error('No authentication token');
        }

        console.log('[MESSAGES] Fetching threads from:', `${API_BASE}/threads`);
        const response = await fetch(`${API_BASE}/threads`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[MESSAGES] Failed to fetch threads:', response.status, errorText);
          throw new Error(`Failed to load conversations: ${response.status}`);
        }

        const threads = await response.json();
        console.log('[MESSAGES] Received threads:', threads.length, threads);
        convList.innerHTML = "";

        if (threads.length === 0) {
          convList.innerHTML =
            "<div class='muted' style='padding: 2rem; text-align: center;'>No conversations yet.<br>Messages will appear here once you have an assigned job.</div>";
          convTitle.textContent = "Select a conversation";
          convSummary.textContent = "";
          convMessages.innerHTML = "";
          activeConversationJobId = null;
          activeConversationThreadId = null;
          return;
        }

        // Get current tab (default to 'active')
        const activeTab = window.activeConversationTab || 'active';
        const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
        
        // Filter threads by tab
        const filteredThreads = threads.filter(thread => {
          const isDeleted = deleted.includes(thread.job.id);
          if (activeTab === 'active') {
            return !isDeleted; // Show non-deleted in active tab
          } else if (activeTab === 'deleted') {
            return isDeleted; // Show deleted in deleted tab
          }
          return true;
        });

        // If nothing is selected yet, auto-open the first thread
        if (!activeConversationJobId && filteredThreads.length > 0) {
          activeConversationJobId = filteredThreads[0].job.id;
          activeConversationThreadId = filteredThreads[0].id;
        }

        // Show empty state if no conversations in current tab
        if (filteredThreads.length === 0) {
          const emptyMessage = activeTab === 'deleted' 
            ? "No deleted conversations. Deleted conversations will appear here."
            : "No active conversations yet.<br>Messages will appear here once you have an assigned job.";
          convList.innerHTML = `<div class='muted' style='padding: 2rem; text-align: center;'>${emptyMessage}</div>`;
          await renderConversation();
          return;
        }

        filteredThreads.forEach((thread) => {
          const otherUser = user.id === thread.userAId ? thread.userB : thread.userA;
          const job = thread.job;

        const item = document.createElement("div");
        item.className = "conversation-item";
        item.dataset.jobId = job.id;
        item.dataset.threadId = thread.id;

        // Highlight the active conversation and unread messages
        const unreadCount = thread.unreadCount || 0;
        const hasUnread = unreadCount > 0;
        
        if (job.id === activeConversationJobId) {
          item.classList.add("active");
        }

        // Avatar (small circular profile photo)
        const avatarContainer = document.createElement("div");
        avatarContainer.className = "conversation-avatar";
        if (otherUser) {
          avatarContainer.innerHTML = renderUserAvatar(otherUser, 40);
        }
        item.appendChild(avatarContainer);
        
        // Info section (name, job title, status, preview)
        const infoContainer = document.createElement("div");
        infoContainer.className = "conversation-info";
        infoContainer.style.flex = "1";
        infoContainer.style.minWidth = "0";
        
        if (otherUser) {
          // User name
          const name = document.createElement("div");
          name.className = "conversation-name";
          name.textContent = otherUser.name || "Unknown";
          if (hasUnread) {
            name.style.fontWeight = "700";
            name.style.color = "#1e40af";
          }
          infoContainer.appendChild(name);
          
          // Job title + status
          const jobMeta = document.createElement("div");
          jobMeta.style.display = "flex";
          jobMeta.style.alignItems = "center";
          jobMeta.style.gap = "0.5rem";
          jobMeta.style.fontSize = "0.75rem";
          jobMeta.style.color = "var(--text-muted)";
          jobMeta.style.marginBottom = "0.25rem";
          
          const titleText = document.createElement("span");
          titleText.textContent = job.title;
          jobMeta.appendChild(titleText);
          
          // Job status badge
          let statusText = "";
          let statusColor = "";
          if (job.status === 'PAID' || job.status === 'COMPLETED_BY_HUSTLER') {
            statusText = "✅ Completed";
            statusColor = "#166534";
          } else if (job.status === 'IN_PROGRESS') {
            statusText = "🟡 In Progress";
            statusColor = "#ca8a04";
          } else if (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') {
            // SCHEDULED/ASSIGNED = Hustler accepted, waiting for start code (not active yet)
            statusText = job.status === 'SCHEDULED' ? "📅 Scheduled" : "📅 Assigned";
            statusColor = "#2563eb";
          }
          
          if (statusText) {
            const statusBadge = document.createElement("span");
            statusBadge.style.background = statusColor === "#166534" ? "#dcfce7" : 
                                           statusColor === "#ca8a04" ? "#fef3c7" :
                                           statusColor === "#2563eb" ? "#dbeafe" : "#d1fae5";
            statusBadge.style.color = statusColor;
            statusBadge.style.padding = "0.125rem 0.375rem";
            statusBadge.style.borderRadius = "4px";
            statusBadge.style.fontSize = "0.7rem";
            statusBadge.style.fontWeight = "600";
            statusBadge.textContent = statusText;
            jobMeta.appendChild(statusBadge);
          }
          
          infoContainer.appendChild(jobMeta);
        }
        
        // Latest message preview
        const latestMessage = thread.messages && thread.messages.length > 0 ? thread.messages[0] : null;
        const preview = document.createElement("div");
        preview.className = "conversation-preview";
        if (latestMessage) {
          const previewText = latestMessage.body.length > 60 ? latestMessage.body.substring(0, 60) + "..." : latestMessage.body;
          preview.textContent = previewText;
          if (hasUnread) {
            preview.style.color = "#1e40af";
            preview.style.fontWeight = "600";
          }
        } else {
          preview.textContent = "No messages yet";
          preview.style.fontStyle = "italic";
        }
        infoContainer.appendChild(preview);
        
        item.appendChild(infoContainer);
        
        // Unread badge
        if (hasUnread) {
          const unreadBadge = document.createElement("div");
          unreadBadge.className = "unread-badge";
          unreadBadge.style.background = "#3b82f6";
          unreadBadge.style.color = "#fff";
          unreadBadge.style.borderRadius = "12px";
          unreadBadge.style.padding = "0.2rem 0.5rem";
          unreadBadge.style.fontSize = "0.7rem";
          unreadBadge.style.fontWeight = "700";
          unreadBadge.style.minWidth = "20px";
          unreadBadge.style.textAlign = "center";
          unreadBadge.textContent = unreadCount > 99 ? "99+" : unreadCount.toString();
          item.appendChild(unreadBadge);
        }

        // Archive/Delete buttons (hidden by default, shown on hover)
        const actionsRow = document.createElement("div");
        actionsRow.className = "conversation-actions";
        
        // Archive/Unarchive button
        const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
        const isArchived = archived.includes(job.id);
        const archiveBtn = document.createElement("button");
        archiveBtn.className = "small-btn";
        archiveBtn.style.background = isArchived ? "#dbeafe" : "transparent";
        archiveBtn.style.color = isArchived ? "#1e40af" : "#6b7280";
        archiveBtn.style.padding = "0.375rem 0.5rem";
        archiveBtn.style.fontSize = "0.75rem";
        archiveBtn.style.border = "none";
        archiveBtn.style.borderRadius = "4px";
        archiveBtn.style.cursor = "pointer";
        archiveBtn.textContent = isArchived ? "📦" : "📦";
        archiveBtn.title = isArchived ? "Unarchive" : "Archive";
        archiveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
          if (isArchived) {
            const index = archived.indexOf(job.id);
            if (index > -1) {
              archived.splice(index, 1);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation unarchived");
              renderMessagesView();
            }
          } else {
            if (!archived.includes(job.id)) {
              archived.push(job.id);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation archived");
              renderMessagesView();
            }
          }
        });
        actionsRow.appendChild(archiveBtn);
        
        // Delete/Restore button (only allow delete for completed jobs)
        const isDeleted = deleted.includes(job.id);
        const isCompleted = job.status === 'PAID' || job.status === 'COMPLETED_BY_HUSTLER';
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "small-btn";
        deleteBtn.style.background = isDeleted ? "#fecaca" : "transparent";
        deleteBtn.style.color = isDeleted ? "#991b1b" : "#6b7280";
        deleteBtn.style.padding = "0.375rem 0.5rem";
        deleteBtn.style.fontSize = "0.75rem";
        deleteBtn.style.border = "none";
        deleteBtn.style.borderRadius = "4px";
        deleteBtn.style.cursor = (isCompleted || isDeleted) ? "pointer" : "not-allowed";
        deleteBtn.style.opacity = (isCompleted || isDeleted) ? "1" : "0.5";
        deleteBtn.textContent = isDeleted ? "↩" : "🗑";
        deleteBtn.title = isDeleted ? "Restore" : (isCompleted ? "Delete" : "Delete (only available for completed jobs)");
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
          if (isDeleted) {
            const index = deleted.indexOf(job.id);
            if (index > -1) {
              deleted.splice(index, 1);
              localStorage.setItem("deletedConversations", JSON.stringify(deleted));
              showToast("Conversation restored");
              renderMessagesView();
            }
          } else {
            // Only allow deletion for completed jobs
            if (!isCompleted) {
              showToast("You can only delete conversations for completed jobs.");
              return;
            }
            if (confirm("Delete this conversation? This will hide it from your messages list. You can restore it later.")) {
              if (!deleted.includes(job.id)) {
                deleted.push(job.id);
                localStorage.setItem("deletedConversations", JSON.stringify(deleted));
                showToast("Conversation deleted");
                renderMessagesView();
              }
            }
          }
        });
        actionsRow.appendChild(deleteBtn);
        
        item.appendChild(actionsRow);

        item.addEventListener("click", () => {
          activeConversationJobId = job.id;
          activeConversationThreadId = thread.id;
          // Reset message tracking for new conversation
          resetMessageTracking();
          
          // On mobile: hide conversation list and show chat area
          if (window.innerWidth <= 768) {
            const sidebar = document.querySelector('.conversations-sidebar');
            const chatArea = document.querySelector('.chat-area');
            if (sidebar) sidebar.classList.add('hidden');
            if (chatArea) chatArea.classList.add('active');
          }
          
          // Re-render list (to update highlight) + right-hand chat
          renderMessagesView();
        });

        convList.appendChild(item);
      });

      // Finally, render the messages for the active conversation
      await renderConversation();
      
      // Initialize message input handler
      if (typeof initConversationInput === 'function') {
        initConversationInput();
      }
      } catch (error) {
        console.error("Error loading conversations:", error);
        convList.innerHTML = "<div class='muted' style='padding: 2rem; text-align: center;'>Error loading conversations. Please try again.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
      }
    }



    async function renderConversation() {
      // Use cached user to avoid repeated auth checks during refresh
      // Only fetch if not cached
      if (!window._cachedCurrentUser) {
        try {
          if (window.hustlAPI && window.hustlAPI.auth && typeof window.hustlAPI.auth.getCurrentUser === 'function') {
            window._cachedCurrentUser = await window.hustlAPI.auth.getCurrentUser();
          } else {
            // Fallback: try to get user from token
            const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
            if (token) {
              const response = await fetch(`${API_BASE}/users/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (response.ok) {
                window._cachedCurrentUser = await response.json();
              }
            }
          }
        } catch (error) {
          console.error('[CONVERSATION] Error getting current user:', error);
          window._cachedCurrentUser = null;
        }
      }
      const user = window._cachedCurrentUser;
      
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      
      if (!activeConversationThreadId || !user) {
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "<div class='empty-chat' style='text-align: center; padding: 3rem; color: var(--text-muted);'><div style='font-size: 3rem; margin-bottom: 1rem;'>💬</div><div style='font-weight: 600; margin-bottom: 0.5rem;'>No conversation selected</div><div style='font-size: 0.9rem;'>Pick a job from the list to start chatting</div></div>";
        return;
      }

      // Fetch messages from API
      convMessages.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading messages...</div>";
      
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          throw new Error('No authentication token');
        }

        const response = await fetch(`${API_BASE}/threads/${activeConversationThreadId}/messages`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load messages');
        }

        const messages = await response.json();
        
        // Also fetch thread details for job info
        const threadResponse = await fetch(`${API_BASE}/threads`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const threads = threadResponse.ok ? await threadResponse.json() : [];
        const thread = threads.find(t => t.id === activeConversationThreadId);
        
        if (thread) {
          convTitle.textContent = thread.job.title;
          // Hide job summary (Job ID and Status) - not needed
          convSummary.textContent = "";
          convSummary.style.display = "none";
        }

        convMessages.innerHTML = "";
        
        if (messages.length === 0) {
          convMessages.innerHTML = "<div style='text-align: center; padding: 3rem; color: var(--text-muted);'><div style='font-size: 2rem; margin-bottom: 1rem;'>💬</div><div>No messages yet. Start the conversation!</div></div>";
          convMessages.scrollTop = convMessages.scrollHeight;
          // Start auto-refresh polling
          startMessagePolling();
          return;
        }

        // Fetch sender info for profile pictures
        const senderIds = [...new Set(messages.map(m => m.senderId))];
        const senderMap = new Map();
        
        // Fetch all unique senders
        for (const senderId of senderIds) {
          try {
            const senderResponse = await fetch(`${API_BASE}/users/${senderId}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (senderResponse.ok) {
              const sender = await senderResponse.json();
              senderMap.set(senderId, sender);
            }
          } catch (e) {
            console.warn('Could not fetch sender info:', e);
          }
        }

        // Render messages with profile picture only on most recent message from other person
        messages.forEach((m, index) => {
          const isMe = m.senderId === user.id;
          const sender = senderMap.get(m.senderId);
          
          // Check if this is the most recent message from the other person
          // Look ahead to see if there are more messages from this sender
          let isMostRecentFromSender = false;
          if (!isMe) {
            // Check if next message is from a different sender or if this is the last message
            const nextMessage = messages[index + 1];
            isMostRecentFromSender = !nextMessage || nextMessage.senderId !== m.senderId;
          }
          
          // Create wrapper for message bubble (full-width flex container)
          const wrapper = document.createElement("div");
          wrapper.className = "chat-msg-wrapper " + (isMe ? "me" : "them");
          wrapper.dataset.messageId = m.id;
          wrapper.dataset.senderId = m.senderId;
          
          // Profile picture (only for received messages AND only on most recent message from that sender)
          if (!isMe && sender && isMostRecentFromSender) {
            const avatar = document.createElement("div");
            avatar.style.cssText = "width: 32px; height: 32px; flex-shrink: 0; border-radius: 50%; overflow: hidden;";
            avatar.innerHTML = renderUserAvatar(sender, 32, { showBorder: false });
            wrapper.appendChild(avatar);
          } else if (!isMe) {
            // Placeholder for spacing when no profile picture
            const spacer = document.createElement("div");
            spacer.style.cssText = "width: 32px; height: 32px; flex-shrink: 0;";
            wrapper.appendChild(spacer);
          }
          
          // Message content container (max-width: 70%)
          const contentContainer = document.createElement("div");
          contentContainer.style.cssText = "display: flex; flex-direction: column; gap: 0.25rem; max-width: 70%; min-width: 0;";
          
          // Create message bubble
          const bubble = document.createElement("div");
          bubble.className = "chat-msg " + (isMe ? "me" : "them");
          bubble.style.cssText = isMe 
            ? "background: var(--primary); color: white; padding: 0.75rem 1rem; border-radius: 18px; word-wrap: break-word; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.1);"
            : "background: #f1f3f5; color: var(--text-main); padding: 0.75rem 1rem; border-radius: 18px; word-wrap: break-word; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05);";
          bubble.textContent = m.body;
          contentContainer.appendChild(bubble);
          
          // Create timestamp
          const timestamp = document.createElement("div");
          timestamp.className = "chat-msg-timestamp";
          timestamp.style.cssText = "font-size: 0.7rem; color: var(--text-muted); padding: 0.25rem 0.5rem 0 0.5rem; " + (isMe ? "text-align: right;" : "text-align: left;");
          timestamp.textContent = timeAgo(m.createdAt);
          contentContainer.appendChild(timestamp);
          
          wrapper.appendChild(contentContainer);
          
          // Spacer for sent messages (to align right)
          if (isMe) {
            const spacer = document.createElement("div");
            spacer.style.cssText = "width: 32px; height: 32px; flex-shrink: 0;";
            wrapper.appendChild(spacer);
          }
          
          convMessages.appendChild(wrapper);
        });
        
        // Set lastMessageId for lightweight refresh
        if (messages.length > 0) {
          lastMessageId = messages[messages.length - 1].id;
        }
        
        convMessages.scrollTop = convMessages.scrollHeight;
        
        // Start auto-refresh polling for messages (lightweight version)
        startMessagePolling();
      } catch (error) {
        console.error("Error loading messages:", error);
        convMessages.innerHTML = "<div style='text-align: center; padding: 2rem; color: #dc2626;'>Error loading messages. Please try again.</div>";
      }
    }

    // Initialize conversation tabs
    function initConversationTabs() {
      const tabs = document.querySelectorAll('.conversation-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabType = tab.dataset.convTab;
          window.activeConversationTab = tabType;
          
          // Update tab styles
          tabs.forEach(t => {
            t.classList.remove('active');
            t.style.borderBottom = '2px solid transparent';
            t.style.color = 'var(--text-muted)';
            t.style.fontWeight = '500';
          });
          tab.classList.add('active');
          tab.style.borderBottom = '2px solid var(--primary)';
          tab.style.color = 'var(--primary)';
          tab.style.fontWeight = '600';
          
          // Re-render conversations with new filter
          if (typeof renderMessagesView === 'function') {
            renderMessagesView();
          }
        });
      });
      
      // Set default tab if not set
      if (!window.activeConversationTab) {
        window.activeConversationTab = 'active';
      }
    }
    
    // Initialize back button for mobile chat
    function initChatBackButton() {
      const backBtn = document.getElementById("chatBackBtn");
      if (backBtn) {
        backBtn.addEventListener("click", () => {
          // On mobile: hide chat area and show conversation list
          if (window.innerWidth <= 768) {
            const sidebar = document.querySelector('.conversations-sidebar');
            const chatArea = document.querySelector('.chat-area');
            if (sidebar) sidebar.classList.remove('hidden');
            if (chatArea) chatArea.classList.remove('active');
          }
        });
        
        // Show back button on mobile
        if (window.innerWidth <= 768) {
          backBtn.style.display = "flex";
        }
      }
    }
    
    function initConversationInput() {
      const sendBtn = document.getElementById("conversationSendButton");
      const input = document.getElementById("conversationInput");
      if (!sendBtn || !input) return;
      
      // Remove existing listeners to avoid duplicates
      const newSendBtn = sendBtn.cloneNode(true);
      sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      
      newSendBtn.addEventListener("click", async () => {
        // Use API-based authentication instead of state-based
        let user = null;
        try {
          if (window.hustlAPI && window.hustlAPI.auth && typeof window.hustlAPI.auth.getCurrentUser === 'function') {
            user = await window.hustlAPI.auth.getCurrentUser();
          } else {
            // Fallback: try to get user from token
            const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
            if (token) {
              const response = await fetch(`${API_BASE}/users/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (response.ok) {
                user = await response.json();
              }
            }
          }
        } catch (error) {
          console.error('[MESSAGE INPUT] Error getting current user:', error);
        }
        
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        if (!activeConversationThreadId) {
          showToast("Please select a conversation first.");
          return;
        }
        const text = newInput.value.trim();
        if (!text) return;
        
        // Check for contact info sharing before job starts (client-side check)
        try {
          // Get job status for this thread
          const threadResponse = await fetch(`${API_BASE}/threads/${activeConversationThreadId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('hustl_token')}` }
          });
          if (threadResponse.ok) {
            const thread = await threadResponse.json();
            if (thread.jobId) {
              const jobResponse = await fetch(`${API_BASE}/jobs/${thread.jobId}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('hustl_token')}` }
              });
              if (jobResponse.ok) {
                const job = await jobResponse.json();
                // Block contact info if job hasn't started (no start code verified)
                if (job.status !== 'IN_PROGRESS' && !job.startCodeVerified) {
                  const phoneRegex = /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b/;
                  const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/;
                  const contactPatterns = [
                    /\b(text me|call me|email me|phone me|contact me|reach me|my number|my phone|my email)\b/i,
                    /\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/,
                    /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/
                  ];
                  
                  const hasContactInfo = contactPatterns.some(pattern => pattern.test(text));
                  
                  if (hasContactInfo) {
                    showToast("For your safety and payment protection, contact details are hidden until the job is accepted and started.");
                    return;
                  }
                }
              }
            }
          }
        } catch (e) {
          console.warn("Could not check job status for message restriction:", e);
          // Continue with message send if check fails
        }
        
        // Disable input while sending
        newSendBtn.disabled = true;
        newInput.disabled = true;
        
        try {
          const token = localStorage.getItem('hustl_token');
          if (!token) {
            throw new Error('No authentication token');
          }

          const response = await fetch(`${API_BASE}/threads/${activeConversationThreadId}/messages`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ body: text })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Failed to send message');
          }

          // Clear input and reload messages
          newInput.value = '';
          await renderConversation();
        } catch (error) {
          console.error("Error sending message:", error);
          showToast(error.message || "Failed to send message. Please try again.");
        } finally {
          newSendBtn.disabled = false;
          newInput.disabled = false;
        }
      });
      
      newInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          newSendBtn.click();
        }
      });
    }
    
    // Lightweight refresh functions - NO auth checks, NO full re-renders
    let lastMessageId = null; // Track last message ID to only append new ones
    
    async function refreshMessagesOnly() {
      // Only refresh if we have an active conversation
      if (!activeConversationThreadId) return;
      
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) return; // Don't refresh if no token - but don't trigger logout
        
        const response = await fetch(`${API_BASE}/threads/${activeConversationThreadId}/messages`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) return; // Silently fail - don't show errors
        
        const messages = await response.json();
        const convMessages = document.getElementById("conversationMessages");
        if (!convMessages) return;
        
        // Only append NEW messages (messages after lastMessageId)
        let foundNewMessages = false;
        const currentMessageIds = new Set(
          Array.from(convMessages.querySelectorAll('.chat-msg-wrapper'))
            .map(el => el.dataset.messageId)
            .filter(id => id)
        );
        
        messages.forEach((m) => {
          // Skip if message already exists
          if (currentMessageIds.has(m.id)) return;
          
          foundNewMessages = true;
          
          // Get current user ID from cached user (no auth check)
          // If no cached user, skip this message (will be added on next full render)
          const cachedUser = window._cachedCurrentUser || window.hustlAPI?.auth?.currentUser;
          if (!cachedUser) return; // Skip if no cached user - don't trigger auth check
          const isMe = m.senderId === cachedUser.id;
          
          // Create message bubble (same structure as renderConversation)
          const wrapper = document.createElement("div");
          wrapper.className = "chat-msg-wrapper " + (isMe ? "me" : "them");
          wrapper.dataset.messageId = m.id;
          wrapper.dataset.senderId = m.senderId;
          
          const bubble = document.createElement("div");
          bubble.className = "chat-msg " + (isMe ? "me" : "them");
          bubble.textContent = m.body;
          wrapper.appendChild(bubble);
          
          const timestamp = document.createElement("div");
          timestamp.className = "chat-msg-timestamp";
          timestamp.textContent = timeAgo(m.createdAt);
          wrapper.appendChild(timestamp);
          
          convMessages.appendChild(wrapper);
        });
        
        // Update lastMessageId
        if (messages.length > 0) {
          lastMessageId = messages[messages.length - 1].id;
        }
        
        // Scroll to bottom only if new messages were added
        if (foundNewMessages) {
          convMessages.scrollTop = convMessages.scrollHeight;
        }
      } catch (error) {
        // Silently fail - don't log or show errors during background refresh
        console.debug('[MESSAGES] Background refresh error (silent):', error);
      }
    }
    
    async function refreshConversationListUnreadCounts() {
      // Only update unread badges - don't re-render entire list
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) return;
        
        const response = await fetch(`${API_BASE}/threads`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) return;
        
        const threads = await response.json();
        const convList = document.getElementById("conversationList");
        if (!convList) return;
        
        // Update unread badges for each conversation item
        threads.forEach((thread) => {
          const item = convList.querySelector(`[data-thread-id="${thread.id}"]`);
          if (!item) return;
          
          const unreadCount = thread.unreadCount || 0;
          const hasUnread = unreadCount > 0;
          
          // Update unread badge
          let badge = item.querySelector('.unread-badge');
          if (hasUnread) {
            if (!badge) {
              badge = document.createElement("div");
              badge.className = "unread-badge";
              badge.style.background = "#3b82f6";
              badge.style.color = "#fff";
              badge.style.borderRadius = "12px";
              badge.style.padding = "0.2rem 0.5rem";
              badge.style.fontSize = "0.75rem";
              badge.style.fontWeight = "700";
              badge.style.minWidth = "24px";
              badge.style.textAlign = "center";
              
              const previewContainer = item.querySelector('.preview-container');
              if (previewContainer) {
                previewContainer.appendChild(badge);
              }
            }
            badge.textContent = unreadCount > 99 ? "99+" : unreadCount.toString();
            
            // Update styling for unread
            if (item.dataset.jobId !== activeConversationJobId) {
              item.style.background = "#eff6ff";
              item.style.borderColor = "#3b82f6";
              item.style.borderWidth = "2px";
              item.style.fontWeight = "600";
            }
            
            // Update message preview styling
            const preview = item.querySelector('.job-meta');
            if (preview) {
              preview.style.color = "#1e40af";
              preview.style.fontWeight = "600";
            }
          } else {
            // Remove badge if no unread
            if (badge) badge.remove();
            
            // Reset styling if not active
            if (item.dataset.jobId !== activeConversationJobId) {
              item.style.background = "";
              item.style.borderColor = "";
              item.style.borderWidth = "";
              item.style.fontWeight = "";
            }
            
            // Reset preview styling
            const preview = item.querySelector('.job-meta');
            if (preview) {
              preview.style.color = "var(--text-muted)";
              preview.style.fontWeight = "400";
            }
          }
        });
      } catch (error) {
        // Silently fail
        console.debug('[MESSAGES] Background unread refresh error (silent):', error);
      }
    }
    
    // Auto-refresh polling for messages - LIGHTWEIGHT VERSION
    function startMessagePolling() {
      // Stop any existing polling
      stopMessagePolling();
      
      // Only poll if we're on the messages view
      if (activeView !== 'messages') {
        return;
      }
      
      console.log('[MESSAGES] Starting lightweight auto-refresh polling');
      
      // Poll every 3 seconds (slightly less aggressive)
      messagePollInterval = setInterval(async () => {
        // Only poll if still on messages view
        if (activeView !== 'messages') {
          stopMessagePolling();
          return;
        }
        
        // Lightweight refresh - NO auth checks, NO full re-renders
        try {
          // Update unread counts in conversation list (lightweight)
          await refreshConversationListUnreadCounts();
          
          // Only refresh messages if we have an active conversation
          if (activeConversationThreadId) {
            await refreshMessagesOnly();
          }
        } catch (error) {
          // Silently fail - don't log errors during background refresh
          console.debug('[MESSAGES] Background refresh error (silent):', error);
        }
      }, 3000); // 3 seconds (less aggressive)
    }
    
    function stopMessagePolling() {
      if (messagePollInterval) {
        clearInterval(messagePollInterval);
        messagePollInterval = null;
        console.log('[MESSAGES] Stopped auto-refresh polling');
      }
    }
    
    // Reset lastMessageId when conversation changes
    function resetMessageTracking() {
      lastMessageId = null;
    }

    /* ---------- Profile ---------- */

    // Helper function to get the latest user photoUrl from single source of truth
    function getUserPhotoUrl(userId) {
      if (!userId) return null;
      
      // First check localStorage (most up-to-date, updated immediately after upload)
      try {
        const cachedUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
        if (cachedUser.id === userId && cachedUser.photoUrl) {
          return cachedUser.photoUrl;
        }
      } catch (e) {
        // Ignore parse errors
      }
      
      // Check auth currentUser (also updated after upload)
      if (window.hustlAPI && window.hustlAPI.auth && window.hustlAPI.auth.currentUser) {
        if (window.hustlAPI.auth.currentUser.id === userId && window.hustlAPI.auth.currentUser.photoUrl) {
          return window.hustlAPI.auth.currentUser.photoUrl;
        }
      }
      
      // Check state.users for other users (customers, hustlers in jobs/messages)
      if (window.state && window.state.users && Array.isArray(window.state.users)) {
        const stateUser = window.state.users.find(u => u && u.id === userId);
        if (stateUser && stateUser.photoUrl) {
          return stateUser.photoUrl;
        }
      }
      
      return null;
    }
    
    // Function to update all avatars in the DOM for a specific user
    // This ensures immediate propagation when a photo is updated
    function updateAllAvatarsInDOM(photoUrl, userId) {
      if (!photoUrl || !userId) {
        console.warn('[updateAllAvatarsInDOM] Missing photoUrl or userId:', { photoUrl, userId });
        return;
      }
      
      const cleanPhotoUrl = photoUrl.replace(/\?t=\d+(&t=\d+)*$/, ''); // Remove existing cache busters
      const cacheBuster = `?t=${Date.now()}`;
      const photoUrlWithCache = `${cleanPhotoUrl}${cacheBuster}`;
      
      console.log('[updateAllAvatarsInDOM] Updating avatars for user:', userId, 'with URL:', cleanPhotoUrl);
      
      // Find all avatar images for this user (by data-user-id attribute)
      const allAvatarImages = document.querySelectorAll(`img[data-user-id="${userId}"]`);
      allAvatarImages.forEach(img => {
        const currentSrc = img.src.split('?')[0]; // Compare without cache buster
        if (currentSrc !== cleanPhotoUrl) {
          img.src = photoUrlWithCache;
          console.log('[updateAllAvatarsInDOM] Updated img src:', img.src);
        }
      });
      
      // Also update any avatar containers (divs with data-user-id)
      const avatarContainers = document.querySelectorAll(`[data-user-id="${userId}"]`);
      avatarContainers.forEach(container => {
        const img = container.querySelector('img');
        if (img) {
          const currentSrc = img.src.split('?')[0];
          if (currentSrc !== cleanPhotoUrl) {
            img.src = photoUrlWithCache;
            console.log('[updateAllAvatarsInDOM] Updated container img src:', img.src);
          }
        }
      });
      
      // Force re-render by triggering a re-render of conversation items if messages view is active
      if (activeView === 'messages') {
        // Re-render conversation list to pick up new photo
        setTimeout(() => {
          if (typeof renderMessagesView === 'function') {
            renderMessagesView();
          }
        }, 100);
      }
      
      console.log('[updateAllAvatarsInDOM] Updated', allAvatarImages.length + avatarContainers.length, 'avatar elements');
    }

    // Centralized avatar rendering function - single source of truth
    // Show profile photo in lightbox
    function showProfilePhotoLightbox(photoUrl, userName) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        cursor: pointer;
      `;
      
      const img = document.createElement('img');
      img.src = photoUrl;
      img.style.cssText = `
        max-width: 90vw;
        max-height: 90vh;
        width: auto;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        object-fit: contain;
      `;
      img.alt = userName || 'Profile photo';
      
      overlay.appendChild(img);
      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';
      
      overlay.addEventListener('click', () => {
        overlay.remove();
        document.body.style.overflow = '';
      });
    }
    
    // Crop image to 1:1 square using canvas
    function cropImageToSquare(file, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Calculate square crop (center crop)
          const size = Math.min(img.width, img.height);
          const x = (img.width - size) / 2;
          const y = (img.height - size) / 2;
          
          // Set canvas to square size
          canvas.width = size;
          canvas.height = size;
          
          // Draw cropped image
          ctx.drawImage(img, x, y, size, size, 0, 0, size, size);
          
          // Convert to blob
          canvas.toBlob((blob) => {
            if (blob) {
              callback(blob);
            } else {
              callback(file); // Fallback to original if conversion fails
            }
          }, 'image/jpeg', 0.92);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // Show image cropper modal with circular crop overlay, drag, and zoom
    function showImageCropper(file, onCrop) {
      const overlay = document.createElement('div');
      overlay.id = 'cropOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 16px;
        max-width: 600px;
        width: 100%;
        padding: 0;
        position: relative;
        overflow: hidden;
      `;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          // Crop state
          let scale = 1;
          let offsetX = 0;
          let offsetY = 0;
          let isDragging = false;
          let dragStartX = 0;
          let dragStartY = 0;
          let lastOffsetX = 0;
          let lastOffsetY = 0;
          
          // Calculate initial crop (centered square)
          const minDimension = Math.min(img.width, img.height);
          const maxDimension = Math.max(img.width, img.height);
          
          // Display size
          const cropSize = 400; // Fixed circular crop area size
          const displayScale = cropSize / minDimension;
          
          // Create crop container
          const cropContainer = document.createElement('div');
          cropContainer.id = 'cropContainer';
          cropContainer.style.cssText = `
            position: relative;
            width: ${cropSize}px;
            height: ${cropSize}px;
            margin: 0 auto;
            background: #000;
            overflow: hidden;
            touch-action: none;
            user-select: none;
          `;
          
          // Create image element (draggable/zoomable)
          const imgElement = document.createElement('img');
          imgElement.src = e.target.result;
          imgElement.style.cssText = `
            position: absolute;
            width: ${img.width * displayScale * scale}px;
            height: ${img.height * displayScale * scale}px;
            left: 0;
            top: 0;
            transform: translate(${offsetX}px, ${offsetY}px);
            cursor: move;
            user-select: none;
            touch-action: none;
            display: block;
            object-fit: contain;
          `;
          imgElement.setAttribute('draggable', 'false');
          
          // Create overlay with circular mask using CSS
          const overlayDiv = document.createElement('div');
          overlayDiv.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            border-radius: 50%;
            box-shadow: 
              0 0 0 9999px rgba(0, 0, 0, 0.7),
              inset 0 0 0 3px white;
          `;
          
          // Function to calculate crop coordinates (used for final crop)
          // This must match exactly what's visible in the circular crop area
          // The circle is centered at (cropSize/2, cropSize/2) with radius cropSize/2
          // We crop a square that fits inside this circle
          const getCropCoordinates = () => {
            // Image display dimensions in pixels (what's shown on screen)
            const imgDisplayWidth = img.width * displayScale * scale;
            const imgDisplayHeight = img.height * displayScale * scale;
            
            // Scale factor: how many source pixels per display pixel
            const scaleFactor = displayScale * scale;
            
            // Crop circle center (always at center of container)
            const cropCenterX = cropSize / 2;
            const cropCenterY = cropSize / 2;
            
            // Image position in container coordinates
            // The image element has left:0, top:0 and is translated by (offsetX, offsetY)
            // So the image's top-left corner is at (offsetX, offsetY) in container coordinates
            const imgLeft = offsetX;
            const imgTop = offsetY;
            
            // The visible square in the crop circle (in container coordinates)
            // For a 1:1 square crop, we use the full cropSize as the square side
            const squareSize = cropSize; // Full diameter = square side for 1:1 crop
            const squareLeft = cropCenterX - squareSize / 2;
            const squareTop = cropCenterY - squareSize / 2;
            
            // Find what part of the source image this square corresponds to
            // Convert from container coordinates to source image coordinates
            // The square's position relative to the image's top-left corner
            const relativeX = squareLeft - imgLeft;
            const relativeY = squareTop - imgTop;
            
            // Convert to source image coordinates
            const sourceX = relativeX / scaleFactor;
            const sourceY = relativeY / scaleFactor;
            const sourceSize = squareSize / scaleFactor;
            
            // Clamp to image bounds
            const clampedX = Math.max(0, Math.min(img.width - sourceSize, sourceX));
            const clampedY = Math.max(0, Math.min(img.height - sourceSize, sourceY));
            const clampedSize = Math.min(sourceSize, img.width - clampedX, img.height - clampedY);
            
            return { x: clampedX, y: clampedY, size: clampedSize };
          };
          
          // Drag handlers
          const handleStart = (clientX, clientY) => {
            isDragging = true;
            dragStartX = clientX;
            dragStartY = clientY;
            lastOffsetX = offsetX;
            lastOffsetY = offsetY;
          };
          
          const handleMove = (clientX, clientY) => {
            if (!isDragging) return;
            const deltaX = clientX - dragStartX;
            const deltaY = clientY - dragStartY;
            offsetX = lastOffsetX + deltaX;
            offsetY = lastOffsetY + deltaY;
            
            // Constrain to keep crop area filled
            const imgDisplayWidth = img.width * displayScale * scale;
            const imgDisplayHeight = img.height * displayScale * scale;
            const maxOffsetX = (imgDisplayWidth - cropSize) / 2;
            const maxOffsetY = (imgDisplayHeight - cropSize) / 2;
            offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, offsetX));
            offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, offsetY));
            
            imgElement.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
          };
          
          const handleEnd = () => {
            isDragging = false;
          };
          
          // Center image initially
          const imgDisplayWidth = img.width * displayScale * scale;
          const imgDisplayHeight = img.height * displayScale * scale;
          offsetX = (cropSize - imgDisplayWidth) / 2;
          offsetY = (cropSize - imgDisplayHeight) / 2;
          imgElement.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
          imgElement.style.left = '0';
          imgElement.style.top = '0';
          
          cropContainer.appendChild(imgElement);
          cropContainer.appendChild(overlayDiv);
          
          // Mouse events - attach to container for better drag handling
          cropContainer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            handleStart(e.clientX, e.clientY);
          });
          
          const mouseMoveHandler = (e) => {
            if (isDragging) {
              e.preventDefault();
              handleMove(e.clientX, e.clientY);
            }
          };
          
          const mouseUpHandler = () => {
            handleEnd();
          };
          
          document.addEventListener('mousemove', mouseMoveHandler);
          document.addEventListener('mouseup', mouseUpHandler);
          
          // Touch events
          cropContainer.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const touch = e.touches[0];
            handleStart(touch.clientX, touch.clientY);
          });
          
          const touchMoveHandler = (e) => {
            if (isDragging) {
              e.preventDefault();
              const touch = e.touches[0];
              handleMove(touch.clientX, touch.clientY);
            }
          };
          
          const touchEndHandler = () => {
            handleEnd();
          };
          
          document.addEventListener('touchmove', touchMoveHandler, { passive: false });
          document.addEventListener('touchend', touchEndHandler);
          
          // Zoom with wheel
          cropContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.max(0.5, Math.min(3, scale * delta));
            
            // Zoom towards mouse position
            const rect = cropContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const scaleChange = newScale / scale;
            offsetX = mouseX - (mouseX - offsetX) * scaleChange;
            offsetY = mouseY - (mouseY - offsetY) * scaleChange;
            
            scale = newScale;
            imgElement.style.width = `${img.width * displayScale * scale}px`;
            imgElement.style.height = `${img.height * displayScale * scale}px`;
            
            // Re-constrain after zoom
            const newImgDisplayWidth = img.width * displayScale * scale;
            const newImgDisplayHeight = img.height * displayScale * scale;
            const maxOffsetX = (newImgDisplayWidth - cropSize) / 2;
            const maxOffsetY = (newImgDisplayHeight - cropSize) / 2;
            offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, offsetX));
            offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, offsetY));
            
            imgElement.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
          }, { passive: false });
          
          // Cleanup event listeners when modal closes
          const cleanup = () => {
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.removeEventListener('touchmove', touchMoveHandler);
            document.removeEventListener('touchend', touchEndHandler);
          };
          
          // Make sure image loads
          imgElement.onload = () => {
            console.log('Crop image loaded');
          };
          imgElement.onerror = (err) => {
            console.error('Crop image error:', err);
          };
          
          modal.innerHTML = `
            <div style="padding: 1.5rem 1.5rem 0;">
              <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; text-align: center;">Crop Profile Photo</h3>
              <p style="text-align: center; color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">Drag to position • Pinch/scroll to zoom</p>
            </div>
          `;
          
          // Append crop container directly
          modal.appendChild(cropContainer);
          
          // Add buttons
          const buttonDiv = document.createElement('div');
          buttonDiv.style.cssText = 'padding: 1.5rem; display: flex; gap: 0.75rem; border-top: 1px solid var(--border);';
          buttonDiv.innerHTML = `
            <button id="cropCancelBtn" class="btn btn-ghost" style="flex: 1; padding: 0.75rem; font-weight: 600;">Cancel</button>
            <button id="cropConfirmBtn" class="btn btn-primary" style="flex: 1; padding: 0.75rem; font-weight: 600;">Use This Photo</button>
          `;
          modal.appendChild(buttonDiv);
          
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
          document.body.style.overflow = 'hidden';
          
          document.getElementById('cropCancelBtn').addEventListener('click', () => {
            cleanup();
            overlay.remove();
            document.body.style.overflow = '';
          });
          
          document.getElementById('cropConfirmBtn').addEventListener('click', () => {
            cleanup();
            
            // Ensure image is fully loaded before cropping
            if (!img.complete || img.naturalWidth === 0) {
              console.error('[CROP] Image not fully loaded');
              showToast('Image not ready. Please try again.');
              return;
            }
            
            // Get crop coordinates - this must match exactly what's visible
            const crop = getCropCoordinates();
            
            console.log('[CROP] ===== CROP DEBUG INFO =====');
            console.log('[CROP] Source image dimensions:', img.width, 'x', img.height);
            console.log('[CROP] Display scale:', displayScale);
            console.log('[CROP] Current zoom scale:', scale);
            console.log('[CROP] Image offset:', offsetX, offsetY);
            console.log('[CROP] Crop container size:', cropSize);
            console.log('[CROP] Calculated crop coordinates:', crop);
            console.log('[CROP] Crop bounds check:', {
              xValid: crop.x >= 0 && crop.x < img.width,
              yValid: crop.y >= 0 && crop.y < img.height,
              sizeValid: crop.size > 0 && crop.x + crop.size <= img.width && crop.y + crop.size <= img.height
            });
            
            // Validate crop coordinates
            if (crop.x < 0 || crop.y < 0 || crop.size <= 0 || 
                crop.x + crop.size > img.width || crop.y + crop.size > img.height) {
              console.error('[CROP] Invalid crop coordinates:', crop);
              showToast('Crop calculation error. Please try again.');
              return;
            }
            
            // Apply crop - create square image that will display as circle
            const finalCanvas = document.createElement('canvas');
            // Use a standard size for consistency (e.g., 400x400 or 800x800)
            const outputSize = 800; // High quality output
            finalCanvas.width = outputSize;
            finalCanvas.height = outputSize;
            const finalCtx = finalCanvas.getContext('2d');
            
            // Set high-quality rendering
            finalCtx.imageSmoothingEnabled = true;
            finalCtx.imageSmoothingQuality = 'high';
            
            // Draw the cropped portion, scaled to output size
            // This ensures the saved image matches what was shown
            try {
              finalCtx.drawImage(
                img, 
                crop.x, crop.y, crop.size, crop.size,  // Source: crop from original image
                0, 0, outputSize, outputSize            // Destination: full canvas at output size
              );
              
              console.log('[CROP] Canvas drawImage completed successfully');
              console.log('[CROP] Canvas dimensions:', finalCanvas.width, 'x', finalCanvas.height);
              
              // Verify canvas has content
              const imageData = finalCtx.getImageData(0, 0, Math.min(10, outputSize), Math.min(10, outputSize));
              const hasContent = imageData.data.some(pixel => pixel !== 0);
              console.log('[CROP] Canvas has content:', hasContent);
              
              if (!hasContent) {
                console.error('[CROP] Canvas appears empty after drawImage');
                showToast('Crop failed. Please try again.');
                return;
              }
            } catch (drawError) {
              console.error('[CROP] Error drawing to canvas:', drawError);
              showToast('Crop error. Please try again.');
              return;
            }
            
            finalCanvas.toBlob((blob) => {
              if (blob && blob.size > 0) {
                console.log('[CROP] ✅ Cropped image created successfully');
                console.log('[CROP] Blob size:', blob.size, 'bytes');
                console.log('[CROP] Blob type:', blob.type);
                onCrop(blob);
              } else {
                console.error('[CROP] ❌ Failed to create blob or blob is empty');
                console.error('[CROP] Blob:', blob);
                showToast('Failed to create cropped image. Please try again.');
              }
              overlay.remove();
              document.body.style.overflow = '';
            }, 'image/jpeg', 0.95); // Higher quality
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function renderUserAvatar(user, size = 40, options = {}) {
      const {
        showBorder = false,
        borderColor = 'var(--border)',
        borderWidth = '2px',
        className = '',
        onClick = null,
        style = '',
        enableLightbox = true,
        enableProfilePopup = false // Enable profile popup for hustlers
      } = options;
      
      // Auto-enable profile popup for hustlers if not explicitly disabled
      const isHustler = user?.roles && Array.isArray(user.roles) && user.roles.includes('HUSTLER');
      const shouldShowProfile = enableProfilePopup || (isHustler && onClick === null);
      
      // Determine click handler - prioritize explicit onClick, then profile popup for hustlers, then lightbox
      let finalOnClick = onClick;
      if (!finalOnClick && shouldShowProfile && user?.id) {
        finalOnClick = `window.showHustlerProfilePopup('${user.id}')`;
      }
      
      const sizePx = `${size}px`;
      const fontSize = `${Math.max(size * 0.4, 14)}px`;
      const initial = (user?.name || user?.email || 'U')[0].toUpperCase();
      
      // Get the latest photoUrl from single source of truth
      // Priority: 1) getUserPhotoUrl (localStorage/auth/state - most up-to-date)
      //           2) user.photoUrl (from API response)
      //           3) null (fallback to initial)
      let photoUrl = null;
      if (user?.id) {
        photoUrl = getUserPhotoUrl(user.id);
      }
      // If getUserPhotoUrl didn't find it, use user.photoUrl from API response
      // This is important for other users (customers/hustlers) who aren't in localStorage
      if (!photoUrl && user?.photoUrl) {
        photoUrl = user.photoUrl;
        // Store in state.users for future lookups
        if (window.state && window.state.users && !window.state.users.find(u => u && u.id === user.id)) {
          window.state.users.push({ id: user.id, photoUrl: user.photoUrl, name: user.name });
        } else if (window.state && window.state.users) {
          const existingUser = window.state.users.find(u => u && u.id === user.id);
          if (existingUser) {
            existingUser.photoUrl = user.photoUrl;
          }
        }
      }
      
      const baseStyle = `
        width: ${sizePx};
        height: ${sizePx};
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        ${showBorder ? `border: ${borderWidth} solid ${borderColor};` : ''}
        ${style}
        ${(finalOnClick || shouldShowProfile) ? 'cursor: pointer;' : ''}
      `.trim();
      
      const userId = user?.id || '';
      const dataUserIdAttr = userId ? `data-user-id="${userId}"` : '';
      
      if (photoUrl) {
        // Add cache-busting if not already present
        const finalPhotoUrl = photoUrl.includes('?') ? photoUrl : `${photoUrl}?t=${Date.now()}`;
        
        // Add lightbox click handler if enabled and no other click handler
        const lightboxClick = enableLightbox && !finalOnClick ? `onclick="window.showProfilePhotoLightbox('${finalPhotoUrl}', '${(user.name || 'User').replace(/'/g, "\\'")}')"` : '';
        
        return `
          <div class="${className}" style="${baseStyle}" ${finalOnClick ? `onclick="${finalOnClick}"` : ''} ${lightboxClick} ${dataUserIdAttr}>
            <img 
              src="${finalPhotoUrl}" 
              alt="${user.name || 'User'}" 
              ${dataUserIdAttr}
              onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=' + encodeURIComponent('${(user.name || user.email || 'User').replace(/'/g, "\\'")}') + '&background=6366f1&color=fff&size=${size}';"
              style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; object-fit: cover; object-position: center; border-radius: 50%; display: block; ${(finalOnClick || shouldShowProfile) ? 'cursor: pointer;' : ''}"
              onerror="this.onerror=null; this.style.display='none'; const fallback=this.parentElement.querySelector('.avatar-fallback') || document.createElement('div'); fallback.className='avatar-fallback'; fallback.style.cssText='width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: ${fontSize}; font-weight: 700; color: var(--primary); background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%); border-radius: 50%;'; fallback.textContent='${initial}'; if(!this.parentElement.querySelector('.avatar-fallback')) this.parentElement.appendChild(fallback);"
            />
          </div>
        `;
      } else {
        return `
          <div 
            class="${className}" 
            style="${baseStyle} background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%); font-size: ${fontSize}; font-weight: 700; color: var(--primary);"
            ${finalOnClick ? `onclick="${finalOnClick}"` : ''}
            ${dataUserIdAttr}
          >
            ${initial}
          </div>
        `;
      }
    }

    // Shared ProfileCard Component - Standardized profile card for job details, applicant lists, messages
    function renderProfileCard(user, options = {}) {
      const {
        showViewReviews = false,
        avatarSize = 40,
        onClick = null,
        ratingAvg = 0,
        ratingCount = 0
      } = options;
      
      if (!user) return '';
      
      // Format name (first and last)
      const nameParts = (user.name || '').trim().split(/\s+/);
      const displayName = nameParts.length > 0 ? nameParts[0] + (nameParts.length > 1 ? ' ' + nameParts[nameParts.length - 1] : '') : (user.name || 'User');
      
      // Format location - use hometown if available, otherwise city + state (never show street address)
      let location = '';
      if (user.hometown) {
        location = user.hometown;
      } else {
        const locationParts = [];
        if (user.city) locationParts.push(user.city);
        if (user.state) locationParts.push(user.state);
        location = locationParts.length > 0 ? locationParts.join(', ') : '';
      }
      
      // Rating display
      const ratingDisplay = ratingCount > 0 
        ? `⭐ ${ratingAvg.toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})`
        : 'New';
      
      const cardId = `profileCard_${user.id}_${Date.now()}`;
      const viewReviewsId = `viewReviews_${user.id}_${Date.now()}`;
      
      // Determine click handler for card - prioritize explicit onClick, then profile popup for hustlers
      let cardOnClick = onClick;
      if (!cardOnClick && shouldShowProfile && user?.id) {
        cardOnClick = `window.showHustlerProfilePopup('${user.id}')`;
      }
      
      // Make name clickable if profile popup is enabled
      const nameOnClick = shouldShowProfile && user?.id && !onClick ? `onclick="window.showHustlerProfilePopup('${user.id}')" style="cursor: pointer;"` : '';
      
      let cardHTML = `
        <div class="profile-card" data-user-id="${user.id}" style="
          display: flex;
          gap: 0.75rem;
          align-items: center;
          padding: 0.75rem;
          border-radius: 8px;
          background: white;
          border: 1px solid var(--border);
          ${cardOnClick ? 'cursor: pointer;' : ''}
        " ${cardOnClick ? `onclick="${cardOnClick}"` : ''}>
          ${renderUserAvatar(user, avatarSize, {
            showBorder: true,
            borderWidth: '2px',
            style: 'flex-shrink: 0;',
            enableProfilePopup: shouldShowProfile
          })}
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: var(--text-main); font-size: 0.95rem; margin-bottom: 0.25rem;" ${nameOnClick}>
              ${displayName}
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; font-size: 0.85rem; color: var(--text-muted);">
              <span>${ratingDisplay}</span>
            </div>
            ${location ? `<div style="font-size: 0.8rem; color: var(--text-muted);">📍 ${location}</div>` : ''}
            ${user.tools && user.tools.trim() ? `<div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">🔧 ${user.tools}</div>` : ''}
            ${showViewReviews && ratingCount > 0 ? `
              <button id="${viewReviewsId}" class="btn btn-ghost" style="
                padding: 0.25rem 0.5rem;
                margin-top: 0.5rem;
                font-size: 0.75rem;
                border: 1px solid var(--border);
              ">View Reviews</button>
            ` : ''}
          </div>
        </div>
      `;
      
      // Add event listener for view reviews if enabled
      if (showViewReviews && ratingCount > 0) {
        setTimeout(() => {
          const viewReviewsBtn = document.getElementById(viewReviewsId);
          if (viewReviewsBtn) {
            viewReviewsBtn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await showUserReviews(user.id);
            });
          }
        }, 100);
      }
      
      return cardHTML;
    }
    
    // Unified Profile Card Component - Shows user profile with completed jobs, bio, and reviews
    // Make it globally accessible
    // showUserProfileCard removed - all profiles now use showHustlerProfilePopup (the Browse Jobs popup)
    // This ensures consistency across the entire app
    window.showUserProfileCard = async function showUserProfileCard(userId) {
      // Redirect to the standardized Browse Jobs profile popup
      if (typeof window.showHustlerProfilePopup === 'function') {
        await window.showHustlerProfilePopup(userId);
        } else {
        showToast("Profile view not available.");
      }
    };
    
    // Show user reviews modal (5 most recent completed jobs) - Legacy function, kept for compatibility
    async function showUserReviews(userId) {
      try {
        const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
        const reviewsResponse = await fetch(`${API_BASE}/reviews/user/${userId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!reviewsResponse.ok) {
          showToast("Could not load reviews.");
          return;
        }
        
        const reviewsData = await reviewsResponse.json();
        const reviews = Array.isArray(reviewsData) ? reviewsData : (reviewsData.reviews || []);
        
        // Get 5 most recent reviews
        const recentReviews = reviews
          .filter(r => r.job && r.job.status === 'completed')
          .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
          .slice(0, 5);
        
        const user = state.users.find(u => u.id === userId) || {};
        
        // Create modal
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
        `;
        
        const modal = document.createElement('div');
        modal.style.cssText = `
          background: white;
          border-radius: 12px;
          max-width: 500px;
          width: 100%;
          max-height: 80vh;
          overflow-y: auto;
          position: relative;
        `;
        
        modal.innerHTML = `
          <button onclick="this.closest('[style*=\\'position: fixed\\']').remove(); document.body.style.overflow = '';" style="
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f3f4f6;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
          ">×</button>
          <div style="padding: 2rem;">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0;">Reviews for ${user.name || 'User'}</h2>
            ${recentReviews.length === 0 ? `
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                No completed job reviews yet.
              </div>
            ` : recentReviews.map(review => `
              <div style="
                padding: 1rem;
                border: 1px solid var(--border);
                border-radius: 8px;
                margin-bottom: 1rem;
              ">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">${'⭐'.repeat(review.stars || review.rating || 0)}</span>
                  <span style="font-weight: 600;">${review.stars || review.rating || 0}/5</span>
                </div>
                ${review.comment ? `<div style="color: var(--text-main); margin-bottom: 0.5rem;">${review.comment}</div>` : ''}
                ${review.job ? `<div style="font-size: 0.85rem; color: var(--text-muted);">Job: ${review.job.title || 'Untitled'}</div>` : ''}
              </div>
            `).join('')}
          </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.style.overflow = 'hidden';
        
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.remove();
            document.body.style.overflow = '';
          }
        });
      } catch (error) {
        console.error("Error showing user reviews:", error);
        showToast("Could not load reviews.");
      }
    }

    // Render Basic Info Section - View Mode
    function renderBasicInfoView(user, ratingAvg, ratingCount, container) {
      if (!container) {
        return;
      }
      // Use compact size for mobile-friendly profile photo (48px for balanced view)
      const avatarContent = renderUserAvatar(user, 48, { 
        showBorder: true, 
        borderWidth: '2px',
        style: 'box-shadow: 0 1px 3px rgba(0,0,0,0.1);'
      });
      
      const genderLabel = user.gender ? 
        (user.gender === 'male' ? 'Male' : 
         user.gender === 'female' ? 'Female' : 
         user.gender === 'other' ? 'Non-binary' : 
         user.gender === 'prefer_not_to_say' ? 'Prefer not to say' : user.gender) : '';
      
      container.innerHTML = `
        <div class="card" style="padding: 1rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white;">
          <div style="display: flex; gap: 1rem; align-items: flex-start;">
            <!-- Profile Photo -->
            <div style="flex-shrink: 0;">${avatarContent}</div>
            
            <!-- Info -->
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                <div>
                  <h2 style="margin: 0; font-size: 1.75rem; font-weight: 700; color: var(--text-main);">${user.name || 'User'}</h2>
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                    <span style="font-size: 1.1rem;">⭐</span>
                    <span style="font-weight: 600; color: var(--text-main);">${ratingAvg.toFixed(1)}</span>
                    <span style="color: var(--text-muted); font-size: 0.9rem;">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                  </div>
                </div>
                <button class="btn btn-primary" id="basicInfoEditBtn" style="padding: 0.5rem 1rem; font-size: 0.9rem; white-space: nowrap;">Edit</button>
              </div>
              
              ${genderLabel ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">${genderLabel}</div>` : ''}
              
              ${user.bio ? `<div style="color: var(--text-main); line-height: 1.6; margin-top: 0.75rem; font-size: 0.95rem;">${user.bio}</div>` : '<div style="color: var(--text-muted); font-style: italic; margin-top: 0.75rem; font-size: 0.9rem;">No description yet.</div>'}
              
              ${user.tools && user.tools.trim() ? `<div style="color: var(--text-main); line-height: 1.6; margin-top: 0.75rem; font-size: 0.95rem;"><strong>🔧 Tools / Equipment:</strong> ${user.tools.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : ''}
              
              ${user.hometown ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.75rem;">${user.hometown.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>` : ''}
            </div>
          </div>
        </div>
      `;
      
      // Add Edit button handler
      setTimeout(() => {
        const editBtn = document.getElementById("basicInfoEditBtn");
        if (editBtn) {
          editBtn.addEventListener("click", () => {
            renderBasicInfoEdit(user, ratingAvg, ratingCount, container);
          });
        }
      }, 100);
    }
    
    // Render Basic Info Section - Edit Mode
    function renderBasicInfoEdit(user, ratingAvg, ratingCount, container) {
      // Store original photo URL for revert on cancel
      const originalPhotoUrl = user.photoUrl || null;
      let photoPreview = user.photoUrl || null;
      let newPhotoFile = null;
      let hasUnsavedPhoto = false;
      
      // Use renderUserAvatar for consistency (80px for mobile-friendly size)
      const avatarContent = renderUserAvatar(user, 80, { 
        showBorder: true, 
        borderWidth: '2px',
        style: 'box-shadow: 0 2px 8px rgba(0,0,0,0.1);'
      });
      
      container.innerHTML = `
        <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white;">
          <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
            <!-- Profile Photo with Upload -->
            <div style="flex-shrink: 0;">
              <div id="basicInfoPhotoPreview" style="margin-bottom: 1rem; width: 48px; height: 48px;">
                ${avatarContent}
              </div>
              <input type="file" id="basicInfoPhotoUpload" accept="image/*" style="display: none;" />
              <button class="btn btn-ghost" onclick="document.getElementById('basicInfoPhotoUpload').click();" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">Upload new photo</button>
            </div>
            
            <!-- Edit Fields -->
            <div style="flex: 1; min-width: 0;">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Full Name</label>
                <input type="text" id="basicInfoName" value="${(user.name || '').replace(/"/g, '&quot;')}" placeholder="Your full name" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: white;" />
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Gender (Optional)</label>
                <select id="basicInfoGender" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: white;">
                  <option value="">Select...</option>
                  <option value="male" ${user.gender === 'male' ? 'selected' : ''}>Male</option>
                  <option value="female" ${user.gender === 'female' ? 'selected' : ''}>Female</option>
                  <option value="other" ${user.gender === 'other' ? 'selected' : ''}>Non-binary</option>
                  <option value="prefer_not_to_say" ${user.gender === 'prefer_not_to_say' ? 'selected' : ''}>Prefer not to say</option>
                </select>
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Description / Bio</label>
                <textarea id="basicInfoBio" placeholder="Tell people about yourself, your experience, and what jobs you like to do." rows="4" maxlength="300" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical; background: white;">${(user.bio || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                <div style="text-align: right; color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">
                  <span id="basicInfoBioCount">0</span>/300 characters
                </div>
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Hometown (City + State) <span style="color: #dc2626;">*</span></label>
                <input type="text" id="basicInfoHometown" value="${(user.hometown || '').replace(/"/g, '&quot;')}" placeholder="e.g., Brentwood" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: white;" />
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">Enter your city (e.g., Brentwood) — ", TN" will be added automatically</div>
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Tools / Equipment (Optional)</label>
                <textarea id="basicInfoTools" placeholder="List any tools or equipment you have (e.g., truck, trailer, power tools)" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical; background: white;">${(user.tools || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
              </div>
              
              <!-- Rating Display (read-only) -->
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                <span style="font-size: 1.1rem;">⭐</span>
                <span style="font-weight: 600; color: var(--text-main);">${ratingAvg.toFixed(1)}</span>
                <span style="color: var(--text-muted); font-size: 0.9rem;">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
              </div>
              
              <!-- Save/Cancel Buttons -->
              <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <button class="btn btn-ghost" id="basicInfoCancelBtn" style="padding: 0.75rem 1.5rem;">Cancel</button>
                <button class="btn btn-primary" id="basicInfoSaveBtn" style="padding: 0.75rem 1.5rem;">Save</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Update bio character count
      const bioInput = document.getElementById("basicInfoBio");
      const bioCount = document.getElementById("basicInfoBioCount");
      if (bioInput && bioCount) {
        bioCount.textContent = bioInput.value.length;
        bioInput.addEventListener("input", () => {
          bioCount.textContent = bioInput.value.length;
        });
      }
      
      // Store original values in closure for cancel handler
      const originalUser = { ...user };
      
      // Photo upload handler
      const photoUpload = document.getElementById("basicInfoPhotoUpload");
      const photoPreviewDiv = document.getElementById("basicInfoPhotoPreview");
      if (photoUpload && photoPreviewDiv) {
        photoUpload.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          if (!file.type.startsWith('image/')) {
            showToast("Please select an image file.");
            return;
          }
          
          // Show cropper modal
          showImageCropper(file, (croppedBlob) => {
            // Create a new file from the cropped blob
            const croppedFile = new File([croppedBlob], file.name, { type: 'image/jpeg' });
            newPhotoFile = croppedFile;
            hasUnsavedPhoto = true;
            
            // Immediately update preview with cropped image (don't upload yet)
            const reader = new FileReader();
            reader.onload = (event) => {
              photoPreview = event.target.result;
              const tempUserForPreview = { ...user, photoUrl: photoPreview };
              photoPreviewDiv.innerHTML = renderUserAvatar(tempUserForPreview, 48, { 
                showBorder: true, 
                borderWidth: '2px',
                style: 'box-shadow: 0 1px 3px rgba(0,0,0,0.1);',
                enableLightbox: false
              });
              
              // Mark profile as having unsaved changes
              const saveBtn = document.getElementById("basicInfoSaveBtn");
              if (saveBtn) {
                saveBtn.style.background = "var(--primary)";
                saveBtn.style.color = "white";
                saveBtn.textContent = "Save";
              }
            };
            reader.readAsDataURL(croppedBlob);
          });
        });
      }
      
      // Cancel button handler - revert unsaved photo changes
      const cancelBtn = document.getElementById("basicInfoCancelBtn");
      if (cancelBtn) {
        cancelBtn.addEventListener("click", () => {
          // Revert to original photo if user had unsaved photo changes
          if (hasUnsavedPhoto) {
            newPhotoFile = null;
            hasUnsavedPhoto = false;
            photoPreview = originalPhotoUrl;
          }
          // Use original user data
          renderBasicInfoView(originalUser, ratingAvg, ratingCount, container);
        });
      }
      
      // Auto-append ", TN" to hometown input
      const hometownInput = document.getElementById("basicInfoHometown");
      if (hometownInput) {
        // Format existing value if it doesn't already have ", TN"
        const currentValue = hometownInput.value.trim();
        if (currentValue && !currentValue.endsWith(', TN') && !currentValue.endsWith(', Tennessee')) {
          // Remove any existing state suffix and add ", TN"
          const cityOnly = currentValue.replace(/,\s*(TN|Tennessee)$/i, '').trim();
          if (cityOnly) {
            hometownInput.value = cityOnly + ', TN';
          }
        }
        
        // Auto-append ", TN" on blur (when user finishes typing)
        hometownInput.addEventListener('blur', () => {
          let value = hometownInput.value.trim();
          if (value) {
            // Remove any existing state suffix
            value = value.replace(/,\s*(TN|Tennessee)$/i, '').trim();
            if (value) {
              hometownInput.value = value + ', TN';
            }
          }
        });
      }
      
      // Save button handler
      const saveBtn = document.getElementById("basicInfoSaveBtn");
      if (saveBtn) {
        saveBtn.addEventListener("click", async () => {
          const nameInput = document.getElementById("basicInfoName");
          const genderSelect = document.getElementById("basicInfoGender");
          const bioInput = document.getElementById("basicInfoBio");
          const hometownInput = document.getElementById("basicInfoHometown");
          const toolsInput = document.getElementById("basicInfoTools");
          
          const name = nameInput?.value.trim() || '';
          const gender = genderSelect?.value || '';
          const bio = bioInput?.value.trim() || '';
          const hometown = hometownInput?.value.trim() || '';
          const tools = toolsInput?.value.trim() || '';
          
          if (!name) {
            showToast("Please enter your name.");
            if (nameInput) nameInput.focus();
            return;
          }
          
          if (!hometown) {
            showToast("Please enter your hometown (City + State).");
            if (hometownInput) hometownInput.focus();
            return;
          }
          
          if (bio.length > 300) {
            showToast("Description must be 300 characters or less.");
            if (bioInput) bioInput.focus();
            return;
          }
          
          saveBtn.disabled = true;
          const originalText = saveBtn.textContent;
          saveBtn.textContent = "Saving...";
          
          try {
            const updates = { name, gender, bio, hometown, tools };
            
            // Upload photo if new one selected (already cropped)
            let uploadedPhotoUrl = null;
            if (newPhotoFile) {
              const formData = new FormData();
              formData.append('photo', newPhotoFile);
              
              const token = localStorage.getItem('hustl_token');
              const uploadResponse = await fetch(`${API_BASE}/users/me/photo`, {
                method: 'POST',
                headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                body: formData
              });
              
              if (uploadResponse.ok) {
                const uploadData = await uploadResponse.json();
                console.log('[PROFILE SAVE] Photo upload response:', uploadData);
                
                // Get photoUrl from response - prefer user.photoUrl (from DB) over photoUrl (from R2)
                // Both should be the same, but DB version is the source of truth
                uploadedPhotoUrl = uploadData.user?.photoUrl || uploadData.photoUrl;
                
                if (!uploadedPhotoUrl) {
                  console.error('[PROFILE SAVE] Photo upload succeeded but no photoUrl in response:', uploadData);
                  throw new Error("Photo upload succeeded but no photoUrl returned");
                }
                
                // Store the clean URL (without cache buster) for database/localStorage
                const photoUrlClean = uploadedPhotoUrl.replace(/\?t=\d+(&t=\d+)*$/, '');
                
                // Immediately update localStorage with clean URL (source of truth)
                const currentUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
                currentUser.photoUrl = photoUrlClean;
                currentUser.id = user.id; // Ensure ID is set
                localStorage.setItem('hustl_user', JSON.stringify(currentUser));
                
                // Update cached user in auth object with clean URL
                if (window.hustlAPI && window.hustlAPI.auth) {
                  if (!window.hustlAPI.auth.currentUser) {
                    window.hustlAPI.auth.currentUser = { ...currentUser };
                  } else {
                    window.hustlAPI.auth.currentUser.photoUrl = photoUrlClean;
                  }
                }
                
                // Update local user object
                user.photoUrl = photoUrlClean;
                
                console.log('[PROFILE SAVE] Photo uploaded successfully. Clean URL:', photoUrlClean);
                
                // Force immediate UI update with cache-busted URL for display
                const photoUrlForDisplay = `${photoUrlClean}?t=${Date.now()}`;
                updateAllAvatarsInDOM(photoUrlForDisplay, user.id);
              } else {
                const errorData = await uploadResponse.json().catch(() => ({}));
                const errorText = await uploadResponse.text().catch(() => '');
                console.error('[PROFILE SAVE] Photo upload failed:', uploadResponse.status, errorData, errorText);
                throw new Error(errorData.error || "Failed to upload photo");
              }
            }
            
            // Prepare updates - always send bio (even if empty/null) to ensure it's saved
            const cleanUpdates = {};
            if (updates.name && updates.name.trim()) {
              cleanUpdates.name = updates.name.trim();
            }
            if (updates.gender !== undefined && updates.gender !== '') {
              cleanUpdates.gender = updates.gender;
            } else if (updates.gender === '') {
              // Explicitly clear gender if empty string
              cleanUpdates.gender = null;
            }
            // Always send bio - send null if empty to clear it, or the trimmed value
            cleanUpdates.bio = bio.trim() || null;
            
            // Hometown - required, must have value
            if (hometown.trim()) {
              cleanUpdates.hometown = hometown.trim();
            }
            
            // Tools - optional, send null if empty
            if (updates.tools !== undefined) {
              cleanUpdates.tools = tools.trim() || null;
            }
            
            // Note: photoUrl is already saved by the upload endpoint, but we include it here
            // to ensure the PATCH response includes it
            if (uploadedPhotoUrl) {
              cleanUpdates.photoUrl = uploadedPhotoUrl.replace(/\?t=\d+$/, ''); // Remove cache buster for DB
            }
            
            console.log('[PROFILE SAVE] Sending update to server:', JSON.stringify(cleanUpdates, null, 2));
            
            // Update profile - get the updated user from response
            // This is the single source of truth from the database
            const updatedUser = await window.hustlAPI.users.updateProfile(cleanUpdates);
            
            if (!updatedUser) {
              throw new Error("No user data returned from server");
            }
            
            console.log('[PROFILE SAVE] Server response:', JSON.stringify(updatedUser, null, 2));
            
            // Verify that the saved data is in the response
            if (cleanUpdates.name && updatedUser.name !== cleanUpdates.name) {
              console.warn('[PROFILE SAVE] Name mismatch! Sent:', cleanUpdates.name, 'Got:', updatedUser.name);
            }
            // Check bio - handle both null and empty string as equivalent
            const sentBio = cleanUpdates.bio === null || cleanUpdates.bio === '' ? null : cleanUpdates.bio;
            const receivedBio = updatedUser.bio === null || updatedUser.bio === '' ? null : updatedUser.bio;
            if (cleanUpdates.bio !== undefined && sentBio !== receivedBio) {
              console.warn('[PROFILE SAVE] Bio mismatch! Sent:', JSON.stringify(cleanUpdates.bio), 'Got:', JSON.stringify(updatedUser.bio));
              console.warn('[PROFILE SAVE] Bio types - Sent type:', typeof cleanUpdates.bio, 'Got type:', typeof updatedUser.bio);
            }
            
            // Handle photoUrl - ensure it's always set correctly
            if (uploadedPhotoUrl) {
              // We already updated localStorage and auth.currentUser above
              // But ensure updatedUser has the clean URL (without cache buster)
              const photoUrlClean = uploadedPhotoUrl.replace(/\?t=\d+(&t=\d+)*$/, '');
              updatedUser.photoUrl = photoUrlClean;
              console.log('[PROFILE SAVE] Photo URL in updatedUser:', updatedUser.photoUrl);
            } else if (updatedUser.photoUrl) {
              // If photoUrl came from the update response (not from upload), use it
              console.log('[PROFILE SAVE] Photo URL from update response:', updatedUser.photoUrl);
              updateAllAvatarsInDOM(`${updatedUser.photoUrl}?t=${Date.now()}`, user.id);
            } else {
              console.warn('[PROFILE SAVE] No photoUrl in updatedUser after save');
            }
            
            // Update local storage with the complete user object from server
            // This is the single source of truth - what's actually in the database
            // CRITICAL: Always include photoUrl
            if (updatedUser.photoUrl) {
              localStorage.setItem('hustl_user', JSON.stringify(updatedUser));
              console.log('[PROFILE SAVE] Updated localStorage with photoUrl:', updatedUser.photoUrl);
            } else {
              console.warn('[PROFILE SAVE] updatedUser missing photoUrl, preserving existing localStorage value');
              // Don't overwrite localStorage if photoUrl is missing
              const existingUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
              if (existingUser.photoUrl) {
                updatedUser.photoUrl = existingUser.photoUrl;
                localStorage.setItem('hustl_user', JSON.stringify(updatedUser));
              } else {
                localStorage.setItem('hustl_user', JSON.stringify(updatedUser));
              }
            }
            
            // Verify tools were saved and update UI
            if (cleanUpdates.tools !== undefined) {
              const sentTools = cleanUpdates.tools === null || cleanUpdates.tools === '' ? null : cleanUpdates.tools;
              const receivedTools = updatedUser.tools === null || updatedUser.tools === '' ? null : updatedUser.tools;
              const finalTools = receivedTools || sentTools; // Use received if available, otherwise use sent
              
              if (sentTools !== receivedTools) {
                console.warn('[PROFILE SAVE] Tools mismatch! Sent:', JSON.stringify(cleanUpdates.tools), 'Got:', JSON.stringify(updatedUser.tools));
                // Force update tools in localStorage with what we sent (it should be saved)
                const storedUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
                storedUser.tools = sentTools;
                localStorage.setItem('hustl_user', JSON.stringify(storedUser));
              } else {
                console.log('[PROFILE SAVE] Tools match:', receivedTools);
              }
              
              // Update the input field with saved value
              const toolsInput = document.getElementById("basicInfoTools");
              if (toolsInput) {
                toolsInput.value = finalTools || '';
              }
              
              // Update all profile cards on the page for this user
              const profileCards = document.querySelectorAll(`[data-user-id="${user.id}"], .profile-card[data-user-id="${user.id}"]`);
              profileCards.forEach(card => {
                // Find the tools element in the card
                const toolsElement = card.querySelector('[style*="🔧"], [style*="Tools"]');
                if (toolsElement) {
                  if (finalTools && finalTools.trim()) {
                    toolsElement.textContent = `🔧 ${finalTools}`;
                    toolsElement.style.display = '';
                  } else {
                    toolsElement.style.display = 'none';
                  }
                } else if (finalTools && finalTools.trim()) {
                  // If tools element doesn't exist, find the location element and add tools after it
                  const locationElement = card.querySelector('[style*="📍"]');
                  if (locationElement && locationElement.parentElement) {
                    const toolsDiv = document.createElement('div');
                    toolsDiv.style.cssText = 'font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;';
                    toolsDiv.textContent = `🔧 ${finalTools}`;
                    locationElement.parentElement.insertBefore(toolsDiv, locationElement.nextSibling);
                  }
                }
              });
              
              console.log('[PROFILE SAVE] Updated', profileCards.length, 'profile cards for user', user.id);
            }
            
            // Update cached user in auth object
            if (window.hustlAPI && window.hustlAPI.auth) {
              window.hustlAPI.auth.currentUser = updatedUser;
              console.log('[PROFILE SAVE] Updated auth.currentUser with photoUrl:', updatedUser.photoUrl);
            }
            
            // Invalidate API cache to force fresh fetch on next render
            if (window.optimizedApi && typeof window.optimizedApi.invalidateCache === 'function') {
              window.optimizedApi.invalidateCache('/users/me');
            }
            
            // Update the local user object for consistency
            Object.assign(user, updatedUser);
            
            // Show success confirmation
            saveBtn.textContent = "Saved ✅";
            saveBtn.style.background = "#16a34a";
            saveBtn.style.color = "white";
            showToast("✅ Profile saved successfully!");
            
            // Return to view mode with updated user immediately - use the server response
            renderBasicInfoView(updatedUser, ratingAvg, ratingCount, container);
            
            // Don't re-fetch immediately - we already have the fresh data from the server
            // The server response is the source of truth, so use it directly
            
            // Reset button after 2 seconds
            setTimeout(() => {
              saveBtn.disabled = false;
              saveBtn.textContent = originalText;
              saveBtn.style.background = "";
              saveBtn.style.color = "";
            }, 2000);
          } catch (error) {
            console.error("Error saving profile:", error);
            console.error("Error details:", error.details);
            
            // Show detailed error message
            let errorMessage = error.message || "Error saving profile. Please try again.";
            if (error.details && error.details.errors) {
              const validationErrors = error.details.errors.map(e => e.msg || `${e.param}: ${e.msg}`).join(', ');
              errorMessage = `Validation error: ${validationErrors}`;
            }
            showToast(`❌ ${errorMessage}`);
            
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
            saveBtn.style.background = "";
            saveBtn.style.color = "";
          }
        });
      }
    }

    async function renderProfile() {
  // Use API to get current user - always fetch fresh data from server
  let user = null;
  try {
    // Force fresh fetch by calling the API directly with cache-busting
    // This ensures we get the latest data from the database, not stale cache
    const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
    if (token) {
      // Add cache-busting query parameter to force fresh fetch
      const cacheBuster = `?t=${Date.now()}`;
      const response = await fetch(`${API_BASE}/users/me${cacheBuster}`, {
        headers: { 
          'Authorization': `Bearer ${token}`,
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache'
        }
      });
      if (response.ok) {
        user = await response.json();
        console.log('[PROFILE RENDER] Fetched fresh user data from server:', user);
        console.log('[PROFILE RENDER] User photoUrl:', user.photoUrl);
        
        // CRITICAL: Ensure photoUrl is always included
        if (!user.photoUrl) {
          console.warn('[PROFILE RENDER] User data missing photoUrl, checking localStorage');
          const cachedUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
          if (cachedUser.photoUrl && cachedUser.id === user.id) {
            user.photoUrl = cachedUser.photoUrl;
            console.log('[PROFILE RENDER] Restored photoUrl from localStorage:', user.photoUrl);
          }
        }
        
        // Update cache with fresh data from server (including photoUrl)
        localStorage.setItem('hustl_user', JSON.stringify(user));
        if (window.hustlAPI && window.hustlAPI.auth) {
          window.hustlAPI.auth.currentUser = user;
        }
      } else {
        const errorText = await response.text();
        console.error('[PROFILE RENDER] Failed to fetch user:', response.status, errorText);
        // Fallback to cached method only if server request fails
        user = await window.hustlAPI.auth.getCurrentUser();
      }
    } else {
      user = await window.hustlAPI.auth.getCurrentUser();
    }
  } catch (error) {
    console.error("[PROFILE RENDER] Error getting user for profile:", error);
    // Try to use cached user as fallback only if server fetch fails
    try {
      const cached = localStorage.getItem('hustl_user');
      if (cached) {
        user = JSON.parse(cached);
        console.log('[PROFILE RENDER] Using cached user data as fallback');
      }
    } catch (e) {
      console.error("Error parsing cached user:", e);
    }
  }
  
  if (!user) {
    console.warn("No user data available for profile render");
    return;
  }
  
  const basicInfoSection = document.getElementById("profileBasicInfo");
  const stripeContent = document.getElementById("stripeConnectContent");
  const quickStats = document.getElementById("profileQuickStats");
  
  // jobsList might not exist if we're on Settings tab, that's OK
  const jobsList = document.getElementById("profileJobsList");

  if (!user) {
    if (basicInfoSection) basicInfoSection.innerHTML = `
      <div class='muted' style='padding: 2rem; text-align: center;'>
        <div style="margin-bottom: 1rem; font-size: 1.1rem;">Please log in to see your profile.</div>
        <button class="btn btn-primary" onclick="if(window.openAuthModal) window.openAuthModal('login'); else setView('auth');" style="padding: 0.75rem 1.5rem;">Log In / Sign Up</button>
      </div>
    `;
    if (quickStats) quickStats.innerHTML = "";
    if (jobsList) jobsList.innerHTML = "";
    return;
  }

  // figure out jobs related to this user
  const activeJobs = state.jobs.filter(
    (j) =>
      j.status !== "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );
  const completedJobs = state.jobs.filter(
    (j) =>
      j.status === "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );

  const totalEarned = state.jobs.reduce((sum, j) => {
    if (j.acceptedHustlerId === user.id && j.paymentStatus === "paid") {
      return sum + (j.hustlerPayoutAmount || 0);
    }
    return sum;
  }, 0);

  const totalSpent = state.jobs.reduce((sum, j) => {
    if (j.postedByUserId === user.id && j.paymentStatus === "paid") {
      return sum + (j.chargedAmount || 0);
    }
    return sum;
  }, 0);

  // Fetch ratings/reviews for Basic Info section
  let ratingAvg = 5.0;
  let ratingCount = 0;
  try {
    const token = localStorage.getItem('hustl_token');
    const reviewsResponse = await fetch(`${API_BASE}/reviews/user/${user.id}`, {
      headers: token ? { 'Authorization': `Bearer ${token}` } : {}
    });
    if (reviewsResponse.ok) {
      const reviewsData = await reviewsResponse.json();
      const reviews = Array.isArray(reviewsData) ? reviewsData : (reviewsData.reviews || []);
      ratingCount = reviews.length;
      if (reviews.length > 0) {
        const sum = reviews.reduce((acc, r) => acc + (r.stars || 5), 0);
        ratingAvg = sum / reviews.length;
      }
    }
  } catch (error) {
    console.error("Error fetching reviews:", error);
    // Continue with default values if fetch fails
  }

  // Render Basic Info Section (View Mode by default)
  if (basicInfoSection) {
    try {
      renderBasicInfoView(user, ratingAvg, ratingCount, basicInfoSection);
    } catch (error) {
      console.error("Error rendering Basic Info:", error);
      // Fallback: show basic info even if render fails
      basicInfoSection.innerHTML = `
        <div class="card" style="padding: 2rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white;">
          <div style="display: flex; gap: 2rem; align-items: flex-start;">
            ${renderUserAvatar(user, 48, { 
              showBorder: true, 
              borderWidth: '2px',
              style: 'box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-shrink: 0;'
            })}
            <div style="flex: 1; min-width: 0;">
              <h2 style="margin: 0; font-size: 1.75rem; font-weight: 700; color: var(--text-main);">${user.name || 'User'}</h2>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                <span style="font-size: 1.1rem;">⭐</span>
                <span style="font-weight: 600; color: var(--text-main);">${ratingAvg.toFixed(1)}</span>
                <span style="color: var(--text-muted); font-size: 0.9rem;">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
              </div>
              ${user.bio ? `<div style="color: var(--text-main); line-height: 1.6; margin-top: 0.75rem; font-size: 0.95rem;">${user.bio}</div>` : '<div style="color: var(--text-muted); font-style: italic; margin-top: 0.75rem; font-size: 0.9rem;">No description yet.</div>'}
            </div>
          </div>
        </div>
      `;
    }
  } else {
    console.error("profileBasicInfo element not found in DOM");
  }
  
  // Render Quick Stats (already got quickStats above, but check again)
  if (quickStats) {
    quickStats.innerHTML = `
      <div class="quick-stat-card">
        <div class="quick-stat-icon">✅</div>
        <div class="quick-stat-value">${completedJobs.length}</div>
        <div class="quick-stat-label">Jobs Done</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-icon">⭐</div>
        <div class="quick-stat-value">${user.ratingAvg ? user.ratingAvg.toFixed(1) : (user.ratingCount > 0 ? '0.0' : '0.0')}</div>
        <div class="quick-stat-label">Rating</div>
      </div>
    `;
  }
  
  // Initialize Profile Tabs (call after a short delay to ensure DOM is ready)
  setTimeout(() => {
    initProfileTabs();
    
    // Populate Ratings tab when clicked
    const ratingsTab = document.querySelector('.profile-tab[data-tab="ratings"]');
    if (ratingsTab && !ratingsTab.dataset.listenerAttached) {
      ratingsTab.dataset.listenerAttached = 'true';
      ratingsTab.addEventListener('click', async () => {
        const ratingsContent = document.getElementById("profileRatingsContent");
        if (ratingsContent) {
          try {
            // Use centralized review loading function - single source of truth
            const result = await window.loadUserReviews(user.id, 6, 0);
            const reviews = result.reviews;
            
            const ratingValue = document.getElementById("profileRatingValue");
            const ratingCount = document.getElementById("profileRatingCount");
            const reviewsList = document.getElementById("profileReviewsList");
            
            // Always use backend data (ratingAvg, ratingCount) - single source of truth
            if (ratingValue) {
              ratingValue.textContent = user.ratingAvg ? user.ratingAvg.toFixed(1) : (user.ratingCount > 0 ? '0.0' : '0.0');
            }
            if (ratingCount) {
              const count = user.ratingCount || 0;
              ratingCount.textContent = count === 0 
                ? 'No reviews yet' 
                : `Based on ${count} ${count === 1 ? 'review' : 'reviews'}`;
            }
            
            // Render reviews with limit of 3 initially, then "View more"
            if (reviewsList) {
              const displayLimit = 3;
              const reviewsToShow = reviews.slice(0, displayLimit);
              const hasMore = reviews.length > displayLimit;
              
              reviewsList.innerHTML = '';
              
              if (reviewsToShow.length === 0) {
                reviewsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No reviews yet</div>';
              } else {
                reviewsToShow.forEach(review => {
                  const reviewItem = document.createElement("div");
                  reviewItem.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.75rem;";
                  
                  const reviewerInfo = document.createElement("div");
                  reviewerInfo.style.cssText = "display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;";
                  
                  const reviewerPic = document.createElement("img");
                  reviewerPic.style.cssText = "width: 32px; height: 32px; border-radius: 50%; object-fit: cover;";
                  reviewerPic.src = review.reviewer?.photoUrl || "https://ui-avatars.com/api/?name=" + encodeURIComponent(review.reviewer?.name || "User") + "&background=6366f1&color=fff&size=128";
                  reviewerPic.alt = review.reviewer?.name || "Reviewer";
                  
                  const reviewerName = document.createElement("span");
                  reviewerName.style.cssText = "font-size: 0.9rem; font-weight: 600; color: var(--text-main);";
                  reviewerName.textContent = review.reviewer?.name || "Anonymous";
                  
                  const reviewStars = document.createElement("span");
                  reviewStars.style.cssText = "margin-left: auto; font-size: 0.9rem; color: #fbbf24;";
                  reviewStars.textContent = "★".repeat(review.stars || review.rating || 0);
                  
                  reviewerInfo.appendChild(reviewerPic);
                  reviewerInfo.appendChild(reviewerName);
                  reviewerInfo.appendChild(reviewStars);
                  reviewItem.appendChild(reviewerInfo);
                  
                  // Show review text (comment) - check both 'text' and 'comment' fields
                  const reviewTextContent = review.text || review.comment;
                  if (reviewTextContent) {
                    const reviewText = document.createElement("p");
                    reviewText.style.cssText = "margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--text-main); line-height: 1.5; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;";
                    reviewText.textContent = reviewTextContent;
                    reviewItem.appendChild(reviewText);
                  }
                  
                  reviewsList.appendChild(reviewItem);
                });
                
                if (hasMore || result.hasMore) {
                  const viewMoreBtn = document.createElement("button");
                  viewMoreBtn.className = "btn btn-secondary";
                  viewMoreBtn.textContent = `View more (${result.total - displayLimit} more)`;
                  viewMoreBtn.style.cssText = "width: 100%; padding: 0.75rem; font-size: 0.95rem; margin-top: 0.5rem;";
                  viewMoreBtn.addEventListener("click", async () => {
                    // Load all reviews
                    const allResult = await window.loadUserReviews(user.id, 100, 0);
                    window.renderReviewsList(allResult.reviews, 'profileReviewsList', user.id, 0, allResult.total, false);
                  });
                  reviewsList.appendChild(viewMoreBtn);
                }
              }
            }
          } catch (error) {
            console.error("[REVIEWS] Error loading ratings:", error);
            const reviewsList = document.getElementById("profileReviewsList");
            if (reviewsList) {
              reviewsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading reviews.</div>";
            }
          }
        }
      });
    }
    
    // Populate Jobs tab when clicked - All jobs with pagination
    const jobsTab = document.querySelector('.profile-tab[data-tab="jobs"]');
    if (jobsTab && !jobsTab.dataset.listenerAttached) {
      jobsTab.dataset.listenerAttached = 'true';
      jobsTab.addEventListener('click', async () => {
        loadAllProfileJobs(user, 0);
      });
    }
    
    // Function to load all profile jobs with pagination (10 at a time)
    async function loadAllProfileJobs(user, offset = 0) {
      const jobsList = document.getElementById("profileJobsList");
      if (!jobsList) return;
      
      try {
        if (offset === 0) {
          jobsList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b; font-family: inherit;">Loading...</div>';
        }
        
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/my-jobs`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                  });
        
        if (!response.ok) throw new Error('Failed to fetch jobs');
        const allJobs = await response.json();
        
        // Get all jobs (both as customer and hustler), sorted by most recent
        const jobs = allJobs
          .filter(j => {
            const isCustomer = j.customerId === user.id;
            const isHustler = j.hustlerId === user.id;
            return isCustomer || isHustler;
          })
          .sort((a, b) => new Date(b.createdAt || b.updatedAt || 0) - new Date(a.createdAt || a.updatedAt || 0));
        
        // Get jobs for current page (10 at a time)
        const pageSize = 10;
        const jobsToShow = jobs.slice(offset, offset + pageSize);
        const hasMore = jobs.length > offset + pageSize;
        
        // Clear loading message on first load
        if (offset === 0) {
          jobsList.innerHTML = "";
        }
        
        // Render job cards
        for (const job of jobsToShow) {
          // Determine if user is customer or hustler
          const isCustomer = job.customerId === user.id;
          const isHustler = job.hustlerId === user.id;
          
          // Get the other person's name
          let otherPersonName = 'Unknown';
          if (isCustomer && job.hustler) {
            otherPersonName = job.hustler.name || 'Unknown hustler';
          } else if (isHustler && job.customer) {
            otherPersonName = job.customer.name || 'Unknown customer';
          }
          
          // Calculate price (earned if hustler, paid if customer)
          // Only show price if job is paid/completed
          let price = 0;
          let isWin = false;
          let showPrice = false;
          
          if (job.status === 'PAID' || job.status === 'COMPLETED_BY_HUSTLER' || job.status === 'AWAITING_CUSTOMER_CONFIRM') {
            showPrice = true;
            if (isHustler && job.payment) {
              price = Number(job.payment.amount || job.amount || 0);
              isWin = job.status === 'PAID' || job.status === 'COMPLETED_BY_HUSTLER';
            } else if (isCustomer && job.payment) {
              price = Number(job.payment.total || job.amount || 0);
              isWin = job.status === 'PAID';
            } else {
              price = Number(job.amount || 0);
              isWin = job.status === 'PAID' || job.status === 'COMPLETED_BY_HUSTLER';
            }
          }
          
          const jobCard = document.createElement("div");
          jobCard.style.cssText = "padding: 1rem; background: white; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;";
          if (showPrice) {
            jobCard.style.borderLeft = `4px solid ${isWin ? '#10b981' : '#ef4444'}`;
          }
          jobCard.addEventListener('click', () => {
            if (typeof window.openJobDetails === 'function') {
              window.openJobDetails(job.id);
            }
          });
          jobCard.addEventListener('mouseenter', () => {
            jobCard.style.background = '#f9fafb';
            jobCard.style.transform = 'translateX(2px)';
          });
          jobCard.addEventListener('mouseleave', () => {
            jobCard.style.background = 'white';
            jobCard.style.transform = 'translateX(0)';
          });
          
                jobCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 700; color: #1e293b; font-size: 1rem; margin-bottom: 0.25rem; word-wrap: break-word; line-height: 1.4;">${job.title || 'Untitled Job'}</div>
                <div style="font-size: 0.85rem; color: #64748b; line-height: 1.4;">${isCustomer ? 'Hustler' : 'Customer'}: ${otherPersonName}</div>
                      </div>
              ${showPrice ? `
                <div style="text-align: right; margin-left: 1rem; flex-shrink: 0;">
                  <div style="font-size: 1.1rem; font-weight: 700; color: ${isWin ? '#10b981' : '#ef4444'}; line-height: 1.4;">
                    ${isWin ? '+' : '-'}$${price.toFixed(2)}
                    </div>
                      </div>
                      ` : ''}
                  </div>
                `;
                
          jobsList.appendChild(jobCard);
        }
        
        // Add "Load More" button if there are more jobs
        if (hasMore) {
          // Remove existing load more button if any
          const existingBtn = document.getElementById('profileJobsLoadMore');
          if (existingBtn) {
            existingBtn.remove();
          }
          
          const loadMoreBtn = document.createElement("button");
          loadMoreBtn.id = 'profileJobsLoadMore';
          loadMoreBtn.className = "btn btn-secondary";
          loadMoreBtn.textContent = `Load More (${jobs.length - offset - pageSize} more)`;
          loadMoreBtn.style.cssText = "width: 100%; padding: 0.75rem; font-size: 0.95rem; margin-top: 0.5rem;";
          loadMoreBtn.addEventListener("click", () => {
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = 'Loading...';
            loadAllProfileJobs(user, offset + pageSize);
          });
          jobsList.appendChild(loadMoreBtn);
        } else if (offset === 0 && jobs.length === 0) {
          jobsList.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #64748b; font-family: inherit;">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">📋</div>
              <div>No jobs yet.</div>
                </div>
              `;
        }
        
        jobsList.dataset.loaded = 'true';
          } catch (error) {
        console.error("Error loading profile jobs:", error);
        jobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: #64748b; font-family: inherit;'>Error loading jobs.</div>";
          }
    }
  }, 200);
  
  // Initialize Change Password button
  setTimeout(() => {
    const changePasswordBtn = document.getElementById("changePasswordBtn");
    if (changePasswordBtn) {
      changePasswordBtn.addEventListener("click", () => {
        if (typeof window.showChangePasswordModal === 'function') {
          window.showChangePasswordModal();
        } else {
          showToast('Change password feature is loading...');
        }
        showChangePasswordModal();
      });
    }
    
    // Profile sign out button
    const profileSignOutBtn = document.getElementById("profileSignOutBtn");
    if (profileSignOutBtn) {
      profileSignOutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Profile sign out button clicked');
        // Call handleSignOut directly
        if (window.handleSignOut) {
          window.handleSignOut();
        } else {
          console.error('handleSignOut not available');
        }
      });
    }
    
    // Delete account button
    const deleteAccountBtn = document.getElementById("deleteAccountBtn");
    if (deleteAccountBtn) {
      deleteAccountBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const user = await window.hustlAPI?.auth?.getCurrentUser();
        if (!user) {
          showToast("Please log in to delete your account");
          return;
        }
        
        // Double confirmation
        const confirm1 = confirm(`⚠️ WARNING: This will PERMANENTLY delete your account and ALL associated data:\n\n- All your jobs\n- All your applications\n- All your messages\n- All your reviews\n- All your payment history\n\nThis action CANNOT be undone. You will need to create a new account if you want to use Hustl again.\n\nAre you sure you want to proceed?`);
        if (!confirm1) return;
        
        const confirm2 = prompt(`Type "DELETE MY ACCOUNT" to confirm permanent deletion:`);
        if (confirm2 !== "DELETE MY ACCOUNT") {
          showToast("Account deletion cancelled");
          return;
        }
        
        try {
          const token = localStorage.getItem('hustl_token');
          if (!token) {
            showToast("Please log in to delete your account");
            return;
          }
          
          // Call delete account endpoint
          const response = await fetch(`${API_BASE}/auth/delete-my-account`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to delete account');
          }
          
          showToast("✅ Account deleted successfully");
          
          // Clear local storage and sign out
          localStorage.clear();
          if (window.handleSignOut) {
            window.handleSignOut();
          } else {
            setView('login');
          }
        } catch (error) {
          console.error('Error deleting account:', error);
          showToast(error.message || 'Failed to delete account. Please try again.');
        }
      });
    }
  }, 100);

  // Stripe Connect Content (clear first to prevent duplicates)
  if (stripeContent) {
    stripeContent.innerHTML = ''; // Clear any existing content first
    
    // Check Stripe Connect status - if account ID exists, fetch status from API
    const checkStripeStatus = async () => {
      if (!user.stripeAccountId) {
        // No account ID - show connect button
        stripeContent.innerHTML = `
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
            Connect with Stripe to receive payments directly to your bank. Instant payouts available!
          </p>
          <button class="btn btn-primary" id="stripeConnectBtnInCard" style="width: 100%; background: #22c55e; border: none;">
            💳 Connect Stripe & Start Earning
          </button>
        `;
        attachStripeButtonHandler();
        return;
      }
      
      // Account ID exists - check status from API
      try {
        const token = localStorage.getItem('hustl_token');
        const statusResponse = await fetch(`${API_BASE}/stripe-connect/status`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (statusResponse.ok) {
          const status = await statusResponse.json();
          const payoutsEnabled = status.payoutsEnabled || status.accountDetails?.payoutsEnabled || false;
          console.log('[STRIPE STATUS] Status check result:', { connected: status.connected, payoutsEnabled, accountId: status.accountId });
          if (status.connected && payoutsEnabled) {
            // Fully connected
            stripeContent.innerHTML = `
              <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #dcfce7; border-radius: 8px;">
                <span style="font-size: 1.5rem;">✅</span>
                <div>
                  <div style="font-weight: 600; color: #166534;">Stripe Connected</div>
                  <div style="font-size: 0.85rem; color: #15803d;">You can receive payments instantly!</div>
                </div>
              </div>
            `;
          } else if (status.accountId) {
            // Account exists but not fully onboarded
            stripeContent.innerHTML = `
              <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #fef3c7; border-radius: 8px; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">⏳</span>
                <div>
                  <div style="font-weight: 600; color: #92400e;">Completing Setup...</div>
                  <div style="font-size: 0.85rem; color: #78350f;">Finish connecting your Stripe account to receive payments.</div>
                </div>
              </div>
              <button class="btn btn-primary" id="stripeConnectBtnInCard" style="width: 100%; background: #f59e0b; border: none;">
                💳 Complete Stripe Setup
              </button>
            `;
            attachStripeButtonHandler();
          } else {
            // Show connect button
            stripeContent.innerHTML = `
              <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                Connect with Stripe to receive payments directly to your bank. Instant payouts available!
              </p>
              <button class="btn btn-primary" id="stripeConnectBtnInCard" style="width: 100%; background: #22c55e; border: none;">
                💳 Connect Stripe & Start Earning
              </button>
            `;
            attachStripeButtonHandler();
          }
        } else {
          // API error - assume connected if account ID exists
          if (user.stripeAccountId) {
            stripeContent.innerHTML = `
              <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #dcfce7; border-radius: 8px;">
                <span style="font-size: 1.5rem;">✅</span>
                <div>
                  <div style="font-weight: 600; color: #166534;">Stripe Connected</div>
                  <div style="font-size: 0.85rem; color: #15803d;">You can receive payments instantly!</div>
                </div>
              </div>
            `;
          } else {
            stripeContent.innerHTML = `
              <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
                Connect with Stripe to receive payments directly to your bank. Instant payouts available!
              </p>
              <button class="btn btn-primary" id="stripeConnectBtnInCard" style="width: 100%; background: #22c55e; border: none;">
                💳 Connect Stripe & Start Earning
              </button>
            `;
            attachStripeButtonHandler();
          }
        }
      } catch (error) {
        console.error('Error checking Stripe status:', error);
        // Fallback: if account ID exists, assume connected
        if (user.stripeAccountId) {
          stripeContent.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #dcfce7; border-radius: 8px;">
              <span style="font-size: 1.5rem;">✅</span>
              <div>
                <div style="font-weight: 600; color: #166534;">Stripe Connected</div>
                <div style="font-size: 0.85rem; color: #15803d;">You can receive payments instantly!</div>
              </div>
            </div>
          `;
        } else {
          stripeContent.innerHTML = `
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
              Connect with Stripe to receive payments directly to your bank. Instant payouts available!
            </p>
            <button class="btn btn-primary" id="stripeConnectBtnInCard" style="width: 100%; background: #22c55e; border: none;">
              💳 Connect Stripe & Start Earning
            </button>
          `;
          attachStripeButtonHandler();
        }
      }
    };
    
    // Helper function to attach button handler
    const attachStripeButtonHandler = () => {
      setTimeout(() => {
        const stripeBtn = document.getElementById("stripeConnectBtnInCard");
        if (stripeBtn) {
          stripeBtn.addEventListener("click", async () => {
            stripeBtn.disabled = true;
            stripeBtn.textContent = "Connecting...";
            
            try {
              const token = localStorage.getItem("hustl_token");
              if (!token) {
                showToast("Please log in to connect Stripe.");
                stripeBtn.disabled = false;
                stripeBtn.textContent = "💳 Connect Stripe & Start Earning";
                return;
              }
              
              // First create account if needed
              await fetch(`${API_BASE}/stripe-connect/create-account`, {
                method: "POST",
                headers: { 
                  "Authorization": "Bearer " + token,
                  "Content-Type": "application/json"
                }
              });
              
              // Then get onboarding link
              const linkResponse = await fetch(`${API_BASE}/stripe-connect/onboarding-link`, {
                method: "POST",
                headers: { 
                  "Authorization": "Bearer " + token,
                  "Content-Type": "application/json"
                }
              });
              
              if (linkResponse.ok) {
                const { url } = await linkResponse.json();
                window.location.href = url;
              } else {
                const error = await linkResponse.json();
                throw new Error(error.message || "Failed to get Stripe link");
              }
            } catch (error) {
              console.error("Error connecting Stripe:", error);
              showToast(error.message || "Failed to connect Stripe. Please try again.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "💳 Connect Stripe & Start Earning";
            }
          });
        }
      }, 100);
    };
    
    // Check Stripe status
    checkStripeStatus();
  }

  // Old duplicate profile form removed - using Basic Info section at top with Edit Profile button
  // All profile editing is handled through renderBasicInfoEdit function

  // ----- RIGHT SIDE: JOBS -----
  // jobsList might not exist if we're on Settings tab, that's OK
  if (jobsList) {
    jobsList.innerHTML = "";

  // A) Jobs you posted
  const postedHeader = document.createElement("div");
  postedHeader.className = "section-title";
  postedHeader.textContent = "Jobs you posted";
  jobsList.appendChild(postedHeader);

  const myPostedJobs = state.jobs.filter((j) => j.postedByUserId === user.id);
  if (myPostedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven’t posted any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myPostedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You posted this · " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // B) Jobs you're doing as a Hustler
  const doingHeader = document.createElement("div");
  doingHeader.className = "section-title";
  doingHeader.style.marginTop = "0.8rem";
  doingHeader.textContent = "Jobs you’re doing as a Hustler";
  jobsList.appendChild(doingHeader);

  const myHustlerJobs = state.jobs.filter(
    (j) => j.acceptedHustlerId === user.id
  );

  if (myHustlerJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven’t been accepted on any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myHustlerJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You’re the Hustler · " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // C) Jobs you've applied for
  const appliedHeader = document.createElement("div");
  appliedHeader.className = "section-title";
  appliedHeader.style.marginTop = "0.8rem";
  appliedHeader.textContent = "Jobs you’ve applied for";
  jobsList.appendChild(appliedHeader);

  const myAppliedJobs = state.jobs.filter((j) =>
    (j.applicants || []).some((a) => a.userId === user.id)
  );

  if (myAppliedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven’t applied for any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myAppliedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent =
        "You applied · " +
        timeAgo(job.createdAt) +
        (job.acceptedHustlerId === user.id
          ? " · (accepted)"
          : job.status === "assigned"
          ? " · (assigned to someone else)"
          : "");
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }
  }

  // Image compression function
  function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          // Calculate new dimensions
          if (width > height) {
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to base64 with compression
          const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(compressedDataUrl);
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Old duplicate form handlers removed - all profile editing is handled through Basic Info edit mode
  // (basicInfoPhotoUpload, basicInfoBio, basicInfoGender, basicInfoSaveBtn, etc.)
  
  // Tools save/edit handler
  setTimeout(() => {
    const saveToolsBtn = document.getElementById("saveToolsButton");
    const toolsInput = document.getElementById("profileToolsInput");
    if (saveToolsBtn && toolsInput) {
      saveToolsBtn.addEventListener("click", async () => {
        // If button says "Edit Tools", make field editable
        if (saveToolsBtn.textContent === "Edit Tools") {
          toolsInput.removeAttribute('readonly');
          toolsInput.style.background = 'white';
          toolsInput.style.cursor = 'text';
          saveToolsBtn.textContent = "Save Tools";
          toolsInput.focus();
          return;
        }
        
        // Otherwise, save the tools
        const tools = toolsInput.value.trim();
        saveToolsBtn.disabled = true;
        saveToolsBtn.textContent = "Saving...";
        try {
          await window.hustlAPI.users.updateProfile({ tools });
          const storedUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
          storedUser.tools = tools;
          localStorage.setItem('hustl_user', JSON.stringify(storedUser));
          
          // Make field read-only and change button to "Edit Tools"
          toolsInput.setAttribute('readonly', 'readonly');
          toolsInput.style.background = 'var(--bg-light)';
          toolsInput.style.cursor = 'default';
          saveToolsBtn.textContent = "Saved";
          saveToolsBtn.style.background = "#16a34a";
          setTimeout(() => {
            saveToolsBtn.textContent = "Edit Tools";
            saveToolsBtn.style.background = "";
            saveToolsBtn.disabled = false;
          }, 2000);
          showToast("✅ Tools updated!");
        } catch (error) {
          saveToolsBtn.textContent = "Save Tools";
          saveToolsBtn.disabled = false;
          showToast("Failed to save tools.");
        }
      });
    }
  }, 100);
// Manual payout options removed - Stripe only

  // hook up "View active jobs"
  const activeLink = document.getElementById("activeJobsLink");
  if (activeLink) {
    activeLink.addEventListener("click", () => {
      setView("jobs");
      activeJobsStatusFilter = "open";
      renderJobs(true); // Reset pagination when filter changes
    });
  }
}

    /* ---------- Feedback ---------- */

    function initFeedback() {
      // Handle old feedback button if it exists
      const btn = document.getElementById("feedbackButton");
      if (btn) {
      btn.addEventListener("click", () => {
          const name = document.getElementById("feedbackName")?.value.trim() || '';
          const email = document.getElementById("feedbackEmail")?.value.trim() || '';
          const message = document.getElementById("feedbackMessage")?.value.trim() || '';
        if (!message) {
          showToast("Please type a bit of feedback first.");
          return;
        }
          if (state && state.feedback) {
        state.feedback.push({
          id: generateId("f"),
          name,
          email,
          message,
          createdAt: Date.now(),
        });
        saveState();
          }
          if (document.getElementById("feedbackMessage")) {
        document.getElementById("feedbackMessage").value = "";
          }
        showToast("Feedback saved (demo). In a live app this would email Hustl.");
      });
      }
      
      // Handle new feedback form in About view
      const feedbackForm = document.getElementById("feedbackForm");
      if (feedbackForm) {
        feedbackForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("feedbackEmail")?.value.trim() || '';
          const message = document.getElementById("feedbackMessage")?.value.trim() || '';
          
          if (!message) {
            showToast("Please type a bit of feedback first.");
            return;
          }
          
          // Try to send feedback via API if available
          try {
            const token = localStorage.getItem('hustl_token');
            const response = await fetch(`${API_BASE}/feedback`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify({ email, message })
            });
            
            if (response.ok) {
              showToast("✅ Thank you for your feedback! We'll review it soon.");
              feedbackForm.reset();
            } else {
              throw new Error('Failed to send feedback');
            }
          } catch (error) {
            // Fallback to local storage if API fails
            console.log("Feedback API not available, saving locally:", error);
            if (state && state.feedback) {
              state.feedback.push({
                id: generateId("f"),
                email,
                message,
                createdAt: Date.now(),
              });
              saveState();
            }
            showToast("✅ Thank you for your feedback! We'll review it soon.");
            feedbackForm.reset();
          }
        });
      }
    }

   /* ---------- Footer links ---------- */

function initFooterLinks() {
  document
    .getElementById("footerTermsLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });

  document
    .getElementById("footerPrivacyLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });
}

   /* ---------- Public profile popup ---------- */
// Standardized profile function - redirects to showHustlerProfilePopup
// This ensures all profile views use the same standardized popup from Browse Jobs
async function openUserProfile(userId) {
  // Use the standardized profile popup (same one used in Browse Jobs)
  if (typeof window.showHustlerProfilePopup === 'function') {
    window.showHustlerProfilePopup(userId);
        return;
  }
  
  // Fallback if showHustlerProfilePopup doesn't exist
  showToast("Profile view not available.");
    return;
}


    /* ---------- Owner view ---------- */

    function renderOwnerView() {
      const user = getCurrentUser();
      const tab = document.getElementById("ownerTab");
      const view = document.getElementById("view-owner");
      const paidList = document.getElementById("ownerPaidList");
      const assignedList = document.getElementById("ownerAssignedList");

      const isOwner = !!(user && user.email && user.email.toLowerCase() === "team.hustlapp@outlook.com");
      if (tab) tab.style.display = isOwner ? "" : "none";
      if (!isOwner) {
        if (view) view.style.display = "none";
        return;
      }

      // Paid jobs
      const paidJobs = state.jobs.filter(j => j.paymentStatus === "paid");
      if (paidList) {
        paidList.innerHTML = "";
        if (paidJobs.length === 0) {
          paidList.innerHTML = "<div class='muted'>No paid jobs yet.</div>";
        } else {
          paidJobs.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
           const custUser = state.users.find(u => u.id === j.postedByUserId);
const hustUser = state.users.find(u => u.id === j.acceptedHustlerId);
const cust = custUser?.name || "Customer";
const hust = hustUser?.name || "Hustler";

let payoutInfo = "";
if (hustUser && hustUser.payoutMethod && hustUser.payoutHandle) {
  const label =
    hustUser.payoutMethod === "venmo" ? "Venmo" :
    hustUser.payoutMethod === "cashapp" ? "Cash App" :
    hustUser.payoutMethod === "zelle" ? "Zelle" : "Payout";
  payoutInfo = ` · ${label}: ${hustUser.payoutHandle}`;
}

meta.textContent =
  `Paid ${formatMoney(j.chargedAmount || 0)} · Your fee ${formatMoney(j.platformFeeAmount || 0)} · ${cust} → ${hust}${payoutInfo}`;
            row.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "job-card-actions";

            const left = document.createElement("div");
            const payoutBadge = document.createElement("span");
            payoutBadge.className = "badge";
            if (j.adminPayoutDone) {
              payoutBadge.classList.add("status-completed");
              payoutBadge.textContent = "Payout marked done";
            } else {
              payoutBadge.classList.add("status-assigned");
              payoutBadge.textContent = "Payout pending";
            }
            left.appendChild(payoutBadge);

            const right = document.createElement("div");
            const markBtn = document.createElement("button");
            markBtn.className = "small-btn";
            markBtn.textContent = j.adminPayoutDone ? "Unmark payout" : "Mark payout done";
            markBtn.addEventListener("click", () => {
              j.adminPayoutDone = !j.adminPayoutDone;
              saveState();
              showToast(j.adminPayoutDone ? "Marked payout done." : "Payout unmarked.");
              renderOwnerView();
            });
            right.appendChild(markBtn);

            actions.appendChild(left);
            actions.appendChild(right);
            row.appendChild(actions);

            paidList.appendChild(row);
          });
        }
      }

      // Assigned but not paid
      const assigned = state.jobs.filter(j => j.status === "assigned" && j.paymentStatus !== "paid");
      if (assignedList) {
        assignedList.innerHTML = "";
        if (assigned.length === 0) {
          assignedList.innerHTML = "<div class='muted'>No assigned-but-unpaid jobs.</div>";
        } else {
          assigned.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
            const cust = state.users.find(u => u.id === j.postedByUserId)?.name || "Customer";
            const hust = state.users.find(u => u.id === j.acceptedHustlerId)?.name || "Hustler";
            meta.textContent = `Assigned · ${cust} ↔ ${hust} · posted ${timeAgo(j.createdAt)}`;
            row.appendChild(meta);

            assignedList.appendChild(row);
          });
        }
      }
    }

    /* ---------- Main render ---------- */

    async function renderAll() {
      console.log("🔵 renderAll called");
      // Update header auth state first
      await updateHeaderAuth();
      
      renderAuthPill();
      renderAuthSectionVisibility();
      renderOwnerView();

      // CRITICAL: Use window.activeView if it's set (from fallback), otherwise use local activeView
      // This ensures fallback code can properly set the view
      const currentView = window.activeView || activeView || "home";
      // Also update local activeView to keep them in sync
      if (window.activeView && window.activeView !== activeView) {
        activeView = window.activeView;
      }
      console.log("🔵 renderAll - activeView:", activeView, "window.activeView:", window.activeView, "currentView:", currentView);
      
      if (currentView === "jobs") {
        console.log("🔵 Rendering jobs view");
        renderJobs();
        startBackgroundPolling(); // Start polling for jobs
      } else if (currentView === "messages") {
        console.log("🔵 Rendering messages view");
        try {
          await renderMessagesView();
          // Start polling when messages view is rendered
          startMessagePolling();
          startBackgroundPolling(); // Also start general polling
        } catch (err) {
          console.error("Error rendering messages:", err);
        }
      } else if (currentView === "profile") {
        console.log("🔵 Rendering profile view");
        renderProfile();
        stopMessagePolling(); // Stop polling when leaving messages view
        stopBackgroundPolling(); // Stop background polling
      } else if (currentView === "manage-jobs") {
        console.log("🔵 Rendering manage-jobs view - calling renderManageJobs");
        renderManageJobs();
        stopMessagePolling(); // Stop polling when leaving messages view
        startBackgroundPolling(); // Start polling for manage jobs
      } else if (currentView === "owner") {
        console.log("🔵 Rendering owner view");
        renderOwnerView();
        stopMessagePolling(); // Stop polling when leaving messages view
        stopBackgroundPolling(); // Stop background polling
      } else if (currentView === "home") {
        console.log("🔵 Rendering home view (no special rendering needed)");
        // Home view doesn't need special rendering - it's the default
        stopMessagePolling(); // Stop polling when leaving messages view
        stopBackgroundPolling(); // Stop background polling
      } else if (currentView === "post") {
        console.log("🔵 Rendering post view");
        stopMessagePolling();
        stopBackgroundPolling(); // Don't poll on post job form
        
        // Clear form when entering post view (refresh form)
        const jobForm = document.getElementById('jobForm');
        if (jobForm) {
          jobForm.reset();
          // Also clear any custom fields
          const titleInput = document.getElementById('jobTitle');
          const descriptionInput = document.getElementById('jobDescription');
          const amountInput = document.getElementById('jobAmount');
          if (titleInput) titleInput.value = '';
          if (descriptionInput) descriptionInput.value = '';
          if (amountInput) amountInput.value = '';
        }
        
        // Hide job stats card when entering post view
        const statsCard = document.getElementById('jobStatsCard');
        if (statsCard) {
          statsCard.style.display = 'none';
        }
      } else {
        console.log("⚠️ renderAll - unknown view:", currentView);
        stopMessagePolling(); // Stop polling when leaving messages view
        stopBackgroundPolling(); // Stop background polling
      }
      
      // Unread message count - function not implemented yet
      // countUnreadMessages();
    }
    
    // Expose renderAll and renderProfile on window for fallback access
    window.renderAll = renderAll;
    window.renderProfile = renderProfile;
    window.showProfilePhotoLightbox = showProfilePhotoLightbox;
    
    // Render Manage Jobs View - Professional job management interface
    async function renderManageJobs() {
      console.log("🔵 renderManageJobs called");
      
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user) {
        console.warn("No user found in renderManageJobs");
        showToast("Please log in to manage jobs.");
        setView('home');
        return;
      }
      
      console.log("✅ User authenticated:", user.id);
      
      // Show/hide tabs based on user role
      const hasHustlerRole = (user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'HUSTLER')) || 
                             (user.role && user.role.toUpperCase() === 'HUSTLER') ||
                             (user.isHustler === true);
      const appliedTab = document.getElementById('appliedJobsTab');
      if (appliedTab) {
        appliedTab.style.display = hasHustlerRole ? '' : 'none';
        console.log("🔵 Applied tab visibility:", hasHustlerRole ? 'visible' : 'hidden', 'user roles:', user.roles, 'user.role:', user.role, 'user.isHustler:', user.isHustler);
      }
      
      // Initialize tabs - use setTimeout to ensure DOM is ready
      setTimeout(() => {
        const manageTabs = document.querySelectorAll('[data-manage-tab]');
        console.log("Found manage tabs:", manageTabs.length);
        
        if (manageTabs.length === 0) {
          console.warn("Manage tabs not found, retrying...");
          setTimeout(() => renderManageJobs(), 100);
          return;
        }
        
        manageTabs.forEach(tab => {
          // Remove old listener if exists
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          // Get fresh reference
          const freshTab = document.querySelector(`[data-manage-tab="${newTab.dataset.manageTab}"]`);
          if (!freshTab) return;
          
          freshTab.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Remove active from all tabs
            document.querySelectorAll('[data-manage-tab]').forEach(t => {
              t.classList.remove('active');
              const indicator = t.querySelector('.tab-indicator');
              if (indicator) indicator.style.display = 'none';
            });
            
            // Add active to clicked tab
            freshTab.classList.add('active');
            const indicator = freshTab.querySelector('.tab-indicator');
            if (indicator) indicator.style.display = 'block';
            
            // Hide all tab content
            document.querySelectorAll('#manageTabPosted, #manageTabActive, #manageTabCompleted, #manageTabApplied').forEach(content => {
              content.style.display = 'none';
              content.classList.remove('active');
            });
            
            // Show selected tab content
            const tabName = freshTab.dataset.manageTab;
            let tabContentId = '';
            if (tabName === 'posted') {
              tabContentId = 'manageTabPosted';
            } else if (tabName === 'active') {
              tabContentId = 'manageTabActive';
            } else if (tabName === 'completed') {
              tabContentId = 'manageTabCompleted';
            } else if (tabName === 'applied') {
              tabContentId = 'manageTabApplied';
            }
            
            const tabContent = document.getElementById(tabContentId);
            if (tabContent) {
              tabContent.style.display = 'block';
              tabContent.classList.add('active');
              
              // Load content for that tab
              console.log("🔵 Tab content loading for:", tabName);
              if (tabName === 'posted') {
                console.log("🔵 Calling loadPostedJobs");
                loadPostedJobs();
              } else if (tabName === 'active') {
                console.log("🔵 Calling loadActiveJobs");
                loadActiveJobs();
              } else if (tabName === 'completed') {
                console.log("🔵 Calling loadCompletedJobs with reset=true");
                if (typeof loadCompletedJobs === 'function') {
                  loadCompletedJobs(true);
                } else {
                  console.error("❌ loadCompletedJobs function not found!");
                }
              } else if (tabName === 'applied') {
                console.log("🔵 Calling loadAppliedJobs");
                loadAppliedJobs();
              }
            }
          });
        });
      }, 100);
      
      // Load initial tab (Posted Jobs)
      setTimeout(() => {
        console.log("🔵 Loading initial tab (Posted Jobs)");
        const postedTab = document.getElementById('manageTabPosted');
        const postedList = document.getElementById('managePostedJobsList');
        console.log("Posted tab element:", postedTab ? "found" : "NOT FOUND");
        console.log("Posted list element:", postedList ? "found" : "NOT FOUND");
        
        if (postedList) {
          loadPostedJobs();
        } else {
          console.error("❌ managePostedJobsList element not found in DOM");
          // Retry after a bit more time
          setTimeout(() => {
            const retryList = document.getElementById('managePostedJobsList');
            if (retryList) {
              console.log("✅ Found on retry, loading...");
              loadPostedJobs();
            } else {
              console.error("❌ Still not found after retry");
            }
          }, 500);
        }
      }, 200);
    }
    
    // Load Posted Jobs - Professional Dashboard Cards
    async function loadPostedJobs() {
      console.log("🔵 loadPostedJobs called");
      
      const postedJobsList = document.getElementById("managePostedJobsList");
      
      // Prevent duplicate calls
      if (postedJobsList && postedJobsList.dataset.loading === 'true') {
        console.log("⏸️ loadPostedJobs already in progress, skipping");
        return;
      }
      
      if (postedJobsList) {
        postedJobsList.dataset.loading = 'true';
      }
      if (!postedJobsList) {
        console.error("❌ managePostedJobsList element not found in DOM");
        // Try to find it again
        setTimeout(() => {
          const retry = document.getElementById("managePostedJobsList");
          if (retry) {
            console.log("✅ Found on retry, calling loadPostedJobs again");
            loadPostedJobs();
          } else {
            console.error("❌ Still not found after retry - DOM may not be ready");
          }
        }, 100);
        return;
      }
      
      console.log("✅ managePostedJobsList element found");
      
      // Show loading state
      postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading...</div>";
      postedJobsList.dataset.loaded = 'false';
      
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          console.warn("No user found");
          postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your jobs.</div>";
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          console.warn("No token found");
          postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your jobs.</div>";
          return;
        }
        
        console.log("🔵 Loading posted jobs for user:", user.id);
        console.log("🔵 API_BASE:", API_BASE);
        console.log("🔵 Endpoint:", `${API_BASE}/jobs/user-posted`);
        
        // Use the dedicated endpoint for posted jobs with retry
        const jobs = await safeFetch(`${API_BASE}/jobs/user-posted`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Ensure jobs is an array
        if (!jobs || !Array.isArray(jobs)) {
          console.warn("❌ Failed to fetch jobs or invalid response");
          postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Failed to load jobs. Please try again.</div>";
          return;
        }
        
        console.log("✅ Fetched posted jobs:", jobs.length, "jobs");
        if (jobs.length > 0) {
          console.log("✅ Sample job:", {
            id: jobs[0].id,
            title: jobs[0].title,
            customerId: jobs[0].customerId,
            status: jobs[0].status,
            category: jobs[0].category
          });
        }
        
        // Filter out jobs that should not appear in "Posted Jobs":
        // - ASSIGNED or SCHEDULED jobs (they should only appear in "Active Jobs")
        // - CANCELLED jobs (deleted as a whole)
        // - PAID or completed jobs (they should appear in "Completed Jobs")
        // - EXPIRED jobs (removed from browse and posted jobs)
        const now = new Date();
        const postedJobs = jobs.filter(job => {
          // Exclude cancelled jobs (deleted as a whole)
          if (job.status === 'CANCELLED') return false;
          
          // Exclude expired jobs
          if (job.status === 'EXPIRED') return false;
          
          // Also check if expiresAt has passed (even if status is still OPEN)
          if (job.expiresAt) {
            const expirationDate = new Date(job.expiresAt);
            if (expirationDate <= now) return false; // Expired
          } else if (job.requirements?.expiresAt) {
            try {
              const expirationDate = new Date(job.requirements.expiresAt);
              if (expirationDate <= now) return false; // Expired
            } catch (e) {
              // Invalid date, continue
            }
          }
          
          // Exclude assigned or scheduled jobs (they go to Active Jobs tab)
          if (job.status === 'ASSIGNED' || job.status === 'SCHEDULED') return false;
          
          // Exclude paid or completed jobs (they go to Completed Jobs tab)
          if (job.status === 'PAID') return false;
          if (job.status === 'COMPLETED_BY_HUSTLER' && job.completionCodeVerified) return false;
          
          // Only show OPEN, REQUESTED, or IN_PROGRESS jobs in Posted Jobs
          // (IN_PROGRESS can stay here if needed, or move to Active - but let's keep it for now)
          return true;
        });
        
        if (postedJobs.length === 0) {
          postedJobsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No posted jobs yet</div>
              <div style="color: var(--text-muted); margin-bottom: 1.5rem;">Post your first job to get started!</div>
              <button class="btn btn-primary" onclick="setView('post')" style="padding: 0.75rem 1.5rem;">Post Your First Job</button>
            </div>
          `;
          postedJobsList.dataset.loaded = 'true';
        } else {
          postedJobsList.innerHTML = "";
          for (const job of postedJobs) {
            // Fetch offer count
            let offerCount = 0;
            let pendingOffers = [];
            try {
              const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
              });
              if (offersResponse.ok) {
                const offers = await offersResponse.json();
                pendingOffers = offers.filter(o => o.status === 'PENDING');
                offerCount = pendingOffers.length;
              }
            } catch (e) {
              console.error("Error fetching offers:", e);
            }
            
            // Get requirements for additional fields
            const requirements = job.requirements || {};
            const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
            const rawTeamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
            const teamSize = typeof rawTeamSize === 'string' ? parseInt(rawTeamSize, 10) : Number(rawTeamSize) || 1;
            const keepActiveFor = requirements.keepActiveFor;
            const expiresAt = requirements.expiresAt ? new Date(requirements.expiresAt) : null;
            const pricingOption = requirements.pricing_option;
            
            // Format location (pickup/dropoff)
            const pickupArea = requirements.pickup_area || requirements.pickupArea;
            const pickupCity = requirements.pickup_city || requirements.pickupCity;
            const pickupZip = requirements.pickup_zip;
            const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
            const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
            const dropoffZip = requirements.dropoff_zip;
            const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
            
            let locationDisplay = job.address || 'Location not specified';
            if (pickupArea || pickupCity) {
              const pickupParts = [];
              if (pickupArea) pickupParts.push(pickupArea);
              if (pickupCity) pickupParts.push(pickupCity);
              if (pickupZip) pickupParts.push(pickupZip);
              locationDisplay = pickupParts.join(', ');
              
              if (!onSiteOnly && (dropoffArea || dropoffCity)) {
                const dropoffParts = [];
                if (dropoffArea) dropoffParts.push(dropoffArea);
                if (dropoffCity) dropoffParts.push(dropoffCity);
                if (dropoffZip) dropoffParts.push(dropoffZip);
                locationDisplay += ` → ${dropoffParts.join(', ')}`;
              } else if (onSiteOnly) {
                locationDisplay += ' (Single location)';
              }
            }
            const shortLocation = locationDisplay.length > 50 ? locationDisplay.substring(0, 50) + '...' : locationDisplay;
            
            // Format timing
            let timingDisplay = '';
            if (deadlinePreference === 'until_completed') {
              timingDisplay = 'Until completed';
            } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
              timingDisplay = 'Flexible this week';
            } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
              timingDisplay = 'Today – ASAP';
            } else if (deadlinePreference === 'tomorrow') {
              timingDisplay = 'Tomorrow';
            } else if (job.startTime) {
              const deadlineDate = new Date(job.startTime);
              timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
              timingDisplay = 'Not specified';
            }
            
            // Format pay
            const payType = job.payType || 'flat';
            let payDisplay = '';
            if (pricingOption === 'hustlers_quote') {
              payDisplay = 'Hustler suggests price';
            } else if (payType === 'hourly') {
              const hourlyRate = parseFloat(job.hourlyRate || 0);
              if (teamSize > 1) {
                const perPersonRate = hourlyRate / teamSize;
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs) · ${teamSize} workers → $${perPersonRate.toFixed(0)}/hr each`;
              } else {
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs)`;
              }
            } else {
              payDisplay = `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
            }
            
            // Format workers
            let workersDisplay = '';
            if (teamSize === 0) {
              workersDisplay = 'Company/crew';
            } else if (teamSize === 1) {
              workersDisplay = '1 worker';
            } else {
              workersDisplay = `${teamSize} workers`;
            }
            
            // Format expiration - check if keepOpenUntilAccepted is enabled
            const isKeepOpenEnabled = requirements.keepOpenUntilAccepted === true;
            let expirationDisplay = '';
            if (isKeepOpenEnabled) {
              expirationDisplay = 'Stays open until hustler assigned';
            } else if (expiresAt && expiresAt > new Date()) {
              const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
              expirationDisplay = `Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}`;
            } else if (expiresAt && expiresAt <= new Date()) {
              expirationDisplay = 'Expired — Repost?';
            }
            
            // Posted date
            const postedDate = new Date(job.createdAt);
            const daysAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60 * 24));
            const postedText = daysAgo === 0 ? 'Posted today' : daysAgo === 1 ? 'Posted 1 day ago' : `Posted ${daysAgo} days ago`;
            
            const jobCard = document.createElement("div");
            jobCard.style.cssText = "padding: 0; border: 2px solid var(--border); border-radius: 16px; background: #f5f5f5; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s; overflow: hidden;";
            jobCard.onmouseenter = () => { 
              jobCard.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
              jobCard.style.transform = 'translateY(-2px)';
              jobCard.style.borderColor = 'var(--primary)';
            };
            jobCard.onmouseleave = () => { 
              jobCard.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
              jobCard.style.transform = 'translateY(0)';
              jobCard.style.borderColor = 'var(--border)';
            };
            
            // Get category icon - handle both display names and API values
            const categoryMap = {
              'Moving / Hauling': '🚚',
              'moving': '🚚',
              'Yard work / Outdoor': '🌿',
              'yard-work': '🌿',
              'yard': '🌿',
              'Cleaning / Organizing': '🧹',
              'cleaning': '🧹',
              'Furniture / Assembly': '🛠',
              'furniture-assembly': '🛠',
              'furniture': '🛠',
              'Other': '⭐',
              'other': '⭐'
            };
            const categoryIcon = categoryMap[job.category] || '📋';
            
            // Normalize category name for display
            const categoryDisplayNames = {
              'moving': 'Moving / Hauling',
              'yard-work': 'Yard work / Outdoor',
              'yard': 'Yard work / Outdoor',
              'cleaning': 'Cleaning / Organizing',
              'furniture-assembly': 'Furniture / Assembly',
              'furniture': 'Furniture / Assembly',
              'other': 'Other'
            };
            let categoryDisplay = categoryDisplayNames[job.category] || job.category || 'General';
            // Ensure first letter is capitalized if it's a fallback value
            if (categoryDisplay && categoryDisplay.length > 0 && !categoryDisplayNames[job.category]) {
              categoryDisplay = categoryDisplay.charAt(0).toUpperCase() + categoryDisplay.slice(1);
            }
            
            // Status badge with better styling
            let statusBadge = '';
            let statusColor = '#6b7280';
            if (job.status === 'OPEN') {
              statusBadge = 'Open for Applications';
              statusColor = '#10b981';
            } else if (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'REQUESTED') {
              // SCHEDULED/ASSIGNED = Hustler accepted, waiting for start code (not active yet)
              statusBadge = job.status === 'SCHEDULED' ? 'Scheduled' : (job.status === 'ASSIGNED' ? 'Assigned' : 'Hustler Assigned');
              statusColor = job.status === 'SCHEDULED' ? '#f59e0b' : '#3b82f6';
            } else if (job.status === 'IN_PROGRESS') {
              // IN_PROGRESS = Start code entered, job actively being worked on
              statusBadge = 'In Progress';
              statusColor = '#7c3aed';
            } else if (job.status === 'COMPLETED_BY_HUSTLER') {
              statusBadge = 'Awaiting Completion';
              statusColor = '#f59e0b';
            }
            
            // Calculate hours/minutes since posted for better time display
            const hoursAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60));
            const minutesAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60));
            let timeAgo = '';
            if (minutesAgo < 60) {
              timeAgo = minutesAgo < 1 ? 'Just now' : `${minutesAgo} ${minutesAgo === 1 ? 'minute' : 'minutes'} ago`;
            } else if (hoursAgo < 24) {
              timeAgo = `${hoursAgo} ${hoursAgo === 1 ? 'hour' : 'hours'} ago`;
            } else {
              timeAgo = postedText;
            }
            
            // Check for pending price proposal (for customer view)
            let priceProposalBadge = '';
            if (job.requirements?.proposedPriceChange && job.requirements.proposedPriceChange.status === 'PENDING') {
              priceProposalBadge = `
                <div style="padding: 0.5rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24; margin-bottom: 0.75rem; text-align: center;">
                  <div style="font-size: 0.85rem; font-weight: 600; color: #92400e;">💰 Price Change Proposal Pending</div>
                </div>
              `;
            }
            
            // Detect mobile for simpler card layout
            const isMobile = window.innerWidth <= 768;
            
            jobCard.innerHTML = isMobile ? `
              <!-- Mobile: Simple Card -->
              <div style="padding: 1rem; background: #f5f5f5;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); line-height: 1.3;">${job.title || 'Untitled Job'}</h3>
                <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">💰 ${payDisplay.length > 40 ? payDisplay.substring(0, 40) + '...' : payDisplay}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">${categoryDisplay}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">📅 ${timeAgo}</div>
                ${priceProposalBadge}
                ${offerCount > 0 ? `
                <div style="padding: 1.25rem; background: #f0fdf4; border-radius: 8px; border: 1px solid #10b98140; text-align: center; margin-bottom: 0.75rem;">
                  <div style="font-size: 2.5rem; font-weight: 700; color: #059669; line-height: 1; margin-bottom: 0.25rem;">${offerCount}</div>
                  <div style="font-size: 0.9rem; color: #047857; font-weight: 600;">${offerCount === 1 ? 'Applicant' : 'Applicants'}</div>
                    </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.75rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px;">
                    View Applicants
                    </button>
                  ${(job.status === 'OPEN' || ((job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified)) ? `
                  <button class="btn btn-ghost cancelJobBtn" data-job-id="${job.id}" style="padding: 0.75rem; font-weight: 600; border-radius: 8px; color: #dc2626; border-color: #fecaca; font-size: 0.9rem; min-width: 48px;">🗑️</button>
                  ` : ''}
                </div>
                ` : `
                <div style="padding: 1.25rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fbbf2440; text-align: center; margin-bottom: 0.75rem;">
                  <div style="font-size: 2rem; margin-bottom: 0.25rem;">👤</div>
                  <div style="font-weight: 600; color: #92400e; margin-bottom: 0.15rem; font-size: 0.9rem;">No applicants yet</div>
                  <div style="font-size: 0.75rem; color: #78350f;">Share your job to get more applicants!</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.75rem; font-size: 0.9rem; font-weight: 600; border-radius: 8px;">
                    View Details
                  </button>
                  ${(job.status === 'OPEN' || ((job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified)) ? `
                  <button class="btn btn-ghost cancelJobBtn" data-job-id="${job.id}" style="padding: 0.75rem; font-weight: 600; border-radius: 8px; color: #dc2626; border-color: #fecaca; font-size: 0.9rem; min-width: 48px;">🗑️</button>
                  ` : ''}
                </div>
                `}
              </div>
            ` : `
              <!-- Desktop: Full Card -->
              <div style="padding: 1.5rem; background: #f0f0f0; border-bottom: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      <span style="font-size: 2rem;">${categoryIcon}</span>
                      <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main); line-height: 1.2;">${job.title || 'Untitled Job'}</h3>
                        <div style="margin-top: 0.25rem; font-size: 0.9rem; color: var(--text-muted);">${categoryDisplay}</div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem;">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-weight: 700; color: var(--text-main);">💰</span>
                        <span style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">${payDisplay}</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>⏰</span>
                        <span style="color: var(--text-muted);">${timingDisplay}</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>👥</span>
                        <span style="color: var(--text-muted);">${workersDisplay}</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>📍</span>
                        <span style="color: var(--text-muted);">${shortLocation}</span>
                      </div>
                      ${expirationDisplay ? `
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>⏳</span>
                        <span style="color: ${isKeepOpenEnabled ? '#1e40af' : (expiresAt && expiresAt <= new Date() ? '#dc2626' : '#d97706')}; font-weight: 600;">${expirationDisplay}</span>
                      </div>
                      ` : ''}
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>📅</span>
                        <span style="color: var(--text-muted);">${timeAgo}</span>
                      </div>
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="text-align: right;">
                      <div style="padding: 0.5rem 1rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 2px solid ${statusColor}40; margin-bottom: 0.5rem;">
                        ${statusBadge}
                      </div>
                      ${(() => {
                        const requirements = job.requirements || {};
                        if (requirements.keepOpenUntilAccepted === true) {
                          return `<div style="padding: 0.35rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 6px; font-weight: 600; font-size: 0.75rem; border: 1px solid #3b82f6; margin-top: 0.25rem;">
                            ✓ Auto-close when assigned
                          </div>`;
                        }
                        return '';
                      })()}
                    </div>
                  </div>
                </div>
              </div>
              
              ${!isMobile ? `
              <!-- Desktop: Payment Status (Customer) -->
              ${(job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && !job.startCodeVerified ? `
              <div style="padding: 1rem; background: #dcfce7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #10b981;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                  <div style="font-size: 1.5rem;">💳</div>
                  <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 0.95rem; color: #059669; margin-bottom: 0.25rem;">Payment Received</div>
                    <div style="font-size: 0.85rem; color: #047857;">You've already paid for this job. Payment is held in escrow until completion.</div>
                  </div>
                </div>
                ${(() => {
                  const payType = job.payType || 'flat';
                  // Use payment.amount if available (negotiated price), otherwise use job.amount (original price)
                  let jobAmount = 0;
                  if (payType === 'hourly') {
                    jobAmount = parseFloat(job.hourlyRate || 0) * parseFloat(job.estHours || 0);
                  } else {
                    // For flat jobs, use payment.amount if it exists (negotiated price), otherwise job.amount
                    jobAmount = job.payment && job.payment.amount ? parseFloat(job.payment.amount) : parseFloat(job.amount || 0);
                  }
                  if (jobAmount > 0) {
                    const serviceFee = jobAmount * 0.065;
                    const finalPrice = jobAmount + serviceFee;
                    return `
                      <div style="padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.8rem; color: #047857; line-height: 1.5;">
                          <div style="margin-bottom: 0.25rem;">Job Amount: <strong>$${jobAmount.toFixed(2)}</strong></div>
                          <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${serviceFee.toFixed(2)}</strong></div>
                          <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #10b981; font-weight: 600;">
                            Total Paid: <strong style="color: #059669;">$${finalPrice.toFixed(2)}</strong>
                          </div>
                        </div>
                      </div>
                    `;
                  }
                  return '';
                })()}
                <div style="padding: 0.75rem; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 6px;">
                  <div style="font-size: 0.8rem; color: #78350f; line-height: 1.4;">
                    <strong>🔄 Refund Policy:</strong> You can get a full refund by unassigning or deleting this job <strong>until the start code is verified</strong>. Once the hustler enters the start code, refunds must be processed through <strong>team.hustlapp@outlook.com</strong>.
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Desktop: Assigned Hustler (if job is in progress or assigned) -->
              ${(job.status === 'IN_PROGRESS' || job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && job.hustler ? `
              <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f640;">
                <div style="font-size: 0.9rem; color: #1e40af; font-weight: 600; margin-bottom: 0.75rem;">✅ Assigned Hustler</div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                  ${job.hustler && job.hustler.id ? renderUserAvatar(job.hustler, 48, { 
                    className: 'viewHustlerProfileBtn',
                    style: 'cursor: pointer;',
                    'data-user-id': job.hustler.id
                  }) : '<div style="width: 48px; height: 48px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); cursor: pointer;" class="viewHustlerProfileBtn">' + (job.hustler?.name ? job.hustler.name.charAt(0).toUpperCase() : 'H') + '</div>'}
                  <div style="flex: 1;">
                    <div style="font-weight: 700; color: var(--text-main); cursor: pointer;" class="viewHustlerProfileBtn" data-user-id="${job.hustler?.id || ''}">${job.hustler?.name || 'Unknown'}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">${job.hustler?.city || ''} ${job.hustler?.zip || ''}</div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <!-- Desktop: Start Code Section (Customer) -->
              ${job.hustlerId && job.startCode && !job.startCodeVerified && (job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && job.status !== 'PAID' ? `
              <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #fbbf24;">
                <div style="font-weight: 700; font-size: 1rem; color: #92400e; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                  <span>🔐</span>
                  <span>Start Code (Give to Hustler)</span>
                </div>
                <div style="font-size: 1.75rem; font-weight: 700; letter-spacing: 0.3em; color: #92400e; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem; border: 2px solid #fbbf24;">
                  ${job.startCode}
                </div>
                <div style="padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;">
                  <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem; font-size: 0.85rem;">⚠️ Safety Warning</div>
                  <div style="font-size: 0.8rem; color: #991b1b;">Do not give the Start Code until the hustler is physically there and ready to begin the job.</div>
                </div>
                ${(() => {
                  const payType = job.payType || 'flat';
                  const jobAmount = payType === 'hourly' 
                    ? (parseFloat(job.hourlyRate || 0) * parseFloat(job.estHours || 0))
                    : parseFloat(job.amount || 0);
                  if (jobAmount > 0) {
                    const serviceFee = jobAmount * 0.065;
                    const finalPrice = jobAmount + serviceFee;
                    return `
                      <div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #fbbf24; margin-bottom: 0.75rem;">
                        <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; font-size: 0.85rem;">💰 Final Price You've Already Paid</div>
                        <div style="font-size: 0.8rem; color: #78350f; line-height: 1.5;">
                          ${payType === 'hourly' && job.hourlyRate ? `
                          <div style="margin-bottom: 0.25rem;">Hourly Rate: <strong>$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hour</strong></div>
                          <div style="margin-bottom: 0.25rem;">Estimated Hours: <strong>${parseInt(job.estHours || 0)} hours</strong></div>
                          <div style="margin-bottom: 0.25rem;">Estimated Total: <strong>$${jobAmount.toFixed(2)}</strong></div>
                          <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${serviceFee.toFixed(2)}</strong></div>
                          <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                            Total Paid: <strong style="color: #059669;">$${finalPrice.toFixed(2)}</strong>
                          </div>
                          <div style="margin-top: 0.5rem; padding: 0.5rem; background: #dcfce7; border-radius: 4px; font-size: 0.75rem; color: #059669; font-weight: 600;">
                            💚 Any hours and money not used will be automatically refunded back to you.
                          </div>
                          ` : `
                          <div style="margin-bottom: 0.25rem;">Job Amount: <strong>$${jobAmount.toFixed(2)}</strong></div>
                          <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${serviceFee.toFixed(2)}</strong></div>
                          <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                            Total: <strong style="color: #059669;">$${finalPrice.toFixed(2)}</strong>
                          </div>
                          `}
                        </div>
                      </div>
                      <div style="padding: 0.75rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.8rem; color: #78350f; line-height: 1.4; font-weight: 600;">
                          Once verified, price is locked. Refunds via <strong>team.hustlapp@outlook.com</strong>.
                        </div>
                      </div>
                    `;
                  }
                  return '';
                })()}
                <div style="font-size: 0.85rem; color: #92400e; text-align: center;">
                  Share this 6-digit code with your hustler when they arrive.
                </div>
              </div>
              ` : ''}
              
              <!-- Desktop: Metrics Section - Prominent Applicant Count -->
              <div style="padding: 1.5rem; background: white;">
                ${offerCount > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #10b98140;">
                  <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 700; color: #059669; line-height: 1;">${offerCount}</div>
                    <div style="font-size: 0.9rem; color: #047857; font-weight: 600; margin-top: 0.5rem;">${offerCount === 1 ? 'Applicant' : 'Applicants'}</div>
                    <div style="font-size: 0.75rem; color: #065f46; margin-top: 0.25rem;">Waiting for review</div>
                  </div>
                  <div style="display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                      <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">👥</div>
                      <div style="font-size: 0.85rem; color: #047857; font-weight: 600;">Review & Accept</div>
                      <div style="font-size: 0.75rem; color: #065f46; margin-top: 0.25rem;">Click below to view</div>
                    </div>
                  </div>
                </div>
                ` : `
                <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf2440; margin-bottom: 1.5rem; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">👤</div>
                  <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">No applicants yet</div>
                  <div style="font-size: 0.85rem; color: #78350f;">Share your job to get more applicants!</div>
                </div>
                `}
                
                <!-- Desktop: Action Buttons -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 200px; padding: 1rem; font-size: 1rem; font-weight: 700; border-radius: 10px;">
                    ${offerCount > 0 ? '👥 View Applicants & Manage' : '🔍 View Job Details'}
                  </button>
                  ${(job.status === 'OPEN' || ((job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified)) ? `
                  <button class="btn btn-ghost cancelJobBtn" data-job-id="${job.id}" style="padding: 1rem 1.5rem; font-weight: 600; border-radius: 10px; color: #dc2626; border-color: #fecaca;">🚫 Delete</button>
                  ` : ''}
                </div>
              </div>
              ` : ''}
            `;
            
            // Add click handlers
            jobCard.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              // Mark that we're viewing from Posted tab so openJobDetails shows applicants
              window._viewingFromPostedTab = true;
              if (typeof window.openJobDetails === 'function') {
                window.openJobDetails(job.id);
              }
            });
            
            jobCard.querySelector('.cancelJobBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              const requirements = job.requirements || {};
              const keepOpenEnabled = requirements.keepOpenUntilAccepted === true;
              if (confirm(`Are you sure you want to cancel this job?${keepOpenEnabled ? ' (Note: Auto-close when assigned setting is active)' : ' It will no longer accept new applicants.'}`)) {
                await cancelJob(job.id, false);
                loadPostedJobs();
              }
            });
            
            // Make card clickable (but not buttons)
            jobCard.addEventListener('click', (e) => {
              if (!e.target.closest('button') && !e.target.closest('.btn')) {
                // Mark that we're viewing from Posted tab so openJobDetails shows applicants
                window._viewingFromPostedTab = true;
                if (typeof window.openJobDetails === 'function') {
                  window.openJobDetails(job.id);
                }
              }
            });
            
            postedJobsList.appendChild(jobCard);
            console.log("✅ Added job card for:", job.title || job.id);
          }
          
          console.log("✅ Total job cards rendered:", postedJobs.length);
          postedJobsList.dataset.loaded = 'true';
        }
      } catch (error) {
        console.error("Error loading posted jobs:", error);
        postedJobsList.innerHTML = `
          <div style='text-align: center; padding: 2rem; color: var(--text-muted);'>
            <div style="font-size: 1.1rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem;">Error loading jobs</div>
            <div style="margin-bottom: 1rem;">${error.message || 'Please refresh and try again.'}</div>
            <button class="btn btn-primary" onclick="loadPostedJobs()" style="padding: 0.75rem 1.5rem;">Retry</button>
          </div>
        `;
        postedJobsList.dataset.loaded = 'true';
      } finally {
        // Always clear loading flag
        if (postedJobsList) {
          postedJobsList.dataset.loading = 'false';
        }
      }
    }
    
    // Load Active Jobs - Role-based (Customer vs Hustler)
    async function loadActiveJobs() {
      const activeJobsList = document.getElementById("manageActiveJobsList");
      if (!activeJobsList) return;
      
      activeJobsList.dataset.loaded = 'false'; // Always reload
      
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user || !token) {
          activeJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view active jobs.</div>";
          return;
        }
        
        // Use the dedicated endpoint for active jobs
        const response = await fetch(`${API_BASE}/jobs/active`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("Failed to fetch active jobs:", response.status, errorText);
          throw new Error(`Failed to fetch active jobs: ${response.status}`);
        }
        
        const jobs = await response.json();
        
        // Ensure jobs is an array
        if (!Array.isArray(jobs)) {
          console.error("Active jobs is not an array:", typeof jobs, jobs);
          throw new Error("Invalid response format from server");
        }
        
        console.log("✅ Fetched active jobs:", jobs.length, "jobs");
        
        // The API endpoint already filters for active jobs, but add client-side filter for completed jobs (safety check)
        const activeJobs = jobs.filter(job => 
          job.status !== 'PAID' && 
          !(job.status === 'COMPLETED_BY_HUSTLER' && job.completionCodeVerified)
        );
        
        if (activeJobs.length === 0) {
          activeJobsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">🟡</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No active jobs</div>
              <div style="color: var(--text-muted);">You're not working on any jobs right now.</div>
            </div>
          `;
        } else {
          activeJobsList.innerHTML = "";
          for (const job of activeJobs) {
            const isCustomer = job.customerId === user.id;
            const isHustler = job.hustlerId === user.id;
            
            // Skip jobs where user is neither customer nor hustler (data integrity check)
            if (!isCustomer && !isHustler) {
              console.warn('Job found in active jobs but user is neither customer nor hustler:', {
                jobId: job.id,
                jobCustomerId: job.customerId,
                jobHustlerId: job.hustlerId,
                userId: user.id
              });
              continue;
            }
            
            // Define customerId in outer scope so it's accessible later
            const customerId = job.customer?.id || job.customerId;
            
            // Get requirements for additional fields
            let requirements = job.requirements || {};
            // Parse requirements if it's a string
            if (typeof requirements === 'string') {
              try {
                requirements = JSON.parse(requirements);
              } catch (e) {
                requirements = {};
              }
            }
            const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
            const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
            const pricingOption = requirements.pricing_option;
            
            // Format location
            const pickupArea = requirements.pickup_area || requirements.pickupArea;
            const pickupCity = requirements.pickup_city || requirements.pickupCity;
            const pickupZip = requirements.pickup_zip;
            const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
            const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
            const dropoffZip = requirements.dropoff_zip;
            const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
            
            let locationDisplay = job.address || 'Location not specified';
            if (pickupArea || pickupCity) {
              const pickupParts = [];
              if (pickupArea) pickupParts.push(pickupArea);
              if (pickupCity) pickupParts.push(pickupCity);
              if (pickupZip) pickupParts.push(pickupZip);
              locationDisplay = pickupParts.join(', ');
              
              if (!onSiteOnly && (dropoffArea || dropoffCity)) {
                const dropoffParts = [];
                if (dropoffArea) dropoffParts.push(dropoffArea);
                if (dropoffCity) dropoffParts.push(dropoffCity);
                if (dropoffZip) dropoffParts.push(dropoffZip);
                locationDisplay += ` → ${dropoffParts.join(', ')}`;
              } else if (onSiteOnly) {
                locationDisplay += ' (Single location)';
              }
            }
            
            // Format timing
            let timingDisplay = '';
            if (deadlinePreference === 'until_completed') {
              timingDisplay = 'Until completed';
            } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
              timingDisplay = 'Flexible this week';
            } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
              timingDisplay = 'Today – ASAP';
            } else if (deadlinePreference === 'tomorrow') {
              timingDisplay = 'Tomorrow';
            } else if (job.startTime) {
              const deadlineDate = new Date(job.startTime);
              timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
              timingDisplay = 'Not specified';
            }
            
            // Format pay
            const payType = job.payType || 'flat';
            let payDisplay = '';
            if (pricingOption === 'hustlers_quote') {
              payDisplay = 'Hustler suggests price';
            } else if (payType === 'hourly') {
              const hourlyRate = parseFloat(job.hourlyRate || 0);
              if (teamSize > 1) {
                const perPersonRate = hourlyRate / teamSize;
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs) · ${teamSize} workers → $${perPersonRate.toFixed(0)}/hr each`;
              } else {
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs)`;
              }
            } else {
              payDisplay = `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
            }
            
            // Format workers
            let workersDisplay = '';
            if (teamSize === 0) {
              workersDisplay = 'Company/crew';
            } else if (teamSize === 1) {
              workersDisplay = '1 worker';
            } else {
              workersDisplay = `${teamSize} workers`;
            }
            
            // Format scheduled time
            const jobDate = new Date(job.date);
            const dateStr = jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            // Calculate current/updated price (check for proposed price change)
            let parsedRequirements = job.requirements || {};
            if (typeof parsedRequirements === 'string') {
              try { parsedRequirements = JSON.parse(parsedRequirements); } catch { parsedRequirements = {}; }
            }
            const proposedPriceChange = parsedRequirements.proposedPriceChange;
            let currentPrice = 0;
            if (pricingOption === 'hustlers_quote') {
              // Hustler suggests price - don't show price
              currentPrice = 0;
            } else if (payType === 'hourly') {
              const hourlyRate = parseFloat(job.hourlyRate || 0);
              const estHours = parseFloat(job.estHours || 0);
              if (proposedPriceChange && proposedPriceChange.status === 'PENDING') {
                const newRate = proposedPriceChange.hourlyRate !== null ? proposedPriceChange.hourlyRate : hourlyRate;
                const newHours = proposedPriceChange.estHours !== null ? proposedPriceChange.estHours : estHours;
                currentPrice = newRate * newHours;
              } else {
                currentPrice = hourlyRate * estHours;
              }
            } else {
              // Flat rate
              if (proposedPriceChange && proposedPriceChange.status === 'PENDING') {
                currentPrice = proposedPriceChange.amount !== null ? proposedPriceChange.amount : parseFloat(job.amount || 0);
              } else {
                currentPrice = parseFloat(job.amount || 0);
              }
            }
            
            const card = document.createElement("div");
            card.style.cssText = "padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;";
            card.onmouseenter = () => { card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
            card.onmouseleave = () => { card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)'; };
            
            // Category icon
            const categoryIcons = {
              'Moving / Hauling': '🚚',
              'Yard work / Outdoor': '🌿',
              'Cleaning / Organizing': '🧹',
              'Furniture / Assembly': '🛠',
              'Other': '⭐'
            };
            const categoryIcon = categoryIcons[job.category] || '📋';
            
            if (isCustomer) {
              // Customer View: Shows hired hustler
              const hustler = job.hustler || {};
              
              // Check if price proposal is pending - if so, replace start code section
              const hasPendingPriceProposal = proposedPriceChange && proposedPriceChange.status === 'PENDING';
              
              // Start code display for customer (if job is scheduled/assigned and not started) - BUT hide if price proposal pending
              const startCodeSection = !hasPendingPriceProposal && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && job.startCode && !job.startCodeVerified ? `
                <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #fbbf24;">
                  <div style="font-weight: 700; font-size: 0.95rem; color: #92400e; margin-bottom: 0.5rem;">🔐 Your Start Code</div>
                  <div style="font-size: 1.75rem; font-weight: 700; letter-spacing: 0.3em; color: #92400e; text-align: center; padding: 0.75rem; background: white; border-radius: 6px; font-family: 'Courier New', monospace; margin-bottom: 0.5rem;">${job.startCode}</div>
                  <div style="font-size: 0.85rem; color: #92400e; line-height: 1.4;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">⚠️ Give this code to your hustler when they arrive and are ready to start.</div>
                    <div style="font-size: 0.8rem; margin-bottom: 0.75rem;">Do not share until the hustler is physically present.</div>
                    ${(() => {
                      const payType = job.payType || 'flat';
                      // Use payment.amount if available (negotiated price), otherwise use job.amount (original price)
                      let jobAmount = 0;
                      if (payType === 'hourly') {
                        jobAmount = parseFloat(job.hourlyRate || 0) * parseFloat(job.estHours || 0);
                      } else {
                        // For flat jobs, use payment.amount if it exists (negotiated price), otherwise job.amount
                        jobAmount = job.payment && job.payment.amount ? parseFloat(job.payment.amount) : parseFloat(job.amount || 0);
                      }
                      if (jobAmount > 0) {
                        const serviceFee = jobAmount * 0.065;
                        const finalPrice = jobAmount + serviceFee;
                        return `
                          <div style="padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid #fbbf24; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; font-size: 0.85rem;">💰 Final Price You've Already Paid</div>
                            <div style="font-size: 0.8rem; color: #78350f; line-height: 1.5;">
                              ${payType === 'hourly' && job.hourlyRate ? `
                              <div style="margin-bottom: 0.25rem;">Hourly Rate: <strong>$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hour</strong></div>
                              <div style="margin-bottom: 0.25rem;">Estimated Hours: <strong>${parseInt(job.estHours || 0)} hours</strong></div>
                              <div style="margin-bottom: 0.25rem;">Estimated Total: <strong>$${jobAmount.toFixed(2)}</strong></div>
                              <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${serviceFee.toFixed(2)}</strong></div>
                              <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                                Total Paid: <strong style="color: #059669;">$${finalPrice.toFixed(2)}</strong>
                              </div>
                              <div style="margin-top: 0.5rem; padding: 0.5rem; background: #dcfce7; border-radius: 4px; font-size: 0.75rem; color: #059669; font-weight: 600;">
                                💚 Any hours and money not used will be automatically refunded back to you.
                              </div>
                              ` : `
                              <div style="margin-bottom: 0.25rem;">Job Amount: <strong>$${jobAmount.toFixed(2)}</strong></div>
                              <div style="margin-bottom: 0.25rem;">Service Fee (6.5%): <strong>$${serviceFee.toFixed(2)}</strong></div>
                              <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                                Total: <strong style="color: #059669;">$${finalPrice.toFixed(2)}</strong>
                              </div>
                              `}
                            </div>
                          </div>
                          <div style="font-size: 0.75rem; color: #78350f; font-weight: 600; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                            Once verified, price is locked. Refunds via <strong>team.hustlapp@outlook.com</strong>.
                          </div>
                        `;
                      }
                      return '';
                    })()}
                  </div>
                </div>
              ` : '';
              
              // Completion code display for customer (if job is IN_PROGRESS) - Customer just needs to see their code to give to hustler
              const completionCodeSection = job.status === 'IN_PROGRESS' && job.startCodeVerified && job.completionCode && !job.completionCodeVerified ? (() => {
                let refundInfo = '';
                if (job.payType === 'hourly' && job.hourlyRate && job.estHours && requirements && requirements.startedAt) {
                  try {
                    const startedAt = new Date(requirements.startedAt);
                    const now = new Date();
                    const elapsedMs = now.getTime() - startedAt.getTime();
                    const actualHours = elapsedMs / (1000 * 60 * 60);
                    const hourlyRate = Number(job.hourlyRate || 0);
                    const maxHours = Number(job.estHours || 0);
                    
                    const originalAuthorized = hourlyRate * maxHours;
                    const actualCharge = hourlyRate * actualHours;
                    const refundAmount = originalAuthorized - actualCharge;
                    
                    if (refundAmount > 0) {
                      refundInfo = `
                        <div style="padding: 0.5rem; background: #dcfce7; border-left: 3px solid #10b981; border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: #047857; line-height: 1.3;">
                          💚 If completed now (${actualHours.toFixed(2)} hrs), you'll be refunded <strong>$${refundAmount.toFixed(2)}</strong> for unused time.
                        </div>
                      `;
                    }
                  } catch (e) {
                    console.error('Error calculating refund estimate:', e);
                  }
                }
                return `
                <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #16a34a;">
                  <div style="font-weight: 700; font-size: 0.95rem; color: #166534; margin-bottom: 0.5rem;">✅ Your Completion Code</div>
                  <div style="font-size: 1.75rem; font-weight: 700; letter-spacing: 0.3em; color: #166534; text-align: center; padding: 0.75rem; background: white; border-radius: 6px; font-family: 'Courier New', monospace; margin-bottom: 0.5rem;">${job.completionCode}</div>
                  <div style="font-size: 0.85rem; color: #166534; line-height: 1.4;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">⚠️ Give this code to your hustler only after the job is fully done and you're satisfied.</div>
                    <div style="font-size: 0.8rem;">This will release payment to the hustler.</div>
                    ${refundInfo}
                  </div>
                </div>
              `;
              })() : '';
              
              card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="font-size: 1.5rem;">${categoryIcon}</span>
                      <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      ${renderUserAvatar(hustler, 40, { 
                        className: 'viewHustlerProfileBtn',
                        style: 'cursor: pointer;'
                      })}
                      <div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${job.status === 'IN_PROGRESS' ? '🔄 In Progress' : '✅ Assigned'}</div>
                        <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewHustlerProfileBtn" data-user-id="${hustler.id}">${hustler.name || 'Unknown'}</div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                      <div style="padding: 0.25rem 0.75rem; background: ${job.status === 'IN_PROGRESS' ? '#f59e0b20' : '#3b82f620'}; color: ${job.status === 'IN_PROGRESS' ? '#f59e0b' : '#3b82f6'}; border-radius: 6px; font-weight: 600; font-size: 0.85rem; display: inline-block;">${job.status === 'IN_PROGRESS' ? 'In Progress' : 'Scheduled'}</div>
                      ${!job.startCodeVerified ? `
                        <div style="padding: 0.25rem 0.75rem; background: #dcfce7; color: #059669; border-radius: 6px; font-weight: 600; font-size: 0.75rem; display: inline-block; border: 1px solid #10b981;">
                          💳 Paid • Refundable
                        </div>
                      ` : ''}
                    </div>
                  </div>
                  ${currentPrice > 0 || (pricingOption !== 'hustlers_quote' && (payType === 'hourly' || payType === 'flat')) ? `
                  <div style="text-align: right; flex-shrink: 0; margin-left: 1rem; padding-left: 1rem;">
                    ${payType === 'hourly' && job.hourlyRate ? `
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary); line-height: 1.2; white-space: nowrap;">$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr</div>
                    ` : `
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary); line-height: 1.2; white-space: nowrap;">$${(currentPrice || 0).toFixed(2)}</div>
                    `}
                    ${hasPendingPriceProposal ? `
                    <div style="font-size: 0.7rem; color: #f59e0b; font-weight: 600; margin-top: 0.25rem; white-space: nowrap;">💰 Pending</div>
                    ` : ''}
                  </div>
                  ` : ''}
                </div>
                ${startCodeSection}
                ${completionCodeSection}
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary messageBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">💬 Message</button>
                  <button class="btn btn-ghost viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem;">🔍 View Job</button>
                  ${(job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified ? `
                    <button class="btn btn-primary unassignHustlerBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: #f59e0b; border: none; border-radius: 8px;">🔓 Unassign</button>
                    <button class="btn btn-ghost deleteJobBtn" data-job-id="${job.id}" style="padding: 0.75rem; width: 48px; height: 48px; color: #dc2626; border: 2px solid #fecaca; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: #fef2f2;" title="Delete Job">🗑️</button>
                  ` : ''}
                </div>
              `;
            } else if (isHustler) {
              // Hustler View: Shows customer who hired them
              const customer = job.customer || {};
              
              // Get tools needed
              const equipmentNeeded = requirements.equipmentNeeded || [];
              const customEquipment = requirements.customEquipment || '';
              let toolsDisplay = 'None';
              if (equipmentNeeded.length > 0) {
                toolsDisplay = equipmentNeeded.join(', ');
              } else if (customEquipment) {
                toolsDisplay = customEquipment;
              }
              
              // Check if price proposal is pending for hustler view
              const hasPendingPriceProposalHustler = proposedPriceChange && proposedPriceChange.status === 'PENDING';
              
              card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="font-size: 1.5rem;">${categoryIcon}</span>
                      <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      ${customer && customer.id ? renderUserAvatar(customer, 40, { className: 'viewCustomerProfileBtn', 'data-user-id': customer.id }) : '<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="' + (customerId || '') + '">' + (customer?.name ? customer.name.charAt(0).toUpperCase() : 'C') + '</div>'}
                      <div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Customer</div>
                        <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${customer?.id || customerId || ''}">${customer?.name || 'Unknown'}</div>
                      </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                      <div>👥 ${workersDisplay}</div>
                      <div>🔧 Tools: ${toolsDisplay}</div>
                      ${job.status === 'IN_PROGRESS' && job.payType === 'hourly' && requirements.startedAt ? `
                        <div id="activeJobTimer-${job.id}" style="padding: 0.5rem; background: #fef3c7; border-radius: 6px; font-weight: 600; font-size: 0.9rem; color: #92400e; font-family: 'Courier New', monospace;">
                          ⏱️ <span id="activeJobTimerText-${job.id}">Calculating...</span>
                    </div>
                      ` : ''}
                      <div style="padding: 0.25rem 0.75rem; background: ${job.status === 'IN_PROGRESS' ? '#f59e0b20' : '#3b82f620'}; color: ${job.status === 'IN_PROGRESS' ? '#f59e0b' : '#3b82f6'}; border-radius: 6px; font-weight: 600; font-size: 0.85rem; display: inline-block; width: fit-content;">${job.status === 'IN_PROGRESS' ? 'In Progress' : 'Scheduled'}</div>
                    </div>
                  </div>
                  ${currentPrice > 0 || (pricingOption !== 'hustlers_quote' && (payType === 'hourly' || payType === 'flat')) ? `
                  <div style="text-align: right; flex-shrink: 0; margin-left: 1rem; padding-left: 1rem;">
                    ${payType === 'hourly' && job.hourlyRate ? `
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary); line-height: 1.2; white-space: nowrap;">$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr</div>
                    ` : `
                    <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary); line-height: 1.2; white-space: nowrap;">$${(currentPrice || 0).toFixed(2)}</div>
                    `}
                    ${hasPendingPriceProposalHustler ? `
                    <div style="font-size: 0.7rem; color: #f59e0b; font-weight: 600; margin-top: 0.25rem; white-space: nowrap;">💰 Pending</div>
                    ` : ''}
                  </div>
                  ` : ''}
                </div>
                ${(job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && job.startCode && !job.startCodeVerified ? `
                <div style="padding: 0.875rem; background: #dbeafe; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; font-size: 0.9rem; color: #1e40af; margin-bottom: 0.375rem;">🔐 Enter Start Code</div>
                  <div style="font-size: 0.8rem; color: #1e40af; margin-bottom: 0.625rem; line-height: 1.3;">Ask the customer for the 6-digit start code to begin the job.</div>
                  ${(() => {
                    const payType = job.payType || 'flat';
                    // Use payment.amount if available (negotiated price), otherwise use job.amount (original price)
                    let currentAmount = 0;
                    if (payType === 'hourly') {
                      currentAmount = parseFloat(job.hourlyRate || 0) * parseFloat(job.estHours || 0);
                    } else {
                      // For flat jobs, use payment.amount if it exists (negotiated price), otherwise job.amount
                      currentAmount = job.payment && job.payment.amount ? parseFloat(job.payment.amount) : parseFloat(job.amount || 0);
                    }
                    if (currentAmount > 0) {
                      const platformFee = currentAmount * 0.12;
                      const finalPayment = currentAmount - platformFee;
                      const isHourly = payType === 'hourly';
                      const hourlyRate = parseFloat(job.hourlyRate || 0);
                      const hourlyEarnings = hourlyRate > 0 ? (hourlyRate * 0.88).toFixed(2) : 0; // 88% after 12% platform fee
                      
                      return `
                        <div style="padding: 0.625rem; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 6px; margin-bottom: 0.625rem;">
                          <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem; font-size: 0.75rem;">💰 Your Final Payment</div>
                          <div style="font-size: 0.7rem; color: #78350f; line-height: 1.4;">
                            ${isHourly && hourlyRate > 0 ? `
                            <div style="margin-bottom: 0.25rem;">Hourly Rate: <strong>$${hourlyRate.toFixed(2)}/hour</strong></div>
                            <div style="margin-bottom: 0.25rem;">Platform Fee (12%): <strong>$${(hourlyRate * 0.12).toFixed(2)}/hour</strong></div>
                            <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                              You'll Earn: <strong style="color: #059669;">$${hourlyEarnings}/hour</strong>
                            </div>
                            <div style="margin-top: 0.375rem; font-size: 0.65rem; color: #92400e; font-style: italic;">
                              This is your guaranteed hourly rate. You're actually guaranteed to make this much per hour because you're paid for actual hours worked.
                            </div>
                            ` : `
                            <div style="margin-bottom: 0.25rem;">Job Amount: <strong>$${currentAmount.toFixed(2)}</strong></div>
                            <div style="margin-bottom: 0.25rem;">Platform Fee (12%): <strong>$${platformFee.toFixed(2)}</strong></div>
                            <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid #fbbf24; font-weight: 600;">
                              You'll Earn: <strong style="color: #059669;">$${finalPayment.toFixed(2)}</strong>
                            </div>
                            `}
                            <div style="margin-top: 0.375rem; font-size: 0.65rem; color: #92400e;">
                              Once verified, price is locked. Refunds via <strong>team.hustlapp@outlook.com</strong>.
                            </div>
                          </div>
                        </div>
                      `;
                    }
                    return '';
                  })()}
                  <input type="text" id="startCodeInput_${job.id}" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 0.625rem; font-size: 1.1rem; text-align: center; letter-spacing: 0.2em; border: 2px solid #3b82f6; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.625rem; box-sizing: border-box;" />
                  <button class="btn btn-primary verifyStartCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.625rem; font-weight: 600; font-size: 0.95rem;">Verify & Start Job</button>
                </div>
                ` : ''}
                ${job.status === 'IN_PROGRESS' && job.startCodeVerified && job.completionCode && !job.completionCodeVerified ? (() => {
                  let payoutInfo = '';
                  if (job.payType === 'hourly' && job.hourlyRate && job.estHours && requirements && requirements.startedAt) {
                    try {
                      const startedAt = new Date(requirements.startedAt);
                      const now = new Date();
                      const elapsedMs = now.getTime() - startedAt.getTime();
                      const actualHours = elapsedMs / (1000 * 60 * 60);
                      const hourlyRate = Number(job.hourlyRate || 0);
                      
                      // Calculate actual job amount (capped at max hours)
                      const maxHours = Number(job.estHours || 0);
                      const actualJobAmount = Math.min(hourlyRate * actualHours, hourlyRate * maxHours);
                      const platformFee = actualJobAmount * 0.12;
                      const payoutAmount = actualJobAmount - platformFee;
                      
                      payoutInfo = `
                        <div style="padding: 0.5rem; background: #dcfce7; border-left: 3px solid #10b981; border-radius: 4px; margin-bottom: 0.625rem; font-size: 0.75rem; color: #047857; line-height: 1.3;">
                          💰 If completed now (${actualHours.toFixed(2)} hrs): Job amount $${actualJobAmount.toFixed(2)} - Platform fee (12%) $${platformFee.toFixed(2)} = <strong>$${payoutAmount.toFixed(2)}</strong> will be released to your account.
                        </div>
                      `;
                    } catch (e) {
                      console.error('Error calculating payout estimate:', e);
                    }
                  }
                  return `
                <div style="padding: 0.875rem; background: #dbeafe; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; font-size: 0.9rem; color: #1e40af; margin-bottom: 0.375rem;">✅ Enter Completion Code</div>
                  <div style="font-size: 0.8rem; color: #1e40af; margin-bottom: 0.625rem; line-height: 1.3;">Ask the customer for the 6-digit completion code to finish the job and release payment.</div>
                  ${payoutInfo}
                  <input type="text" id="completionCodeInput_${job.id}" placeholder="Enter 6-digit completion code" maxlength="6" style="width: 100%; padding: 0.625rem; font-size: 1.1rem; text-align: center; letter-spacing: 0.2em; border: 2px solid #3b82f6; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.625rem; box-sizing: border-box;" />
                  <button class="btn btn-primary verifyCompletionCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.625rem; font-weight: 600; font-size: 0.95rem;">Verify & Complete Job</button>
                </div>
              `;
                })() : ''}
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary messageBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">💬 Message</button>
                  ${(job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && !job.startCodeVerified ? `
                    <button class="btn btn-primary proposePriceBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: #f59e0b; border: none; border-radius: 8px;">💰 Propose New Price</button>
                    <button class="btn btn-primary leaveJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: #dc2626; border: none; border-radius: 8px;">🚪 Leave Job</button>
                  ` : ''}
                </div>
              `;
            }
            
            // Event listeners
            card.querySelector('.messageBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              // Set the active conversation to this job
              if (typeof window !== 'undefined' && window.activeConversationJobId !== undefined) {
                window.activeConversationJobId = job.id;
              }
              setView('messages');
            });
            
            card.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              if (typeof window.openJobDetails === 'function') {
                window.openJobDetails(job.id);
              } else if (typeof openJobDetails === 'function') {
                openJobDetails(job.id);
              }
            });
            
            // Map button removed - not needed on active job cards
            
            card.querySelector('.unacceptBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('Are you sure you want to unaccept this hustler? The job will be open for applicants again.')) {
                await unacceptHustler(job.id);
                loadActiveJobs();
                loadPostedJobs();
              }
            });
            
            // Unassign hustler button (customer view for scheduled jobs)
            card.querySelector('.unassignHustlerBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('Are you sure you want to unassign this hustler? The job will be open for applicants again.')) {
                await unacceptHustler(job.id);
                loadActiveJobs();
                loadPostedJobs();
              }
            });
            
            // Delete job button (customer view for scheduled jobs)
            card.querySelector('.deleteJobBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                try {
                  const token = localStorage.getItem('hustl_token');
                  const response = await fetch(`${API_BASE}/jobs/${job.id}`, {
                    method: 'DELETE',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || errorData.message || 'Failed to delete job');
                  }
                  
                  showToast("✅ Job deleted successfully.");
                  loadActiveJobs();
                  loadPostedJobs();
                } catch (error) {
                  console.error("Error deleting job:", error);
                  showToast(error.message || "Error deleting job. Please try again.");
                }
              }
            });
            
            // Handle start code input (only allow numbers)
            const startCodeInput = card.querySelector(`#startCodeInput_${job.id}`);
            if (startCodeInput) {
              // Prevent card click from opening modal when clicking input
              startCodeInput.addEventListener('click', (e) => {
                e.stopPropagation();
              });
              startCodeInput.addEventListener('focus', (e) => {
                e.stopPropagation();
              });
              startCodeInput.addEventListener('input', (e) => {
                e.stopPropagation();
                e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
              });
            }
            
            // Handle verify start code button
            card.querySelector('.verifyStartCodeBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              e.preventDefault();
              const input = card.querySelector(`#startCodeInput_${job.id}`);
              if (!input) {
                showToast('❌ Error: Start code input not found');
                return;
              }
              const code = input.value.trim();
              if (!code || code.length !== 6) {
                showToast('❌ Please enter a valid 6-digit start code');
                input.focus();
                return;
              }
              const success = await verifyStartCode(job.id, code);
              if (success) {
                loadActiveJobs();
              }
            });
            
            card.querySelector('.markStartedBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              await verifyStartCode(job.id);
              loadActiveJobs();
            });
            
            // Handle completion code input (only allow numbers)
            const completionCodeInput = card.querySelector(`#completionCodeInput_${job.id}`);
            if (completionCodeInput) {
              completionCodeInput.addEventListener('click', (e) => {
                e.stopPropagation();
              });
              completionCodeInput.addEventListener('focus', (e) => {
                e.stopPropagation();
              });
              completionCodeInput.addEventListener('input', (e) => {
                e.stopPropagation();
                e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
              });
            }
            
            // Handle verify completion code button
            card.querySelector('.verifyCompletionCodeBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              e.preventDefault();
              const input = card.querySelector(`#completionCodeInput_${job.id}`);
              if (!input) {
                showToast('❌ Error: Completion code input not found');
                return;
              }
              const code = input.value.trim();
              if (!code || code.length !== 6) {
                showToast('❌ Please enter a valid 6-digit completion code');
                input.focus();
                return;
              }
              const success = await verifyCompletionCode(job.id, code);
              if (success) {
                loadActiveJobs();
                loadCompletedJobs();
              }
            });
            
            // Leave job button (hustler view for scheduled/assigned jobs)
            // Propose New Price button - opens job details and scrolls to price change section
            card.querySelector('.proposePriceBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (typeof window.openJobDetails === 'function') {
                window.openJobDetails(job.id);
                // Wait for modal to open, then scroll to price change section
                setTimeout(() => {
                  const modal = document.getElementById('jobDetailModal');
                  if (modal) {
                    const priceChangeSection = modal.querySelector('[style*="💰 Adjust Price"]')?.closest('div[style*="margin-bottom: 1rem"]');
                    if (priceChangeSection) {
                      priceChangeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      // Highlight the section briefly
                      priceChangeSection.style.transition = 'box-shadow 0.3s';
                      priceChangeSection.style.boxShadow = '0 0 0 4px rgba(245, 158, 11, 0.3)';
                      setTimeout(() => {
                        priceChangeSection.style.boxShadow = '';
                      }, 2000);
                    }
                  }
                }, 500);
              } else if (typeof openJobDetails === 'function') {
                openJobDetails(job.id);
              }
            });
            
            card.querySelector('.leaveJobBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('Are you sure you want to leave this job? The job will be open for other applicants.')) {
                await leaveJob(job.id);
                loadActiveJobs();
              }
            });
            
            card.querySelector('.markFinishedBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              await submitCompletionCode(job.id);
              loadActiveJobs();
            });
            
            card.querySelector('.cancelApplicationBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              // BUSINESS RULE: Can only cancel before start code is entered
              if (job.startCodeVerified) {
                showToast('Cannot cancel: Job has already started. Once the start code is entered, the job must be completed.');
                return;
              }
              if (confirm('Are you sure you want to cancel this job? The job will be reopened for other applicants.')) {
                await cancelApplication(job.id);
                loadActiveJobs();
              }
            });
            
            // View profile buttons
            // Handle reviews dropdown toggle for customer profile in job card
            if (isHustler && customerId) {
              const viewReviewsBtn = card.querySelector(`.viewLast5ReviewsBtn_${customerId}`);
              const reviewsDropdown = card.querySelector(`.reviewsDropdown_${customerId}`);
              if (viewReviewsBtn && reviewsDropdown) {
                viewReviewsBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const isVisible = reviewsDropdown.style.display !== 'none';
                  reviewsDropdown.style.display = isVisible ? 'none' : 'block';
                  viewReviewsBtn.textContent = isVisible ? 'View last 5 reviews' : 'Hide reviews';
                });
              }
            }
            
            card.querySelectorAll('.viewHustlerProfileBtn, .viewCustomerProfileBtn').forEach(btn => {
              btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const userId = btn.dataset.userId || btn.closest('[data-user-id]')?.dataset.userId;
                if (userId) {
                  if (typeof window.showHustlerProfilePopup === 'function') {
                    window.showHustlerProfilePopup(userId);
                  }
                }
              });
            });
            
            // Make entire card clickable
            card.addEventListener('click', (e) => {
              if (!e.target.closest('button') && 
                  !e.target.closest('img') && 
                  !e.target.closest('.viewHustlerProfileBtn') && 
                  !e.target.closest('.viewCustomerProfileBtn') &&
                  !e.target.closest('input') &&
                  !e.target.closest(`#startCodeInput_${job.id}`) &&
                  !e.target.closest(`#completionCodeInput_${job.id}`)) {
                if (typeof window.openJobDetails === 'function') {
                  window.openJobDetails(job.id);
                } else if (typeof openJobDetails === 'function') {
                  openJobDetails(job.id);
                }
              }
            });
            
            // Initialize timer for hourly IN_PROGRESS jobs
            if (job.status === 'IN_PROGRESS' && job.payType === 'hourly' && requirements.startedAt) {
              const timerElement = card.querySelector(`#activeJobTimerText-${job.id}`);
              if (timerElement) {
                const updateActiveJobTimer = () => {
                  try {
                    const startedAt = new Date(requirements.startedAt);
                    const now = new Date();
                    const elapsedMs = now.getTime() - startedAt.getTime();
                    const hours = Math.floor(elapsedMs / (1000 * 60 * 60));
                    const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
                    
                    let timerText = '';
                    if (hours > 0) {
                      timerText = `${hours}h ${minutes}m ${seconds}s`;
                    } else if (minutes > 0) {
                      timerText = `${minutes}m ${seconds}s`;
                    } else {
                      timerText = `${seconds}s`;
                    }
                    
                    timerElement.textContent = timerText;
                  } catch (e) {
                    console.error("Error updating active job timer:", e);
                  }
                };
                
                updateActiveJobTimer();
                const timerInterval = setInterval(updateActiveJobTimer, 1000);
                
                // Store interval ID on card for cleanup
                card._timerInterval = timerInterval;
              }
            }
            
            activeJobsList.appendChild(card);
            
            // Fix any broken avatar images after insertion
            setTimeout(() => {
              const avatarImages = card.querySelectorAll('img[id^="avatar_"]');
              avatarImages.forEach(img => {
                if (!img.complete || img.naturalHeight === 0) {
                  // Image failed to load or is broken
                  img.style.display = 'none';
                  const fallbackId = img.id.replace('_img', '_fallback');
                  const fallback = document.getElementById(fallbackId);
                  if (fallback) {
                    fallback.style.display = 'flex';
                  }
                } else {
                  // Image loaded successfully, hide fallback
                  const fallbackId = img.id.replace('_img', '_fallback');
                  const fallback = document.getElementById(fallbackId);
                  if (fallback) {
                    fallback.style.display = 'none';
                  }
                }
              });
            }, 100);
          }
          activeJobsList.dataset.loaded = 'true';
        }
      } catch (error) {
        console.error("Error loading active jobs:", error);
        const currentUser = await window.hustlAPI.auth.getCurrentUser().catch(() => null);
        console.error("Error details:", {
          message: error.message,
          stack: error.stack,
          user: currentUser?.id,
          token: localStorage.getItem('hustl_token') ? 'present' : 'missing'
        });
        activeJobsList.innerHTML = `
          <div style='text-align: center; padding: 2rem; color: var(--text-muted);'>
            <div style="font-size: 1.1rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem;">Error loading active jobs</div>
            <div style="margin-bottom: 1rem; font-size: 0.9rem;">${error.message || 'Please refresh and try again.'}</div>
            <button class="btn btn-primary" onclick="loadActiveJobs()" style="padding: 0.75rem 1.5rem;">Retry</button>
          </div>
        `;
      }
    }
    
    // Load Completed Jobs with pagination
    let completedJobsPage = 1;
    let completedJobsLoaded = [];
    let hasMoreCompletedJobs = true;
    
    async function loadCompletedJobs(reset = false) {
      console.log("🔵 loadCompletedJobs called, reset:", reset);
      
      const completedJobsList = document.getElementById("manageCompletedJobsList");
      
      if (!completedJobsList) {
        console.error("❌ manageCompletedJobsList element not found");
        setTimeout(() => {
          const retry = document.getElementById("manageCompletedJobsList");
          if (retry) {
            console.log("✅ Found on retry, calling loadCompletedJobs again");
            loadCompletedJobs(reset);
          }
        }, 200);
        return;
      }
      
      // Prevent duplicate calls
      if (completedJobsList.dataset.loading === 'true') {
        console.log("⏸️ loadCompletedJobs already in progress, skipping");
        return;
      }
      
      if (reset) {
        completedJobsPage = 1;
        completedJobsLoaded = [];
        hasMoreCompletedJobs = true;
        completedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading...</div>";
      }
      
      completedJobsList.dataset.loading = 'true';
      
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        console.log("🔵 User:", user?.id, "Role:", user?.role);
        if (!user) {
          completedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your completed jobs.</div>";
          completedJobsList.dataset.loading = 'false';
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          completedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your completed jobs.</div>";
          completedJobsList.dataset.loading = 'false';
          return;
        }
        
        // Check user role - handle both role (string) and roles (array)
        const userRole = user.role || (user.roles && Array.isArray(user.roles) ? user.roles[0] : null);
        const isCustomer = userRole === 'CUSTOMER' || userRole === 'customer' || 
                          (user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'CUSTOMER'));
        const isHustler = userRole === 'HUSTLER' || userRole === 'hustler' || 
                         (user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'HUSTLER'));
        console.log("🔵 User role check - role:", userRole, "roles:", user.roles, "isCustomer:", isCustomer, "isHustler:", isHustler);
        
        // Fetch completed jobs using the dedicated /jobs/completed endpoint
        console.log("🔵 Fetching completed jobs from /jobs/completed");
        let completedJobs = [];
        
        try {
          const completedJobsResponse = await fetch(`${API_BASE}/jobs/completed`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (completedJobsResponse.ok) {
            const jobs = await completedJobsResponse.json();
            if (Array.isArray(jobs)) {
              completedJobs = jobs;
              console.log("✅ Fetched completed jobs:", completedJobs.length, "jobs");
              if (completedJobs.length > 0) {
                console.log("🔵 Sample completed job:", {
                  id: completedJobs[0].id,
                  status: completedJobs[0].status,
                  completionCodeVerified: completedJobs[0].completionCodeVerified,
                  customerId: completedJobs[0].customerId,
                  hustlerId: completedJobs[0].hustlerId
                });
              }
            } else {
              console.warn("⚠️ Response is not an array:", jobs);
              completedJobs = [];
            }
          } else {
            const errorText = await completedJobsResponse.text();
            console.error("❌ Failed to fetch completed jobs:", completedJobsResponse.status, errorText);
            completedJobsList.innerHTML = `<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Failed to load completed jobs (${completedJobsResponse.status}). Please try again.</div>`;
            completedJobsList.dataset.loading = 'false';
            return;
          }
        } catch (error) {
          console.error("❌ Error fetching completed jobs:", error);
          completedJobsList.innerHTML = `<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading completed jobs: ${error.message}. Please try again.</div>`;
          completedJobsList.dataset.loading = 'false';
          return;
        }
        
        console.log("🔵 Completed jobs count:", completedJobs.length);
        
        // Jobs are already sorted by updatedAt desc from the API, but we can ensure it
        completedJobs.sort((a, b) => {
          const dateA = new Date(a.updatedAt || a.completedAt || a.createdAt);
          const dateB = new Date(b.updatedAt || b.completedAt || b.createdAt);
          return dateB - dateA;
        });
        
        // Pagination: show 5 jobs initially, then load more
        const jobsToShow = reset ? completedJobs.slice(0, 5) : completedJobs.slice(0, completedJobsPage * 5);
        hasMoreCompletedJobs = completedJobs.length > jobsToShow.length;
        
        if (reset) {
          completedJobsList.innerHTML = "";
          completedJobsLoaded = [];
        }
        
        if (jobsToShow.length === 0 && completedJobsLoaded.length === 0) {
          completedJobsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No completed jobs yet</div>
              <div style="color: var(--text-muted);">Complete your first job to see it here!</div>
            </div>
          `;
          completedJobsList.dataset.loaded = 'true';
          completedJobsList.dataset.loading = 'false';
          return;
        }
        
        // Render job cards
        for (const job of jobsToShow) {
          // Skip if already rendered
          if (completedJobsLoaded.includes(job.id)) continue;
          completedJobsLoaded.push(job.id);
          
          // Determine role for THIS SPECIFIC JOB (not just user's general roles)
          const isCustomerForThisJob = job.customerId === user.id;
          const isHustlerForThisJob = job.hustlerId === user.id;
          
          // Payment is already included in job from /jobs/completed endpoint
          // Use it directly - it may be null for some completed jobs
          let payment = job.payment || null;
          
          // Get other user info based on role in this job
          const otherUser = isCustomerForThisJob ? (job.hustler || {}) : (job.customer || {});
          
          // Check if tip already added (only for customers of this job)
          // Convert tip to number in case it's a Decimal type from Prisma
          let tipAmount = payment ? Number(payment.tip || 0) : 0;
          
          // If we're the customer, ALWAYS try fetching fresh payment data to check for tips
          // This helps when webhook just processed the tip but job data hasn't refreshed
          let hasPendingTip = false;
          if (isCustomerForThisJob) {
            // Check if there's a pending tip in sessionStorage (in case webhook hasn't processed yet)
            hasPendingTip = sessionStorage.getItem(`tipPending_${job.id}`) === 'true';
            
            // Always fetch fresh payment data to ensure we have the latest tip information
            try {
              const paymentResponse = await fetch(`${API_BASE}/payments/job/${job.id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (paymentResponse.ok) {
                const freshPayment = await paymentResponse.json();
                if (freshPayment) {
                  payment = freshPayment; // Use fresh payment data
                  const freshTipAmount = Number(freshPayment.tip || 0);
                  tipAmount = freshTipAmount; // Always use fresh tip amount
                  if (freshTipAmount > 0) {
                    console.log(`[TIP CHECK] Found tip in fresh payment data: $${tipAmount.toFixed(2)}`);
                    // Clear pending flag if tip is now in database
                    if (hasPendingTip) {
                      sessionStorage.removeItem(`tipPending_${job.id}`);
                      hasPendingTip = false;
                    }
                  } else {
                    console.log(`[TIP CHECK] No tip found in fresh payment data`);
                    if (hasPendingTip) {
                      console.log(`[TIP CHECK] But found pending tip in sessionStorage for job ${job.id}`);
                    }
                  }
                }
              }
            } catch (e) {
              // Silently fail - use existing payment data
              console.log('[TIP CHECK] Could not fetch fresh payment data:', e);
            }
          }
          
          // Only consider it tipped if tipAmount > 0 in database (ignore sessionStorage if database has value)
          // sessionStorage is only for temporary state during processing, but if database shows tip, that's the truth
          const hasTipped = isCustomerForThisJob && tipAmount > 0;
          
          // Clear any stale pending tip flags if tip is in database
          if (hasTipped && hasPendingTip) {
            try {
              sessionStorage.removeItem(`tipPending_${job.id}`);
            } catch (e) {
              // Ignore errors
            }
          }
          
          // Debug logging for tip detection
          if (isCustomerForThisJob) {
            console.log(`[TIP CHECK] Job ${job.id}: payment=${!!payment}, payment.tip=${payment?.tip}, tipAmount=${tipAmount.toFixed(2)}, hasTipped=${hasTipped}, hasPendingTip=${hasPendingTip}`);
          }
          
          // Check if user has already reviewed (reviews have reviewerId field)
          const hasReviewed = job.reviews && job.reviews.some(r => r.reviewerId === user.id);
          const userReview = job.reviews && job.reviews.find(r => r.reviewerId === user.id);
          
          // Format completion date
          const completedDate = job.updatedAt || job.completedAt || job.createdAt;
          const completedDateObj = new Date(completedDate);
          const completedDateStr = completedDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
          
          // Create card with more padding and better styling
          const card = document.createElement("div");
          card.style.cssText = "padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white; box-shadow: 0 2px 6px rgba(0,0,0,0.08); transition: all 0.2s; cursor: pointer;";
          card.onmouseenter = () => { 
            card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.12)'; 
            card.style.transform = 'translateY(-2px)';
            card.style.borderColor = 'var(--primary)';
          };
          card.onmouseleave = () => { 
            card.style.boxShadow = '0 2px 6px rgba(0,0,0,0.08)';
            card.style.transform = 'translateY(0)';
            card.style.borderColor = 'var(--border)';
          };
          
          card.innerHTML = `
            <div style="margin-bottom: 1rem;">
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.5rem; line-height: 1.3;">${job.title || 'Untitled Job'}</div>
              <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                <strong>${isCustomerForThisJob ? 'Hustler' : 'Customer'}:</strong> <span style="color: var(--text-main); font-weight: 600;">${otherUser?.name || 'Unknown'}</span>
              </div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">Completed: ${completedDateStr}</div>
            </div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
              ${isCustomerForThisJob ? `
                ${hasTipped ? `
                  <div style="flex: 1; min-width: 120px; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; border: 2px solid #10b981; color: #10b981; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span>💚 Thanks for tipping!</span>
                    ${tipAmount > 0 ? `
                      <button class="btn btn-ghost viewTipBtn" data-job-id="${job.id}" data-tip-amount="${tipAmount.toFixed(2)}" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; font-weight: 600; color: #059669; background: transparent; border: 1px solid #10b981; border-radius: 6px; cursor: pointer; margin-left: 0.5rem;">View Tip ($${tipAmount.toFixed(2)})</button>
                    ` : ''}
                  </div>
                ` : `
                  <button class="btn btn-primary tipBtn" data-job-id="${job.id}" style="flex: 1; min-width: 120px; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; border: 2px solid var(--primary); border-radius: 8px;">💝 Tip</button>
                `}
              ` : ''}
              ${hasReviewed ? `
                <button class="btn btn-ghost viewReviewBtn" data-job-id="${job.id}" data-review-id="${userReview?.id || ''}" style="flex: 1; min-width: 120px; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; border: 2px solid #f59e0b; color: #f59e0b; border-radius: 8px;">📝 View Written Review</button>
              ` : `
                <button class="btn btn-primary reviewBtn" data-job-id="${job.id}" style="flex: 1; min-width: 120px; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; border: 2px solid var(--primary); border-radius: 8px;">⭐ Review</button>
              `}
            </div>
          `;
          
          // If tip is in "Processing..." state, start aggressive polling for updates
          if (hasTipped && hasPendingTip && tipAmount === 0) {
            // Poll more aggressively - every 1 second for first 10 seconds, then every 3 seconds
            let pollAttempts = 0;
            const maxAttempts = 60; // Increased to 60 attempts (2 minutes total)
            let pollInterval;
            
            const pollForTip = async () => {
              pollAttempts++;
              if (pollAttempts > maxAttempts) {
                clearInterval(pollInterval);
                console.log(`[TIP POLL] Stopped polling for job ${job.id} after ${maxAttempts} attempts`);
                return;
              }
              
              try {
                const paymentResponse = await fetch(`${API_BASE}/payments/job/${job.id}`, {
                  headers: { 'Authorization': `Bearer ${token}` },
                  cache: 'no-cache' // Force fresh data
                });
                if (paymentResponse.ok) {
                  const freshPayment = await paymentResponse.json();
                  const freshTipAmount = Number(freshPayment?.tip || 0);
                  if (freshTipAmount > 0) {
                    // Tip has been processed! Clear flag and refresh immediately
                    console.log(`[TIP POLL] Tip found! Amount: $${freshTipAmount.toFixed(2)}`);
                    clearInterval(pollInterval);
                    sessionStorage.removeItem(`tipPending_${job.id}`);
                    // Force immediate refresh of this specific job card
                    if (typeof loadCompletedJobs === 'function') {
                      loadCompletedJobs(true);
                    }
                    return; // Stop polling
                  }
                }
              } catch (e) {
                console.log('[TIP POLL] Error polling for tip:', e);
              }
            };
            
            // Start with aggressive polling (every 1 second for first 10 seconds)
            pollInterval = setInterval(pollForTip, 1000);
            
            // After 10 seconds, switch to less frequent polling (every 3 seconds)
            setTimeout(() => {
              if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = setInterval(pollForTip, 3000);
              }
            }, 10000);
          }
          
          // Event listeners
          card.querySelector('.tipBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const jobId = e.target.dataset.jobId;
            const tipBtn = e.target;
            // Open tip modal
            const handleTipSuccess = (tipAmount = 0) => {
              // Replace tip button with "Thanks for tipping" message and view tip button
              const tipContainer = tipBtn.parentElement;
              tipBtn.remove();
              
              const thanksDiv = document.createElement('div');
              thanksDiv.style.cssText = 'flex: 1; min-width: 120px; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; border: 2px solid #10b981; color: #10b981; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;';
              thanksDiv.innerHTML = `
                <span>💚 Thanks for tipping!</span>
                <button class="btn btn-ghost viewTipBtn" data-job-id="${jobId}" data-tip-amount="${tipAmount.toFixed(2)}" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; font-weight: 600; color: #059669; background: transparent; border: 1px solid #10b981; border-radius: 6px; cursor: pointer; margin-left: 0.5rem;">View Tip ($${tipAmount.toFixed(2)})</button>
              `;
              
              // Add event listener for view tip button
              const viewTipBtn = thanksDiv.querySelector('.viewTipBtn');
              viewTipBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                showToast(`💚 You tipped $${tipAmount.toFixed(2)} for this job!`, 'success', 4000);
              });
              
              tipContainer.appendChild(thanksDiv);
            };
            
            if (typeof window.showTipModal === 'function') {
              window.showTipModal(jobId, job, payment, handleTipSuccess);
            } else {
              // Fallback: show tip input directly
              showTipInputModal(jobId, job, payment, handleTipSuccess);
            }
          });
          
          // View tip button (shows tip amount in a toast)
          card.querySelector('.viewTipBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const tipAmount = parseFloat(e.target.dataset.tipAmount || 0);
            showToast(`💚 You tipped $${tipAmount.toFixed(2)} for this job!`, 'success', 4000);
          });
          
          card.querySelector('.reviewBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const jobId = e.target.dataset.jobId;
            const revieweeId = isCustomerForThisJob ? job.hustlerId : job.customerId;
            const revieweeName = isCustomerForThisJob ? (job.hustler?.name || 'Hustler') : (job.customer?.name || 'Customer');
            // Open review modal with proper star rating
            if (typeof window.showReviewModal === 'function') {
              window.showReviewModal(jobId, revieweeId, revieweeName);
            } else {
              // Fallback: show review input directly
              showReviewInputModal(jobId, revieweeId, isCustomerForThisJob ? 'hustler' : 'customer');
            }
          });
          
          card.querySelector('.viewReviewBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const jobId = e.target.dataset.jobId;
            const reviewId = e.target.dataset.reviewId;
            // Show review in popup
            showReviewDetailsModal(jobId, reviewId, userReview);
          });
          
          // Make card clickable to open details popup
          card.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
              openCompletedJobDetails(job.id, job, payment, isCustomerForThisJob, isHustlerForThisJob);
            }
          });
          
          completedJobsList.appendChild(card);
        }
        
        // Add "Load More" button if there are more jobs
        if (hasMoreCompletedJobs) {
          const existingLoadMore = completedJobsList.querySelector('.loadMoreCompletedJobsBtn');
          if (existingLoadMore) {
            existingLoadMore.remove();
          }
          
          const loadMoreBtn = document.createElement('button');
          loadMoreBtn.className = 'loadMoreCompletedJobsBtn btn btn-ghost';
          loadMoreBtn.style.cssText = 'width: 100%; padding: 1rem; margin-top: 1rem; font-weight: 600; border: 2px solid var(--primary); color: var(--primary);';
          loadMoreBtn.textContent = `Load More (${completedJobs.length - jobsToShow.length} remaining)`;
          loadMoreBtn.addEventListener('click', () => {
            completedJobsPage++;
            loadCompletedJobs(false);
          });
          completedJobsList.appendChild(loadMoreBtn);
        } else {
          const existingLoadMore = completedJobsList.querySelector('.loadMoreCompletedJobsBtn');
          if (existingLoadMore) {
            existingLoadMore.remove();
          }
        }
        
        completedJobsList.dataset.loaded = 'true';
        completedJobsList.dataset.loading = 'false';
        console.log("✅ loadCompletedJobs completed successfully. Rendered", jobsToShow.length, "jobs");
        
      } catch (error) {
        console.error("❌ Error loading completed jobs:", error);
        console.error("Error stack:", error.stack);
        if (completedJobsList) {
          completedJobsList.innerHTML = `
            <div style='text-align: center; padding: 2rem; color: var(--text-muted);'>
              <div style="font-size: 1.1rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem;">Error loading completed jobs</div>
              <div style="margin-bottom: 1rem; font-size: 0.9rem;">${error.message || 'Please refresh and try again.'}</div>
              <button class="btn btn-primary" onclick="if(typeof loadCompletedJobs === 'function') loadCompletedJobs(true)" style="padding: 0.75rem 1.5rem;">Retry</button>
            </div>
          `;
          completedJobsList.dataset.loading = 'false';
        }
      }
    }
    
    // Open completed job details popup
    async function openCompletedJobDetails(jobId, jobData = null, paymentData = null, isCustomer = null, isHustler = null) {
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          showToast('Please log in to view job details.');
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          showToast('Please log in to view job details.');
          return;
        }
        
        // Fetch job data if not provided
        let job = jobData;
        
        // Determine user role for THIS SPECIFIC JOB (not general roles)
        // Check if user is customer or hustler for this particular job
        if (isCustomer === null || isHustler === null) {
          isCustomer = job.customerId === user.id;
          isHustler = job.hustlerId === user.id;
        }
        
        console.log('🔵 Job role check - customerId:', job.customerId, 'hustlerId:', job.hustlerId, 'userId:', user.id, 'isCustomer:', isCustomer, 'isHustler:', isHustler);
        if (!job) {
          const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!jobResponse.ok) {
            throw new Error('Failed to fetch job details');
          }
          job = await jobResponse.json();
        }
        
        // Fetch reviews if not included
        if (!job.reviews || job.reviews.length === 0) {
          try {
            const reviewsResponse = await fetch(`${API_BASE}/reviews/job/${jobId}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (reviewsResponse.ok) {
              const reviews = await reviewsResponse.json();
              job.reviews = Array.isArray(reviews) ? reviews : [];
            }
          } catch (e) {
            console.error("Error fetching reviews:", e);
            job.reviews = [];
          }
        }
        
        // Fetch payment data - always fetch fresh for customers to get latest tip status
        let payment = paymentData;
        if (!payment || isCustomer) {
          try {
            const paymentResponse = await fetch(`${API_BASE}/payments/job/${jobId}`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (paymentResponse.ok) {
              const freshPayment = await paymentResponse.json();
              if (freshPayment) {
                payment = freshPayment; // Always use fresh payment data
              }
            }
          } catch (e) {
            console.error("Error fetching payment:", e);
          }
        }
        
        // Get other user based on role in THIS job
        const otherUser = isCustomer ? (job.hustler || {}) : (job.customer || {});
        
        // Check if tip already added (only for customers of this job)
        // Always check payment.tip from database (not sessionStorage)
        // Convert tip to number in case it's a Decimal type from Prisma
        const tipAmount = payment ? Number(payment.tip || 0) : 0;
        const hasTipped = isCustomer && tipAmount > 0;
        
        // Clear any pending tip flag from sessionStorage if tip is now in database
        if (isCustomer && tipAmount > 0) {
          try {
            sessionStorage.removeItem(`tipPending_${jobId}`);
          } catch (e) {
            // Ignore errors clearing sessionStorage
          }
        }
        
        console.log('🔵 Popup role check - isCustomer:', isCustomer, 'isHustler:', isHustler, 'hasTipped:', hasTipped);
        
        // Calculate amounts - ensure all are numbers
        // For hourly jobs: payment.amount is the actual amount charged (updated after completion)
        // For flat jobs: use payment.amount if it exists (negotiated price), otherwise job.amount
        const payType = job.payType || 'flat';
        let jobAmount = 0;
        if (payType === 'hourly') {
          // For hourly jobs, payment.amount is the actual amount charged (hours worked × rate)
          // If payment doesn't exist yet, fall back to estimated
          jobAmount = payment && payment.amount ? parseFloat(payment.amount) : (parseFloat(job.hourlyRate || 0) * parseFloat(job.estHours || 0));
        } else {
          // For flat jobs, use payment.amount if it exists (negotiated price), otherwise job.amount
          jobAmount = payment && payment.amount ? parseFloat(payment.amount) : parseFloat(job.amount || 0);
        }
        jobAmount = Number(jobAmount);
        
        // Get actual hours worked for hourly jobs (stored in requirements.actualHours)
        let actualHours = null;
        if (payType === 'hourly' && job.requirements) {
          const requirements = typeof job.requirements === 'string' ? JSON.parse(job.requirements) : job.requirements;
          actualHours = requirements?.actualHours || null;
        }
        
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'completedJobDetailModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.75);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          border-radius: 16px;
          padding: 2rem;
          max-width: 600px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 25px 50px rgba(0,0,0,0.5);
          position: relative;
        `;
        
        // Format completion date
        const completedDate = job.updatedAt || job.completedAt || job.createdAt;
        const completedDateObj = new Date(completedDate);
        const completedDateStr = completedDateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        
        // Reviews section
        const reviews = job.reviews || [];
        const userReview = reviews.find(r => r.reviewerId === user.id);
        
        // Build modal content based on user role
        console.log('🔵 Building completed job modal - isCustomer:', isCustomer, 'isHustler:', isHustler, 'jobId:', jobId);
        let modalHTML = '';
        
        if (isCustomer) {
          // CUSTOMER VIEW: Full payment details, Tip, Review, Completed by, Job info
          // For hourly jobs, calculate refund amount (original authorized - actual charged)
          let originalAuthorizedAmount = jobAmount;
          let refundAmount = 0;
          if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
            // Original authorized amount = hourlyRate × estHours
            originalAuthorizedAmount = Number(job.hourlyRate) * Number(job.estHours);
            // Refund = original authorized - actual charged (payment.amount is the actual amount charged)
            refundAmount = Math.max(0, originalAuthorizedAmount - jobAmount);
          }
          
          // Service fee is 6.5% of the actual amount charged
          // Use stored feeCustomer from payment record if available (more accurate), otherwise calculate
          const serviceFee = payment && payment.feeCustomer ? Number(payment.feeCustomer) : Number(jobAmount * 0.065);
          // Get tip amount - check payment.tip from database, not sessionStorage
          const tipAmount = Number(payment?.tip || 0);
          const totalPaid = Number(jobAmount + serviceFee);
          
          modalHTML = `
            <button id="closeCompletedJobModal" style="position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; border: none; background: #f3f4f6; color: var(--text-main); font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 1;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">×</button>
            
            <div style="margin-bottom: 1.5rem;">
              <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--text-main); margin: 0 0 0.5rem 0;">${job.title || 'Untitled Job'}</h2>
              <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Completed: ${completedDateStr}</div>
            </div>
            
            <!-- Completed by Hustler Section -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #10b981;">
              ${otherUser && otherUser.id ? renderUserAvatar(otherUser, 70, { 
                className: 'viewHustlerProfileBtn',
                'data-user-id': otherUser.id
              }) : '<div style="width: 70px; height: 70px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 1.75rem;">H</div>'}
              <div style="flex: 1;">
                <div style="font-size: 0.85rem; color: #047857; margin-bottom: 0.25rem; font-weight: 600;">✅ Completed by Hustler</div>
                <div style="font-weight: 700; font-size: 1.2rem; color: var(--text-main); cursor: pointer;" class="viewHustlerProfileBtn" data-user-id="${otherUser?.id || ''}">${otherUser?.name || 'Unknown'}</div>
              </div>
            </div>
            
            <!-- Full Payment Details -->
            <div style="padding: 1.5rem; background: #eff6ff; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
              <div style="font-weight: 700; font-size: 1.2rem; color: #1e40af; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                💳 Payment Details
              </div>
              <div style="font-size: 0.95rem; color: #1e3a8a; line-height: 2;">
                ${job.payType === 'hourly' && actualHours !== null ? `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #dcfce7; border-radius: 8px; border-left: 4px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 1rem;">⏱️ Time Worked</div>
                  <div style="font-size: 1.1rem; color: #065f46;">
                    Hustler worked <strong>${actualHours.toFixed(2)} hours</strong> at <strong>$${Number(job.hourlyRate).toFixed(2)}/hr</strong>
                  </div>
                </div>
                ` : ''}
                ${job.payType === 'hourly' && actualHours !== null && refundAmount > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.75rem; background: #dcfce7; border-radius: 6px; border-left: 3px solid #10b981;">
                  <span>Original Amount Authorized:</span>
                  <strong>$${originalAuthorizedAmount.toFixed(2)}</strong>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                  <span>${job.payType === 'hourly' ? 'Amount Charged' : 'Job Amount Charged'}:</span>
                  <strong>$${jobAmount.toFixed(2)}</strong>
                </div>
                ${job.payType === 'hourly' && actualHours !== null && refundAmount > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;">
                  <span>💚 Refunded (Unused Time):</span>
                  <strong style="color: #059669;">-$${refundAmount.toFixed(2)}</strong>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                  <span>Service Fee (6.5%):</span>
                  <strong>$${serviceFee.toFixed(2)}</strong>
                </div>
                ${tipAmount > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #93c5fd;">
                  <span>💝 Tip:</span>
                  <strong style="color: #059669;">+$${tipAmount.toFixed(2)}</strong>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #3b82f6; font-weight: 700; font-size: 1.15rem;">
                  <span>Total Paid:</span>
                  <strong style="color: #1e40af; font-size: 1.3rem;">$${Number(totalPaid + tipAmount).toFixed(2)}</strong>
                </div>
                ${job.payType === 'hourly' && actualHours !== null && refundAmount > 0 ? `
                <div style="margin-top: 1rem; padding: 0.75rem; background: #dcfce7; border-radius: 6px; border-left: 3px solid #10b981; font-size: 0.85rem; color: #047857; line-height: 1.4;">
                  💚 <strong>$${refundAmount.toFixed(2)}</strong> was automatically refunded to your original payment method for unused time.
                </div>
                ` : ''}
                ${payment && payment.paymentMethod ? `
                  <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #93c5fd; font-size: 0.85rem; color: #475569;">
                    Payment Method: <strong>${payment.paymentMethod}</strong>
                  </div>
                ` : ''}
              </div>
            </div>
            
            <!-- Tip Section (Customer Only) -->
            ${hasTipped ? `
              <div style="padding: 1.5rem; background: #dcfce7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #10b981;">
                <div style="font-weight: 700; font-size: 1.1rem; color: #059669; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  💚 Thanks for Tipping!
                </div>
                <div style="font-size: 0.95rem; color: #047857;">
                  You tipped <strong>$${tipAmount.toFixed(2)}</strong> for this job. Thank you for your appreciation!
                </div>
              </div>
            ` : `
              <div style="padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #f59e0b;">
                <div style="font-weight: 700; font-size: 1.2rem; color: #92400e; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  💝 Tip Your Hustler
                </div>
                <div style="font-size: 0.95rem; color: #78350f; margin-bottom: 1rem; line-height: 1.5;">
                  Show your appreciation for a job well done! The tip goes directly to the hustler.
                </div>
                <button class="btn btn-primary tipHustlerBtn" data-job-id="${job.id}" style="width: 100%; padding: 1rem; font-weight: 600; background: #f59e0b; border-color: #f59e0b; font-size: 1rem; border-radius: 8px;">💝 Tip Your Hustler</button>
              </div>
            `}
            
            <!-- Review Section -->
            ${userReview ? `
              <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                <div style="font-weight: 700; font-size: 1.1rem; color: #92400e; margin-bottom: 1rem;">⭐ Your Review</div>
                <div style="font-size: 0.95rem; color: #78350f; line-height: 1.6;">
                  <div style="margin-bottom: 0.75rem;">Rating: <strong style="font-size: 1.1rem;">${'⭐'.repeat(userReview.stars || userReview.rating || 0)} ${userReview.stars || userReview.rating || 0}/5</strong></div>
                  ${userReview.text ? `<div style="padding: 1rem; background: white; border-radius: 8px; white-space: pre-wrap; color: var(--text-main);">${userReview.text}</div>` : ''}
                </div>
              </div>
            ` : `
              <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                <div style="font-weight: 700; font-size: 1.2rem; color: #92400e; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  ⭐ Rate Your Hustler
                </div>
                <div style="font-size: 0.95rem; color: #78350f; margin-bottom: 1rem; line-height: 1.5;">
                  Share your experience to help other customers and recognize great work!
                </div>
                <button class="btn btn-primary rateCompletedJobBtn" data-job-id="${job.id}" style="width: 100%; padding: 1rem; font-weight: 600; background: #f59e0b; border-color: #f59e0b; font-size: 1rem; border-radius: 8px;">⭐ Rate Your Hustler</button>
              </div>
            `}
            
            <!-- Job Information -->
            <div style="padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--border);">
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                📋 Job Information
              </div>
              <div style="font-size: 0.95rem; color: var(--text-main); line-height: 1.8;">
                <div style="margin-bottom: 0.75rem;"><strong>Category:</strong> ${job.category || 'Other'}</div>
                <div style="margin-bottom: 0.75rem;"><strong>Description:</strong> ${job.description || 'No description'}</div>
                <div style="margin-bottom: 0.75rem;"><strong>Completed:</strong> ${completedDateStr}</div>
              </div>
            </div>
          `;
        } else if (isHustler) {
          // HUSTLER VIEW: Earnings (How much you made), Review, Job info
          // For hourly jobs: jobAmount is the actual amount charged (already updated in payment.amount)
          const platformFee = Number(jobAmount * 0.12);
          const earnings = Number(jobAmount - platformFee);
          const tipAmount = Number(payment?.tip || 0);
          const totalEarnings = Number(earnings + tipAmount);
          
          modalHTML = `
            <button id="closeCompletedJobModal" style="position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; border: none; background: #f3f4f6; color: var(--text-main); font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 1;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">×</button>
            
            <div style="margin-bottom: 1.5rem;">
              <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--text-main); margin: 0 0 0.5rem 0;">${job.title || 'Untitled Job'}</h2>
              <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Completed: ${completedDateStr}</div>
            </div>
            
            <!-- Completed for Customer Section -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; border: 2px solid #3b82f6;">
              ${otherUser && otherUser.id ? renderUserAvatar(otherUser, 70, { 
                className: 'viewCustomerProfileBtn',
                'data-user-id': otherUser.id
              }) : '<div style="width: 70px; height: 70px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 1.75rem;">C</div>'}
              <div style="flex: 1;">
                <div style="font-size: 0.85rem; color: #1e40af; margin-bottom: 0.25rem; font-weight: 600;">✅ Completed for Customer</div>
                <div style="font-weight: 700; font-size: 1.2rem; color: var(--text-main); cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${otherUser?.id || ''}">${otherUser?.name || 'Unknown'}</div>
              </div>
            </div>
            
            <!-- How Much You Made (Earnings) -->
            <div style="padding: 1.5rem; background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #10b981;">
              <div style="font-weight: 700; font-size: 1.3rem; color: #059669; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                💰 How Much You Made
              </div>
              <div style="font-size: 1rem; color: #047857; line-height: 2;">
                ${job.payType === 'hourly' && actualHours !== null ? `
                <div style="margin-bottom: 1rem; padding: 1rem; background: #bbf7d0; border-radius: 8px; border-left: 4px solid #059669;">
                  <div style="font-weight: 600; color: #065f46; margin-bottom: 0.5rem; font-size: 1rem;">⏱️ Time Worked</div>
                  <div style="font-size: 1.1rem; color: #047857;">
                    You worked <strong>${actualHours.toFixed(2)} hours</strong> at <strong>$${Number(job.hourlyRate).toFixed(2)}/hr</strong>
                  </div>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                  <span>${job.payType === 'hourly' ? 'Amount Earned' : 'Job Amount'}:</span>
                  <strong>$${jobAmount.toFixed(2)}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                  <span>Platform Fee (12%):</span>
                  <strong style="color: #dc2626;">-$${platformFee.toFixed(2)}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #86efac;">
                  <span>Base Earnings:</span>
                  <strong>$${earnings.toFixed(2)}</strong>
                </div>
                ${tipAmount > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #86efac;">
                  <span>💝 Tip:</span>
                  <strong style="color: #059669;">+$${tipAmount.toFixed(2)}</strong>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-top: 1rem; padding-top: 1rem; border-top: 3px solid #10b981; font-weight: 700; font-size: 1.4rem;">
                  <span>Total Earnings:</span>
                  <strong style="color: #059669; font-size: 1.6rem;">$${totalEarnings.toFixed(2)}</strong>
                </div>
                ${user.stripeAccountId ? `
                  <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #86efac; font-size: 0.85rem; color: #065f46;">
                    ✅ Paid to: <strong>Stripe Account (${user.stripeAccountId.substring(0, 20)}...)</strong>
                  </div>
                ` : `
                  <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #fbbf24; font-size: 0.9rem; color: #92400e; background: #fef3c7; padding: 0.75rem; border-radius: 6px;">
                    ⚠️ Stripe account not connected. Connect in Profile settings to receive payments.
                  </div>
                `}
              </div>
            </div>
            
            <!-- Review Section (Hustler) -->
            ${userReview ? `
              <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                <div style="font-weight: 700; font-size: 1.1rem; color: #92400e; margin-bottom: 1rem;">⭐ Your Review</div>
                <div style="font-size: 0.95rem; color: #78350f; line-height: 1.6;">
                  <div style="margin-bottom: 0.75rem;">Rating: <strong style="font-size: 1.1rem;">${'⭐'.repeat(userReview.stars || userReview.rating || 0)} ${userReview.stars || userReview.rating || 0}/5</strong></div>
                  ${userReview.text ? `<div style="padding: 1rem; background: white; border-radius: 8px; white-space: pre-wrap; color: var(--text-main);">${userReview.text}</div>` : ''}
                </div>
              </div>
            ` : `
              <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                <div style="font-weight: 700; font-size: 1.2rem; color: #92400e; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  ⭐ Rate Your Customer
                </div>
                <div style="font-size: 0.95rem; color: #78350f; margin-bottom: 1rem; line-height: 1.5;">
                  Share your experience working with this customer to help other hustlers!
                </div>
                <button class="btn btn-primary rateCompletedJobBtn" data-job-id="${job.id}" style="width: 100%; padding: 1rem; font-weight: 600; background: #f59e0b; border-color: #f59e0b; font-size: 1rem; border-radius: 8px;">⭐ Rate Your Customer</button>
              </div>
            `}
            
            <!-- Job Information -->
            <div style="padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1rem; border: 1px solid var(--border);">
              <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                📋 Job Information
              </div>
              <div style="font-size: 0.95rem; color: var(--text-main); line-height: 1.8;">
                <div style="margin-bottom: 0.75rem;"><strong>Category:</strong> ${job.category || 'Other'}</div>
                <div style="margin-bottom: 0.75rem;"><strong>Description:</strong> ${job.description || 'No description'}</div>
                <div style="margin-bottom: 0.75rem;"><strong>Completed:</strong> ${completedDateStr}</div>
              </div>
            </div>
          `;
        }
        
        modalContent.innerHTML = modalHTML;
        console.log('✅ Modal HTML built for', isCustomer ? 'CUSTOMER' : 'HUSTLER');
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Event listeners
        modal.querySelector('#closeCompletedJobModal')?.addEventListener('click', () => {
          document.body.removeChild(modal);
          document.body.style.overflow = '';
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = '';
          }
        });
        
        modal.querySelector('.rateCompletedJobBtn')?.addEventListener('click', async (e) => {
          e.stopPropagation();
          const jobId = e.target.dataset.jobId;
          const revieweeId = isCustomer ? job.hustlerId : job.customerId;
          const revieweeName = isCustomer ? (job.hustler?.name || 'Hustler') : (job.customer?.name || 'Customer');
          // Close modal first
          document.body.removeChild(modal);
          document.body.style.overflow = '';
          // Open review modal with proper star rating
          if (typeof window.showReviewModal === 'function') {
            window.showReviewModal(jobId, revieweeId, revieweeName);
          } else {
            showToast('Rating feature coming soon!');
          }
        });
        
        modal.querySelectorAll('.viewHustlerProfileBtn, .viewCustomerProfileBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const userId = btn.dataset.userId;
            if (userId && typeof window.showHustlerProfilePopup === 'function') {
              window.showHustlerProfilePopup(userId);
            }
          });
        });
        
        modal.querySelector('.tipHustlerBtn')?.addEventListener('click', async (e) => {
          e.stopPropagation();
          const jobId = e.target.dataset.jobId;
          // Close modal first
          document.body.removeChild(modal);
          document.body.style.overflow = '';
          // Show tip modal
          if (typeof window.showTipInputModal === 'function') {
            window.showTipInputModal(jobId, job, payment);
          } else {
            showToast('Tip feature coming soon! You can contact support at team.hustlapp@outlook.com to send a tip.');
          }
        });
        
      } catch (error) {
        console.error('Error opening completed job details:', error);
        showToast('Failed to load job details. Please try again.');
      }
    }
    
    // Show tip input modal with Stripe payment
    async function showTipInputModal(jobId, jobData, paymentData) {
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user) {
        showToast('Please log in to add a tip.');
        return;
      }
      
      const token = localStorage.getItem('hustl_token');
      if (!token) {
        showToast('Please log in to add a tip.');
        return;
      }
      
      // Fetch job data to get current payment info
      let job = jobData;
      if (!job) {
        try {
          const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (jobResponse.ok) {
            job = await jobResponse.json();
          }
        } catch (e) {
          console.error("Error fetching job:", e);
          showToast('Failed to load job information.');
          return;
        }
      }
      
      // Use payment from job or provided payment data
      let payment = paymentData || job?.payment || null;
      
      // Check if already tipped
      if (payment && payment.tip && payment.tip > 0) {
        showToast(`You've already tipped $${payment.tip.toFixed(2)} for this job.`);
        return;
      }
      
      // Ensure user is customer for THIS job (only customers can tip)
      const isCustomerForJob = job.customerId === user.id;
      
      if (!isCustomerForJob) {
        showToast('Only the customer for this job can tip the hustler.');
        return;
      }
      
      // Calculate max tip based on job amount (from payment or job itself)
      const jobAmount = Number(payment?.amount || job?.amount || 0);
      const maxTip = Math.min(jobAmount * 0.25, 50); // 25% or $50, whichever is lower
      
      const modal = document.createElement('div');
      modal.id = 'tipModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 1rem;
        overflow-y: auto;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        position: relative;
      `;
      
      modalContent.innerHTML = `
        <button id="closeTipModal" style="position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; border: none; background: #f3f4f6; color: var(--text-main); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">×</button>
        
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 0 0 1rem 0;">💝 Tip Your Hustler</h2>
        <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem;">Show your appreciation for a job well done! The tip will go directly to the hustler.</p>
        
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">Tip Amount</label>
          <div style="position: relative;">
            <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-weight: 600;">$</span>
            <input type="number" id="tipAmountInput" min="0.01" max="${maxTip}" step="0.01" placeholder="0.00" style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; font-weight: 600;" />
          </div>
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">Maximum tip: $${maxTip.toFixed(2)}</div>
        </div>
        
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
          <button class="quickTipBtn" data-amount="${Math.min(jobAmount * 0.15, 50).toFixed(2)}" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: white; color: var(--text-main); font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--primary)'" onmouseout="this.style.background='white'; this.style.borderColor='var(--border)'">15% ($${Math.min(jobAmount * 0.15, 50).toFixed(2)})</button>
          <button class="quickTipBtn" data-amount="${Math.min(jobAmount * 0.20, 50).toFixed(2)}" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: white; color: var(--text-main); font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--primary)'" onmouseout="this.style.background='white'; this.style.borderColor='var(--border)'">20% ($${Math.min(jobAmount * 0.20, 50).toFixed(2)})</button>
          <button class="quickTipBtn" data-amount="${Math.min(jobAmount * 0.25, 50).toFixed(2)}" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; background: white; color: var(--text-main); font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--primary)'" onmouseout="this.style.background='white'; this.style.borderColor='var(--border)'">25% ($${Math.min(jobAmount * 0.25, 50).toFixed(2)})</button>
        </div>
        
        <button id="submitTipBtn" style="width: 100%; padding: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">💝 Tip</button>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Quick tip buttons - update amount input
      modal.querySelectorAll('.quickTipBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const amount = parseFloat(btn.dataset.amount);
          document.getElementById('tipAmountInput').value = amount.toFixed(2);
        });
      });
      
      // Close button
      modal.querySelector('#closeTipModal')?.addEventListener('click', () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
          document.body.style.overflow = '';
        }
      });
      
      // Submit button - opens Stripe Checkout
      modal.querySelector('#submitTipBtn')?.addEventListener('click', async () => {
        const tipAmount = parseFloat(document.getElementById('tipAmountInput').value);
        
        if (!tipAmount || tipAmount <= 0) {
          showToast('Please enter a valid tip amount.');
          return;
        }
        
        if (tipAmount > maxTip) {
          showToast(`Maximum tip is $${maxTip.toFixed(2)}.`);
          return;
        }
        
        const submitBtn = modal.querySelector('#submitTipBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Opening checkout...';
        
        try {
          // Create Stripe Checkout Session
          const response = await fetch(`${API_BASE}/tips/create-checkout/job/${jobId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ tipAmount })
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.error || 'Failed to create checkout session');
          }
          
          // Redirect to Stripe Checkout
          // Store jobId in sessionStorage so we can update the button after return
          sessionStorage.setItem(`tipPending_${jobId}`, 'true');
          if (result.checkoutUrl) {
            window.location.href = result.checkoutUrl;
          } else {
            throw new Error('No checkout URL returned');
          }
        } catch (error) {
          console.error('Error creating tip checkout:', error);
          showToast(error.message || 'Failed to process tip. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = '💝 Tip';
        }
      });
    }
    
    // Show review input modal
    async function showReviewInputModal(jobId, revieweeId, revieweeType) {
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user) {
        showToast('Please log in to write a review.');
        return;
      }
      
      const token = localStorage.getItem('hustl_token');
      if (!token) {
        showToast('Please log in to write a review.');
        return;
      }
      
      const modal = document.createElement('div');
      modal.id = 'reviewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 1rem;
        overflow-y: auto;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        position: relative;
      `;
      
      modalContent.innerHTML = `
        <button id="closeReviewModal" style="position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; border: none; background: #f3f4f6; color: var(--text-main); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">×</button>
        
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 0 0 1rem 0;">⭐ Write a Review</h2>
        <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1.5rem;">Share your experience with this ${revieweeType}.</p>
        
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">Rating</label>
          <div id="starRating" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
            ${[1, 2, 3, 4, 5].map(i => `
              <button class="starBtn" data-rating="${i}" style="font-size: 2rem; background: none; border: none; cursor: pointer; color: #d1d5db; transition: color 0.2s; padding: 0;">⭐</button>
            `).join('')}
          </div>
          <div id="ratingText" style="font-size: 0.85rem; color: var(--text-muted); min-height: 1.2rem;"></div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">Review (minimum 10 characters)</label>
          <textarea id="reviewTextInput" rows="4" placeholder="Write your review here..." style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical;" maxlength="1000"></textarea>
          <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; text-align: right;"><span id="reviewCharCount">0</span>/1000 characters</div>
        </div>
        
        <button id="submitReviewBtn" style="width: 100%; padding: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Submit Review</button>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      let selectedRating = 0;
      
      // Star rating buttons
      modal.querySelectorAll('.starBtn').forEach((btn, index) => {
        btn.addEventListener('click', () => {
          selectedRating = index + 1;
          modal.querySelectorAll('.starBtn').forEach((b, i) => {
            if (i < selectedRating) {
              b.style.color = '#fbbf24';
            } else {
              b.style.color = '#d1d5db';
            }
          });
          
          const ratingTexts = {
            1: 'Poor',
            2: 'Fair',
            3: 'Good',
            4: 'Very Good',
            5: 'Excellent'
          };
          document.getElementById('ratingText').textContent = ratingTexts[selectedRating] || '';
        });
      });
      
      // Character count
      const textarea = document.getElementById('reviewTextInput');
      const charCount = document.getElementById('reviewCharCount');
      textarea.addEventListener('input', () => {
        charCount.textContent = textarea.value.length;
      });
      
      // Close button
      modal.querySelector('#closeReviewModal')?.addEventListener('click', () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
          document.body.style.overflow = '';
        }
      });
      
      // Submit button
      modal.querySelector('#submitReviewBtn')?.addEventListener('click', async () => {
        if (selectedRating === 0) {
          showToast('Please select a rating.');
          return;
        }
        
        const reviewText = textarea.value.trim();
        if (reviewText.length < 10) {
          showToast('Please write at least 10 characters in your review.');
          return;
        }
        
        const submitBtn = modal.querySelector('#submitReviewBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        try {
          const response = await fetch(`${API_BASE}/reviews`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              jobId,
              revieweeId,
              stars: selectedRating,
              text: reviewText
            })
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.error || 'Failed to submit review');
          }
          
          showToast('✅ Review submitted successfully!');
          
          // Close modal
          document.body.removeChild(modal);
          document.body.style.overflow = '';
          
          // Refresh completed jobs list
          if (typeof loadCompletedJobs === 'function') {
            loadCompletedJobs(true);
          }
        } catch (error) {
          console.error('Error submitting review:', error);
          showToast(error.message || 'Failed to submit review. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Review';
        }
      });
    }
    
    // Show review details modal
    function showReviewDetailsModal(jobId, reviewId, reviewData) {
      const modal = document.createElement('div');
      modal.id = 'reviewDetailsModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 1rem;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        position: relative;
      `;
      
      modalContent.innerHTML = `
        <button id="closeReviewDetailsModal" style="position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; border: none; background: #f3f4f6; color: var(--text-main); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">×</button>
        
        <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 0 0 1rem 0;">⭐ Your Review</h2>
        
        <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf24;">
          <div style="margin-bottom: 0.75rem;">
            <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">
              ${'⭐'.repeat(reviewData?.stars || 0)}${'☆'.repeat(5 - (reviewData?.stars || 0))}
            </div>
            <div style="font-size: 0.9rem; color: #78350f; font-weight: 600;">${reviewData?.stars || 0} out of 5 stars</div>
          </div>
          ${reviewData?.text ? `
            <div style="padding: 1rem; background: white; border-radius: 8px; margin-top: 0.75rem;">
              <div style="font-size: 0.95rem; color: var(--text-main); line-height: 1.6; white-space: pre-wrap;">${reviewData.text}</div>
            </div>
          ` : ''}
          ${reviewData?.createdAt ? `
            <div style="font-size: 0.75rem; color: #78350f; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #fbbf24;">
              Reviewed on ${new Date(reviewData.createdAt).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
            </div>
          ` : ''}
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Close button
      modal.querySelector('#closeReviewDetailsModal')?.addEventListener('click', () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
          document.body.style.overflow = '';
        }
      });
    }
    
    // Expose functions globally
    window.loadCompletedJobs = loadCompletedJobs;
    window.openCompletedJobDetails = openCompletedJobDetails;
    window.showTipModal = showTipInputModal;
    window.showTipInputModal = showTipInputModal;
    window.showReviewInputModal = showReviewInputModal;
    window.showReviewDetailsModal = showReviewDetailsModal;
    // Alias for compatibility
    window.showRatingModal = window.showReviewModal;
    
    // Load Applied Jobs (Hustler only)
    async function loadAppliedJobs() {
      console.log("🔵 loadAppliedJobs called");
      const appliedJobsList = document.getElementById("manageAppliedJobsList");
      if (!appliedJobsList) {
        console.error("❌ manageAppliedJobsList element not found");
        setTimeout(() => {
          const retry = document.getElementById("manageAppliedJobsList");
          if (retry) {
            console.log("✅ Found on retry, calling loadAppliedJobs again");
            loadAppliedJobs();
          } else {
            console.error("❌ Still not found after retry - DOM may not be ready");
          }
        }, 200);
        return;
      }
      
      if (appliedJobsList.dataset.loading === 'true') {
        console.log("⏸️ loadAppliedJobs already in progress, skipping");
        return;
      }
      appliedJobsList.dataset.loading = 'true';
      
      // Show loading state
      appliedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading...</div>";
      
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          appliedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your applications.</div>";
          appliedJobsList.dataset.loading = 'false';
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          appliedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your applications.</div>";
          appliedJobsList.dataset.loading = 'false';
          return;
        }
        
        console.log("🔵 Loading applied jobs for user:", user.id);
        
        // Fetch offers (applications)
        const response = await fetch(`${API_BASE}/offers/user/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("❌ Failed to fetch applied jobs:", response.status, errorText);
          throw new Error(`Failed to fetch applications: ${response.status} - ${errorText}`);
        }
        
        const allOffers = await response.json();
        console.log("🔵 Fetched all offers:", allOffers.length);
        
        // Filter to show only PENDING and ACCEPTED offers (not DECLINED)
        // ACCEPTED offers should auto-move to "Active Jobs" when job status becomes IN_PROGRESS
        // So we only show ACCEPTED if job is SCHEDULED/ASSIGNED but not started yet
        const relevantOffers = allOffers.filter(offer => {
          // Always show PENDING offers (waiting for customer review)
          if (offer.status === 'PENDING') return true;
          // Show ACCEPTED offers only if job is SCHEDULED/ASSIGNED but start code not verified (can still cancel)
          // Once start code is verified, job moves to IN_PROGRESS and should appear in Active Jobs, not Applied Jobs
          if (offer.status === 'ACCEPTED' && offer.job && (offer.job.status === 'SCHEDULED' || offer.job.status === 'ASSIGNED') && !offer.job.startCodeVerified) return true;
          // Don't show DECLINED offers or jobs that have started (those are in Active Jobs)
          return false;
        });
        
        console.log("🔵 Filtered to relevant applied jobs:", relevantOffers.length);
        
        if (relevantOffers.length === 0) {
          appliedJobsList.innerHTML = `
            <div style='text-align: center; padding: 3rem; color: var(--text-muted);'>
              <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No active applications</div>
              <div>Start browsing jobs and apply to get started!</div>
            </div>
          `;
          appliedJobsList.dataset.loading = 'false';
          return;
        }
        
        appliedJobsList.innerHTML = "";
        
        // Render each application as a job card
        for (const offer of relevantOffers) {
          const job = offer.job;
          if (!job) continue;
          
          // Determine status badge and color
          let statusBadge = '';
          let statusColor = '';
          if (offer.status === 'ACCEPTED') {
            statusBadge = '✅ Accepted';
            statusColor = '#10b981';
          } else if (offer.status === 'PENDING') {
            statusBadge = '⏳ Pending Review';
            statusColor = '#f59e0b';
          } else {
            statusBadge = '📋 ' + offer.status;
            statusColor = '#6b7280';
          }
          
          // Format pay display
          const requirements = job.requirements || {};
          const pricingOption = requirements.pricing_option;
          let payDisplay = '';
          if (pricingOption === 'hustlers_quote') {
            payDisplay = 'Hustler suggests price';
          } else if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
            const hr = Number(job.hourlyRate);
            const maxHrs = job.estHours;
            payDisplay = `$${hr.toFixed(0)}/hr total (max ${maxHrs} hrs)`;
          } else {
            payDisplay = `$${Number(job.amount || 0).toFixed(0)} flat`;
          }
          
          // Format original price
          let originalPriceDisplay = '';
          if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
            originalPriceDisplay = `$${Number(job.hourlyRate).toFixed(0)}/hr total (max ${job.estHours} hrs)`;
          } else {
            originalPriceDisplay = `$${Number(job.amount || 0).toFixed(0)} flat`;
          }
          
          // Format proposed price - always show hustler's most recent offer
          let proposedPriceDisplay = '';
          let hasHustlerProposedPrice = false;
          
          // Show hustler's most recent offer (proposedAmount if exists, otherwise use job amount for hustlers_quote jobs)
          if (offer.proposedAmount) {
            // Hustler has proposed a price - show it
            hasHustlerProposedPrice = true;
            const proposedAmount = Number(offer.proposedAmount);
            if (job.payType === 'hourly') {
              proposedPriceDisplay = `$${proposedAmount.toFixed(0)}/hr`;
            } else {
              proposedPriceDisplay = `$${proposedAmount.toFixed(0)} flat`;
            }
          } else if (pricingOption === 'hustlers_quote') {
            // For hustlers_quote jobs, if no proposedAmount yet, show job amount as their current offer
            hasHustlerProposedPrice = true;
            if (job.payType === 'hourly' && job.hourlyRate) {
              proposedPriceDisplay = `$${Number(job.hourlyRate).toFixed(0)}/hr`;
            } else {
              proposedPriceDisplay = `$${Number(job.amount || 0).toFixed(0)} flat`;
            }
          }
          
          // Get category display
          const categoryIcons = {
            'moving': '🚚', 'yard-work': '🌿', 'dump-run': '🗑️', 'cleaning': '🧹',
            'power-washing': '💦', 'furniture-assembly': '🔧', 'painting': '🎨',
            'handyman': '🔨', 'landscaping': '🌳', 'pet-care': '🐕', 'delivery': '📦',
            'car-cleaning': '🚿', 'event-setup': '🎪', 'snow-removal': '❄️', 'other': '⭐'
          };
          const categoryNames = {
            'moving': 'Moving', 'yard-work': 'Yard Work', 'dump-run': 'Dump Run',
            'cleaning': 'Cleaning', 'power-washing': 'Power Wash', 'furniture-assembly': 'Assembly',
            'painting': 'Painting', 'handyman': 'Handyman', 'landscaping': 'Landscaping',
            'pet-care': 'Pet Care', 'delivery': 'Delivery', 'car-cleaning': 'Car Clean',
            'event-setup': 'Event Setup', 'snow-removal': 'Snow Removal', 'other': 'Other'
          };
          const jobCategory = (job.category || 'other').toLowerCase();
          const catIcon = categoryIcons[jobCategory] || '⭐';
          const catName = categoryNames[jobCategory] || job.category || 'Other';
          
          // Get team size
          const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
          let workersDisplay = '';
          if (teamSize === 0) {
            workersDisplay = 'Company/crew';
          } else if (teamSize === 1) {
            workersDisplay = '1 person';
          } else {
            workersDisplay = `${teamSize} people`;
          }
          
          // Get applicant count
          const offersCount = job._count?.offers || job.offersCount || 0;
          const applicantCountText = offersCount > 0 ? `${offersCount} ${offersCount === 1 ? 'applicant' : 'applicants'}` : 'No applicants yet';
          
          // Format price for top right
          let priceDisplay = '';
          if (pricingOption === 'hustlers_quote') {
            priceDisplay = 'You suggest price';
          } else if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
            const hr = Number(job.hourlyRate);
            const maxHrs = job.estHours;
            priceDisplay = `$${hr.toFixed(0)}/hr`;
          } else {
            priceDisplay = `$${Number(job.amount || 0).toFixed(0)}`;
          }
          
          const jobCard = document.createElement('div');
          jobCard.className = 'job-card';
          jobCard.style.cssText = `
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          `;
          
          jobCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <h3 style="font-size: 1.15rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 0.85rem; color: var(--text-muted);">
                  <span>${catIcon} ${catName}</span>
                  <span>•</span>
                  <span>👥 ${workersDisplay}</span>
                  <span>•</span>
                  <span>📋 ${applicantCountText}</span>
              </div>
                </div>
              <div style="text-align: right; flex-shrink: 0; margin-left: 1rem;">
                <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${priceDisplay}</div>
              </div>
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
              <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" data-offer-id="${offer.id}" style="flex: 1; padding: 0.75rem; font-weight: 600; border-radius: 8px; font-size: 0.95rem;">View Job</button>
              ${offer.status === 'PENDING' || (offer.status === 'ACCEPTED' && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified) ? `
              <button class="btn btn-ghost cancelApplicationBtn" data-offer-id="${offer.id}" data-job-id="${job.id}" style="padding: 0.75rem 1.25rem; font-weight: 600; border-radius: 8px; color: #dc2626; border-color: #fecaca; font-size: 0.95rem;">Cancel</button>
              ` : ''}
            </div>
          `;
          
          // Add click handlers
          jobCard.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const jobId = e.target.dataset.jobId;
            const offerId = e.target.dataset.offerId;
            // Store offer data for openJobDetails to use
            if (typeof window.openJobDetails === 'function') {
              window._currentViewingOffer = offer;
              window.openJobDetails(jobId);
            }
          });
          
          jobCard.querySelector('.cancelApplicationBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const offerId = e.target.dataset.offerId;
            const jobId = e.target.dataset.jobId;
            const isAccepted = offer.status === 'ACCEPTED';
            const confirmMessage = isAccepted 
              ? 'Are you sure you want to cancel this job? You cannot do it anymore. The customer will be notified and the job will be reopened for other applicants. This action cannot be undone.'
              : 'Are you sure you want to cancel this application?';
            
            if (confirm(confirmMessage)) {
              try {
                const token = localStorage.getItem('hustl_token');
                if (!token) {
                  showToast('Please log in to cancel applications');
                  return;
                }
                
                if (offerId) {
                  // Cancel pending application
                  if (offer.status === 'PENDING') {
                    const response = await fetch(`${API_BASE}/offers/${offerId}/cancel`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.error || 'Failed to cancel application');
                    }
                    
                    showToast('✅ Application cancelled');
                  } else if (offer.status === 'ACCEPTED') {
                    // Cancel accepted offer (use hustler-cancel endpoint)
                    const response = await fetch(`${API_BASE}/offers/${offerId}/hustler-cancel`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.error || 'Failed to cancel job');
                    }
                    
                    showToast('✅ Job cancelled. The job is now open for other applicants.');
                  }
                } else if (jobId) {
                  // Cancel via job ID (for accepted offers)
                  const response = await fetch(`${API_BASE}/offers/${offer.id}/hustler-cancel`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to cancel job');
                  }
                  
                  showToast('✅ Job cancelled. The job is now open for other applicants.');
                }
                
                // Reload applied jobs
                loadAppliedJobs();
              } catch (error) {
                console.error('Error cancelling application:', error);
                showToast(error.message || 'Failed to cancel application');
              }
            }
          });
          
          // Make card clickable
          jobCard.addEventListener('click', (e) => {
            if (!e.target.closest('button') && !e.target.closest('.btn')) {
              const jobId = job.id;
              const offerId = offer.id;
              // Store offer data for openJobDetails to use
              if (typeof window.openJobDetails === 'function') {
                window._currentViewingOffer = offer;
                window.openJobDetails(jobId);
              }
            }
          });
          
          appliedJobsList.appendChild(jobCard);
        }
        
        appliedJobsList.dataset.loading = 'false';
        console.log("✅ Rendered applied jobs:", relevantOffers.length);
      } catch (error) {
        console.error("Error loading applied jobs:", error);
        appliedJobsList.innerHTML = `
          <div style='text-align: center; padding: 2rem; color: var(--text-muted);'>
            <div style="margin-bottom: 1rem;">❌ Error loading applications</div>
            <button class="btn btn-primary" onclick="loadAppliedJobs()" style="padding: 0.75rem 1.5rem;">Retry</button>
          </div>
        `;
      }
    }
    
    // OLD loadCompletedJobs function removed - using new one with pagination and popup (see line 23921)
    // The new loadCompletedJobs function is defined earlier in the file (around line 23921)
    // with pagination (5 jobs per page), popup details, and payment information
    
    window.renderManageJobs = renderManageJobs;
    
    // Rehire Job Modal - Opens prefilled job form for rehiring a specific hustler
    async function showRehireJobModal(completedJobId, hustlerId, hustlerName) {
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          showToast("Please log in to rehire a worker.");
          return;
        }
        
        // Fetch the completed job details to prefill the form
        const jobResponse = await fetch(`${API_BASE}/jobs/${completedJobId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!jobResponse.ok) {
          showToast("Failed to load job details.");
          return;
        }
        const completedJob = await jobResponse.json();
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'rehireJobModal';
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Create modal content
        const modal = document.createElement('div');
        modal.style.cssText = `
          background: white;
          border-radius: 16px;
          padding: 2rem;
          max-width: 600px;
          width: 100%;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        `;
        
        const requirements = completedJob.requirements || {};
        const prefilledTitle = completedJob.title || '';
        const prefilledDescription = completedJob.description || '';
        const prefilledCategory = completedJob.category || '';
        const prefilledAddress = completedJob.address || '';
        const prefilledPayType = completedJob.payType || 'flat';
        const prefilledAmount = completedJob.amount ? parseFloat(completedJob.amount) : 0;
        const prefilledHourlyRate = completedJob.hourlyRate ? parseFloat(completedJob.hourlyRate) : null;
        const prefilledEstHours = completedJob.estHours || null;
        const prefilledTeamSize = completedJob.teamSize || requirements.teamSize || 1;
        
        // Calculate default date (tomorrow)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const defaultDate = tomorrow.toISOString().split('T')[0];
        const defaultStartTime = new Date(tomorrow);
        defaultStartTime.setHours(8, 0, 0, 0);
        const defaultEndTime = new Date(tomorrow);
        defaultEndTime.setHours(17, 0, 0, 0);
        
        modal.innerHTML = `
          <div style="margin-bottom: 1.5rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);">🔄 Rehire ${hustlerName}</h2>
            <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">This job will be sent privately to ${hustlerName} only. They can accept or decline.</p>
          </div>
          
          <form id="rehireJobForm">
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehireJobTitle">Job Title *</label>
              <input id="rehireJobTitle" type="text" value="${prefilledTitle}" required />
            </div>
            
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehireJobCategory">Category *</label>
              <select id="rehireJobCategory" required>
                <option value="">Select...</option>
                <option value="moving" ${prefilledCategory === 'moving' ? 'selected' : ''}>Moving / Hauling</option>
                <option value="yard-work" ${prefilledCategory === 'yard-work' ? 'selected' : ''}>Yard Work</option>
                <option value="cleaning" ${prefilledCategory === 'cleaning' ? 'selected' : ''}>Cleaning</option>
                <option value="furniture-assembly" ${prefilledCategory === 'furniture-assembly' ? 'selected' : ''}>Furniture Assembly</option>
                <option value="other" ${prefilledCategory === 'other' ? 'selected' : ''}>Other</option>
              </select>
            </div>
            
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehireJobDescription">Description *</label>
              <textarea id="rehireJobDescription" rows="4" required>${prefilledDescription}</textarea>
            </div>
            
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehireJobAddress">Address *</label>
              <input id="rehireJobAddress" type="text" value="${prefilledAddress}" required />
            </div>
            
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehireJobDate">Date *</label>
              <input id="rehireJobDate" type="date" value="${defaultDate}" required />
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div class="field">
                <label for="rehireJobStartTime">Start Time *</label>
                <input id="rehireJobStartTime" type="time" value="${defaultStartTime.toTimeString().slice(0,5)}" required />
              </div>
              <div class="field">
                <label for="rehireJobEndTime">End Time *</label>
                <input id="rehireJobEndTime" type="time" value="${defaultEndTime.toTimeString().slice(0,5)}" required />
              </div>
            </div>
            
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehirePayType">Payment Type *</label>
              <select id="rehirePayType" required>
                <option value="flat" ${prefilledPayType === 'flat' ? 'selected' : ''}>Flat Rate</option>
                <option value="hourly" ${prefilledPayType === 'hourly' ? 'selected' : ''}>Hourly</option>
              </select>
            </div>
            
            <div id="rehireFlatAmount" class="field" style="margin-bottom: 1rem; ${prefilledPayType === 'hourly' ? 'display: none;' : ''}">
              <label for="rehireAmount">Amount ($) *</label>
              <input id="rehireAmount" type="number" min="0" step="0.01" value="${prefilledAmount}" required />
            </div>
            
            <div id="rehireHourlyFields" style="margin-bottom: 1rem; ${prefilledPayType === 'flat' ? 'display: none;' : ''}">
              <div class="field" style="margin-bottom: 0.75rem;">
                <label for="rehireHourlyRate">Hourly Rate ($) *</label>
                <input id="rehireHourlyRate" type="number" min="0" step="0.01" value="${prefilledHourlyRate || ''}" required />
              </div>
              <div class="field">
                <label for="rehireEstHours">Estimated Hours *</label>
                <input id="rehireEstHours" type="number" min="1" value="${prefilledEstHours || ''}" required />
              </div>
            </div>
            
            <div class="field" style="margin-bottom: 1rem;">
              <label for="rehireTeamSize">Team Size *</label>
              <input id="rehireTeamSize" type="number" min="1" value="${prefilledTeamSize}" required />
            </div>
            
            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
              <button type="button" class="btn btn-ghost" id="cancelRehireBtn" style="flex: 1; padding: 0.75rem;">Cancel</button>
              <button type="submit" class="btn btn-primary" style="flex: 1; padding: 0.75rem; font-weight: 600;">Send Rehire Request</button>
            </div>
          </form>
        `;
        
        modalOverlay.appendChild(modal);
        document.body.appendChild(modalOverlay);
        
        // Handle pay type toggle
        document.getElementById('rehirePayType').addEventListener('change', (e) => {
          const isHourly = e.target.value === 'hourly';
          document.getElementById('rehireFlatAmount').style.display = isHourly ? 'none' : 'block';
          document.getElementById('rehireHourlyFields').style.display = isHourly ? 'block' : 'none';
          document.getElementById('rehireAmount').required = !isHourly;
          document.getElementById('rehireHourlyRate').required = isHourly;
          document.getElementById('rehireEstHours').required = isHourly;
        });
        
        // Handle cancel
        document.getElementById('cancelRehireBtn').addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        // Handle form submission
        document.getElementById('rehireJobForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const title = document.getElementById('rehireJobTitle').value.trim();
          const category = document.getElementById('rehireJobCategory').value;
          const description = document.getElementById('rehireJobDescription').value.trim();
          const address = document.getElementById('rehireJobAddress').value.trim();
          const date = document.getElementById('rehireJobDate').value;
          const startTimeStr = document.getElementById('rehireJobStartTime').value;
          const endTimeStr = document.getElementById('rehireJobEndTime').value;
          const payType = document.getElementById('rehirePayType').value;
          const teamSize = parseInt(document.getElementById('rehireTeamSize').value) || 1;
          
          // Combine date and time
          const startTime = new Date(`${date}T${startTimeStr}`);
          const endTime = new Date(`${date}T${endTimeStr}`);
          
          let amount = 0;
          let hourlyRate = null;
          let estHours = null;
          
          if (payType === 'flat') {
            amount = parseFloat(document.getElementById('rehireAmount').value) || 0;
          } else {
            hourlyRate = parseFloat(document.getElementById('rehireHourlyRate').value) || 0;
            estHours = parseInt(document.getElementById('rehireEstHours').value) || 1;
            amount = hourlyRate * estHours; // Total estimated
          }
          
          if (!title || !category || !description || !address) {
            showToast("Please fill in all required fields.");
            return;
          }
          
          // Create rehire job (private, not in Browse Jobs)
          try {
            const response = await fetch(`${API_BASE}/jobs`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                title,
                category,
                description,
                address,
                date: startTime.toISOString(),
                startTime: startTime.toISOString(),
                endTime: endTime.toISOString(),
                payType,
                amount,
                hourlyRate: payType === 'hourly' ? hourlyRate : null,
                estHours: payType === 'hourly' ? estHours : null,
                teamSize,
                requirements: {
                  ...requirements,
                  teamSize,
                  isPrivate: true, // Mark as private rehire job
                  rehireHustlerId: hustlerId, // Store the hustler ID for the offer
                }
              })
            });
            
            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'Failed to create rehire job');
            }
            
            const newJob = await response.json();
            
            // Create an offer automatically for the selected hustler
            const offerResponse = await fetch(`${API_BASE}/offers`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                jobId: newJob.id,
                hustlerId: hustlerId,
                status: 'PENDING',
                isRehire: true
              })
            });
            
            if (!offerResponse.ok) {
              console.error('Failed to create offer:', await offerResponse.text());
            }
            
            // Send message to hustler
            try {
              const user = await window.hustlAPI.auth.getCurrentUser();
              // Get or create thread (thread is created automatically when offer is created)
              // Find the thread for this job
              const threadsResponse = await fetch(`${API_BASE}/threads?jobId=${newJob.id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              
              let threadId = null;
              if (threadsResponse.ok) {
                const threads = await threadsResponse.json();
                if (threads.length > 0) {
                  threadId = threads[0].id;
                } else {
                  // Create thread if it doesn't exist
                  const createThreadResponse = await fetch(`${API_BASE}/threads`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                      jobId: newJob.id,
                      participantIds: [user.id, hustlerId]
                    })
                  });
                  if (createThreadResponse.ok) {
                    const thread = await createThreadResponse.json();
                    threadId = thread.id;
                  }
                }
              }
              
              if (threadId) {
                // Send rehire message
                await fetch(`${API_BASE}/threads/${threadId}/messages`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    body: `You've been invited to a rehire job by ${user.name || 'a customer'}.`,
                  })
                });
              }
            } catch (msgError) {
              console.error('Failed to send message:', msgError);
              // Continue even if message fails
            }
            
            showToast(`✅ Rehire request sent to ${hustlerName}!`);
            document.body.removeChild(modalOverlay);
            
            // Refresh manage jobs to show the new active job
            if (typeof loadActiveJobs === 'function') {
              loadActiveJobs();
            }
          } catch (error) {
            console.error('Rehire error:', error);
            showToast(`Failed to send rehire request: ${error.message}`);
          }
        });
      } catch (error) {
        console.error('Error showing rehire modal:', error);
        showToast("Failed to load rehire form.");
      }
    }
    
    // Job Management Modal - Shows full job details + applicants
    async function showJobManagementModal(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        // Fetch full job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        // Fetch applicants
        const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const offers = offersResponse.ok ? await offersResponse.json() : [];
        const pendingOffers = offers.filter(o => o.status === 'PENDING');
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Format pay
        const payType = job.payType || 'flat';
        const payDisplay = payType === 'hourly' 
          ? `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr (est. ${job.estHours || 0} hrs)` 
          : `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
        
        // Format date/time
        const jobDate = new Date(job.date);
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        modalOverlay.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
          ">
            <!-- Close Button -->
            <button class="closeModalBtn" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: #f3f4f6;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.25rem;
              z-index: 1;
              transition: all 0.2s;
            ">×</button>
            
            <!-- Modal Content -->
            <div style="padding: 2rem;">
              <!-- Job Info Section -->
              <div style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Category</div>
                    <div style="font-weight: 600; color: var(--text-main);">${job.category || 'General'}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Pay</div>
                    <div style="font-weight: 600; color: var(--text-main);">${payDisplay}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Status</div>
                    <div style="font-weight: 600; color: #10b981;">Open</div>
                  </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Description</div>
                  <div style="color: var(--text-main); line-height: 1.6; white-space: pre-wrap;">${job.description || 'No description provided.'}</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">📍 Address</div>
                  <a href="https://maps.google.com/?q=${encodeURIComponent(job.address)}" target="_blank" style="
                    color: var(--primary);
                    text-decoration: none;
                    font-weight: 500;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                  ">
                    ${job.address || 'Address not specified'}
                    <span>🔗</span>
                  </a>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">📅 Scheduled</div>
                  <div style="color: var(--text-main); font-weight: 500;">${dateStr} at ${timeStr}</div>
                </div>
                
                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                  ${job.customer ? renderUserAvatar(job.customer, 40) : '<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary);">' + (job.customer?.name?.[0] || 'U') + '</div>'}
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Posted by</div>
                    <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewCustomerProfile" data-user-id="${job.customerId}">${job.customer?.name || 'Unknown'}</div>
                  </div>
                </div>
              </div>
              
              <!-- Applicants Section -->
              <div style="border-top: 2px solid var(--border); padding-top: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">
                  👥 Applicants (${pendingOffers.length})
                </h3>
                
                <div id="applicantsList" style="display: flex; flex-direction: column; gap: 1rem;">
                  ${pendingOffers.length === 0 ? `
                    <div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                      <div style="font-size: 2rem; margin-bottom: 0.5rem;">👤</div>
                      <div>No applicants yet. Share your job to get more applicants!</div>
                    </div>
                  ` : pendingOffers.map(offer => {
                    const hustler = offer.hustler || {};
                    const rating = hustler.ratingAvg || 0;
                    const ratingCount = hustler.ratingCount || 0;
                    const proposedPrice = offer.proposedAmount ? `$${parseFloat(offer.proposedAmount).toFixed(2)}` : null;
                    const appliedDate = new Date(offer.createdAt);
                    
                    return `
                      <div data-offer-id="${offer.id}" style="
                        padding: 1.5rem;
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        background: white;
                      ">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                          ${renderUserAvatar(hustler, 60, {
                            style: 'flex-shrink: 0;'
                          })}
                          <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                              <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem; cursor: pointer;" class="viewHustlerProfile" data-user-id="${hustler.id}">${hustler.name || 'Unknown'}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                              <span style="font-size: 1rem;">${'⭐'.repeat(Math.floor(rating))}${rating % 1 >= 0.5 ? '⭐' : ''}</span>
                              <span style="color: var(--text-muted); font-size: 0.85rem;">${rating.toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                            </div>
                            ${hustler.bio ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem; line-height: 1.5;">${hustler.bio}</div>` : ''}
                            ${offer.note ? `<div style="padding: 0.75rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.5rem;">
                              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Why I'm a good fit:</div>
                              <div style="color: var(--text-main); line-height: 1.5;">${offer.note}</div>
                            </div>` : ''}
                            ${proposedPrice ? `<div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                              💵 Suggested price: <span style="font-weight: 600; color: var(--primary);">${proposedPrice}</span>
                            </div>` : ''}
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Applied ${appliedDate.toLocaleDateString()}</div>
                          </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                          <button class="btn btn-primary acceptOfferBtn" data-offer-id="${offer.id}" style="flex: 1; min-width: 120px; padding: 0.75rem; font-weight: 600;">✅ Accept</button>
                          <button class="btn btn-ghost declineOfferBtn" data-offer-id="${offer.id}" style="flex: 1; min-width: 120px; padding: 0.75rem; color: #dc2626; border-color: #fecaca;">❌ Reject</button>
                          <button class="btn btn-ghost viewProfileBtn" data-user-id="${hustler.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">View Profile</button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modalOverlay);
        
        // Close button
        modalOverlay.querySelector('.closeModalBtn').addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        // Click outside to close
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
        
        // Accept/Decline buttons
        modalOverlay.querySelectorAll('.acceptOfferBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const offerId = btn.dataset.offerId;
            await acceptOffer(offerId, modalOverlay);
          });
        });
        
        modalOverlay.querySelectorAll('.declineOfferBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const offerId = btn.dataset.offerId;
            await declineOffer(offerId, jobId, modalOverlay);
          });
        });
        
        // View profile buttons
        modalOverlay.querySelectorAll('.viewHustlerProfile, .viewCustomerProfile, .viewProfileBtn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const userId = btn.dataset.userId;
            // Open profile popup (reuse existing function if available)
            if (typeof showUserProfile === 'function') {
              showUserProfile(userId);
            } else {
              setView('profile');
              // Could navigate to user profile if we have that view
            }
          });
        });
        
      } catch (error) {
        console.error("Error showing job management modal:", error);
        showToast("Error loading job details. Please try again.");
      }
    }
    
    window.showJobManagementModal = showJobManagementModal;
    
    // Active Job Modal - Role-based (Customer vs Hustler)
    async function showActiveJobModal(jobId, role) {
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        
        // Fetch full job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Format pay
        const payType = job.payType || 'flat';
        const payDisplay = payType === 'hourly' 
          ? `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr (est. ${job.estHours || 0} hrs)` 
          : `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
        
        // Format date/time
        const jobDate = new Date(job.date);
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        if (role === 'customer') {
          // Customer View Modal - Improved
          const hustler = job.hustler || {};
          const requirements = job.requirements || {};
          const payType = job.payType || 'flat';
          const hourlyRate = parseFloat(job.hourlyRate || 0);
          const maxHours = Number(job.estHours) || Number(requirements.maxHours) || 0;
          const jobAmount = parseFloat(job.amount || 0);
          
          // Format price display
          let priceDisplay = '';
          if (payType === 'hourly' && hourlyRate > 0) {
            const maxTotal = hourlyRate * maxHours;
            if (maxHours > 0) {
              priceDisplay = `$${hourlyRate.toFixed(0)}/hr (max ${maxHours}h = $${maxTotal.toFixed(0)})`;
            } else {
              priceDisplay = `$${hourlyRate.toFixed(0)}/hr`;
            }
          } else {
            priceDisplay = `$${jobAmount.toFixed(0)} flat`;
          }
          
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 800px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeModalBtn" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
              ">×</button>
              
              <!-- Price in top corner -->
              <div style="position: absolute; top: 1rem; left: 1rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 8px; border: 2px solid #10b981; z-index: 1;">
                <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">PAY</div>
                <div style="font-size: 1.1rem; font-weight: 700; color: #059669;">${priceDisplay}</div>
              </div>
              
              <div style="padding: 2rem; padding-top: 4rem;">
                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1.75rem 0; color: #111827; letter-spacing: -0.02em;">${job.title || 'Untitled Job'}</h2>
                
                <!-- Accepted Hustler Section -->
                <div style="padding: 1.5rem; background: #f0fdf4; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #10b981;">
                  <div style="font-size: 0.8rem; color: #059669; margin-bottom: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">✅ Hustler Accepted</div>
                  <div style="display: flex; gap: 1rem; align-items: center;">
                    ${renderUserAvatar(hustler, 60, {
                      className: 'viewHustlerProfileBtn'
                    })}
                    <div style="flex: 1;">
                      <div style="font-weight: 700; font-size: 1.15rem; color: #111827; margin-bottom: 0.25rem; letter-spacing: -0.01em;">${hustler.name || 'Unknown'}</div>
                      </div>
                    <button class="btn btn-primary messageHustlerBtn" data-job-id="${job.id}" style="padding: 0.875rem 1.5rem; font-weight: 700; font-size: 0.95rem; color: white; background: var(--primary); border: none; border-radius: 8px;">💬 Message</button>
                  </div>
                </div>
                
                <!-- Start Code Section - Prominent for Customer to Share -->
                ${job.startCode ? `
                  <div style="padding: 1.5rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; margin-bottom: 1.5rem; border: 3px solid #f59e0b; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 0.75rem; font-size: 1.05rem; letter-spacing: -0.01em;">🔐 Start Code - Give this to your hustler</div>
                    <div style="font-size: 2.5rem; font-weight: 700; letter-spacing: 0.4em; color: #92400e; text-align: center; padding: 1.25rem; background: white; border-radius: 10px; font-family: 'Courier New', monospace; margin-bottom: 0.875rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${job.startCode}</div>
                    <div style="font-size: 0.875rem; color: #92400e; text-align: center; font-weight: 600;">${job.startCodeVerified ? '✅ Verified by hustler - Job started!' : '⏳ Share this code with your hustler to start the job'}</div>
                  </div>
                ` : ''}
                
                ${job.completionCode && job.status === 'COMPLETED_BY_HUSTLER' ? `
                  <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 0.875rem; font-size: 1.05rem; letter-spacing: -0.01em;">✅ Completion Code (from Hustler)</div>
                    <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1.25rem; line-height: 1.5; font-weight: 500;">The hustler should have provided you with a completion code. Enter it below to release payment.</div>
                    ${!job.completionCodeVerified ? `
                      <input type="text" id="completionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 0.875rem; border: 2px solid #3b82f6; border-radius: 8px; font-size: 1.25rem; text-align: center; letter-spacing: 0.3em; font-family: 'Courier New', monospace; font-weight: 700; color: #1e40af;">
                      <button class="btn btn-primary verifyCompletionBtn" data-job-id="${job.id}" style="width: 100%; margin-top: 0.875rem; padding: 0.875rem; font-weight: 700; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 0.95rem;">Verify & Release Payment</button>
                    ` : `
                      <div style="padding: 1.25rem; background: #dcfce7; border-radius: 8px; border: 1px solid #10b981;">
                        <div style="font-weight: 700; color: #166534; font-size: 0.95rem;">✅ Completion verified - Payment released</div>
                      </div>
                    `}
                  </div>
                ` : job.status === 'COMPLETED_BY_HUSTLER' && !job.completionCode ? `
                  <div style="padding: 1.25rem; background: #fef3c7; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #fbbf24;">
                    <div style="font-weight: 700; color: #92400e; font-size: 0.95rem;">⏳ Waiting for completion code from hustler</div>
                  </div>
                ` : ''}
                
                <!-- Price Adjustment Section (if job not started) -->
                ${(job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified ? `
                  <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                    <!-- Price change feature disabled -->
                  </div>
                ` : ''}
                
                <!-- Actions -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                  <button class="btn btn-primary messageHustlerBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: var(--primary); border: none; border-radius: 8px;">💬 Message</button>
                  <button class="btn btn-ghost viewJobBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: #1f2937; border: 2px solid #e5e7eb; border-radius: 8px;">🔍 View Job</button>
                  ${(job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified ? `
                    <button class="btn btn-primary unassignHustlerBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: #f59e0b; border: none; border-radius: 8px;">🔓 Unassign</button>
                    <button class="btn btn-ghost deleteJobBtn" data-job-id="${job.id}" style="padding: 0.75rem; width: 48px; height: 48px; color: #dc2626; border: 2px solid #fecaca; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: #fef2f2;" title="Delete Job">🗑️</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        } else {
          // Hustler View Modal - Simplified
          const customer = job.customer || {};
          const requirements = job.requirements || {};
          const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
          
          // Get tools needed
          const equipmentNeeded = requirements.equipmentNeeded || [];
          const customEquipment = requirements.customEquipment || '';
          let toolsDisplay = 'None';
          if (equipmentNeeded.length > 0) {
            toolsDisplay = equipmentNeeded.join(', ');
          } else if (customEquipment) {
            toolsDisplay = customEquipment;
          }
          
          // Format workers
          let workersDisplay = '';
          if (teamSize === 0) {
            workersDisplay = 'Company/crew';
          } else if (teamSize === 1) {
            workersDisplay = '1 worker';
          } else {
            workersDisplay = `${teamSize} workers`;
          }
          
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 800px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeModalBtn" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
              ">×</button>
              
              <div style="padding: 2rem;">
                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1.75rem 0; color: #111827; letter-spacing: -0.02em;">${job.title || 'Untitled Job'}</h2>
                
                <!-- Customer Info -->
                <div style="padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                  <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 0.875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Customer</div>
                  <div style="display: flex; gap: 1rem; align-items: center;">
                    ${customer ? renderUserAvatar(customer, 60) : `<div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.5rem;">C</div>`}
                    <div style="flex: 1;">
                      <div style="font-weight: 700; font-size: 1.15rem; color: #111827; margin-bottom: 0.25rem; letter-spacing: -0.01em;">${customer.name || 'Unknown'}</div>
                    </div>
                  </div>
                </div>
                
                <!-- Essential Job Info -->
                <div style="padding: 1.5rem; background: #f8f9fa; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
                  <div style="display: grid; gap: 1rem;">
                    <div style="font-weight: 700; color: #111827; font-size: 0.95rem;"><span style="color: #6b7280; margin-right: 0.5rem;">👥</span>Workers: <span style="color: #374151; font-weight: 600;">${workersDisplay}</span></div>
                    <div style="font-weight: 700; color: #111827; font-size: 0.95rem;"><span style="color: #6b7280; margin-right: 0.5rem;">🔧</span>Tools Needed: <span style="color: #374151; font-weight: 600;">${toolsDisplay}</span></div>
                    <div style="font-weight: 700; color: #111827; font-size: 0.95rem;"><span style="color: #6b7280; margin-right: 0.5rem;">📅</span>Scheduled: <span style="color: #374151; font-weight: 600;">${dateStr} at ${timeStr}</span></div>
                    <div style="padding: 0.625rem 1.125rem; background: ${job.status === 'IN_PROGRESS' ? '#fef3c7' : '#dbeafe'}; color: ${job.status === 'IN_PROGRESS' ? '#92400e' : '#1e40af'}; border-radius: 8px; font-weight: 700; display: inline-block; width: fit-content; font-size: 0.875rem; border: 1px solid ${job.status === 'IN_PROGRESS' ? '#fbbf24' : '#3b82f6'};">${job.status === 'IN_PROGRESS' ? 'In Progress' : 'Scheduled'}</div>
                  </div>
                </div>
                
                <!-- Start Code Entry - Mobile Friendly -->
                ${job.startCode && !job.startCodeVerified ? `
                  <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 0.75rem; font-size: 1.05rem; letter-spacing: -0.01em;">🔐 Enter Start Code</div>
                    <div style="font-size: 0.875rem; color: #92400e; margin-bottom: 1.25rem; line-height: 1.5; font-weight: 500;">Ask the customer for the 6-digit start code to begin the job.</div>
                    <input type="text" id="startCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 1rem; border: 2px solid #fbbf24; border-radius: 8px; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; font-family: 'Courier New', monospace; font-weight: 700; box-sizing: border-box; min-height: 60px; color: #92400e;" />
                    <button class="btn btn-primary verifyStartCodeBtn" data-job-id="${job.id}" style="width: 100%; margin-top: 0.875rem; padding: 1rem; font-weight: 700; background: #f59e0b; font-size: 1rem; min-height: 50px; color: white; border: none; border-radius: 8px;">Verify & Start Job</button>
                  </div>
                ` : job.startCodeVerified ? `
                  <div style="padding: 1.25rem; background: #dcfce7; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #10b981;">
                    <div style="font-weight: 700; color: #166534; font-size: 0.95rem;">✅ Start code verified - Job in progress</div>
                  </div>
                ` : ''}
                
                <!-- Mark Complete Section -->
                ${job.startCodeVerified && job.status !== 'COMPLETED_BY_HUSTLER' && job.status !== 'PAID' ? `
                  <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 0.875rem; font-size: 1.05rem; letter-spacing: -0.01em;">✅ Mark Job Complete</div>
                    <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1.25rem; line-height: 1.5; font-weight: 500;">When you finish the job, click below to mark it complete. A verification code will be sent to the customer.</div>
                    <button class="btn btn-primary submitEndCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.875rem; font-weight: 700; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 0.95rem;">Mark Complete</button>
                  </div>
                ` : job.status === 'COMPLETED_BY_HUSTLER' ? `
                  <div style="padding: 1.25rem; background: #dcfce7; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #10b981;">
                    <div style="font-weight: 700; color: #166534; font-size: 0.95rem;">✅ Job marked as complete - Waiting for customer confirmation</div>
                  </div>
                ` : ''}
                
                <!-- Actions -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                  <button class="btn btn-primary messageCustomerBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: var(--primary); border: none; border-radius: 8px;">💬 Message</button>
                  ${(job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && !job.startCodeVerified ? `<button class="btn btn-primary leaveJobBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 0.95rem; color: white; background: #dc2626; border: none; border-radius: 8px;">🚪 Leave Job</button>` : ''}
                </div>
              </div>
            </div>
          `;
        }
        
        document.body.appendChild(modalOverlay);
        
        // Close button
        modalOverlay.querySelector('.closeModalBtn').addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        // Click outside to close
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
        
        // Event listeners based on role
        if (role === 'customer') {
          modalOverlay.querySelectorAll('.messageHustlerBtn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const jobId = btn.dataset.jobId || job.id;
              
              // Set active conversation job ID
              activeConversationJobId = jobId;
              
              document.body.removeChild(modalOverlay);
              
              // Switch to messages view
              if (window.setView && typeof window.setView === 'function') {
                const funcStr = window.setView.toString();
                const isStub = funcStr.includes('not ready yet');
                if (!isStub) {
                  await window.setView('messages');
                } else {
                  // Use fallback
                  activeView = 'messages';
                  window.activeView = 'messages';
                  document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
                  const target = document.getElementById("view-messages");
                  if (target) target.style.display = "block";
                  document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === 'messages'));
                  await renderAll();
                }
              }
              
              // Wait for view to switch, then render and open conversation
              setTimeout(async () => {
                await renderMessagesView();
                // Find and click the conversation for this job
                const conversationItems = document.querySelectorAll('[data-job-id]');
                conversationItems.forEach(item => {
                  if (item.dataset.jobId === jobId) {
                    item.click();
                  }
                });
              }, 300);
            });
          });
          
          modalOverlay.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            document.body.removeChild(modalOverlay);
            showViewJobModal(job.id, 'customer');
          });
          
          modalOverlay.querySelector('.unassignHustlerBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to unassign this hustler? The job will be open for applicants again.')) {
              await unacceptHustler(job.id);
              document.body.removeChild(modalOverlay);
              loadActiveJobs();
              loadPostedJobs();
            }
          });
          
          modalOverlay.querySelector('.deleteJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
              try {
                const token = localStorage.getItem('hustl_token');
                const response = await fetch(`${API_BASE}/jobs/${job.id}`, {
                  method: 'DELETE',
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                  showToast('Job deleted successfully');
                  document.body.removeChild(modalOverlay);
                  loadActiveJobs();
                  loadPostedJobs();
                } else {
                  throw new Error('Failed to delete job');
                }
              } catch (error) {
                console.error('Error deleting job:', error);
                showToast('Error deleting job. Please try again.');
              }
            }
          });
          
          modalOverlay.querySelector('.adjustPriceBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const payType = job.payType || 'flat';
            const hourlyRate = parseFloat(job.hourlyRate || 0);
            const maxHours = Number(job.estHours) || Number(job.requirements?.maxHours) || 0;
            const jobAmount = parseFloat(job.amount || 0);
            
            // Open price adjustment modal
            const adjustModal = document.createElement('div');
            adjustModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            adjustModal.innerHTML = `
              <div style="background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; position: relative;">
                <button class="closeAdjustModal" style="position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; border: none; background: #f3f4f6; cursor: pointer; font-size: 1.25rem;">×</button>
                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1rem 0;">Adjust Job Price</h3>
                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">New Price</label>
                  ${payType === 'hourly' ? `
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem;">
                      <div>
                        <input type="number" id="newHourlyRate" placeholder="Hourly rate" min="1" step="0.01" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${hourlyRate || ''}">
                      </div>
                      <div>
                        <input type="number" id="newMaxHours" placeholder="Max hours" min="1" step="1" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${maxHours || ''}">
                      </div>
                    </div>
                  ` : `
                    <input type="number" id="newAmount" placeholder="Total amount" min="1" step="0.01" style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;" value="${jobAmount || ''}">
                  `}
                </div>
                <div style="display: flex; gap: 0.75rem;">
                  <button class="btn btn-primary savePriceBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Save Changes</button>
                  <button class="btn btn-ghost cancelPriceBtn" style="flex: 1; padding: 0.75rem;">Cancel</button>
                </div>
              </div>
            `;
            document.body.appendChild(adjustModal);
            
            adjustModal.querySelector('.closeAdjustModal')?.addEventListener('click', () => {
              document.body.removeChild(adjustModal);
            });
            adjustModal.querySelector('.cancelPriceBtn')?.addEventListener('click', () => {
              document.body.removeChild(adjustModal);
            });
            adjustModal.querySelector('.savePriceBtn')?.addEventListener('click', async () => {
              try {
                const token = localStorage.getItem('hustl_token');
                const proposalData = {};
                if (payType === 'hourly') {
                  const newRate = parseFloat(document.getElementById('newHourlyRate')?.value);
                  const newHours = parseInt(document.getElementById('newMaxHours')?.value);
                  if (newRate && newRate > 0) proposalData.hourlyRate = newRate;
                  if (newHours && newHours > 0) proposalData.estHours = newHours;
                } else {
                  const newAmount = parseFloat(document.getElementById('newAmount')?.value);
                  if (newAmount && newAmount > 0) proposalData.amount = newAmount;
                }
                
                if (Object.keys(proposalData).length === 0) {
                  showToast('Please enter a valid price');
                  return;
                }
                
                // Use new proposal endpoint
                const response = await fetch(`${API_BASE}/jobs/${job.id}/propose-price-change`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(proposalData)
                });
                
                if (response.ok) {
                  showToast('Price change proposal sent! The hustler must accept it before the price changes.');
                  document.body.removeChild(adjustModal);
                  document.body.removeChild(modalOverlay);
                  loadActiveJobs();
                  setTimeout(() => showActiveJobModal(job.id, 'customer'), 300);
                } else {
                  const error = await response.json();
                  showToast(error.error || 'Failed to propose price change');
                }
              } catch (error) {
                console.error('Error proposing price change:', error);
                showToast('Error proposing price change. Please try again.');
              }
            });
          });
          
          modalOverlay.querySelector('.verifyCompletionBtn')?.addEventListener('click', async () => {
            const code = document.getElementById('completionCodeInput')?.value.trim();
            if (!code || code.length !== 6) {
              showToast("Please enter a valid 6-digit completion code.");
              return;
            }
            
            try {
              const token = localStorage.getItem('hustl_token');
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
              });
              
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to verify completion code');
              }
              
              const data = await response.json();
              
              // Close the job modal
              document.body.removeChild(modalOverlay);
              
              // Show congratulations modal, then force review
              showJobCompletionFlow(data.jobId, data.customerId, data.hustlerId);
              
              // Refresh jobs
              loadActiveJobs(); // Refresh list
              loadCompletedJobs(); // Refresh completed list
            } catch (error) {
              console.error("Error verifying completion:", error);
              showToast(error.message || "Invalid completion code. Please check and try again.");
            }
          });
          
          modalOverlay.querySelector('.cancelJobBtn')?.addEventListener('click', async () => {
            if (confirm('Are you sure you want to cancel this job?')) {
              await cancelJob(job.id);
              document.body.removeChild(modalOverlay);
            }
          });
        } else {
          // Handle reviews dropdown toggle in customer profile card (hustler view)
          if (job.customer && job.customer.id) {
            const viewReviewsBtn = modalOverlay.querySelector(`.viewLast5ReviewsBtn_modal_${job.customer.id}`);
            const reviewsDropdown = modalOverlay.querySelector(`.reviewsDropdown_modal_${job.customer.id}`);
            if (viewReviewsBtn && reviewsDropdown) {
              viewReviewsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isVisible = reviewsDropdown.style.display !== 'none';
                reviewsDropdown.style.display = isVisible ? 'none' : 'block';
                viewReviewsBtn.textContent = isVisible ? 'View last 5 reviews' : 'Hide reviews';
              });
            }
          }
          
          modalOverlay.querySelectorAll('.messageCustomerBtn').forEach(btn => {
            btn.addEventListener('click', () => {
              // Set the active conversation to this job
              if (typeof window !== 'undefined' && window.activeConversationJobId !== undefined) {
                window.activeConversationJobId = job.id;
              }
              document.body.removeChild(modalOverlay);
              setView('messages');
            });
          });
          
          modalOverlay.querySelector('.verifyStartCodeBtn')?.addEventListener('click', async () => {
            const codeInput = document.getElementById('startCodeInput');
            const code = codeInput?.value.trim();
            if (!code || code.length !== 6) {
              showToast("Please enter a valid 6-digit start code.");
              return;
            }
            const verified = await verifyStartCode(job.id, code);
            if (verified) {
              document.body.removeChild(modalOverlay);
              loadActiveJobs();
            }
          });
          
          modalOverlay.querySelector('.leaveJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to leave this job?')) {
              try {
                const token = localStorage.getItem('hustl_token');
                const response = await fetch(`${API_BASE}/offers/job/${job.id}/hustler-cancel`, {
                  method: 'POST',
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                  showToast('You have left the job');
                  document.body.removeChild(modalOverlay);
                  loadActiveJobs();
                } else {
                  throw new Error('Failed to leave job');
                }
              } catch (error) {
                console.error('Error leaving job:', error);
                showToast('Error leaving job. Please try again.');
              }
            }
          });
          
          modalOverlay.querySelector('.leaveJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to leave this job?')) {
              try {
                const token = localStorage.getItem('hustl_token');
                const response = await fetch(`${API_BASE}/offers/job/${job.id}/hustler-cancel`, {
                  method: 'POST',
                  headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                  showToast('You have left the job');
                  document.body.removeChild(modalOverlay);
                  loadActiveJobs();
                } else {
                  throw new Error('Failed to leave job');
                }
              } catch (error) {
                console.error('Error leaving job:', error);
                showToast('Error leaving job. Please try again.');
              }
            }
          });
          
          modalOverlay.querySelector('.submitEndCodeBtn')?.addEventListener('click', async () => {
            const code = document.getElementById('endCodeInput')?.value.trim();
            if (!code) {
              showToast("Please enter the completion code.");
              return;
            }
            // Note: The completion code is generated when hustler marks complete, not before
            // So we just call submitCompletionCode which will generate the code
            await submitCompletionCode(job.id);
            document.body.removeChild(modalOverlay);
          });
        }
        
      } catch (error) {
        console.error("Error showing active job modal:", error);
        showToast("Error loading job details. Please try again.");
      }
    }
    
    window.showActiveJobModal = showActiveJobModal;
    
    // View Job Modal - Comprehensive job view with all features (Customer & Hustler views)
    async function showViewJobModal(jobId, role = 'customer') {
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          showToast("Please log in to view job details.");
          return;
        }
        
        // Fetch full job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        // Determine actual role
        const isCustomer = job.customerId === user.id;
        const isHustler = job.hustlerId === user.id;
        // Check if user is a hustler by role (not just assigned to this job)
        const userIsHustler = user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'HUSTLER') || 
                             (user.role && user.role.toUpperCase() === 'HUSTLER') ||
                             (user.isHustler === true) ||
                             (!user.roles || (user.roles && !user.roles.includes('CUSTOMER')));
        const actualRole = isCustomer ? 'customer' : (isHustler ? 'hustler' : role);
        
        // Helper function to determine negotiation state from backend data
        // This uses proposedAmount as single source of truth
        const getNegotiationState = (offer, jobData, currentUserId) => {
          if (!offer || offer.status !== 'PENDING') return null;
          
          const originalOfferKey = `hustlerOriginalOffer_${offer.id}`;
          let originalAmount = localStorage.getItem(originalOfferKey);
          
          // If no original stored, use current proposedAmount or job amount as baseline
          if (!originalAmount && offer.proposedAmount) {
            originalAmount = offer.proposedAmount.toString();
            localStorage.setItem(originalOfferKey, originalAmount);
          } else if (!originalAmount) {
            originalAmount = (jobData.amount || 0).toString();
            localStorage.setItem(originalOfferKey, originalAmount);
          }
          
          const original = parseFloat(originalAmount);
          const current = offer.proposedAmount ? parseFloat(offer.proposedAmount) : original;
          
          // If current equals original, no negotiation yet
          if (Math.abs(current - original) < 0.01) {
            return {
              hasNegotiation: false,
              lastOfferBy: 'hustler', // Initial offer is always by hustler
              lastOfferAmount: original,
              isMyTurn: false, // No negotiation, no turn
              waitingFor: null
            };
          }
          
          // Someone negotiated - determine who by checking if current user is customer or hustler
          // If current user is customer and proposedAmount differs from original, customer negotiated
          // If current user is hustler and proposedAmount differs from original, hustler counter-offered
          // We need to infer from the flow: if customer negotiates, proposedAmount becomes customer's offer
          // If hustler counter-offers, proposedAmount becomes hustler's offer
          
          // Strategy: Compare with stored values to determine who sent it
          const customerCounterKey = `customerCounterOffer_${offer.id}`;
          const hustlerCounterKey = `hustlerCounterOffer_${offer.id}`;
          const storedCustomerCounter = localStorage.getItem(customerCounterKey);
          const storedHustlerCounter = localStorage.getItem(hustlerCounterKey);
          
          let lastOfferBy = 'hustler';
          let isMyTurn = false;
          let waitingFor = null;
          
          if (storedCustomerCounter) {
            const customerAmount = parseFloat(storedCustomerCounter);
            if (Math.abs(current - customerAmount) < 0.01) {
              // Matches customer's counter-offer
              lastOfferBy = 'customer';
              isMyTurn = currentUserId === offer.hustlerId; // Hustler's turn to respond
              waitingFor = currentUserId === offer.hustlerId ? 'hustler' : 'customer';
            } else {
              // Different from customer's - hustler counter-offered
              lastOfferBy = 'hustler';
              isMyTurn = currentUserId === jobData.customerId; // Customer's turn to respond
              waitingFor = currentUserId === jobData.customerId ? 'customer' : 'hustler';
            }
          } else if (storedHustlerCounter) {
            const hustlerAmount = parseFloat(storedHustlerCounter);
            if (Math.abs(current - hustlerAmount) < 0.01) {
              // Matches hustler's counter-offer
              lastOfferBy = 'hustler';
              isMyTurn = currentUserId === jobData.customerId; // Customer's turn
              waitingFor = currentUserId === jobData.customerId ? 'customer' : 'hustler';
            }
          } else {
            // No stored values - infer from amount difference
            // If amount differs from original and we don't have stored values, 
            // it's likely the first negotiation (customer negotiated)
            lastOfferBy = 'customer';
            isMyTurn = currentUserId === offer.hustlerId; // Hustler's turn
            waitingFor = currentUserId === offer.hustlerId ? 'hustler' : 'customer';
          }
          
          return {
            hasNegotiation: true,
            lastOfferBy: lastOfferBy,
            lastOfferAmount: current,
            isMyTurn: isMyTurn,
            waitingFor: waitingFor,
            originalAmount: original
          };
        };
        
        // Fetch applicants/offers for customer view and hustler view (to check if already applied)
        let offers = [];
        let pendingOffers = [];
        let userOffer = null; // For hustler view - check if they already applied
        if (actualRole === 'customer') {
          try {
            const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (offersResponse.ok) {
              offers = await offersResponse.json();
              pendingOffers = offers.filter(o => o.status === 'PENDING');
              
              // Sync localStorage from backend for each offer
              offers.forEach(offer => {
                if (offer.proposedAmount) {
                  const originalKey = `hustlerOriginalOffer_${offer.id}`;
                  if (!localStorage.getItem(originalKey)) {
                    // Store original if not stored yet
                    localStorage.setItem(originalKey, offer.proposedAmount.toString());
                  }
                }
              });
            }
          } catch (e) {
            console.error("Error fetching offers:", e);
          }
        } else if (!isCustomer && !isHustler && job.status === 'OPEN') {
          // Hustler viewing job - check if they already applied
          try {
            const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (offersResponse.ok) {
              const allOffers = await offersResponse.json();
              userOffer = allOffers.find(o => o.hustlerId === user.id && o.status === 'PENDING');
              
              // Store original offer if not stored
              if (userOffer) {
                const originalKey = `hustlerOriginalOffer_${userOffer.id}`;
                if (!localStorage.getItem(originalKey)) {
                  const originalAmount = userOffer.proposedAmount || job.amount || 0;
                  localStorage.setItem(originalKey, originalAmount.toString());
                }
              }
            }
          } catch (e) {
            console.error("Error fetching offers:", e);
          }
        }
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'viewJobModal';
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Get requirements for additional fields
        const requirements = job.requirements || {};
        const pricingOption = requirements.pricing_option;
        const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
        const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
        const keepActiveFor = requirements.keepActiveFor;
        // Check both expiresAt field and requirements.expiresAt for backward compatibility
        const expiresAt = job.expiresAt ? new Date(job.expiresAt) : (requirements.expiresAt ? new Date(requirements.expiresAt) : null);
        const preferredTime = requirements.preferredTime || 'anytime';
        
        // Format pay
        const payType = job.payType || 'flat';
        let payDisplay = '';
        if (pricingOption === 'hustlers_quote') {
          payDisplay = '💰 Hustler suggests price';
        } else if (payType === 'hourly') {
          payDisplay = `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr${job.estHours ? ` (max ${job.estHours} hrs)` : ''}`;
        } else {
          payDisplay = `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
        }
        
        // Format timing display / Needed By
        let timingDisplay = '';
        let neededByDisplay = '';
        
        if (deadlinePreference === 'until_completed') {
          timingDisplay = 'Until completed (no strict deadline)';
        } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
          timingDisplay = 'Flexible this week';
        } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
          timingDisplay = 'Today – ASAP';
        } else if (deadlinePreference === 'tomorrow') {
          timingDisplay = 'Tomorrow';
        } else if (deadlinePreference === 'custom' && job.startTime) {
          const deadlineDate = new Date(job.startTime);
          timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } else if (job.startTime) {
          const deadlineDate = new Date(job.startTime);
          timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } else {
          timingDisplay = 'Not specified';
        }
        
        // Format "Needed By" using endTime (the actual deadline)
        // Show Needed By for jobs with specific deadlines (not flexible/no deadline)
        if (deadlinePreference && 
            deadlinePreference !== 'until_completed' && 
            deadlinePreference !== 'whenever' && 
            deadlinePreference !== 'flexible' &&
            deadlinePreference !== 'flexible_week' &&
            deadlinePreference !== 'no_deadline') {
          let neededByDate;
          
          if (job.endTime) {
            neededByDate = new Date(job.endTime);
          } else if (deadlinePreference === 'today_asap' && job.date) {
            // For today_asap, use today at 11:59 PM local time
            neededByDate = new Date(job.date);
            neededByDate.setHours(23, 59, 59, 999);
          } else if (deadlinePreference === 'tomorrow' && job.date) {
            // For tomorrow, use tomorrow at end of day
            neededByDate = new Date(job.date);
            neededByDate.setHours(23, 59, 59, 999);
          } else if (deadlinePreference === 'specific_date' && job.date) {
            // For specific date, use the job date + end time if available
            neededByDate = new Date(job.date);
            if (job.endTime) {
              neededByDate = new Date(job.endTime);
            } else {
              // Default to end of selected day
              neededByDate.setHours(23, 59, 59, 999);
            }
          }
          
          if (neededByDate && !isNaN(neededByDate.getTime())) {
            neededByDisplay = neededByDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric', 
              year: 'numeric'
            }) + ', ' + neededByDate.toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit'
            });
          }
        }
        
        // Format date/time
        const jobDate = new Date(job.date);
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        // Format location
        const pickupArea = requirements.pickup_area || requirements.pickupArea;
        const pickupCity = requirements.pickup_city || requirements.pickupCity;
        const pickupZip = requirements.pickup_zip;
        const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
        const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
        const dropoffZip = requirements.dropoff_zip;
        const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
        
        let locationDisplay = job.address || 'Address not specified';
        if (pickupArea || pickupCity) {
          const pickupParts = [];
          if (pickupArea) pickupParts.push(pickupArea);
          if (pickupCity) pickupParts.push(pickupCity);
          if (pickupZip) pickupParts.push(pickupZip);
          locationDisplay = pickupParts.join(', ');
          
          if (!onSiteOnly && (dropoffArea || dropoffCity)) {
            const dropoffParts = [];
            if (dropoffArea) dropoffParts.push(dropoffArea);
            if (dropoffCity) dropoffParts.push(dropoffCity);
            if (dropoffZip) dropoffParts.push(dropoffZip);
            locationDisplay += ` → ${dropoffParts.join(', ')}`;
          } else if (onSiteOnly) {
            locationDisplay += ' (Single location job)';
          }
        }
        
        // Format workers display
        let workersDisplay = '';
        if (teamSize === 0) {
          workersDisplay = 'Company / crew job';
        } else if (teamSize === 1) {
          workersDisplay = '1 worker';
        } else {
          workersDisplay = `${teamSize} workers`;
        }
        
        // Format expiration - check if keepOpenUntilAccepted is enabled
        const isKeepOpenEnabled = requirements.keepOpenUntilAccepted === true;
        let expirationDisplay = '';
        let expirationColor = '#059669';
        if (isKeepOpenEnabled) {
          expirationDisplay = 'Stays open until hustler assigned';
          expirationColor = '#1e40af';
        } else if (expiresAt && expiresAt > new Date()) {
          const now = new Date();
          const diff = expiresAt - now;
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          
          // Check if expires today (local time)
          const expiresDate = new Date(expiresAt);
          const today = new Date();
          const isToday = expiresDate.toDateString() === today.toDateString();
          
          if (isToday) {
            expirationDisplay = `Expires today (${hours}h ${minutes}m)`;
            expirationColor = '#dc2626';
          } else if (hours < 24) {
            expirationDisplay = `Expires in ${hours}h ${minutes}m`;
            expirationColor = '#f59e0b';
          } else {
            const days = Math.floor(hours / 24);
            expirationDisplay = `Expires in ${days}d ${hours % 24}h`;
            expirationColor = '#059669';
          }
        } else if (expiresAt && expiresAt <= new Date()) {
          expirationDisplay = 'Expired';
          expirationColor = '#dc2626';
        }
        
        // Format preferred time
        const preferredTimeLabels = {
          'morning': '🌅 Morning (8am - 12pm)',
          'afternoon': '☀️ Afternoon (12pm - 5pm)',
          'evening': '🌆 Evening (5pm - 9pm)',
          'anytime': '⏰ Anytime / Flexible'
        };
        const preferredTimeDisplay = preferredTimeLabels[preferredTime] || '⏰ Anytime / Flexible';
        
        // Category icon
        const categoryIcons = {
          'Moving / Hauling': '🚚',
          'Yard work / Outdoor': '🌿',
          'Cleaning / Organizing': '🧹',
          'Furniture / Assembly': '🛠',
          'Other': '⭐'
        };
        const categoryIcon = categoryIcons[job.category] || '📋';
        
        // Posted date - calculate hours ago
        const postedDate = new Date(job.createdAt);
        const hoursAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60));
        const minutesAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60));
        let postedText = '';
        if (minutesAgo < 60) {
          postedText = minutesAgo < 1 ? 'Just now' : `${minutesAgo} ${minutesAgo === 1 ? 'minute' : 'minutes'} ago`;
        } else if (hoursAgo < 24) {
          postedText = `${hoursAgo} ${hoursAgo === 1 ? 'hour' : 'hours'} ago`;
        } else {
          const daysAgo = Math.floor(hoursAgo / 24);
          postedText = `${daysAgo} ${daysAgo === 1 ? 'day' : 'days'} ago`;
        }
        
        if (actualRole === 'customer') {
          // CUSTOMER VIEW - Simplified: Essential info + Applicants
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 900px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeViewJobModal" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
                transition: all 0.2s;
              ">×</button>
              
              <div style="padding: 2.5rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <!-- Job Header - Essential Info -->
                <div style="margin-bottom: 2.5rem; padding: 2rem; background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); text-align: center;">
                  <h2 style="font-size: 2rem; font-weight: 700; margin: 0 0 1.5rem 0; color: #1a1a1a; letter-spacing: -0.02em; line-height: 1.2;">${job.title || 'Untitled Job'}</h2>
                  <div style="display: flex; flex-direction: column; gap: 1rem; align-items: center; max-width: 500px; margin: 0 auto;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: #059669; padding: 0.75rem 1.5rem; background: #d1fae5; border-radius: 10px; width: 100%;">${payDisplay}</div>
                    <div style="font-size: 1rem; color: #4a4a4a; font-weight: 600;">👥 ${workersDisplay}</div>
                    ${(() => {
                      // Get coordinates for mini map
                      const reqLat = requirements.pickup_lat || requirements.pickupLat || job.approximateLat;
                      const reqLng = requirements.pickup_lng || requirements.pickupLng || job.approximateLng;
                      const jobLat = job.lat;
                      const jobLng = job.lng;
                      const lat = reqLat || jobLat;
                      const lng = reqLng || jobLng;
                      
                      if (lat && lng && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                        return `
                        <div style="width: 100%; margin-top: 0.5rem;">
                          <div style="font-size: 0.9rem; color: #4a4a4a; font-weight: 600; margin-bottom: 0.5rem; text-align: center;">📍 Location</div>
                          <div id="miniMap_${job.id}" style="width: 100%; height: 150px; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb; background: #e5e7eb; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" data-lat="${lat}" data-lng="${lng}">
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; color: #6a6a6a; font-size: 0.85rem;">Loading map...</div>
                            </div>
                          </div>
                        `;
                      }
                      return `<div style="font-size: 1rem; color: #4a4a4a; font-weight: 600;">📍 ${locationDisplay}</div>`;
                    })()}
                    <div style="font-size: 0.9rem; color: #6a6a6a; font-weight: 500; margin-top: 0.5rem;">${postedText}</div>
                  </div>
                </div>
                
                <!-- Job Description -->
                ${job.description ? `
                <div style="margin-bottom: 2.5rem; padding: 2rem; background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                  <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1.25rem 0; color: #1a1a1a; letter-spacing: -0.01em; text-align: center;">📝 Description</h3>
                  <div style="color: #2a2a2a; line-height: 1.8; white-space: pre-wrap; font-size: 1rem; text-align: left; max-width: 700px; margin: 0 auto;">${job.description}</div>
                </div>
                ` : ''}
                
                <!-- Applicants Section -->
                ${job.status === 'OPEN' ? `
                <div style="margin-bottom: 2rem;">
                  <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 2rem 0; color: #1a1a1a; letter-spacing: -0.01em; text-align: center;">
                    👥 Applicants${pendingOffers.length > 0 ? ` (${pendingOffers.length})` : ''}
                    </h3>
                  ${pendingOffers.length > 0 ? `
                  
                  <div id="applicantsListContainer" style="display: flex; flex-direction: column; gap: 2rem; max-width: 800px; margin: 0 auto;">
                    ${pendingOffers.map(offer => {
                      const hustler = offer.hustler || {};
                      const rating = hustler.ratingAvg || 0;
                      const ratingCount = hustler.ratingCount || 0;
                      const jobAmount = parseFloat(job.amount || 0);
                      const hourlyRate = parseFloat(job.hourlyRate || 0);
                      const maxHours = Number(job.estHours) || Number(job.requirements?.maxHours) || 0;
                      const proposedAmount = offer.proposedAmount ? parseFloat(offer.proposedAmount) : null;
                      const payType = job.payType || 'flat';
                      
                      // Calculate customer's original price display
                      let customerPriceDisplay = '';
                      if (payType === 'hourly' && hourlyRate > 0) {
                        const maxTotal = hourlyRate * (maxHours || 0);
                        if (maxHours > 0) {
                          customerPriceDisplay = `$${hourlyRate.toFixed(0)}/hr (maximum ${maxHours} hours = $${maxTotal.toFixed(0)} total)`;
                        } else {
                          customerPriceDisplay = `$${hourlyRate.toFixed(0)}/hr`;
                        }
                      } else {
                        customerPriceDisplay = `$${jobAmount.toFixed(0)} total (flat rate)`;
                      }
                      
                      // Format for display in the accepted price box
                      const acceptedPriceDisplay = customerPriceDisplay;
                      
                      // Check if hustler suggested a different price
                      const hasSuggestedPrice = proposedAmount && (
                        (payType === 'hourly' && Math.abs(proposedAmount - hourlyRate) > 0.01) ||
                        (payType === 'flat' && Math.abs(proposedAmount - jobAmount) > 0.01)
                      );
                      
                      const suggestedPriceDisplay = proposedAmount ? 
                        (payType === 'hourly' ? `$${proposedAmount.toFixed(0)}/hr` : `$${proposedAmount.toFixed(0)} total`) : 
                        customerPriceDisplay;
                      
                      return `
                        <div data-offer-id="${offer.id}" style="
                          padding: 2rem;
                          border: 2px solid #e5e7eb;
                          border-radius: 16px;
                          background: white;
                          box-shadow: 0 4px 6px rgba(0,0,0,0.07);
                          transition: all 0.3s;
                        " class="applicant-card" onmouseenter="this.style.boxShadow='0 8px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)'" onmouseleave="this.style.boxShadow='0 4px 6px rgba(0,0,0,0.07)'; this.style.transform='translateY(0)'">
                          <div style="text-align: center; margin-bottom: 1.25rem;">
                            <div style="display: inline-block; margin-bottom: 0.75rem;">
                              ${renderUserAvatar(hustler, 80, { 
                              className: 'viewApplicantProfile',
                              style: 'cursor: pointer;'
                            })}
                              </div>
                            <div>
                              <div style="font-weight: 700; color: #1a1a1a; font-size: 1.5rem; cursor: pointer; letter-spacing: -0.01em; margin-bottom: 0.5rem;" class="viewApplicantProfile" data-user-id="${hustler.id}">${hustler.name || 'Unknown'}</div>
                              <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0;">
                                <span style="font-size: 1.1rem;">${'⭐'.repeat(Math.floor(rating))}${rating % 1 >= 0.5 ? '⭐' : ''}</span>
                                <span style="color: #4a4a4a; font-size: 1rem; font-weight: 600;">${rating.toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                              </div>
                                        </div>
                                      </div>
                                      
                          <!-- Customer's Original Price -->
                          <div style="padding: 1rem; background: #f0f9ff; border-radius: 12px; border: 2px solid #3b82f6; margin-bottom: 1rem; text-align: center;">
                            <div style="font-size: 0.85rem; color: #1e40af; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: 0.5px;">YOUR PRICE</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #1e40af; line-height: 1.2;">${customerPriceDisplay}</div>
                            <div style="font-size: 0.75rem; color: #3b82f6; margin-top: 0.5rem; font-style: italic;">Maximum you're willing to pay</div>
                          </div>
                          
                          ${hasSuggestedPrice ? `
                          <!-- Suggested New Price from Hustler - Yellow -->
                          <div style="padding: 1rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px solid #f59e0b; margin-bottom: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);">
                            <div style="font-size: 0.85rem; color: #92400e; font-weight: 700; margin-bottom: 0.375rem; letter-spacing: 0.5px; text-transform: uppercase;">💡 Suggested New Price from Hustler</div>
                            <div style="font-size: 1.75rem; font-weight: 700; color: #b45309; line-height: 1.2;">${suggestedPriceDisplay}</div>
                            <div style="font-size: 0.75rem; color: #92400e; margin-top: 0.375rem; font-style: italic;">If you accept this hustler, this becomes the official price</div>
                                  </div>
                          ` : `
                          <!-- No Price Suggestion - Show Original Price -->
                          <div style="padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #10b981; margin-bottom: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);">
                            <div style="font-size: 0.9rem; color: #047857; font-weight: 700; margin-bottom: 0.375rem; letter-spacing: 0.5px;">Hustler Accepted Your Price</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #059669; line-height: 1.3;">${acceptedPriceDisplay}</div>
                                </div>
                          `}
                          
                          <!-- Why I'm a good fit -->
                          ${offer.note ? `
                          <div style="padding: 1.25rem; background: #f0fdf4; border-radius: 12px; border: 2px solid #10b98140; margin-bottom: 1.25rem;">
                            <div style="font-size: 1.1rem; color: #047857; margin-bottom: 0.75rem; font-weight: 700; letter-spacing: -0.01em; text-align: center;">💬 Why I'm a good fit:</div>
                            <div style="color: #2a2a2a; line-height: 1.7; font-size: 1rem; font-weight: 500; text-align: left;">${offer.note}</div>
                                  </div>
                                ` : ''}
                          
                          <!-- Accept/Deny Buttons -->
                          <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                            <button class="btn btn-primary acceptApplicantBtn" data-offer-id="${offer.id}" data-job-id="${job.id}" style="flex: 1; min-width: 180px; padding: 1.25rem; font-weight: 700; font-size: 1.1rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">✅ Accept</button>
                            <button class="btn btn-ghost declineApplicantBtn" data-offer-id="${offer.id}" data-job-id="${job.id}" style="flex: 1; min-width: 180px; padding: 1.25rem; font-weight: 700; font-size: 1.1rem; color: #dc2626; border-color: #fecaca; border-radius: 12px; border-width: 2px;">❌ Deny</button>
                              </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                  ` : `
                  <div style="text-align: center; padding: 3rem 2rem; background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.07);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">👤</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #4a4a4a; margin-bottom: 0.5rem;">No applicants yet</div>
                    <div style="font-size: 1rem; color: #6a6a6a;">Share your job to get more applicants!</div>
                </div>
                  `}
                    </div>
                    ` : ''}
              </div>
            </div>
          `;
        } else {
          // HUSTLER VIEW - Job details with apply option
          // Fetch customer profile data (completed jobs count and reviews) before building modal
          let customerProfileData = { completedJobsCount: 0, reviews: [] };
          if (job.customer && job.customer.id) {
            try {
              const profileResponse = await fetch(`${API_BASE}/users/${job.customer.id}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
              });
              if (profileResponse.ok) {
                const profileData = await profileResponse.json();
                customerProfileData.completedJobsCount = profileData.completedJobsCount || 0;
              }
              
              const reviewsResponse = await fetch(`${API_BASE}/reviews?userId=${job.customer.id}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
              });
              if (reviewsResponse.ok) {
                const reviewsData = await reviewsResponse.json();
                customerProfileData.reviews = Array.isArray(reviewsData) ? reviewsData : [];
              }
            } catch (e) {
              console.error('Error fetching customer profile:', e);
            }
          }
          
          const last5Reviews = customerProfileData.reviews
            .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
            .slice(0, 5);
          
          let reviewsHTML = '';
          if (last5Reviews.length === 0) {
            reviewsHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">No reviews yet.</div>';
          } else {
            reviewsHTML = last5Reviews.map(review => `
              <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.1rem;">${'⭐'.repeat(review.stars || review.rating || 0)}</span>
                  <span style="font-weight: 600; color: var(--text-main);">${review.stars || review.rating || 0}/5</span>
                  ${review.reviewer ? `<span style="font-size: 0.85rem; color: var(--text-muted);">by ${review.reviewer.name || 'Anonymous'}</span>` : ''}
                </div>
                ${review.text ? `<div style="color: var(--text-main); margin-bottom: 0.5rem; line-height: 1.5;">${review.text}</div>` : ''}
                ${review.job ? `<div style="font-size: 0.8rem; color: var(--text-muted);">${review.job.title || 'Untitled Job'}</div>` : ''}
              </div>
            `).join('');
          }
          
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 800px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeViewJobModal" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
              ">×</button>
              
              <div style="padding: 2rem;">
                <!-- Job Header -->
                <div style="margin-bottom: 2rem;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <span style="font-size: 2rem;">${categoryIcon}</span>
                    <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                    <span style="padding: 0.35rem 0.75rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-weight: 600;">${job.category || 'General'}</span>
                    <span style="font-weight: 600; color: var(--text-main);">💰 ${payDisplay}</span>
                    <span style="padding: 0.35rem 0.75rem; background: #10b98120; color: #10b981; border-radius: 6px; font-weight: 600;">${job.status || 'Open'}</span>
                  </div>
                </div>
                
                <!-- Full Job Description -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid var(--border);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">📝 Full Description</h3>
                  <div style="color: var(--text-main); line-height: 1.7; white-space: pre-wrap;">${job.description || 'No description provided.'}</div>
                </div>
                
                <!-- Job Details Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">💰 Pay</div>
                    <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">${payDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">👥 Workers</div>
                    <div style="font-weight: 600; color: var(--text-main);">${workersDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">📍 Location</div>
                    <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem;">${actualRole === 'customer' ? '💬 Message hustler for exact location' : '💬 Message customer for exact location'}</div>
                  </div>
                </div>
                
                ${requirements.notes ? `
                <!-- Notes Section -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 1px solid #fbbf24;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #92400e;">📝 Additional Notes</h3>
                  <div style="color: #92400e; line-height: 1.7; white-space: pre-wrap;">${requirements.notes}</div>
                </div>
                ` : ''}
                
                ${requirements.equipment_needed && requirements.equipment_needed.length > 0 ? `
                <!-- Equipment Needed -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #eff6ff; border-radius: 12px; border: 1px solid #3b82f6;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #1e40af;">🔧 Equipment Needed</h3>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${requirements.equipment_needed.map(eq => `<span style="padding: 0.5rem 1rem; background: white; border: 1px solid #3b82f6; border-radius: 6px; font-size: 0.9rem; color: #1e40af; font-weight: 600;">${eq}</span>`).join('')}
                  </div>
                </div>
                ` : ''}
                
                <!-- Customer Profile Card Format -->
                ${job.customer ? `
                <div id="customerProfileCard_${job.customerId}" style="padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border);">
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
                    ${renderUserAvatar(job.customer, 60, { enableLightbox: true })}
                    <div style="flex: 1;">
                      <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 0.25rem 0; color: var(--text-main);">${job.customer.name || 'Customer'}</h3>
                      <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);">
                        ${job.customer.ratingAvg ? `<span>⭐ ${job.customer.ratingAvg.toFixed(1)}</span>` : ''}
                        ${job.customer.ratingCount ? `<span>(${job.customer.ratingCount} reviews)</span>` : '<span>No reviews yet</span>'}
                      </div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem; padding: 0.75rem; background: white; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600;">📋 Completed Jobs</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${customerProfileData.completedJobsCount}</div>
                  </div>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">About this person</div>
                    <div style="color: var(--text-main); line-height: 1.6; padding: 0.75rem; background: white; border-radius: 8px; min-height: 40px;">
                      ${job.customer.bio && job.customer.bio.trim() ? job.customer.bio : '<span style="color: var(--text-muted);">This person hasn\'t added anything about themselves yet.</span>'}
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">Reviews</div>
                    <button class="viewLast5ReviewsBtn_modal_${job.customerId}" style="
                      width: 100%;
                      padding: 0.75rem 1rem;
                      background: var(--primary);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      font-weight: 600;
                      cursor: pointer;
                      font-size: 0.9rem;
                      transition: all 0.2s;
                    " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                      View last 5 reviews
                    </button>
                    <div class="reviewsDropdown_modal_${job.customerId}" style="
                      display: none;
                      margin-top: 1rem;
                      border: 1px solid var(--border);
                      border-radius: 8px;
                      overflow: hidden;
                      max-height: 300px;
                      overflow-y: auto;
                    ">
                      <div style="padding: 1rem; text-align: center; color: var(--text-muted);">Loading reviews...</div>
                    </div>
                  </div>
                </div>
                ` : ''}
                
                <!-- Apply Section or Negotiation Section -->
                ${job.status === 'OPEN' && !isCustomer && userIsHustler && !isHustler && !userOffer ? `
                <div style="padding: 1.5rem; background: #f0fdf4; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #10b981;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💼 Apply for This Job</h3>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.75rem;">💰 Pay Rate</label>
                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--border);">
                      <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem;">Current Rate:</div>
                      <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${payDisplay}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">${payType === 'hourly' ? 'Hourly Rate' : 'Flat Rate'}</div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">💬 Why I'm a good fit</label>
                    <textarea id="applicationNoteInput" placeholder="Tell the customer why you're perfect for this job..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
                  </div>
                  
                  <button class="btn btn-primary applyToJobBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600;">✅ Apply to Job</button>
                </div>
                ` : job.status === 'OPEN' && !isHustler && userOffer ? `
                <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #f59e0b;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💬 Negotiation</h3>
                  
                  ${(() => {
                    // SIMPLE HUSTLER VIEW:
                    // 1. Store original offer (hustler's initial)
                    // 2. If proposedAmount != original, customer countered
                    // 3. Show customer's counter with accept/deny
                    
                    const currentProposed = userOffer.proposedAmount ? parseFloat(userOffer.proposedAmount) : null;
                    const jobAmount = parseFloat(job.amount || 0);
                    
                    // SIMPLE DETECTION: If proposedAmount exists and differs from job.amount, customer countered
                    // The hustler's original offer would typically match job.amount (or they didn't propose)
                    // When customer counters, proposedAmount becomes the customer's counter price
                    const customerCountered = currentProposed !== null && 
                                             Math.abs(currentProposed - jobAmount) > 0.01;
                    
                    // Check if hustler already accepted customer's counter-offer
                    const jobIsScheduled = job.status === 'SCHEDULED' || job.status === 'ASSIGNED';
                    const offerIsAccepted = userOffer.status === 'ACCEPTED';
                    const hustlerAcceptedCounter = customerCountered && jobIsScheduled && offerIsAccepted && job.hustlerId === userOffer.hustlerId;
                    
                    return `
                      <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--border);">
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600;">Most recent offer:</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-bottom: 0.25rem;">
                          $${hustlerAcceptedCounter ? currentProposed.toFixed(2) : (currentProposed || jobAmount).toFixed(2)} ${payType === 'hourly' ? '/hr' : 'flat'}
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); font-style: italic;">Sent by you</div>
                        ${hustlerAcceptedCounter ? `
                        <div style="font-size: 0.85rem; color: #059669; margin-top: 0.75rem; padding: 0.5rem; background: #d1fae5; border-radius: 6px; border: 1px solid #10b981; font-weight: 600;">
                          ✅ You accepted the customer's counter-offer! Job is now active.
                        </div>
                        ` : userOffer.status === 'PENDING' && !customerCountered ? `
                        <div style="font-size: 0.85rem; color: #d97706; margin-top: 0.75rem; padding: 0.5rem; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24;">
                          ⏳ Waiting for customer to accept offer
                        </div>
                        ` : ''}
                        ${userOffer.note ? `
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; margin-top: 0.75rem;">Your message:</div>
                        <div style="color: var(--text-main); font-size: 0.9rem; padding: 0.75rem; background: white; border-radius: 6px; border: 1px solid var(--border);">"${userOffer.note}"</div>
                        ` : ''}
                      </div>
                      
                      ${customerCountered && !hustlerAcceptedCounter ? `
                      <div style="padding: 1rem; background: #dbeafe; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #3b82f6;">
                        <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 0.75rem; font-weight: 600;">Customer counter-offer:</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af; margin-bottom: 1rem; text-align: center;">
                          $${currentProposed.toFixed(2)} ${payType === 'hourly' ? '/hr' : 'flat'}
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                          <button class="btn btn-primary acceptNegotiationBtn" data-offer-id="${userOffer.id}" data-proposed-amount="${currentProposed}" style="flex: 1; padding: 0.75rem; font-weight: 600; background: #10b981; border-color: #10b981;">✅ Accept</button>
                          <button class="btn btn-ghost denyNegotiationBtn" data-offer-id="${userOffer.id}" style="flex: 1; padding: 0.75rem; font-weight: 600; color: #dc2626; border-color: #fecaca;">❌ Deny</button>
                        </div>
                      </div>
                      ` : ''}
                      
                      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <button class="btn btn-ghost cancelApplicationBtn" data-offer-id="${userOffer.id}" style="width: 100%; padding: 0.75rem; font-weight: 600; color: #dc2626; border-color: #fecaca;">Cancel Application</button>
                      </div>
                    `;
                  })()}
                </div>
                ` : isHustler ? `
                <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; color: #1e40af; margin-bottom: 0.5rem;">✅ You've been accepted for this job!</div>
                  <div style="color: var(--text-muted); font-size: 0.9rem;">You can message the customer and view job details.</div>
                </div>
                ` : ''}
                
                <!-- Start Code Input (Hustler) - NOT for completed jobs -->
                ${isHustler && job.startCode && !job.startCodeVerified && (job.status === 'ASSIGNED' || job.status === 'SCHEDULED') && job.status !== 'PAID' ? `
                <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;">🔐 Enter Start Code</div>
                  <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;">Ask the customer for the 6-digit start code to begin the job.</div>
                  <input type="text" id="hustlerStartCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;">
                  <button class="btn btn-primary verifyHustlerStartCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-weight: 600;">Verify & Start Job</button>
                </div>
                ` : ''}
                
                <!-- Completion Code Input (Hustler) - NOT for completed jobs -->
                ${isHustler && job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified ? `
                <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;">🔐 Enter Completion Code</div>
                  <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;">Ask the customer for the 6-digit completion code to finish the job and release payment.</div>
                  <input type="text" id="hustlerCompletionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;">
                  <button class="btn btn-primary verifyHustlerCompletionCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-weight: 600;">Verify & Complete Job</button>
                </div>
                ` : ''}
                
                ${isHustler ? `
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 2rem;">
                  <button class="btn btn-primary messageCustomerBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">💬 Message Customer</button>
                  ${job.status === 'ASSIGNED' && !job.startCodeVerified ? `
                  <button class="btn btn-ghost cancelApplicationBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; color: #dc2626; border-color: #fecaca; font-weight: 600;">🚫 Cancel - Can't Do Job</button>
                  ` : ''}
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        document.body.appendChild(modalOverlay);
        
        // Initialize mini map if coordinates are available
        setTimeout(() => {
          const miniMapContainer = document.getElementById(`miniMap_${job.id}`);
          if (miniMapContainer) {
            const lat = parseFloat(miniMapContainer.dataset.lat);
            const lng = parseFloat(miniMapContainer.dataset.lng);
            
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
              // Get Mapbox token
              fetch(`${API_BASE}/jobs/mapbox-token`)
                .then(res => res.json())
                .then(data => {
                  if (data.token && typeof mapboxgl !== 'undefined') {
                    const miniMap = new mapboxgl.Map({
                      container: miniMapContainer.id,
                      style: 'mapbox://styles/mapbox/streets-v12',
                      center: [lng, lat],
                      zoom: 13,
                      interactive: false,
                      attributionControl: false
                    });
                    
                    miniMap.on('load', () => {
                      // Remove loading text
                      const loadingDiv = miniMapContainer.querySelector('div');
                      if (loadingDiv) loadingDiv.remove();
                      
                      // Add marker
                      new mapboxgl.Marker({ color: '#3b82f6' })
                        .setLngLat([lng, lat])
                        .addTo(miniMap);
                    });
                  } else {
                    // Fallback: show static map or address
                    miniMapContainer.innerHTML = `<div style="padding: 1rem; text-align: center; color: #6a6a6a; font-size: 0.85rem;">📍 ${locationDisplay}</div>`;
                  }
                })
                .catch(() => {
                  // Fallback: show address
                  miniMapContainer.innerHTML = `<div style="padding: 1rem; text-align: center; color: #6a6a6a; font-size: 0.85rem;">📍 ${locationDisplay}</div>`;
                });
            }
          }
        }, 100);
        
        // Background refresh for offers (silent, no UI indicators)
        let offerRefreshInterval = null;
        const refreshOffersSilently = async () => {
          try {
            const token = localStorage.getItem('hustl_token');
            if (!token) return;
            
            // Only refresh if modal is still open
            if (!document.body.contains(modalOverlay)) {
              if (offerRefreshInterval) {
                clearInterval(offerRefreshInterval);
                offerRefreshInterval = null;
              }
              return;
            }
            
            // Silently fetch updated offers and sync negotiation state
            if (actualRole === 'customer') {
              const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (offersResponse.ok) {
                const updatedOffers = await offersResponse.json();
                const updatedPendingOffers = updatedOffers.filter(o => o.status === 'PENDING');
                
                // Sync localStorage from backend for each offer
                updatedOffers.forEach(offer => {
                  if (offer.proposedAmount) {
                    const originalKey = `hustlerOriginalOffer_${offer.id}`;
                    const customerCounterKey = `customerCounterOffer_${offer.id}`;
                    const hustlerCounterKey = `hustlerCounterOffer_${offer.id}`;
                    
                    // Store original if not stored
                    if (!localStorage.getItem(originalKey)) {
                      localStorage.setItem(originalKey, offer.proposedAmount.toString());
                    }
                    
                    // Sync counter-offers based on proposedAmount changes
                    const currentAmount = parseFloat(offer.proposedAmount);
                    const originalAmount = parseFloat(localStorage.getItem(originalKey) || offer.proposedAmount);
                    
                    if (Math.abs(currentAmount - originalAmount) > 0.01) {
                      // Someone negotiated
                      const storedCustomerCounter = localStorage.getItem(customerCounterKey);
                      if (storedCustomerCounter) {
                        const customerAmount = parseFloat(storedCustomerCounter);
                        if (Math.abs(currentAmount - customerAmount) > 0.01) {
                          // Different from customer's - hustler counter-offered
                          localStorage.setItem(hustlerCounterKey, currentAmount.toString());
                        }
                      }
                    }
                  }
                });
                
                // Check if offers changed (status or proposedAmount)
                const offersChanged = updatedPendingOffers.length !== pendingOffers.length || 
                    offers.some((oldOffer, idx) => {
                      const newOffer = updatedOffers.find(o => o.id === oldOffer.id);
                      if (!newOffer) return true;
                      if (oldOffer.status !== newOffer.status) return true;
                      const oldAmount = oldOffer.proposedAmount ? parseFloat(oldOffer.proposedAmount) : null;
                      const newAmount = newOffer.proposedAmount ? parseFloat(newOffer.proposedAmount) : null;
                      if (oldAmount !== newAmount && (oldAmount === null || newAmount === null || Math.abs(oldAmount - newAmount) > 0.01)) {
                        return true;
                      }
                      return false;
                    });
                
                if (offersChanged) {
                  offers = updatedOffers;
                  pendingOffers = updatedPendingOffers;
                  
                  // Re-render modal to show updated negotiation state
                  if (document.body.contains(modalOverlay)) {
                    const lastRenderKey = `lastModalRender_${jobId}`;
                    const lastRender = parseInt(localStorage.getItem(lastRenderKey) || '0');
                    const now = Date.now();
                    
                    // Only re-render if it's been at least 2 seconds since last render
                    if (now - lastRender > 2000) {
                      localStorage.setItem(lastRenderKey, now.toString());
                      document.body.removeChild(modalOverlay);
                      if (offerRefreshInterval) {
                        clearInterval(offerRefreshInterval);
                        offerRefreshInterval = null;
                      }
                      setTimeout(() => {
                        showViewJobModal(jobId, actualRole);
                      }, 100);
                      return;
                    }
                  }
                }
              }
            } else if (!isCustomer && !isHustler && job.status === 'OPEN') {
              // Hustler view - check if their offer status changed
              const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (offersResponse.ok) {
                const allOffers = await offersResponse.json();
                const updatedUserOffer = allOffers.find(o => o.hustlerId === user.id && o.status === 'PENDING');
                
                if (updatedUserOffer) {
                  // Sync localStorage from backend
                  const originalKey = `hustlerOriginalOffer_${updatedUserOffer.id}`;
                  const customerCounterKey = `customerCounterOffer_${updatedUserOffer.id}`;
                  const hustlerCounterKey = `hustlerCounterOffer_${updatedUserOffer.id}`;
                  
                  // Store original if not stored
                  if (!localStorage.getItem(originalKey)) {
                    const originalAmount = updatedUserOffer.proposedAmount || job.amount || 0;
                    localStorage.setItem(originalKey, originalAmount.toString());
                  }
                  
                  // Sync counter-offers
                  const currentAmount = updatedUserOffer.proposedAmount ? parseFloat(updatedUserOffer.proposedAmount) : null;
                  const originalAmount = parseFloat(localStorage.getItem(originalKey) || updatedUserOffer.proposedAmount || job.amount || 0);
                  
                  if (currentAmount && Math.abs(currentAmount - originalAmount) > 0.01) {
                    // Someone negotiated
                    const storedCustomerCounter = localStorage.getItem(customerCounterKey);
                    if (storedCustomerCounter) {
                      const customerAmount = parseFloat(storedCustomerCounter);
                      if (Math.abs(currentAmount - customerAmount) < 0.01) {
                        // Matches customer's counter-offer
                        localStorage.removeItem(hustlerCounterKey);
                      } else {
                        // Different - hustler counter-offered
                        localStorage.setItem(hustlerCounterKey, currentAmount.toString());
                      }
                    } else {
                      // No stored customer counter-offer, but amount differs
                      // Customer must have negotiated
                      localStorage.setItem(customerCounterKey, currentAmount.toString());
                      localStorage.removeItem(hustlerCounterKey);
                    }
                  }
                  
                  // Check if offer changed
                  const oldAmount = userOffer?.proposedAmount ? parseFloat(userOffer.proposedAmount) : null;
                  const newAmount = updatedUserOffer.proposedAmount ? parseFloat(updatedUserOffer.proposedAmount) : null;
                  const amountChanged = oldAmount !== newAmount && (oldAmount === null || newAmount === null || Math.abs(oldAmount - newAmount) > 0.01);
                  
                  const offerChanged = !userOffer || 
                    updatedUserOffer.status !== userOffer.status ||
                    amountChanged;
                  
                  if (offerChanged) {
                    userOffer = updatedUserOffer;
                    
                    // Re-render modal to show updated negotiation state
                    if (document.body.contains(modalOverlay)) {
                      const lastRenderKey = `lastModalRender_${jobId}`;
                      const lastRender = parseInt(localStorage.getItem(lastRenderKey) || '0');
                      const now = Date.now();
                      
                      // Only re-render if it's been at least 2 seconds since last render
                      if (now - lastRender > 2000) {
                        localStorage.setItem(lastRenderKey, now.toString());
                        document.body.removeChild(modalOverlay);
                        if (offerRefreshInterval) {
                          clearInterval(offerRefreshInterval);
                          offerRefreshInterval = null;
                        }
                        setTimeout(() => {
                          showViewJobModal(jobId, actualRole);
                        }, 100);
                        return;
                      }
                    }
                  }
                }
              }
            }
          } catch (error) {
            // Silently fail - don't log or show errors during background refresh
            console.debug('[OFFERS] Background refresh error (silent):', error);
          }
        };
        
        // Start background refresh every 5 seconds (silent, no UI indicators)
        offerRefreshInterval = setInterval(refreshOffersSilently, 5000);
        
        
        // Live countdown update for expiration display
        let countdownInterval = null;
        if (expiresAt && !isKeepOpenEnabled) {
          const expirationDisplayEl = modalOverlay.querySelector(`#expirationDisplay_${job.id}`);
          if (expirationDisplayEl) {
            const updateExpirationCountdown = () => {
              const now = new Date();
              const diff = expiresAt - now;
              
              if (diff <= 0) {
                expirationDisplayEl.textContent = 'Expired';
                expirationDisplayEl.style.color = '#dc2626';
                if (countdownInterval) {
                  clearInterval(countdownInterval);
                  countdownInterval = null;
                }
                return;
              }
              
              const hours = Math.floor(diff / (1000 * 60 * 60));
              const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
              
              // Check if expires today (local time)
              const expiresDate = new Date(expiresAt);
              const today = new Date();
              const isToday = expiresDate.toDateString() === today.toDateString();
              
              let displayText = '';
              let displayColor = '#059669';
              
              if (isToday) {
                displayText = `Expires today (${hours}h ${minutes}m)`;
                displayColor = '#dc2626';
              } else if (hours < 24) {
                displayText = `Expires in ${hours}h ${minutes}m`;
                displayColor = '#f59e0b';
              } else {
                const days = Math.floor(hours / 24);
                displayText = `Expires in ${days}d ${hours % 24}h`;
                displayColor = '#059669';
              }
              
              expirationDisplayEl.textContent = displayText;
              expirationDisplayEl.style.color = displayColor;
            };
            
            // Update immediately and then every minute
            updateExpirationCountdown();
            countdownInterval = setInterval(updateExpirationCountdown, 60000);
          }
        }
        
        // Close button
        const closeModal = () => {
          if (offerRefreshInterval) {
            clearInterval(offerRefreshInterval);
            offerRefreshInterval = null;
          }
          if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
          }
          if (document.body.contains(modalOverlay)) {
            document.body.removeChild(modalOverlay);
          }
        };
        
        modalOverlay.querySelector('.closeViewJobModal')?.addEventListener('click', closeModal);
        
        // Click outside to close
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            closeModal();
          }
        });
        
        // Initialize map previews
        setTimeout(async () => {
          const mapPreviews = modalOverlay.querySelectorAll('[id^="jobMapPreview_"]');
          for (const preview of mapPreviews) {
            const lat = parseFloat(preview.dataset.lat);
            const lng = parseFloat(preview.dataset.lng);
            const jobId = preview.dataset.jobId;
            
            if (isNaN(lat) || isNaN(lng)) continue;
            
            try {
              const token = await getMapboxToken();
              if (!token) {
                preview.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Map unavailable</div>';
                continue;
              }
              
              // Initialize small map preview
              const previewMap = new mapboxgl.Map({
                container: preview,
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [lng, lat],
                zoom: 14,
                interactive: false,
                attributionControl: false
              });
              
              previewMap.on('load', () => {
                // Add marker
                new mapboxgl.Marker({
                  color: '#3b82f6',
                  anchor: 'center'
                })
                  .setLngLat([lng, lat])
                  .addTo(previewMap);
              });
              
              // Click to open Google Maps
              preview.addEventListener('click', () => {
                // Open Google Maps with job location
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat)},${encodeURIComponent(lng)}`;
                window.open(googleMapsUrl, '_blank');
              });
            } catch (error) {
              console.error('Error initializing map preview:', error);
              preview.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">Map unavailable</div>';
            }
          }
        }, 200);
        
        // Profile button event listeners - work for both customer and hustler views
        // Use setTimeout to ensure modal is fully rendered
        setTimeout(() => {
          const profileButtons = modalOverlay.querySelectorAll('.viewCustomerProfile, .viewCustomerProfileBtn, .viewHustlerProfile, .viewHustlerProfileBtn, .viewApplicantProfile, .viewApplicantProfileBtn');
          console.log('🔵 Found profile buttons:', profileButtons.length);
          profileButtons.forEach(btn => {
            const userId = btn.dataset.userId || btn.getAttribute('data-user-id');
            console.log('🔵 Attaching listener to button with userId:', userId, 'Classes:', btn.className);
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              e.preventDefault();
              const clickedUserId = btn.dataset.userId || btn.getAttribute('data-user-id');
              console.log('🔵 Profile button clicked, userId:', clickedUserId, 'Button:', btn, 'showHustlerProfilePopup available:', typeof window.showHustlerProfilePopup);
              if (clickedUserId && typeof window.showHustlerProfilePopup === 'function') {
                console.log('🔵 Calling showHustlerProfilePopup with userId:', clickedUserId);
                await window.showHustlerProfilePopup(clickedUserId);
              } else {
                console.error('❌ showHustlerProfilePopup not available or userId missing. userId:', clickedUserId, 'showHustlerProfilePopup type:', typeof window.showHustlerProfilePopup);
                showToast('Error: Could not load profile');
              }
            });
          });
        }, 100);
        
        // Also attach to any dynamically added profile buttons using event delegation on the modal
        modalOverlay.addEventListener('click', async (e) => {
          const profileBtn = e.target.closest('.viewCustomerProfileBtn, .viewHustlerProfileBtn, .viewApplicantProfileBtn, .viewCustomerProfile, .viewHustlerProfile, .viewApplicantProfile');
          if (profileBtn) {
            const userId = profileBtn.dataset.userId || profileBtn.getAttribute('data-user-id');
            if (userId) {
              e.stopPropagation();
              e.preventDefault();
              console.log('🔵 Profile button clicked (delegation), userId:', userId, 'showHustlerProfilePopup available:', typeof window.showHustlerProfilePopup);
              if (typeof window.showHustlerProfilePopup === 'function') {
                await window.showHustlerProfilePopup(userId);
              } else {
                console.error('❌ showHustlerProfilePopup not available');
                showToast('Error: Could not load profile');
              }
            }
          }
        });
        
        // Event listeners for customer view
        if (actualRole === 'customer') {
          // Accept/Decline applicants
          modalOverlay.querySelectorAll('.acceptApplicantBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId;
              await acceptOffer(offerId, jobId, modalOverlay);
            });
          });
          
          modalOverlay.querySelectorAll('.declineApplicantBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId || job.id;
              if (confirm('Are you sure you want to decline this applicant? They will be removed from the applicants list.')) {
                await declineOffer(offerId, jobId, modalOverlay);
              }
            });
          });
          
          // Negotiate price
          // Handle both negotiatePriceBtn (old) and suggestPriceBtn (new)
          modalOverlay.querySelectorAll('.negotiatePriceBtn, .suggestPriceBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId;
              showNegotiatePriceModal(offerId, jobId, modalOverlay);
            });
          });
          
          // Accept hustler's counter-offer (customer side)
          modalOverlay.querySelectorAll('.acceptHustlerCounterOfferBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const proposedAmount = btn.dataset.proposedAmount;
              if (!offerId) return;
              
              try {
                const token = localStorage.getItem('hustl_token');
                if (!token) {
                  showToast('Please log in');
                  return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Accepting...';
                
                // Customer accepts hustler's counter-offer
                showToast('✅ You accepted the hustler\'s counter-offer. You can now officially accept this applicant.');
                document.body.removeChild(modalOverlay);
                
                // Refresh the view
                if (typeof loadPostedJobs === 'function') {
                  loadPostedJobs();
                } else if (typeof showViewJobModal === 'function') {
                  setTimeout(() => {
                    showViewJobModal(job.id, 'customer');
                  }, 500);
                }
              } catch (error) {
                showToast('Error: ' + (error.message || 'Failed to accept'));
                btn.disabled = false;
                btn.textContent = '✅ Accept';
              }
            });
          });
          
          // Deny hustler's counter-offer (customer side - show counter-offer option)
          modalOverlay.querySelectorAll('.denyHustlerCounterOfferBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              if (!offerId) return;
              
              // Show the counter-offer section
              const counterSection = document.getElementById(`customerCounterOfferSection_${offerId}`);
              if (counterSection) {
                counterSection.style.display = counterSection.style.display === 'none' ? 'block' : 'none';
                if (counterSection.style.display === 'block') {
                  // Focus the input
                  const input = document.getElementById(`customerCounterOfferInput_${offerId}`);
                  if (input) {
                    setTimeout(() => input.focus(), 100);
                  }
                }
              }
            });
          });
          
          // Submit customer counter-offer (customer sends counter-offer to hustler)
          modalOverlay.querySelectorAll('.submitCustomerCounterOfferBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              if (!offerId) return;
              
              const input = document.getElementById(`customerCounterOfferInput_${offerId}`);
              const proposedAmount = parseFloat(input?.value || 0);
              
              if (!proposedAmount || proposedAmount <= 0) {
                showToast('Please enter a valid price');
                return;
              }
              
              try {
                const token = localStorage.getItem('hustl_token');
                if (!token) {
                  showToast('Please log in to send counter-offer');
                  return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Sending...';
                
                const response = await fetch(`${API_BASE}/offers/${offerId}/negotiate`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ proposedAmount })
                });
                
                if (!response.ok) {
                  const error = await response.json();
                  throw new Error(error.error || 'Failed to send counter-offer');
                }
                
                // Store customer's counter-offer in localStorage
                // Clear hustler counter-offer since customer just responded
                const customerCounterOfferKey = `customerCounterOffer_${offerId}`;
                const hustlerCounterOfferKey = `hustlerCounterOffer_${offerId}`;
                localStorage.setItem(customerCounterOfferKey, proposedAmount.toString());
                localStorage.removeItem(hustlerCounterOfferKey); // Clear hustler's counter-offer since customer responded
                
                // Mark as recently negotiated
                const negotiationKey = `negotiated_${offerId}`;
                localStorage.setItem(negotiationKey, 'true');
                setTimeout(() => {
                  localStorage.removeItem(negotiationKey);
                }, 3600000);
                
                showToast('✅ Counter-offer sent to hustler!');
                document.body.removeChild(modalOverlay);
                
                // Refresh the view
                if (typeof loadPostedJobs === 'function') {
                  loadPostedJobs();
                } else if (typeof showViewJobModal === 'function') {
                  setTimeout(() => {
                    showViewJobModal(job.id, 'customer');
                  }, 500);
                }
              } catch (error) {
                showToast('Error: ' + (error.message || 'Failed to send counter-offer'));
                btn.disabled = false;
                btn.textContent = '💬 Send Counter-Offer';
              }
            });
          });
          
          // Edit/Close/Repost job
          modalOverlay.querySelector('.editJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            document.body.removeChild(modalOverlay);
            await loadJobForEdit(job.id);
          });
          
          // Update expiration display when checkbox changes
          const keepOpenCheckbox = modalOverlay.querySelector('#keepOpenUntilAccepted');
          const expirationDisplayElement = modalOverlay.querySelector(`#expirationDisplay_${job.id}`);
          const expirationContainer = expirationDisplayElement?.parentElement;
          
          if (keepOpenCheckbox && expirationDisplayElement && expirationContainer) {
            keepOpenCheckbox.addEventListener('change', (e) => {
              const isChecked = e.target.checked;
              if (isChecked) {
                expirationDisplayElement.textContent = 'Stays open until hustler assigned';
                expirationDisplayElement.style.color = '#1e40af';
                expirationContainer.style.background = '#dbeafe';
                expirationContainer.style.borderColor = '#3b82f6';
              } else {
                // Recalculate expiration based on expiresAt
                const requirements = job.requirements || {};
                const expiresAt = requirements.expiresAt ? new Date(requirements.expiresAt) : null;
                if (expiresAt && expiresAt > new Date()) {
                  const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
                  expirationDisplayElement.textContent = `Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}`;
                  expirationDisplayElement.style.color = '#d97706';
                  expirationContainer.style.background = '#fef3c7';
                  expirationContainer.style.borderColor = '#fbbf24';
                } else if (expiresAt && expiresAt <= new Date()) {
                  expirationDisplayElement.textContent = 'Expired — Repost?';
                  expirationDisplayElement.style.color = '#dc2626';
                  expirationContainer.style.background = '#fee2e2';
                  expirationContainer.style.borderColor = '#fca5a5';
                } else {
                  expirationDisplayElement.textContent = '';
                }
              }
            });
          }
          
          // Save keep open setting button
          modalOverlay.querySelector('.saveKeepOpenSettingBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const keepOpenUntilAccepted = modalOverlay.querySelector('#keepOpenUntilAccepted')?.checked || false;
            await cancelJob(job.id, keepOpenUntilAccepted, true); // true = just updating setting, not canceling
            // Refresh the modal to show updated expiration
            document.body.removeChild(modalOverlay);
            showViewJobModal(job.id, 'customer');
          });
          
          modalOverlay.querySelector('.cancelJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const keepOpenUntilAccepted = modalOverlay.querySelector('#keepOpenUntilAccepted')?.checked || false;
            if (confirm(`Are you sure you want to cancel this job?${keepOpenUntilAccepted ? ' (Job will stay active until a hustler is assigned)' : ''}`)) {
              await cancelJob(job.id, keepOpenUntilAccepted);
              document.body.removeChild(modalOverlay);
              loadPostedJobs();
            }
          });
          
          modalOverlay.querySelectorAll('.repostJobBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await repostJob(job.id);
              document.body.removeChild(modalOverlay);
              loadPostedJobs();
            });
          });
        } else {
          // Event listeners for hustler view
          // Negotiate price checkbox - Use both inline onclick (for immediate response) and event listener (as backup)
          // Apply to job
          modalOverlay.querySelector('.applyToJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const note = document.getElementById('applicationNoteInput')?.value.trim() || '';
            
            const result = await applyToJob(job.id, note, null, null);
            document.body.removeChild(modalOverlay);
            // Refresh jobs list to remove the applied job from Browse Jobs
            if (typeof renderJobs === 'function') {
              // Reset the jobs list and reload
              allLoadedJobs = [];
              await renderJobs(true);
            }
            // showToast is handled inside applyToJob function
          });
          
          // Cancel application (for negotiation view)
          modalOverlay.querySelectorAll('.cancelApplicationBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId;
              if (offerId) {
                // Cancel pending application
                if (confirm('Are you sure you want to cancel this application?')) {
                  try {
                    const token = localStorage.getItem('hustl_token');
                    const response = await fetch(`${API_BASE}/offers/${offerId}/cancel`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.error || 'Failed to cancel application');
                    }
                    showToast('✅ Application cancelled');
                    document.body.removeChild(modalOverlay);
                    if (typeof loadActiveJobs === 'function') loadActiveJobs();
                  } catch (error) {
                    showToast('Error: ' + (error.message || 'Failed to cancel'));
                  }
                }
              } else if (jobId) {
                // Cancel accepted job
                if (confirm('Are you sure you want to cancel this job? You cannot do it anymore. The customer will be notified and the job will be reopened for other applicants. This action cannot be undone.')) {
                  await cancelApplication(jobId);
                  document.body.removeChild(modalOverlay);
                  if (typeof loadActiveJobs === 'function') loadActiveJobs();
                }
              }
            });
          });
          
          // Accept negotiation (hustler accepts customer's counter-offer)
          modalOverlay.querySelectorAll('.acceptNegotiationBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              if (!offerId) return;
              
              try {
                const token = localStorage.getItem('hustl_token');
                if (!token) {
                  showToast('Please log in');
                  return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Accepting...';
                
                // Call backend endpoint to accept negotiation
                const response = await fetch(`${API_BASE}/offers/${offerId}/accept-negotiation`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });
                
                if (!response.ok) {
                  const error = await response.json();
                  throw new Error(error.error || 'Failed to accept negotiation');
                }
                
                const result = await response.json();
                showToast('✅ ' + result.message);
                
                // Close modal and refresh
                document.body.removeChild(modalOverlay);
                
                // Refresh the view
                if (typeof loadActiveJobs === 'function') {
                  loadActiveJobs();
                } else if (typeof renderJobs === 'function') {
                  await renderJobs(true);
                } else if (typeof loadAppliedJobs === 'function') {
                  await loadAppliedJobs();
                }
              } catch (error) {
                showToast('Error: ' + (error.message || 'Failed to accept'));
                btn.disabled = false;
                btn.textContent = '✅ Accept';
              }
            });
          });
          
          // Deny negotiation (hustler rejects customer's counter-offer - show counter-offer option)
          modalOverlay.querySelectorAll('.denyNegotiationBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              if (!offerId) return;
              
              // Show the counter-offer section
              const counterSection = document.getElementById(`counterOfferSection_${offerId}`);
              if (counterSection) {
                counterSection.style.display = counterSection.style.display === 'none' ? 'block' : 'none';
                if (counterSection.style.display === 'block') {
                  // Focus the input
                  const input = document.getElementById(`hustlerCounterOffer_${offerId}`);
                  if (input) {
                    setTimeout(() => input.focus(), 100);
                  }
                }
              }
            });
          });
          
          // Submit counter-offer (hustler sends counter-offer to customer)
          modalOverlay.querySelectorAll('.submitCounterOfferBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              if (!offerId) return;
              
              const input = document.getElementById(`hustlerCounterOffer_${offerId}`);
              const proposedAmount = parseFloat(input?.value || 0);
              
              if (!proposedAmount || proposedAmount <= 0) {
                showToast('Please enter a valid price');
                return;
              }
              
              try {
                const token = localStorage.getItem('hustl_token');
                if (!token) {
                  showToast('Please log in to send counter-offer');
                  return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Sending...';
                
                const response = await fetch(`${API_BASE}/offers/${offerId}/hustler-counter`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ proposedAmount })
                });
                
                if (!response.ok) {
                  const error = await response.json();
                  throw new Error(error.error || 'Failed to send counter-offer');
                }
                
                // Update localStorage to track hustler's counter-offer
                // Clear customer counter-offer since hustler just responded
                const hustlerCounterOfferKey = `hustlerCounterOffer_${offerId}`;
                const customerCounterOfferKey = `customerCounterOffer_${offerId}`;
                localStorage.setItem(hustlerCounterOfferKey, proposedAmount.toString());
                localStorage.removeItem(customerCounterOfferKey); // Clear customer's counter-offer since hustler responded
                
                showToast('✅ Counter-offer sent to customer!');
                document.body.removeChild(modalOverlay);
                
                // Refresh the view to show updated state
                if (typeof loadActiveJobs === 'function') {
                  loadActiveJobs();
                } else if (typeof renderJobs === 'function') {
                  await renderJobs(true);
                } else {
                  // Refresh the modal to show updated state
                  setTimeout(() => {
                    showViewJobModal(job.id, 'hustler');
                  }, 500);
                }
              } catch (error) {
                showToast('Error: ' + (error.message || 'Failed to send counter-offer'));
                btn.disabled = false;
                btn.textContent = '💬 Send Counter-Offer';
              }
            });
          });
          
          // Message customer
          modalOverlay.querySelector('.messageCustomerBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            // Set the active conversation to this job
            if (typeof window !== 'undefined' && window.activeConversationJobId !== undefined) {
              window.activeConversationJobId = job.id;
            }
            document.body.removeChild(modalOverlay);
            setView('messages');
          });
          
          // Start code verification (hustler)
          modalOverlay.querySelector('.verifyHustlerStartCodeBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const codeInput = modalOverlay.querySelector('#hustlerStartCodeInput');
            const code = codeInput?.value.trim() || '';
            if (code.length !== 6) {
              showToast("Please enter a 6-digit code");
              return;
            }
            try {
              const btn = e.target;
              btn.disabled = true;
              btn.textContent = "Verifying...";
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-start`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ code })
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.error || "Verification failed");
              }
              showToast("✅ Start code verified! Job is now active.");
              document.body.removeChild(modalOverlay);
              showViewJobModal(job.id, 'hustler');
              if (typeof loadActiveJobs === 'function') loadActiveJobs();
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to verify"));
              e.target.disabled = false;
              e.target.textContent = "Verify & Start Job";
            }
          });
          
          // Completion code verification (hustler)
          modalOverlay.querySelector('.verifyHustlerCompletionCodeBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const codeInput = modalOverlay.querySelector('#hustlerCompletionCodeInput');
            const code = codeInput?.value.trim() || '';
            if (code.length !== 6) {
              showToast("Please enter a 6-digit code");
              return;
            }
            try {
              const btn = e.target;
              btn.disabled = true;
              btn.textContent = "Verifying...";
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ code })
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.error || "Verification failed");
              }
              
              // Close the job modal
              document.body.removeChild(modalOverlay);
              
              // Show congratulations modal, then force review
              showJobCompletionFlow(data.jobId, data.customerId, data.hustlerId);
              
              // Refresh jobs
              if (typeof loadActiveJobs === 'function') loadActiveJobs();
              if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to verify"));
              e.target.disabled = false;
              e.target.textContent = "Verify & Complete Job";
            }
          });
          
          // Input validation for code inputs
          modalOverlay.querySelector('#hustlerStartCodeInput')?.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, "");
          });
          modalOverlay.querySelector('#hustlerCompletionCodeInput')?.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, "");
          });
          
          // View customer profile
          modalOverlay.querySelectorAll('.viewCustomerProfileBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const userId = btn.dataset.userId;
              showApplicantProfileModal(userId);
            });
          });
        }
        
      } catch (error) {
        console.error("Error showing view job modal:", error);
        showToast("Error loading job details. Please try again.");
      }
    }
    
    window.showViewJobModal = showViewJobModal;
    
    // Helper functions for job actions
    async function verifyStartCode(jobId, codeParam = null) {
      try {
        // Try to get code from parameter, or from various input field IDs
        let code = codeParam;
        if (!code) {
          code = document.getElementById('startCodeInput')?.value.trim() ||
                 document.getElementById(`startCodeInput_${jobId}`)?.value.trim() ||
                 document.getElementById('hustlerStartCodeInput')?.value.trim();
        }
        
        if (!code || code.length !== 6) {
          showToast("Please enter a valid 6-digit start code.");
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/verification/job/${jobId}/verify-start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to verify start code');
        }
        
        const data = await response.json();
        showToast("✅ Start code verified! Job is now active. You can begin work.");
        loadActiveJobs(); // Refresh list
        return true;
      } catch (error) {
        console.error("Error verifying start code:", error);
        showToast(error.message || "Error verifying start code. Please check the code and try again.");
        return false;
      }
    }
    
    async function verifyCompletionCode(jobId, code) {
        const token = localStorage.getItem('hustl_token');
      
      // Helper function to check if job is completed and show success modal
      const checkAndShowSuccess = async () => {
        try {
          const jobCheckResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (jobCheckResponse.ok) {
            const jobData = await jobCheckResponse.json();
            console.log('🔍 Checking job status:', {
              completionCodeVerified: jobData.completionCodeVerified,
              status: jobData.status,
              customerId: jobData.customerId,
              hustlerId: jobData.hustlerId
            });
            
            if (jobData.completionCodeVerified && (jobData.status === 'PAID' || jobData.status === 'COMPLETED_BY_HUSTLER' || jobData.status === 'IN_PROGRESS')) {
              // Job is actually completed, show success
              console.log('✅ Job is completed! Showing success modal');
              
              // Get actual amounts from payment record (for hourly jobs, this is the actual charged amount)
              const actualJobAmount = jobData.payment?.amount || jobData.amount || 0;
              const platformFee = jobData.payment?.feeHustler || (actualJobAmount * 0.12);
              const hustlerPayout = actualJobAmount - platformFee;
              const actualHours = jobData.requirements?.actualHours || null;
              
              showCompletionSuccessModal(jobId, {
                customerId: jobData.customerId,
                hustlerId: jobData.hustlerId,
                actualJobAmount: actualJobAmount,
                hustlerPayout: hustlerPayout,
                actualHours: actualHours,
                platformFee: platformFee
              });
              if (typeof loadActiveJobs === 'function') loadActiveJobs();
              if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
              // Refresh profile stats after job completion
              if (typeof renderProfileStats === 'function') {
                setTimeout(() => renderProfileStats(), 1000);
              }
              return true;
            }
          }
        } catch (checkError) {
          console.warn('Could not check job status:', checkError);
        }
        return false;
      };
      
      try {
        const response = await fetch(`${API_BASE}/verification/job/${jobId}/verify-completion`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });
        
        // If we get a 500 error, immediately check if job is completed
        if (response.status === 500) {
          console.log('⚠️ Got 500 error, checking if job is actually completed...');
          const isCompleted = await checkAndShowSuccess();
          if (isCompleted) {
            return true; // Job is completed, modal shown
          }
        }
        
        let data;
        try {
          data = await response.json();
        } catch (parseError) {
          // If response is not JSON, check if job is actually completed
          console.log('⚠️ Could not parse JSON response, checking job status...');
          const isCompleted = await checkAndShowSuccess();
          if (isCompleted) {
            return true;
          }
          throw new Error('Failed to verify completion code');
        }
        
        if (!response.ok) {
          // Check if job is actually completed despite the error
          console.log('⚠️ Response not OK, checking if job is actually completed...');
          const isCompleted = await checkAndShowSuccess();
          if (isCompleted) {
            return true;
          }
          throw new Error(data.error || 'Failed to verify completion code');
        }
        
        // Success! Show congratulations modal
        console.log('✅ Completion verified successfully!');
        showCompletionSuccessModal(jobId, data);
        
        // Refresh profile stats after job completion
        if (typeof renderProfileStats === 'function') {
          setTimeout(() => renderProfileStats(), 2000);
        }
        
        return true;
      } catch (error) {
        console.error("Error verifying completion code:", error);
        // Final check - maybe job completed but we got an error
        const isCompleted = await checkAndShowSuccess();
        if (isCompleted) {
          return true;
        }
        
        showToast(error.message || "Error verifying completion code. Please check the code and try again.");
        return false;
      }
    }
    
    // Show completion success modal with confetti and review prompt
    // Track if modal is already showing to prevent infinite loops
    let completionModalShowing = false;
    
    function showCompletionSuccessModal(jobId, completionData) {
      // Prevent infinite recursion and duplicate modals
      if (completionModalShowing) {
        console.log('⚠️ Completion modal already showing, skipping...');
        return;
      }
      
      // Check if modal already exists
      if (document.getElementById('completionSuccessModal')) {
        console.log('⚠️ Completion modal already exists, skipping...');
        return;
      }
      
      console.log('🎉 showCompletionSuccessModal called with:', { jobId, completionData });
      completionModalShowing = true;
      
      // Get user - try getCurrentUser first, then API if needed
      let user = getCurrentUser();
      if (!user) {
        console.warn('⚠️ No user found, trying to get user from API...');
        // Get user from API and create modal with that user data
        window.hustlAPI.auth.getCurrentUser().then(userData => {
          if (userData && !document.getElementById('completionSuccessModal')) {
            console.log('✅ Got user from API, creating modal with user data');
            completionModalShowing = false; // Reset before creating
            createCompletionModal(jobId, completionData, userData);
          } else {
            console.error('❌ Could not get user or modal already exists');
            completionModalShowing = false;
          }
        }).catch(err => {
          console.error('❌ Error getting user:', err);
          completionModalShowing = false;
        });
        return;
      }
      
      // Create the modal with the user we have
      createCompletionModal(jobId, completionData, user);
    }
    
    // Separate function to create the modal (prevents recursion)
    function createCompletionModal(jobId, completionData, user) {
      // Check if modal already exists FIRST
      const existingModal = document.getElementById('completionSuccessModal');
      if (existingModal) {
        console.log('⚠️ Modal already exists, skipping...');
        completionModalShowing = false;
        return;
      }
      
      if (!user) {
        console.error('❌ No user provided to createCompletionModal');
        completionModalShowing = false;
        return;
      }
      
      // Check if this modal was already dismissed for this job/user
      const dismissedKey = `completionModalDismissed_${jobId}_${user.id}`;
      if (localStorage.getItem(dismissedKey) === 'true') {
        console.log('⚠️ Completion modal already dismissed for this job, skipping...');
        completionModalShowing = false;
        return;
      }
      
      // Check if user already submitted a review for this job
      const reviewSubmittedKey = `reviewSubmitted_${jobId}_${user.id}`;
      if (localStorage.getItem(reviewSubmittedKey) === 'true') {
        console.log('⚠️ Review already submitted for this job, skipping modal...');
        completionModalShowing = false;
        return;
      }
      
      // Set flag to prevent duplicates
      completionModalShowing = true;
      
      // Determine if user is customer or hustler
      const isCustomer = completionData.customerId === user.id;
      const isHustler = completionData.hustlerId === user.id;
      const otherUserId = isCustomer ? completionData.hustlerId : completionData.customerId;
      
      // Create confetti container
      const confettiContainer = document.createElement('div');
      confettiContainer.id = 'confettiContainer';
      confettiContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10001;
      `;
      document.body.appendChild(confettiContainer);
      
      // Create confetti particles
      const colors = ['#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#ef4444'];
      const confettiCount = 150;
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        const color = colors[Math.floor(Math.random() * colors.length)];
        const size = Math.random() * 10 + 5;
        const startX = Math.random() * 100;
        const duration = Math.random() * 3 + 2;
        const delay = Math.random() * 0.5;
        
        confetti.style.cssText = `
          position: absolute;
          width: ${size}px;
          height: ${size}px;
          background: ${color};
          left: ${startX}%;
          top: -10px;
          border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
          animation: confettiFall ${duration}s ${delay}s linear forwards;
        `;
        
        confettiContainer.appendChild(confetti);
      }
      
      // Add confetti animation
      if (!document.getElementById('confettiStyles')) {
        const style = document.createElement('style');
        style.id = 'confettiStyles';
        style.textContent = `
          @keyframes confettiFall {
            0% {
              transform: translateY(0) rotate(0deg);
              opacity: 1;
            }
            100% {
              transform: translateY(100vh) rotate(720deg);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // Remove confetti after animation
      setTimeout(() => {
        if (confettiContainer.parentNode) {
          confettiContainer.parentNode.removeChild(confettiContainer);
        }
      }, 5000);
      
      const modal = document.createElement('div');
      modal.id = 'completionSuccessModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 1rem;
        animation: fadeIn 0.3s ease;
      `;
      
      // Add fade in animation
      if (!document.getElementById('modalFadeStyles')) {
        const style = document.createElement('style');
        style.id = 'modalFadeStyles';
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
        `;
        document.head.appendChild(style);
      }
      
      modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 24px; padding: 3rem 2rem; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5); position: relative; animation: slideUp 0.4s ease;">
          <div style="text-align: center; margin-bottom: 2.5rem;">
            <div style="font-size: 6rem; margin-bottom: 1rem; animation: bounce 1s ease infinite;">🎉</div>
            <h2 style="font-size: 2.5rem; font-weight: 800; color: #1a1a1a; margin: 0 0 0.75rem 0; letter-spacing: -0.02em;">CONGRATULATIONS!</h2>
            <p style="font-size: 1.25rem; color: #4a4a4a; margin: 0; font-weight: 600;">Job Completed Successfully! 🎊</p>
          </div>
          
          <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 3px solid #16a34a; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.2);">
            <div style="font-weight: 700; color: #166534; margin-bottom: 1rem; font-size: 1.25rem; text-align: center;">💰 Payment Released</div>
            <div style="color: #166534; text-align: center; font-size: 1.1rem;">
              ${completionData.actualJobAmount ? `<div style="font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem;">$${parseFloat(completionData.actualJobAmount).toFixed(2)}</div><div style="font-size: 0.95rem; opacity: 0.9;">has been released to ${isHustler ? 'you' : 'the hustler'}</div>` : '<div style="font-size: 1.5rem; font-weight: 700;">Payment has been processed.</div>'}
              ${completionData.actualHours ? `<div style="margin-top: 1rem; font-size: 1rem; font-weight: 600; padding-top: 1rem; border-top: 2px solid rgba(22, 163, 74, 0.3);">⏱️ Final time worked: ${completionData.actualHours.toFixed(2)} hours</div>` : ''}
              ${completionData.hustlerPayout ? `<div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">After platform fee (12%): $${parseFloat(completionData.hustlerPayout).toFixed(2)}</div>` : ''}
            </div>
          </div>
          
          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; border: 3px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);">
            <div style="font-weight: 700; color: #92400e; margin-bottom: 1rem; font-size: 1.5rem; text-align: center;">🎉 Job Completed</div>
            <p style="color: #92400e; margin: 0 0 1rem 0; line-height: 1.6; text-align: center; font-size: 1.1rem; font-weight: 600;">
              Please rate your experience
            </p>
            <p style="color: #92400e; margin: 0 0 1.5rem 0; line-height: 1.6; text-align: center; font-size: 0.95rem;">
              Help build trust in the community! Rate ${isCustomer ? 'your hustler' : 'your customer'} and share your experience.
            </p>
            <button class="btn btn-primary" id="reviewNowBtn" style="width: 100%; padding: 1rem; font-weight: 700; font-size: 1.1rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); transition: transform 0.2s;">
              ⭐ Write Review Now
            </button>
            <button class="btn btn-ghost" id="reviewLaterBtn" style="width: 100%; padding: 0.75rem; margin-top: 0.75rem; color: #92400e; font-weight: 600;">
              I'll Review Later
            </button>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-primary" id="viewCompletedJobBtn" style="flex: 1; padding: 0.875rem; font-weight: 700; font-size: 1rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 12px;">
              View Completed Job
            </button>
            <button class="btn btn-ghost" id="closeCompletionModalBtn" style="flex: 1; padding: 0.875rem; font-weight: 600; border-radius: 12px;">
              Close
            </button>
          </div>
        </div>
      `;
      
      // Add slide up animation
      if (!document.getElementById('slideUpStyles')) {
        const style = document.createElement('style');
        style.id = 'slideUpStyles';
        style.textContent = `
          @keyframes slideUp {
            from {
              transform: translateY(50px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
          @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Review now button
      modal.querySelector('#reviewNowBtn')?.addEventListener('click', async () => {
        // Mark modal as dismissed (user is going to review)
        const dismissedKey = `completionModalDismissed_${jobId}_${user.id}`;
        localStorage.setItem(dismissedKey, 'true');
        
        // Fetch the other user's name
        let revieweeName = isCustomer ? 'Hustler' : 'Customer';
        try {
          const token = localStorage.getItem('hustl_token');
          const userResponse = await fetch(`${API_BASE}/users/${otherUserId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (userResponse.ok) {
            const userData = await userResponse.json();
            revieweeName = userData.name || revieweeName;
          }
        } catch (e) {
          console.warn('Could not fetch user name:', e);
        }
        
        document.body.removeChild(modal);
        document.body.style.overflow = '';
        completionModalShowing = false;
        
        // Refresh jobs to show completed status
        if (typeof loadActiveJobs === 'function') loadActiveJobs();
        if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
        // Refresh profile stats after job completion
        if (typeof renderProfileStats === 'function') {
          setTimeout(() => renderProfileStats(), 1000);
        }
        
        // Open review modal immediately
        if (typeof showReviewModal === 'function') {
          setTimeout(() => {
            showReviewModal(jobId, otherUserId, revieweeName);
          }, 300);
        } else {
          // Navigate to completed jobs if modal function not available
        setView('manage-jobs');
        setTimeout(() => {
          loadCompletedJobs();
            showToast('Please write your review from the Completed Jobs section');
        }, 100);
        }
      });
      
      // Review later button
      modal.querySelector('#reviewLaterBtn')?.addEventListener('click', () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
        showToast('💡 You can write a review anytime from the Completed Jobs section');
      });
      
      // View completed job button
      modal.querySelector('#viewCompletedJobBtn')?.addEventListener('click', async () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
        
        // Navigate to manage-jobs view and switch to completed tab
        if (typeof window.setView === 'function') {
          window.setView('manage-jobs');
        } else if (typeof setView === 'function') {
          setView('manage-jobs');
        } else {
          window.location.hash = '#manage-jobs';
        }
        
        // Wait a bit for view to load, then switch to completed tab and open the job popup
        setTimeout(async () => {
          const completedTab = document.querySelector('[data-manage-tab="completed"]');
          if (completedTab) {
            completedTab.click();
          }
          // Refresh completed jobs
          if (typeof loadCompletedJobs === 'function') {
            await loadCompletedJobs(true);
          }
          
          // Wait a bit more for jobs to load, then find and click the job card to open popup
          setTimeout(async () => {
            const jobCard = document.querySelector(`.job-card[data-job-id="${jobId}"]`);
            if (jobCard) {
              jobCard.click();
            } else {
              // If card not found, try to open the job details directly
              if (typeof openCompletedJobDetails === 'function') {
                try {
                  // Fetch the job data and open it
                  const token = localStorage.getItem('hustl_token');
                  const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (jobResponse.ok) {
                    const job = await jobResponse.json();
                    // Fetch payment data
                    let payment = null;
                    try {
                      const paymentResponse = await fetch(`${API_BASE}/payments/job/${jobId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                      });
                      if (paymentResponse.ok) {
                        payment = await paymentResponse.json();
                      }
                    } catch (e) {
                      console.error('Error fetching payment:', e);
                    }
                    const user = getCurrentUser();
                    if (user && job) {
                      const isCustomer = job.customerId === user.id;
                      const isHustler = job.hustlerId === user.id;
                      openCompletedJobDetails(jobId, job, payment, isCustomer, isHustler);
                    }
                  }
                } catch (err) {
                  console.error('Error fetching job for popup:', err);
                }
              }
            }
          }, 1000);
        }, 500);
        if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
        
        setView('manage-jobs');
        setTimeout(() => {
          loadCompletedJobs();
          setTimeout(() => {
            if (typeof showViewJobModal === 'function') {
              showViewJobModal(jobId, isCustomer ? 'customer' : 'hustler');
            }
          }, 500);
        }, 100);
      });
      
      // Helper function to mark modal as dismissed
      const markModalDismissed = () => {
        const dismissedKey = `completionModalDismissed_${jobId}_${user.id}`;
        localStorage.setItem(dismissedKey, 'true');
        completionModalShowing = false;
      };
      
      // Close button
      modal.querySelector('#closeCompletionModalBtn')?.addEventListener('click', () => {
        markModalDismissed();
        if (modal.parentNode) {
        document.body.removeChild(modal);
        }
        document.body.style.overflow = '';
        
        // Refresh jobs to show completed status
        if (typeof loadActiveJobs === 'function') loadActiveJobs();
        if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
        // Refresh profile stats after job completion
        if (typeof renderProfileStats === 'function') {
          setTimeout(() => renderProfileStats(), 1000);
        }
      });
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          markModalDismissed();
          if (modal.parentNode) {
          document.body.removeChild(modal);
          }
          document.body.style.overflow = '';
          
          // Refresh jobs to show completed status
          if (typeof loadActiveJobs === 'function') loadActiveJobs();
          if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
        }
      });
      
      // Reset flag when modal is removed
      const observer = new MutationObserver(() => {
        if (!document.getElementById('completionSuccessModal')) {
          completionModalShowing = false;
        }
      });
      observer.observe(document.body, { childList: true });
    }
    
    // Show review modal with star rating
    window.showReviewModal = function(jobId, revieweeId, revieweeName = 'User') {
      const modal = document.createElement('div');
      modal.id = 'reviewModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 1rem;
      `;
      
      let selectedRating = 0; // The actual selected rating (persists)
      let hoverRating = 0; // Temporary hover preview (clears on mouse leave)
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 0 0 1rem 0;">Rate ${revieweeName}</h2>
          
          <div style="margin-bottom: 1.5rem;">
            <div style="font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Your Rating</div>
            <div id="starRating" style="display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 0.5rem;">
              ${[1, 2, 3, 4, 5].map(i => `
                <span class="star" data-rating="${i}" style="
                  font-size: 2.5rem;
                  cursor: pointer;
                  color: #d1d5db;
                  transition: all 0.2s;
                  user-select: none;
                ">★</span>
              `).join('')}
            </div>
            <div id="ratingText" style="text-align: center; color: var(--text-muted); font-size: 0.9rem; min-height: 1.5rem;">
              Tap a star to rate
            </div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">
              Your Review (optional but recommended)
            </label>
            <textarea id="reviewText" placeholder="Share your experience..." style="
              width: 100%;
              min-height: 120px;
              padding: 0.75rem;
              border: 2px solid var(--border);
              border-radius: 8px;
              font-family: inherit;
              font-size: 0.95rem;
              resize: vertical;
            "></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.25rem;">
              <div style="font-size: 0.85rem; color: var(--text-muted);">Minimum 10 characters required</div>
              <div id="charCount" style="font-size: 0.85rem; color: var(--text-muted);">0 / 1000</div>
            </div>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button id="submitReviewBtn" class="btn btn-primary" style="flex: 1; padding: 0.75rem; font-weight: 600; opacity: 0.5; cursor: not-allowed; background-color: #9ca3af;">
              Submit Review
            </button>
            <button id="cancelReviewBtn" class="btn btn-ghost" style="flex: 1; padding: 0.75rem;">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      const stars = modal.querySelectorAll('.star');
      const ratingText = modal.querySelector('#ratingText');
      const submitBtn = modal.querySelector('#submitReviewBtn');
      const reviewText = modal.querySelector('#reviewText');
      const charCount = modal.querySelector('#charCount');
      const starContainer = modal.querySelector('#starRating');
      
      console.log('🔍 Star rating modal initialized - stars found:', stars.length);
      if (stars.length === 0) {
        console.error('❌ CRITICAL: No stars found in modal!');
      } else {
        console.log('✅ Stars found:', stars.length, 'First star:', stars[0], 'Initial color:', stars[0].style.color || 'not set');
      }
      
      const ratingLabels = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
      };
      
      // Render stars based on displayRating (hoverRating ?? selectedRating)
      // Use hoverRating if actively hovering, otherwise use selectedRating
      function renderStars() {
        const displayRating = hoverRating > 0 ? hoverRating : selectedRating;
        console.log('🎨 renderStars called - hoverRating:', hoverRating, 'selectedRating:', selectedRating, 'displayRating:', displayRating, 'stars.length:', stars.length);
        
        if (!stars || stars.length === 0) {
          console.error('❌ No stars found!');
          return;
        }
        
        stars.forEach((star, index) => {
          const starNumber = index + 1;
          const isHighlighted = starNumber <= displayRating;
          
          if (isHighlighted) {
            star.style.color = '#fbbf24'; // Gold - direct assignment overrides inline styles
            // Only show scale effect when hovering and no selection yet
            star.style.transform = (hoverRating > 0 && selectedRating === 0) ? 'scale(1.1)' : 'scale(1)';
            console.log(`  ✅ Star ${starNumber} highlighted (color: ${star.style.color})`);
          } else {
            star.style.color = '#d1d5db'; // Gray
            star.style.transform = 'scale(1)';
            console.log(`  ⚪ Star ${starNumber} not highlighted (color: ${star.style.color})`);
          }
        });
        
        // Update text based on display rating
        if (displayRating > 0) {
          ratingText.textContent = ratingLabels[displayRating] || `${displayRating}/5`;
        } else {
          ratingText.textContent = 'Tap a star to rate';
        }
      }
      
      // Initialize stars on load
      renderStars();
      
      // Star click handler - sets selectedRating
      stars.forEach((star, index) => {
        const starNumber = index + 1;
        
        star.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          selectedRating = starNumber;
          hoverRating = 0; // Clear hover on click
          console.log('⭐ Star clicked - Selected rating:', selectedRating, 'starNumber:', starNumber);
          console.log('⭐ Stars found:', stars.length, 'star element:', star);
          renderStars();
          updateSubmitButton();
        });
        
        star.addEventListener('mouseenter', (e) => {
          e.stopPropagation();
          // Always allow hover preview (will be cleared on mouseleave, showing selectedRating)
          hoverRating = starNumber;
          renderStars();
        });
      });
      
      // Clear hover when mouse leaves star container
      starContainer.addEventListener('mouseleave', () => {
        hoverRating = 0;
        renderStars();
      });
      
      function updateSubmitButton() {
        const text = reviewText.value.trim();
        const hasText = text.length >= 10;
        const hasRating = selectedRating > 0;
        const shouldEnable = hasRating && hasText;
        
        // Don't disable button - just show visual feedback
        // Disabled buttons don't fire click events reliably
        if (shouldEnable) {
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
          submitBtn.style.backgroundColor = 'var(--primary)';
        } else {
          submitBtn.style.opacity = '0.5';
          submitBtn.style.cursor = 'not-allowed';
          submitBtn.style.backgroundColor = '#9ca3af';
        }
        
        console.log('Submit button state:', {
          hasRating,
          hasText,
          selectedRating,
          textLength: text.length,
          shouldEnable
        });
      }
      
      // Initialize button state
      updateSubmitButton();
      
      // Character count
      reviewText.addEventListener('input', (e) => {
        const text = e.target.value;
        charCount.textContent = `${text.length} / 1000`;
        if (text.length > 1000) {
          charCount.style.color = '#dc2626';
          e.target.value = text.substring(0, 1000);
          charCount.textContent = '1000 / 1000';
        } else {
          charCount.style.color = 'var(--text-muted)';
        }
        updateSubmitButton();
      });
      
      // Submit review - use onclick to ensure it works even if disabled
      const handleSubmit = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('📤 Submit button clicked!');
        console.log('📤 Current state - rating:', selectedRating, 'text length:', reviewText.value.trim().length, 'disabled:', submitBtn.disabled);
        
        // Check requirements
        if (selectedRating === 0) {
          showToast('Please select a rating');
          return;
        }
        
        const text = reviewText.value.trim();
        if (text.length < 10) {
          showToast('Please write at least 10 characters in your review');
          return;
        }
        
        // Disable button and show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        try {
          const token = localStorage.getItem('hustl_token');
          if (!token) {
            throw new Error('Please log in to submit a review');
          }
          
          const reviewData = {
            jobId,
            revieweeId,
            stars: selectedRating,
            text: text
          };
          
          console.log('📤 Review data being submitted:', reviewData);
          console.log('📤 API endpoint:', `${API_BASE}/reviews`);
          
          const response = await fetch(`${API_BASE}/reviews`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(reviewData)
          });
          
          console.log('📤 Response status:', response.status, response.statusText);
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('❌ Review submission error:', errorData);
            throw new Error(errorData.error || errorData.message || 'Failed to submit review');
          }
          
          const result = await response.json();
          console.log('✅ Review submitted successfully:', result);
          
          // Mark review as submitted for this job (prevents completion modal from showing again)
          const user = getCurrentUser();
          if (user) {
            const reviewSubmittedKey = `reviewSubmitted_${jobId}_${user.id}`;
            localStorage.setItem(reviewSubmittedKey, 'true');
            // Also mark completion modal as dismissed since review was submitted
            const dismissedKey = `completionModalDismissed_${jobId}_${user.id}`;
            localStorage.setItem(dismissedKey, 'true');
          }
          
          // Show thank you modal
          const thankYouModal = document.createElement('div');
          thankYouModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;';
          thankYouModal.innerHTML = `
            <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 100%; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
              <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
              <h2 style="margin: 0 0 1rem 0; font-size: 1.75rem; color: var(--text-main);">Thank You!</h2>
              <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6;">
                Thank you for your review! That's very helpful to the other user.
              </p>
              <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.6; font-weight: 600;">
                Post or do your next job.
              </p>
              <button class="btn btn-primary" id="thankYouCloseBtn" style="width: 100%; padding: 0.9rem; font-size: 1rem;">
                Continue
              </button>
            </div>
          `;
          document.body.appendChild(thankYouModal);
          document.body.style.overflow = 'hidden';
          
          thankYouModal.querySelector('#thankYouCloseBtn').addEventListener('click', () => {
            document.body.removeChild(thankYouModal);
          document.body.style.overflow = '';
            document.body.removeChild(modal);
          
          // Refresh completed jobs to show the review
          if (typeof loadCompletedJobs === 'function') {
            loadCompletedJobs();
          }
          
          // Refresh profile stats after review submission (updates rating)
          if (typeof renderProfileStats === 'function') {
            setTimeout(() => renderProfileStats(), 1000);
          }
          });
        } catch (error) {
          console.error('❌ Error submitting review:', error);
          console.error('❌ Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
          });
          showToast(error.message || 'Error submitting review. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Review';
          // Re-enable button by updating state
          updateSubmitButton();
        }
      };
      
      // Attach both addEventListener and onclick to ensure it works
      submitBtn.addEventListener('click', handleSubmit);
      submitBtn.onclick = handleSubmit;
      
      // Remove disabled attribute to ensure clicks work
      submitBtn.removeAttribute('disabled');
      
      // Cancel button
      modal.querySelector('#cancelReviewBtn')?.addEventListener('click', () => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      });
      
      // Close on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
          document.body.style.overflow = '';
        }
      });
    };
    
    async function submitCompletionCode(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to complete job');
        }
        
        showToast("✅ Job marked as complete! Waiting for customer confirmation.");
        loadActiveJobs(); // Refresh list
      } catch (error) {
        console.error("Error completing job:", error);
        showToast(error.message || "Error completing job. Please try again.");
      }
    }
    
    async function confirmJobComplete(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/confirm-complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to confirm completion');
        }
        
        showToast("✅ Job confirmed complete! Payment will be processed.");
        loadActiveJobs(); // Refresh list
        loadCompletedJobs(); // Refresh completed list
      } catch (error) {
        console.error("Error confirming completion:", error);
        showToast(error.message || "Error confirming completion. Please try again.");
      }
    }
    
    async function cancelJob(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to cancel job');
        }
        
        showToast("Job cancelled successfully.");
        loadActiveJobs(); // Refresh list
        loadPostedJobs(); // Refresh posted list
      } catch (error) {
        console.error("Error cancelling job:", error);
        showToast(error.message || "Error cancelling job. Please try again.");
      }
    }
    
    // Show Applicants Modal - Professional management interface
    window.showApplicantsModal = async function(jobId) {
      const token = localStorage.getItem('hustl_token');
      
      // Fetch job and offers
      let job, offers;
      try {
        const [jobRes, offersRes] = await Promise.all([
          fetch(`${API_BASE}/jobs/${jobId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
          }),
          fetch(`${API_BASE}/offers/${jobId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
          })
        ]);
        
        if (!jobRes.ok || !offersRes.ok) throw new Error('Failed to fetch data');
        job = await jobRes.json();
        offers = await offersRes.ok ? await offersRes.json() : [];
      } catch (error) {
        console.error("Error fetching job/offers:", error);
        showToast("Error loading applicants. Please try again.");
        return;
      }
      
      // Filter to only pending offers
      const pendingOffers = offers.filter(o => o.status === 'PENDING');
      
      // Create modal
      const overlay = document.createElement("div");
      overlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
      overlay.id = "applicantsModalOverlay";
      
      const modal = document.createElement("div");
      modal.style.cssText = "background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);";
      
      modal.innerHTML = `
        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);">Manage Applicants</h2>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--text-muted);">${job.title}</p>
          </div>
          <button id="closeApplicantsModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.5rem; line-height: 1;">&times;</button>
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 1.5rem 2rem;">
          ${pendingOffers.length === 0 ? `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No applicants yet</div>
              <div style="color: var(--text-muted);">Share your job to get more applicants!</div>
            </div>
          ` : pendingOffers.map(offer => {
            const hustler = offer.hustler;
            const rating = hustler.ratingAvg || 5.0;
            const reviewCount = hustler.ratingCount || 0;
            const proposedPrice = offer.proposedAmount ? `$${parseFloat(offer.proposedAmount).toFixed(2)}` : null;
            const jobPrice = `$${parseFloat(job.amount || 0).toFixed(2)}`;
            
            // Determine if "Suggest New Price" should be shown
            const requirements = job.requirements || {};
            const pricingOption = requirements.pricing_option;
            const hustlerSuggestedPrice = offer.proposedAmount !== null && offer.proposedAmount !== undefined;
            const showSuggestPrice = (pricingOption === 'hustlers_quote' || hustlerSuggestedPrice) && offer.status === 'PENDING';
            
            // Check if customer has already countered (stored in localStorage)
            const customerCounteredKey = `customerCountered_${offer.id}`;
            const customerCountered = localStorage.getItem(customerCounteredKey) === 'true';
            const canSuggestPrice = showSuggestPrice && !customerCountered;
            
            // Check if waiting for hustler response (customer countered, waiting for hustler)
            const waitingForHustler = customerCountered && offer.proposedAmount;
            
            return `
              <div style="padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1rem; background: white;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                  ${renderUserAvatar(hustler, 60, {
                    style: 'flex-shrink: 0;'
                  })}
                  <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem;">${hustler.name || 'Hustler'}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                      <span>⭐ ${rating.toFixed(1)}</span>
                      <span>(${reviewCount} ${reviewCount === 1 ? 'review' : 'reviews'})</span>
                    </div>
                    ${hustler.bio ? `<div style="font-size: 0.9rem; color: var(--text-main); line-height: 1.5; margin-top: 0.5rem;">${hustler.bio.substring(0, 150)}${hustler.bio.length > 150 ? '...' : ''}</div>` : ''}
                  </div>
                </div>
                
                ${offer.note ? `
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-weight: 600; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Why I'm a good fit:</div>
                    <div style="color: var(--text-main); line-height: 1.6; font-size: 0.9rem;">${offer.note}</div>
                  </div>
                ` : ''}
                
                <div style="padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div>
                      ${proposedPrice ? `
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">${waitingForHustler ? 'Your Proposed Price' : 'Hustler Proposed Price'}</div>
                        <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">${proposedPrice}</div>
                        ${!waitingForHustler ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Your price: ${jobPrice}</div>` : ''}
                      ` : `
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Price</div>
                        <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">${jobPrice}</div>
                      `}
                    </div>
                  </div>
                  
                  ${waitingForHustler ? `
                    <div style="padding: 0.75rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                      <div style="font-weight: 600; color: #92400e; font-size: 0.9rem;">⏳ Waiting for hustler response</div>
                      <div style="font-size: 0.85rem; color: #78350f; margin-top: 0.25rem;">They can accept or decline your price</div>
                    </div>
                  ` : ''}
                  
                  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-ghost declineOfferBtn" data-offer-id="${offer.id}" style="padding: 0.75rem 1.5rem; color: #6b7280;">Decline</button>
                    ${canSuggestPrice ? `
                      <button class="btn btn-ghost suggestPriceBtn" data-offer-id="${offer.id}" data-job-id="${jobId}" style="padding: 0.75rem 1.5rem; border-color: #3b82f6; color: #3b82f6;">
                        💰 Suggest New Price
                      </button>
                    ` : ''}
                    <button class="btn btn-primary acceptOfferBtn" data-offer-id="${offer.id}" data-job-id="${jobId}" style="padding: 0.75rem 1.5rem;">
                      💳 Accept & Pay
                    </button>
                  </div>
                  <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.75rem; padding: 0.5rem; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd; text-align: center;">
                    💰 Payment will be held in escrow until job completion
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Close button
      overlay.querySelector('#closeApplicantsModal')?.addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      });
      
      // Accept/Decline buttons
      modal.querySelectorAll('.acceptOfferBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const offerId = btn.dataset.offerId;
          const jobId = btn.dataset.jobId;
          await acceptOffer(offerId, jobId, overlay);
        });
      });
      
      modal.querySelectorAll('.declineOfferBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const offerId = btn.dataset.offerId;
          await declineOffer(offerId, jobId, overlay);
        });
      });
      
      // Suggest New Price button handlers
      modal.querySelectorAll('.suggestPriceBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const offerId = btn.dataset.offerId;
          const jobId = btn.dataset.jobId;
          await showNegotiatePriceModal(offerId, jobId, overlay);
        });
      });
    };
    
    // Delete Job function
    window.deleteJob = async function(jobId, jobTitle) {
      if (!confirm(`Are you sure you want to delete "${jobTitle}"? This cannot be undone.`)) {
        return;
      }
      
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
          method: 'DELETE',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete job');
        }
        
        showToast("Job deleted successfully.");
        
        // Refresh the manage jobs view if we're on it
        if (activeView === 'manage-jobs') {
          const postedJobsList = document.getElementById("managePostedJobsList");
          if (postedJobsList) {
            postedJobsList.dataset.loaded = 'false'; // Force reload
            loadPostedJobs();
          }
        } else {
          // Otherwise refresh profile jobs tab
          const jobsTab = document.querySelector('.profile-tab[data-tab="jobs"]');
          if (jobsTab) {
            jobsTab.click();
          }
        }
      } catch (error) {
        console.error("Error deleting job:", error);
        showToast(error.message || "Error deleting job. Please try again.");
      }
    };
    
    // Accept Offer helper
    async function acceptOffer(offerId, jobId, modalOverlay) {
      try {
        showToast("Processing...");
        
        const token = localStorage.getItem('hustl_token');
        
        // Step 1: Create payment intent first
        let paymentIntentData;
        try {
          const intentRes = await fetch(`${API_BASE}/payments/create-intent/offer/${offerId}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (!intentRes.ok) {
            const error = await intentRes.json().catch(() => ({}));
            if (error.error?.includes('Stripe') || error.error?.includes('payment')) {
              throw new Error(error.message || 'Failed to create payment');
            }
            throw new Error(error.error || 'Failed to create payment intent');
          }
          
          paymentIntentData = await intentRes.json();
        } catch (error) {
          console.error('Error creating payment intent:', error);
          showToast(error.message || 'Failed to create payment. Please try again.');
          return;
        }
        
        // Step 2: Show Stripe payment modal
        await showStripePaymentModal(paymentIntentData.clientSecret, jobId, async (paymentIntentId) => {
          // Step 3: Accept offer with payment intent ID
          try {
            const acceptRes = await fetch(`${API_BASE}/offers/${offerId}/accept`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                paymentIntentId: paymentIntentId
              })
            });
            
            if (!acceptRes.ok) {
              const error = await acceptRes.json().catch(() => ({}));
              throw new Error(error.error || 'Failed to accept offer');
            }
            
            // Success!
            showToast("✅ Hustler accepted! Payment is held in escrow until job completion.");
            if (modalOverlay && modalOverlay.parentNode) {
              document.body.removeChild(modalOverlay);
            }
            
            // Refresh the manage jobs view if we're on it
            if (activeView === 'manage-jobs') {
              const postedJobsList = document.getElementById("managePostedJobsList");
              if (postedJobsList) {
                postedJobsList.dataset.loaded = 'false'; // Force reload
                loadPostedJobs();
              }
              // Also refresh active jobs since job moved there
              const activeJobsList = document.getElementById("manageActiveJobsList");
              if (activeJobsList) {
                activeJobsList.dataset.loaded = 'false';
                loadActiveJobs();
              }
            } else {
              // Otherwise refresh profile jobs tab
              const jobsTab = document.querySelector('.profile-tab[data-tab="jobs"]');
              if (jobsTab) {
                jobsTab.click();
              }
            }
          } catch (error) {
            console.error("Error accepting offer:", error);
            showToast(error.message || "Error accepting offer. Please try again.");
          }
        });
      } catch (error) {
        console.error("Error in acceptOffer:", error);
        showToast(error.message || "Error accepting offer. Please try again.");
      }
    }
    
    // Decline Offer helper
    async function declineOffer(offerId, jobId, modalOverlay) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/offers/${offerId}/decline`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to decline offer');
        }
        
        showToast("✅ Applicant declined and removed from view.");
        
        // Refresh the modal to remove the declined offer
        if (modalOverlay && jobId) {
          document.body.removeChild(modalOverlay);
          showViewJobModal(jobId, 'customer');
        }
        
        // Remove the offer from the modal
        const offerCard = document.querySelector(`[data-offer-id="${offerId}"]`)?.closest('div[style*="border: 1px solid"]');
        if (offerCard) {
          offerCard.style.transition = 'opacity 0.3s';
          offerCard.style.opacity = '0';
          setTimeout(() => {
            offerCard.remove();
            // If no more offers, show empty state
            const offersContainer = modalOverlay.querySelector('div[style*="flex: 1"]');
            if (offersContainer && offersContainer.querySelectorAll('div[style*="border: 1px solid"]').length === 0) {
              offersContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem 1rem;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                  <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No applicants</div>
                  <div style="color: var(--text-muted);">All applicants have been reviewed.</div>
                </div>
              `;
            }
          }, 300);
        }
      } catch (error) {
        console.error("Error declining offer:", error);
        showToast("Error declining offer. Please try again.");
      }
    }
    
    // Negotiate Price Modal
    async function showNegotiatePriceModal(offerId, jobId, parentModal) {
      const token = localStorage.getItem('hustl_token');
      
      // Fetch offer details
      let offer = null;
      try {
        const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (offersResponse.ok) {
          const offers = await offersResponse.json();
          offer = offers.find(o => o.id === offerId);
        }
      } catch (e) {
        console.error("Error fetching offer:", e);
      }
      
      const modalOverlay = document.createElement('div');
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      modalOverlay.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          max-width: 500px;
          width: 100%;
          padding: 2rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
        ">
          <button class="closeNegotiateModal" style="
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 1.25rem;
          ">×</button>
          
          <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💰 Suggest New Price</h3>
          
          <div style="margin-bottom: 1.5rem;">
            <label for="negotiatePriceInput" style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.75rem;">💰 Your Proposed Price ($)</label>
            <input type="number" id="negotiatePriceInput" placeholder="Enter your price" step="0.01" min="0" value="${offer?.proposedAmount || ''}" style="width: 100%; padding: 1.75rem; border: 3px solid var(--primary); border-radius: 12px; font-size: 2rem; font-weight: 700; text-align: center; background: #f0fdf4; color: var(--text-main); min-height: 70px; box-sizing: border-box;">
            <div style="margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-muted); text-align: center;">The hustler can accept or decline your price</div>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-primary submitNegotiateBtn" data-offer-id="${offerId}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Submit</button>
            <button class="btn btn-ghost cancelNegotiateBtn" style="flex: 1; padding: 0.75rem;">Cancel</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modalOverlay);
      
      modalOverlay.querySelector('.closeNegotiateModal')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.cancelNegotiateBtn')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.submitNegotiateBtn')?.addEventListener('click', async () => {
        const price = parseFloat(document.getElementById('negotiatePriceInput')?.value || 0);
        if (!price || price <= 0) {
          showToast("Please enter a valid price.");
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE}/offers/${offerId}/negotiate`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ proposedAmount: price })
          });
          
          if (!response.ok) throw new Error('Failed to negotiate price');
          
          // Mark that customer has countered (prevent multiple counters)
          const customerCounteredKey = `customerCountered_${offerId}`;
          localStorage.setItem(customerCounteredKey, 'true');
          
          // Store customer's counter-offer amount
          const customerCounterOfferKey = `customerCounterOffer_${offerId}`;
          localStorage.setItem(customerCounterOfferKey, price.toString());
          
          showToast("✅ Price negotiation sent! Waiting for hustler response.");
          document.body.removeChild(modalOverlay);
          
          // Refresh the applicants modal to show "Waiting for hustler response"
          if (parentModal && jobId) {
            document.body.removeChild(parentModal);
            setTimeout(() => {
              showApplicantsModal(jobId);
            }, 100);
          }
        } catch (error) {
          console.error("Error negotiating price:", error);
          showToast("Error negotiating price. Please try again.");
        }
      });
      
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
        }
      });
    }
    
    // Show Payment Modal with embedded Stripe Payment Element
    async function showPaymentModal(offerId, jobId, parentModal) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        // Get Stripe publishable key
        const configRes = await fetch(`${API_BASE}/payments/config`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!configRes.ok) {
          throw new Error('Failed to get Stripe configuration');
        }
        const { publishableKey } = await configRes.json();
        
        // Check if Stripe.js is loaded
        if (typeof Stripe === 'undefined') {
          // Load Stripe.js if not loaded
          const script = document.createElement('script');
          script.src = 'https://js.stripe.com/v3/';
          script.onload = () => {
            initializePaymentModal(publishableKey, offerId, jobId, parentModal, token);
          };
          document.head.appendChild(script);
        } else {
          await initializePaymentModal(publishableKey, offerId, jobId, parentModal, token);
        }
      } catch (error) {
        console.error("Error showing payment modal:", error);
        showToast(error.message || "Failed to load payment form. Please try again.");
      }
    }
    
    async function initializePaymentModal(publishableKey, offerId, jobId, parentModal, token) {
      try {
        // Check if we're in test mode (no Stripe key or SKIP_STRIPE_CHECK)
        const isTestMode = !publishableKey || publishableKey.includes('test') || publishableKey.length < 10;
        
        // Create payment intent
        const intentRes = await fetch(`${API_BASE}/payments/create-intent/offer/${offerId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!intentRes.ok) {
          const error = await intentRes.json().catch(() => ({}));
          throw new Error(error.message || error.error || 'Failed to create payment');
        }
        
        const { clientSecret, paymentIntentId, isTestMode: backendTestMode } = await intentRes.json();
        const useTestMode = isTestMode || backendTestMode || !clientSecret || clientSecret.includes('test');
        
        // Create payment modal
        const paymentModal = document.createElement('div');
        paymentModal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 10002;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
        `;
        
        paymentModal.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
          ">
            <button class="closePaymentModal" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: #f3f4f6;
              cursor: pointer;
              font-size: 1.5rem;
              z-index: 10;
            ">×</button>
            
            <div style="padding: 2rem;">
              <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💳 Complete Payment</h3>
              ${useTestMode ? `
              <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px;">
                <div style="font-weight: 700; color: #92400e; margin-bottom: 0.5rem;">🧪 TEST MODE</div>
                <div style="color: #78350f; font-size: 0.9rem; line-height: 1.6;">
                  This is a test payment. Click "Simulate Payment" below to see how the payment flow works without actually processing a payment.
                </div>
              </div>
              <div id="payment-element" style="margin-bottom: 1.5rem; padding: 2rem; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 12px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">💳</div>
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem;">Stripe Payment Form</div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">In production, this would show the Stripe payment form with card, Apple Pay, and Google Pay options.</div>
              </div>
              ` : `
              <div style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">
                Secure payment powered by Stripe. Supports card, Apple Pay, and Google Pay.
              </div>
              <div id="payment-element" style="margin-bottom: 1.5rem;">
                <!-- Stripe Payment Element will be inserted here -->
              </div>
              `}
              
              <button id="submit-payment" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 600;">
                ${useTestMode ? '✅ Simulate Payment' : 'Pay Now'}
              </button>
              
              <div id="payment-error" style="margin-top: 1rem; color: #dc2626; font-size: 0.9rem; display: none;"></div>
            </div>
          </div>
        `;
        
        document.body.appendChild(paymentModal);
        
        // Close button
        paymentModal.querySelector('.closePaymentModal')?.addEventListener('click', () => {
          document.body.removeChild(paymentModal);
        });
        
        paymentModal.addEventListener('click', (e) => {
          if (e.target === paymentModal) {
            document.body.removeChild(paymentModal);
          }
        });
        
        // Initialize Payment Element (only if not in test mode)
        let elements, paymentElement;
        if (!useTestMode && publishableKey && typeof Stripe !== 'undefined') {
          const stripe = Stripe(publishableKey);
          elements = stripe.elements({ clientSecret });
          paymentElement = elements.create('payment', {
            layout: 'tabs'
          });
          paymentElement.mount('#payment-element');
        }
        
        // Handle form submission
        const submitButton = paymentModal.querySelector('#submit-payment');
        const errorDiv = paymentModal.querySelector('#payment-error');
        let isProcessing = false;
        
        submitButton.addEventListener('click', async (e) => {
          e.preventDefault();
          if (isProcessing) return;
          
          isProcessing = true;
          submitButton.disabled = true;
          submitButton.textContent = useTestMode ? 'Simulating...' : 'Processing...';
          errorDiv.style.display = 'none';
          
          try {
            if (useTestMode) {
              // Test mode - simulate payment with a delay
              await new Promise(resolve => setTimeout(resolve, 1500));
              
              // Confirm payment on backend (will use test mode)
              submitButton.textContent = 'Processing payment...';
            } else {
              // Real payment - confirm with Stripe
              const { error: confirmError } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                  return_url: `${window.location.origin}${window.location.pathname}?payment=success&offerId=${offerId}&jobId=${jobId}`,
                },
                redirect: 'if_required'
              });
              
              if (confirmError) {
                errorDiv.textContent = confirmError.message || 'Payment failed. Please try again.';
                errorDiv.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Pay Now';
                isProcessing = false;
                return;
              }
              
              submitButton.textContent = 'Processing payment...';
            }
            
            // Confirm payment on backend
            const confirmRes = await fetch(`${API_BASE}/payments/confirm-payment`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ paymentIntentId, offerId })
            });
            
            if (!confirmRes.ok) {
              const errorData = await confirmRes.json().catch(() => ({}));
              const errorMessage = errorData.message || errorData.error || 'Failed to confirm payment';
              console.error('[PAYMENT] Confirm payment error:', errorData);
              throw new Error(errorMessage);
            }
            
            const confirmData = await confirmRes.json();
            console.log('[PAYMENT] Payment confirmed successfully:', confirmData);
            
            showToast("✅ Payment successful! Hustler accepted.");
            
            // Close modals
            document.body.removeChild(paymentModal);
            if (parentModal && parentModal.parentNode) {
              document.body.removeChild(parentModal);
            }
            
            // Refresh job lists
            if (activeView === 'manage-jobs') {
              loadPostedJobs();
              loadActiveJobs();
            }
          } catch (error) {
            console.error("Payment error:", error);
            errorDiv.textContent = error.message || 'Payment failed. Please try again.';
            errorDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = useTestMode ? '✅ Simulate Payment' : 'Pay Now';
            isProcessing = false;
          }
        });
      } catch (error) {
        console.error("Error initializing payment modal:", error);
        showToast(error.message || "Failed to load payment form. Please try again.");
      }
    }
    
    // Repost Job
    async function repostJob(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/repost`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Failed to repost job');
        
        showToast("✅ Job reposted! It's now visible to hustlers again.");
      } catch (error) {
        console.error("Error reposting job:", error);
        showToast("Error reposting job. Please try again.");
      }
    }
    
    // Cancel Job (or update keep open setting)
    async function cancelJob(jobId, keepOpenUntilAccepted = false, justUpdatingSetting = false) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ keepOpenUntilAccepted, justUpdatingSetting })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to update job');
        }
        
        if (justUpdatingSetting) {
          showToast(`✅ Setting saved! ${keepOpenUntilAccepted ? 'Job will stay open until you accept a hustler.' : 'Setting removed. You can manually cancel the job.'}`);
          // Refresh the modal to show updated state
          if (activeView === 'manage-jobs') {
            const modal = document.getElementById('viewJobModal');
            if (modal && modal.querySelector(`[data-job-id="${jobId}"]`)) {
              document.body.removeChild(modal);
              showViewJobModal(jobId, 'customer');
            }
          }
        } else if (keepOpenUntilAccepted) {
          showToast("✅ Job settings updated. Job will close automatically when you assign a hustler.");
        } else {
          showToast("✅ Job cancelled. It will no longer accept new applicants.");
        }
        // Refresh the list
        loadPostedJobs();
      } catch (error) {
        console.error("Error updating job:", error);
        showToast(error.message || "Error updating job. Please try again.");
      }
    }
    
    // Apply to Job (Hustler)
    async function applyToJob(jobId, note, proposedPrice, priceType) {
      // Store hustler's original offer in localStorage for tracking
      // This will be used to show "Your offer" even after negotiations
      try {
        const token = localStorage.getItem('hustl_token');
        const requestBody = {
          jobId: jobId,
          note: note || null,
        };
        
        // If proposing a price, include both proposedAmount and priceType
        if (proposedPrice !== null && proposedPrice > 0) {
          requestBody.proposedAmount = proposedPrice;
          requestBody.priceType = priceType || null; // Send price type for display/processing
        }
        
        const response = await fetch(`${API_BASE}/offers`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to apply to job');
        }
        
        const offer = await response.json();
        
        // Store hustler's original offer in localStorage for tracking
        // This will be used to show "Your offer" even after negotiations
        if (offer.id) {
          const hustlerOriginalOfferKey = `hustlerOriginalOffer_${offer.id}`;
          // Store the proposedAmount if hustler proposed a price, otherwise store null (will use job.amount as baseline)
          localStorage.setItem(hustlerOriginalOfferKey, (proposedPrice || '').toString());
        }
        
        // Show success confirmation modal
        const successOverlay = document.createElement("div");
        successOverlay.className = "modal-overlay";
        successOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
        
        const successModal = document.createElement("div");
        successModal.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
        
        successModal.innerHTML = `
          <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
          <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Application Sent!</h2>
          <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
            You've successfully applied to this job.<br>
            The customer will review your proposal and respond soon.
          </p>
          <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem;">
            You can manage this application in:<br>
            <strong style="color: var(--text-main);">Manage → Applied Jobs</strong>
          </p>
          <button class="btn btn-primary" id="gotItBtn3" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
            Got it
          </button>
        `;
        
        successOverlay.appendChild(successModal);
        document.body.appendChild(successOverlay);
        
        // Handle "Got it" button
        successOverlay.querySelector('#gotItBtn3').addEventListener('click', () => {
          document.body.removeChild(successOverlay);
          setView('manage');
          setTimeout(() => {
            const appliedTab = document.getElementById('appliedJobsTab');
            if (appliedTab) {
              appliedTab.click();
              if (typeof loadAppliedJobs === 'function') {
                loadAppliedJobs();
              }
            }
          }, 100);
        });
        
        successOverlay.addEventListener('click', (e) => {
          if (e.target === successOverlay) {
            document.body.removeChild(successOverlay);
            setView('manage');
            setTimeout(() => {
              const appliedTab = document.getElementById('appliedJobsTab');
              if (appliedTab) {
                appliedTab.click();
                if (typeof loadAppliedJobs === 'function') {
                  loadAppliedJobs();
                }
              }
            }, 100);
          }
        });
        
        // Refresh the jobs list if we're on the jobs view
        if (typeof renderJobs === 'function') {
          renderJobs(true);
        }
      } catch (error) {
        console.error("Error applying to job:", error);
        showToast(error.message || "Error applying to job. Please try again.");
      }
    }
    
    // Cancel Application (Hustler) - For accepted hustlers to cancel after being assigned
    async function cancelApplication(offerIdOrJobId, isOfferId = false) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        let offerId = offerIdOrJobId;
        
        // If jobId was passed, find the offer
        if (!isOfferId) {
          const jobId = offerIdOrJobId;
          // First find the offer for this job
          const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!offersResponse.ok) throw new Error('Failed to fetch offers');
          const offers = await offersResponse.json();
          const user = await window.hustlAPI.auth.getCurrentUser();
          const myOffer = offers.find(o => o.hustlerId === user.id && o.status === 'ACCEPTED');
          
          if (!myOffer) {
            showToast("No active application found for this job.");
            return;
          }
          
          offerId = myOffer.id;
        }
        
        // Use the new hustler-cancel endpoint
        const response = await fetch(`${API_BASE}/offers/${offerId}/hustler-cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to cancel application');
        }
        
        const result = await response.json();
        showToast("✅ You have cancelled this job. The customer has been notified and the job is now open for other applicants.");
        
        // Refresh the view
        if (activeView === 'manage-jobs') {
          loadActiveJobs();
        }
      } catch (error) {
        console.error("Error cancelling application:", error);
        showToast(error.message || "Error cancelling application. Please try again.");
      }
    }
    
    // Show Applicant Profile Modal
    async function showApplicantProfileModal(userId) {
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          showToast('Please log in to view profiles');
          return;
        }
        
        console.log("🔵 Fetching user profile for applicant ID:", userId);
        console.log("🔵 API URL:", `${API_BASE}/users/${userId}`);
        const response = await fetch(`${API_BASE}/users/${userId}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Failed to fetch user profile:', response.status, errorText);
          showToast(`Failed to load profile: ${response.status === 401 ? 'Please log in' : response.status === 404 ? 'User not found' : 'Error'}`);
          return;
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.error('Response is not JSON:', contentType);
          showToast('Invalid response format');
          return;
        }
        
        const user = await response.json();
        console.log("✅ Fetched user profile:", user);
        
        // Fetch user's jobs and reviews
        const jobsResponse = await fetch(`${API_BASE}/jobs/my-jobs`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const allJobs = jobsResponse.ok ? await jobsResponse.json() : [];
        const userJobs = allJobs.filter(j => j.hustlerId === user.id && j.status === 'PAID');
        console.log("✅ User jobs:", userJobs.length);
        
        const reviewsResponse = await fetch(`${API_BASE}/reviews?userId=${userId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const reviews = reviewsResponse.ok ? await reviewsResponse.json() : [];
        console.log("✅ User reviews:", reviews.length);
        
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        modalOverlay.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
          ">
            <button class="closeProfileModal" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: #f3f4f6;
              cursor: pointer;
              font-size: 1.25rem;
              z-index: 1;
            ">×</button>
            
            <div style="padding: 2rem;">
              <!-- Profile Header -->
              <div style="text-align: center; margin-bottom: 2rem;">
                ${renderUserAvatar(user, 80, {
                  showBorder: true,
                  borderWidth: '3px',
                  style: 'margin: 0 auto 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);'
                })}
                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">${user.name || 'Unknown'}</h2>
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">${'⭐'.repeat(Math.floor(user.ratingAvg || 0))}</span>
                  <span style="font-weight: 600; color: var(--text-main);">${(user.ratingAvg || 0).toFixed(1)}</span>
                  <span style="color: var(--text-muted); font-size: 0.9rem;">(${user.ratingCount || 0} ${(user.ratingCount || 0) === 1 ? 'review' : 'reviews'})</span>
                </div>
                ${user.city || user.zip ? `<div style="color: var(--text-muted); font-size: 0.9rem;">📍 ${user.city || ''} ${user.zip || ''}</div>` : ''}
                ${user.gender ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">${user.gender === 'male' ? '👨' : user.gender === 'female' ? '👩' : '👤'} ${user.gender.charAt(0).toUpperCase() + user.gender.slice(1)}</div>` : ''}
              </div>
              
              <!-- Bio -->
              ${user.bio ? `
              <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">📝 Bio</h3>
                <div style="color: var(--text-main); line-height: 1.6;">${user.bio}</div>
              </div>
              ` : ''}
              
              <!-- Tools -->
              ${user.tools && (typeof user.tools === 'string' ? user.tools.trim() : (Array.isArray(user.tools) ? user.tools.length > 0 : false)) ? `
              <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">🛠 Tools They Have</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                  ${typeof user.tools === 'string' 
                    ? user.tools.split(',').filter(t => t.trim()).map(tool => `<span style="padding: 0.5rem 1rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">${tool.trim()}</span>`).join('')
                    : Array.isArray(user.tools) 
                      ? user.tools.map(tool => `<span style="padding: 0.5rem 1rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">${tool}</span>`).join('')
                      : `<span style="padding: 0.5rem 1rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">${user.tools}</span>`
                  }
                </div>
              </div>
              ` : ''}
              
              <!-- Job History -->
              <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">💼 Job History</h3>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${userJobs.length}</div>
                  <div style="color: var(--text-muted); font-size: 0.9rem;">Completed jobs</div>
                </div>
              </div>
              
              <!-- Reviews -->
              ${reviews.length > 0 ? `
              <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">⭐ Reviews</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  ${reviews.slice(0, 5).map(review => `
                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border);">
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span>${'⭐'.repeat(review.stars || 0)}</span>
                        <span style="font-weight: 600; color: var(--text-main);">${(review.stars || 0)}/5</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">${new Date(review.createdAt).toLocaleDateString()}</span>
                        ${review.reviewer ? `<span style="color: var(--text-muted); font-size: 0.85rem; margin-left: auto;">- ${review.reviewer.name || 'Anonymous'}</span>` : ''}
                      </div>
                      ${review.text ? `<div style="color: var(--text-main); line-height: 1.5;">${review.text}</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        document.body.appendChild(modalOverlay);
        
        modalOverlay.querySelector('.closeProfileModal')?.addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
      } catch (error) {
        console.error("Error showing applicant profile:", error);
        showToast("Error loading profile. Please try again.");
      }
    }
    
    // Show Rate Worker Modal
    async function showRateWorkerModal(userId, jobId) {
      const modalOverlay = document.createElement('div');
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      let selectedRating = 0;
      
      modalOverlay.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          max-width: 500px;
          width: 100%;
          padding: 2rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
        ">
          <button class="closeRateModal" style="
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 1.25rem;
          ">×</button>
          
          <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">⭐ Rate Worker</h3>
          
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Rating</div>
            <div id="ratingStars" style="display: flex; gap: 0.5rem; font-size: 2rem; cursor: pointer;">
              ${[1,2,3,4,5].map(i => `<span class="ratingStar" data-rating="${i}" style="color: #d1d5db; transition: color 0.2s;">★</span>`).join('')}
            </div>
            <div id="ratingText" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Select a rating</div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">Review (optional)</label>
            <textarea id="reviewCommentInput" placeholder="Share your experience..." style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-primary submitRatingBtn" data-user-id="${userId}" data-job-id="${jobId}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Submit Rating</button>
            <button class="btn btn-ghost cancelRatingBtn" style="flex: 1; padding: 0.75rem;">Cancel</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modalOverlay);
      
      // Rating stars interaction
      const stars = modalOverlay.querySelectorAll('.ratingStar');
      const ratingText = modalOverlay.querySelector('#ratingText');
      const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
      };
      
      console.log('🔍 showRateWorkerModal - Stars found:', stars.length);
      
      let hoverRating = 0; // Track hover state separately
      
      // Helper function to render stars
      function renderStars() {
        const displayRating = hoverRating > 0 ? hoverRating : selectedRating;
        console.log('🎨 renderStars (rateWorker) - hoverRating:', hoverRating, 'selectedRating:', selectedRating, 'displayRating:', displayRating);
        
        stars.forEach((s, i) => {
          const starNum = i + 1;
          const isHighlighted = starNum <= displayRating;
          
          // Force remove inline style and set new color with !important via setProperty
          s.style.removeProperty('color');
          s.style.cssText = s.style.cssText.replace(/color\s*:[^;]+;?/gi, ''); // Remove any color from cssText
          
          if (isHighlighted) {
            s.style.setProperty('color', '#fbbf24', 'important');
            console.log(`  ✅ Star ${starNum} highlighted - computed color: ${window.getComputedStyle(s).color}`);
          } else {
            s.style.setProperty('color', '#d1d5db', 'important');
            console.log(`  ⚪ Star ${starNum} not highlighted - computed color: ${window.getComputedStyle(s).color}`);
          }
        });
        
        if (displayRating > 0) {
          ratingText.textContent = ratingTexts[displayRating] || '';
        } else {
          ratingText.textContent = 'Select a rating';
        }
      }
      
      stars.forEach(star => {
        star.addEventListener('mouseenter', (e) => {
          const rating = parseInt(e.target.dataset.rating);
          hoverRating = rating;
          renderStars();
        });
        
        star.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          selectedRating = parseInt(e.target.dataset.rating);
          hoverRating = 0; // Clear hover on click
          console.log('⭐ Star clicked - Selected rating:', selectedRating);
          renderStars();
        });
      });
      
      modalOverlay.querySelector('#ratingStars').addEventListener('mouseleave', () => {
        hoverRating = 0; // Clear hover
        renderStars();
      });
      
      modalOverlay.querySelector('.closeRateModal')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.cancelRatingBtn')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.submitRatingBtn')?.addEventListener('click', async () => {
        console.log('📤 Submitting rating with selectedRating:', selectedRating);
        
        if (selectedRating === 0) {
          showToast("Please select a rating.");
          return;
        }
        
        const comment = document.getElementById('reviewCommentInput')?.value.trim() || '';
        
        // Backend requires text to be at least 10 characters
        // If no comment provided, use default text
        const reviewText = comment.length >= 10 ? comment : 'Great job!';
        
        try {
          const token = localStorage.getItem('hustl_token');
          const response = await fetch(`${API_BASE}/reviews`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              jobId: jobId,
              revieweeId: userId,
              stars: selectedRating, // Backend expects 'stars', not 'rating'
              text: reviewText, // Backend expects 'text', not 'comment', and requires min 10 chars
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to submit rating');
          }
          
          showToast("✅ Rating submitted! Thank you for your feedback.");
          document.body.removeChild(modalOverlay);
          
          // CRITICAL: Refresh completed jobs to hide the "Rate Worker" button
          // This ensures the UI reflects that a review was already submitted
          if (typeof loadCompletedJobs === 'function') {
            loadCompletedJobs();
          }
          
          // Trigger global review refresh event
          window.dispatchEvent(new CustomEvent('reviewSubmitted', { 
            detail: { revieweeId: userId, jobId } 
          }));
        } catch (error) {
          console.error("Error submitting rating:", error);
          showToast("Error submitting rating. Please try again.");
        }
      });
      
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
        }
      });
    }
    
    // Show Job Completion Flow: Congratulations → Forced Review
    async function showJobCompletionFlow(jobId, customerId, hustlerId) {
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user) return;
      
      const isCustomer = user.id === customerId;
      const isHustler = user.id === hustlerId;
      const otherUserId = isCustomer ? hustlerId : customerId;
      
      // Step 1: Show Congratulations Modal
      const congratsModal = document.createElement('div');
      congratsModal.id = 'jobCompletionCongrats';
      congratsModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10002;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      congratsModal.innerHTML = `
        <div style="
          background: white;
          border-radius: 24px;
          max-width: 600px;
          width: 100%;
          padding: 3rem 2rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          text-align: center;
        ">
          <div style="font-size: 5rem; margin-bottom: 1rem;">🎉</div>
          <h2 style="font-size: 2rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">
            Job Completed Successfully!
          </h2>
          <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
            Great work! Please take a moment to leave a review for ${isCustomer ? 'your hustler' : 'your customer'}.
          </p>
          <button class="btn btn-primary continueToReviewBtn" style="
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            max-width: 300px;
          ">Continue to Review →</button>
        </div>
      `;
      
      document.body.appendChild(congratsModal);
      
      // Continue button - show review modal
      congratsModal.querySelector('.continueToReviewBtn')?.addEventListener('click', () => {
        document.body.removeChild(congratsModal);
        showForcedReviewModal(jobId, otherUserId, isCustomer);
      });
    }
    
    // Show Forced Review Modal (no cancel, must submit)
    async function showForcedReviewModal(jobId, revieweeId, isCustomer) {
      // Fetch reviewee info
      const token = localStorage.getItem('hustl_token');
      let revieweeName = 'the other party';
      try {
        const userResponse = await fetch(`${API_BASE}/users/${revieweeId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (userResponse.ok) {
          const userData = await userResponse.json();
          revieweeName = userData.name || revieweeName;
        }
      } catch (e) {
        console.error("Error fetching reviewee:", e);
      }
      
      const modalOverlay = document.createElement('div');
      modalOverlay.id = 'forcedReviewModal';
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10003;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      let selectedRating = 0;
      
      modalOverlay.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          max-width: 600px;
          width: 100%;
          padding: 2.5rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          position: relative;
        ">
          <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main); text-align: center;">
            ⭐ Rate ${revieweeName}
          </h2>
          <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem; text-align: center;">
            Your feedback helps build trust in our community
          </p>
          
          <div style="margin-bottom: 2rem;">
            <div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 1rem; text-align: center;">Rating *</div>
            <div id="ratingStars" style="display: flex; gap: 0.75rem; font-size: 3rem; cursor: pointer; justify-content: center;">
              ${[1,2,3,4,5].map(i => `<span class="ratingStar" data-rating="${i}" style="color: #d1d5db; transition: all 0.2s; user-select: none;">★</span>`).join('')}
            </div>
            <div id="ratingText" style="margin-top: 0.75rem; font-size: 1rem; color: var(--text-muted); text-align: center; min-height: 1.5rem;">Select a rating</div>
          </div>
          
          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Review (optional)</label>
            <textarea id="reviewCommentInput" placeholder="Share your experience... (minimum 10 characters)" style="width: 100%; min-height: 120px; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical;"></textarea>
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">Optional: Tell others about your experience</div>
          </div>
          
          <button class="btn btn-primary submitForcedReviewBtn" data-reviewee-id="${revieweeId}" data-job-id="${jobId}" style="
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--primary);
          ">Submit Review</button>
        </div>
      `;
      
      document.body.appendChild(modalOverlay);
      
      // Rating stars interaction
      const stars = modalOverlay.querySelectorAll('.ratingStar');
      const ratingText = modalOverlay.querySelector('#ratingText');
      const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
      };
      
      console.log('🔍 showForcedReviewModal - Stars found:', stars.length);
      
      let hoverRating = 0; // Track hover state separately
      
      // Helper function to render stars
      function renderStars() {
        const displayRating = hoverRating > 0 ? hoverRating : selectedRating;
        console.log('🎨 renderStars (forcedReview) - hoverRating:', hoverRating, 'selectedRating:', selectedRating, 'displayRating:', displayRating);
        
        stars.forEach((s, i) => {
          const starNum = i + 1;
          const isHighlighted = starNum <= displayRating;
          
          // Force remove inline style and set new color with !important
          s.style.removeProperty('color');
          s.style.removeProperty('transform');
          s.style.cssText = s.style.cssText.replace(/color\s*:[^;]+;?/gi, ''); // Remove any color from cssText
          
          if (isHighlighted) {
            s.style.setProperty('color', '#fbbf24', 'important');
            s.style.transform = (hoverRating > 0 && selectedRating === 0) ? 'scale(1.1)' : 'scale(1)';
            console.log(`  ✅ Star ${starNum} highlighted - computed: ${window.getComputedStyle(s).color}`);
          } else {
            s.style.setProperty('color', '#d1d5db', 'important');
            s.style.transform = 'scale(1)';
            console.log(`  ⚪ Star ${starNum} not highlighted - computed: ${window.getComputedStyle(s).color}`);
          }
        });
        
        if (displayRating > 0) {
          ratingText.textContent = ratingTexts[displayRating] || '';
        } else {
          ratingText.textContent = 'Select a rating';
        }
      }
      
      stars.forEach(star => {
        star.addEventListener('mouseenter', (e) => {
          const rating = parseInt(e.target.dataset.rating);
          hoverRating = rating;
          renderStars();
        });
        
        star.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          selectedRating = parseInt(e.target.dataset.rating);
          hoverRating = 0; // Clear hover on click
          console.log('⭐ Star clicked (forcedReview) - Selected rating:', selectedRating);
          renderStars();
        });
      });
      
      modalOverlay.querySelector('#ratingStars').addEventListener('mouseleave', () => {
        hoverRating = 0; // Clear hover
        renderStars();
      });
      
      // Submit review (required)
      modalOverlay.querySelector('.submitForcedReviewBtn')?.addEventListener('click', async () => {
        console.log('📤 Submitting forced review with selectedRating:', selectedRating);
        
        if (selectedRating === 0) {
          showToast("Please select a rating before submitting.");
          return;
        }
        
        const comment = document.getElementById('reviewCommentInput')?.value.trim() || '';
        console.log('📤 Review text length:', comment.length);
        
        // Validate comment length if provided (API requires min 10 chars)
        if (comment && comment.length < 10) {
          showToast("Review must be at least 10 characters if provided.");
          return;
        }
        
        // Use default text if no comment provided (API requires text field)
        const reviewText = comment.length >= 10 ? comment : 'Great job!';
        
        const btn = modalOverlay.querySelector('.submitForcedReviewBtn');
        btn.disabled = true;
        btn.textContent = "Submitting...";
        
        try {
          const token = localStorage.getItem('hustl_token');
          const response = await fetch(`${API_BASE}/reviews`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              jobId: jobId,
              revieweeId: revieweeId,
              stars: selectedRating,
              text: reviewText
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'Failed to submit review');
          }
          
          showToast("✅ Review submitted! Thank you for your feedback.");
          document.body.removeChild(modalOverlay);
          
          // CRITICAL: Refresh all review displays after submission
          if (typeof loadActiveJobs === 'function') loadActiveJobs();
          if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
          if (typeof renderProfile === 'function') renderProfile();
          if (typeof renderJobs === 'function') renderJobs();
          
          // Trigger global review refresh event
          window.dispatchEvent(new CustomEvent('reviewSubmitted', { 
            detail: { revieweeId, jobId } 
          }));
          
          // Navigate to completed jobs
          if (typeof setView === 'function') {
            setView('manage-jobs');
            setTimeout(() => {
              const completedTab = document.querySelector('[data-status="done"]');
              if (completedTab) completedTab.click();
            }, 300);
          }
        } catch (error) {
          console.error("Error submitting review:", error);
          showToast("Error: " + (error.message || "Failed to submit review. Please try again."));
          btn.disabled = false;
          btn.textContent = "Submit Review";
        }
      });
      
      // Prevent closing by clicking outside
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          // Don't allow closing - review is required
          showToast("Please submit a review to continue.");
        }
      });
    }
    
    // Favorite Worker
    async function favoriteWorker(userId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/users/${userId}/favorite`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          // Check if already favorited
          if (response.status === 409) {
            showToast("Worker already in favorites!");
            return;
          }
          throw new Error('Failed to favorite worker');
        }
        
        showToast("✅ Worker added to favorites!");
      } catch (error) {
        console.error("Error favoriting worker:", error);
        showToast("Error favoriting worker. Please try again.");
      }
    }
    
    // Unaccept Hustler (Customer can unaccept before start code exchanged)
    async function unacceptHustler(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        const response = await fetch(`${API_BASE}/jobs/${jobId}/unassign`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.message || 'Failed to unassign hustler');
        }
        
        const result = await response.json();
        showToast(result.message || "Hustler unassigned. Job is now open for applicants again.");
        loadPostedJobs();
        loadActiveJobs();
      } catch (error) {
        console.error("Error unassigning hustler:", error);
        showToast(error.message || "Error unassigning hustler. Please try again.");
      }
    }

    async function leaveJob(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        const response = await fetch(`${API_BASE}/jobs/${jobId}/leave`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.message || 'Failed to leave job');
        }
        
        const result = await response.json();
        showToast(result.message || "You have left the job.");
        loadActiveJobs();
      } catch (error) {
        console.error("Error leaving job:", error);
        showToast(error.message || "Error leaving job. Please try again.");
      }
    }

    /* ---------- Mode Toggle ---------- */
    
    function initModeToggle() {
      const customerBtn = document.getElementById("modeCustomerBtn");
      const hustlerBtn = document.getElementById("modeHustlerBtn");
      
      if (customerBtn) {
        customerBtn.addEventListener("click", () => {
          userMode = "customer";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
      
      if (hustlerBtn) {
        hustlerBtn.addEventListener("click", () => {
          userMode = "hustler";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
    }

    /* ---------- Init ---------- */

    function initNav() {
      const navContainer = document.querySelector(".nav-tabs");
      if (!navContainer) {
        console.log("Nav container not found, retrying in 50ms...");
        setTimeout(initNav, 50);
        return;
      }
      
      if (navContainer.dataset.listenerAttached) {
        console.log("Nav listener already attached");
        return;
      }
      navContainer.dataset.listenerAttached = 'true';
      console.log("✅ Nav listener attached");
      
      navContainer.addEventListener("click", async (e) => {
        const tab = e.target.closest(".nav-tab");
        if (!tab) return;
        e.preventDefault();
        e.stopPropagation();
        const v = tab.dataset.view;
        console.log("Nav tab clicked:", v);
        if (v) {
          // Try to call setView - if it's the stub, use fallback
          if (window.setView && typeof window.setView === 'function') {
            // Check if it's the real function (not the stub)
            // Real setView is async, stub is not. Also check for 'not ready yet' string
            const funcStr = window.setView.toString();
            const isAsync = funcStr.includes('async') || window.setView.constructor.name === 'AsyncFunction';
            const isStub = funcStr.includes('not ready yet');
            
            if (isAsync && !isStub) {
              console.log("✅ Calling real window.setView with:", v);
              try {
                await window.setView(v);
                return; // Success - exit early
              } catch (error) {
                console.error("Error calling setView:", error);
                // Fall through to fallback
              }
            } else {
              console.log("⚠️ setView is stub (isAsync:", isAsync, "isStub:", isStub, "), using fallback");
            }
          }
          
          // Fallback: manual view switching
          console.log("Using fallback view switching for:", v);
          // CRITICAL: Set activeView so renderAll knows which view to render
          activeView = v;
          window.activeView = v;
          document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
          const target = document.getElementById("view-" + v);
          if (target) {
            target.style.display = "block";
          } else {
            console.error("View target not found:", "view-" + v);
          }
          document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === v));
          window.scrollTo({ top: 0, behavior: 'instant' });
          // IMPORTANT: Also call renderAll to actually render the content
          setTimeout(async () => {
            try {
              // Ensure activeView is set before calling renderAll
              activeView = v;
              window.activeView = v;
              console.log("🔵 Calling renderAll with activeView:", window.activeView);
              if (typeof window.renderAll === 'function') {
                await window.renderAll();
              } else if (typeof renderAll === 'function') {
                await renderAll();
              } else {
                console.error("❌ renderAll function not found!");
              }
            } catch (error) {
              console.error("Error in fallback render:", error);
            }
          }, 100);
        }
      });
      
      // Home CTA buttons
      const homeCtaPost = document.getElementById("homeCtaPost");
      if (homeCtaPost && !homeCtaPost.dataset.listenerAttached) {
        homeCtaPost.dataset.listenerAttached = 'true';
        console.log("✅ CTA Post button listener attached");
        homeCtaPost.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("CTA Post button clicked");
          if (window.setView && typeof window.setView === 'function') {
            const funcStr = window.setView.toString();
            if (!funcStr.includes('not ready yet')) {
              window.setView("post");
              setTimeout(() => {
                const formCard = document.getElementById("jobFormCard");
                if (formCard) {
                  formCard.scrollIntoView({ behavior: "smooth" });
                }
              }, 100);
            } else {
              console.warn("setView is stub, using fallback");
              document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
              const target = document.getElementById("view-post");
              if (target) target.style.display = "block";
              window.scrollTo({ top: 0, behavior: 'instant' });
            }
          } else {
            console.warn("setView not available, using fallback");
            document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
            const target = document.getElementById("view-post");
            if (target) target.style.display = "block";
            window.scrollTo({ top: 0, behavior: 'instant' });
          }
        });
      }
      
      const homeCtaBrowse = document.getElementById("homeCtaBrowse");
      if (homeCtaBrowse && !homeCtaBrowse.dataset.listenerAttached) {
        homeCtaBrowse.dataset.listenerAttached = 'true';
        console.log("✅ CTA Browse button listener attached");
        homeCtaBrowse.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("CTA Browse button clicked");
          if (window.setView && typeof window.setView === 'function') {
            const funcStr = window.setView.toString();
            if (!funcStr.includes('not ready yet')) {
              window.setView("jobs");
            } else {
              console.warn("setView is stub, using fallback");
              document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
              const target = document.getElementById("view-jobs");
              if (target) target.style.display = "block";
              window.scrollTo({ top: 0, behavior: 'instant' });
            }
          } else {
            console.warn("setView not available, using fallback");
            document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
            const target = document.getElementById("view-jobs");
            if (target) target.style.display = "block";
            window.scrollTo({ top: 0, behavior: 'instant' });
          }
        });
      }
      
      // Home Bottom Sign Up button
      const homeBottomSignUpBtn = document.getElementById("homeBottomSignUpBtn");
      if (homeBottomSignUpBtn && !homeBottomSignUpBtn.dataset.listenerAttached) {
        homeBottomSignUpBtn.dataset.listenerAttached = 'true';
        homeBottomSignUpBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (window.openAuthModal && typeof window.openAuthModal === 'function') {
            window.openAuthModal('create');
          } else if (document.getElementById('authSection')) {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('authSection').scrollIntoView({ behavior: 'smooth' });
          }
        });
      }
      
      // Status filter removed - Browse Jobs only shows OPEN jobs
      
      // Location permission and distance filter handlers
      const locationStatusContainer = document.getElementById("locationStatusContainer");
      const locationStatusText = document.getElementById("locationStatusText");
      const requestLocationBtn = document.getElementById("requestLocationBtn");
      const distanceFilterContainer = document.getElementById("distanceFilterContainer");
      
      // Check if location is already stored
      function checkStoredLocation() {
        try {
          const stored = localStorage.getItem('userLocation');
          if (stored) {
            const location = JSON.parse(stored);
            // Check if location is less than 1 hour old
            if (location.timestamp && (Date.now() - location.timestamp < 60 * 60 * 1000)) {
              userLocation = { lat: location.lat, lng: location.lng };
              updateLocationUI(true);
              return true;
            }
          }
        } catch (e) {
          console.warn('Error reading stored location:', e);
        }
        updateLocationUI(false);
        return false;
      }
      
      function updateLocationUI(hasLocation) {
        if (locationStatusContainer) {
          locationStatusContainer.style.display = 'block';
        }
        if (hasLocation && userLocation) {
          if (locationStatusText) {
            locationStatusText.textContent = '✅ Location set';
            locationStatusText.style.color = '#10b981';
          }
          if (requestLocationBtn) {
            requestLocationBtn.textContent = 'Update';
            requestLocationBtn.style.background = '#6b7280';
          }
          if (distanceFilterContainer) {
            distanceFilterContainer.style.display = 'block';
          }
        } else {
          if (locationStatusText) {
            locationStatusText.textContent = '📍 Location not set';
            locationStatusText.style.color = 'var(--text-main)';
          }
          if (requestLocationBtn) {
            requestLocationBtn.textContent = 'Get My Location';
            requestLocationBtn.style.background = 'var(--primary)';
          }
          if (distanceFilterContainer) {
            distanceFilterContainer.style.display = 'none';
          }
        }
      }
      
      // Function to update user location and marker
      function updateUserLocation(lat, lng) {
        userLocation = { lat, lng };
        
        // Store in localStorage (always update)
        localStorage.setItem('userLocation', JSON.stringify({
          lat: userLocation.lat,
          lng: userLocation.lng,
          timestamp: Date.now()
        }));
        
        // Update location marker on map if it exists
        if (window.userLocationMarker && jobsMap) {
          window.userLocationMarker.setLngLat([lng, lat]);
        } else if (jobsMap && jobsMap.loaded()) {
          // Create marker if it doesn't exist
          if (typeof addUserLocationMarker === 'function') {
            addUserLocationMarker(lat, lng);
          }
        }
        
        // Update UI
        updateLocationUI(true);
        
        // Refresh jobs if distance filter is active
        if (activeDistanceFilter && typeof renderJobs === 'function') {
          renderJobs(true);
        }
      }
      
      // Function to add user location marker to map
      function addUserLocationMarker(lat, lng) {
        if (!jobsMap || !jobsMap.loaded()) return;
        
        // Remove existing marker if any
        if (userLocationMarker) {
          userLocationMarker.remove();
        }
        
        // Create person icon element
        const el = document.createElement('div');
        el.className = 'user-location-marker';
        el.style.cssText = `
          width: 28px;
          height: 28px;
          background: #dc2626;
          border: 2px solid white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          cursor: pointer;
          z-index: 10;
        `;
        el.innerHTML = '👤';
        el.title = 'Your location';
        
        // Create marker
        userLocationMarker = new mapboxgl.Marker({
          element: el,
          anchor: 'center'
        })
          .setLngLat([lng, lat])
          .addTo(jobsMap);
      }
      
      // Request location permission and start continuous watching
      if (requestLocationBtn) {
        requestLocationBtn.addEventListener("click", () => {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
          }
          
          // Stop any existing watch
          if (locationWatchId !== null) {
            navigator.geolocation.clearWatch(locationWatchId);
            locationWatchId = null;
          }
          
          requestLocationBtn.textContent = 'Getting location...';
          requestLocationBtn.disabled = true;
          
          // First get current position immediately
          navigator.geolocation.getCurrentPosition(
            (position) => {
              updateUserLocation(position.coords.latitude, position.coords.longitude);
              requestLocationBtn.disabled = false;
              
              // Show confirmation
              if (typeof showToast === 'function') {
                showToast('✅ Location confirmed! Tracking your location continuously.');
              }
              
              // Start continuous watching (updates every 30 seconds or when position changes significantly)
              locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                  updateUserLocation(position.coords.latitude, position.coords.longitude);
                },
                (error) => {
                  console.warn('Location watch error:', error);
                  // Don't show error toast for watch errors, just log
                },
                { 
                  timeout: 15000, 
                  maximumAge: 30000, // Use cached position if less than 30 seconds old
                  enableHighAccuracy: true // Better accuracy for continuous tracking
                }
              );
            },
            (error) => {
              console.warn('Geolocation error:', error);
              requestLocationBtn.textContent = 'Get My Location';
              requestLocationBtn.disabled = false;
              
              let errorMsg = 'Could not get your location.';
              if (error.code === error.PERMISSION_DENIED) {
                errorMsg = 'Location permission denied. Please enable location access in your browser settings.';
              } else if (error.code === error.POSITION_UNAVAILABLE) {
                errorMsg = 'Location information unavailable.';
              } else if (error.code === error.TIMEOUT) {
                errorMsg = 'Location request timed out.';
              }
              
              if (typeof showToast === 'function') {
                showToast('❌ ' + errorMsg);
              } else {
                alert(errorMsg);
              }
            },
            { timeout: 10000, maximumAge: 60000, enableHighAccuracy: true }
          );
        });
      }
      
      // Check for stored location on page load and start watching if available
      if (checkStoredLocation()) {
        // If we have a stored location, start watching for updates
        if (navigator.geolocation && locationWatchId === null) {
          locationWatchId = navigator.geolocation.watchPosition(
            (position) => {
              updateUserLocation(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
              console.warn('Location watch error:', error);
            },
            { 
              timeout: 15000, 
              maximumAge: 30000,
              enableHighAccuracy: true
            }
          );
        }
      }
      
      // Distance filter chip handlers (in panel - only toggle temp state)
      document.querySelectorAll('.distance-chip').forEach(btn => {
        btn.addEventListener("click", () => {
          if (!userLocation) {
            if (typeof showToast === 'function') {
              showToast('📍 Please set your location first to filter by distance.');
            }
            return;
          }
          
          const distance = btn.dataset.distance;
          if (tempDistanceFilter === distance) {
            tempDistanceFilter = null;
          } else {
            tempDistanceFilter = distance;
          }
          updateChipVisuals();
        });
      });
      
      // Distance "View More" button
      const distanceViewMoreBtn = document.getElementById("distanceViewMoreBtn");
      const distanceMoreOptions = document.getElementById("distanceMoreOptions");
      if (distanceViewMoreBtn && distanceMoreOptions) {
        let showingMore = false;
        distanceViewMoreBtn.addEventListener("click", () => {
          showingMore = !showingMore;
          distanceMoreOptions.style.display = showingMore ? "flex" : "none";
          distanceViewMoreBtn.textContent = showingMore ? "View Less" : "View More";
        });
      }
      
      // Check for stored location on page load
      checkStoredLocation();
      
      // Filter Panel Control
      const filtersPanel = document.getElementById("filtersPanel");
      const filtersOverlay = document.getElementById("filtersOverlay");
      const filtersToggleBtn = document.getElementById("filtersToggleBtn");
      const filtersCloseBtn = document.getElementById("filtersCloseBtn");
      const applyFiltersBtn = document.getElementById("applyFiltersBtn");
      const clearFiltersBtn = document.getElementById("clearFiltersBtn");
      const filtersBadge = document.getElementById("filtersBadge");
      
      // Temporary filter state (for panel editing)
      let tempCategoryFilters = new Set();
      let tempPriceTypeFilters = new Set();
      let tempWorkersFilters = new Set();
      let tempDistanceFilter = null;
      
      // Function to count active filters
      function countActiveFilters() {
        let count = 0;
        count += activeCategoryFilters.size;
        count += activePriceTypeFilters.size;
        count += activeWorkersFilters.size;
        if (activeDistanceFilter) count += 1;
        return count;
      }
      
      // Function to update filter badge
      function updateFilterBadge() {
        const count = countActiveFilters();
        if (filtersBadge) {
          if (count > 0) {
            filtersBadge.textContent = count;
            filtersBadge.style.display = 'inline-block';
          } else {
            filtersBadge.style.display = 'none';
          }
        }
      }
      
      // Make updateFilterBadge globally available
      window.updateFilterBadge = updateFilterBadge;
      
      // Initial badge update
      updateFilterBadge();
      
      // Function to sync temp state with active state
      function syncTempToActive() {
        tempCategoryFilters = new Set(activeCategoryFilters);
        tempPriceTypeFilters = new Set(activePriceTypeFilters);
        tempWorkersFilters = new Set(activeWorkersFilters);
        tempDistanceFilter = activeDistanceFilter;
      }
      
      // Function to sync active state to temp state
      function syncActiveToTemp() {
        activeCategoryFilters = new Set(tempCategoryFilters);
        activePriceTypeFilters = new Set(tempPriceTypeFilters);
        activeWorkersFilters = new Set(tempWorkersFilters);
        activeDistanceFilter = tempDistanceFilter;
      }
      
      // Function to update chip visual states based on temp state
      function updateChipVisuals() {
        // Category chips
        document.querySelectorAll('.category-chip').forEach(chip => {
          const cat = chip.dataset.category;
          if (tempCategoryFilters.has(cat)) {
            chip.style.background = "var(--primary)";
            chip.style.color = "white";
            chip.style.border = "1.5px solid var(--primary)";
          } else {
            chip.style.background = "white";
            chip.style.color = "var(--text-main)";
            chip.style.border = "1.5px solid var(--border)";
          }
        });
        
        // Price type chips
        document.querySelectorAll('.price-chip').forEach(chip => {
          const priceType = chip.dataset.priceType;
          if (tempPriceTypeFilters.has(priceType)) {
            chip.style.background = "var(--primary)";
            chip.style.color = "white";
            chip.style.border = "1.5px solid var(--primary)";
          } else {
            chip.style.background = "white";
            chip.style.color = "var(--text-main)";
            chip.style.border = "1.5px solid var(--border)";
          }
        });
        
        // Workers chips
        document.querySelectorAll('.workers-chip').forEach(chip => {
          const workers = chip.dataset.workers;
          if (tempWorkersFilters.has(workers)) {
            chip.style.background = "var(--primary)";
            chip.style.color = "white";
            chip.style.border = "1.5px solid var(--primary)";
          } else {
            chip.style.background = "white";
            chip.style.color = "var(--text-main)";
            chip.style.border = "1.5px solid var(--border)";
          }
        });
        
        // Ensure all filter types support multi-select (no restrictions)
        
        // Distance chips
        document.querySelectorAll('.distance-chip').forEach(chip => {
          const distance = chip.dataset.distance;
          if (tempDistanceFilter === distance) {
            chip.style.background = "var(--primary)";
            chip.style.color = "white";
            chip.style.border = "1.5px solid var(--primary)";
          } else {
            chip.style.background = "white";
            chip.style.color = "var(--text-main)";
            chip.style.border = "1.5px solid var(--border)";
          }
        });
      }
      
      // Function to open filter panel
      function openFiltersPanel() {
        syncTempToActive();
        updateChipVisuals();
        if (filtersPanel) {
          filtersPanel.style.bottom = '0';
          filtersPanel.style.visibility = 'visible';
          filtersPanel.style.pointerEvents = 'auto';
        }
        if (filtersOverlay) {
          filtersOverlay.style.display = 'block';
          filtersOverlay.style.visibility = 'visible';
          filtersOverlay.style.pointerEvents = 'auto';
          setTimeout(() => {
            filtersOverlay.style.opacity = '1';
          }, 10);
        }
        document.body.style.overflow = 'hidden';
      }
      
      // Function to close filter panel
      function closeFiltersPanel() {
        if (filtersPanel) {
          filtersPanel.style.bottom = '-100%';
          // Delay hiding visibility to allow transition
          setTimeout(() => {
            if (filtersPanel) {
              filtersPanel.style.visibility = 'hidden';
              filtersPanel.style.pointerEvents = 'none';
            }
          }, 300);
        }
        if (filtersOverlay) {
          filtersOverlay.style.opacity = '0';
          setTimeout(() => {
            if (filtersOverlay) {
            filtersOverlay.style.display = 'none';
              filtersOverlay.style.visibility = 'hidden';
              filtersOverlay.style.pointerEvents = 'none';
            }
          }, 300);
        }
        document.body.style.overflow = '';
      }
      
      // Open panel handlers
      if (filtersToggleBtn) {
        filtersToggleBtn.addEventListener("click", openFiltersPanel);
      }
      
      // Close panel handlers
      if (filtersCloseBtn) {
        filtersCloseBtn.addEventListener("click", closeFiltersPanel);
      }
      if (filtersOverlay) {
        filtersOverlay.addEventListener("click", closeFiltersPanel);
      }
      
      // Apply filters button
      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener("click", () => {
          // Save scroll position
          const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
          
          // Apply temp state to active state
          syncActiveToTemp();
          
          // Close panel
          closeFiltersPanel();
          
          // Update badge
          updateFilterBadge();
          
          // Apply filters and restore scroll position
          if (typeof renderJobs === 'function') {
            renderJobs(true).then(() => {
              // Restore scroll position after a brief delay
              setTimeout(() => {
                window.scrollTo({ top: scrollPosition, behavior: 'instant' });
              }, 100);
            });
          }
        });
      }
      
      // Clear all filters button
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener("click", () => {
          tempCategoryFilters.clear();
          tempPriceTypeFilters.clear();
          tempWorkersFilters.clear();
          tempDistanceFilter = null;
          updateChipVisuals();
        });
      }
      
      // Price type filter chips - add click handlers for multiple selection
      document.querySelectorAll('.price-chip').forEach(chip => {
        chip.addEventListener("click", () => {
          const priceType = chip.dataset.priceType;
          if (tempPriceTypeFilters.has(priceType)) {
            tempPriceTypeFilters.delete(priceType);
          } else {
            tempPriceTypeFilters.add(priceType);
          }
          updateChipVisuals();
        });
      });
      
      // Workers filter chips - add click handlers for multiple selection
      document.querySelectorAll('.workers-chip').forEach(chip => {
        chip.addEventListener("click", () => {
          const workers = chip.dataset.workers;
          if (tempWorkersFilters.has(workers)) {
            tempWorkersFilters.delete(workers);
          } else {
            tempWorkersFilters.add(workers);
          }
          updateChipVisuals();
        });
      });
      
      // Sort dropdown
      const sortSelect = document.getElementById("jobsSortSelect");
      if (sortSelect) {
        sortSelect.value = activeSortBy;
        sortSelect.addEventListener("change", (e) => {
          activeSortBy = e.target.value;
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      }
      
      // Category filter - populate dynamically from available jobs
      const categoryFilterChips = document.getElementById("categoryFilterChips");
      const categoryViewMoreBtn = document.getElementById("categoryViewMoreBtn");
      if (categoryFilterChips) {
        // Function to populate categories
        function populateCategories() {
          const categories = new Set();
          if (Array.isArray(allLoadedJobs)) {
            allLoadedJobs.forEach(job => {
              if (job.category) categories.add(job.category.toLowerCase());
            });
          }
          
          // Category definitions with emojis
          const categoryDefs = {
            'moving': { name: 'Moving', emoji: '🚚' },
            'yard-work': { name: 'Yard Work', emoji: '🌿' },
            'dump-run': { name: 'Dump Run', emoji: '🗑️' },
            'cleaning': { name: 'Cleaning', emoji: '🧹' },
            'power-washing': { name: 'Power Wash', emoji: '💦' },
            'furniture-assembly': { name: 'Assembly', emoji: '🔧' },
            'housekeeping': { name: 'Housekeeping', emoji: '🏡' },
            'small-moves': { name: 'Small Moves', emoji: '📦' },
            'heavy-lifting': { name: 'Heavy Lifting', emoji: '🎒' },
            'furniture-help': { name: 'Furniture Help', emoji: '🪑' },
            'painting': { name: 'Painting', emoji: '🎨' },
            'handyman': { name: 'Handyman', emoji: '🔨' },
            'landscaping': { name: 'Landscaping', emoji: '🌳' },
            'pet-care': { name: 'Pet Care', emoji: '🐕' },
            'delivery': { name: 'Delivery', emoji: '📦' },
            'car-cleaning': { name: 'Car Clean', emoji: '🚿' },
            'event-setup': { name: 'Event Setup', emoji: '🎪' },
            'snow-removal': { name: 'Snow Removal', emoji: '❄️' },
            'other': { name: 'Other', emoji: '➕' }
          };
          
          // All available categories (including ones not in jobs)
          const allCategories = [
            'moving', 'yard-work', 'dump-run', 'cleaning', 'power-washing',
            'furniture-assembly', 'housekeeping', 'small-moves', 'heavy-lifting',
            'furniture-help', 'painting', 'handyman', 'landscaping', 'pet-care',
            'delivery', 'car-cleaning', 'event-setup', 'snow-removal', 'other'
          ];
          
          // Filter to only show categories that exist in jobs OR show all
          const categoriesToShow = Array.from(categories).length > 0 
            ? Array.from(categories) 
            : allCategories;
          
          const initialCategories = categoriesToShow.slice(0, 6);
          const moreCategories = categoriesToShow.slice(6);
          
          // Clear existing chips
          categoryFilterChips.innerHTML = '';
          
          // Add initial categories
          initialCategories.forEach(cat => {
            const def = categoryDefs[cat] || { name: cat, emoji: '⭐' };
            const chip = document.createElement("button");
            chip.className = "filter-chip category-chip";
            chip.dataset.category = cat;
            chip.innerHTML = `<span>${def.emoji}</span> <span>${def.name}</span>`;
            chip.style.cssText = "padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;";
            chip.addEventListener("click", () => {
              if (tempCategoryFilters.has(cat)) {
                tempCategoryFilters.delete(cat);
              } else {
                tempCategoryFilters.add(cat);
              }
              updateChipVisuals();
            });
            categoryFilterChips.appendChild(chip);
          });
          
          // Show "View More" if there are more categories
          if (moreCategories.length > 0 && categoryViewMoreBtn) {
            categoryViewMoreBtn.style.display = "block";
            // Start with collapsed state (showingMore = false)
            let showingMore = false;
            // Ensure the button text starts as "Show More" and container is hidden
            categoryViewMoreBtn.textContent = "➕ Show More";
            let moreContainer = document.getElementById("categoryMoreOptions");
            if (!moreContainer) {
              moreContainer = document.createElement("div");
              moreContainer.id = "categoryMoreOptions";
              moreContainer.style.cssText = "display: none; margin-top: 0.75rem; gap: 0.6rem; flex-wrap: wrap;";
              // When shown, it will use flex display
              categoryViewMoreBtn.parentNode.insertBefore(moreContainer, categoryViewMoreBtn.nextSibling);
            } else {
              moreContainer.innerHTML = ''; // Clear existing
            }
            
            moreCategories.forEach(cat => {
              const def = categoryDefs[cat] || { name: cat, emoji: '⭐' };
              const chip = document.createElement("button");
              chip.className = "filter-chip category-chip";
              chip.dataset.category = cat;
              chip.innerHTML = `<span>${def.emoji}</span> <span>${def.name}</span>`;
              chip.style.cssText = "padding: 0.65rem 1.25rem; border: 1.5px solid var(--border); border-radius: 24px; font-size: 0.9rem; background: white; color: var(--text-main); cursor: pointer; white-space: nowrap; transition: all 0.2s; font-weight: 500; display: flex; align-items: center; gap: 0.4rem;";
              chip.addEventListener("click", () => {
                if (tempCategoryFilters.has(cat)) {
                  tempCategoryFilters.delete(cat);
                } else {
                  tempCategoryFilters.add(cat);
                }
                updateChipVisuals();
              });
              moreContainer.appendChild(chip);
            });
            
            categoryViewMoreBtn.addEventListener("click", () => {
              showingMore = !showingMore;
              if (moreContainer) {
                moreContainer.style.display = showingMore ? "flex" : "none";
              }
              categoryViewMoreBtn.textContent = showingMore ? "➖ Show Less" : "➕ Show More";
            });
          } else if (categoryViewMoreBtn) {
            categoryViewMoreBtn.style.display = "none";
          }
        }
        
        // Populate categories when jobs are loaded
        populateCategories();
      }
      
      // Price type filter handlers
      document.querySelectorAll('.price-chip').forEach(btn => {
        btn.addEventListener("click", () => {
          const priceType = btn.dataset.priceType;
          if (activePriceTypeFilters.has(priceType)) {
            activePriceTypeFilters.delete(priceType);
            btn.style.background = "white";
            btn.style.color = "var(--text-main)";
          } else {
            activePriceTypeFilters.add(priceType);
            btn.style.background = "var(--primary)";
            btn.style.color = "white";
          }
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      });
      
      // Time filter handlers
      document.querySelectorAll('.time-chip').forEach(btn => {
        btn.addEventListener("click", () => {
          const time = btn.dataset.time;
          if (activeTimeFilters.has(time)) {
            activeTimeFilters.delete(time);
            btn.style.background = "white";
            btn.style.color = "var(--text-main)";
          } else {
            activeTimeFilters.add(time);
            btn.style.background = "var(--primary)";
            btn.style.color = "white";
          }
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      });
      
      const timeViewMoreBtn = document.getElementById("timeViewMoreBtn");
      const timeMoreOptions = document.getElementById("timeMoreOptions");
      if (timeViewMoreBtn && timeMoreOptions) {
        let showingMore = false;
        timeViewMoreBtn.addEventListener("click", () => {
          showingMore = !showingMore;
          timeMoreOptions.style.display = showingMore ? "flex" : "none";
          timeViewMoreBtn.textContent = showingMore ? "View Less" : "View More";
        });
      }
      
      // Workers filter handlers
      document.querySelectorAll('.workers-chip').forEach(btn => {
        btn.addEventListener("click", () => {
          const workers = btn.dataset.workers;
          if (activeWorkersFilters.has(workers)) {
            activeWorkersFilters.delete(workers);
            btn.style.background = "white";
            btn.style.color = "var(--text-main)";
          } else {
            activeWorkersFilters.add(workers);
            btn.style.background = "var(--primary)";
            btn.style.color = "white";
          }
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      });
      
      const workersViewMoreBtn = document.getElementById("workersViewMoreBtn");
      const workersMoreOptions = document.getElementById("workersMoreOptions");
      if (workersViewMoreBtn && workersMoreOptions) {
        let showingMore = false;
        workersViewMoreBtn.addEventListener("click", () => {
          showingMore = !showingMore;
          workersMoreOptions.style.display = showingMore ? "flex" : "none";
          workersViewMoreBtn.textContent = showingMore ? "View Less" : "View More";
        });
      }
      
      // Refresh button
      const refreshBtn = document.getElementById("refreshJobsBtn");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
          // Removed toast notification - silent refresh
        });
      }
      
      // Background polling system
      function startBackgroundPolling() {
        stopBackgroundPolling();
        
        const currentView = window.activeView || activeView;
        if (!POLLABLE_VIEWS.includes(currentView)) {
          return;
        }
        
        console.log('[POLLING] Starting background polling for view:', currentView);
        
        backgroundPollInterval = setInterval(async () => {
          // Check if user is interacting (typing, etc.)
          if (isUserInteracting) {
            console.debug('[POLLING] Skipping poll - user is interacting');
            return;
          }
          
          const view = window.activeView || activeView;
          if (!POLLABLE_VIEWS.includes(view)) {
            stopBackgroundPolling();
            return;
          }
          
          // Prevent too frequent polling
          const now = Date.now();
          if (now - lastPollTime < 3000) {
            return;
          }
          lastPollTime = now;
          
          try {
            // CRITICAL: Only use silent update functions that preserve state
            // NEVER call renderJobs(true) or renderAll() from polling
            if (view === 'jobs') {
              await silentUpdateBrowseJobs(); // This preserves scroll, filters, state
            } else if (view === 'manage-jobs') {
              await silentUpdateManageJobs(); // This preserves tab, scroll, state
            } else if (view === 'messages') {
              // Messages already has its own polling, skip
            }
          } catch (error) {
            // Silently ignore errors - don't disrupt user experience
            console.debug('[POLLING] Silent update error (ignored):', error);
          }
        }, POLL_INTERVAL);
      }
      
      function stopBackgroundPolling() {
        if (backgroundPollInterval) {
          clearInterval(backgroundPollInterval);
          backgroundPollInterval = null;
          console.log('[POLLING] Stopped background polling');
        }
      }
      
      // Silent update for Browse Jobs - only updates data, preserves UI state
      // CRITICAL: This function MUST NOT reset any state, scroll position, filters, or UI
      async function silentUpdateBrowseJobs() {
        const jobsList = document.getElementById("jobsList");
        if (!jobsList) return;
        
        // Preserve scroll position
        const scrollPosition = jobsList.scrollTop || window.scrollY || 0;
        
        // Preserve current filters and pagination
        const savedPage = currentJobsPage;
        const savedFilters = {
          category: activeCategoryFilter,
          priceType: activePriceTypeFilter,
          workers: activeWorkersFilter,
          sortBy: activeSortBy
        };
        const savedView = currentJobsView; // 'list' or 'map'
        
        try {
          // Use current filters, not hardcoded ones
          const filters = {
            page: 1, // Always fetch first page for updates
            limit: 100, // Get enough to update existing
            status: 'OPEN'
          };
          
          // Preserve category filter if set
          if (activeCategoryFilter && activeCategoryFilter !== 'all') {
            filters.category = activeCategoryFilter;
          }
          
          let response;
          if (window.hustlAPI && window.hustlAPI.jobs && typeof window.hustlAPI.jobs.list === 'function') {
            response = await window.hustlAPI.jobs.list(filters);
          } else {
            const params = new URLSearchParams();
            params.append('page', '1');
            params.append('limit', '100');
            params.append('status', 'OPEN'); // Explicitly request OPEN jobs
            if (filters.category) params.append('category', filters.category);
            if (filters.zip) params.append('zip', filters.zip);
            if (filters.radius) params.append('radius', filters.radius);
            const apiResponse = await fetch(`${API_BASE}/jobs?${params.toString()}`, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' }
            });
            if (!apiResponse.ok) return;
            response = await apiResponse.json();
          }
          
          const newJobs = response?.jobs || response || [];
          if (!Array.isArray(newJobs)) return;
          
          // Update existing job cards or add new ones WITHOUT clearing the list
          const existingJobIds = new Set();
          jobsList.querySelectorAll('[data-job-id]').forEach(card => {
            const jobId = card.dataset.jobId;
            if (jobId) existingJobIds.add(jobId);
          });
          
          // Update existing cards with new data (silent update)
          newJobs.forEach(job => {
            const existingCard = jobsList.querySelector(`[data-job-id="${job.id}"]`);
            if (existingCard) {
              // Update status, price, etc. without full re-render
              updateJobCardSilently(existingCard, job);
            }
          });
          
          // Update allLoadedJobs cache WITHOUT resetting it
          if (!Array.isArray(allLoadedJobs)) {
            allLoadedJobs = [];
          }
          const jobMap = new Map(allLoadedJobs.map(j => [j.id, j]));
          newJobs.forEach(job => {
            jobMap.set(job.id, job);
          });
          allLoadedJobs = Array.from(jobMap.values());
          
          // Restore scroll position
          if (scrollPosition > 0) {
            requestAnimationFrame(() => {
              if (jobsList) jobsList.scrollTop = scrollPosition;
              if (window.scrollY !== scrollPosition) {
                window.scrollTo(0, scrollPosition);
              }
            });
          }
          
          // Restore filters and pagination (they shouldn't have changed, but be safe)
          currentJobsPage = savedPage;
          activeCategoryFilter = savedFilters.category;
          activePriceTypeFilter = savedFilters.priceType;
          activeWorkersFilter = savedFilters.workers;
          activeSortBy = savedFilters.sortBy;
          
          // Restore map/list view
          if (savedView && currentJobsView !== savedView) {
            currentJobsView = savedView;
          }
          
          // If map view is active, update map markers silently (preserve zoom/pan)
          if (currentJobsView === 'map' && jobsMap && jobsMap.loaded()) {
            try {
              // Save current map state
              const mapCenter = jobsMap.getCenter();
              const mapZoom = jobsMap.getZoom();
              const mapBearing = jobsMap.getBearing();
              const mapPitch = jobsMap.getPitch();
              
              // Update map with new jobs (this updates markers but doesn't reset view)
              await renderJobsOnMap(Array.from(jobMap.values()));
              
              // Restore map view exactly as it was
              if (mapCenter && mapZoom) {
                jobsMap.setCenter(mapCenter);
                jobsMap.setZoom(mapZoom);
                if (mapBearing !== undefined) jobsMap.setBearing(mapBearing);
                if (mapPitch !== undefined) jobsMap.setPitch(mapPitch);
              }
            } catch (mapError) {
              console.debug('[POLLING] Map update error (ignored):', mapError);
            }
          }
          
        } catch (error) {
          console.debug('[POLLING] Browse Jobs update error (silent, ignored):', error);
          // On error, restore state anyway
          currentJobsPage = savedPage;
        }
      }
      
      // Update a single job card silently without re-rendering
      function updateJobCardSilently(card, job) {
        // Only update dynamic content that might change:
        // - Status badges
        // - Applied indicators
        // - Price if changed
        // - Time ago text
        
        // Update status if visible
        const statusEl = card.querySelector('.job-status');
        if (statusEl && job.status) {
          const statusLabels = {
            'OPEN': 'Open',
            'ASSIGNED': 'Assigned',
            'SCHEDULED': 'Scheduled',
            'IN_PROGRESS': 'In Progress',
            'COMPLETED_BY_HUSTLER': 'Awaiting Confirmation',
            'PAID': 'Completed',
            'EXPIRED': 'Expired'
          };
          statusEl.textContent = statusLabels[job.status] || job.status;
        }
        
        // Update "Applied" indicator if present
        const appliedBadge = card.querySelector('.applied-badge');
        if (appliedBadge) {
          // Check if still applied
          // This would need to check user's offers
        }
        
        // Update time ago if present
        const timeAgoEl = card.querySelector('.time-ago');
        if (timeAgoEl && job.createdAt) {
          const createdMs = new Date(job.createdAt).getTime();
          timeAgoEl.textContent = timeAgo(createdMs);
        }
      }
      
      // Silent update for Manage Jobs
      async function silentUpdateManageJobs() {
        const currentTab = document.querySelector('.manage-tab.active')?.dataset?.manageTab;
        if (!currentTab) return;
        
        try {
          const token = localStorage.getItem('hustl_token');
          if (!token) return;
          
          if (currentTab === 'posted') {
            // Update posted jobs
            const response = await fetch(`${API_BASE}/jobs/my-jobs`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;
            const jobs = await response.json();
            if (Array.isArray(jobs)) {
              updateManageJobsList('managePostedJobsList', jobs.filter(j => j.status === 'OPEN'));
            }
          } else if (currentTab === 'active') {
            // Update active jobs
            const response = await fetch(`${API_BASE}/jobs/active`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;
            const jobs = await response.json();
            if (Array.isArray(jobs)) {
              updateManageJobsList('manageActiveJobsList', jobs);
            }
          } else if (currentTab === 'completed') {
            // Update completed jobs
            const response = await fetch(`${API_BASE}/jobs/my-jobs`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;
            const jobs = await response.json();
            if (Array.isArray(jobs)) {
              const completed = jobs.filter(j => 
                j.status === 'PAID' || 
                j.status === 'COMPLETED_BY_HUSTLER' ||
                j.status === 'CANCELLED'
              );
              updateManageJobsList('manageCompletedJobsList', completed);
            }
          } else if (currentTab === 'applied') {
            // Update applied jobs
            const response = await fetch(`${API_BASE}/offers/user/me`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) return;
            const offers = await response.json();
            if (Array.isArray(offers)) {
              const appliedJobs = offers
                .filter(o => o.status === 'PENDING' || (o.status === 'ACCEPTED' && o.job && !o.job.startCodeVerified))
                .map(o => o.job)
                .filter(Boolean);
              updateManageJobsList('manageAppliedJobsList', appliedJobs);
            }
          }
        } catch (error) {
          console.debug('[POLLING] Manage Jobs update error (silent):', error);
        }
      }
      
      // Update manage jobs list silently
      function updateManageJobsList(listId, newJobs) {
        const listEl = document.getElementById(listId);
        if (!listEl) return;
        
        // Create a map of existing jobs
        const existingMap = new Map();
        listEl.querySelectorAll('[data-job-id]').forEach(card => {
          const jobId = card.dataset.jobId;
          if (jobId) existingMap.set(jobId, card);
        });
        
        // Update existing or add new
        newJobs.forEach(job => {
          const existing = existingMap.get(job.id);
          if (existing) {
            updateJobCardSilently(existing, job);
          }
          // New jobs will be added on next full render
        });
      }
      
      // Track user interactions to pause polling
      let interactionTimeout = null;
      function markUserInteraction() {
        isUserInteracting = true;
        if (interactionTimeout) clearTimeout(interactionTimeout);
        interactionTimeout = setTimeout(() => {
          isUserInteracting = false;
        }, 2000); // Resume polling 2 seconds after last interaction
      }
      
      // Monitor for user typing/interactions
      document.addEventListener('input', (e) => {
        const target = e.target;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
          markUserInteraction();
        }
      });
      
      document.addEventListener('focus', (e) => {
        const target = e.target;
        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
          markUserInteraction();
        }
      });
      
      // Make functions globally available
      window.startBackgroundPolling = startBackgroundPolling;
      window.stopBackgroundPolling = stopBackgroundPolling;
    }
    
    async function startPayment(jobId) {
  const job = state.jobs.find((j) => j.id === jobId);
  const user = getCurrentUser();

  if (!job || !user || user.id !== job.postedByUserId) {
    showToast("Only the customer who posted can pay for this job.");
    return;
  }

  if (!job.acceptedHustlerId) {
    showToast("Accept a Hustler before paying.");
    return;
  }

  // Calculate total
  let total = 0;
  if (job.paymentType === "flat") {
    total = job.flatAmount || 0;
  } else {
    total = (job.hourlyRate || 0) * (job.maxHours || 0);
  }

  if (total <= 0) {
    showToast("Job total must be greater than zero.");
    return;
  }

  // Stripe expects amount in cents
  const platformPercent = 0.12; // 12% cut
  const platformFee = Math.round(total * platformPercent);
  const amountToCharge = total * 100; // Convert to cents

try {
    const res = await fetch("http://localhost:8080/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amountTotalCents: amountToCharge,
        customerEmail: user.email,
        description: `Hustl job payment for: ${job.title}`,
      }),
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast("Failed to start Stripe Checkout session.");
    }
  } catch (err) {
    console.error("Payment error:", err);
    showToast("Error connecting to payment server.");
  }
}

  // ========== HAMBURGER MENU ==========
  function initHamburgerMenu() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (!hamburgerBtn || !mobileMenu) {
      // Retry if elements not ready
      setTimeout(initHamburgerMenu, 100);
      return;
    }
    
    // Remove old event listeners by cloning elements
    const newHamburgerBtn = hamburgerBtn.cloneNode(true);
    const newMobileMenu = mobileMenu.cloneNode(true);
    hamburgerBtn.parentNode.replaceChild(newHamburgerBtn, hamburgerBtn);
    mobileMenu.parentNode.replaceChild(newMobileMenu, mobileMenu);
    
    // Get fresh references after cloning
    const freshHamburgerBtn = document.getElementById('hamburgerBtn');
    const freshMobileMenu = document.getElementById('mobileMenu');
    
    if (!freshHamburgerBtn || !freshMobileMenu) {
      console.warn("Hamburger menu elements not found after cloning");
      return;
    }
    
    // Prevent double-click issues
    let isToggling = false;
    freshHamburgerBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (isToggling) return;
      isToggling = true;
      
      const isOpen = freshMobileMenu.classList.contains('open');
      
      if (isOpen) {
        // Closing menu
        freshHamburgerBtn.classList.remove('open');
        freshMobileMenu.classList.remove('open');
        document.body.classList.remove('mobile-menu-open');
        document.body.style.overflow = '';
        // Hide close button
        const closeBtn = document.getElementById('mobileMenuClose');
        if (closeBtn) {
          closeBtn.style.display = 'none';
          closeBtn.style.visibility = 'hidden';
        }
      } else {
        // Opening menu
        freshHamburgerBtn.classList.add('open');
        freshMobileMenu.classList.add('open');
        document.body.classList.add('mobile-menu-open');
        document.body.style.overflow = 'hidden';
        // Show close button - use setTimeout to ensure menu is rendered first
        setTimeout(() => {
          const closeBtn = document.getElementById('mobileMenuClose');
          if (closeBtn) {
            closeBtn.style.display = 'flex';
            closeBtn.style.visibility = 'visible';
            closeBtn.style.opacity = '1';
            closeBtn.style.zIndex = '10006';
          }
        }, 10);
      }
      
      setTimeout(() => {
        isToggling = false;
      }, 300);
    });
    
    // Handle close button click
    const mobileMenuClose = document.getElementById('mobileMenuClose');
    if (mobileMenuClose) {
      mobileMenuClose.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        freshHamburgerBtn.classList.remove('open');
        freshMobileMenu.classList.remove('open');
        document.body.classList.remove('mobile-menu-open');
        document.body.style.overflow = '';
        mobileMenuClose.style.display = 'none';
      });
    }
    
    // Close menu when clicking overlay (but not menu content)
    freshMobileMenu.addEventListener('click', (e) => {
      // If clicking directly on the menu container (overlay), close it
      if (e.target === freshMobileMenu) {
        freshHamburgerBtn.classList.remove('open');
        freshMobileMenu.classList.remove('open');
        document.body.classList.remove('mobile-menu-open');
        document.body.style.overflow = '';
        const closeBtn = document.getElementById('mobileMenuClose');
        if (closeBtn) closeBtn.style.display = 'none';
        return;
      }
    });
    
    // Handle mobile menu item clicks using event delegation (works with dynamically added items)
    freshMobileMenu.addEventListener('click', (e) => {
        // Don't close if clicking the close button (handled above)
        if (e.target.closest('.mobile-menu-close')) return;
        
        const item = e.target.closest('.mobile-menu-item');
        if (!item) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const view = item.dataset.view;
        const action = item.dataset.action;
        
        // Call window.setView
        if (view && window.setView && typeof window.setView === 'function') {
          const funcStr = window.setView.toString();
          if (!funcStr.includes('not ready yet')) {
            window.setView(view);
            
          } else {
            // Fallback if setView is stub
            document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
            const target = document.getElementById("view-" + view);
            if (target) target.style.display = "block";
          }
        }
        
        // Close menu
        freshHamburgerBtn.classList.remove('open');
        freshMobileMenu.classList.remove('open');
        document.body.classList.remove('mobile-menu-open');
        document.body.style.overflow = '';
        const closeBtn = document.getElementById('mobileMenuClose');
        if (closeBtn) closeBtn.style.display = 'none';
        
        // Update active state
        freshMobileMenu.querySelectorAll('.mobile-menu-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
      });
      
      // Mobile auth buttons - use event delegation for dynamically added buttons
      freshMobileMenu.addEventListener('click', (e) => {
        // Handle login button
        if (e.target.id === 'mobileLoginBtn' || e.target.closest('#mobileLoginBtn')) {
          e.preventDefault();
          e.stopPropagation();
          freshHamburgerBtn.classList.remove('open');
          freshMobileMenu.classList.remove('open');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
          if (typeof window.openAuthModal === 'function') {
            window.openAuthModal('login');
          }
        } 
        // Handle signup button
        else if (e.target.id === 'mobileSignupBtn' || e.target.closest('#mobileSignupBtn')) {
          e.preventDefault();
          e.stopPropagation();
          freshHamburgerBtn.classList.remove('open');
          freshMobileMenu.classList.remove('open');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
          if (typeof window.openAuthModal === 'function') {
            window.openAuthModal('create');
          }
        }
        // Handle sign out button - check for ID, data-action, or text content
        else if (e.target.id === 'mobileSignOutBtn' || 
                 e.target.closest('#mobileSignOutBtn') ||
                 e.target.dataset.action === 'signout' || 
                 e.target.closest('[data-action="signout"]')) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Mobile sign out button clicked');
          freshHamburgerBtn.classList.remove('open');
          freshMobileMenu.classList.remove('open');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
          // Call handleSignOut directly
          if (window.handleSignOut) {
            window.handleSignOut();
          } else {
            console.error('handleSignOut not available');
          }
        }
      });
    
    // Desktop auth buttons are now handled in updateHeaderAuth() to avoid duplicate listeners
  }
  
  // ========== AUTH MODAL ==========
  // Define and assign to window immediately
  window.openAuthModal = function openAuthModal(mode = 'create') {
    // Check if user is already logged in
    const user = getCurrentUser();
    if (user) {
      if (typeof window.setView === 'function') {
        window.setView('profile');
      }
      return;
    }
    
    // Switch to home view first, then show auth section
    if (typeof window.setView === 'function') {
      window.setView('home');
    }
    
    // Small delay to ensure home view is rendered
    setTimeout(() => {
      const authSection = document.getElementById('authSection');
      if (authSection) {
        authSection.style.display = 'block';
        authSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Toggle to correct mode
        const authTitle = document.getElementById("authCardTitle");
        const authBodyCreate = document.getElementById("authBodyCreate");
        const authBodyLogin = document.getElementById("authBodyLogin");
        
        if (mode === 'login') {
          if (authTitle) authTitle.textContent = "👋 Welcome Back";
          if (authBodyCreate) authBodyCreate.style.display = 'none';
          if (authBodyLogin) authBodyLogin.style.display = 'block';
        } else {
          if (authTitle) authTitle.textContent = "🚀 Join Hustl";
          if (authBodyCreate) authBodyCreate.style.display = 'block';
          if (authBodyLogin) authBodyLogin.style.display = 'none';
        }
      }
    }, 50);
  }
  // Expose openAuthModal globally immediately after definition
  window.openAuthModal = openAuthModal;
  
  // Define and assign closeAuthModal to window immediately
  window.closeAuthModal = function closeAuthModal() {
    const overlay = document.getElementById('authModalOverlay');
    if (overlay) {
      overlay.classList.remove('open');
      document.body.style.overflow = '';
    }
  };
  
  // Function is already assigned above, just log confirmation
  console.log('✅ closeAuthModal function assigned to window.closeAuthModal');
  
  // Update header when logged in/out - uses API to get current user
  async function updateHeaderAuth() {
    let user = null;
    try {
      user = await window.hustlAPI.auth.getCurrentUser();
    } catch (error) {
      console.error("Error getting current user:", error);
      user = null;
    }
    
    const desktopAuth = document.getElementById('headerAuthDesktop');
    const mobileAuth = document.querySelector('.mobile-menu .header-auth');
    
    // Add/remove logged-in class on body
    if (user) {
      document.body.classList.add('logged-in');
      // Show Manage Jobs tab when logged in
      const manageJobsTab = document.getElementById('manageJobsTab');
      if (manageJobsTab) manageJobsTab.style.display = 'block';
      // Hide bottom sign up CTA when logged in
      const homeBottomSignUpCTA = document.getElementById('homeBottomSignUpCTA');
      if (homeBottomSignUpCTA) homeBottomSignUpCTA.style.display = 'none';
    } else {
      document.body.classList.remove('logged-in');
      // Hide Manage Jobs tab when logged out
      const manageJobsTab = document.getElementById('manageJobsTab');
      if (manageJobsTab) manageJobsTab.style.display = 'none';
      // Show bottom sign up CTA when logged out
      const homeBottomSignUpCTA = document.getElementById('homeBottomSignUpCTA');
      if (homeBottomSignUpCTA) homeBottomSignUpCTA.style.display = '';
    }
    
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (user) {
      // Logged in state - simplified header
      const firstName = user.name?.split(' ')[0] || user.email?.split('@')[0] || 'User';
      if (desktopAuth) {
        desktopAuth.innerHTML = `
          <span style="color: var(--text-main); font-size: 0.85rem; font-weight: 500; margin-right: 0.75rem;">👋 ${firstName}</span>
          <button class="btn-login-header" id="desktopProfileBtn" data-action="profile">Profile</button>
          <button class="btn-signup-header" id="desktopLogoutBtn" data-action="signout" style="background: #fee2e2; color: #dc2626; border-color: #fca5a5; cursor: pointer;">Logout</button>
        `;
        // Add event listeners for desktop buttons - use setTimeout to ensure DOM is ready
        setTimeout(() => {
          const desktopProfileBtn = document.getElementById('desktopProfileBtn');
          const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
          if (desktopProfileBtn) {
            desktopProfileBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Desktop profile button clicked');
              if (window.setView && typeof window.setView === 'function') {
                window.setView('profile');
              }
            });
          } else {
            console.warn('desktopProfileBtn not found');
          }
          if (desktopLogoutBtn) {
            desktopLogoutBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Desktop logout button clicked');
              // Call handleSignOut directly - it's always defined
              if (window.handleSignOut) {
                window.handleSignOut();
              } else {
                console.error('handleSignOut not available');
              }
            });
          } else {
            console.warn('desktopLogoutBtn not found');
          }
        }, 50);
      }
      // Update mobile menu items for logged-in users (preserve header and close button)
      const mobileMenuItems = document.getElementById('mobileMenuItems');
      const mobileMenuAuth = document.getElementById('mobileMenuAuth');
      
      if (mobileMenuItems) {
        mobileMenuItems.innerHTML = `
          <button class="mobile-menu-item active" data-view="home">🏠 Home</button>
          <button class="mobile-menu-item" data-view="jobs">💼 Browse Jobs</button>
          <button class="mobile-menu-item" data-view="post">➕ Post a Job</button>
          <button class="mobile-menu-item" data-view="manage-jobs">📋 Manage Jobs</button>
          <button class="mobile-menu-item" data-view="messages">💬 Messages</button>
          <button class="mobile-menu-item" data-view="profile">👤 Profile</button>
          <button class="mobile-menu-item" data-view="about">ℹ️ About Us</button>
        `;
      }
      
      if (mobileMenuAuth) {
        mobileMenuAuth.innerHTML = `
            <div style="padding: 0.5rem; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border);">👋 Signed in as ${firstName}</div>
            <button class="btn-signup-header" id="mobileSignOutBtn" data-action="signout" style="width:100%; margin-top: 0.5rem; padding: 1rem; background: #fee2e2 !important; color: #dc2626 !important; border: 2px solid #fca5a5 !important; font-weight: 600; font-size: 1rem; z-index: 1; position: relative; opacity: 1 !important; visibility: visible !important; display: block !important;">🚪 Sign Out</button>
        `;
      }
    } else {
      // Logged out state - restore default buttons
      if (desktopAuth) {
        desktopAuth.innerHTML = `
          <button class="btn-login-header" id="headerLoginBtn">Log In</button>
          <button class="btn-signup-header" id="headerSignupBtn">Sign Up Free</button>
        `;
        // Add event listeners for desktop buttons - use setTimeout to ensure DOM is ready
        setTimeout(() => {
          const headerLoginBtn = document.getElementById('headerLoginBtn');
          const headerSignupBtn = document.getElementById('headerSignupBtn');
          if (headerLoginBtn) {
            headerLoginBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Header login button clicked');
              if (window.openAuthModal && typeof window.openAuthModal === 'function') {
                window.openAuthModal('login');
              }
            });
          } else {
            console.warn('headerLoginBtn not found');
          }
          if (headerSignupBtn) {
            headerSignupBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Header signup button clicked');
              if (window.openAuthModal && typeof window.openAuthModal === 'function') {
                window.openAuthModal('create');
              }
            });
          } else {
            console.warn('headerSignupBtn not found');
          }
        }, 50);
      }
      // Update mobile menu items for logged-out users (preserve header and close button)
      const mobileMenuItems = document.getElementById('mobileMenuItems');
      const mobileMenuAuth = document.getElementById('mobileMenuAuth');
      
      if (mobileMenuItems) {
        mobileMenuItems.innerHTML = `
          <button class="mobile-menu-item active" data-view="home">🏠 Home</button>
          <button class="mobile-menu-item" data-view="jobs">💼 Browse Jobs</button>
          <button class="mobile-menu-item" data-view="post">➕ Post a Job</button>
          <button class="mobile-menu-item" data-view="manage-jobs">📋 Manage Jobs</button>
          <button class="mobile-menu-item" data-view="messages">💬 Messages</button>
          <button class="mobile-menu-item" data-view="profile">👤 Profile</button>
          <button class="mobile-menu-item" data-view="about">ℹ️ About Us</button>
        `;
      }
      
      if (mobileMenuAuth) {
        mobileMenuAuth.innerHTML = `
            <button class="btn-login-header" id="mobileLoginBtn">Log In</button>
            <button class="btn-signup-header" id="mobileSignupBtn">Sign Up Free</button>
        `;
      }
    }
    
    // Re-initialize hamburger menu after updating HTML to ensure event listeners work
    // Use setTimeout to avoid immediate re-initialization issues
    setTimeout(() => {
      initHamburgerMenu();
    }, 100);
  }
  
  // Handle sign out - COMPLETE and IMMEDIATE logout
  // Define and assign to window immediately
  window.handleSignOut = async function handleSignOut() {
    console.log('handleSignOut called - starting logout process');
    // IMMEDIATELY clear everything FIRST (don't wait for API)
    // Clear ALL localStorage
    localStorage.removeItem('hustl_token');
    localStorage.removeItem('hustl_user');
    localStorage.removeItem('hustl_state_v3');
    
    // Clear ALL sessionStorage
    sessionStorage.removeItem('hustl_token');
    sessionStorage.removeItem('hustl_user');
    
    // Clear cookies
    document.cookie.split(";").forEach((c) => {
      document.cookie = c
        .replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
    
    // Clear state
    state.currentUserId = null;
    state.users = [];
    saveState();
    
    // Clear any cached user data
    if (window.hustlAPI && window.hustlAPI.auth) {
      window.hustlAPI.auth.currentUser = null;
    }
    
    // Clear cached current user for messages
    window._cachedCurrentUser = null;
    
    // Force clear any cached API responses
    if (window.optimizedApi) {
      window.optimizedApi.invalidateCache();
    }
    
    // Close mobile menu if open
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    if (hamburgerBtn) hamburgerBtn.classList.remove('open');
    if (mobileMenu) mobileMenu.classList.remove('open');
    document.body.style.overflow = '';
    
    // Call API sign out (non-blocking - don't wait)
    window.hustlAPI.auth.signOut().catch(err => {
      console.warn("Backend logout call failed (non-critical):", err);
    });
    
    // IMMEDIATELY redirect to home and show login
    // Hide all views
    document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
    const homeView = document.getElementById("view-home");
    if (homeView) {
      homeView.style.display = "block";
      activeView = 'home';
    }
    
    // Show auth section immediately
    const authSection = document.getElementById("authSection");
    if (authSection) {
      authSection.style.display = 'block';
    }
    
    // Update UI immediately (don't wait)
    updateHeaderAuth().then(() => {
      // Open login modal after UI updates
      setTimeout(() => {
        if (window.openAuthModal && typeof window.openAuthModal === 'function') {
          window.openAuthModal('login');
        }
      }, 100);
    });
    
    // Update nav tabs
    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.classList.toggle("active", tab.dataset.view === 'home');
    });
    
    // Update mobile bottom nav
    if (window.mobileCore && window.mobileCore.bottomNav) {
      window.mobileCore.bottomNav.updateActiveTab('home');
    }
    
    showToast("✅ Signed out successfully");
    
    // Use replaceState to prevent back button from going to logged-in state
    if (window.history && window.history.replaceState) {
      window.history.replaceState(null, '', window.location.pathname);
    }
    
    // Render all (non-blocking)
    renderAll().catch(err => console.error("Render error:", err));
  };
  
  // Function is already assigned above, just log confirmation
  console.log('✅ handleSignOut function assigned to window.handleSignOut');
  
  // Profile Tabs
  function initProfileTabs() {
    const tabs = document.querySelectorAll('.profile-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active from all tabs
        tabs.forEach(t => t.classList.remove('active'));
        // Add active to clicked tab
        tab.classList.add('active');
        
        // Hide all tab content
        document.querySelectorAll('.profile-tab-content').forEach(content => {
          content.style.display = 'none';
          content.classList.remove('active');
        });
        
        // Show selected tab content
        const tabName = tab.dataset.tab;
        const tabContent = document.getElementById('profileTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
        if (tabContent) {
          tabContent.style.display = 'block';
          tabContent.classList.add('active');
        }
      });
    });
    
    // Initialize notification preferences
    const prefEmailNotif = document.getElementById('prefEmailNotif');
    const prefJobAlerts = document.getElementById('prefJobAlerts');
    
    // Load saved preferences from localStorage
    if (prefEmailNotif) {
      const savedEmailNotif = localStorage.getItem('prefEmailNotif');
      prefEmailNotif.checked = savedEmailNotif !== 'false'; // Default to true if not set
      
      prefEmailNotif.addEventListener('change', (e) => {
        localStorage.setItem('prefEmailNotif', e.target.checked.toString());
        showToast(e.target.checked ? '✅ Email notifications enabled' : '🔕 Email notifications disabled', 2000);
      });
    }
    
    if (prefJobAlerts) {
      const savedJobAlerts = localStorage.getItem('prefJobAlerts');
      prefJobAlerts.checked = savedJobAlerts !== 'false'; // Default to true if not set
      
      prefJobAlerts.addEventListener('change', (e) => {
        localStorage.setItem('prefJobAlerts', e.target.checked.toString());
        showToast(e.target.checked ? '✅ Job alerts enabled' : '🔕 Job alerts disabled', 2000);
      });
    }
  }

  // Functions are already exposed globally at their definition points:
  // - setView: line 3538-3539
  // - openAuthModal: line 10246-10247
  // - closeAuthModal: line 10237-10238
  // - handleSignOut: line 10363-10364
  // goToStripeSetup, startExploring, closeWelcomeModal are already defined globally above

  // Prevent back button from showing logged-in content
  window.addEventListener('popstate', async (event) => {
    // Check if user is actually logged in
    const user = await window.hustlAPI.auth.getCurrentUser();
    if (!user) {
      // Not logged in - redirect to home
      if (window.setView && typeof window.setView === 'function') {
        window.setView('home');
      }
      // Show login if on protected view
      const protectedViews = ['profile', 'messages', 'post'];
      if (protectedViews.includes(activeView)) {
        setTimeout(() => {
          if (window.openAuthModal && typeof window.openAuthModal === 'function') {
            window.openAuthModal('login');
          }
        }, 300);
      }
    }
  });

  // Boot - initialize when DOM is ready
  // Show onboarding modal for first-time users
  function showOnboardingModal() {
    // Check if onboarding has been dismissed
    const onboardingDismissed = localStorage.getItem('onboardingDismissed');
    if (onboardingDismissed === 'true') {
      return; // Already dismissed, don't show
    }
    
    // Check if modal already exists
    if (document.getElementById('onboardingModal')) {
      return;
    }
    
    const user = getCurrentUser();
    const isHustler = user && (user.role === 'HUSTLER' || user.role === 'hustler');
    const isCustomer = user && (user.role === 'CUSTOMER' || user.role === 'customer');
    
    const modal = document.createElement('div');
    modal.id = 'onboardingModal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 1rem;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
      <div style="background: white; border-radius: 20px; padding: 2rem; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.5); position: relative; animation: slideUp 0.4s ease;">
        <!-- Close button -->
        <button id="onboardingCloseBtn" style="position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; border: none; background: #f3f4f6; color: var(--text-main); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">×</button>
        
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 2rem;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">👋</div>
          <h1 style="font-size: 2rem; font-weight: 700; color: var(--text-main); margin: 0 0 0.5rem 0;">Welcome to Hustl!</h1>
          <p style="font-size: 1.1rem; color: var(--text-muted); margin: 0;">Let's get you started</p>
        </div>
        
        <!-- General Info -->
        <div style="margin-bottom: 2rem;">
          <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-main); margin: 0 0 1rem 0;">How Hustl Works</h2>
          <div style="background: #f8fafc; border-radius: 12px; padding: 1.25rem; border-left: 4px solid var(--primary);">
            <p style="margin: 0 0 0.75rem 0; color: var(--text-main); line-height: 1.6;">
              Hustl connects customers with local hustlers for real jobs. Whether you need help with moving, yard work, or odd jobs, or you're looking to make extra money, Hustl makes it simple.
            </p>
            <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-weight: 600;">
              💡 Keep communication and payments in the app for your protection.
            </p>
          </div>
        </div>
        
        ${isHustler ? `
        <!-- For Hustlers -->
        <div style="margin-bottom: 2rem;">
          <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-main); margin: 0 0 1rem 0;">For Hustlers 💪</h2>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="background: #f0fdf4; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #10b981;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #065f46;">✅ Complete Stripe Setup</p>
              <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">You must complete Stripe setup before getting paid. Find this in your Profile settings.</p>
            </div>
            <div style="background: #f0fdf4; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #10b981;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #065f46;">⭐ Build a Strong Profile</p>
              <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">A strong profile with a photo, bio, and tools helps you get more jobs.</p>
            </div>
            <div style="background: #f0fdf4; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #10b981;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #065f46;">📝 Reviews Matter</p>
              <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">Good work leads to more opportunities. Complete jobs well to build your reputation.</p>
            </div>
            <div style="background: #fef3c7; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #f59e0b;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #92400e;">💰 Pricing Tips</p>
              <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">When applying, you may suggest a different price, but clearly explain why. Better explanations increase your chances of being accepted.</p>
            </div>
          </div>
        </div>
        ` : ''}
        
        ${isCustomer ? `
        <!-- For Customers -->
        <div style="margin-bottom: 2rem;">
          <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-main); margin: 0 0 1rem 0;">For Customers 🏠</h2>
          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div style="background: #eff6ff; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #2563eb;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #1e40af;">📝 Clear Job Descriptions</p>
              <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">Clear job descriptions lead to better applicants. Be specific about what you need.</p>
            </div>
            <div style="background: #eff6ff; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #2563eb;">
              <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #1e40af;">💰 Pricing is Locked</p>
              <p style="margin: 0; color: var(--text-main); line-height: 1.6; font-size: 0.95rem;">Prices are agreed on before the job starts. Once a job starts, price and scope are locked.</p>
            </div>
          </div>
        </div>
        ` : ''}
        
        <!-- Navigation Overview -->
        <div style="margin-bottom: 2rem;">
          <h2 style="font-size: 1.25rem; font-weight: 600; color: var(--text-main); margin: 0 0 1rem 0;">📍 Where Things Live</h2>
          <div style="display: grid; gap: 0.75rem;">
            <div style="background: #f9fafb; border-radius: 10px; padding: 1rem; border: 1px solid #e5e7eb;">
              <p style="margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main);">🔍 Browse Jobs</p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Where hustlers find and apply to jobs</p>
            </div>
            <div style="background: #f9fafb; border-radius: 10px; padding: 1rem; border: 1px solid #e5e7eb;">
              <p style="margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main);">📝 Post a Job</p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Where customers create a new job</p>
            </div>
            <div style="background: #f9fafb; border-radius: 10px; padding: 1rem; border: 1px solid #e5e7eb;">
              <p style="margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main);">📋 Manage Jobs</p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Track posted, applied, active, and completed jobs</p>
            </div>
            <div style="background: #f9fafb; border-radius: 10px; padding: 1rem; border: 1px solid #e5e7eb;">
              <p style="margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main);">💬 Messages</p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Where communication happens after applying or acceptance</p>
            </div>
            <div style="background: #f9fafb; border-radius: 10px; padding: 1rem; border: 1px solid #e5e7eb;">
              <p style="margin: 0 0 0.25rem 0; font-weight: 600; color: var(--text-main);">👤 Profile</p>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Edit your profile, connect Stripe (hustlers), and view reviews and earnings</p>
            </div>
          </div>
        </div>
        
        <!-- Got it button -->
        <button id="onboardingGotItBtn" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
          Got it! Let's go 🚀
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    
    // Add animations if not already added
    if (!document.getElementById('onboardingAnimations')) {
      const style = document.createElement('style');
      style.id = 'onboardingAnimations';
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes slideUp {
          from {
            transform: translateY(30px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    // Close button handler
    const closeBtn = modal.querySelector('#onboardingCloseBtn');
    const gotItBtn = modal.querySelector('#onboardingGotItBtn');
    
    const dismissOnboarding = () => {
      localStorage.setItem('onboardingDismissed', 'true');
      if (modal.parentNode) {
        document.body.removeChild(modal);
      }
      document.body.style.overflow = '';
    };
    
    closeBtn.addEventListener('click', dismissOnboarding);
    gotItBtn.addEventListener('click', dismissOnboarding);
    
    // Close on background click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        dismissOnboarding();
      }
    });
  }

  function initializeApp() {
    try {
      loadState();
      initAgeGate();
      initNav();
      initAuthCard();
      initHamburgerMenu();
      initJobsForm();
      initConversationInput();
      initConversationTabs();
      initChatBackButton();
      initFeedback();
      initFooterLinks();
      checkAgeGate();
      handleStripeReturn();
      checkAutoCompleteJobs();
      setInterval(checkAutoCompleteJobs, 60 * 1000);
      
      // Initialize auth state and render
      (async () => {
        try {
          // Check auth on page load
          const user = await window.hustlAPI.auth.getCurrentUser();
          
          // If on a protected view and not authenticated, redirect to home
          const protectedViews = ['profile', 'messages', 'post'];
          const currentView = activeView || 'home';
          
          if (protectedViews.includes(currentView) && !user) {
            // Not authenticated on protected view - redirect to home
            if (window.setView && typeof window.setView === 'function') {
              window.setView('home');
            }
            // Show login modal
            setTimeout(() => {
              if (window.openAuthModal && typeof window.openAuthModal === 'function') {
                window.openAuthModal('login');
              }
            }, 500);
          }
          
          await updateHeaderAuth();
          await renderAll();
          
          // Show onboarding modal for authenticated users (after a short delay)
          if (user) {
            setTimeout(() => {
              showOnboardingModal();
            }, 1000);
          }
        } catch (error) {
          console.error('Error initializing auth state:', error);
          // If auth check fails, assume not logged in
          await updateHeaderAuth();
          await renderAll();
        }
      })();
      
      // Start token auto-refresh for persistent login
      if (window.appCore && window.appCore.tokenManager) {
        window.appCore.tokenManager.startAutoRefresh();
      }
    } catch (error) {
      console.error('Error initializing app:', error);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    // Global event delegation for profile buttons - ensures all profile buttons work
    document.addEventListener('click', async (e) => {
      const profileBtn = e.target.closest('.viewCustomerProfileBtn, .viewHustlerProfileBtn, .viewApplicantProfileBtn, .viewCustomerProfile, .viewHustlerProfile, .viewApplicantProfile');
      if (profileBtn && profileBtn.dataset.userId) {
        e.stopPropagation();
        if (typeof window.showHustlerProfilePopup === 'function') {
          await window.showHustlerProfilePopup(profileBtn.dataset.userId);
        }
      }
    });
    
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    // DOM is already ready
    initializeApp();
  }
  
  // Check for payment success/cancel in URL (run after initialization)
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    const tipSuccess = urlParams.get('tip_success');
    const tipCancelled = urlParams.get('tip_cancelled');
    const sessionId = urlParams.get('session_id');
    const offerId = urlParams.get('offerId');
    const jobId = urlParams.get('jobId');
    const resetToken = urlParams.get('token');
    
    // Check if this is a password reset link
    if (resetToken) {
      // Show password reset form
      showPasswordResetModal(resetToken);
      // Clean URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    } else if (tipSuccess) {
      // Tip payment completed
      if (typeof showToast === 'function') {
        showToast('💚 Thanks for tipping! Your tip has been sent to the hustler.');
      }
      
      // Clean URL
      const cleanUrl = window.location.pathname + (window.location.hash || '');
      window.history.replaceState({}, document.title, cleanUrl);
      
      // Update tip buttons immediately if we can find them
      const updateTipButtons = async () => {
        // Find all tip buttons and update them if tip was just completed
        document.querySelectorAll('.tipBtn').forEach(async (btn) => {
          const jobId = btn.dataset.jobId;
          if (jobId && sessionStorage.getItem(`tipPending_${jobId}`)) {
            // Fetch tip amount from payment data
            let tipAmount = 0;
            try {
              const token = localStorage.getItem('hustl_token');
              const paymentResponse = await fetch(`${API_BASE}/payments/job/${jobId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (paymentResponse.ok) {
                const payment = await paymentResponse.json();
                tipAmount = Number(payment?.tip || 0);
              }
            } catch (e) {
              console.error('Error fetching tip amount:', e);
            }
            
            // Replace tip button with "Thanks for tipping" message and view tip button
            const tipContainer = btn.parentElement;
            btn.remove();
            
            const thanksDiv = document.createElement('div');
            thanksDiv.style.cssText = 'flex: 1; min-width: 120px; padding: 0.75rem 1rem; font-size: 0.9rem; font-weight: 600; border: 2px solid #10b981; color: #10b981; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 0.5rem;';
            thanksDiv.innerHTML = `
              <span>💚 Thanks for tipping!</span>
              <button class="btn btn-ghost viewTipBtn" data-job-id="${jobId}" data-tip-amount="${tipAmount.toFixed(2)}" style="padding: 0.25rem 0.75rem; font-size: 0.85rem; font-weight: 600; color: #059669; background: transparent; border: 1px solid #10b981; border-radius: 6px; cursor: pointer; margin-left: 0.5rem;">View Tip ($${tipAmount.toFixed(2)})</button>
            `;
            
            // Add event listener for view tip button
            const viewTipBtn = thanksDiv.querySelector('.viewTipBtn');
            viewTipBtn?.addEventListener('click', (e) => {
              e.stopPropagation();
              showToast(`💚 You tipped $${tipAmount.toFixed(2)} for this job!`, 'success', 4000);
            });
            
            tipContainer.appendChild(thanksDiv);
            sessionStorage.removeItem(`tipPending_${jobId}`);
          }
        });
      };
      
      // Update buttons immediately
      updateTipButtons();
      
      // Refresh completed jobs if on manage-jobs view
      // Wait a bit for webhook to process, then refresh multiple times to ensure tip shows
      const refreshCompletedJobs = () => {
        const currentView = window.activeView || activeView;
        if (currentView === 'manage-jobs' || window.location.hash === '#manage-jobs') {
          // Switch to completed tab and refresh
          const completedTab = document.querySelector('[data-manage-tab="completed"]');
          if (completedTab && !completedTab.classList.contains('active')) {
            completedTab.click(); // Switch to completed tab
          }
          if (typeof loadCompletedJobs === 'function') {
            loadCompletedJobs(true); // Reload with reset
          }
        }
      };
      
      // Refresh immediately, then again after delays (webhook might take a moment)
      // More aggressive refresh to catch webhook processing
      setTimeout(() => {
        updateTipButtons();
        refreshCompletedJobs();
      }, 500);
      setTimeout(() => {
        updateTipButtons();
        refreshCompletedJobs();
      }, 2000);
      setTimeout(() => {
        updateTipButtons();
        refreshCompletedJobs();
      }, 5000);
      setTimeout(() => {
        updateTipButtons();
        refreshCompletedJobs();
      }, 10000); // Extra refresh after 10 seconds
      setTimeout(() => {
        updateTipButtons();
        refreshCompletedJobs();
      }, 20000); // Final refresh after 20 seconds
    } else if (tipCancelled) {
      // Tip payment cancelled
      if (typeof showToast === 'function') {
        showToast('Tip cancelled. You can add a tip anytime from the completed jobs tab.');
      }
      
      // Clean URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    } else if (paymentStatus === 'success' && sessionId) {
      // Payment completed - show success and refresh
      if (typeof showToast === 'function') {
        showToast('✅ Payment successful! Hustler accepted and job activated.');
      }
      
      // Clean URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      
      // Refresh job lists if on manage-jobs view
      setTimeout(() => {
        if (typeof activeView !== 'undefined' && activeView === 'manage-jobs') {
          if (typeof loadPostedJobs === 'function') loadPostedJobs();
          if (typeof loadActiveJobs === 'function') loadActiveJobs();
        }
        
        // Also refresh if we have jobId
        if (jobId && typeof showViewJobModal === 'function') {
          // Refresh the job modal if it's open
        }
      }, 1000);
      
      if (offerId) {
        console.log('Payment completed for offer:', offerId);
      }
    } else if (paymentStatus === 'cancelled') {
      // Payment cancelled
      if (typeof showToast === 'function') {
        showToast('Payment cancelled. You can try again when ready.');
      }
      
      // Clean URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  }, 1000);
  </script>
  
  <!-- Performance-optimized script loading -->
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css" />
  <script src="/app-core.js" defer></script>
  <script src="/mobile-core.js" defer></script>
</body>
</html>




