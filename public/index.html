
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  
  <!-- SEO: Primary Meta Tags -->
  <title>Hustl Jobs – Fast Local Help for Moving, Yard Work & More in Tennessee</title>
  <meta name="title" content="Hustl Jobs – Fast Local Help for Moving, Yard Work & More in Tennessee" />
  <meta name="description" content="Find local help fast for moving, mulching, power washing, junk removal, yard work, and more. Hire or get hired instantly anywhere in Tennessee through Hustl. Serving Knoxville, Nashville, Chattanooga, Memphis and all of TN." />
  <meta name="keywords" content="hustl, hustl jobs, hustl tennessee, hustl moving, moving help tennessee, yard work tennessee, dump runs near me, hire help knoxville, local jobs tennessee, hustler jobs knoxville, moving knoxville, power washing tennessee, junk removal TN, mulching service, handyman tennessee, local help near me, gig jobs tennessee, same day help, moving help nashville, yard work knoxville" />
  <meta name="author" content="Hustl Jobs" />
  <meta name="robots" content="index, follow" />
  <meta name="googlebot" content="index, follow" />
  <link rel="canonical" href="https://hustljobs.com/" />
  
  <!-- SEO: Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://hustljobs.com/" />
  <meta property="og:title" content="Hustl Jobs – Fast Local Help for Moving, Yard Work & More in Tennessee" />
  <meta property="og:description" content="Find local help fast for moving, mulching, power washing, junk removal, yard work, and more. Hire or get hired instantly anywhere in Tennessee." />
  <meta property="og:image" content="https://hustljobs.com/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="Hustl Jobs" />
  <meta property="og:locale" content="en_US" />
  
  <!-- SEO: Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="https://hustljobs.com/" />
  <meta name="twitter:title" content="Hustl Jobs – Fast Local Help in Tennessee" />
  <meta name="twitter:description" content="Find local help fast for moving, yard work, power washing & more. Hire or get hired instantly across Tennessee." />
  <meta name="twitter:image" content="https://hustljobs.com/og-image.png" />
  
  <!-- SEO: Favicon & App Icons -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  <!-- SEO: Geographic targeting -->
  <meta name="geo.region" content="US-TN" />
  <meta name="geo.placename" content="Tennessee" />
  
  <!-- Mobile App Experience -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Hustl" />
  <meta name="application-name" content="Hustl Jobs" />
  <meta name="theme-color" content="#2563eb" />
  
  <!-- Performance: Preconnect to external resources -->
  <link rel="preconnect" href="https://hustl-production.up.railway.app" crossorigin />
  <link rel="dns-prefetch" href="https://hustl-production.up.railway.app" />
  
  <!-- SEO: LocalBusiness Schema Markup -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": "Hustl Jobs",
    "description": "On-demand local help marketplace for moving, yard work, power washing, junk removal, and more across Tennessee.",
    "url": "https://hustljobs.com",
    "logo": "https://hustljobs.com/logo.png",
    "image": "https://hustljobs.com/og-image.png",
    "telephone": "",
    "address": {
      "@type": "PostalAddress",
      "addressRegion": "TN",
      "addressCountry": "US"
    },
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": "35.5175",
      "longitude": "-86.5804"
    },
    "areaServed": [
      {
        "@type": "State",
        "name": "Tennessee"
      },
      {
        "@type": "City",
        "name": "Knoxville"
      },
      {
        "@type": "City",
        "name": "Nashville"
      },
      {
        "@type": "City",
        "name": "Chattanooga"
      },
      {
        "@type": "City",
        "name": "Memphis"
      }
    ],
    "priceRange": "$$",
    "openingHoursSpecification": {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
      "opens": "00:00",
      "closes": "23:59"
    },
    "sameAs": []
  }
  </script>
  
  <!-- SEO: WebSite Schema for Sitelinks -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Hustl Jobs",
    "url": "https://hustljobs.com",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://hustljobs.com/?search={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  
  <!-- SEO: Organization Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Hustl Jobs",
    "url": "https://hustljobs.com",
    "logo": "https://hustljobs.com/logo.png",
    "description": "Tennessee's local help marketplace for moving, yard work, and more.",
    "foundingLocation": {
      "@type": "Place",
      "name": "Tennessee, USA"
    },
    "slogan": "Local help, real hustle"
  }
  </script>
  
  <!-- Mobile Optimizations CSS (load early for faster paint) -->
  <link rel="stylesheet" href="mobile-optimizations.css" />
  
  <!-- Preload critical scripts -->
  <link rel="modulepreload" href="app-core.js" />
  <link rel="modulepreload" href="mobile-core.js" />
  <style>
    :root {
      /* Clean Blue Light Theme */
      --bg: #f0f7ff;
      --bg-light: #ffffff;
      --card: rgba(255, 255, 255, 0.95);
      --card-solid: #ffffff;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.1);
      --primary-dark: #1d4ed8;
      --primary-glow: rgba(37, 99, 235, 0.3);
      --accent: #0ea5e9;
      --accent-soft: rgba(14, 165, 233, 0.1);
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --danger: #dc2626;
      --danger-soft: #fef2f2;
      --success: #059669;
      --success-soft: #ecfdf5;
      --warning: #d97706;
      --warning-soft: #fffbeb;
      --radius: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 16px rgba(37, 99, 235, 0.1);
      --shadow-lg: 0 12px 40px rgba(37, 99, 235, 0.15);
      --shadow-glow: 0 0 60px var(--primary-glow);
      --glass: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(37, 99, 235, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(180deg, #eff6ff 0%, #f0f9ff 50%, #f8fafc 100%);
      color: var(--text-main);
      min-height: auto;
      height: auto;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse 100% 60% at 50% 0%, rgba(37, 99, 235, 0.08) 0%, transparent 60%);
      pointer-events: none;
      z-index: -1;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      cursor: pointer;
      font-family: inherit;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: auto;
      justify-content: flex-start;
    }
    
    /* When logged in, hide auth section completely */
    body.logged-in #authSection {
      display: none !important;
    }

    /* CLEAN MODERN HEADER */
    header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(37, 99, 235, 0.1);
      padding: 0.875rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      margin-bottom: 0 !important;
    }
    
    /* Remove any spacing below header */
    header + * {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-mark {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 1.2rem;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.5), 0 0 30px rgba(14, 165, 233, 0.3);
      flex-shrink: 0;
    }

    .logo-text-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .logo-text-main {
      font-weight: 800;
      font-size: 1.2rem;
      letter-spacing: 0.02em;
      color: var(--text-main);
      white-space: nowrap;
    }

    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Desktop nav tabs */
    .nav-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      font-size: 0.85rem;
      margin-top: 0.5rem;
    }

    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .nav-tab:hover {
      color: var(--text-main);
      background: var(--primary-soft);
    }

    .nav-tab.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 2px 10px var(--primary-glow);
    }

    /* Header auth buttons */
    .header-auth {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn-login-header {
      padding: 0.625rem 1.25rem;
      border: 1.5px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-main);
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-login-header:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    .btn-signup-header {
      padding: 0.625rem 1.5rem;
      border: none;
      background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      color: #fff;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4), 0 0 20px rgba(14, 165, 233, 0.2);
    }

    .btn-signup-header:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5), 0 0 30px rgba(14, 165, 233, 0.3);
    }

    /* HAMBURGER MENU */
    .hamburger-btn {
      display: none;
      width: 44px;
      height: 44px;
      border: 1.5px solid var(--border);
      background: #fff;
      border-radius: 8px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 101;
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }
    
    .hamburger-btn:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
    }

    .hamburger-btn span {
      display: block;
      width: 18px;
      height: 2px;
      background: var(--text-main);
      border-radius: 1px;
      transition: all 0.3s ease;
      opacity: 1;
    }

    .hamburger-btn.open span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger-btn.open span:nth-child(2) {
      opacity: 0;
    }

    .hamburger-btn.open span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    /* Mobile menu overlay */
    .mobile-menu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ffffff;
      z-index: 100;
      padding: 70px 1rem 2rem;
      flex-direction: column;
      gap: 0.25rem;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      overscroll-behavior: contain; /* Prevent scroll chaining */
    }
    
    /* Prevent body scroll when menu is open */
    body.mobile-menu-open {
      overflow: hidden !important;
      position: fixed;
      width: 100%;
    }

    .mobile-menu.open {
      display: flex;
    }

    .mobile-menu-item {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      text-align: left;
      border-radius: var(--radius);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mobile-menu-item:hover,
    .mobile-menu-item.active {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .mobile-menu .header-auth {
      margin-top: auto;
      flex-direction: column;
      width: 100%;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .mobile-menu .btn-login-header,
    .mobile-menu .btn-signup-header {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      z-index: 1;
      position: relative;
      opacity: 1 !important;
      visibility: visible !important;
      display: block !important;
    }
    
    .mobile-menu .btn-signup-header {
      background: var(--primary) !important;
      color: white !important;
      font-weight: 600;
    }
    
    /* Sign Out button specific styling */
    .mobile-menu .btn-signup-header[onclick*="handleSignOut"],
    .mobile-menu .btn-signup-header[onclick*="SignOut"] {
      background: #fee2e2 !important;
      color: #dc2626 !important;
      border: 2px solid #fca5a5 !important;
      font-weight: 600;
    }
    
    .mobile-menu .btn-login-header {
      background: white !important;
      color: var(--primary) !important;
      border: 2px solid var(--primary) !important;
      font-weight: 600;
    }

    /* Hide old auth pill */
    .auth-pill {
      display: none;
    }

    main {
      flex: 0 1 auto;
      padding: 0;
      padding-bottom: 1rem;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* Post job view - ensure form is visible */
    #view-post #jobFormCard {
      margin-top: 0 !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: auto !important;
      height: auto !important;
    }
    
    /* Profile view specific - no extra top spacing */
    #view-profile {
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    #view-profile > *:first-child {
      margin-top: 0 !important;
    }
    
    /* Remove all top margins from profile elements */
    #view-profile .profile-basic-info {
      margin-top: 0 !important;
    }
    
    #view-profile .profile-quick-stats {
      margin-top: 0 !important;
    }
    
    #view-profile .profile-tabs {
      margin-top: 0 !important;
    }
    
    /* Post job view - start at top */
    #view-post {
      padding-top: 0 !important;
      margin-top: 0 !important;
      padding: 1rem;
      padding-top: 0 !important;
      padding-bottom: 2rem !important;
      margin-bottom: 0 !important;
      display: none; /* Default hidden */
    }
    
    /* When post view is active, make it visible */
    #view-post[style*="display: block"],
    #view-post[style*="display:block"],
    body.viewing-post #view-post {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    #view-post > *:first-child {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    #view-post .card {
      margin-top: 0 !important;
      margin-bottom: 0 !important;
    }
    
    /* Main content starts at top - no padding */
    body.viewing-post main {
      padding-top: 0 !important;
    }
    
    /* Add padding inside the view sections instead */
    #view-home,
    #view-jobs,
    #view-profile,
    #view-messages,
    #view-post,
    #view-owner {
      padding: 1rem;
      padding-top: 0 !important;
      margin-top: 0 !important;
      margin-bottom: 0 !important;
    }
    
    /* Ensure all views start at the very top with no spacing */
    [id^="view-"] {
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    /* Remove any spacing from first child of views */
    [id^="view-"] > *:first-child {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* Hide authSection properly when logged in or not on home */
    body.logged-in #authSection,
    #authSection[style*="display: none"] {
      display: none !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      overflow: hidden !important;
      visibility: hidden !important;
    }
    
    /* Ensure main doesn't have extra padding when auth is hidden */
    body.logged-in main > #authSection {
      display: none !important;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 1rem;
    }

    /* CLEAN CARDS */
    .card {
      background: var(--card);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius);
      border: 1px solid var(--glass-border);
      padding: 1.5rem;
      box-shadow: var(--shadow-md);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: rgba(37, 99, 235, 0.25);
    }

    /* Mobile responsive for hamburger */
    @media (max-width: 768px) {
      .nav-tabs {
        display: none !important;
      }

      .header-auth.desktop-only {
        display: none !important;
      }

      .hamburger-btn {
        display: flex !important;
      }
    }

    /* Floating animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    /* Auth Modal Popup */
    .auth-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .auth-modal-overlay.open {
      display: flex;
    }

    .auth-modal {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      padding: 2.5rem;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Checkbox styling */
    .checkbox-field {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .checkbox-field input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .checkbox-field label {
      font-size: 0.875rem;
      color: var(--text-muted);
      cursor: pointer;
      line-height: 1.4;
    }

    .checkbox-field a {
      color: var(--primary);
      text-decoration: underline;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 8px;
      padding: 0.35rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      border: none;
      color: var(--text-muted);
      background: var(--border-light);
    }

    .badge.hot {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #dc2626;
    }

    .badge.status-open {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      color: #059669;
    }

    .badge.status-assigned {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--primary);
    }

    .badge.status-completed {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      color: #7c3aed;
    }
    
    .badge.status-in-progress {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: #d97706;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .hero-heading {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #0ea5e9 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .hero-sub {
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .hero-cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      justify-content: center;
    }

    .btn {
      border-radius: 12px;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(37, 99, 235, 0.4), 0 0 20px rgba(14, 165, 233, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5), 0 0 40px rgba(14, 165, 233, 0.3);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border);
      color: var(--text-main);
      backdrop-filter: blur(10px);
    }
    
    .btn-ghost:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
      color: var(--primary);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.35);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
    }

    .step-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .step-card {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.8);
      padding: 1.25rem;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      font-size: 0.875rem;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .step-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .step-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .step-card:hover::before {
      opacity: 1;
    }

    .step-title {
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: var(--primary);
    }

    .step-emoji {
      display: block;
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .pill {
      border-radius: 20px;
      padding: 0.4rem 0.875rem;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.6);
      transition: all 0.2s ease;
    }
    
    .pill:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--primary-soft);
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .field {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-main);
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1.5px solid var(--border);
      padding: 0.875rem 1rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: #fff;
      color: var(--text-main);
      transition: all 0.2s ease;
    }

    input::placeholder,
    textarea::placeholder {
      color: var(--text-muted);
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
      background: #fff;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    select option {
      background: #fff;
      color: var(--text-main);
    }

    .field-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }

    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    /* Only add scrollbar when there's content - use class instead of :has() for better compatibility */
    .jobs-list.has-content {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    .job-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      gap: 0.25rem;
    }

    .job-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .job-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.25rem;
    }

    .job-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .job-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .small-btn {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
    }

    .small-btn.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease;
      pointer-events: auto !important; /* Ensure overlay is clickable */
    }
    

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg);
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
      }
      
      .modal-content {
        max-width: 100%;
        max-height: 95vh;
        border-radius: 16px 16px 0 0;
        animation: slideUpMobile 0.3s ease;
      }
      
      @keyframes slideUpMobile {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Smooth page transitions */
    [id^="view-"] {
      animation: fadeIn 0.2s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Better input focus for mobile */
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      transform: scale(1.01);
      transition: all 0.2s;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text);
      z-index: 10;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #fff;
      transform: scale(1.1);
    }

    .job-detail {
      margin-top: 0.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.75rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }
/* High-contrast styling just for the job detail panel */
.job-detail-contrast {
  background: #111827;           /* light dark slate */
  color: #e5e7eb;                /* light text */
  border-color: #0b1220;
  box-shadow: 0 16px 40px rgba(0,0,0,0.35);
}

/* labels & muted text inside the dark panel */
.job-detail-contrast .detail-label { 
  color: #93c5fd;                /* soft blue for labels */
}

.job-detail-contrast .muted {
  color: #cbd5e1;                /* lighter muted */
}

/* buttons inside the dark panel */
.job-detail-contrast .small-btn.outline {
  border-color: #334155;
  color: #e5e7eb;
  background: transparent;
}
.job-detail-contrast .small-btn {
  background: #1f2937;           /* subtle dark chip */
  color: #e5e7eb;
}

/* links inside the dark panel */
.job-detail-contrast .linkish {
  color: #93c5fd;
}

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .detail-value {
      font-weight: 500;
    }

    .chat-box {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      margin-top: 0.5rem;
      background: #fff;
    }

    .chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .chat-msg {
      font-size: 0.9rem;
      padding: 0.6rem 0.85rem;
      border-radius: 18px;
      max-width: 75%;
      margin-bottom: 0.25rem;
      word-wrap: break-word;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .chat-msg.me {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
      margin-left: auto;
    }
    
    .chat-msg.them {
      align-self: flex-start;
      background: #f0f0f0;
      color: var(--text-main);
      border-bottom-left-radius: 4px;
      margin-right: auto;
    }
    
    .chat-msg-wrapper {
      display: flex;
      flex-direction: column;
      margin-bottom: 0.5rem;
      width: 100%;
    }
    
    .chat-msg-wrapper.me {
      align-items: flex-end;
    }
    
    .chat-msg-wrapper.them {
      align-items: flex-start;
    }
    
    .chat-msg-timestamp {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
      padding: 0 0.5rem;
    }
    
    /* Modern Messages Layout */
    .messages-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
      height: calc(100vh - 150px);
      max-height: 700px;
    }
    
    .conversations-sidebar {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .conversations-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #eff6ff 0%, white 100%);
    }
    
    .unread-badge {
      background: #ef4444;
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      min-width: 20px;
      text-align: center;
    }
    
    .conversations-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    
    .conversation-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .conversation-item:hover {
      background: #f1f5f9;
    }
    
    .conversation-item.active {
      background: var(--primary-soft);
      border-color: var(--primary);
    }
    
    .conversation-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    
    .conversation-info {
      flex: 1;
      min-width: 0;
    }
    
    .conversation-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .conversation-preview {
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-area {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #eff6ff 0%, white 100%);
    }
    
    .chat-messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .chat-input-area {
      padding: 1rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.75rem;
      background: #f8fafc;
    }
    
    .chat-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1.5px solid var(--border);
      border-radius: 999px;
      font-size: 0.95rem;
      background: white;
      transition: all 0.2s;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .chat-send-btn {
      padding: 0.75rem 1.25rem;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    @media (max-width: 768px) {
      .messages-layout {
        grid-template-columns: 1fr;
        height: auto;
        max-height: none;
      }
      
      .conversations-sidebar {
        max-height: 250px;
      }
      
      .chat-area {
        min-height: 400px;
      }
    }

    .chat-msg.them {
      align-self: flex-start;
      background: #e5e7eb;
      color: var(--text-main);
    }

    .chat-meta {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.4rem;
    }

    .chat-input-row input {
      flex: 1;
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.5rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-weight: 600;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-muted);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    /* Enhanced Profile Page */
    .profile-hero-card {
      background: linear-gradient(135deg, #2563eb 0%, #7c3aed 50%, #db2777 100%);
      border-radius: 20px;
      padding: 1rem 1.25rem;
      color: white;
      box-shadow: 0 8px 32px rgba(37, 99, 235, 0.35);
      position: relative;
      overflow: hidden;
      margin-bottom: 0.75rem;
      min-height: auto;
    }
    
    /* Hide empty profile hero card */
    .profile-hero-card:empty {
      display: none !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    .profile-hero-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
      pointer-events: none;
    }
    
    .profile-hero-top {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }
    
    .profile-hero-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      font-weight: 700;
      border: 3px solid rgba(255,255,255,0.4);
      overflow: hidden;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .profile-hero-avatar:hover {
      transform: scale(1.05);
    }
    
    .profile-hero-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-camera-icon {
      position: absolute;
      bottom: -2px;
      right: -2px;
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .profile-hero-info {
      flex: 1;
    }
    
    .profile-hero-name {
      font-size: 1.4rem;
      font-weight: 800;
      margin-bottom: 0.2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .profile-hero-email {
      font-size: 0.85rem;
      opacity: 0.85;
      margin-bottom: 0.35rem;
    }
    
    .profile-hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      background: rgba(255,255,255,0.2);
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    
    .profile-hero-location {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    /* Quick Stats Bar */
    .profile-quick-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin: 0 0 0.75rem 0;
    }
    
    /* Hide empty quick stats */
    .profile-quick-stats:empty {
      display: none !important;
      height: 0 !important;
      margin: 0 !important;
    }
    
    .quick-stat-card {
      background: white;
      border-radius: 12px;
      padding: 0.75rem;
      text-align: center;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .quick-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .quick-stat-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    
    .quick-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-main);
    }
    
    .quick-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    /* Profile Tabs */
    .profile-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.4rem;
    }
    
    .profile-tab {
      padding: 0.75rem 1.25rem;
      background: transparent;
      border: none;
      border-radius: 10px 10px 0 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .profile-tab:hover {
      background: var(--bg-light);
      color: var(--text-main);
    }
    
    .profile-tab.active {
      background: var(--primary-soft);
      color: var(--primary);
      border-bottom: 3px solid var(--primary);
      margin-bottom: -2px;
    }
    
    .profile-tab-content {
      display: none;
    }
    
    .profile-tab-content.active {
      display: block;
    }
    
    .profile-section-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    
    .profile-settings-card {
      border: 1px solid var(--border);
    }
    
    /* Preferences */
    .preference-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .preference-item:last-child {
      border-bottom: none;
    }
    
    .preference-label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-main);
    }
    
    .preference-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.3s;
      border-radius: 28px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--primary);
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    @media (max-width: 768px) {
      .profile-quick-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .profile-section-grid {
        grid-template-columns: 1fr;
      }
      
      .profile-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .profile-tab {
        white-space: nowrap;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
      }
      
      .profile-hero-card {
        padding: 0.875rem 1rem;
        margin-bottom: 0.5rem;
      }
      
      .profile-hero-avatar {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        border: 2px solid rgba(255,255,255,0.4);
      }
      
      .profile-hero-name {
        font-size: 1.2rem;
      }
      
      .profile-hero-email {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
      }
      
      .profile-hero-badge {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
      }
      
      .profile-hero-location {
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
    }

   .linkish {
  color: var(--primary);
  font-size: 0.75rem;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
  text-decoration-thickness: 1.5px;
  font-weight: 600;
}
.linkish:hover {
  text-decoration-thickness: 2px;
  color: var(--primary-dark);
}

    .job-status-group {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-status-group span {
      margin-right: 0.35rem;
      cursor: pointer;
    }

    .job-status-group span.active {
      color: var(--primary);
      font-weight: 600;
    }

    .feedback-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .about-text {
      font-size: 0.8rem;
      color: var(--text-main);
      line-height: 1.45;
      white-space: pre-line;
    }

    .legal-subtitle {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.6rem;
    }

    .legal-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    footer {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      font-size: 0.65rem;
      background: #000000;
      color: #ffffff;
    }
    
    footer .footer-links span {
      color: #ffffff;
    }

    .footer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    .footer-links span {
      cursor: pointer;
    }

    .footer-links a {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .footer-links a:hover {
      text-decoration: underline;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: #111827;
      color: #f9fafb;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-size: 0.75rem;
      z-index: 50;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .age-gate-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.84);
      display: none; /* Hidden by default - age gate disabled */
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .age-gate-card {
      background: #ffffff;
      padding: 1.2rem;
      border-radius: 14px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }

    .age-gate-card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    .age-gate-card p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.7rem;
    }

    .age-gate-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.3rem;
    }

@media (max-width: 800px) {
      header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .jobs-list {
        max-height: none; /* let the page scroll instead of tiny inner scroll */
      }
    }
    
    /* ========== COMPREHENSIVE MOBILE RESPONSIVE FIXES ========== */
    
    /* Phone (up to 480px) */
    @media (max-width: 480px) {
      main {
        padding: 0 0.75rem 0.75rem 0.75rem !important;
        padding-top: 0 !important;
      }
      
      .card {
        padding: 1rem !important;
        margin-bottom: 1rem !important;
      }
      
      .card-title {
        font-size: 1.1rem !important;
      }
      
      .btn {
        padding: 0.75rem 1rem !important;
        font-size: 0.9rem !important;
      }
      
      .field {
        margin-bottom: 1rem !important;
      }
      
      input, textarea, select {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 0.75rem !important;
      }
      
      .profile-hero-card {
        padding: 0.875rem 1rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .profile-hero-avatar {
        width: 60px !important;
        height: 60px !important;
        font-size: 1.5rem !important;
      }
      
      .profile-hero-name {
        font-size: 1.2rem !important;
      }
      
      .profile-quick-stats {
        gap: 0.5rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .quick-stat-card {
        padding: 0.6rem !important;
      }
      
      .profile-tabs {
        gap: 0.25rem !important;
        margin-bottom: 0.75rem !important;
        padding-bottom: 0.35rem !important;
      }
      
      .profile-tab {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.85rem !important;
      }
      
      /* Remove excessive white space */
      #view-profile {
        padding-top: 0 !important;
        margin-top: 0 !important;
      }
      
      #view-profile > *:first-child {
        margin-top: 0 !important;
      }
    }
    
    /* Tablet (481px to 768px) */
    @media (min-width: 481px) and (max-width: 768px) {
      main {
        padding: 0 1rem 1rem 1rem !important;
        padding-top: 0 !important;
      }
      
      .card {
        padding: 1.25rem !important;
      }
      
      .profile-hero-card {
        padding: 1rem 1.25rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .profile-hero-avatar {
        width: 65px !important;
        height: 65px !important;
        font-size: 1.6rem !important;
      }
      
      .profile-hero-name {
        font-size: 1.3rem !important;
      }
    }
    
    /* Desktop (769px and up) */
    @media (min-width: 769px) {
      main {
        padding: 0 1.5rem 1.5rem 1.5rem !important;
        padding-top: 0 !important;
      }
      
      .card {
        padding: 1.5rem !important;
      }
    }
    
    /* Fix white space on all devices */
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      height: auto !important;
      overflow-x: hidden;
      overflow-y: auto; /* Only show scrollbar when content exceeds viewport */
    }
    
    /* Prevent unnecessary scrolling - only scroll when there's actual content */
    body {
      overflow-y: auto;
      min-height: 100vh;
    }
    
    /* Remove scrolling from empty views */
    #view-home:empty,
    #view-jobs:empty,
    #view-post:empty,
    #view-messages:empty,
    #view-profile:empty {
      overflow: hidden;
      height: auto;
    }
    
    /* Make sure post view is visible when displayed */
    #view-post[style*="display: block"],
    #view-post[style*="display:block"] {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Remove duplicate spacing */
    #view-profile .profile-basic-info:empty,
    #view-profile .profile-quick-stats:empty {
      display: none !important;
      height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    /* Profile Basic Info Styles */
    .profile-basic-info {
      margin-bottom: 1.5rem;
    }
    
    .profile-basic-info .card {
      transition: all 0.2s ease;
    }
    
    .profile-basic-info input,
    .profile-basic-info textarea,
    .profile-basic-info select {
      transition: all 0.2s ease;
    }
    
    .profile-basic-info input:focus,
    .profile-basic-info textarea:focus,
    .profile-basic-info select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* ========== COMPREHENSIVE MOBILE FIXES - COMPACT VERSION ========== */
    
    /* Mobile First: Base styles for phones - COMPACT */
    @media (max-width: 767px) {
      /* Prevent horizontal scroll */
      * {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      html, body {
        overflow-x: hidden !important;
        width: 100% !important;
        position: relative;
      }
      
      /* Header fixes - COMPACT */
      header {
        padding: 0.5rem 0.75rem !important;
        flex-wrap: nowrap !important;
        gap: 0.5rem !important;
        min-height: auto !important;
      }
      
      .logo-mark {
        width: 32px !important;
        height: 32px !important;
        font-size: 0.9rem !important;
      }
      
      .logo-text-main {
        font-size: 0.9rem !important;
        line-height: 1.2 !important;
      }
      
      .logo-sub {
        font-size: 0.6rem !important;
        line-height: 1.2 !important;
      }
      
      .logo-text-container {
        gap: 0.25rem !important;
      }
      
      .hamburger-btn {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        min-height: 36px !important;
        padding: 0 !important;
      }
      
      .hamburger-btn span {
        width: 18px !important;
        height: 2px !important;
      }
      
      /* Main content - COMPACT */
      main {
        padding: 0 0.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* View sections - COMPACT */
      #view-home,
      #view-jobs,
      #view-post,
      #view-messages,
      #view-profile,
      #view-owner {
        padding: 0.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Cards - COMPACT */
      .card {
        padding: 0.75rem !important;
        margin-bottom: 0.75rem !important;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 10px !important;
      }
      
      /* Job cards - COMPACT */
      .job-card {
        padding: 0.75rem !important;
        width: 100% !important;
        max-width: 100% !important;
        margin-bottom: 0.5rem !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        gap: 0.25rem !important;
      }
      
      .job-card-top {
        flex-wrap: wrap !important;
        gap: 0.375rem !important;
        margin-bottom: 0.25rem !important;
      }
      
      .job-title {
        font-size: 0.85rem !important;
        line-height: 1.25 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        margin: 0 !important;
      }
      
      .job-meta {
        font-size: 0.75rem !important;
        line-height: 1.3 !important;
        word-wrap: break-word !important;
        margin: 0.125rem 0 !important;
      }
      
      .job-card-actions {
        margin-top: 0.375rem !important;
        gap: 0.375rem !important;
        flex-wrap: wrap !important;
      }
      
      /* Buttons - COMPACT but touch-friendly */
      button,
      .btn {
        min-height: 40px !important;
        min-width: 40px !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.85rem !important;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(37, 99, 235, 0.2);
        margin: 0 !important;
      }
      
      .small-btn {
        min-height: 32px !important;
        min-width: 32px !important;
        padding: 0.375rem 0.625rem !important;
        font-size: 0.75rem !important;
      }
      
      .btn-primary,
      .btn-signup-header {
        padding: 0.625rem 1rem !important;
        font-size: 0.9rem !important;
        font-weight: 600 !important;
      }
      
      .nav-tab {
        padding: 0.375rem 0.75rem !important;
        font-size: 0.8rem !important;
        min-height: 32px !important;
      }
      
      /* Inputs and forms - COMPACT */
      input,
      textarea,
      select {
        font-size: 16px !important; /* Prevents iOS zoom */
        padding: 0.625rem 0.75rem !important;
        min-height: 40px !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        -webkit-appearance: none;
        appearance: none;
        border-radius: 8px !important;
        margin: 0 !important;
      }
      
      textarea {
        min-height: 80px !important;
        resize: vertical;
        padding: 0.625rem !important;
      }
      
      .field {
        margin-bottom: 0.875rem !important;
        width: 100% !important;
      }
      
      .field label {
        font-size: 0.85rem !important;
        margin-bottom: 0.375rem !important;
      }
      
      .field-inline {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      /* Modals - COMPACT */
      .modal-overlay {
        padding: 0 !important;
        align-items: flex-end !important;
      }
      
      .modal-content {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 90vh !important;
        border-radius: 16px 16px 0 0 !important;
        padding: 1rem 0.75rem !important;
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      .modal-close {
        width: 36px !important;
        height: 36px !important;
        min-width: 36px !important;
        min-height: 36px !important;
        font-size: 1.1rem !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
      }
      
      /* Job form - COMPACT */
      #jobFormCard {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0.75rem !important;
        margin: 0 !important;
      }
      
      #jobFormCard .field {
        width: 100% !important;
        margin-bottom: 0.875rem !important;
      }
      
      #jobFormCard input,
      #jobFormCard textarea,
      #jobFormCard select {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Jobs list - COMPACT */
      .jobs-list {
        width: 100% !important;
        max-width: 100% !important;
        gap: 0.5rem !important;
      }
      
      /* Header auth buttons - COMPACT */
      .header-auth {
        gap: 0.375rem !important;
      }
      
      .btn-login-header,
      .btn-signup-header {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.8rem !important;
        min-height: 36px !important;
      }
      
      /* Profile elements - COMPACT */
      .profile-hero-card {
        padding: 0.75rem !important;
        flex-wrap: wrap !important;
        margin-bottom: 0.75rem !important;
      }
      
      .profile-hero-avatar {
        width: 50px !important;
        height: 50px !important;
        font-size: 1.25rem !important;
      }
      
      .profile-hero-name {
        font-size: 1.1rem !important;
      }
      
      .profile-quick-stats {
        flex-wrap: wrap !important;
        gap: 0.5rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .quick-stat-card {
        min-width: calc(50% - 0.25rem) !important;
        flex: 1 1 calc(50% - 0.25rem) !important;
        padding: 0.5rem !important;
      }
      
      /* Badges - COMPACT */
      .badge {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.75rem !important;
        min-height: 24px !important;
        line-height: 1.2 !important;
      }
      
      /* Text sizing - COMPACT */
      h1 {
        font-size: 1.25rem !important;
        line-height: 1.3 !important;
        margin: 0.5rem 0 !important;
      }
      
      h2 {
        font-size: 1.1rem !important;
        line-height: 1.3 !important;
        margin: 0.5rem 0 !important;
      }
      
      h3 {
        font-size: 1rem !important;
        line-height: 1.3 !important;
        margin: 0.5rem 0 !important;
      }
      
      .card-title {
        font-size: 1rem !important;
        line-height: 1.3 !important;
        margin: 0 0 0.5rem 0 !important;
      }
      
      p {
        font-size: 0.875rem !important;
        line-height: 1.4 !important;
        margin: 0.5rem 0 !important;
      }
      
      /* Prevent text overflow */
      * {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* Layout grid - COMPACT */
      .layout-grid {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      /* Fix any fixed widths */
      [style*="width:"] {
        max-width: 100% !important;
      }
      
      /* Tables - make scrollable */
      table {
        display: block !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        width: 100% !important;
        font-size: 0.8rem !important;
      }
      
      /* Images */
      img {
        max-width: 100% !important;
        height: auto !important;
      }
      
      /* Remove hover effects on mobile */
      .job-card:hover {
        transform: none !important;
      }
      
      .card:hover {
        transform: none !important;
      }
      
      /* Fix overlapping elements */
      .iconBadge {
        flex-shrink: 0 !important;
        margin-right: 0.5rem !important;
      }
      
      /* Fix header row spacing */
      .headerRow {
        gap: 0.5rem !important;
        align-items: flex-start !important;
      }
      
      /* Fix pay display in job cards */
      .job-card .pay {
        font-size: 0.9rem !important;
        white-space: normal !important;
        word-break: break-word !important;
        margin: 0 !important;
      }
      
      /* Fix title row in job cards */
      .titleRow {
        flex-wrap: wrap !important;
        gap: 0.375rem !important;
        align-items: flex-start !important;
      }
      
      /* Reduce spacing in text content */
      .textContent {
        min-width: 0 !important;
        flex: 1 !important;
      }
      
      /* Fix equipment badges */
      .equipmentRow {
        gap: 0.25rem !important;
        margin-top: 0.375rem !important;
      }
      
      /* Fix actions row */
      .job-card-actions .left,
      .job-card-actions .right {
        gap: 0.375rem !important;
      }
    }
    
    /* Small phones (up to 360px) - EXTRA COMPACT */
    @media (max-width: 360px) {
      header {
        padding: 0.375rem 0.5rem !important;
      }
      
      .logo-text-container {
        flex-direction: column !important;
        gap: 0.125rem !important;
      }
      
      .logo-sub {
        font-size: 0.55rem !important;
      }
      
      main {
        padding: 0 0.375rem !important;
      }
      
      #view-home,
      #view-jobs,
      #view-post,
      #view-messages,
      #view-profile {
        padding: 0.375rem !important;
      }
      
      .card {
        padding: 0.625rem !important;
        margin-bottom: 0.625rem !important;
      }
      
      .job-card {
        padding: 0.625rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      button,
      .btn {
        padding: 0.5rem 0.625rem !important;
        font-size: 0.8rem !important;
        min-height: 36px !important;
      }
      
      .small-btn {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.7rem !important;
        min-height: 28px !important;
      }
    }
    
    /* Landscape phones - COMPACT */
    @media (max-width: 767px) and (orientation: landscape) {
      .modal-content {
        max-height: 85vh !important;
        padding: 0.75rem !important;
      }
      
      header {
        padding: 0.375rem 0.75rem !important;
      }
      
      main {
        padding: 0 0.5rem !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-row">
        <div class="logo-mark">H</div>
        <div class="logo-text-container">
          <div class="logo-text-main">Hustl</div>
          <div class="logo-sub">Real Hustle. All of Tennessee.</div>
        </div>
      </div>
      
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="home">Home</button>
        <button class="nav-tab" data-view="jobs">Browse Jobs</button>
        <button class="nav-tab" data-view="post">Post a Job</button>
        <button class="nav-tab" data-view="manage-jobs" id="manageJobsTab">📋 Manage Jobs</button>
        <button class="nav-tab" data-view="messages">Messages</button>
        <button class="nav-tab" data-view="profile">Profile</button>
        <button class="nav-tab" data-view="owner" id="ownerTab" style="display:none;">Owner</button>
      </nav>
      
      <div class="header-auth desktop-only" id="headerAuthDesktop">
        <button class="btn-login-header" id="headerLoginBtn" onclick="if(typeof window.openAuthModal === 'function') window.openAuthModal('login')">Log In</button>
        <button class="btn-signup-header" id="headerSignupBtn" onclick="if(typeof window.openAuthModal === 'function') window.openAuthModal('create')">Sign Up Free</button>
      </div>
      
      <!-- Hamburger for mobile -->
      <button class="hamburger-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
      
      <!-- Old auth pill (hidden but kept for JS compatibility) -->
      <div class="auth-pill" id="authPill" style="display:none;">
        Not signed in
        <button id="openAuthButton">Sign in / Create account</button>
      </div>
    </header>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
      <!-- Menu items will be populated dynamically by updateHeaderAuth() -->
      <div class="header-auth" id="mobileMenuAuth">
        <!-- Auth buttons will be populated dynamically -->
      </div>
    </div>

    <main>
      <!-- AUTH CARD -->
      <section id="authSection" class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--card-glass) 100%); display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
          <div>
            <div class="card-title" id="authCardTitle" style="font-size: 1.3rem; margin-bottom: 0.25rem;">🚀 Join Hustl</div>
            <div style="color: var(--text-muted); font-size: 0.85rem;">Start earning or get help today</div>
          </div>
          <div id="authModeToggle">
            <span class="linkish" data-auth-mode="login" style="background: var(--bg-light); padding: 0.5rem 1rem; border-radius: 999px; font-weight: 500; color: var(--text-main); cursor: pointer; border: 1px solid var(--border);">Log in</span>
          </div>
        </div>
        
        <div id="authBodyCreate">
          <!-- Step indicator -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <div style="flex: 1; height: 4px; background: var(--primary); border-radius: 2px;"></div>
            <div style="flex: 1; height: 4px; background: var(--border); border-radius: 2px;"></div>
          </div>
          
          <div class="field">
            <label for="createName">Your Name</label>
            <input id="createName" type="text" placeholder="John Smith" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="createEmail">Email Address</label>
            <input id="createEmail" type="email" placeholder="john@example.com" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="createPassword">Create Password</label>
            <input id="createPassword" type="password" placeholder="At least 8 characters" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <div class="field" style="flex: 2;">
              <label for="createCity">Your City</label>
              <input id="createCity" type="text" placeholder="Knoxville" style="font-size: 1rem; padding: 0.75rem;" />
            </div>
            <div class="field" style="flex: 1;">
              <label for="createZip">ZIP</label>
              <input id="createZip" type="text" placeholder="37901" maxlength="5" pattern="[0-9]{5}" style="font-size: 1rem; padding: 0.75rem;" />
            </div>
          </div>
          <p style="font-size: 0.75rem; color: var(--text-muted); margin: -0.5rem 0 0.75rem 0;">
            📍 Your home base for "Near Me" - you can still see jobs anywhere in TN
          </p>
          
          <div class="field" style="display: none;">
            <label for="createRole">I want to</label>
            <select id="createRole" style="font-size: 1rem; padding: 0.75rem;">
              <option value="both" selected>Do both - Post jobs & earn money</option>
              <option value="customer">Only post jobs (Customer)</option>
              <option value="hustler">Only earn money (Hustler)</option>
            </select>
          </div>
          
          <!-- Hidden fields for backwards compatibility -->
          <div style="display: none;">
            <select id="createPayoutMethod"><option value="">Choose one</option></select>
            <input id="createPayoutHandle" type="text" />
            <input id="createPayoutName" type="text" />
          </div>
          
          <!-- Required Checkboxes -->
          <div style="margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 10px;">
            <div class="checkbox-field">
              <input type="checkbox" id="ageCheckbox" required />
              <label for="ageCheckbox">I confirm I am <strong>18 years or older</strong></label>
            </div>
            <div class="checkbox-field">
              <input type="checkbox" id="termsCheckbox" required />
              <label for="termsCheckbox">I agree to the <a href="/terms.html" target="_blank">Terms of Use</a> and <a href="/privacy.html" target="_blank">Privacy Policy</a></label>
            </div>
          </div>
          
          <button class="btn btn-primary" id="createAccountButton" style="width: 100%; padding: 0.9rem; font-size: 1rem;">
            Create Free Account
          </button>
          
          <p class="muted" style="text-align: center; margin-top: 0.75rem; font-size: 0.75rem;">
            <span style="color: var(--success);">✓ Free to join</span> • <span style="color: var(--success);">✓ No monthly fees</span> • <span style="color: var(--success);">✓ Cancel anytime</span>
          </p>
        </div>

        <div id="authBodyLogin" style="display:none;">
          <div style="text-align: center; margin-bottom: 1rem;">
            <span style="font-size: 2rem;">👋</span>
            <div style="font-weight: 600; margin-top: 0.25rem;">Welcome back!</div>
          </div>
          
          <div class="field">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="you@example.com" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="Your password" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <button class="btn btn-primary" id="loginButton" style="width: 100%; padding: 0.9rem; font-size: 1rem;">
            Log In →
          </button>
          
          <p class="muted" style="text-align: center; margin-top: 0.75rem; font-size: 0.8rem;">
            Don't have an account? <span class="linkish" data-auth-mode="create">Sign up free</span>
          </p>
        </div>
      </section>

      <!-- HOME VIEW - CLEAN HERO -->
      <section id="view-home">
        <!-- Hero Section -->
        <div style="text-align: center; padding: 2rem 1rem; max-width: 600px; margin: 0 auto;">
          
          <!-- Briefcase Icon -->
          <div style="width: 80px; height: 80px; margin: 1.5rem auto 1.25rem; background: var(--primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
          </div>
          
          <!-- Main Headline -->
          <h1 style="font-size: 2rem; font-weight: 700; line-height: 1.2; margin: 0 0 0.75rem; color: var(--text-main);">
            Need help or want to make extra cash?
          </h1>
          
          <!-- Subheadline -->
          <p style="font-size: 1rem; color: var(--text-muted); margin: 0 0 1.5rem; line-height: 1.5;">
            Hustl connects you with locals for simple jobs and everyday tasks.
          </p>
          
          <!-- CTA Buttons -->
          <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <button class="btn btn-primary" id="homeCtaPost" style="padding: 0.875rem 1.75rem; font-size: 1rem; font-weight: 600; border-radius: 10px; background: var(--primary); border: none; color: white;">
              Post a Job
            </button>
            <button class="btn btn-ghost" id="homeCtaBrowse" style="padding: 0.875rem 1.75rem; font-size: 1rem; font-weight: 600; border-radius: 10px; background: white; border: 1px solid var(--border); color: var(--text-main);">
              Browse Jobs
            </button>
          </div>
          
          <!-- Trust badges -->
          <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-muted);">
            <span>✓ Free to join</span>
            <span>✓ Secure payments</span>
            <span>✓ Instant payouts</span>
          </div>
        </div>
        
        <!-- How It Works Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          
          <!-- Card 1: Post -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(251, 191, 36, 0.3); background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">📝</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: #fbbf24;">1. Post Your Job</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Describe what you need, set your price. Takes 30 seconds.</p>
          </div>
          
          <!-- Card 2: Connect -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">💪</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--primary);">2. Get Offers</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Local hustlers apply. Compare, chat, and pick your favorite.</p>
          </div>
          
          <!-- Card 3: Pay -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(34, 197, 94, 0.3); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">💰</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--success);">3. Pay Securely</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Pay through Stripe. Hustler gets paid instantly to their bank.</p>
          </div>
        </div>
        
        <!-- SEO: Local Services Section -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.2); background: white;">
          <h2 style="font-size: 1.2rem; margin: 0 0 1rem; color: var(--text-main);">
            🏠 Local Help Across Tennessee
          </h2>
          <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin: 0 0 1rem;">
            Fast, simple local help across Tennessee — built to support people who need tasks done and people looking to earn.
          </p>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Knoxville, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Nashville, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Chattanooga, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 Memphis, TN</span>
            <span style="padding: 0.4rem 0.75rem; background: var(--bg-light); border-radius: 999px; font-size: 0.8rem; color: var(--text-muted);">📍 All of Tennessee</span>
          </div>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🚚 Moving</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🌿 Yard Work</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">💦 Power Washing</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🗑️ Junk Removal</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🎨 Painting</span>
            <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🔧 Handyman</span>
          </div>
          <button type="button" id="seeMoreCategoriesBtn" style="padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('allCategoriesExpanded').style.display = document.getElementById('allCategoriesExpanded').style.display === 'none' ? 'block' : 'none'; this.textContent = this.textContent === 'See More Categories' ? 'Show Less' : 'See More Categories';">
            See More Categories
          </button>
          <div id="allCategoriesExpanded" style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🔧 Furniture Assembly</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🌳 Landscaping</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🐕 Pet Care</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🚚 Delivery</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🚿 Car Cleaning</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">🎪 Event Setup</span>
              <span style="padding: 0.35rem 0.6rem; background: rgba(37, 99, 235, 0.1); border-radius: 6px; font-size: 0.75rem; color: var(--primary);">❄️ Snow Removal</span>
            </div>
          </div>
        </div>
        
        <!-- Why Stripe Section -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(99, 91, 255, 0.3);">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #635bff 0%, #a855f7 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 1.5rem;">💳</span>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.1rem;">Powered by Stripe</h3>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem;">Secure payments trusted by Uber, DoorDash, Lyft, Instacart</p>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; margin-top: 0.75rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">✓</span> Fast payouts
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">✓</span> Protected payments
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">✓</span> Bank-level security
            </div>
          </div>
        </div>
        
        <!-- Quick Info -->
        <div class="card" style="background: var(--card-glass);">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
            <span style="font-size: 1.25rem;">📍</span>
            <span style="font-weight: 600;">Currently serving Tennessee</span>
          </div>
          <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
            <li>• All of Tennessee — Knoxville, Nashville, Memphis & more</li>
            <li>• Hustl takes only 12% — the rest goes to hustlers</li>
            <li>• Chat with hustlers before you hire</li>
            <li>• You must be 18+ to use Hustl</li>
          </ul>
            <div class="section-title" style="margin-top:0.8rem;">Example categories</div>
            <div class="pill-row">
              <div class="pill">🚚 Moving & dump runs</div>
              <div class="pill">🌿 Yard work</div>
              <div class="pill">🧹 Clean-up & organizing</div>
              <div class="pill">🛠 Furniture & set-up</div>
              <div class="pill">⭐ Other local odd jobs</div>
            </div>
          </div>
        </div>
      </section>

      <!-- POST JOB VIEW (separate page) -->
      <section id="view-post" style="display:none;">
        <!-- Job Stats Section (shown after job is posted) -->
        <div id="jobStatsCard" class="card" style="display: none; margin-bottom: 1.5rem; padding: 2rem;">
          <div class="card-header">
            <div class="card-title">📊 Job Stats</div>
          </div>
          <div id="jobStatsContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
            <!-- Stats will be populated here -->
          </div>
          <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            <button class="btn btn-primary" onclick="setView('manage-jobs')" style="width: 100%; padding: 0.75rem; font-weight: 600;">📋 Manage This Job</button>
          </div>
        </div>
        
        <div class="card" id="jobFormCard" style="padding: 2.5rem;">
          <div class="card-header">
            <div class="card-title">Post a job</div>
          </div>
          <div class="muted" style="margin-bottom:0.5rem;">
            Post your job and hustlers will see it in the Jobs list.
          </div>

          <div class="field">
            <label for="jobTitle">Job title</label>
            <input id="jobTitle" type="text" placeholder="Example: Dump run from West Nashville" />
          </div>

          <!-- Category Selection - Mobile-friendly -->
          <div class="field">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span>📂 What do you need help with?</span>
            </label>
            
            <!-- Hidden select for form submission -->
            <select id="jobCategory" style="display: none;">
              <option value="">Select...</option>
              <option value="moving">Moving / Hauling</option>
              <option value="yard-work">Yard Work</option>
              <option value="dump-run">Dump Run</option>
              <option value="cleaning">Cleaning</option>
              <option value="power-washing">Power Washing</option>
              <option value="furniture-assembly">Furniture Assembly</option>
              <option value="painting">Painting</option>
              <option value="handyman">Handyman</option>
              <option value="landscaping">Landscaping</option>
              <option value="pet-care">Pet Care</option>
              <option value="delivery">Delivery</option>
              <option value="car-cleaning">Car Cleaning</option>
              <option value="event-setup">Event Setup</option>
              <option value="snow-removal">Snow Removal</option>
              <option value="other">Other</option>
            </select>

            <!-- Popular Categories - Big tappable chips -->
            <div id="categoryChips" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
              <button type="button" class="category-chip" data-value="moving" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🚚 Moving
              </button>
              <button type="button" class="category-chip" data-value="yard-work" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🌿 Yard Work
              </button>
              <button type="button" class="category-chip" data-value="dump-run" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🗑️ Dump Run
              </button>
              <button type="button" class="category-chip" data-value="cleaning" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🧹 Cleaning
              </button>
              <button type="button" class="category-chip" data-value="power-washing" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                💦 Power Wash
              </button>
              <button type="button" class="category-chip" data-value="furniture-assembly" style="padding: 0.6rem 1rem; border: 2px solid var(--border); background: #fff; border-radius: 999px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;">
                🔧 Assembly
              </button>
            </div>
            
            <!-- See More Categories -->
            <div id="moreCategoriesSection">
              <button type="button" id="showMoreCategoriesBtn" style="width: 100%; padding: 0.6rem; border: 1px dashed var(--border); background: transparent; border-radius: 8px; color: var(--primary); font-size: 0.9rem; cursor: pointer; transition: all 0.2s;">
                + See all categories
              </button>
              
              <div id="allCategoriesGrid" style="display: none; margin-top: 0.75rem;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                  <button type="button" class="category-chip" data-value="painting" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🎨 Painting</button>
                  <button type="button" class="category-chip" data-value="handyman" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🔨 Handyman</button>
                  <button type="button" class="category-chip" data-value="landscaping" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🌳 Landscaping</button>
                  <button type="button" class="category-chip" data-value="pet-care" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🐕 Pet Care</button>
                  <button type="button" class="category-chip" data-value="delivery" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🚚 Delivery</button>
                  <button type="button" class="category-chip" data-value="car-cleaning" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🚿 Car Cleaning</button>
                  <button type="button" class="category-chip" data-value="event-setup" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">🎪 Event Setup</button>
                  <button type="button" class="category-chip" data-value="snow-removal" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left;">❄️ Snow Removal</button>
                  <button type="button" class="category-chip" data-value="other" style="padding: 0.6rem; border: 2px solid var(--border); background: #fff; border-radius: 8px; font-size: 0.85rem; cursor: pointer; text-align: left; grid-column: span 2;">✨ Other / Custom Job</button>
                </div>
              </div>
            </div>
            
            <!-- Selected category display -->
            <div id="selectedCategoryDisplay" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: var(--primary-soft); border: 2px solid var(--primary); border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="selectedCategoryText" style="font-weight: 600; color: var(--primary);"></span>
                <button type="button" id="changeCategoryBtn" style="padding: 0.25rem 0.5rem; background: transparent; border: 1px solid var(--primary); border-radius: 4px; color: var(--primary); font-size: 0.8rem; cursor: pointer;">Change</button>
              </div>
            </div>
          </div>

          <!-- Custom category input (shown when "Other" is selected) -->
          <div class="field" id="customCategoryField" style="display: none;">
            <label for="customCategory">Describe your job type</label>
            <input id="customCategory" type="text" placeholder="What kind of help do you need?" />
          </div>

          <!-- Sub-tags (shown based on category) -->
          <div id="subTagsContainer" class="field" style="display: none;">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span>🏷️ More details</span>
              <span class="muted" style="font-weight: 400;">(optional)</span>
            </label>
            <div id="subTagsGrid" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <!-- Dynamically populated -->
            </div>
          </div>

          <div class="field">
            <label for="jobDescription">Job Description</label>
            <textarea id="jobDescription" rows="5" style="min-height: 120px;" placeholder="What needs to be done? Be specific about:
• What items need moving/work
• Any stairs, heavy items, or tight spaces
• When you need this done
• Any access instructions"></textarea>
            <div class="field-tip" style="margin-top: 0.5rem; padding: 0.75rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 8px; border-left: 3px solid var(--primary);">
              <span style="font-size: 0.85rem; color: #1e40af;">💡 <strong>Pro tip:</strong> Clearer details help hustlers understand your job better.</span>
            </div>
          </div>

          <!-- When Section -->
          <div class="section-title" style="margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main);">📅 When do you need this done?</div>
          
          <div class="field">
            <label for="jobWhen">Preferred time</label>
            <select id="jobWhen">
              <option value="today_asap">⚡ Today – ASAP</option>
              <option value="tomorrow">📆 Tomorrow</option>
              <option value="specific_date">📅 Specific date</option>
              <option value="flexible_week">⏰ Flexible (this week)</option>
              <option value="no_deadline">✅ No strict deadline</option>
            </select>
          </div>
          
          <!-- Specific date fields (shown when "Specific date" is selected) -->
          <div id="customDateFields" style="display: none;">
            <div class="field-inline">
              <div class="field">
                <label for="customDate">Date</label>
                <input id="customDate" type="date" />
              </div>
              <div class="field">
                <label for="customTime">Time</label>
                <select id="customTime">
                  <option value="morning">Morning (8am - 12pm)</option>
                  <option value="afternoon">Afternoon (12pm - 5pm)</option>
                  <option value="evening">Evening (5pm - 9pm)</option>
                  <option value="night">Night (9pm - 11pm)</option>
                </select>
              </div>
            </div>
          </div>
          
          <div id="flexibleDeadlineNote" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
            <p style="margin: 0; font-size: 0.85rem; color: #92400e;" id="flexibleDeadlineNoteText">
              <strong>⏰ Flexible Deadline:</strong> This job will stay active until someone completes it. No rush!
            </p>
          </div>
          
          <div id="todayAsapNote" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #fee2e2; border-radius: 8px; border-left: 3px solid #ef4444;">
            <p style="margin: 0; font-size: 0.85rem; color: #991b1b;">
              <strong>⚡ Today – ASAP:</strong> This job will be deleted after today unless you renew it.
            </p>
          </div>
          
          <div id="tomorrowNote" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b;">
            <p style="margin: 0; font-size: 0.85rem; color: #92400e;">
              <strong>📆 Tomorrow:</strong> This job will be active until tomorrow.
            </p>
          </div>

          <!-- Keep job active for (hidden - auto-set based on When selection) -->
          <div class="field" id="jobDurationField" style="display: none;">
            <label for="jobDuration">⏳ Keep this job active for</label>
            <select id="jobDuration">
              <option value="1">1 day</option>
              <option value="3" selected>3 days</option>
              <option value="7">1 week</option>
              <option value="14">2 weeks</option>
              <option value="30">1 month</option>
            </select>
            <p class="muted" style="font-size: 0.8rem; margin-top: 0.5rem;">
              How long should this job stay visible to hustlers? You can always extend or remove it manually.
            </p>
          </div>

          <!-- Equipment Needed Section - Optional & Collapsible -->
          <div class="field" style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
            <button type="button" id="equipmentToggle" style="width: 100%; padding: 0.875rem 1rem; background: var(--glass); border: none; display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.95rem;">
              <span style="display: flex; align-items: center; gap: 0.5rem;">
                <span>🔧 Equipment Needed</span>
                <span class="muted" style="font-weight: 400; font-size: 0.85rem;">(optional)</span>
              </span>
              <span id="equipmentToggleIcon" style="transition: transform 0.2s;">▼</span>
            </button>
            <div id="equipmentContent" style="display: none; padding: 1rem; background: var(--bg-light); border-top: 1px solid var(--border);">
              <p style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-muted);">Does the hustler need to bring any equipment?</p>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 0.75rem;">
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="truck" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🚛 Truck</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="pickup-truck" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🚚 Pick up truck</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="trailer" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🚗 Trailer</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="straps" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🪢 Moving Straps</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="dolly" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🛒 Dolly</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="tools" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🧰 Tools</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="lawnmower" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🌿 Lawn Mower</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="pressure-washer" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>💦 Pressure Washer</span>
                </label>
                <label class="equipment-checkbox" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                  <input type="checkbox" name="equipment" value="ladder" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                  <span>🪜 Ladder</span>
                </label>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
                <input type="checkbox" id="customEquipmentToggle" style="width: 18px; height: 18px; accent-color: var(--primary);" />
                <label for="customEquipmentToggle" style="cursor: pointer; color: var(--primary); font-weight: 500; font-size: 0.9rem;">+ Other equipment</label>
              </div>
              <div id="customEquipmentField" style="display: none; margin-top: 0.5rem;">
                <input id="customEquipment" type="text" placeholder="Describe other equipment needed..." />
              </div>
            </div>
          </div>

          <!-- Workers Needed -->
          <div class="field">
            <label for="workersNeeded">👥 How many workers needed?</label>
            <select id="workersNeeded">
              <option value="1">1 person</option>
              <option value="2">2 people</option>
              <option value="3">3 people</option>
              <option value="4">4 people</option>
              <option value="5">5 people</option>
              <option value="6">6 people</option>
              <option value="custom">Custom</option>
              <option value="company">Company (Insured company/crew)</option>
            </select>
          </div>
          
          <!-- Custom workers input (shown when "Custom" is selected) -->
          <div class="field" id="customWorkersField" style="display: none;">
            <label for="customWorkersCount">Enter number of workers</label>
            <input id="customWorkersCount" type="number" min="1" max="20" placeholder="How many workers?" />
          </div>

          <div class="section-title" style="margin-top: 1rem; margin-bottom: 0.75rem; font-weight: 600; color: var(--text-main); font-size: 1.1rem;">📍 Location Details</div>

          <!-- Pickup Location -->
          <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div style="font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem; font-size: 0.95rem;">Pickup Location</div>
            
            <div class="field-inline" style="margin-bottom: 0.75rem;">
              <div class="field">
                <label for="pickupArea">Pickup area / neighborhood</label>
                <input id="pickupArea" type="text" placeholder="Example: West Nashville near Vanderbilt" />
              </div>
              <div class="field">
                <label for="pickupCity">Pickup city</label>
                <input id="pickupCity" type="text" placeholder="Example: Nashville, TN" />
              </div>
              <div class="field">
                <label for="pickupZip">Pickup ZIP</label>
                <input id="pickupZip" type="text" placeholder="Example: 37203" maxlength="10" />
              </div>
            </div>

            <div class="field">
              <label for="pickupAddress">Pickup address *</label>
              <input id="pickupAddress" type="text" placeholder="Start typing address..." autocomplete="off" required />
              <div id="pickupAddressSuggestions" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 300px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
              <input type="hidden" id="pickupLat" />
              <input type="hidden" id="pickupLng" />
            </div>
          </div>

          <div class="field" style="margin-bottom: 1.5rem;">
            <label>
              <input type="checkbox" id="jobOnSiteOnly" />
              This job happens only at the pickup location (no separate dropoff).
            </label>
          </div>

          <div class="field" style="margin-bottom: 1.5rem; padding: 0.75rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fde68a;">
            <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="hideAddressUntilAssigned" style="margin-top: 0.25rem; cursor: pointer;" />
              <div style="font-size: 0.9rem; color: var(--text-main);">
                <strong>Hide address until hustler is assigned</strong>
                <div style="margin-top: 0.25rem; color: var(--text-muted); font-size: 0.85rem;">
                  Address will only be shown to hustlers after they're assigned. You can also send it through messaging.
                </div>
              </div>
            </label>
          </div>

          <!-- Dropoff Location -->
          <div id="dropoffFields" style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <div style="font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem; font-size: 0.95rem;">Dropoff Location</div>
            
            <div class="field-inline" style="margin-bottom: 0.75rem;">
              <div class="field">
                <label for="dropoffArea">Dropoff area / neighborhood</label>
                <input id="dropoffArea" type="text" placeholder="Example: East Nashville" />
              </div>
              <div class="field">
                <label for="dropoffCity">Dropoff city</label>
                <input id="dropoffCity" type="text" placeholder="Example: Nashville, TN" />
              </div>
              <div class="field">
                <label for="dropoffZip">Dropoff ZIP</label>
                <input id="dropoffZip" type="text" placeholder="Example: 37206" maxlength="10" />
              </div>
            </div>
            
            <div class="field">
              <label for="dropoffAddress">Dropoff address *</label>
              <input id="dropoffAddress" type="text" placeholder="Start typing address..." autocomplete="off" required />
              <div id="dropoffAddressSuggestions" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 300px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
              <input type="hidden" id="dropoffLat" />
              <input type="hidden" id="dropoffLng" />
            </div>
          </div>

          <div class="section-title" style="margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-main);">💰 Pricing</div>
          
          <!-- Pricing Option -->
          <div class="field">
            <label for="pricingOption">How do you want to set the price?</label>
            <select id="pricingOption">
              <option value="set_price">I want to set a price</option>
              <option value="hustlers_quote">Let hustlers give their own price</option>
            </select>
          </div>
          
          <!-- Price Setting Fields (shown when "set_price" is selected) -->
          <div id="priceSettingFields">
            <div class="field-inline">
              <div class="field">
                <label for="paymentType">Payment type</label>
                <select id="paymentType">
                  <option value="flat">Flat amount (one-time)</option>
                  <option value="hourly">Hourly + max hours</option>
                </select>
              </div>
              <div class="field" id="flatAmountField">
                <label for="flatAmount">Pay ($ flat)</label>
                <input id="flatAmount" type="number" min="0" step="1" value="80" />
              </div>
            </div>

            <div id="hourlyFields" style="display:none;">
              <div style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--text-main); margin-bottom: 0.75rem;">Hourly Pay</div>
                
                <div class="field" style="margin-bottom: 0.75rem;">
                  <label for="hourlyRate" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Total hourly rate:</label>
                  <input id="hourlyRate" type="number" min="0" step="1" value="20" style="width: 100%;" />
                  <span style="font-size: 0.85rem; color: var(--text-muted); margin-left: 0.5rem;">/hr</span>
                </div>
                
                <div class="field" style="margin-bottom: 0.75rem;">
                  <label for="maxHours" style="display: block; font-weight: 600; margin-bottom: 0.25rem;">Max hours:</label>
                  <input id="maxHours" type="number" min="1" step="1" value="3" style="width: 100%;" />
                </div>
                
                <div id="hourlyRateCalculation" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px;">
                  <div style="font-size: 0.85rem; color: var(--text-main); margin-bottom: 0.5rem; font-weight: 600;">Split between workers</div>
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    Example: <span id="exampleWorkers">2</span> workers → $<span id="examplePerPerson">10</span>/hr each
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Note when hustlers quote -->
          <div id="hustlersQuoteNote" style="display: none; padding: 0.75rem; background: #fef3c7; border-radius: 8px; border-left: 3px solid #f59e0b; margin-top: 0.5rem;">
            <p style="margin: 0; font-size: 0.85rem; color: #92400e;">
              💡 Hustlers will propose their own prices when applying. You can accept, decline, or negotiate.
            </p>
          </div>

          <div class="field">
            <label for="jobNotes">Extra notes (optional)</label>
            <textarea id="jobNotes" placeholder="Parking, gate codes, equipment, pets, any special requests."></textarea>
          </div>

          <div class="field">
            <label for="jobPhoto">Optional photo (not uploaded in this demo)</label>
            <input id="jobPhoto" type="file" accept="image/*" />
          </div>

          <button class="btn btn-primary" id="postJobButton">Post job to Hustl</button>

          <div class="muted" style="margin-top:0.4rem;">
            Your job will be posted and visible to hustlers across Tennessee.
          </div>
        </div>
      </section>

      <!-- JOBS VIEW -->
      <section id="view-jobs" style="display:none;">
        <!-- Search & Filter Bar -->
        <div class="card" style="margin-bottom: 1rem; padding: 2rem;">
          <!-- Category Filter Chips -->
          <div style="margin-bottom: 1.5rem; padding-top: 0.5rem;">
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-muted); margin-bottom: 1rem;">Filter by Category</div>
            <div id="categoryFilterChips" style="display: flex; flex-wrap: wrap; gap: 0.75rem; min-height: 80px; align-items: center; padding-top: 0.5rem;">
              <button class="filter-chip active" data-category="all" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--primary); background: var(--primary-soft); color: var(--primary); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                All Jobs
              </button>
              <button class="filter-chip" data-category="moving" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); background: white; color: var(--text-main); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                🚚 Moving
              </button>
              <button class="filter-chip" data-category="yard-work" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); background: white; color: var(--text-main); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                🌿 Yard Work
              </button>
              <button class="filter-chip" data-category="dump-run" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); background: white; color: var(--text-main); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                🗑️ Dump Run
              </button>
              <button class="filter-chip" data-category="cleaning" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); background: white; color: var(--text-main); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                🧹 Cleaning
              </button>
              <button class="filter-chip" data-category="power-washing" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); background: white; color: var(--text-main); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                💦 Power Wash
              </button>
              <button class="filter-chip" data-category="handyman" style="padding: 0.5rem 0.75rem; border: 1.5px solid var(--border); background: white; color: var(--text-main); border-radius: 999px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                🔧 Handyman
              </button>
            </div>
          </div>
          
          <!-- Sort & Status Row -->
          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
            <!-- Sort Dropdown -->
            <div style="flex: 1; min-width: 140px;">
              <select id="jobsSortBy" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; background: white;">
                <option value="newest">🕐 Newest First</option>
                <option value="highest">💰 Highest Pay</option>
                <option value="lowest">💵 Lowest Pay</option>
                <option value="closest">📍 Closest</option>
              </select>
            </div>
            
            <!-- Status Pills -->
            <div class="job-status-group" id="jobsStatusFilter" style="flex: 2; display: flex; gap: 0.25rem;">
              <span data-status="all" class="job-status-tab active" style="padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; background: var(--primary); color: white; font-weight: 600; border: 2px solid var(--primary); transition: all 0.2s;">All</span>
              <span data-status="applied" class="job-status-tab" style="padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; background: white; color: var(--text-main); border: 2px solid var(--border); transition: all 0.2s;">✓ Applied</span>
              <span data-status="in_progress" class="job-status-tab" style="padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; background: white; color: var(--text-main); border: 2px solid var(--border); transition: all 0.2s;">🟡 In Progress</span>
              <span data-status="done" class="job-status-tab" style="padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; background: white; color: var(--text-main); border: 2px solid var(--border); transition: all 0.2s;">✅ Done</span>
            </div>
          </div>
          
          <!-- Location Filter -->
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.75rem;">📍 Filter by Location</div>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
              <div style="flex: 1; min-width: 120px;">
                <input type="text" id="locationZipFilter" placeholder="ZIP code (e.g., 37919)" maxlength="5" style="width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; background: white;" />
              </div>
              <div style="flex: 1; min-width: 140px;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="range" id="locationRadiusFilter" min="5" max="100" value="25" step="5" style="flex: 1;" />
                  <span id="radiusValueDisplay" style="font-size: 0.85rem; color: var(--text-muted); min-width: 50px; text-align: right;">25 mi</span>
                </div>
              </div>
              <button id="clearLocationFilter" style="padding: 0.6rem 1rem; background: transparent; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; white-space: nowrap;">Clear</button>
            </div>
          </div>
        </div>
        
        <!-- Jobs Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0 0.25rem;">
          <div>
            <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-main);" id="jobsCardTitle">Jobs in Tennessee</h2>
            <span class="muted" id="jobsFilterSummary" style="font-size: 0.85rem;"></span>
          </div>
          <button id="refreshJobsBtn" style="padding: 0.5rem 0.75rem; background: transparent; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer;">
            🔄 Refresh
          </button>
        </div>
        
        <!-- Jobs List -->
        <div class="jobs-list" id="jobsList" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
        
        <!-- Load More Button -->
        <div id="loadMoreSection" style="text-align: center; padding: 1rem; display: none;">
          <button id="loadMoreJobsBtn" style="padding: 0.75rem 2rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Load More Jobs
          </button>
        </div>
        
        <div id="jobDetailContainer"></div>
      </section>

      <!-- MESSAGES VIEW -->
      <section id="view-messages" style="display:none;">
        <div class="messages-layout">
          <!-- Conversations List -->
          <div class="conversations-sidebar">
            <div class="conversations-header">
              <h3 style="margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                💬 Messages
              </h3>
              <span id="unreadBadge" class="unread-badge" style="display: none;">0</span>
            </div>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin: 0.5rem 0 1rem; padding: 0 1rem;">
              Each conversation is tied to a specific job.
            </p>
            <div class="conversations-list" id="conversationList"></div>
          </div>
          
          <!-- Chat Area -->
          <div class="chat-area">
            <div class="chat-header">
              <div id="conversationTitle" style="font-weight: 600; font-size: 1rem;">Select a conversation</div>
              <div id="conversationJobSummary" style="font-size: 0.85rem; color: var(--text-muted);"></div>
            </div>
            <div class="chat-messages-container" id="conversationMessages">
              <div class="empty-chat" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">💬</div>
                <div style="font-weight: 600; margin-bottom: 0.5rem;">No conversation selected</div>
                <div style="font-size: 0.9rem;">Pick a job from the list to start chatting</div>
              </div>
            </div>
            <div class="chat-input-area">
              <input id="conversationInput" type="text" placeholder="Type a message..." class="chat-input" />
              <button class="btn btn-primary chat-send-btn" id="conversationSendButton">
                <span>Send</span>
                <span style="margin-left: 0.25rem;">→</span>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- MANAGE JOBS VIEW -->
      <section id="view-manage-jobs" style="display:none;">
        <div style="padding: 1rem; max-width: 1200px; margin: 0 auto;">
          <h1 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1.5rem 0; color: var(--text-main);">📋 Manage Jobs</h1>
          
          <!-- Tabs with blue highlighting -->
          <div class="profile-tabs" style="margin-bottom: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
            <button class="profile-tab active manage-tab" data-manage-tab="posted" style="position: relative;">
              📋 Posted
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: block;"></span>
            </button>
            <button class="profile-tab manage-tab" data-manage-tab="active" style="position: relative;">
              🟡 Active
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: none;"></span>
            </button>
            <button class="profile-tab manage-tab" data-manage-tab="completed" style="position: relative;">
              ✅ Completed
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: none;"></span>
            </button>
            <button class="profile-tab manage-tab" data-manage-tab="applied" style="position: relative; display: none;" id="appliedJobsTab">
              📝 Applied
              <span class="tab-indicator" style="position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 3px; background: var(--primary); border-radius: 2px 2px 0 0; display: none;"></span>
            </button>
          </div>
          
          <!-- Posted Jobs Tab -->
          <div id="manageTabPosted" class="profile-tab-content active">
            <div style="margin-bottom: 1.5rem;">
              <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">📋 Posted</h2>
              <div style="color: var(--text-muted); font-size: 0.9rem;">Manage your job postings, review applicants, and track activity</div>
            </div>
            <div id="managePostedJobsList" style="display: grid; gap: 1.5rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Active Jobs Tab -->
          <div id="manageTabActive" class="profile-tab-content" style="display: none;">
            <div style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">Jobs currently happening. View details, message, navigate to map, mark started/finished, or cancel.</div>
            <div id="manageActiveJobsList" style="display: grid; gap: 1rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Completed Jobs Tab -->
          <div id="manageTabCompleted" class="profile-tab-content" style="display: none;">
            <div style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">All finished jobs. View final pay, rate the worker, view reviews, re-hire, or favorite.</div>
            <div id="manageCompletedJobsList" style="display: grid; gap: 1rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Applied Jobs Tab (Hustler only) -->
          <div id="manageTabApplied" class="profile-tab-content" style="display: none;">
            <div style="margin-bottom: 1.5rem;">
              <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">📝 Applied</h2>
              <div style="color: var(--text-muted); font-size: 0.9rem;">Track your applications and see their status</div>
            </div>
            <div id="manageAppliedJobsList" style="display: grid; gap: 1.5rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" style="display:none;">
        <!-- Basic Info Section -->
        <div id="profileBasicInfo" class="profile-basic-info">
          <div style="padding: 2rem; text-align: center; color: var(--text-muted);">Loading profile...</div>
        </div>
        
        <!-- Quick Stats -->
        <div id="profileQuickStats" class="profile-quick-stats"></div>
        
        <!-- Tab Navigation -->
        <div class="profile-tabs">
          <button class="profile-tab active" data-tab="settings">⚙️ Settings</button>
          <button class="profile-tab" data-tab="ratings">⭐ View Ratings</button>
          <button class="profile-tab" data-tab="jobs">📋 Jobs</button>
          <button class="profile-tab" data-tab="earnings">💰 Earnings</button>
        </div>
        
        <!-- Settings Tab -->
        <div id="profileTabSettings" class="profile-tab-content active">
          <div class="profile-section-grid">
            <!-- Left Column -->
            <div>
              <!-- Preferences -->
              <div class="card profile-settings-card" style="margin-top: 1rem;">
                <div class="card-header">
                  <div class="card-title">🔔 Preferences</div>
                </div>
                <div id="profilePreferences">
                  <div class="preference-item">
                    <div>
                      <div class="preference-label">Email Notifications</div>
                      <div class="preference-desc">Get notified about new jobs and messages</div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="prefEmailNotif" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  <div class="preference-item">
                    <div>
                      <div class="preference-label">Job Alerts</div>
                      <div class="preference-desc">Get alerts for jobs near you</div>
                    </div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="prefJobAlerts" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right Column -->
            <div>
              <!-- Payment Setup -->
              <div class="card profile-settings-card" id="stripeConnectSection">
                <div class="card-header">
                  <div class="card-title" style="color: #16a34a;">💳 Payment Setup</div>
                </div>
                <div id="stripeConnectContent"></div>
              </div>
              
              <!-- Account Actions -->
              <div class="card profile-settings-card" style="margin-top: 1rem;">
                <div class="card-header">
                  <div class="card-title">🔐 Account</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <button class="btn btn-ghost" id="changePasswordBtn" style="width: 100%; justify-content: flex-start; gap: 0.5rem;">
                    🔑 Change Password
                  </button>
                  <button class="btn btn-ghost" id="profileSignOutBtn" data-action="signout" style="width: 100%; justify-content: flex-start; gap: 0.5rem; color: #dc2626; border-color: #fecaca;">
                    🚪 Sign Out
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Ratings Tab -->
        <div id="profileTabRatings" class="profile-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">⭐ Your Ratings & Reviews</div>
            </div>
            <div id="profileRatingsContent" style="padding: 1.5rem;">
              <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">⭐</div>
                <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;" id="profileRatingValue">
                  ${user.ratingAvg ? user.ratingAvg.toFixed(1) : '5.0'}
                </div>
                <div style="color: var(--text-muted); margin-bottom: 1.5rem;" id="profileRatingCount">
                  Based on ${user.ratingCount || 0} ${user.ratingCount === 1 ? 'review' : 'reviews'}
                </div>
                <div id="profileReviewsList" style="text-align: left; margin-top: 2rem;"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Jobs Tab -->
        <div id="profileTabJobs" class="profile-tab-content" style="display: none;">
          <!-- Posted Jobs Section (Customer) -->
          <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
              <div class="card-title">📋 Posted</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">Manage jobs you've posted</div>
            </div>
            <div id="postedJobsList" style="padding: 1rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
          
          <!-- Active Jobs Section (Hustler) -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">💼 Active</div>
              <div style="font-size: 0.85rem; color: var(--text-muted);">Jobs you're working on</div>
            </div>
            <div id="activeJobsList" style="padding: 1rem;">
              <div style="text-align: center; padding: 2rem; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
        </div>
        
        <!-- Earnings Tab -->
        <div id="profileTabEarnings" class="profile-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <div class="card-title">💰 Earnings Overview</div>
            </div>
            <div id="profileEarningsContent"></div>
          </div>
        </div>
      </section>

      <!-- OWNER VIEW -->
      <section id="view-owner" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Owner dashboard (demo)</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Shows paid jobs, your 12% fee, and whether you've sent the Hustler their payout.
            </div>
            <div id="ownerPaidList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Assigned but not paid yet</div>
            </div>
            <div id="ownerAssignedList"></div>
          </div>
        </div>
      </section>

      <!-- FEEDBACK VIEW -->
      <section id="view-feedback" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Send feedback to Hustl</div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            This isn’t a public review wall. It’s a private way to send feedback directly to the Hustl team
            (<strong>team.hustlapp@outlook.com</strong>) about bugs, ideas, or issues.
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="feedbackName">Name (optional)</label>
              <input id="feedbackName" type="text" placeholder="Your name or leave blank" />
            </div>
            <div class="field">
              <label for="feedbackEmail">Email (optional)</label>
              <input id="feedbackEmail" type="email" placeholder="So we can reply if needed" />
            </div>
          </div>
          <div class="field">
            <label for="feedbackMessage">Feedback</label>
            <textarea id="feedbackMessage" placeholder="Tell us what’s working, what’s confusing, or what you’d love to see."></textarea>
          </div>
          <button class="btn btn-primary" id="feedbackButton">Send feedback</button>
          <div class="feedback-note">
            Your feedback will be sent to the Hustl team. We read every message!
          </div>
        </div>
      </section>

          <!-- ABOUT / LEGAL VIEW -->
      <section id="view-about" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">About Hustl</div>
          </div>
          <div class="about-text">
Hustl was built in Knoxville, Tennessee with a simple goal:  
make it easier for people to help each other and make real money on the side.

If you need help – moving a couch, doing a dump run, cleaning out a garage,
tackling yard work, or knocking out random errands – you shouldn’t have to
blast group chats or scroll through sketchy posts. You should be able to
describe the job, set a fair price, and connect with someone local who’s
ready to work.

If you’re a Hustler, Hustl is a way to turn your time, truck, or muscle into
extra cash on your own schedule. No long-term commitments, no complicated
contracts – just clear jobs, clear payouts, and a straightforward platform fee.

Hustl is also about supporting small, local businesses and solo operators.
As the platform grows, the same tools that help with one-time jobs can help
people build regular clients, repeat work, and real side-income here in the
community.

Post a job, apply to one, show up, do solid work, and get paid – that’s the
heart of Hustl.
          </div>
        </div>
      </section>

    </main>

    <footer>
      <div class="footer-row">
        <div>© 2025 Hustl. All rights reserved.</div>
        <div class="footer-links">
          <a href="terms.html" id="footerTermsLink">Terms of Use</a>
          <span>•</span>
          <a href="privacy.html" id="footerPrivacyLink">Privacy Policy</a>
          <span>•</span>
          <span>team.hustlapp@outlook.com</span>
          <span>·</span>
          <span>@team.hustlapp</span>
        </div>
      </div>
    </footer>

       <div class="toast" id="toast"></div>

    <!-- Age gate disabled: popup hidden -->
    <div class="age-gate-overlay" id="ageGate" style="display:none;">
      <div class="age-gate-card">
        <h2>Are you 18 or older?</h2>
        <p>
          Hustl is for adults only. By continuing, you confirm that you are at least 18 years old.
        </p>
        <div class="age-gate-buttons">
          <button class="btn btn-primary" id="ageYesButton">Yes, I’m 18+</button>
          <button class="btn btn-ghost" id="ageNoButton">No</button>
        </div>
        <div class="muted" style="margin-top:0.4rem;">
          If you tap “No”, we’ll just hide the app. You can come back when you’re older.
        </div>
      </div>
    </div>
  </div>

<!-- Backend API Configuration -->
<script>
  // Set your Railway backend URL here
  window.HUSTL_CONFIG = {
    API_URL: 'https://hustl-production.up.railway.app' // Railway backend URL
  };
  
  // Auto-detect localhost for development
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.HUSTL_CONFIG.API_URL = 'http://localhost:4000';
  }
</script>
<script src="/api-integration.js?v=3"></script>
<script>
  // Simple stub functions - will be replaced when real functions are defined
  // The stub actually works as a fallback to ensure navigation always functions
  window.setView = async function(view) {
    console.log("⚠️ setView stub called, using fallback for view:", view);
    // Fallback implementation - manually switch views
    if (typeof window.activeView !== 'undefined') {
      window.activeView = view;
    }
    // Hide all views
    document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
    // Show target view
    const target = document.getElementById("view-" + view);
    if (target) {
      target.style.display = "block";
      window.scrollTo({ top: 0, behavior: 'instant' });
    }
    // Update nav tabs
    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.classList.toggle("active", tab.dataset.view === view);
    });
    // Call renderAll if available
    if (typeof window.renderAll === 'function') {
      setTimeout(async () => {
        try {
          await window.renderAll();
        } catch (err) {
          console.error("Error in stub renderAll:", err);
        }
      }, 50);
    }
  };
  window.openAuthModal = function(mode) {
    console.warn("openAuthModal not ready yet, mode:", mode);
  };
  window.closeAuthModal = function() {
    console.warn("closeAuthModal not ready yet");
  };
  // Stub will be replaced by real function below
  window.handleSignOut = function() {
    console.warn("handleSignOut not ready yet - please wait for page to load");
  };
  
  // Backend API configuration - using NestJS API with Neon database
  // No Supabase needed - we use Railway backend with Neon PostgreSQL
  // Deploy v2.1 - Fixed button handlers
  
  const STORAGE_KEY = "hustl_state_v3";
    // Get backend URL from config or default
    const BACKEND_URL = (window.HUSTL_CONFIG && window.HUSTL_CONFIG.API_URL) || 
                        (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                          ? 'http://localhost:4000' 
                          : 'https://hustl-production.up.railway.app');
    // API base for direct fetch calls (no /api prefix needed)
    const API_BASE = BACKEND_URL;

    // 🔔 Auto-complete after 72 hours of no customer response
    const AUTO_COMPLETE_HOURS = 72;
    const AUTO_COMPLETE_MS = AUTO_COMPLETE_HOURS * 60 * 60 * 1000;

    let state = {
      users: [],
      currentUserId: null,
      jobs: [],
      feedback: [],
    };

    let activeView = "home";
    // Expose activeView on window for fallback access
    window.activeView = activeView;
    let activeJobsStatusFilter = "all";
    let activeConversationJobId = null;
    let activeConversationThreadId = null;
    let messagePollInterval = null;
    
    // Pagination state
    let currentJobsPage = 1;
    let jobsPagination = { hasMore: false };
    let allLoadedJobs = []; // Always initialize as empty array

    /* ---------- Utilities ---------- */

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
        }
      } catch (e) {
        console.error("Error loading state", e);
      }
    }

    function getCurrentUser() {
      return state.users.find((u) => u.id === state.currentUserId) || null;
    }

    function generateId(prefix) {
      return (
        prefix +
        "_" +
        Date.now().toString(36) +
        "_" +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function formatMoney(amount) {
      const n = Number(amount) || 0;
      return "$" + n.toFixed(2);
    }

    function timeAgo(timestamp) {
      if (!timestamp) return "Recently";
      // Handle both Date objects and timestamps
      let timeMs;
      if (timestamp instanceof Date) {
        timeMs = timestamp.getTime();
      } else if (typeof timestamp === 'string') {
        timeMs = new Date(timestamp).getTime();
      } else if (typeof timestamp === 'number') {
        timeMs = timestamp;
      } else {
        return "Recently";
      }
      
      // Check if valid date
      if (isNaN(timeMs)) return "Recently";
      
      const now = Date.now();
      const diffMs = now - timeMs;
      if (diffMs < 0) return "Recently"; // Future date
      
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return diffMin + (diffMin === 1 ? " min ago" : " mins ago");
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return diffHr + (diffHr === 1 ? " hr ago" : " hrs ago");
      const diffDay = Math.floor(diffHr / 24);
      if (diffDay === 1) return "1 day ago";
      if (diffDay < 7) return diffDay + " days ago";
      const diffWeek = Math.floor(diffDay / 7);
      if (diffWeek < 4) return diffWeek + (diffWeek === 1 ? " week ago" : " weeks ago");
      const diffMonth = Math.floor(diffDay / 30);
      return diffMonth + (diffMonth === 1 ? " month ago" : " months ago");
    }

    let toastTimeout = null;
    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        el.classList.remove("show");
      }, 2200);
    }

    // ⏱ Auto-complete checker: if Hustler marked finished and no dispute + no response in time
    function checkAutoCompleteJobs() {
      const now = Date.now();
      let changed = false;

      state.jobs.forEach((job) => {
        if (
          job &&
          job.status === "assigned" &&
          job.completionRequestedAt &&
          !job.dispute &&
          !job.autoCompleted
        ) {
          if (now - job.completionRequestedAt >= AUTO_COMPLETE_MS) {
            job.status = "completed"; // If there's a hustler, this will now appear in Owner payout queue
            if (job.acceptedHustlerId) {
              console.log("Job moved to payout queue:", job.id);
            }
            job.autoCompleted = true;
            changed = true;
          }
        }
      });

      if (changed) {
        saveState();
        renderAll();
      }
    }

    /* ---------- Age gate (disabled) ---------- */

    function checkAgeGate() {
      // Always keep it hidden
      const overlay = document.getElementById("ageGate");
      if (overlay) overlay.style.display = "none";
    }

    function initAgeGate() {
      // No-op – age gate disabled
    }

    /* ---------- View navigation ---------- */

    async function setView(view) {
      // Protected views that require authentication
      const protectedViews = ['profile', 'messages', 'post'];
      
      // Check auth for protected views
      if (protectedViews.includes(view)) {
        let user = null;
        try {
          user = await window.hustlAPI.auth.getCurrentUser();
        } catch (e) {
          // Ignore errors, user will be null
        }
        
        if (!user) {
          // Not authenticated - redirect to home and show login
          showToast("Please log in to access this page");
          view = 'home';
          // Open login modal
          setTimeout(() => {
            if (window.openAuthModal && typeof window.openAuthModal === 'function') {
              window.openAuthModal('login');
            }
          }, 300);
        }
      }
      
      activeView = view;
      // Update window.activeView for fallback access
      window.activeView = view;
      
      // Hide ALL sections first including auth section
      document
        .querySelectorAll("[id^='view-']")
        .forEach((sec) => (sec.style.display = "none"));
      
      // Check if user is logged in to determine if auth section should show
      let user = null;
      try {
        user = await window.hustlAPI.auth.getCurrentUser();
      } catch (e) {
        // Ignore errors
      }
      
      // Hide auth section when not on home OR when logged in
      const authSection = document.getElementById("authSection");
      if (authSection) {
        const shouldShow = !user && view === 'home';
        authSection.style.display = shouldShow ? 'block' : 'none';
        if (!shouldShow) {
          authSection.style.height = '0';
          authSection.style.padding = '0';
          authSection.style.margin = '0';
        }
      }
      
      const target = document.getElementById("view-" + view);
      if (target) {
        target.style.display = "block";
        // Scroll to top immediately for all views to remove white space
        window.scrollTo({ top: 0, behavior: 'instant' });
        // Remove any padding/margin from the view
        target.style.marginTop = '0';
        target.style.paddingTop = '0';
        // Scroll to top and remove padding for post view
        if (view === 'post') {
          document.body.classList.add('viewing-post');
          const jobFormCard = document.getElementById("jobFormCard");
          if (jobFormCard) {
            jobFormCard.style.marginTop = '0';
            jobFormCard.style.paddingTop = '0';
          }
        } else {
          document.body.classList.remove('viewing-post');
        }
      }
      
      // Don't re-initialize hamburger menu - it uses event delegation and doesn't need re-initialization
      // Re-initializing causes infinite loops
      
      // Update active state for nav tabs (don't re-initialize - that causes infinite loops)
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.view === view);
      });
      
      // Update mobile bottom nav active state if it exists
      if (window.mobileCore && window.mobileCore.bottomNav) {
        window.mobileCore.bottomNav.updateActiveTab(view);
      }

      await renderAll();
    }
    // Expose setView globally immediately after definition
    window.setView = setView;

    /* ---------- Auth visibility ---------- */

    async function renderAuthSectionVisibility() {
  const authSection = document.getElementById("authSection");
  const user = await window.hustlAPI.auth.getCurrentUser();
  // Only show auth section on home view AND when not logged in
  const shouldShow = !user && activeView === 'home';
  authSection.style.display = shouldShow ? "block" : "none";
}

    
/* ---------- Auth ---------- */

async function renderAuthPill() {
  const pill = document.getElementById("authPill");
  const user = await window.hustlAPI.auth.getCurrentUser();

  if (!user) {
    pill.innerHTML =
      'Not signed in <button id="openAuthButton">Sign in / Create account</button>';

    const openBtn = document.getElementById("openAuthButton");
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        document
          .getElementById("authSection")
          .scrollIntoView({ behavior: "smooth" });
      });
    }
  } else {
    const displayName = user.name || user.email;
    const role = user.roles && user.roles.length > 0 ? user.roles[0].toLowerCase() : "user";
    pill.innerHTML =
      `Signed in as <strong>${displayName}</strong> · ${role}` +
      '<button id="logoutButton">Log out</button>';

    const logoutBtn = document.getElementById("logoutButton");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        if (typeof window.handleSignOut === 'function') {
          await window.handleSignOut();
        } else {
          // Fallback if handleSignOut not ready
          await window.hustlAPI.auth.signOut();
          showToast("Logged out.");
          renderAll();
        }
      });
    }
  }
}

function initAuthCard() {
  const authTitle = document.getElementById("authCardTitle");
  const authToggle = document.getElementById("authModeToggle");
  const authBodyCreate = document.getElementById("authBodyCreate");
  const authBodyLogin = document.getElementById("authBodyLogin");
  let mode = "create";

  function wireToggle() {
    const span = authToggle.querySelector("span.linkish");
    if (span) {
      span.addEventListener("click", (e) => {
        const m = e.target.dataset.authMode;
        setMode(m);
      });
    }
  }

  function setMode(next) {
    mode = next;
    if (mode === "create") {
      authTitle.textContent = "Create account";
      authBodyCreate.style.display = "";
      authBodyLogin.style.display = "none";
      authToggle.innerHTML =
        'Already have an account? <span class="linkish" data-auth-mode="login">Log in</span>';
    } else {
      authTitle.textContent = "Log in";
      authBodyCreate.style.display = "none";
      authBodyLogin.style.display = "";
      authToggle.innerHTML =
        'Need a new account? <span class="linkish" data-auth-mode="create">Create one</span>';
    }
    wireToggle();
  }

  setMode("create");

document.getElementById("createAccountButton").addEventListener("click", async () => {
  const name = document.getElementById("createName").value.trim();
  const email = document.getElementById("createEmail").value.trim();
  const password = document.getElementById("createPassword").value.trim();
  const city = document.getElementById("createCity").value.trim();
  const zip = document.getElementById("createZip").value.trim();
  const role = document.getElementById("createRole").value;

  // Get checkbox values
  const ageCheckbox = document.getElementById("ageCheckbox");
  const termsCheckbox = document.getElementById("termsCheckbox");

  if (!name || !email || !password) {
    showToast("Please fill name, email, and password.");
    return;
  }
  if (!city) {
    showToast("Please enter your city.");
    return;
  }
  if (!zip || !/^\d{5}$/.test(zip)) {
    showToast("Please enter a valid 5-digit ZIP code.");
    return;
  }
  if (password.length < 8) {
    showToast("Password should be at least 8 characters.");
    return;
  }
  if (ageCheckbox && !ageCheckbox.checked) {
    showToast("You must be 18 or older to use Hustl.");
    return;
  }
  if (termsCheckbox && !termsCheckbox.checked) {
    showToast("Please agree to the Terms of Use and Privacy Policy.");
    return;
  }

  // Generate username from email (take part before @, make alphanumeric)
  let username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
  // Ensure it's at least 3 characters
  if (username.length < 3) {
    username = 'user' + username;
  }
  // Add random suffix for uniqueness
  const randomSuffix = Math.floor(Math.random() * 10000);
  username = username + randomSuffix;
  // Max 20 characters total
  if (username.length > 20) {
    username = username.substring(0, 20);
  }

  try {
    // Use backend API for signup with city and zip
    const result = await window.hustlAPI.auth.signUp(
      email,
      password,
      name,
      username,
      city,
      zip,
      role
    );

    // Check if email verification is required (backend returns requiresEmailVerification)
    if (result.requiresEmailVerification || !result.user?.emailVerified) {
      showToast("✅ Check your email for a verification code!");
      // Show verification input
      showEmailVerification(email);
    } else {
      showToast("✅ Account created successfully!");
      await updateHeaderAuth();
      const authSection = document.getElementById("authSection");
      if (authSection) authSection.style.display = 'none';
      setView("home");
      await renderAll();
    }
  } catch (error) {
    console.error("Sign up error:", error);
    let errorMsg = error.message || "Unknown error";
    showToast("Sign up error: " + errorMsg);
  }
});

// Email verification function
function showEmailVerification(email) {
  const authBodyCreate = document.getElementById("authBodyCreate");
  if (!authBodyCreate) return;
  
  authBodyCreate.innerHTML = `
    <div style="text-align: center; padding: 1rem;">
      <div style="font-size: 3rem; margin-bottom: 1rem;">📧</div>
      <h3 style="margin: 0 0 0.5rem 0; color: var(--text-main);">Check Your Email</h3>
      <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
        We sent a 6-digit code to<br><strong>${email}</strong>
      </p>
      
      <div class="field">
        <label for="verificationCode">Enter Verification Code</label>
        <input 
          id="verificationCode" 
          type="text" 
          placeholder="000000" 
          maxlength="6" 
          pattern="[0-9]{6}"
          style="font-size: 1.5rem; text-align: center; letter-spacing: 0.5em; padding: 1rem; font-family: monospace;"
        />
      </div>
      
      <button class="btn btn-primary" id="verifyEmailButton" style="width: 100%; padding: 0.9rem; font-size: 1rem; margin-top: 1rem;">
        Verify Email
      </button>
      
      <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
        Didn't receive the code? <span class="linkish" id="resendCodeBtn">Resend</span>
      </p>
    </div>
  `;
  
  // Add verification button listener
  document.getElementById("verifyEmailButton").addEventListener("click", async () => {
    const code = document.getElementById("verificationCode").value.trim();
    if (!code || code.length !== 6) {
      showToast("Please enter the 6-digit code.");
      return;
    }
    
    try {
      const result = await window.hustlAPI.auth.verifyEmail(email, code);
      showToast("✅ Email verified successfully!");
      
      // Update header immediately
      await updateHeaderAuth();
      
      // Hide auth section
      const authSection = document.getElementById("authSection");
      if (authSection) authSection.style.display = 'none';
      
      // Close auth modal if open
      if (window.closeAuthModal && typeof window.closeAuthModal === 'function') {
        window.closeAuthModal();
      }
      
      // Redirect to profile (logged-in dashboard) - NOT home
      if (window.setView && typeof window.setView === 'function') {
        window.setView("profile");
      } else {
        setView("profile");
      }
      await renderAll();
    } catch (error) {
      showToast("Invalid code. Please try again.");
    }
  });
  
  // Add resend button listener
  document.getElementById("resendCodeBtn").addEventListener("click", async () => {
    try {
      await window.hustlAPI.auth.resendVerification(email);
      showToast("New code sent! Check your email.");
    } catch (error) {
      showToast("Could not resend code. Please try again.");
    }
  });
}

// Show verification success screen with options
window.showVerificationSuccess = function() {
  const authBodyCreate = document.getElementById("authBodyCreate");
  if (!authBodyCreate) {
    // If auth section is hidden, show a modal instead
    window.showWelcomeModal();
    return;
  }
  
  authBodyCreate.innerHTML = `
    <div style="text-align: center; padding: 1.5rem;">
      <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 2.5rem;">✓</span>
      </div>
      
      <h2 style="margin: 0 0 0.5rem 0; color: var(--success); font-size: 1.5rem;">
        🎉 Verification Successful!
      </h2>
      
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; line-height: 1.5;">
        Congratulations! Your email is verified and your account is ready to go.
      </p>
      
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 1rem; margin: 1rem 0; border: 1px solid #f59e0b;">
        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #92400e;">💡 Want to earn money?</p>
        <p style="margin: 0; font-size: 0.9rem; color: #78350f;">
          Connect your Stripe account to apply for jobs and get paid instantly!
        </p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem;">
        <button class="btn btn-primary" onclick="goToStripeSetup()" style="padding: 1rem; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
          <span>💳</span> Connect Stripe & Start Earning
        </button>
        
        <button class="btn btn-ghost" onclick="startExploring()" style="padding: 0.875rem; font-size: 1rem;">
          Browse Jobs First →
        </button>
      </div>
      
      <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted);">
        You can always connect Stripe later in your Profile
      </p>
    </div>
  `;
};

// Show welcome modal (for when auth section is hidden)
window.showWelcomeModal = function() {
  // Create modal overlay
  const modal = document.createElement('div');
  modal.id = 'welcomeModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; max-width: 400px; width: 100%; padding: 2rem; text-align: center; animation: slideUp 0.3s ease;">
      <div style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 2.5rem; color: white;">✓</span>
      </div>
      
      <h2 style="margin: 0 0 0.5rem 0; color: #059669; font-size: 1.5rem;">
        🎉 Verification Successful!
      </h2>
      
      <p style="color: #64748b; margin-bottom: 1.5rem; line-height: 1.5;">
        Congratulations! Your account is ready. What would you like to do?
      </p>
      
      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 1rem; margin: 1rem 0; border: 1px solid #f59e0b;">
        <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #92400e;">💡 Want to earn money?</p>
        <p style="margin: 0; font-size: 0.9rem; color: #78350f;">
          Connect Stripe to apply for jobs and get paid instantly!
        </p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1.5rem;">
        <button class="btn btn-primary" onclick="goToStripeSetup(); closeWelcomeModal();" style="padding: 1rem; font-size: 1rem; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
          <span>💳</span> Connect Stripe & Start Earning
        </button>
        
        <button class="btn" onclick="startExploring(); closeWelcomeModal();" style="padding: 0.875rem; font-size: 1rem; background: white; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
          Browse Jobs First →
        </button>
      </div>
      
      <p style="margin-top: 1rem; font-size: 0.8rem; color: #94a3b8;">
        You can connect Stripe anytime in your Profile
      </p>
    </div>
  `;
  
  document.body.appendChild(modal);
};

window.closeWelcomeModal = function() {
  const modal = document.getElementById('welcomeModal');
  if (modal) modal.remove();
};

window.goToStripeSetup = function() {
  window.closeWelcomeModal();
  if (typeof setView === 'function') setView('profile');
  if (typeof renderAll === 'function') renderAll();
  // Scroll to Stripe section after a short delay
  setTimeout(() => {
    const stripeSection = document.getElementById('stripeConnectSection');
    if (stripeSection) {
      stripeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 300);
};

window.startExploring = function() {
  window.closeWelcomeModal();
  if (typeof setView === 'function') setView('jobs');
  if (typeof renderAll === 'function') renderAll();
};

// Change Password Modal
function showChangePasswordModal() {
  const modal = document.createElement('div');
  modal.id = 'changePasswordModal';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
  
  modal.innerHTML = `
    <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0; font-size: 1.5rem;">🔑 Change Password</h2>
        <button id="closeChangePasswordModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
      </div>
      
      <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
        Enter your current password and choose a new one. Your new password must be at least 8 characters.
      </p>
      
      <div class="field" style="margin-bottom: 1rem;">
        <label for="currentPassword">Current Password</label>
        <input id="currentPassword" type="password" placeholder="Enter current password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" />
      </div>
      
      <div class="field" style="margin-bottom: 1rem;">
        <label for="newPassword">New Password</label>
        <input id="newPassword" type="password" placeholder="At least 8 characters" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" />
      </div>
      
      <div class="field" style="margin-bottom: 1.5rem;">
        <label for="confirmPassword">Confirm New Password</label>
        <input id="confirmPassword" type="password" placeholder="Re-enter new password" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px;" />
      </div>
      
      <div style="display: flex; gap: 0.75rem;">
        <button class="btn btn-ghost" id="cancelChangePassword" style="flex: 1;">Cancel</button>
        <button class="btn btn-primary" id="submitChangePassword" style="flex: 1;">Change Password</button>
      </div>
      
      <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <button class="btn btn-ghost" id="forgotPasswordBtn" style="width: 100%; font-size: 0.9rem; color: var(--primary);">
          📧 Forgot password? Send reset email
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  
  // Close handlers
  const closeModal = () => {
    modal.remove();
    document.body.style.overflow = '';
  };
  
  modal.querySelector('#closeChangePasswordModal').addEventListener('click', closeModal);
  modal.querySelector('#cancelChangePassword').addEventListener('click', closeModal);
  modal.querySelector('#forgotPasswordBtn').addEventListener('click', async () => {
    try {
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user || !user.email) {
        showToast("Unable to find your email. Please contact support.");
        return;
      }
      
      // Call password reset endpoint (if it exists)
      const token = localStorage.getItem('hustl_token');
      const response = await fetch('/auth/forgot-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        body: JSON.stringify({ email: user.email })
      });
      
      if (response.ok) {
        showToast("✅ Password reset email sent! Check your inbox.");
        closeModal();
      } else {
        showToast("Could not send reset email. Please try again later.");
      }
    } catch (error) {
      showToast("Error sending reset email. Please contact support.");
    }
  });
  
  // Submit handler
  modal.querySelector('#submitChangePassword').addEventListener('click', async () => {
    const currentPassword = modal.querySelector('#currentPassword').value;
    const newPassword = modal.querySelector('#newPassword').value;
    const confirmPassword = modal.querySelector('#confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
      showToast("Please fill in all fields.");
      return;
    }
    
    if (newPassword.length < 8) {
      showToast("New password must be at least 8 characters.");
      return;
    }
    
    if (newPassword !== confirmPassword) {
      showToast("New passwords don't match.");
      return;
    }
    
    if (currentPassword === newPassword) {
      showToast("New password must be different from current password.");
      return;
    }
    
    try {
      const token = localStorage.getItem('hustl_token');
      const response = await fetch('/auth/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          currentPassword,
          newPassword
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || data.message || 'Failed to change password');
      }
      
      showToast("✅ Password changed successfully!");
      closeModal();
    } catch (error) {
      showToast("Error: " + (error.message || "Could not change password. Please try again."));
    }
  });
}

  document
    .getElementById("loginButton")
    .addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password =
        document.getElementById("loginPassword").value.trim();
      if (!email || !password)
        return showToast("Enter email and password.");

      try {
        const result = await window.hustlAPI.auth.signIn(email, password);
        showToast("✅ Logged in successfully!");
        
        // Update header immediately
        await updateHeaderAuth();
        
        // Hide auth section
        const authSection = document.getElementById("authSection");
        if (authSection) authSection.style.display = 'none';
        
        // Close auth modal if open
        if (window.closeAuthModal && typeof window.closeAuthModal === 'function') {
          window.closeAuthModal();
        }
        
        // Redirect to profile (logged-in dashboard) - NOT home
        if (window.setView && typeof window.setView === 'function') {
          window.setView("profile");
        } else {
          setView("profile");
        }
        await renderAll();
      } catch (error) {
        showToast("Login error: " + (error.message || "Unknown error"));
      }
    });
}

    /* ---------- Jobs ---------- */

    function clearJobForm() {
      document.getElementById("jobTitle").value = "";
      document.getElementById("jobCategory").value = "";
      document.getElementById("jobDescription").value = "";
      document.getElementById("pickupArea").value = "";
      document.getElementById("pickupCity").value = "";
      document.getElementById("pickupZip").value = "";
      document.getElementById("pickupAddress").value = "";
      document.getElementById("jobOnSiteOnly").checked = false;
      document.getElementById("dropoffArea").value = "";
      document.getElementById("dropoffCity").value = "";
      document.getElementById("dropoffZip").value = "";
      document.getElementById("dropoffAddress").value = "";
      if (document.getElementById("pricingOption")) {
        document.getElementById("pricingOption").value = "set_price";
      }
      document.getElementById("paymentType").value = "flat";
      document.getElementById("flatAmount").value = "80";
      document.getElementById("hourlyRate").value = "20";
      document.getElementById("maxHours").value = "3";
      document.getElementById("jobNotes").value = "";
      document.getElementById("jobPhoto").value = "";
      if (document.getElementById("priceSettingFields")) {
        document.getElementById("priceSettingFields").style.display = "block";
      }
      if (document.getElementById("hustlersQuoteNote")) {
        document.getElementById("hustlersQuoteNote").style.display = "none";
      }
      document.getElementById("flatAmountField").style.display = "block";
      document.getElementById("hourlyFields").style.display = "none";
      document.getElementById("dropoffFields").style.display = "block";
      
      // Reset new fields
      if (document.getElementById("customCategory")) {
        document.getElementById("customCategory").value = "";
        document.getElementById("customCategoryField").style.display = "none";
      }
      if (document.getElementById("workersNeeded")) {
        document.getElementById("workersNeeded").value = "1";
      }
      if (document.getElementById("customEquipment")) {
        document.getElementById("customEquipment").value = "";
        document.getElementById("customEquipmentField").style.display = "none";
        document.getElementById("customEquipmentToggle").checked = false;
      }
      // Reset equipment section
      const equipmentContent = document.getElementById("equipmentContent");
      const equipmentToggleIcon = document.getElementById("equipmentToggleIcon");
      if (equipmentContent) equipmentContent.style.display = "none";
      if (equipmentToggleIcon) equipmentToggleIcon.style.transform = "rotate(0deg)";
      
      // Reset equipment checkboxes
      document.querySelectorAll('input[name="equipment"]').forEach(cb => {
        cb.checked = false;
        const label = cb.closest('.equipment-checkbox');
        if (label) {
          label.style.background = '#fff';
          label.style.borderColor = 'var(--border)';
        }
      });
      
      // Reset sub-tags
      const subTagsContainer = document.getElementById("subTagsContainer");
      const subTagsGrid = document.getElementById("subTagsGrid");
      if (subTagsContainer) subTagsContainer.style.display = "none";
      if (subTagsGrid) subTagsGrid.innerHTML = "";
    }
    // Initialize Mapbox Places Autocomplete
    async function initMapboxAutocomplete() {
      // Always try to fetch from backend first (Railway environment variable)
      let MAPBOX_TOKEN = '';
      
      try {
        const response = await fetch(`${API_BASE}/jobs/mapbox-token`);
        if (response.ok) {
          const data = await response.json();
          MAPBOX_TOKEN = data.token;
          console.log('✅ Mapbox token loaded from backend');
        } else {
          console.warn('⚠️ Could not fetch Mapbox token from backend:', response.status);
        }
      } catch (e) {
        console.warn('⚠️ Could not fetch Mapbox token from backend:', e);
      }
      
      // Fallback to config or window variable
      if (!MAPBOX_TOKEN) {
        MAPBOX_TOKEN = window.HUSTL_CONFIG?.MAPBOX_TOKEN || window.MAPBOX_TOKEN || '';
        if (MAPBOX_TOKEN) {
          console.log('✅ Mapbox token loaded from frontend config');
        }
      }
      
      if (!MAPBOX_TOKEN) {
        console.warn('❌ Mapbox token not configured. Address autocomplete will not work.');
        console.warn('💡 Make sure MAPBOX_TOKEN is set in Railway environment variables.');
        return;
      }
      
      // Store token globally for map initialization
      window.MAPBOX_TOKEN = MAPBOX_TOKEN;
      
      // Helper function to extract address components from Mapbox result
      function extractAddressComponents(feature) {
        const context = feature.context || [];
        let zip = null;
        let city = null;
        let state = null;
        let neighborhood = null;
        let street = feature.text || '';
        
        for (const item of context) {
          const id = item.id || '';
          if (id.startsWith('postcode')) {
            zip = item.text;
          } else if (id.startsWith('place')) {
            city = item.text;
          } else if (id.startsWith('region')) {
            state = item.text;
          } else if (id.startsWith('neighborhood') || id.startsWith('locality')) {
            neighborhood = item.text;
          }
        }
        
        return { street, city, state, zip, neighborhood, fullAddress: feature.place_name };
      }
      
      // Initialize pickup address autocomplete
      const pickupAddressInput = document.getElementById('pickupAddress');
      if (pickupAddressInput && typeof MapboxGeocoder !== 'undefined') {
        // Create a container for the geocoder (it will replace the input)
        const pickupContainer = document.createElement('div');
        pickupContainer.id = 'pickupAddressContainer';
        pickupContainer.style.cssText = 'position: relative; width: 100%;';
        pickupAddressInput.parentNode.insertBefore(pickupContainer, pickupAddressInput);
        pickupAddressInput.style.display = 'none'; // Hide original input
        
        const pickupGeocoder = new MapboxGeocoder({
          accessToken: MAPBOX_TOKEN,
          types: 'address',
          countries: 'us',
          bbox: [-90.3, 34.98, -81.65, 36.68], // Tennessee bounding box (west, south, east, north)
          placeholder: 'Start typing address...',
          proximity: { longitude: -86.7816, latitude: 36.1627 }, // Nashville center
        });
        
        pickupGeocoder.addTo('#pickupAddressContainer');
        
        pickupGeocoder.on('result', (e) => {
          const feature = e.result;
          const [lng, lat] = feature.center;
          const components = extractAddressComponents(feature);
          
          // Store coordinates
          const latInput = document.getElementById('pickupLat');
          const lngInput = document.getElementById('pickupLng');
          if (latInput) latInput.value = lat;
          if (lngInput) lngInput.value = lng;
          
          // Autofill fields - update the hidden input and visible fields
          if (components.street) {
            pickupAddressInput.value = components.street;
          }
          if (components.neighborhood) {
            const areaInput = document.getElementById('pickupArea');
            if (areaInput) areaInput.value = components.neighborhood;
          }
          if (components.city) {
            const cityInput = document.getElementById('pickupCity');
            if (cityInput) cityInput.value = components.city + (components.state ? ', ' + components.state : '');
          }
          if (components.zip) {
            const zipInput = document.getElementById('pickupZip');
            if (zipInput) zipInput.value = components.zip;
          }
        });
        
        // Handle clear event
        pickupGeocoder.on('clear', () => {
          pickupAddressInput.value = '';
          document.getElementById('pickupLat').value = '';
          document.getElementById('pickupLng').value = '';
        });
      }
      
      // Initialize dropoff address autocomplete
      const dropoffAddressInput = document.getElementById('dropoffAddress');
      if (dropoffAddressInput && typeof MapboxGeocoder !== 'undefined') {
        // Create a container for the geocoder (it will replace the input)
        const dropoffContainer = document.createElement('div');
        dropoffContainer.id = 'dropoffAddressContainer';
        dropoffContainer.style.cssText = 'position: relative; width: 100%;';
        dropoffAddressInput.parentNode.insertBefore(dropoffContainer, dropoffAddressInput);
        dropoffAddressInput.style.display = 'none'; // Hide original input
        
        const dropoffGeocoder = new MapboxGeocoder({
          accessToken: MAPBOX_TOKEN,
          types: 'address',
          countries: 'us',
          bbox: [-90.3, 34.98, -81.65, 36.68], // Tennessee bounding box (west, south, east, north)
          placeholder: 'Start typing address...',
          proximity: { longitude: -86.7816, latitude: 36.1627 }, // Nashville center
        });
        
        dropoffGeocoder.addTo('#dropoffAddressContainer');
        
        dropoffGeocoder.on('result', (e) => {
          const feature = e.result;
          const [lng, lat] = feature.center;
          const components = extractAddressComponents(feature);
          
          // Store coordinates
          const latInput = document.getElementById('dropoffLat');
          const lngInput = document.getElementById('dropoffLng');
          if (latInput) latInput.value = lat;
          if (lngInput) lngInput.value = lng;
          
          // Autofill fields - update the hidden input and visible fields
          if (components.street) {
            dropoffAddressInput.value = components.street;
          }
          if (components.neighborhood) {
            const areaInput = document.getElementById('dropoffArea');
            if (areaInput) areaInput.value = components.neighborhood;
          }
          if (components.city) {
            const cityInput = document.getElementById('dropoffCity');
            if (cityInput) cityInput.value = components.city + (components.state ? ', ' + components.state : '');
          }
          if (components.zip) {
            const zipInput = document.getElementById('dropoffZip');
            if (zipInput) zipInput.value = components.zip;
          }
        });
        
        // Handle clear event
        dropoffGeocoder.on('clear', () => {
          dropoffAddressInput.value = '';
          document.getElementById('dropoffLat').value = '';
          document.getElementById('dropoffLng').value = '';
        });
      }
    }
    
    function initJobsForm() {
      const jobOnSiteOnly = document.getElementById("jobOnSiteOnly");
      const dropoffFields = document.getElementById("dropoffFields");
      jobOnSiteOnly.addEventListener("change", () => {
        const isChecked = jobOnSiteOnly.checked;
        dropoffFields.style.display = isChecked ? "none" : "block";
        // Update required attribute on dropoff address
        const dropoffAddressInput = document.getElementById("dropoffAddress");
        if (dropoffAddressInput) {
          dropoffAddressInput.required = !isChecked;
        }
      });
      
      // Initialize Mapbox autocomplete after form is ready
      // Also ensure token is loaded for maps
      setTimeout(async () => {
        await initMapboxAutocomplete();
        // If token wasn't loaded yet, try to initialize mapboxgl
        if (window.MAPBOX_TOKEN && window.mapboxgl) {
          mapboxgl.accessToken = window.MAPBOX_TOKEN;
        }
      }, 500);

      // Pricing option toggle
      const pricingOptionSelect = document.getElementById("pricingOption");
      const priceSettingFields = document.getElementById("priceSettingFields");
      const hustlersQuoteNote = document.getElementById("hustlersQuoteNote");
      if (pricingOptionSelect && priceSettingFields && hustlersQuoteNote) {
        pricingOptionSelect.addEventListener("change", () => {
          if (pricingOptionSelect.value === "set_price") {
            priceSettingFields.style.display = "block";
            hustlersQuoteNote.style.display = "none";
          } else {
            priceSettingFields.style.display = "none";
            hustlersQuoteNote.style.display = "block";
          }
        });
      }
      
      const paymentTypeSelect = document.getElementById("paymentType");
      const flatField = document.getElementById("flatAmountField");
      const hourlyFields = document.getElementById("hourlyFields");
      const hourlyRateCalculation = document.getElementById("hourlyRateCalculation");
      
      // Update hourly rate calculation when rate, hours, or workers change
      function updateHourlyRateCalculation() {
        if (!hourlyRateCalculation || !paymentTypeSelect || paymentTypeSelect.value !== "hourly") {
          if (hourlyRateCalculation) hourlyRateCalculation.style.display = "none";
          return;
        }
        const hourlyRate = parseFloat(document.getElementById("hourlyRate")?.value || 0);
        const workersNeeded = document.getElementById("workersNeeded");
        let workersCount = 1;
        if (workersNeeded) {
          const workersValue = workersNeeded.value;
          if (workersValue === "custom") {
            workersCount = parseInt(document.getElementById("customWorkersCount")?.value || 1);
          } else if (workersValue === "company") {
            workersCount = 0; // Company option - don't calculate hourly rate
            hourlyRateCalculation.style.display = "none";
            return;
          } else {
            workersCount = parseInt(workersValue || 1);
          }
        }
        if (workersCount > 0 && hourlyRate > 0) {
          // hourlyRate is now the TOTAL rate, not per person
          const totalRate = hourlyRate; // Total rate entered by user
          const perPersonRate = totalRate / workersCount; // Calculate per person
          const exampleWorkers = document.getElementById("exampleWorkers");
          const examplePerPerson = document.getElementById("examplePerPerson");
          
          if (exampleWorkers) exampleWorkers.textContent = workersCount;
          if (examplePerPerson) examplePerPerson.textContent = perPersonRate.toFixed(workersCount > 1 ? 2 : 0);
          
          hourlyRateCalculation.style.display = "block";
        } else {
          hourlyRateCalculation.style.display = "none";
        }
      }
      
      if (paymentTypeSelect && flatField && hourlyFields) {
        paymentTypeSelect.addEventListener("change", () => {
          if (paymentTypeSelect.value === "flat") {
            flatField.style.display = "block";
            hourlyFields.style.display = "none";
            if (hourlyRateCalculation) hourlyRateCalculation.style.display = "none";
          } else {
            flatField.style.display = "none";
            hourlyFields.style.display = "grid";
            if (hourlyRateCalculation) hourlyRateCalculation.style.display = "block";
            updateHourlyRateCalculation();
          }
        });
      }
      
      // Add event listeners for hourly rate calculation
      const hourlyRateInput = document.getElementById("hourlyRate");
      const workersNeededSelect = document.getElementById("workersNeeded");
      const customWorkersInput = document.getElementById("customWorkersCount");
      if (hourlyRateInput) hourlyRateInput.addEventListener("input", updateHourlyRateCalculation);
      if (workersNeededSelect) {
        workersNeededSelect.addEventListener("change", () => {
          updateHourlyRateCalculation();
        });
      }
      if (customWorkersInput) customWorkersInput.addEventListener("input", updateHourlyRateCalculation);
      
      // Custom date selection - show immediately when selected
      const jobWhenSelect = document.getElementById("jobWhen");
      const customDateFields = document.getElementById("customDateFields");
      const flexibleDeadlineNote = document.getElementById("flexibleDeadlineNote");
      if (jobWhenSelect) {
        jobWhenSelect.addEventListener("change", () => {
          const todayAsapNote = document.getElementById("todayAsapNote");
          const tomorrowNote = document.getElementById("tomorrowNote");
          
          if (jobWhenSelect.value === "specific_date") {
            if (customDateFields) customDateFields.style.display = "block";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
            // Focus on date input immediately
            setTimeout(() => {
              const customDateInput = document.getElementById("customDate");
              if (customDateInput) customDateInput.focus();
            }, 100);
          } else if (jobWhenSelect.value === "today_asap") {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "block";
            if (tomorrowNote) tomorrowNote.style.display = "none";
          } else if (jobWhenSelect.value === "tomorrow") {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "block";
          } else if (jobWhenSelect.value === "flexible_week") {
            if (customDateFields) customDateFields.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
            if (flexibleDeadlineNote) {
              flexibleDeadlineNote.style.display = "block";
              const noteText = document.getElementById("flexibleDeadlineNoteText");
              if (noteText) {
                noteText.innerHTML = '<strong>⏰ Flexible (This Week):</strong> This job will stay active for 7 days after posting.';
              }
            }
          } else if (jobWhenSelect.value === "no_deadline") {
            if (customDateFields) customDateFields.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
            if (flexibleDeadlineNote) {
              flexibleDeadlineNote.style.display = "block";
              const noteText = document.getElementById("flexibleDeadlineNoteText");
              if (noteText) {
                noteText.innerHTML = '<strong>⏰ Flexible Deadline:</strong> This job will stay active until someone completes it. No rush!';
              }
            }
          } else {
            if (customDateFields) customDateFields.style.display = "none";
            if (flexibleDeadlineNote) flexibleDeadlineNote.style.display = "none";
            if (todayAsapNote) todayAsapNote.style.display = "none";
            if (tomorrowNote) tomorrowNote.style.display = "none";
          }
          
          // Auto-set keepActiveFor based on When selection
          const jobDurationField = document.getElementById("jobDurationField");
          const jobDurationSelect = document.getElementById("jobDuration");
          if (jobDurationSelect) {
            if (jobWhenSelect.value === "today_asap") {
              jobDurationSelect.value = "1"; // 1 day for today
            } else if (jobWhenSelect.value === "tomorrow") {
              jobDurationSelect.value = "1"; // 1 day for tomorrow
            } else if (jobWhenSelect.value === "flexible_week") {
              jobDurationSelect.value = "7"; // 1 week
            } else if (jobWhenSelect.value === "no_deadline") {
              jobDurationSelect.value = "30"; // 1 month
            } else {
              jobDurationSelect.value = "3"; // Default 3 days
            }
          }
        });
      }

      // Sub-tags data based on category
      const subTagsData = {
        'power-washing': ['Siding', 'Driveway', 'Roof', 'Deck', 'Patio', 'Fence'],
        'yard-work': ['Mowing', 'Leaf Removal', 'Weeding', 'Trimming', 'Edging'],
        'landscaping': ['Planting', 'Garden Bed', 'Rock/Stone', 'Sod'],
        'snow-removal': ['Driveway', 'Sidewalk', 'Salting'],
        'moving': ['Full Move', 'Load Only', 'Unload Only', 'Packing Help'],
        'dump-run': ['Furniture', 'Yard Waste', 'Construction', 'Appliances'],
        'cleaning': ['Deep Clean', 'Move-out', 'Organizing', 'Regular'],
        'furniture-assembly': ['IKEA', 'Bed Frame', 'Shelving', 'Desk'],
        'painting': ['Interior', 'Exterior', 'Fence', 'Deck'],
        'handyman': ['Repairs', 'Mounting', 'Drywall', 'Plumbing'],
        'car-cleaning': ['Exterior', 'Interior', 'Full Detail'],
        'pet-care': ['Walking', 'Sitting', 'Transport'],
        'delivery': ['Pickup', 'Drop-off', 'Store Run'],
        'event-setup': ['Tables/Chairs', 'Tent', 'Cleanup'],
      };

      // Category names for display
      const categoryNames = {
        'moving': '🚚 Moving / Hauling',
        'yard-work': '🌿 Yard Work',
        'dump-run': '🗑️ Dump Run',
        'cleaning': '🧹 Cleaning',
        'power-washing': '💦 Power Washing',
        'furniture-assembly': '🔧 Furniture Assembly',
        'painting': '🎨 Painting',
        'handyman': '🔨 Handyman',
        'landscaping': '🌳 Landscaping',
        'pet-care': '🐕 Pet Care',
        'delivery': '🚚 Delivery',
        'car-cleaning': '🚿 Car Cleaning',
        'event-setup': '🎪 Event Setup',
        'snow-removal': '❄️ Snow Removal',
        'other': '✨ Other'
      };

      // Category chip selection handler
      const jobCategory = document.getElementById("jobCategory");
      const customCategoryField = document.getElementById("customCategoryField");
      const subTagsContainer = document.getElementById("subTagsContainer");
      const subTagsGrid = document.getElementById("subTagsGrid");
      const selectedCategoryDisplay = document.getElementById("selectedCategoryDisplay");
      const selectedCategoryText = document.getElementById("selectedCategoryText");
      const categoryChips = document.getElementById("categoryChips");
      const moreCategoriesSection = document.getElementById("moreCategoriesSection");
      const showMoreCategoriesBtn = document.getElementById("showMoreCategoriesBtn");
      const allCategoriesGrid = document.getElementById("allCategoriesGrid");
      const changeCategoryBtn = document.getElementById("changeCategoryBtn");

      // Handle "See all categories" toggle
      if (showMoreCategoriesBtn && allCategoriesGrid) {
        showMoreCategoriesBtn.addEventListener("click", () => {
          const isHidden = allCategoriesGrid.style.display === "none";
          allCategoriesGrid.style.display = isHidden ? "block" : "none";
          showMoreCategoriesBtn.textContent = isHidden ? "− Show less" : "+ See all categories";
        });
      }

      // Handle category chip clicks
      function selectCategory(value) {
        // Update hidden select
        if (jobCategory) jobCategory.value = value;
        
        // Hide chips, show selected
        if (categoryChips) categoryChips.style.display = "none";
        if (moreCategoriesSection) moreCategoriesSection.style.display = "none";
        if (selectedCategoryDisplay) {
          selectedCategoryDisplay.style.display = "block";
          if (selectedCategoryText) {
            selectedCategoryText.textContent = categoryNames[value] || value;
          }
        }
        
        // Show/hide custom category field
        if (customCategoryField) {
          customCategoryField.style.display = value === "other" ? "block" : "none";
        }
        
        // Show sub-tags if available
        if (subTagsContainer && subTagsGrid) {
          const tags = subTagsData[value];
          if (tags && tags.length > 0) {
            subTagsGrid.innerHTML = tags.map(tag => `
              <label class="sub-tag-chip" style="display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 0.75rem; background: #fff; border: 1.5px solid var(--border); border-radius: 999px; cursor: pointer; transition: all 0.2s; font-size: 0.85rem;">
                <input type="checkbox" name="subTags" value="${tag.toLowerCase().replace(/\s+/g, '-')}" style="display: none;" />
                <span>${tag}</span>
              </label>
            `).join('');
            subTagsContainer.style.display = "block";
            
            // Add toggle effect for sub-tag chips
            subTagsGrid.querySelectorAll('.sub-tag-chip').forEach(chip => {
              chip.addEventListener('click', () => {
                const cb = chip.querySelector('input');
                cb.checked = !cb.checked;
                if (cb.checked) {
                  chip.style.background = 'var(--primary-soft)';
                  chip.style.borderColor = 'var(--primary)';
                  chip.style.color = 'var(--primary)';
                } else {
                  chip.style.background = '#fff';
                  chip.style.borderColor = 'var(--border)';
                  chip.style.color = 'inherit';
                }
              });
            });
          } else {
            subTagsContainer.style.display = "none";
            subTagsGrid.innerHTML = "";
          }
        }
      }

      // Handle change category button
      if (changeCategoryBtn) {
        changeCategoryBtn.addEventListener("click", () => {
          if (categoryChips) categoryChips.style.display = "flex";
          if (moreCategoriesSection) moreCategoriesSection.style.display = "block";
          if (selectedCategoryDisplay) selectedCategoryDisplay.style.display = "none";
          if (subTagsContainer) subTagsContainer.style.display = "none";
          if (customCategoryField) customCategoryField.style.display = "none";
          if (jobCategory) jobCategory.value = "";
        });
      }

      // Add click handlers to all category chips
      document.querySelectorAll('.category-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          selectCategory(chip.dataset.value);
        });
      });

      // Equipment section toggle
      const equipmentToggle = document.getElementById("equipmentToggle");
      const equipmentContent = document.getElementById("equipmentContent");
      const equipmentToggleIcon = document.getElementById("equipmentToggleIcon");
      if (equipmentToggle && equipmentContent) {
        equipmentToggle.addEventListener("click", () => {
          const isOpen = equipmentContent.style.display !== "none";
          equipmentContent.style.display = isOpen ? "none" : "block";
          equipmentToggleIcon.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
        });
      }

      // Custom equipment toggle
      const customEquipmentToggle = document.getElementById("customEquipmentToggle");
      const customEquipmentField = document.getElementById("customEquipmentField");
      if (customEquipmentToggle && customEquipmentField) {
        customEquipmentToggle.addEventListener("change", () => {
          customEquipmentField.style.display = customEquipmentToggle.checked ? "block" : "none";
        });
      }
      
      // Workers needed - handle custom and my_team options
      const workersNeededSelect2 = document.getElementById("workersNeeded");
      const customWorkersField = document.getElementById("customWorkersField");
      if (workersNeededSelect2 && customWorkersField) {
        workersNeededSelect2.addEventListener("change", () => {
          if (workersNeededSelect2.value === "custom") {
            customWorkersField.style.display = "block";
          } else {
            customWorkersField.style.display = "none";
          }
          // Also update hourly rate calculation when workers change
          if (typeof updateHourlyRateCalculation === 'function') {
            updateHourlyRateCalculation();
          }
        });
      }

      // Equipment checkbox hover effects
      document.querySelectorAll('.equipment-checkbox').forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              label.style.background = 'var(--primary-soft)';
              label.style.borderColor = 'var(--primary)';
            } else {
              label.style.background = '#fff';
              label.style.borderColor = 'var(--border)';
            }
          });
        }
      });

      document
        .getElementById("postJobButton")
        .addEventListener("click", async () => {
          const user = await window.hustlAPI.auth.getCurrentUser();
          if (!user)
            return showToast("Please log in to post a job.");

          const title = document.getElementById("jobTitle").value.trim();
          const category = document.getElementById("jobCategory").value;
          const desc = document.getElementById("jobDescription").value.trim();
          const pickupArea = document
            .getElementById("pickupArea")
            .value.trim();
          const pickupCity = document
            .getElementById("pickupCity")
            .value.trim();
          const pickupZip = document
            .getElementById("pickupZip")
            .value.trim();
          const pickupAddress = document
            .getElementById("pickupAddress")
            .value.trim();
          const onSiteOnly =
            document.getElementById("jobOnSiteOnly").checked;
          const hideAddressUntilAssigned =
            document.getElementById("hideAddressUntilAssigned").checked;
          const dropoffArea = document
            .getElementById("dropoffArea")
            .value.trim();
          const dropoffCity = document
            .getElementById("dropoffCity")
            .value.trim();
          const dropoffZip = document
            .getElementById("dropoffZip")
            .value.trim();
          const dropoffAddress = onSiteOnly ? "" : document
            .getElementById("dropoffAddress")
            .value.trim();
          // Pricing option
          const pricingOption = document.getElementById("pricingOption")?.value || "set_price";
          
          let paymentType = null;
          let flatAmount = null;
          let hourlyRate = null;
          let maxHours = null;
          
          if (pricingOption === "set_price") {
            paymentType = document.getElementById("paymentType").value;
            flatAmount = Number(document.getElementById("flatAmount").value);
            hourlyRate = Number(document.getElementById("hourlyRate").value);
            maxHours = Number(document.getElementById("maxHours").value);
          } else {
            // If hustlers_quote, use default values (backend requires these fields)
            paymentType = 'flat';
            flatAmount = 50; // Default placeholder amount
            hourlyRate = null;
            maxHours = null;
          }
          
          const notes = document
            .getElementById("jobNotes")
            .value.trim();

          // Collect new fields
          const customCategory = document.getElementById("customCategory")?.value.trim() || "";
          const workersNeededValue = document.getElementById("workersNeeded")?.value || "1";
          let workersNeeded = 1;
          if (workersNeededValue === "custom") {
            const customCount = Number(document.getElementById("customWorkersCount")?.value || 1);
            workersNeeded = Math.max(1, Math.min(20, customCount));
          } else if (workersNeededValue === "company") {
            workersNeeded = 0; // Special value for "Company" (insured company/crew)
          } else {
            workersNeeded = Number(workersNeededValue) || 1;
          }
          const customEquipment = document.getElementById("customEquipment")?.value.trim() || "";
          
          // Collect keepActiveFor (jobDuration)
          const jobDuration = document.getElementById("jobDuration")?.value || "3";
          const keepActiveFor = parseInt(jobDuration) || 3; // Days to keep job active
          
          // Collect equipment checkboxes
          const equipmentNeeded = [];
          document.querySelectorAll('input[name="equipment"]:checked').forEach(cb => {
            equipmentNeeded.push(cb.value);
          });
          if (customEquipment) {
            equipmentNeeded.push(customEquipment);
          }

          // Collect sub-tags
          const subTags = [];
          document.querySelectorAll('input[name="subTags"]:checked').forEach(cb => {
            subTags.push(cb.value);
          });

          // Determine final category
          const finalCategory = category === "other" && customCategory ? customCategory : category;

          if (!title || !category || !desc)
            return showToast(
              "Please fill title, category, and description."
            );

          // Validate address fields
          if (!pickupCity || !pickupArea) {
            return showToast("Please fill in pickup location (city and area/neighborhood).");
          }
          if (!pickupZip) {
            return showToast("Please enter pickup ZIP code.");
          }
          if (!onSiteOnly && (!dropoffCity || !dropoffArea)) {
            return showToast("Please fill in dropoff location (city and area/neighborhood).");
          }
          if (!onSiteOnly && !dropoffZip) {
            return showToast("Please enter dropoff ZIP code.");
          }

          // Validate payment if set_price
          if (pricingOption === "set_price") {
            if (paymentType === "flat") {
              if (!flatAmount || flatAmount <= 0)
                return showToast("Flat amount must be > 0.");
            } else {
              if (!hourlyRate || hourlyRate <= 0 || !maxHours || maxHours <= 0)
                return showToast("Hourly rate and max hours must be valid.");
            }
          }

          try {
            // Build address string from pickup location
            const addressParts = [];
            if (pickupAddress) addressParts.push(pickupAddress);
            if (pickupCity) addressParts.push(pickupCity);
            if (pickupZip) addressParts.push(pickupZip);
            const address = addressParts.join(', ').trim();
            
            if (!address) {
              return showToast("Please provide a valid pickup address.");
            }
            
            // Build date/time based on user's "when" selection
            const jobWhen = document.getElementById("jobWhen")?.value || "today_asap";
            const now = new Date();
            let date, startTime, endTime, deadlinePreference;
            
            if (jobWhen === "no_deadline") {
              // No strict deadline - set far future date (1 year from now)
              const futureDate = new Date(now);
              futureDate.setFullYear(futureDate.getFullYear() + 1);
              date = futureDate.toISOString().split('T')[0];
              startTime = new Date(futureDate);
              startTime.setHours(9, 0, 0, 0);
              endTime = new Date(futureDate);
              endTime.setHours(17, 0, 0, 0);
              deadlinePreference = "no_deadline";
            } else if (jobWhen === "flexible_week") {
              // Flexible this week - set end of week
              const endOfWeek = new Date(now);
              endOfWeek.setDate(endOfWeek.getDate() + (7 - endOfWeek.getDay())); // Next Sunday
              date = endOfWeek.toISOString().split('T')[0];
              startTime = new Date(now);
              startTime.setHours(9, 0, 0, 0);
              endTime = new Date(endOfWeek);
              endTime.setHours(17, 0, 0, 0);
              deadlinePreference = "flexible_week";
            } else if (jobWhen === "specific_date") {
              const customDate = document.getElementById("customDate")?.value;
              const customTime = document.getElementById("customTime")?.value || "morning";
              if (!customDate) {
                return showToast("Please select a date for your specific deadline.");
              }
              date = customDate;
              const selectedDate = new Date(customDate);
              // Set time based on custom time selection
              if (customTime === "morning") {
                startTime = new Date(selectedDate);
                startTime.setHours(8, 0, 0, 0);
                endTime = new Date(selectedDate);
                endTime.setHours(12, 0, 0, 0);
              } else if (customTime === "afternoon") {
                startTime = new Date(selectedDate);
                startTime.setHours(12, 0, 0, 0);
                endTime = new Date(selectedDate);
                endTime.setHours(17, 0, 0, 0);
              } else if (customTime === "evening") {
                startTime = new Date(selectedDate);
                startTime.setHours(17, 0, 0, 0);
                endTime = new Date(selectedDate);
                endTime.setHours(21, 0, 0, 0);
              } else { // night
                startTime = new Date(selectedDate);
                startTime.setHours(21, 0, 0, 0);
                endTime = new Date(selectedDate);
                endTime.setHours(23, 0, 0, 0);
              }
              deadlinePreference = "specific_date";
            } else if (jobWhen === "tomorrow") {
              // Tomorrow - set to tomorrow with flexible time
              const targetDate = new Date(now);
              targetDate.setDate(targetDate.getDate() + 1);
              date = targetDate.toISOString().split('T')[0];
              startTime = new Date(targetDate);
              startTime.setHours(8, 0, 0, 0);
              endTime = new Date(targetDate);
              endTime.setHours(21, 0, 0, 0);
              deadlinePreference = "tomorrow";
            } else {
              // today_asap - set to today with ASAP timing
              date = now.toISOString().split('T')[0];
              startTime = new Date(now);
              startTime.setHours(now.getHours(), 0, 0, 0);
              endTime = new Date(now);
              endTime.setHours(23, 59, 59, 0);
              deadlinePreference = "today_asap";
            }
            
            // Ensure deadlinePreference is set
            if (!deadlinePreference) {
              deadlinePreference = jobWhen || "today_asap";
            }
            
            // Transform payment data to backend format
            const payType = paymentType || 'flat';
            let amount = 0;
            let hourlyRateValue = null;
            let estHoursValue = null;
            
            if (pricingOption === "set_price") {
              if (payType === 'flat') {
                amount = flatAmount; // Already in dollars
              } else {
                amount = hourlyRate * maxHours; // Total estimated amount
                hourlyRateValue = hourlyRate;
                estHoursValue = maxHours;
              }
            } else {
              // hustlers_quote - use placeholder amount (backend requires amount field)
              amount = 50; // Placeholder, hustlers will propose their own price
            }
            
            // Validate required fields
            if (!title || title.trim().length === 0) {
              return showToast("❌ Please enter a job title.");
            }
            
            if (!desc || desc.trim().length === 0) {
              return showToast("❌ Please enter a job description.");
            }
            
            if (!address || address.trim().length === 0) {
              return showToast("❌ Please enter a job address.");
            }
            
            if (!date) {
              return showToast("❌ Please select a job date.");
            }
            
            // Ensure amount is valid
            if (!amount || amount <= 0 || isNaN(amount)) {
              return showToast("❌ Please set a valid price amount.");
            }
            
            // Build job data - only include hourlyRate/estHours if they have values
            const jobData = {
              title,
              category: finalCategory,
              description: desc,
              address, // Backend expects single address
              date, // Backend expects ISO date string
              startTime: startTime.toISOString(), // Backend expects ISO datetime
              endTime: endTime.toISOString(), // Backend expects ISO datetime
              payType: payType, // Backend expects 'flat' or 'hourly'
              amount: amount, // Backend expects dollar amount (not cents)
              teamSize: workersNeeded || 1,
              keepActiveFor: keepActiveFor, // Days to keep job active
              requirements: {
                pickup_area: pickupArea,
                pickup_city: pickupCity,
                pickup_zip: pickupZip,
                pickup_address: pickupAddress,
                pickup_lat: document.getElementById('pickupLat')?.value || null,
                pickup_lng: document.getElementById('pickupLng')?.value || null,
                on_site_only: onSiteOnly,
                dropoff_area: onSiteOnly ? null : dropoffArea,
                dropoff_city: onSiteOnly ? null : dropoffCity,
                dropoff_zip: onSiteOnly ? null : dropoffZip,
                dropoff_address: onSiteOnly ? null : dropoffAddress,
                dropoff_lat: onSiteOnly ? null : (document.getElementById('dropoffLat')?.value || null),
                dropoff_lng: onSiteOnly ? null : (document.getElementById('dropoffLng')?.value || null),
                hide_address_until_assigned: hideAddressUntilAssigned, // Privacy setting
                equipment_needed: equipmentNeeded.length > 0 ? equipmentNeeded : null,
                sub_tags: subTags.length > 0 ? subTags : null,
                notes: notes || null,
                pricing_option: pricingOption, // Store for future use
                deadline_preference: deadlinePreference || jobWhen, // Store deadline preference
              },
            };
            
            // Only add hourlyRate and estHours if they have valid values
            if (hourlyRateValue && hourlyRateValue > 0) {
              jobData.hourlyRate = hourlyRateValue;
            }
            if (estHoursValue && estHoursValue > 0) {
              jobData.estHours = estHoursValue;
            }

            console.log("Posting job with data:", JSON.stringify(jobData, null, 2));
            let result;
            try {
              result = await window.hustlAPI.jobs.create(jobData);
              console.log("Job posted successfully:", result);
            } catch (error) {
              console.error("Full error object:", error);
              console.error("Error message:", error.message);
              console.error("Error stack:", error.stack);
              throw error;
            }

            // Show success message with details
            const successMessage = result?.message || "✅ Job posted successfully! Hustlers nearby will begin applying soon. Go to Manage Jobs to choose your favorite.";
            
            // Make button green and show congratulations popup
            const postButton = document.getElementById("postJobButton");
            if (postButton) {
              postButton.style.background = "#10b981";
              postButton.style.borderColor = "#10b981";
              postButton.textContent = "✅ Job Posted Successfully!";
              postButton.disabled = true;
              
              // Reset button after 5 seconds
              setTimeout(() => {
                postButton.style.background = "";
                postButton.style.borderColor = "";
                postButton.textContent = "Post job to Hustl";
                postButton.disabled = false;
              }, 5000);
            }
            
            // Show congratulations popup
            const congratsModal = document.createElement("div");
            congratsModal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.6);
              z-index: 10001;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 1rem;
            `;
            congratsModal.innerHTML = `
              <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text-main); margin: 0 0 0.5rem 0;">Congratulations!</h2>
                <p style="color: var(--text-muted); margin: 0 0 1.5rem 0; line-height: 1.6;">
                  Your job has been posted successfully! Hustlers nearby will begin applying soon.
                </p>
                <button onclick="
                  const modal = this.closest('div[style*=\"position: fixed\"]');
                  if (modal) modal.remove();
                  if (window.setView && typeof window.setView === 'function') {
                    window.setView('manage-jobs');
                  }
                " style="
                  padding: 0.75rem 2rem;
                  background: var(--primary);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-size: 1rem;
                  font-weight: 600;
                  cursor: pointer;
                ">Got it!</button>
              </div>
            `;
            document.body.appendChild(congratsModal);
            
            showToast(successMessage);
            
            // Show job stats on the post page
            if (result && result.id) {
              await showJobStats(result.id);
            }
            
            // Refresh the Manage Jobs view if it's loaded
            if (activeView === 'manage-jobs') {
              loadPostedJobs();
            }
            
            // Don't clear form or navigate - keep user on post page to see stats
            // clearJobForm();
            // setView("manage-jobs");
            
            // Also refresh jobs list
            renderJobs(true);
          } catch (error) {
            console.error("Post job error:", error);
            console.error("Error details:", error.message, error.stack);
            const errorMsg = error.message || "Unknown error";
            showToast("Failed to post job: " + errorMsg);
          }
        });
    }
    
    // Show Job Stats on Post Job Page
    async function showJobStats(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) return;
        
        // Fetch job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!jobResponse.ok) return;
        const job = await jobResponse.json();
        
        // Fetch offers/applicants
        let offerCount = 0;
        let pendingOffers = 0;
        try {
          const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (offersResponse.ok) {
            const offers = await offersResponse.json();
            offerCount = offers.length;
            pendingOffers = offers.filter(o => o.status === 'PENDING').length;
          }
        } catch (e) {
          console.error("Error fetching offers:", e);
        }
        
        // Show stats card
        const statsCard = document.getElementById('jobStatsCard');
        const statsContent = document.getElementById('jobStatsContent');
        if (!statsCard || !statsContent) return;
        
        statsCard.style.display = 'block';
        
        // Calculate time since posted
        const postedDate = new Date(job.createdAt);
        const hoursAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60));
        const timeAgo = hoursAgo < 1 ? 'Just now' : hoursAgo === 1 ? '1 hour ago' : `${hoursAgo} hours ago`;
        
        statsContent.innerHTML = `
          <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 12px;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--primary);">${offerCount}</div>
            <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem;">Total Applicants</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: #dbeafe; border-radius: 12px;">
            <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">${pendingOffers}</div>
            <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem;">Pending</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 12px;">
            <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${job.status || 'OPEN'}</div>
            <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem;">Status</div>
          </div>
          <div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 12px;">
            <div style="font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${timeAgo}</div>
            <div style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.25rem;">Posted</div>
          </div>
        `;
        
        // Auto-refresh stats every 30 seconds if job is still open
        if (job.status === 'OPEN' || job.status === 'REQUESTED') {
          setTimeout(() => {
            if (activeView === 'post') {
              showJobStats(jobId);
            }
          }, 30000);
        }
      } catch (error) {
        console.error("Error showing job stats:", error);
      }
    }

    
// Global filter state
let activeCategoryFilter = 'all';
let activeSortBy = 'newest';

async function renderJobs(reset = false) {
  console.log('🔵 NEW RENDERJOBS VERSION LOADED - v3.0');
  const jobsList = document.getElementById("jobsList");
  const jobsCardTitle = document.getElementById("jobsCardTitle");
  const jobsFilterSummary = document.getElementById("jobsFilterSummary");

  // Reset pagination if needed
  if (reset) {
    currentJobsPage = 1;
    allLoadedJobs = [];
    if (jobsList) jobsList.innerHTML = ""; // Clear existing jobs
  }
  
  // Fetch user's applied jobs to show "Applied" indicator
  let userAppliedJobIds = new Set();
  let userAppliedOffers = new Map(); // jobId -> offer object (for status checking)
  try {
    const token = localStorage.getItem('hustl_token');
    const user = await window.hustlAPI?.auth?.getCurrentUser();
    if (token && user) {
      const offersResponse = await fetch(`${API_BASE}/offers/user/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (offersResponse.ok) {
        const offers = await offersResponse.json();
        // Filter out DECLINED offers - only track PENDING and ACCEPTED
        const relevantOffers = offers.filter(offer => 
          offer.status === 'PENDING' || 
          (offer.status === 'ACCEPTED' && offer.job && (offer.job.status === 'SCHEDULED' || offer.job.status === 'ASSIGNED') && !offer.job.startCodeVerified)
        );
        userAppliedJobIds = new Set(relevantOffers.map(offer => offer.jobId).filter(Boolean));
        // Store offer details for status checking
        relevantOffers.forEach(offer => {
          if (offer.jobId) {
            userAppliedOffers.set(offer.jobId, offer);
          }
        });
        console.log("🔵 User has applied to jobs:", Array.from(userAppliedJobIds), "Total offers:", relevantOffers.length);
      }
    }
  } catch (e) {
    console.warn("Could not fetch user's applied jobs:", e);
  }

  try {
    // Get location filters
    const locationZipFilter = document.getElementById("locationZipFilter");
    const locationRadiusFilter = document.getElementById("locationRadiusFilter");
    const zip = locationZipFilter ? locationZipFilter.value.trim() : '';
    const radius = locationRadiusFilter ? parseInt(locationRadiusFilter.value) : 25;
    
    // Build filters for API
    const filters = {
      page: currentJobsPage,
      limit: 20,
      sortBy: activeSortBy
    };
    
    if (zip && zip.length === 5) {
      filters.zip = zip;
    }
    
    if (radius && radius !== 25) {
      filters.radius = radius;
    }
    
    // Add category filter if not "all"
    if (activeCategoryFilter && activeCategoryFilter !== 'all') {
      filters.category = activeCategoryFilter;
    }

    // Load jobs from API (use window.hustlAPI if available, otherwise fallback)
    let response;
    try {
      if (window.hustlAPI && window.hustlAPI.jobs && typeof window.hustlAPI.jobs.list === 'function') {
        response = await window.hustlAPI.jobs.list(filters);
      } else {
        // Fallback: Try direct API call
        const params = new URLSearchParams();
        if (filters.page) params.append('page', filters.page);
        if (filters.limit) params.append('limit', filters.limit);
        if (filters.zip) params.append('zip', filters.zip);
        if (filters.category) params.append('category', filters.category);
        
        const apiResponse = await fetch(`${BACKEND_URL}/api/jobs?${params.toString()}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!apiResponse.ok) {
          throw new Error(`API returned ${apiResponse.status}: ${apiResponse.statusText}`);
        }
        
        response = await apiResponse.json();
      }
    } catch (apiError) {
      console.error("API call failed:", apiError);
      // If API fails, use empty response instead of crashing
      response = { jobs: [], pagination: { hasMore: false, total: 0 } };
      throw new Error(`Failed to load jobs: ${apiError.message || 'Network error'}`);
    }
    
    // Handle paginated response - ensure we always have an array
    let newJobs = [];
    if (response) {
      console.log('[renderJobs] Response type:', typeof response, 'Is array:', Array.isArray(response));
      // New API format: response has jobs and pagination properties
      if (response.jobs && Array.isArray(response.jobs)) {
        newJobs = response.jobs;
        if (response.pagination) {
          jobsPagination = response.pagination;
        }
        console.log('[renderJobs] Using response.jobs, length:', newJobs.length);
      } else if (Array.isArray(response)) {
        // Old format: response is directly an array
        newJobs = response;
        console.log('[renderJobs] Using response as array, length:', newJobs.length);
      } else if (Array.isArray(response.data)) {
        // Alternative format: response.data is an array
        newJobs = response.data;
        console.log('[renderJobs] Using response.data, length:', newJobs.length);
      } else {
        console.warn('[renderJobs] Unexpected response format:', response);
      }
    } else {
      console.warn('[renderJobs] No response received');
    }
    
    console.log('[renderJobs] newJobs is array:', Array.isArray(newJobs), 'length:', newJobs.length);
    
    const pagination = (response && response.pagination) || jobsPagination || { hasMore: false };
    
    // Ensure allLoadedJobs is always an array
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('[renderJobs] allLoadedJobs was not an array, resetting');
      allLoadedJobs = [];
    }
    
    // Ensure newJobs is an array before spreading
    if (!Array.isArray(newJobs)) {
      console.warn('[renderJobs] newJobs was not an array, resetting');
      newJobs = [];
    }
    
    // Append new jobs to existing list
    allLoadedJobs = [...allLoadedJobs, ...newJobs];
    console.log('[renderJobs] allLoadedJobs after append, length:', allLoadedJobs.length, 'is array:', Array.isArray(allLoadedJobs));
    jobsPagination = pagination;

    // Filter by status (client-side) - ensure filteredJobs is always an array
    // Double-check allLoadedJobs is an array before filtering
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('allLoadedJobs is not an array, resetting to empty array');
      allLoadedJobs = [];
    }
    
    let filteredJobs = allLoadedJobs;
    const currentUser = getCurrentUser();
    
    if (activeJobsStatusFilter === "all") {
      // All: Shows everything related to the user (jobs applied to, accepted, in progress, completed)
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => {
        if (!currentUser) return j.status === "OPEN" || j.status === "open";
        // Show jobs user posted, applied to, accepted, or completed
        const isPoster = j.postedByUserId === currentUser.id;
        // Check if user has applied (using fetched offers or job.offers)
        const hasApplied = userAppliedJobIds.has(j.id) || 
                          (j.offers && Array.isArray(j.offers) && j.offers.some(offer => 
                            offer.hustlerId === currentUser.id && 
                            (offer.status === "PENDING" || offer.status === "ACCEPTED")
                          ));
        const isAssigned = j.hustlerId === currentUser.id;
        return isPoster || hasApplied || isAssigned || j.status === "OPEN" || j.status === "open";
      }) : [];
    } else if (activeJobsStatusFilter === "applied") {
      // Applied: Shows only jobs the hustler has applied for (still waiting on customer or accepted but not started)
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => {
        if (!currentUser) return false;
        
        // Check if user has applied using the offers we fetched
        const hasAppliedOffer = userAppliedJobIds.has(j.id);
        if (!hasAppliedOffer) {
          // Fallback: check job.offers if available
          const hasApplied = j.offers && Array.isArray(j.offers) && j.offers.some(offer => 
            offer.hustlerId === currentUser.id && 
            (offer.status === "PENDING" || offer.status === "ACCEPTED")
          );
          if (!hasApplied) return false;
        }
        
        // Get offer status if available
        const offer = userAppliedOffers.get(j.id) || (j.offers && Array.isArray(j.offers) ? j.offers.find(o => o.hustlerId === currentUser.id) : null);
        
        // Show PENDING offers (waiting for customer)
        if (offer && offer.status === 'PENDING') {
          return j.status === "OPEN" || j.status === "open";
        }
        
        // Show ACCEPTED offers that haven't started yet (can still cancel)
        if (offer && offer.status === 'ACCEPTED' && (j.status === 'SCHEDULED' || j.status === 'ASSIGNED') && !j.startCodeVerified) {
          return true;
        }
        
        return false;
      }) : [];
    } else if (activeJobsStatusFilter === "in_progress") {
      // In Progress: Shows jobs where start code has been used (actively being worked on)
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => {
        if (!currentUser) return false;
        // Must be assigned to user AND start code verified (job is active)
        const isAssigned = j.hustlerId === currentUser.id || j.postedByUserId === currentUser.id;
        const isActive = j.arrivalCodeVerified && !j.completionCodeVerified;
        return isAssigned && isActive;
      }) : [];
    } else if (activeJobsStatusFilter === "done") {
      // Done: Shows completed jobs (completion code entered, payment released)
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => {
        if (!currentUser) return false;
        // Must be related to user AND completed
        const isPoster = j.postedByUserId === currentUser.id;
        const isHustler = j.hustlerId === currentUser.id;
        const isCompleted = j.completionCodeVerified || j.status === "COMPLETED" || j.status === "PAID";
        return (isPoster || isHustler) && isCompleted;
      }) : [];
    } else if (activeJobsStatusFilter) {
      // Fallback for other status filters
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => j.status === activeJobsStatusFilter) : [];
    }
    
    // Final safety check
    if (!Array.isArray(filteredJobs)) {
      console.warn('filteredJobs is not an array, resetting to empty array');
      filteredJobs = [];
    }

    // Get user role for card title
    let role = null;
    try {
      if (window.hustlAPI && window.hustlAPI.auth) {
        const user = await window.hustlAPI.auth.getCurrentUser();
        role = user?.roles?.[0] || null;
      }
    } catch (e) {
      console.error("Error getting user role:", e);
    }
    
    // Update card title
    let cardTitle = "Jobs near you";
    if (role === "CUSTOMER" || role === "customer") cardTitle = "Your jobs & local jobs";
    if (role === "HUSTLER" || role === "hustler") cardTitle = "Jobs you can apply for";
    if (jobsCardTitle) jobsCardTitle.textContent = cardTitle;

    // Update summary
    if (jobsFilterSummary) {
      jobsFilterSummary.textContent = filteredJobs.length === 0 
        ? "No jobs yet." 
        : `Showing ${filteredJobs.length} job(s)${pagination.total ? ` of ${pagination.total}` : ''}`;
    }

    if (filteredJobs.length === 0 && currentJobsPage === 1) {
      if (jobsList) {
        jobsList.innerHTML = "<div class='muted'>No jobs found.</div>";
        jobsList.classList.remove('has-content'); // Remove scrollbar when empty
      }
      return;
    }

    // Render each job card (only new ones if not resetting)
    filteredJobs.forEach((job) => {
      // Check if job card already exists
      if (!reset) {
        const existingCard = jobsList?.querySelector(`[data-job-id="${job.id}"]`);
        if (existingCard) return; // Skip if already rendered
      }

      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      // Category icon mapping
      const categoryIcons = {
        'moving': '🚚', 'yard-work': '🌿', 'dump-run': '🗑️', 'cleaning': '🧹',
        'power-washing': '💦', 'furniture-assembly': '🔧', 'painting': '🎨',
        'handyman': '🔨', 'landscaping': '🌳', 'pet-care': '🐕', 'delivery': '📦',
        'car-cleaning': '🚿', 'event-setup': '🎪', 'snow-removal': '❄️', 'other': '✨',
        'yard': '🌿', 'furniture': '🔧'
      };
      const categoryNames = {
        'moving': 'Moving', 'yard-work': 'Yard Work', 'dump-run': 'Dump Run',
        'cleaning': 'Cleaning', 'power-washing': 'Power Wash', 'furniture-assembly': 'Assembly',
        'painting': 'Painting', 'handyman': 'Handyman', 'landscaping': 'Landscaping',
        'pet-care': 'Pet Care', 'delivery': 'Delivery', 'car-cleaning': 'Car Clean',
        'event-setup': 'Event Setup', 'snow-removal': 'Snow Removal', 'other': 'Other',
        'yard': 'Yard Work', 'furniture': 'Assembly'
      };
      
      const jobCategory = (job.category || 'other').toLowerCase();
      const catIcon = categoryIcons[jobCategory] || '⭐';
      const catName = categoryNames[jobCategory] || job.category || 'Job';
      
      // Top row with category icon, title, and price
      const headerRow = document.createElement("div");
      headerRow.style.cssText = "display: flex; align-items: flex-start; gap: 0.75rem;";
      
      // Category icon badge
      const iconBadge = document.createElement("div");
      iconBadge.style.cssText = "width: 40px; height: 40px; border-radius: 10px; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; flex-shrink: 0;";
      iconBadge.textContent = catIcon;
      headerRow.appendChild(iconBadge);
      
      // Title and meta container
      const textContent = document.createElement("div");
      textContent.style.cssText = "flex: 1; min-width: 0;";
      
      const titleRow = document.createElement("div");
      titleRow.style.cssText = "display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;";
      
      const titleEl = document.createElement("div");
      titleEl.className = "job-title";
      titleEl.style.cssText = "font-size: 0.95rem; line-height: 1.3;";
      titleEl.textContent = job.title;
      titleRow.appendChild(titleEl);

      const pay = document.createElement("div");
      pay.style.cssText = "font-weight: 700; color: var(--success); font-size: 1rem; white-space: nowrap;";

      // Format pricing display
      const requirements = job.requirements || {};
      const pricingOption = requirements.pricing_option;
      
      if (pricingOption === "hustlers_quote") {
        pay.textContent = "💰 Hustler suggests price";
        pay.style.color = "#f59e0b";
      } else if (job.payType === "flat") {
        const total = Number(job.amount) || 0;
        pay.textContent = `💰 $${total.toFixed(0)} flat`;
      } else if (job.payType === "hourly") {
        const hr = Number(job.hourlyRate) || 0;
        const maxHrs = job.estHours || "";
        const teamSize = job.teamSize || 1;
        if (teamSize > 1) {
          const perPerson = hr / teamSize;
          pay.textContent = `💰 $${hr.toFixed(0)}/hr (max ${maxHrs || '?'} hrs)\n👥 ${teamSize} → $${perPerson.toFixed(0)}/hr each`;
          pay.style.whiteSpace = "pre-line";
        } else {
          pay.textContent = `💰 $${hr.toFixed(0)}/hr (max ${maxHrs || '?'} hrs)`;
        }
      } else {
        const total = Number(job.amount) || 0;
        pay.textContent = `💰 $${total.toFixed(0)}`;
      }
      titleRow.appendChild(pay);
      textContent.appendChild(titleRow);

      // Category + posted time line (simplified)
      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.style.cssText = "margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-muted);";

      const createdMs = job.createdAt
        ? new Date(job.createdAt).getTime()
        : Date.now();

      meta.textContent = `${catIcon} ${catName} • ${timeAgo(createdMs)}`;
      textContent.appendChild(meta);
      
      // Deadline/needed by line (simplified)
      try {
        const deadlineMeta = document.createElement("div");
        deadlineMeta.className = "job-meta";
        deadlineMeta.style.cssText = "margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-muted);";
        
        const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
        
        if (deadlinePreference === "until_completed") {
          deadlineMeta.textContent = "⏰ No deadline";
        } else if (deadlinePreference === "whenever" || deadlinePreference === "flexible") {
          deadlineMeta.textContent = "⏰ Flexible this week";
        } else if (deadlinePreference === "this_morning" || deadlinePreference === "this_afternoon" || deadlinePreference === "this_evening") {
          deadlineMeta.textContent = "⏰ Today – ASAP";
          deadlineMeta.style.color = "#dc2626";
          deadlineMeta.style.fontWeight = "600";
        } else if (deadlinePreference === "tomorrow") {
          deadlineMeta.textContent = "⏰ Tomorrow";
        } else if (deadlinePreference === "custom" && job.startTime) {
          try {
            const deadlineDate = new Date(job.startTime);
            if (!isNaN(deadlineDate.getTime())) {
              const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
              });
              deadlineMeta.textContent = `⏰ ${deadlineStr}`;
            }
          } catch (e) {}
        } else if (job.date) {
          try {
            const deadlineDate = new Date(job.date);
            if (!isNaN(deadlineDate.getTime())) {
              const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric'
              });
              deadlineMeta.textContent = `⏰ ${deadlineStr}`;
            }
          } catch (e) {}
        }
        if (deadlineMeta.textContent) {
          textContent.appendChild(deadlineMeta);
        }
      } catch (e) {
        console.warn("Error rendering deadline:", e);
      }

      // Description line (short preview)
      if (job.description) {
        const desc = document.createElement("div");
        desc.className = "job-meta";
        desc.style.cssText = "margin-top: 0.25rem; color: var(--text-muted); font-size: 0.8rem; line-height: 1.4;";
        const shortDesc = job.description.length > 70 ? job.description.substring(0, 70) + "..." : job.description;
        desc.textContent = shortDesc;
        textContent.appendChild(desc);
      }

      // Location line (simplified)
      const loc = document.createElement("div");
      loc.className = "job-meta";
      loc.style.cssText = "margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-muted); cursor: pointer;";

      let locationText = "";
      const pickupArea = requirements.pickup_area || requirements.pickupArea;
      const pickupCity = requirements.pickup_city || requirements.pickupCity;
      const pickupZip = requirements.pickup_zip;
      const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
      const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
      const dropoffZip = requirements.dropoff_zip;
      const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly || job.onSiteOnly;
      
      // Helper function to calculate distance using Haversine formula (accurate)
      function calculateDistance(lat1, lng1, lat2, lng2) {
        if (!lat1 || !lng1 || !lat2 || !lng2) return null;
        
        const R = 3959; // Earth's radius in miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = 
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const miles = R * c;
        
        return Math.round(miles * 10) / 10; // Round to 1 decimal place
      }
      
      const pickupAddress = requirements.pickup_address || requirements.pickupAddress;
      const dropoffAddress = requirements.dropoff_address || requirements.dropoffAddress;
      const pickupLat = requirements.pickup_lat || requirements.pickupLat;
      const pickupLng = requirements.pickup_lng || requirements.pickupLng;
      const dropoffLat = requirements.dropoff_lat || requirements.dropoffLat;
      const dropoffLng = requirements.dropoff_lng || requirements.dropoffLng;
      
      // Check if user is hustler and job not accepted - hide full address (OPTIONAL FEATURE)
      // Set HIDE_ADDRESSES_FROM_HUSTLERS to false in config to disable this feature
      const hideAddressesEnabled = window.HUSTL_CONFIG?.HIDE_ADDRESSES_FROM_HUSTLERS !== false; // Default: true (enabled)
      let showFullAddress = true;
      
      if (hideAddressesEnabled) {
        try {
          const user = window.hustlAPI?.auth?.getCurrentUserSync?.() || (window.currentUser || null);
          if (user) {
            const isHustler = user && !user.roles?.includes('CUSTOMER');
            const jobAccepted = job.hustlerId && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'IN_PROGRESS');
            showFullAddress = !isHustler || jobAccepted;
          }
        } catch (e) {
          // If we can't determine user, default to showing full address
          showFullAddress = true;
        }
      }
      
      if (onSiteOnly) {
        if (showFullAddress && pickupAddress) {
          locationText = pickupAddress;
        } else if (pickupCity) {
          locationText = pickupCity;
          if (pickupZip) locationText += ` ${pickupZip}`;
        } else {
          locationText = job.address?.split(',')[0] || "Location TBD";
        }
      } else if (dropoffArea || dropoffCity || dropoffZip || dropoffAddress) {
        let pickupStr = showFullAddress && pickupAddress ? pickupAddress : (pickupCity || "Pickup");
        let dropoffStr = showFullAddress && dropoffAddress ? dropoffAddress : (dropoffCity || "Dropoff");
        // Use coordinates for accurate distance calculation
        if (pickupLat && pickupLng && dropoffLat && dropoffLng) {
          const miles = calculateDistance(parseFloat(pickupLat), parseFloat(pickupLng), parseFloat(dropoffLat), parseFloat(dropoffLng));
          locationText = `${pickupStr} → ${dropoffStr}${miles ? ` (${miles} mi)` : ''}`;
        } else {
          locationText = `${pickupStr} → ${dropoffStr}`;
        }
      } else {
        if (showFullAddress && pickupAddress) {
          locationText = pickupAddress;
        } else if (pickupCity) {
          locationText = pickupCity;
          if (pickupZip) locationText += ` ${pickupZip}`;
        } else {
          locationText = job.address?.split(',')[0] || "Location TBD";
        }
      }
      
      loc.textContent = `📍 ${locationText}`;
      loc.addEventListener("click", (e) => {
        e.stopPropagation();
        openJobDetails(job.id);
      });
      textContent.appendChild(loc);
      
      // Workers needed line (simplified)
      const teamSize = job.teamSize || job.requirements?.teamSize || job.requirements?.team_size || 1;
      if (teamSize === 0) {
        const workersBadge = document.createElement("div");
        workersBadge.style.cssText = "margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-muted);";
        workersBadge.textContent = "👥 Company/crew";
        textContent.appendChild(workersBadge);
      } else if (teamSize > 1) {
        const workersBadge = document.createElement("div");
        workersBadge.style.cssText = "margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-muted);";
        workersBadge.textContent = `👥 ${teamSize} workers`;
        textContent.appendChild(workersBadge);
      }
      
      headerRow.appendChild(textContent);
      card.appendChild(headerRow);

      // Actions row
      const actions = document.createElement("div");
      actions.className = "job-card-actions";

      const right = document.createElement("div");
      right.style.cssText = "display: flex; gap: 0.5rem; align-items: center;";
      
      const viewBtn = document.createElement("button");
      viewBtn.className = "small-btn outline";
      viewBtn.textContent = "View";
      viewBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openJobDetails(job.id);
      });
      right.appendChild(viewBtn);
      actions.appendChild(right);

      card.appendChild(actions);

      // Clicking the whole card opens details
      card.addEventListener("click", () => openJobDetails(job.id));

      if (jobsList) {
        jobsList.appendChild(card);
        jobsList.classList.add('has-content'); // Add scrollbar when there's content
      }
    });

    // Add "Load More" button if there are more pages
    const existingLoadMore = jobsList?.querySelector("#loadMoreJobsBtn");
    if (existingLoadMore) {
      existingLoadMore.remove();
    }

    // Show "Load More" if there are more pages OR if we have 20+ jobs loaded
    const shouldShowLoadMore = pagination.hasMore || (allLoadedJobs.length >= 20);
    
    if (shouldShowLoadMore && jobsList) {
      const loadMoreBtn = document.createElement("button");
      loadMoreBtn.id = "loadMoreJobsBtn";
      loadMoreBtn.className = "btn btn-primary";
      loadMoreBtn.style.width = "100%";
      loadMoreBtn.style.marginTop = "1rem";
      loadMoreBtn.style.padding = "1rem";
      loadMoreBtn.style.fontSize = "1rem";
      loadMoreBtn.style.fontWeight = "600";
      loadMoreBtn.textContent = `Load More Jobs (${allLoadedJobs.length} loaded)`;
      
      let isLoading = false;
      loadMoreBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (isLoading) return;
        isLoading = true;
        
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = "Loading...";
        currentJobsPage++;
        
        try {
          await renderJobs(false); // Don't reset, just append
          loadMoreBtn.textContent = `Load More Jobs (${allLoadedJobs.length} loaded)`;
        } catch (error) {
          console.error("Error loading more jobs:", error);
          showToast("Failed to load more jobs. Please try again.");
          loadMoreBtn.textContent = "Load More Jobs";
        } finally {
          loadMoreBtn.disabled = false;
          isLoading = false;
        }
      });
      jobsList.appendChild(loadMoreBtn);
    }

  } catch (error) {
    console.error("Error loading jobs:", error);
    if (jobsList) {
      // Show a more helpful error message
      const errorMsg = error.message || "Unknown error";
      jobsList.innerHTML = `
        <div class='muted' style='padding: 2rem; text-align: center;'>
          <div style='margin-bottom: 1rem; font-size: 1.1rem;'>⚠️ Unable to load jobs</div>
          <div style='margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;'>${errorMsg}</div>
          <button id="retryJobsBtn" style='padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer; font-weight: 600;' onclick="if(typeof renderJobs === 'function') renderJobs(true);">
            🔄 Try Again
          </button>
        </div>
      `;
    }
  }
}

    // Show "Apply for Job" popup modal
    async function showApplyJobModal(job) {
      const user = getCurrentUser();
      if (!user) {
        showToast("Please log in to apply for jobs.");
        return;
      }

      // Check if already applied
      let hasApplied = false;
      try {
        const token = localStorage.getItem("hustl_token");
        const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        if (offersResponse.ok) {
          const offers = await offersResponse.json();
          hasApplied = Array.isArray(offers) && offers.some(o => o.hustlerId === user.id);
        }
      } catch (e) {
        console.error("Error checking applications:", e);
      }

      if (hasApplied) {
        showToast("You've already applied for this job.");
        return;
      }

      // Check Stripe connection
      const hasStripe = user.stripeAccountId && user.stripePayoutsEnabled;

      // Create modal overlay
      const modalOverlay = document.createElement("div");
      modalOverlay.id = "applyJobModal";
      modalOverlay.className = "modal-overlay";
      modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
      
      const modalContent = document.createElement("div");
      modalContent.className = "modal-content";
      modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";

      // Close button
      const closeBtn = document.createElement("button");
      closeBtn.innerHTML = "×";
      closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10;";
      closeBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });

      // Job Summary Section
      const jobSummary = document.createElement("div");
      jobSummary.style.cssText = "padding: 1.5rem; border-bottom: 1px solid #e5e7eb;";
      
      const jobTitle = document.createElement("h2");
      jobTitle.style.cssText = "margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);";
      jobTitle.textContent = "Apply for This Job";
      jobSummary.appendChild(jobTitle);

      // Get requirements for additional fields
      const requirements = job.requirements || {};
      const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
      const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
      const pricingOption = requirements.pricing_option;
      
      // Format location
      const pickupArea = requirements.pickup_area || requirements.pickupArea;
      const pickupCity = requirements.pickup_city || requirements.pickupCity;
      const pickupZip = requirements.pickup_zip;
      const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
      const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
      const dropoffZip = requirements.dropoff_zip;
      const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
      
      let locationDisplay = job.address || 'Location TBD';
      if (pickupArea || pickupCity) {
        const pickupParts = [];
        if (pickupArea) pickupParts.push(pickupArea);
        if (pickupCity) pickupParts.push(pickupCity);
        if (pickupZip) pickupParts.push(pickupZip);
        locationDisplay = pickupParts.join(', ');
        
        if (!onSiteOnly && (dropoffArea || dropoffCity)) {
          const dropoffParts = [];
          if (dropoffArea) dropoffParts.push(dropoffArea);
          if (dropoffCity) dropoffParts.push(dropoffCity);
          if (dropoffZip) dropoffParts.push(dropoffZip);
          locationDisplay += ` → ${dropoffParts.join(', ')}`;
        } else if (onSiteOnly) {
          locationDisplay += ' (Single location)';
        }
      }
      
      // Format timing
      let timingDisplay = '';
      if (deadlinePreference === 'until_completed') {
        timingDisplay = 'Until completed (no strict deadline)';
      } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
        timingDisplay = 'Flexible this week';
      } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
        timingDisplay = 'Today – ASAP';
      } else if (deadlinePreference === 'tomorrow') {
        timingDisplay = 'Tomorrow';
      } else if (job.startTime) {
        const deadlineDate = new Date(job.startTime);
        timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } else {
        timingDisplay = 'Not specified';
      }
      
      // Format price
      const jobAmount = Number(job.amount) || 0;
      const jobHourlyRate = Number(job.hourlyRate) || 0;
      let price = '';
      if (pricingOption === 'hustlers_quote') {
        price = 'Hustler suggests price';
      } else if (job.payType === "flat" || job.paymentType === "flat") {
        price = `$${jobAmount.toFixed(2)} flat`;
      } else if (jobHourlyRate > 0) {
        price = `$${jobHourlyRate.toFixed(2)}/hr${job.estHours ? ` (max ${job.estHours} hrs)` : ''}`;
      } else {
        price = `$${jobAmount.toFixed(2)}`;
      }
      
      // Format workers
      let workersDisplay = '';
      if (teamSize === 0) {
        workersDisplay = 'Company/crew job';
      } else if (teamSize === 1) {
        workersDisplay = '1 worker';
      } else {
        workersDisplay = `${teamSize} workers needed`;
      }

      const summaryInfo = document.createElement("div");
      summaryInfo.style.cssText = "display: flex; flex-direction: column; gap: 0.75rem; font-size: 0.9rem; color: var(--text-muted);";
      
      const jobTitleRow = document.createElement("div");
      jobTitleRow.style.cssText = "font-weight: 600; color: var(--text-main); font-size: 1rem;";
      jobTitleRow.innerHTML = `<strong>Job:</strong> ${job.title || 'Untitled Job'}`;
      summaryInfo.appendChild(jobTitleRow);

      const timingRow = document.createElement("div");
      timingRow.innerHTML = `<strong>⏰ Timing:</strong> ${timingDisplay}`;
      summaryInfo.appendChild(timingRow);

      const locationRow = document.createElement("div");
      locationRow.innerHTML = `<strong>📍 Location:</strong> ${locationDisplay}`;
      summaryInfo.appendChild(locationRow);

      const workersRow = document.createElement("div");
      workersRow.innerHTML = `<strong>👥 Workers:</strong> ${workersDisplay}`;
      summaryInfo.appendChild(workersRow);

      const priceRow = document.createElement("div");
      priceRow.style.cssText = "font-weight: 600; color: var(--primary); font-size: 1rem;";
      priceRow.innerHTML = `<strong>💰 Price:</strong> ${price}`;
      summaryInfo.appendChild(priceRow);

      if (job.date) {
        const dateRow = document.createElement("div");
        const jobDate = new Date(job.date);
        dateRow.innerHTML = `<strong>📅 Scheduled:</strong> ${jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
        summaryInfo.appendChild(dateRow);
      }
      
      if (requirements.notes) {
        const notesRow = document.createElement("div");
        notesRow.style.cssText = "padding: 0.75rem; background: #fef3c7; border-radius: 8px; margin-top: 0.5rem;";
        notesRow.innerHTML = `<strong>📝 Notes:</strong><br><span style="font-size: 0.85rem;">${requirements.notes}</span>`;
        summaryInfo.appendChild(notesRow);
      }

      jobSummary.appendChild(summaryInfo);
      modalContent.appendChild(jobSummary);

      // Form Section
      const formSection = document.createElement("div");
      formSection.style.cssText = "padding: 1.5rem;";

      // Why are you a good fit
      const whyFitLabel = document.createElement("label");
      whyFitLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      whyFitLabel.innerHTML = "Why Are You a Good Fit? <span style='color: #ef4444;'>*</span>";
      formSection.appendChild(whyFitLabel);

      const whyFitTextarea = document.createElement("textarea");
      whyFitTextarea.id = "applyWhyFit";
      whyFitTextarea.placeholder = "Write a short message...";
      whyFitTextarea.maxLength = 400;
      whyFitTextarea.rows = 5;
      whyFitTextarea.style.cssText = "width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical; margin-bottom: 0.5rem;";
      formSection.appendChild(whyFitTextarea);

      const charCount = document.createElement("div");
      charCount.style.cssText = "font-size: 0.75rem; color: #6b7280; text-align: right; margin-bottom: 1rem;";
      charCount.textContent = "0 / 400 characters";
      formSection.appendChild(charCount);

      whyFitTextarea.addEventListener("input", () => {
        charCount.textContent = `${whyFitTextarea.value.length} / 400 characters`;
      });

      // Price Negotiation Section
      const priceSection = document.createElement("div");
      priceSection.style.cssText = "margin-bottom: 1rem;";
      
      const priceLabel = document.createElement("label");
      priceLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      priceLabel.textContent = "Price";
      formSection.appendChild(priceLabel);

      const priceOptions = document.createElement("div");
      priceOptions.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;";
      
      // Accept listed price option
      const acceptPriceLabel = document.createElement("label");
      acceptPriceLabel.style.cssText = "display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;";
      
      const acceptPriceRadio = document.createElement("input");
      acceptPriceRadio.type = "radio";
      acceptPriceRadio.name = "priceOption";
      acceptPriceRadio.value = "accept";
      acceptPriceRadio.checked = true;
      acceptPriceRadio.style.accentColor = "var(--primary)";
      
      const acceptPriceText = document.createElement("span");
      acceptPriceText.textContent = `Accept listed price: ${price}`;
      acceptPriceLabel.appendChild(acceptPriceRadio);
      acceptPriceLabel.appendChild(acceptPriceText);
      priceOptions.appendChild(acceptPriceLabel);

      // Negotiate price option
      const negotiatePriceLabel = document.createElement("label");
      negotiatePriceLabel.style.cssText = "display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;";
      
      const negotiatePriceRadio = document.createElement("input");
      negotiatePriceRadio.type = "radio";
      negotiatePriceRadio.name = "priceOption";
      negotiatePriceRadio.value = "negotiate";
      negotiatePriceRadio.style.accentColor = "var(--primary)";
      
      const negotiatePriceText = document.createElement("span");
      negotiatePriceText.textContent = "Propose a different price";
      negotiatePriceLabel.appendChild(negotiatePriceRadio);
      negotiatePriceLabel.appendChild(negotiatePriceText);
      priceOptions.appendChild(negotiatePriceLabel);

      formSection.appendChild(priceOptions);

      // Proposed price input (shown when negotiate is selected)
      const proposedPriceContainer = document.createElement("div");
      proposedPriceContainer.id = "proposedPriceContainer";
      proposedPriceContainer.style.cssText = "display: none; margin-bottom: 1rem;";
      
      const proposedPriceLabel = document.createElement("label");
      proposedPriceLabel.style.cssText = "display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      proposedPriceLabel.textContent = "Your Proposed Price";
      proposedPriceContainer.appendChild(proposedPriceLabel);

      const proposedPriceInput = document.createElement("input");
      proposedPriceInput.type = "number";
      proposedPriceInput.id = "proposedPriceInput";
      proposedPriceInput.min = "1";
      proposedPriceInput.step = "0.01";
      proposedPriceInput.placeholder = job.payType === "hourly" ? "Enter hourly rate" : "Enter total amount";
      proposedPriceInput.style.cssText = "width: 100%; padding: 1.25rem; border: 2px solid var(--primary); border-radius: 10px; font-size: 1.25rem; font-weight: 600; text-align: center; background: #f0fdf4; min-height: 50px; box-sizing: border-box;";
      proposedPriceContainer.appendChild(proposedPriceInput);

      const priceTypeLabel = document.createElement("div");
      priceTypeLabel.style.cssText = "margin-top: 0.25rem; font-size: 0.75rem; color: #6b7280;";
      priceTypeLabel.textContent = job.payType === "hourly" ? "Per hour" : "Total amount";
      proposedPriceContainer.appendChild(priceTypeLabel);

      formSection.appendChild(proposedPriceContainer);

      // Show/hide proposed price input based on radio selection
      const priceRadios = [acceptPriceRadio, negotiatePriceRadio];
      priceRadios.forEach(radio => {
        radio.addEventListener("change", () => {
          if (radio.value === "negotiate") {
            proposedPriceContainer.style.display = "block";
            proposedPriceInput.focus();
          } else {
            proposedPriceContainer.style.display = "none";
            proposedPriceInput.value = "";
          }
        });
      });

      // Optional Add-Ons
      const addOnsLabel = document.createElement("label");
      addOnsLabel.style.cssText = "display: block; font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;";
      addOnsLabel.textContent = "Optional Add-Ons";
      formSection.appendChild(addOnsLabel);

      const addOnsContainer = document.createElement("div");
      addOnsContainer.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;";
      
      const addOns = [
        { value: "truck", label: "🚚 I have my own truck" },
        { value: "helper", label: "👥 I can bring another helper" },
        { value: "same_day", label: "⚡ I can come same-day" }
      ];

      addOns.forEach(addon => {
        const label = document.createElement("label");
        label.style.cssText = "display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;";
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "applyAddOns";
        checkbox.value = addon.value;
        checkbox.style.accentColor = "var(--primary)";
        
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(addon.label));
        addOnsContainer.appendChild(label);
      });

      formSection.appendChild(addOnsContainer);

      // Stripe Requirement
      const stripeSection = document.createElement("div");
      stripeSection.style.cssText = "padding: 1rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fbbf24; margin-bottom: 1rem;";
      
      const stripeNote = document.createElement("div");
      stripeNote.style.cssText = "font-size: 0.85rem; color: #92400e; margin-bottom: 0.75rem;";
      stripeNote.textContent = "Note: You must have a connected Stripe account to apply for jobs.";
      stripeSection.appendChild(stripeNote);

      if (!hasStripe) {
        const connectStripeBtn = document.createElement("button");
        connectStripeBtn.className = "btn btn-primary";
        connectStripeBtn.textContent = "Connect Stripe to Apply";
        connectStripeBtn.style.cssText = "width: 100%; padding: 0.75rem;";
        connectStripeBtn.addEventListener("click", () => {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
          setView("profile");
          // Scroll to Stripe section
          setTimeout(() => {
            const stripeSection = document.querySelector('[style*="Stripe"]');
            if (stripeSection) {
              stripeSection.scrollIntoView({ behavior: 'smooth' });
            }
          }, 300);
        });
        stripeSection.appendChild(connectStripeBtn);
      } else {
        const stripeConnected = document.createElement("div");
        stripeConnected.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #059669;";
        stripeConnected.innerHTML = "✅ Stripe account connected";
        stripeSection.appendChild(stripeConnected);
      }

      formSection.appendChild(stripeSection);

      // Buttons
      const buttonsContainer = document.createElement("div");
      buttonsContainer.style.cssText = "display: flex; gap: 0.75rem; margin-top: 1.5rem;";

      const cancelBtn = document.createElement("button");
      cancelBtn.className = "btn btn-ghost";
      cancelBtn.textContent = "Cancel";
      cancelBtn.style.cssText = "flex: 1; padding: 0.75rem;";
      cancelBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });
      buttonsContainer.appendChild(cancelBtn);

      const submitBtn = document.createElement("button");
      submitBtn.className = "btn btn-primary";
      submitBtn.textContent = "Submit Application";
      submitBtn.style.cssText = "flex: 1; padding: 0.75rem;";
      submitBtn.disabled = !hasStripe;
      
      if (!hasStripe) {
        submitBtn.style.opacity = "0.5";
        submitBtn.style.cursor = "not-allowed";
      }

      submitBtn.addEventListener("click", async () => {
        if (!hasStripe) {
          showToast("Please connect your Stripe account first.");
          return;
        }

        const whyFit = whyFitTextarea.value.trim();
        if (!whyFit) {
          showToast("Please explain why you're a good fit for this job.");
          whyFitTextarea.focus();
          return;
        }

        // Get price option
        const selectedPriceOption = document.querySelector('input[name="priceOption"]:checked')?.value || "accept";
        let proposedAmount = null;
        
        if (selectedPriceOption === "negotiate") {
          const proposedPrice = parseFloat(proposedPriceInput.value);
          if (!proposedPrice || proposedPrice <= 0) {
            showToast("Please enter a valid proposed price.");
            proposedPriceInput.focus();
            return;
          }
          proposedAmount = proposedPrice;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite;"></span> Submitting...';
        
        try {
          // Collect add-ons
          const addOnsChecked = Array.from(document.querySelectorAll('input[name="applyAddOns"]:checked')).map(cb => cb.value);
          
          // Submit application
          const token = localStorage.getItem("hustl_token");
          const offerData = {
            jobId: job.id,
            note: whyFit,
            addOns: addOnsChecked
          };
          
          // Add proposed amount if negotiating
          if (proposedAmount !== null) {
            offerData.proposedAmount = proposedAmount;
          }
          
          const response = await fetch(`${API_BASE}/offers`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(offerData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to submit application');
          }

          // Success - close application modal
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
          
          // Show success confirmation modal
          const successOverlay = document.createElement("div");
          successOverlay.className = "modal-overlay";
          successOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
          
          const successModal = document.createElement("div");
          successModal.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
          
          successModal.innerHTML = `
            <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
            <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Application Sent!</h2>
            <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
              You've successfully applied to this job.<br>
              The customer will review your proposal and respond soon.
            </p>
            <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem;">
              You can manage this application in:<br>
              <strong style="color: var(--text-main);">Manage → Applied Jobs</strong>
            </p>
            <button class="btn btn-primary" id="gotItBtn" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
              Got it
            </button>
          `;
          
          successOverlay.appendChild(successModal);
          document.body.appendChild(successOverlay);
          
          // Handle "Got it" button - navigate to Applied Jobs tab
          successOverlay.querySelector('#gotItBtn').addEventListener('click', () => {
            document.body.removeChild(successOverlay);
            document.body.style.overflow = "";
            
            // Navigate to Manage Jobs → Applied Jobs tab
            setView('manage');
            setTimeout(() => {
              const appliedTab = document.getElementById('appliedJobsTab');
              if (appliedTab) {
                appliedTab.click();
                // Load applied jobs
                if (typeof loadAppliedJobs === 'function') {
                  loadAppliedJobs();
                }
              }
            }, 100);
          });
          
          // Also allow clicking outside to close
          successOverlay.addEventListener('click', (e) => {
            if (e.target === successOverlay) {
              document.body.removeChild(successOverlay);
              document.body.style.overflow = "";
              // Still navigate to Applied Jobs
              setView('manage');
              setTimeout(() => {
                const appliedTab = document.getElementById('appliedJobsTab');
                if (appliedTab) {
                  appliedTab.click();
                  if (typeof loadAppliedJobs === 'function') {
                    loadAppliedJobs();
                  }
                }
              }, 100);
            }
          });
          
          // Refresh jobs list
          renderJobs();
        } catch (error) {
          console.error("Error submitting application:", error);
          showToast("Failed to submit application: " + (error.message || "Unknown error"));
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Application";
        }
      });

      buttonsContainer.appendChild(submitBtn);
      formSection.appendChild(buttonsContainer);

      modalContent.appendChild(closeBtn);
      modalContent.appendChild(formSection);
      modalOverlay.appendChild(modalContent);
      
      // Close on overlay click
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
        }
      });

      document.body.appendChild(modalOverlay);
      document.body.style.overflow = "hidden";
      
      // Focus on textarea
      setTimeout(() => {
        whyFitTextarea.focus();
      }, 100);
    }

    // Show Stripe Payment Modal for accepting hustler
    async function showStripePaymentModal(clientSecret, jobId, onSuccessCallback) {
      // Check if Stripe.js is loaded
      if (typeof Stripe === 'undefined') {
        showToast("Payment system loading... Please try again in a moment.");
        return;
      }

      // Fetch Stripe publishable key from API
      let publishableKey = null;
      try {
        const configResponse = await fetch(`${API_BASE}/payments/config`);
        if (configResponse.ok) {
          const config = await configResponse.json();
          publishableKey = config.publishableKey;
        }
      } catch (e) {
        console.error("Error fetching Stripe config:", e);
      }

      if (!publishableKey) {
        showToast("Payment system not configured. Please contact support.");
        return;
      }

      const stripe = Stripe(publishableKey);
      
      const modalOverlay = document.createElement("div");
      modalOverlay.id = "stripePaymentModal";
      modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 1rem;";
      
      const modalContent = document.createElement("div");
      modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);";
      
      const closeBtn = document.createElement("button");
      closeBtn.innerHTML = "×";
      closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280;";
      closeBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });
      modalContent.appendChild(closeBtn);
      
      const title = document.createElement("h2");
      title.style.cssText = "margin: 0 0 1.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);";
      title.textContent = "Complete Payment";
      modalContent.appendChild(title);
      
      const description = document.createElement("p");
      description.style.cssText = "margin-bottom: 1.5rem; color: var(--text-muted);";
      description.textContent = "Complete payment to accept this hustler. Payment will be held in escrow until the job is completed.";
      modalContent.appendChild(description);
      
      // Add test mode indicator and test card instructions
      const isTestMode = publishableKey && publishableKey.startsWith('pk_test_');
      if (isTestMode) {
        const testModeNotice = document.createElement("div");
        testModeNotice.style.cssText = "padding: 1rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; margin-bottom: 1.5rem;";
        testModeNotice.innerHTML = `
          <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">🧪 Test Mode</div>
          <div style="font-size: 0.85rem; color: #78350f; line-height: 1.5;">
            <strong>Test Card Numbers:</strong><br>
            • Success: <code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">4242 4242 4242 4242</code><br>
            • Decline: <code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">4000 0000 0000 0002</code><br>
            Use any future expiry date (e.g., 12/34) and any 3-digit CVC (e.g., 123)
          </div>
        `;
        modalContent.appendChild(testModeNotice);
      }
      
      const paymentElement = document.createElement("div");
      paymentElement.id = "stripe-payment-element";
      modalContent.appendChild(paymentElement);
      
      const submitBtn = document.createElement("button");
      submitBtn.className = "btn btn-primary";
      submitBtn.textContent = "Pay & Accept Hustler";
      submitBtn.style.cssText = "width: 100%; padding: 1rem; margin-top: 1.5rem; font-size: 1rem; font-weight: 600;";
      submitBtn.disabled = true;
      modalContent.appendChild(submitBtn);
      
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);
      document.body.style.overflow = "hidden";
      
      // Initialize Stripe Elements
      const elements = stripe.elements({ clientSecret });
      const paymentElementInstance = elements.create('payment');
      paymentElementInstance.mount('#stripe-payment-element');
      
      paymentElementInstance.on('ready', () => {
        submitBtn.disabled = false;
      });
      
      submitBtn.addEventListener("click", async () => {
        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";
        
        const { error, paymentIntent } = await stripe.confirmPayment({
          elements: paymentElementInstance,
          confirmParams: {
            return_url: `${window.location.origin}/?payment_success=true&jobId=${jobId}`
          },
          redirect: 'if_required'
        });
        
        if (error) {
          showToast("Payment failed: " + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = "Pay & Accept Hustler";
        } else if (paymentIntent && (paymentIntent.status === 'succeeded' || paymentIntent.status === 'requires_capture')) {
          // Payment succeeded or is pre-authorized (held in escrow)
          showToast("✅ Payment successful! Processing...");
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
          
          // Call the callback with paymentIntentId if provided
          if (onSuccessCallback && typeof onSuccessCallback === 'function') {
            await onSuccessCallback(paymentIntent.id);
          } else {
            // Default behavior: refresh job details
            openJobDetails(jobId);
            renderJobs();
          }
        }
      });
      
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
        }
      });
    }

    async function openJobDetails(jobId, options = {}) {
      // Try to find job in state.jobs first, then allLoadedJobs
      let job = state.jobs.find((j) => j.id === jobId);
      if (!job && typeof allLoadedJobs !== 'undefined' && Array.isArray(allLoadedJobs)) {
        job = allLoadedJobs.find((j) => j.id === jobId);
      }
      
      // If still not found, try to fetch from API
      if (!job) {
        try {
          const token = localStorage.getItem("hustl_token");
          const response = await fetch(`${BACKEND_URL}/api/jobs/${jobId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (response.ok) {
            job = await response.json();
            // Add to state for future use
            if (job && !state.jobs.find(j => j.id === jobId)) {
              state.jobs.push(job);
            }
          }
        } catch (error) {
          console.error("Error fetching job details:", error);
        }
      }
      
      const user = getCurrentUser();
      if (!job) {
        console.error("Job not found:", jobId);
        showToast("Job not found. Please try again.");
        return;
      }

      // Create modal overlay - CENTERED
      let modalOverlay = document.getElementById("jobDetailModal");
      if (modalOverlay) {
        document.body.removeChild(modalOverlay);
      }
      
      modalOverlay = document.createElement("div");
      modalOverlay.id = "jobDetailModal";
      modalOverlay.className = "modal-overlay";
      modalOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;";
      document.body.appendChild(modalOverlay);
      
      const modalContent = document.createElement("div");
      modalContent.className = "modal-content";
      modalContent.style.cssText = "background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 95vh; height: 95vh; overflow: hidden; position: relative; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); margin: auto; display: flex; flex-direction: column;";
      
      // Close button (X) - top right
      const closeBtn = document.createElement("button");
      closeBtn.innerHTML = "×";
      closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10; transition: all 0.2s;";
      closeBtn.addEventListener("mouseenter", () => {
        closeBtn.style.background = "#e5e7eb";
        closeBtn.style.color = "#374151";
      });
      closeBtn.addEventListener("mouseleave", () => {
        closeBtn.style.background = "#f3f4f6";
        closeBtn.style.color = "#6b7280";
      });
      closeBtn.addEventListener("click", () => {
        document.body.removeChild(modalOverlay);
        document.body.style.overflow = "";
      });
      modalContent.appendChild(closeBtn);

      // Job Summary Section - Top of Modal (not scrollable, more compact)
      const summarySection = document.createElement("div");
      summarySection.style.cssText = "padding: 1.25rem 2rem 1rem 2rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; background: #f9fafb;";
      
      // Job Title (more compact)
      const jobTitle = document.createElement("h2");
      jobTitle.style.cssText = "margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main); line-height: 1.3;";
      jobTitle.textContent = job.title || "Untitled Job";
      summarySection.appendChild(jobTitle);

      // Summary Grid (more compact, 2 columns on larger screens)
      const summaryGrid = document.createElement("div");
      summaryGrid.style.cssText = "display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem 1rem; font-size: 0.8rem;";
      
      // Category
      const categoryRow = document.createElement("div");
      categoryRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      const categoryEmoji = job.category === "moving" ? "🚚" : job.category === "yard" ? "🌿" : job.category === "cleaning" ? "🧹" : job.category === "furniture" ? "🛠" : "⭐";
      const categoryText = job.category === "moving" ? "Moving / Hauling" : job.category === "yard" ? "Yard / Outdoor" : job.category === "cleaning" ? "Cleaning / Organizing" : job.category === "furniture" ? "Furniture / Setup" : "Other";
      categoryRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Category:</span> <span style="color: var(--text-muted);">${categoryEmoji} ${categoryText}</span>`;
      summaryGrid.appendChild(categoryRow);

      // Pay/Rate
      const payRow = document.createElement("div");
      payRow.style.cssText = "display: flex; align-items: center; gap: 0.5rem;";
      let payText = "";
      if (job.payType === "flat" || !job.payType) {
        const amount = Number(job.flatAmount || job.amount || 0);
        payText = formatMoney(amount) + " flat";
      } else {
        const hourlyRate = Number(job.hourlyRate || 0);
        const maxHours = Number(job.maxHours || job.estHours || 0);
        payText = formatMoney(hourlyRate) + "/hr total";
        if (maxHours > 0) {
          payText += ` (Max ${maxHours} hrs)`;
        }
      }
      payRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Pay:</span> <span style="color: var(--text-muted);">${payText}</span>`;
      summaryGrid.appendChild(payRow);
      
      // Hourly Pay Breakdown Section (if hourly)
      if (job.payType === "hourly") {
        const hourlyBreakdownSection = document.createElement("div");
        hourlyBreakdownSection.style.cssText = "grid-column: 1 / -1; margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px; border-left: 3px solid #3b82f6;";
        
        const breakdownTitle = document.createElement("div");
        breakdownTitle.style.cssText = "font-weight: 700; font-size: 0.95rem; color: #1e40af; margin-bottom: 0.75rem;";
        breakdownTitle.textContent = "💰 Hourly Pay Breakdown";
        hourlyBreakdownSection.appendChild(breakdownTitle);
        
        const hourlyRate = Number(job.hourlyRate || 0);
        const maxHours = Number(job.maxHours || job.estHours || 0);
        const teamSize = job.teamSize || 1;
        const perPersonRate = teamSize > 0 ? hourlyRate / teamSize : hourlyRate;
        
        const breakdownList = document.createElement("div");
        breakdownList.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; color: var(--text-main);";
        
        breakdownList.innerHTML = `
          <div><strong>Total hourly rate:</strong> $${hourlyRate.toFixed(0)}/hr</div>
          ${maxHours > 0 ? `<div><strong>Max hours:</strong> ${maxHours} hours</div>` : ''}
          <div><strong>Workers needed:</strong> ${teamSize}</div>
          ${teamSize > 1 ? `<div><strong>Each worker earns:</strong> $${perPersonRate.toFixed(0)}/hr (before platform fees)</div>` : ''}
        `;
        
        hourlyBreakdownSection.appendChild(breakdownList);
        summaryGrid.appendChild(hourlyBreakdownSection);
      }

      // Status
      const statusRow = document.createElement("div");
      statusRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      let statusText = "Open";
      let statusColor = "#059669";
      if (job.status === "OPEN" || job.status === "open") {
        statusText = "Open";
        statusColor = "#059669";
      } else if (job.status === "ASSIGNED" || job.status === "assigned") {
        statusText = "Assigned";
        statusColor = "#2563eb";
      } else if (job.status === "PAID" || job.status === "paid") {
        statusText = "In Progress";
        statusColor = "#7c3aed";
      } else if (job.status === "COMPLETED" || job.status === "completed") {
        statusText = "Completed";
        statusColor = "#9333ea";
      } else {
        statusText = job.status || "Open";
      }
      statusRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Status:</span> <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>`;
      summaryGrid.appendChild(statusRow);

      // Time Posted - Fix NaN bug
      const timeRow = document.createElement("div");
      timeRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      let postedTime = "Recently";
      if (job.createdAt) {
        const createdDate = typeof job.createdAt === 'string' ? new Date(job.createdAt) : (job.createdAt instanceof Date ? job.createdAt : new Date(job.createdAt));
        postedTime = timeAgo(createdDate);
      }
      timeRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Posted:</span> <span style="color: var(--text-muted);">${postedTime}</span>`;
      summaryGrid.appendChild(timeRow);

      // Job Date / Scheduled Date
      if (job.date || job.startTime) {
        const dateRow = document.createElement("div");
        dateRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
        try {
          const jobDate = job.startTime ? new Date(job.startTime) : new Date(job.date);
          if (!isNaN(jobDate.getTime())) {
            const dateStr = jobDate.toLocaleDateString('en-US', { 
              weekday: 'short',
              month: 'short', 
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            dateRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Date:</span> <span style="color: var(--text-muted);">${dateStr}</span>`;
            summaryGrid.appendChild(dateRow);
          }
        } catch (e) {
          console.warn("Error formatting job date:", e);
        }
      }

      // Deadline / Needed By
      const deadlineRow = document.createElement("div");
      deadlineRow.style.cssText = "display: flex; align-items: center; gap: 0.4rem;";
      try {
        const requirements = job.requirements || {};
        const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
        
        if (deadlinePreference === "until_completed" || deadlinePreference === "whenever" || deadlinePreference === "flexible") {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Deadline:</span> <span style="color: #f59e0b; font-weight: 600;">⏰ Flexible - Until completed</span>`;
        } else if (job.startTime) {
          const deadlineDate = new Date(job.startTime);
          if (!isNaN(deadlineDate.getTime())) {
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Needed By:</span> <span style="color: #059669; font-weight: 600;">📅 ${deadlineStr}</span>`;
          } else {
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Needed By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
          }
        } else if (job.date) {
          const deadlineDate = new Date(job.date);
          if (!isNaN(deadlineDate.getTime())) {
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', { 
              month: 'short', 
              day: 'numeric',
              year: 'numeric'
            });
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Needed By:</span> <span style="color: #059669; font-weight: 600;">📅 ${deadlineStr}</span>`;
          } else {
            deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Needed By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
          }
        } else {
          deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Needed By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
        }
        summaryGrid.appendChild(deadlineRow);
      } catch (e) {
        console.warn("Error formatting deadline:", e);
        deadlineRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Needed By:</span> <span style="color: var(--text-muted);">Not specified</span>`;
        summaryGrid.appendChild(deadlineRow);
      }

      // Location
      const locationRow = document.createElement("div");
      locationRow.style.cssText = "display: flex; align-items: flex-start; gap: 0.4rem; grid-column: 1 / -1;";
      const fullAddress = job.address || (job.requirements?.pickup_address ? `${job.requirements.pickup_address}, ${job.requirements.pickup_city || ''} ${job.requirements.pickup_area || ''}`.trim() : "Location TBD");
      locationRow.innerHTML = `<span style="font-weight: 600; color: var(--text-main);">Location:</span> <span style="color: var(--text-muted);">${fullAddress}</span>`;
      summaryGrid.appendChild(locationRow);

      // Posted By - Make clickable to view customer profile
      let poster = state.users?.find((u) => u.id === job.postedByUserId) || job.postedBy || job.customer;
      if (!poster && job.postedByUserId) {
        // Try to fetch customer from API
        try {
          const token = localStorage.getItem("hustl_token");
          const userResponse = await fetch(`${API_BASE}/users/${job.postedByUserId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (userResponse.ok) {
            poster = await userResponse.json();
          }
        } catch (e) {
          console.error("Error fetching customer:", e);
        }
      }
      
      if (poster) {
        const postedByRow = document.createElement("div");
        postedByRow.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; margin-top: 0.4rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; transition: background 0.2s; grid-column: 1 / -1;";
        postedByRow.addEventListener("mouseenter", () => {
          postedByRow.style.background = "#f3f4f6";
        });
        postedByRow.addEventListener("mouseleave", () => {
          postedByRow.style.background = "#f9fafb";
        });
        postedByRow.addEventListener("click", (e) => {
          e.stopPropagation();
          if (poster.id) {
            // Close job modal first
            if (modalOverlay && modalOverlay.parentNode) {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
            }
            // Open user profile
            if (typeof openUserProfile === 'function') {
              setTimeout(() => {
                openUserProfile(poster.id);
              }, 100);
            } else {
              // Fallback: navigate to profile view
              if (typeof setView === 'function') {
                setView('profile');
              }
            }
          }
        });
        
        const posterAvatar = document.createElement("div");
        posterAvatar.style.cssText = "width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.85rem; flex-shrink: 0;";
        const posterInitial = (poster.name || poster.email || "U")[0].toUpperCase();
        if (poster.photoUrl) {
          posterAvatar.innerHTML = `<img src="${poster.photoUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
        } else {
          posterAvatar.textContent = posterInitial;
        }
        postedByRow.appendChild(posterAvatar);
        
        const posterInfo = document.createElement("div");
        posterInfo.style.cssText = "flex: 1; min-width: 0;";
        
        const posterName = document.createElement("div");
        posterName.style.cssText = "font-weight: 600; color: var(--text-main); margin-bottom: 0.15rem; font-size: 0.85rem;";
        posterName.textContent = poster.name || poster.username || poster.email?.split('@')[0] || "Unknown";
        posterInfo.appendChild(posterName);
        
        const posterRating = document.createElement("div");
        posterRating.style.cssText = "font-size: 0.75rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.25rem;";
        const ratingValue = poster.ratingAvg || poster.rating || 0;
        const ratingCount = poster.ratingCount || poster.reviewCount || 0;
        if (ratingCount > 0) {
          posterRating.innerHTML = `⭐ ${Number(ratingValue).toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})`;
        } else {
          posterRating.textContent = "⭐ No reviews yet";
        }
        posterInfo.appendChild(posterRating);
        
        postedByRow.appendChild(posterInfo);
        
        const viewProfileBtn = document.createElement("div");
        viewProfileBtn.style.cssText = "font-size: 0.75rem; color: var(--primary); font-weight: 600; white-space: nowrap;";
        viewProfileBtn.textContent = "View Profile →";
        postedByRow.appendChild(viewProfileBtn);
        
        summaryGrid.appendChild(postedByRow);
      }

      summarySection.appendChild(summaryGrid);
      modalContent.appendChild(summarySection);
      
      // Close on overlay click
      modalOverlay.addEventListener("click", (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
          document.body.style.overflow = "";
        }
      });
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = "hidden";
      
      // Append modal content to overlay
      modalOverlay.appendChild(modalContent);

      // Content Section (scrollable) - CREATE FIRST
      const contentSection = document.createElement("div");
      contentSection.style.cssText = "padding: 1.5rem 2rem; flex: 1 1 0; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; min-height: 0; position: relative;";
      
      // Additional Details Section
      if (job.requirements) {
        const detailsSection = document.createElement("div");
        detailsSection.style.cssText = "margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;";
        
        const detailsTitle = document.createElement("div");
        detailsTitle.style.cssText = "font-weight: 600; font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.75rem;";
        detailsTitle.textContent = "Additional Details";
        detailsSection.appendChild(detailsTitle);
        
        const detailsList = document.createElement("div");
        detailsList.style.cssText = "display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);";
        
        // Check if user is hustler and job not accepted - hide full address (OPTIONAL FEATURE)
        const hideAddressesEnabled = window.HUSTL_CONFIG?.HIDE_ADDRESSES_FROM_HUSTLERS !== false; // Default: true (enabled)
        let showFullAddressDetails = true;
        
        if (hideAddressesEnabled) {
          try {
            const user = window.hustlAPI?.auth?.getCurrentUserSync?.() || (window.currentUser || null);
            if (user) {
              const isHustler = user && !user.roles?.includes('CUSTOMER');
              const jobAccepted = job.hustlerId && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'IN_PROGRESS');
              showFullAddressDetails = !isHustler || jobAccepted;
            }
          } catch (e) {
            showFullAddressDetails = true;
          }
        }
        
        if (job.requirements.pickup_address || job.requirements.pickup_city) {
          const pickupDetail = document.createElement("div");
          let pickupText = '';
          if (showFullAddressDetails && job.requirements.pickup_address) {
            pickupText = `${job.requirements.pickup_address}, ${job.requirements.pickup_city || ''} ${job.requirements.pickup_zip || ''}`.trim();
          } else {
            pickupText = `${job.requirements.pickup_area || ''} ${job.requirements.pickup_city || ''} ${job.requirements.pickup_zip || ''}`.trim();
            if (!showFullAddressDetails) {
              pickupText += ' (Exact address shown after acceptance)';
            }
          }
          pickupDetail.innerHTML = `<strong>Pickup:</strong> ${pickupText}`;
          detailsList.appendChild(pickupDetail);
        }
        
        if (job.requirements.dropoff_address && !job.requirements.on_site_only) {
          const dropoffDetail = document.createElement("div");
          let dropoffText = '';
          if (showFullAddressDetails && job.requirements.dropoff_address) {
            dropoffText = `${job.requirements.dropoff_address}, ${job.requirements.dropoff_city || ''} ${job.requirements.dropoff_zip || ''}`.trim();
          } else {
            dropoffText = `${job.requirements.dropoff_area || ''} ${job.requirements.dropoff_city || ''} ${job.requirements.dropoff_zip || ''}`.trim();
            if (!showFullAddressDetails) {
              dropoffText += ' (Address will be provided after assignment)';
            }
          }
          dropoffDetail.innerHTML = `<strong>Dropoff:</strong> ${dropoffText}`;
          detailsList.appendChild(dropoffDetail);
        }
        
        if (job.requirements.equipment_needed && Array.isArray(job.requirements.equipment_needed) && job.requirements.equipment_needed.length > 0) {
          const equipmentDetail = document.createElement("div");
          equipmentDetail.innerHTML = `<strong>Equipment Needed:</strong> ${job.requirements.equipment_needed.join(', ')}`;
          detailsList.appendChild(equipmentDetail);
        }
        
        // Team Size / Workers Needed - VERY IMPORTANT
        const teamSize = job.teamSize || job.workersNeeded || job.requirements?.team_size || 1;
        if (teamSize && teamSize > 0) {
          const teamSizeDetail = document.createElement("div");
          teamSizeDetail.style.cssText = "font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-top: 0.5rem; padding: 0.75rem; background: #eff6ff; border-radius: 6px; border-left: 3px solid #3b82f6;";
          if (teamSize === 1) {
            teamSizeDetail.innerHTML = `👤 <strong>Workers Needed:</strong> 1 person`;
          } else {
            teamSizeDetail.innerHTML = `👥 <strong>Workers Needed:</strong> ${teamSize} people<br><span style="font-size: 0.85rem; color: #1e40af; font-weight: 500;">💡 Bring some friends! This job requires ${teamSize} ${teamSize === 2 ? 'people' : 'people'} to complete.</span>`;
          }
          detailsList.appendChild(teamSizeDetail);
        }
        
        if (detailsList.children.length > 0) {
          detailsSection.appendChild(detailsList);
          contentSection.appendChild(detailsSection);
        }
      }

      // Full Job Description Section
      const descSection = document.createElement("div");
      descSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
      
      const descTitle = document.createElement("div");
      descTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
      descTitle.textContent = "Job Description";
      descSection.appendChild(descTitle);
      
      const desc = document.createElement("div");
      desc.style.cssText = "color: var(--text-main); font-size: 1rem; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;";
      // Get full description from job object
      const fullDescription = job.description || job.requirements?.notes || job.notes || "No description provided.";
      desc.textContent = fullDescription;
      descSection.appendChild(desc);
      
      // Job Photos (if any)
      if (job.photos && Array.isArray(job.photos) && job.photos.length > 0) {
        const photosSection = document.createElement("div");
        photosSection.style.cssText = "margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;";
        job.photos.forEach(photoUrl => {
          const photo = document.createElement("img");
          photo.src = photoUrl;
          photo.style.cssText = "width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;";
          photo.addEventListener("click", () => {
            window.open(photoUrl, '_blank');
          });
          photosSection.appendChild(photo);
        });
        descSection.appendChild(photosSection);
      }
      
      contentSection.appendChild(descSection);
      
      // Location with Map Preview
      const locationSection = document.createElement("div");
      locationSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
      
      const locationTitle = document.createElement("div");
      locationTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
      locationTitle.textContent = "📍 Location";
      locationSection.appendChild(locationTitle);
      
      const locationText = document.createElement("div");
      locationText.style.cssText = "color: var(--text-main); font-size: 0.95rem; margin-bottom: 1rem; line-height: 1.5;";
      locationText.textContent = fullAddress;
      locationSection.appendChild(locationText);
      
      // Map preview (Mapbox)
      if (fullAddress && fullAddress !== "Location TBD" && job.lat && job.lng) {
        const mapContainer = document.createElement("div");
        const mapId = `map-${job.id}-${Date.now()}`;
        mapContainer.id = mapId;
        mapContainer.style.cssText = "width: 100%; height: 200px; border-radius: 8px; overflow: hidden; background: #e5e7eb; margin-top: 0.75rem;";
        locationSection.appendChild(mapContainer);
        
        // Initialize Mapbox map after a short delay to ensure token is loaded
        setTimeout(() => {
          if (window.mapboxgl && window.MAPBOX_TOKEN) {
            try {
              mapboxgl.accessToken = window.MAPBOX_TOKEN;
              const map = new mapboxgl.Map({
                container: mapId,
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [job.lng, job.lat],
                zoom: 13,
                interactive: false // Static preview
              });
              
              // Add marker
              new mapboxgl.Marker({ color: '#2563eb' })
                .setLngLat([job.lng, job.lat])
                .addTo(map);
            } catch (mapError) {
              console.warn('Could not initialize Mapbox map:', mapError);
              // Fallback to Google Maps link
              const mapLink = document.createElement("a");
              mapLink.href = `https://maps.google.com/?q=${encodeURIComponent(fullAddress)}`;
              mapLink.target = "_blank";
              mapLink.style.cssText = "display: block; padding: 1rem; text-align: center; color: var(--primary); text-decoration: none; font-weight: 600;";
              mapLink.textContent = "🗺️ View on Google Maps";
              mapContainer.appendChild(mapLink);
            }
          } else {
            // Fallback to Google Maps link if Mapbox not available
            const mapLink = document.createElement("a");
            mapLink.href = `https://maps.google.com/?q=${encodeURIComponent(fullAddress)}`;
            mapLink.target = "_blank";
            mapLink.style.cssText = "display: block; padding: 1rem; text-align: center; color: var(--primary); text-decoration: none; font-weight: 600;";
            mapLink.textContent = "🗺️ View on Google Maps";
            mapContainer.appendChild(mapLink);
          }
        }, 100);
      }
      
      contentSection.appendChild(locationSection);
      
      // Tools/Equipment Needed
      const equipment = job.requirements?.equipment || job.requirements?.equipment_needed || [];
      if (equipment.length > 0) {
        const equipmentSection = document.createElement("div");
        equipmentSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
        
        const equipmentTitle = document.createElement("div");
        equipmentTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
        equipmentTitle.textContent = "🔧 Tools & Equipment Needed";
        equipmentSection.appendChild(equipmentTitle);
        
        const equipmentList = document.createElement("div");
        equipmentList.style.cssText = "display: flex; flex-wrap: wrap; gap: 0.5rem;";
        equipment.forEach(eq => {
          const badge = document.createElement("span");
          badge.style.cssText = "padding: 0.5rem 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; color: var(--text-main);";
          badge.textContent = eq;
          equipmentList.appendChild(badge);
        });
        equipmentSection.appendChild(equipmentList);
        contentSection.appendChild(equipmentSection);
      }
      
      // Estimated Time/Difficulty
      if (job.estHours || job.maxHours || job.difficulty) {
        const timeSection = document.createElement("div");
        timeSection.style.cssText = "margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;";
        
        if (job.estHours || job.maxHours) {
          const timeInfo = document.createElement("div");
          timeInfo.style.cssText = "font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.5rem;";
          timeInfo.textContent = `⏱️ Estimated Time: ${job.estHours || job.maxHours} ${(job.estHours || job.maxHours) === 1 ? 'hour' : 'hours'}`;
          timeSection.appendChild(timeInfo);
        }
        
        if (job.difficulty) {
          const difficultyInfo = document.createElement("div");
          difficultyInfo.style.cssText = "font-size: 0.9rem; color: var(--text-main);";
          difficultyInfo.textContent = `📊 Difficulty: ${job.difficulty}`;
          timeSection.appendChild(difficultyInfo);
        }
        
        contentSection.appendChild(timeSection);
      }

      // Apply Now Button Section (moved here, right after Tools & Equipment)
      // Check if user is logged in (check token first, then get user)
      const token = localStorage.getItem("hustl_token");
      const isLoggedIn = !!token;
      
      // Use the user variable from earlier in the function, or get it again
      const currentUser = user || getCurrentUser();
      
      // Check if job is open (case-insensitive)
      const jobStatusUpper = (job.status || "").toUpperCase();
      const isOpen = jobStatusUpper === "OPEN" || jobStatusUpper === "";
      const isNotPoster = currentUser ? (job.postedByUserId !== currentUser.id) : true; // If no user object, assume not poster
      
      // Show apply section if: user is logged in (has token) and job is open
      // We'll check if user is poster inside the form and show appropriate message
      console.log("Apply section visibility check:", { isLoggedIn, isOpen, isNotPoster, jobStatus: job.status, hasToken: !!token });
      if (isLoggedIn && isOpen) {
        // Check if already applied
        let hasApplied = false;
        try {
          const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (offersResponse.ok) {
            const offers = await offersResponse.json();
            // Get user ID from currentUser or fetch from API
            let userId = currentUser?.id;
            if (!userId && token) {
              try {
                const userResponse = await fetch(`${API_BASE}/auth/me`, {
                  headers: { "Authorization": `Bearer ${token}` }
                });
                if (userResponse.ok) {
                  const userData = await userResponse.json();
                  userId = userData.id;
                }
              } catch (e) {
                console.error("Error getting user ID:", e);
              }
            }
            hasApplied = userId && Array.isArray(offers) && offers.some(o => o.hustlerId === userId);
          }
        } catch (e) {
          console.error("Error checking applications:", e);
        }
        
        const applySection = document.createElement("div");
        applySection.style.cssText = "margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 12px;";
        
        // Check job status for hustler
        const jobStatusUpper = (job.status || "OPEN").toUpperCase();
        
        if (hasApplied) {
          let statusText = "✓ Applied — Pending Customer Response";
          let statusBg = "#dcfce7";
          let statusColor = "#059669";
          
          // Check if accepted
          if (job.hustlerId === currentUser.id || job.acceptedHustlerId === currentUser.id) {
            const hasStartCode = job.arrivalCode && !job.arrivalCodeVerified;
            const isInProgress = job.arrivalCodeVerified && !job.completionCodeVerified;
            const isCompleted = job.completionCodeVerified;
            
            if (hasStartCode) {
              statusText = "✓ Accepted — Waiting for Start Code";
              statusBg = "#fef3c7";
              statusColor = "#d97706";
            } else if (isInProgress) {
              statusText = "✓ Job Active — In Progress";
              statusBg = "#dbeafe";
              statusColor = "#2563eb";
            } else if (isCompleted) {
              statusText = "✓ Completed";
              statusBg = "#e9d5ff";
              statusColor = "#9333ea";
            } else {
              statusText = "✓ Accepted — Waiting for Start Code";
              statusBg = "#fef3c7";
              statusColor = "#d97706";
            }
          }
          
          const appliedBadge = document.createElement("div");
          appliedBadge.style.cssText = `padding: 1rem; background: ${statusBg}; border-radius: 8px; text-align: center; color: ${statusColor}; font-weight: 600;`;
          appliedBadge.textContent = statusText;
          applySection.appendChild(appliedBadge);
        } else {
          // Check if this is a hustler-suggested-price job
          const pricingOption = job.requirements?.pricing_option;
          const isHustlerSuggestedPrice = pricingOption === "hustlers_quote";
          
          // Apply form directly in the modal
          const applyTitle = document.createElement("div");
          applyTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 1rem;";
          applyTitle.textContent = "Apply for This Job";
          applySection.appendChild(applyTitle);
          
          // Why you're a good fit textarea
          const whyFitLabel = document.createElement("label");
          whyFitLabel.style.cssText = "display: block; font-weight: 600; font-size: 0.9rem; color: var(--text-main); margin-bottom: 0.5rem;";
          whyFitLabel.textContent = "Why are you a good fit for this job? *";
          applySection.appendChild(whyFitLabel);
          
          const whyFitTextarea = document.createElement("textarea");
          whyFitTextarea.id = `whyFitTextarea_${job.id}`;
          whyFitTextarea.placeholder = "Tell the customer why you're right for this job. Include your experience, tools, availability, etc.";
          whyFitTextarea.maxLength = 400;
          whyFitTextarea.required = true;
          whyFitTextarea.style.cssText = "width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical; margin-bottom: 0.5rem;";
          whyFitTextarea.addEventListener("input", (e) => {
            const remaining = 400 - e.target.value.length;
            charCounter.textContent = `${remaining} characters remaining`;
            if (remaining < 50) {
              charCounter.style.color = "#dc2626";
            } else {
              charCounter.style.color = "var(--text-muted)";
            }
          });
          applySection.appendChild(whyFitTextarea);
          
          const charCounter = document.createElement("div");
          charCounter.style.cssText = "font-size: 0.75rem; color: var(--text-muted); margin-bottom: 1rem; text-align: right;";
          charCounter.textContent = "400 characters remaining";
          applySection.appendChild(charCounter);
          
          // For hustler-suggested-price jobs, show price input directly (required)
          // For customer-set-price jobs, show optional checkbox
          if (!isHustlerSuggestedPrice) {
            // Suggest Different Price (Optional) - with checkbox toggle
            const priceCheckboxContainer = document.createElement("div");
            priceCheckboxContainer.style.cssText = "margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;";
            
            const priceCheckboxLabel = document.createElement("label");
            priceCheckboxLabel.style.cssText = "display: flex; align-items: center; gap: 0.75rem; cursor: pointer; font-weight: 600; font-size: 0.95rem; color: var(--text-main);";
            
            const priceCheckbox = document.createElement("input");
            priceCheckbox.type = "checkbox";
            priceCheckbox.id = `suggestPriceCheckbox_${job.id}`;
            priceCheckbox.style.cssText = "width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);";
            
            const priceCheckboxText = document.createElement("span");
            priceCheckboxText.textContent = "💵 Suggest a different price";
            
            priceCheckboxLabel.appendChild(priceCheckbox);
            priceCheckboxLabel.appendChild(priceCheckboxText);
            priceCheckboxContainer.appendChild(priceCheckboxLabel);
            applySection.appendChild(priceCheckboxContainer);
          }
          
          // Price negotiation fields (shown directly for hustler-suggested-price, hidden by default for customer-set-price)
          const priceNegotiationSection = document.createElement("div");
          priceNegotiationSection.id = `priceNegotiationSection_${job.id}`;
          priceNegotiationSection.style.cssText = isHustlerSuggestedPrice 
            ? "margin-top: 1rem; padding: 1rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px;"
            : "display: none; margin-top: 1rem; padding: 1rem; background: white; border: 2px solid #e5e7eb; border-radius: 8px;";
          
          const priceLabel = document.createElement("label");
          priceLabel.style.cssText = "display: block; font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.75rem;";
          priceLabel.textContent = isHustlerSuggestedPrice ? "Your Proposed Price *" : "Your Proposed Price";
          priceNegotiationSection.appendChild(priceLabel);
          
          // Show current price (only for customer-set-price jobs, not for hustler-suggested-price)
          if (!isHustlerSuggestedPrice) {
            const currentPriceDisplay = document.createElement("div");
            currentPriceDisplay.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--border);";
            const currentPrice = job.payType === "flat" ? formatMoney(job.flatAmount || job.amount || 0) : formatMoney(job.hourlyRate || 0) + "/hr";
            const priceTypeLabel = job.payType === "flat" ? "Flat Rate" : "Hourly Rate";
            currentPriceDisplay.innerHTML = `
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Current ${priceTypeLabel}:</div>
              <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${currentPrice}</div>
            `;
            priceNegotiationSection.appendChild(currentPriceDisplay);
          }
          
          // Price input container with dollar sign
          const priceInputWrapper = document.createElement("div");
          priceInputWrapper.style.cssText = "position: relative; margin-bottom: 1rem;";
          
          const dollarSign = document.createElement("span");
          dollarSign.style.cssText = "position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 2.5rem; font-weight: 700; color: var(--primary); z-index: 1;";
          dollarSign.textContent = "$";
          priceInputWrapper.appendChild(dollarSign);
          
          const priceInput = document.createElement("input");
          priceInput.type = "number";
          priceInput.id = `proposedPrice_${job.id}`;
          priceInput.placeholder = job.payType === "flat" ? "e.g., 150.00" : "e.g., 25.00";
          priceInput.min = "0";
          priceInput.step = "0.01";
          priceInput.required = isHustlerSuggestedPrice; // Required for hustler-suggested-price jobs
          priceInput.style.cssText = "width: 100%; padding: 2rem 1.5rem 2rem 4rem; border: 4px solid var(--primary); border-radius: 16px; font-size: 2.5rem; font-weight: 700; text-align: left; background: #f0fdf4; color: var(--text-main); min-height: 85px; box-sizing: border-box; transition: all 0.2s; font-family: inherit;";
          priceInputWrapper.appendChild(priceInput);
          
          // Add /hr suffix for hourly rates (initial state)
          if (job.payType === "hourly") {
            const hrSuffix = document.createElement("span");
            hrSuffix.className = "hr-suffix";
            hrSuffix.style.cssText = "position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.75rem; font-weight: 600; color: var(--text-muted); z-index: 1;";
            hrSuffix.textContent = "/hr";
            priceInputWrapper.appendChild(hrSuffix);
            priceInput.placeholder = "e.g., 60.00 (total for all workers)";
          }
          
          priceNegotiationSection.appendChild(priceInputWrapper);
          
          // Price type selector - always visible, allows switching between flat and hourly
          const priceTypeSelect = document.createElement("select");
          priceTypeSelect.id = `proposedPriceType_${job.id}`;
          priceTypeSelect.style.cssText = "width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; font-weight: 600; font-family: inherit; background: white; margin-bottom: 0.75rem;";
          priceTypeSelect.innerHTML = `
            <option value="flat">Flat Rate (one-time payment)</option>
            <option value="hourly">Per Hour (total hourly rate)</option>
          `;
          // Set default to match job pay type
          priceTypeSelect.value = job.payType || "flat";
          
          // Update input placeholder and /hr suffix when type changes
          priceTypeSelect.addEventListener("change", () => {
            const existingHrSuffix = priceInputWrapper.querySelector('.hr-suffix');
            if (priceTypeSelect.value === "hourly") {
              priceInput.placeholder = "e.g., 60.00 (total for all workers)";
              // Show /hr suffix if not already there
              if (!existingHrSuffix) {
                const hrSuffix = document.createElement("span");
                hrSuffix.className = "hr-suffix";
                hrSuffix.style.cssText = "position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.75rem; font-weight: 600; color: var(--text-muted); z-index: 1;";
                hrSuffix.textContent = "/hr";
                priceInputWrapper.appendChild(hrSuffix);
              }
            } else {
              priceInput.placeholder = "e.g., 150.00";
              // Remove /hr suffix
              if (existingHrSuffix) existingHrSuffix.remove();
            }
          });
          
          priceNegotiationSection.appendChild(priceTypeSelect);
          
          const priceHint = document.createElement("div");
          priceHint.style.cssText = "padding: 0.75rem; background: #dbeafe; border-radius: 8px; font-size: 0.85rem; color: #1e40af;";
          if (isHustlerSuggestedPrice) {
            priceHint.textContent = `💡 The customer will see your proposed price and compare it with other hustlers' proposals to decide who's the best fit.`;
          } else {
            const priceTypeLabel = job.payType === "flat" ? "Flat Rate" : "Hourly Rate";
            priceHint.textContent = `💡 Customer will see your proposed ${priceTypeLabel.toLowerCase()} when reviewing your application`;
          }
          priceNegotiationSection.appendChild(priceHint);
          
          applySection.appendChild(priceNegotiationSection);
          
          // Toggle price negotiation section when checkbox is clicked (only for customer-set-price jobs)
          if (!isHustlerSuggestedPrice) {
            const priceCheckbox = document.getElementById(`suggestPriceCheckbox_${job.id}`);
            if (priceCheckbox) {
              priceCheckbox.addEventListener("change", () => {
                if (priceCheckbox.checked) {
                  priceNegotiationSection.style.display = "block";
                  priceInput.focus();
                } else {
                  priceNegotiationSection.style.display = "none";
                  priceInput.value = "";
                }
              });
            }
          }
          
          // Stripe requirement check - TEMPORARILY DISABLED FOR SANDBOX MODE
          // const stripeCheck = document.createElement("div");
          // stripeCheck.style.cssText = "padding: 0.75rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);";
          // 
          // let hasStripe = false;
          // try {
          //   const token = localStorage.getItem("hustl_token");
          //   const userResponse = await fetch(`${API_BASE}/users/me`, {
          //     headers: token ? { "Authorization": `Bearer ${token}` } : {}
          //   });
          //   if (userResponse.ok) {
          //     const userData = await userResponse.json();
          //     hasStripe = !!(userData.stripeAccountId || userData.stripeConnectAccountId);
          //   }
          // } catch (e) {
          //   console.error("Error checking Stripe:", e);
          // }
          // 
          // if (!hasStripe) {
          //   stripeCheck.innerHTML = `
          //     <div style="margin-bottom: 0.5rem; color: #dc2626; font-weight: 600;">⚠️ Stripe Account Required</div>
          //     <div style="margin-bottom: 0.75rem;">You must have a connected Stripe account to apply for jobs.</div>
          //     <button id="connectStripeBtn_${job.id}" class="btn btn-primary" style="width: 100%; padding: 0.6rem; font-size: 0.9rem;">
          //       Connect Stripe to Apply
          //     </button>
          //   `;
          //   const connectBtn = stripeCheck.querySelector(`#connectStripeBtn_${job.id}`);
          //   if (connectBtn) {
          //     connectBtn.addEventListener("click", () => {
          //       document.body.removeChild(modalOverlay);
          //       document.body.style.overflow = "";
          //       setView("profile");
          //       setTimeout(() => {
          //         const stripeSection = document.getElementById("stripeConnectSection");
          //         if (stripeSection) {
          //           stripeSection.scrollIntoView({ behavior: "smooth", block: "center" });
          //         }
          //       }, 300);
          //     });
          //   }
          // } else {
          //   stripeCheck.innerHTML = `<div style="color: #059669; font-weight: 600;">✅ Stripe account connected</div>`;
          // }
          // applySection.appendChild(stripeCheck);
          
          // Apply button
          const applyNowBtn = document.createElement("button");
          applyNowBtn.className = "btn btn-primary";
          applyNowBtn.textContent = "Submit Application";
          applyNowBtn.style.cssText = "width: 100%; padding: 1rem; font-size: 1rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); border: none; border-radius: 12px; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;";
          // Stripe requirement temporarily disabled for sandbox mode
          // applyNowBtn.disabled = !hasStripe;
          // if (!hasStripe) {
          //   applyNowBtn.style.opacity = "0.5";
          //   applyNowBtn.style.cursor = "not-allowed";
          // }
          
          applyNowBtn.addEventListener("mouseenter", () => {
            if (!applyNowBtn.disabled) {
              applyNowBtn.style.transform = "translateY(-2px)";
              applyNowBtn.style.boxShadow = "0 6px 16px rgba(59, 130, 246, 0.5)";
            }
          });
          applyNowBtn.addEventListener("mouseleave", () => {
            applyNowBtn.style.transform = "translateY(0)";
            applyNowBtn.style.boxShadow = "0 4px 12px rgba(59, 130, 246, 0.4)";
          });
          
          applyNowBtn.addEventListener("click", async () => {
            const whyFit = whyFitTextarea.value.trim();
            if (!whyFit) {
              showToast("Please explain why you're a good fit for this job.");
              whyFitTextarea.focus();
              return;
            }
            
            // Stripe requirement temporarily disabled for sandbox mode
            // if (!hasStripe) {
            //   showToast("Please connect your Stripe account first.");
            //   return;
            // }
            
            try {
              applyNowBtn.disabled = true;
              applyNowBtn.textContent = "Submitting...";
              
              // Get proposed price if checkbox is checked and value is entered
              const requestBody = {
                note: whyFit
              };
              
              // For hustler-suggested-price jobs, price is always required
              // For customer-set-price jobs, price is only required if checkbox is checked
              const pricingOption = job.requirements?.pricing_option;
              const isHustlerSuggestedPrice = pricingOption === "hustlers_quote";
              
              if (isHustlerSuggestedPrice) {
                // Price is required for hustler-suggested-price jobs
                const proposedPrice = priceInput && priceInput.value ? parseFloat(priceInput.value) : null;
                if (!proposedPrice || proposedPrice <= 0) {
                  showToast("Please enter your proposed price.");
                  applyNowBtn.disabled = false;
                  applyNowBtn.textContent = "Submit Application";
                  return;
                }
                requestBody.proposedAmount = proposedPrice;
                requestBody.proposedPriceType = priceTypeSelect ? priceTypeSelect.value : (job.payType || "flat");
              } else {
                // Price is optional for customer-set-price jobs (only if checkbox checked)
                const priceCheckbox = document.getElementById(`suggestPriceCheckbox_${job.id}`);
                if (priceCheckbox && priceCheckbox.checked) {
                  const proposedPrice = priceInput && priceInput.value ? parseFloat(priceInput.value) : null;
                  if (proposedPrice && proposedPrice > 0) {
                    requestBody.proposedAmount = proposedPrice;
                    requestBody.proposedPriceType = priceTypeSelect ? priceTypeSelect.value : (job.payType || "flat");
                  } else {
                    showToast("Please enter a proposed price or uncheck the price suggestion option.");
                    applyNowBtn.disabled = false;
                    applyNowBtn.textContent = "Submit Application";
                    return;
                  }
                }
              }
              
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/offers/${job.id}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(requestBody)
              });
              
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || "Failed to submit application");
              }
              
              showToast("✅ Application Submitted!");
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              renderJobs();
            } catch (error) {
              console.error("Error submitting application:", error);
              showToast("Failed to submit application: " + (error.message || "Unknown error"));
              applyNowBtn.disabled = false;
              applyNowBtn.textContent = "Submit Application";
            }
          });
          applySection.appendChild(applyNowBtn);
        }
        
        // Append apply section to contentSection (inside scrollable area, after Tools & Equipment)
        contentSection.appendChild(applySection);
      } else if (isLoggedIn && !isOpen) {
        // Job is not open - show message (inside contentSection)
        const closedSection = document.createElement("div");
        closedSection.style.cssText = "margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: #f3f4f6; border-radius: 12px; border: 1px solid #e5e7eb;";
        const closedMessage = document.createElement("div");
        closedMessage.style.cssText = "text-align: center; color: var(--text-muted); font-weight: 600;";
        closedMessage.textContent = `This job is ${job.status || 'closed'}. Applications are no longer being accepted.`;
        closedSection.appendChild(closedMessage);
        contentSection.appendChild(closedSection);
      } else if (!isLoggedIn) {
        // Not logged in - show login prompt (inside contentSection)
        const loginSection = document.createElement("div");
        loginSection.style.cssText = "margin-top: 1.5rem; margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 1px solid #e5e7eb;";
        const loginMessage = document.createElement("div");
        loginMessage.style.cssText = "text-align: center;";
        loginMessage.innerHTML = `<div style="margin-bottom: 0.75rem; color: var(--text-main); font-weight: 600;">Log in to apply for this job</div><button class="btn btn-primary" id="loginToApplyBtn" style="width: 100%; padding: 0.75rem;">Log In / Sign Up</button>`;
        loginSection.appendChild(loginMessage);
        const loginBtn = loginMessage.querySelector("#loginToApplyBtn");
        if (loginBtn) {
          loginBtn.addEventListener("click", () => {
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            if (window.openAuthModal) {
              window.openAuthModal('login');
            }
          });
        }
        contentSection.appendChild(loginSection);
      }
      
      // Now append contentSection to modalContent (after all content including apply section is added)
      modalContent.appendChild(contentSection);

      // Customer view: Show start code if hustler is accepted but not started (NOT for completed jobs)
      if (user && user.id === job.postedByUserId && job.hustlerId && job.startCode && !job.startCodeVerified && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && job.status !== 'PAID') {
        const startCodeSection = document.createElement("div");
        startCodeSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf24;";
        
        const startCodeTitle = document.createElement("div");
        startCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #92400e; margin-bottom: 0.75rem;";
        startCodeTitle.textContent = "🔐 Start Code (Give to Hustler)";
        startCodeSection.appendChild(startCodeTitle);
        
        const startCodeDisplay = document.createElement("div");
        startCodeDisplay.style.cssText = "font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #92400e; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;";
        startCodeDisplay.textContent = job.startCode;
        startCodeSection.appendChild(startCodeDisplay);
        
        // Safety warning
        const safetyWarning = document.createElement("div");
        safetyWarning.style.cssText = "padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;";
        safetyWarning.innerHTML = `<div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">⚠️ Safety Warning</div><div style="font-size: 0.85rem; color: #991b1b;">Do not give the Start Code until the hustler is physically there and ready to begin the job.</div>`;
        startCodeSection.appendChild(safetyWarning);
        
        const startCodeInstructions = document.createElement("div");
        startCodeInstructions.style.cssText = "font-size: 0.9rem; color: #92400e; line-height: 1.5; margin-bottom: 0.75rem;";
        const expiresAt = job.startCodeExpiresAt ? new Date(job.startCodeExpiresAt) : null;
        const hoursLeft = expiresAt ? Math.max(0, Math.floor((expiresAt - new Date()) / (1000 * 60 * 60))) : 78;
        startCodeInstructions.innerHTML = `
          <div style="margin-bottom: 0.5rem;">Share this 6-digit code with your hustler when they arrive to start the job.</div>
          <div style="font-weight: 600;">⏰ Code expires in ${hoursLeft} hours. If not used, job will be cancelled and you'll be refunded.</div>
        `;
        startCodeSection.appendChild(startCodeInstructions);
        
        // Regenerate button
        const regenerateBtn = document.createElement("button");
        regenerateBtn.className = "btn btn-ghost";
        regenerateBtn.textContent = "🔄 Regenerate Code";
        regenerateBtn.style.cssText = "width: 100%; padding: 0.5rem; font-size: 0.85rem;";
        regenerateBtn.addEventListener("click", async () => {
          if (!confirm("Regenerate the start code? The old code will no longer work.")) return;
          try {
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/regenerate-start-code`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              }
            });
            if (!response.ok) throw new Error("Failed to regenerate");
            showToast("✅ Start code regenerated!");
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            openJobDetails(job.id);
          } catch (error) {
            showToast("Error regenerating code: " + error.message);
          }
        });
        startCodeSection.appendChild(regenerateBtn);
        
        contentSection.appendChild(startCodeSection);
      }
      
      // Customer view: Show completion code after job is started (IN_PROGRESS, NOT for completed jobs)
      if (user && user.id === job.postedByUserId && job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified) {
        const completionCodeSection = document.createElement("div");
        completionCodeSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #dcfce7; border-radius: 12px; border: 2px solid #16a34a;";
        
        const completionCodeTitle = document.createElement("div");
        completionCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #166534; margin-bottom: 0.75rem;";
        completionCodeTitle.textContent = "🔐 Completion Code (For Hustler)";
        completionCodeSection.appendChild(completionCodeTitle);
        
        const completionCodeDisplay = document.createElement("div");
        completionCodeDisplay.style.cssText = "font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #166534; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;";
        completionCodeDisplay.textContent = job.completionCode;
        completionCodeSection.appendChild(completionCodeDisplay);
        
        // Safety warning
        const safetyWarning = document.createElement("div");
        safetyWarning.style.cssText = "padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;";
        safetyWarning.innerHTML = `<div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">⚠️ Safety Warning</div><div style="font-size: 0.85rem; color: #991b1b;">Only give the Completion Code after the job is fully done and you are satisfied with the work.</div>`;
        completionCodeSection.appendChild(safetyWarning);
        
        const completionInstructions = document.createElement("div");
        completionInstructions.style.cssText = "font-size: 0.9rem; color: #166534; margin-bottom: 0.75rem;";
        completionInstructions.textContent = "The hustler will enter this code when the job is complete. Do not share it until you are satisfied with the work.";
        completionCodeSection.appendChild(completionInstructions);
        
        // Regenerate button
        const regenerateBtn = document.createElement("button");
        regenerateBtn.className = "btn btn-ghost";
        regenerateBtn.textContent = "🔄 Regenerate Code";
        regenerateBtn.style.cssText = "width: 100%; padding: 0.5rem; font-size: 0.85rem;";
        regenerateBtn.addEventListener("click", async () => {
          if (!confirm("Regenerate the completion code? The old code will no longer work.")) return;
          try {
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/regenerate-completion-code`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              }
            });
            if (!response.ok) throw new Error("Failed to regenerate");
            showToast("✅ Completion code regenerated!");
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            openJobDetails(job.id);
          } catch (error) {
            showToast("Error regenerating code: " + error.message);
          }
        });
        completionCodeSection.appendChild(regenerateBtn);
        
        contentSection.appendChild(completionCodeSection);
      }
      
      // Hustler view: Show start code input if accepted but not started (NOT for completed jobs)
      if (user && user.id === job.hustlerId && job.startCode && !job.startCodeVerified && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && job.status !== 'PAID') {
        const startCodeInputSection = document.createElement("div");
        startCodeInputSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #dbeafe; border-radius: 12px; border: 2px solid #3b82f6;";
        
        const startCodeTitle = document.createElement("div");
        startCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;";
        startCodeTitle.textContent = "🔐 Enter Start Code";
        startCodeInputSection.appendChild(startCodeTitle);
        
        const startCodeInstructions = document.createElement("div");
        startCodeInstructions.style.cssText = "font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;";
        startCodeInstructions.textContent = "Ask the customer for the 6-digit start code to begin the job.";
        startCodeInputSection.appendChild(startCodeInstructions);
        
        const codeInput = document.createElement("input");
        codeInput.type = "text";
        codeInput.id = `startCodeInput_${job.id}`;
        codeInput.placeholder = "Enter 6-digit code";
        codeInput.maxLength = 6;
        codeInput.style.cssText = "width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;";
        codeInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
        });
        startCodeInputSection.appendChild(codeInput);
        
        const verifyBtn = document.createElement("button");
        verifyBtn.className = "btn btn-primary";
        verifyBtn.textContent = "Verify & Start Job";
        verifyBtn.style.cssText = "width: 100%; padding: 0.75rem;";
        verifyBtn.addEventListener("click", async () => {
          const code = codeInput.value.trim();
          if (code.length !== 6) {
            showToast("Please enter a 6-digit code");
            return;
          }
          
          try {
            verifyBtn.disabled = true;
            verifyBtn.textContent = "Verifying...";
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-start`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ code })
            });
            
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.error || "Verification failed");
            }
            
            showToast("✅ Start code verified! Job is now active.");
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            openJobDetails(job.id);
            renderJobs();
          } catch (error) {
            showToast("Error: " + (error.message || "Failed to verify"));
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify & Start Job";
          }
        });
        startCodeInputSection.appendChild(verifyBtn);
        
        contentSection.appendChild(startCodeInputSection);
      }
      
      // Hustler view: Show completion code input if job is IN_PROGRESS (NOT for completed jobs)
      if (user && user.id === job.hustlerId && job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified) {
        const completionCodeInputSection = document.createElement("div");
        completionCodeInputSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #dbeafe; border-radius: 12px; border: 2px solid #3b82f6;";
        
        const completionCodeTitle = document.createElement("div");
        completionCodeTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;";
        completionCodeTitle.textContent = "🔐 Enter Completion Code";
        completionCodeInputSection.appendChild(completionCodeTitle);
        
        const completionCodeInstructions = document.createElement("div");
        completionCodeInstructions.style.cssText = "font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;";
        completionCodeInstructions.textContent = "Ask the customer for the 6-digit completion code to finish the job and release payment.";
        completionCodeInputSection.appendChild(completionCodeInstructions);
        
        const codeInput = document.createElement("input");
        codeInput.type = "text";
        codeInput.id = `completionCodeInput_${job.id}`;
        codeInput.placeholder = "Enter 6-digit code";
        codeInput.maxLength = 6;
        codeInput.style.cssText = "width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;";
        codeInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
        });
        completionCodeInputSection.appendChild(codeInput);
        
        const verifyBtn = document.createElement("button");
        verifyBtn.className = "btn btn-primary";
        verifyBtn.textContent = "Verify & Complete Job";
        verifyBtn.style.cssText = "width: 100%; padding: 0.75rem;";
        verifyBtn.addEventListener("click", async () => {
          const code = codeInput.value.trim();
          if (code.length !== 6) {
            showToast("Please enter a 6-digit code");
            return;
          }
          
          try {
            verifyBtn.disabled = true;
            verifyBtn.textContent = "Verifying...";
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ code })
            });
            
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.error || "Verification failed");
            }
            
            showToast("✅ Completion code verified! Job is now complete.");
            document.body.removeChild(modalOverlay);
            document.body.style.overflow = "";
            openJobDetails(job.id);
            renderJobs();
          } catch (error) {
            showToast("Error: " + (error.message || "Failed to verify"));
            verifyBtn.disabled = false;
            verifyBtn.textContent = "Verify & Complete Job";
          }
        });
        completionCodeInputSection.appendChild(verifyBtn);
        
        contentSection.appendChild(completionCodeInputSection);
      }
      

      // Customer view: Show applicants if job is posted by current user
      if (user && user.id === job.postedByUserId && (job.status === "OPEN" || job.status === "open")) {
        // Fetch offers from API
        let offers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (offersResponse.ok) {
            offers = await offersResponse.json();
            if (!Array.isArray(offers)) offers = [];
          }
        } catch (e) {
          console.error("Error fetching offers:", e);
        }

        if (offers.length > 0) {
          const applicantsSection = document.createElement("div");
          applicantsSection.style.cssText = "margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb;";
          
          const applicantsTitle = document.createElement("div");
          applicantsTitle.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 1rem;";
          applicantsTitle.textContent = `Applicants (${offers.length})`;
          applicantsSection.appendChild(applicantsTitle);

          offers.forEach((offer) => {
            const hustler = offer.hustler || state.users.find((x) => x.id === offer.hustlerId);
            if (!hustler) {
              // Try to fetch hustler from API
              (async () => {
                try {
                  const token = localStorage.getItem("hustl_token");
                  const userResponse = await fetch(`${API_BASE}/users/${offer.hustlerId}`, {
                    headers: token ? { "Authorization": `Bearer ${token}` } : {}
                  });
                  if (userResponse.ok) {
                    const fetchedHustler = await userResponse.json();
                    // Re-render this section with the fetched hustler
                    openJobDetails(job.id);
                  }
                } catch (e) {
                  console.error("Error fetching hustler:", e);
                }
              })();
              return;
            }

            const applicantCard = document.createElement("div");
            applicantCard.style.cssText = "padding: 1.25rem; background: white; border-radius: 12px; margin-bottom: 1rem; border: 2px solid #e5e7eb; transition: all 0.2s;";
            applicantCard.addEventListener("mouseenter", () => {
              applicantCard.style.borderColor = "var(--primary)";
              applicantCard.style.boxShadow = "0 4px 12px rgba(37, 99, 235, 0.1)";
            });
            applicantCard.addEventListener("mouseleave", () => {
              applicantCard.style.borderColor = "#e5e7eb";
              applicantCard.style.boxShadow = "none";
            });

            // Top row: Avatar, Name, Rating
            const topRow = document.createElement("div");
            topRow.style.cssText = "display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;";

            const avatar = document.createElement("div");
            avatar.style.cssText = "width: 60px; height: 60px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.5rem; flex-shrink: 0; cursor: pointer; border: 2px solid var(--primary-soft);";
            avatar.textContent = (hustler.name || hustler.email || "U")[0].toUpperCase();
            if (hustler.photoUrl) {
              avatar.innerHTML = `<img src="${hustler.photoUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
            }
            avatar.addEventListener("click", () => {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              if (typeof openUserProfile === 'function') {
                openUserProfile(hustler.id);
              }
            });
            topRow.appendChild(avatar);

            const nameRating = document.createElement("div");
            nameRating.style.cssText = "flex: 1; min-width: 0;";
            
            const name = document.createElement("div");
            name.style.cssText = "font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem; cursor: pointer;";
            name.textContent = hustler.name || hustler.username || hustler.email?.split('@')[0] || "Unknown User";
            name.addEventListener("click", () => {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              if (typeof openUserProfile === 'function') {
                openUserProfile(hustler.id);
              }
            });
            nameRating.appendChild(name);

            const rating = document.createElement("div");
            rating.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted);";
            const ratingValue = hustler.ratingAvg || hustler.rating || 5.0;
            const ratingCount = hustler.ratingCount || hustler.reviewCount || 0;
            rating.innerHTML = `⭐ <strong>${Number(ratingValue).toFixed(1)}</strong>`;
            if (ratingCount > 0) {
              rating.innerHTML += ` <span>(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>`;
            } else {
              rating.innerHTML += ` <span style="color: #9ca3af;">(No reviews yet)</span>`;
            }
            nameRating.appendChild(rating);
            topRow.appendChild(nameRating);

            applicantCard.appendChild(topRow);

            // Hustler Bio (if available)
            if (hustler.bio) {
              const bioBox = document.createElement("div");
              bioBox.style.cssText = "padding: 0.75rem; background: #f0f9ff; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--text-main); line-height: 1.5; border-left: 3px solid var(--primary);";
              bioBox.textContent = hustler.bio;
              applicantCard.appendChild(bioBox);
            }

            // Tools & Equipment (if available)
            if (hustler.tools) {
              const toolsBox = document.createElement("div");
              toolsBox.style.cssText = "padding: 0.75rem; background: #fef3c7; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.85rem; color: #92400e;";
              toolsBox.innerHTML = `<strong>🔧 Tools & Equipment:</strong> ${hustler.tools}`;
              applicantCard.appendChild(toolsBox);
            }

            // Their Pitch/Note
            if (offer.note) {
              const messageBox = document.createElement("div");
              messageBox.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.95rem; color: var(--text-main); line-height: 1.6; border: 1px solid #e5e7eb;";
              const pitchLabel = document.createElement("div");
              pitchLabel.style.cssText = "font-weight: 600; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;";
              pitchLabel.textContent = "💬 Why I'm a good fit:";
              messageBox.appendChild(pitchLabel);
              const pitchText = document.createElement("div");
              pitchText.style.cssText = "white-space: pre-wrap;";
              pitchText.textContent = offer.note;
              messageBox.appendChild(pitchText);
              applicantCard.appendChild(messageBox);
            }
            
            // Show proposed price
            const priceBox = document.createElement("div");
            priceBox.style.cssText = "padding: 0.75rem; background: #dcfce7; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.95rem; font-weight: 600;";
            const jobPrice = job.payType === "flat" ? Number(job.amount || job.flatAmount || 0) : Number(job.hourlyRate || 0);
            const proposedPrice = offer.proposedAmount ? Number(offer.proposedAmount) : jobPrice;
            
            if (offer.proposedAmount && proposedPrice !== jobPrice) {
              priceBox.style.background = "#fef3c7";
              priceBox.style.color = "#92400e";
              priceBox.innerHTML = `💰 <strong>Proposed: ${formatMoney(proposedPrice)}${job.payType === 'hourly' ? '/hr' : ''}</strong> <span style="font-weight: normal; font-size: 0.85rem; color: #78350f;">(Original: ${formatMoney(jobPrice)}${job.payType === 'hourly' ? '/hr' : ''})</span>`;
            } else {
              priceBox.style.color = "#166534";
              priceBox.innerHTML = `💰 <strong>Price: ${formatMoney(proposedPrice)}${job.payType === 'hourly' ? '/hr' : ''}</strong> <span style="font-weight: normal; font-size: 0.85rem; color: #15803d;">(Accepting listed price)</span>`;
            }
            applicantCard.appendChild(priceBox);

            const actionsRow = document.createElement("div");
            actionsRow.style.cssText = "display: flex; gap: 0.5rem;";

            const viewProfileBtn = document.createElement("button");
            viewProfileBtn.className = "btn btn-ghost";
            viewProfileBtn.textContent = "View Profile";
            viewProfileBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
            viewProfileBtn.addEventListener("click", () => {
              document.body.removeChild(modalOverlay);
              document.body.style.overflow = "";
              openUserProfile(hustler.id);
            });
            actionsRow.appendChild(viewProfileBtn);

            if (!job.hustlerId && !job.acceptedHustlerId) {
              const acceptBtn = document.createElement("button");
              acceptBtn.className = "btn btn-primary";
              acceptBtn.textContent = "Accept Hustler";
              acceptBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
              acceptBtn.addEventListener("click", async () => {
                acceptBtn.disabled = true;
                acceptBtn.textContent = "Accepting...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  
                  // First, try to accept the offer
                  let response = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });

                  if (!response.ok) {
                    const errorData = await response.json();
                    
                    // If payment is required, create payment intent and show payment modal
                    if (errorData.requiresPayment) {
                      acceptBtn.disabled = false;
                      acceptBtn.textContent = "Accept Hustler";
                      
                      // Create payment intent
                      const paymentResponse = await fetch(`${API_BASE}/payments/create-intent/offer/${offer.id}`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        }
                      });
                      
                      if (!paymentResponse.ok) {
                        const paymentError = await paymentResponse.json();
                        throw new Error(paymentError.error || "Failed to create payment");
                      }
                      
                      const paymentData = await paymentResponse.json();
                      
                      // Close job modal first
                      document.body.removeChild(modalOverlay);
                      document.body.style.overflow = "";
                      
                      // Show Stripe payment modal
                      await showStripePaymentModal(paymentData.clientSecret, job.id, async (paymentIntentId) => {
                        // After payment succeeds, accept the offer with paymentIntentId
                        try {
                          const acceptResponse = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                            method: 'POST',
                            headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ paymentIntentId })
                          });
                          
                          if (!acceptResponse.ok) {
                            const acceptError = await acceptResponse.json();
                            throw new Error(acceptError.error || "Failed to accept offer");
                          }
                          
                          showToast("✅ Hustler accepted! You can now message them.");
                          openJobDetails(job.id);
                          renderJobs();
                        } catch (acceptError) {
                          showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                        }
                      });
                      
                      return;
                    }
                    
                    throw new Error(errorData.error || 'Failed to accept hustler');
                  }

                  const data = await response.json();
                  
                  showToast("✅ Hustler accepted! You can now message them.");
                  document.body.removeChild(modalOverlay);
                  document.body.style.overflow = "";
                  openJobDetails(job.id);
                  renderJobs();
                } catch (error) {
                  console.error("Error accepting hustler:", error);
                  showToast("Failed to accept hustler: " + (error.message || "Unknown error"));
                  acceptBtn.disabled = false;
                  acceptBtn.textContent = "Accept Hustler";
                }
              });
              actionsRow.appendChild(acceptBtn);
            }

            applicantCard.appendChild(actionsRow);
            applicantsSection.appendChild(applicantCard);
          });

          contentSection.appendChild(applicantsSection);
        }
      }

      // Old code removed - keeping only essential parts
      if (false) {
        // Check if user already applied
        let userOffer = null;
        let allOffers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const response = await fetch(`/offers/${jobId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (response.ok) {
            const offersData = await response.json();
            allOffers = Array.isArray(offersData) ? offersData : [];
            userOffer = allOffers.find(o => o.hustlerId === user?.id);
          }
        } catch (error) {
          console.error("Error fetching offers:", error);
        }

        const applySection = document.createElement("div");
        applySection.style.marginTop = "1.5rem";
        applySection.style.padding = "1rem";
        applySection.style.background = "#f0f9ff";
        applySection.style.borderRadius = "8px";
        applySection.style.border = "1px solid #bae6fd";

        if (userOffer) {
          const appliedTitle = document.createElement("h3");
          appliedTitle.style.margin = "0 0 0.5rem 0";
          appliedTitle.style.fontSize = "1.1rem";
          appliedTitle.textContent = "You've Applied";
          applySection.appendChild(appliedTitle);

          const appliedStatus = document.createElement("div");
          appliedStatus.className = "muted";
          appliedStatus.style.marginBottom = "0.5rem";
          const offerStatus = (userOffer.status || "PENDING").toUpperCase();
          if (offerStatus === "ACCEPTED") {
            appliedStatus.textContent = "✓ Your application was accepted!";
            appliedStatus.style.color = "#059669";
          } else if (offerStatus === "DECLINED") {
            appliedStatus.textContent = "Your application was declined.";
            appliedStatus.style.color = "#dc2626";
          } else {
            appliedStatus.textContent = "Your application is pending customer review.";
          }
          applySection.appendChild(appliedStatus);

          if (userOffer.note) {
            const note = document.createElement("div");
            note.style.marginTop = "0.5rem";
            note.style.padding = "0.75rem";
            note.style.background = "#fff";
            note.style.borderRadius = "6px";
            note.style.fontSize = "0.9rem";
            note.textContent = userOffer.note;
            applySection.appendChild(note);
          }
          
          // Add message button if accepted
          if (offerStatus === "ACCEPTED" && job.customerId) {
            const messageBtn = document.createElement("button");
            messageBtn.className = "btn btn-primary";
            messageBtn.style.marginTop = "0.75rem";
            messageBtn.style.width = "100%";
            messageBtn.textContent = "💬 Message Customer";
            messageBtn.addEventListener("click", async () => {
              // Set active conversation and switch to messages view
              activeConversationJobId = job.id;
              overlay.remove();
              document.body.style.overflow = "";
              
              // Switch to messages view
              if (window.setView && typeof window.setView === 'function') {
                const funcStr = window.setView.toString();
                const isStub = funcStr.includes('not ready yet');
                if (!isStub) {
                  await window.setView("messages");
                } else {
                  // Use fallback
                  activeView = "messages";
                  window.activeView = "messages";
                  document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
                  const target = document.getElementById("view-messages");
                  if (target) target.style.display = "block";
                  document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === "messages"));
                  await renderAll();
                }
              }
              
              // Small delay to ensure messages view is rendered, then open conversation
              setTimeout(async () => {
                await renderMessagesView();
                // Find and click the conversation for this job
                const conversationItems = document.querySelectorAll('[data-job-id]');
                conversationItems.forEach(item => {
                  if (item.dataset.jobId === job.id) {
                    item.click();
                  }
                });
              }, 300);
            });
            applySection.appendChild(messageBtn);
            
            // Hustler verification codes section
            const hustlerVerifySection = document.createElement("div");
            hustlerVerifySection.style.marginTop = "1rem";
            
            const arrivalVerified = job.arrivalCodeVerified;
            const completionCode = job.completionCode;
            const completionVerified = job.completionCodeVerified;
            
            if (!arrivalVerified) {
              // Hustler needs to enter arrival code from customer
              hustlerVerifySection.innerHTML = `
                <div style="padding: 0.75rem; background: #fef3c7; border-radius: 8px; border: 2px solid #f59e0b;">
                  <div style="font-weight: 600; font-size: 0.9rem; color: #92400e; margin-bottom: 0.5rem;">🔐 Step 1: Enter Arrival Code</div>
                  <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.5rem;">When you arrive, ask the customer for their 4-digit arrival code.</div>
                  <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="hustlerArrivalInput_${job.id}" placeholder="Enter code" maxlength="4"
                      style="flex: 1; padding: 0.75rem; font-size: 1.25rem; text-align: center; letter-spacing: 0.2em; border: 2px solid #f59e0b; border-radius: 8px; font-family: 'Courier New', monospace;" />
                    <button id="verifyArrivalBtn_${job.id}" class="btn" style="padding: 0.75rem 1rem; background: #f59e0b; color: white; border: none;">I Arrived</button>
                  </div>
                </div>
              `;
            } else if (completionCode && !completionVerified) {
              // Hustler gives completion code to customer
              hustlerVerifySection.innerHTML = `
                <div style="padding: 0.75rem; background: #dcfce7; border-radius: 8px; border: 2px solid #16a34a; margin-bottom: 0.5rem;">
                  <div style="font-weight: 600; color: #166534; margin-bottom: 0.25rem;">✅ Arrival Confirmed!</div>
                  <div style="font-size: 0.85rem; color: #166534;">You can now start the job.</div>
                </div>
                <div style="padding: 0.75rem; background: #dbeafe; border-radius: 8px; border: 2px solid #3b82f6;">
                  <div style="font-weight: 600; font-size: 0.9rem; color: #1e40af; margin-bottom: 0.5rem;">🔐 Step 2: Completion Code</div>
                  <div style="font-size: 0.8rem; color: #1e3a8a; margin-bottom: 0.5rem;">When job is done, give this code to the customer to release payment:</div>
                  <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #1e40af; text-align: center; font-family: 'Courier New', monospace; padding: 0.5rem; background: white; border-radius: 8px;">
                    ${completionCode}
                  </div>
                </div>
              `;
            } else if (completionVerified) {
              hustlerVerifySection.innerHTML = `
                <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; border: 2px solid #16a34a; text-align: center;">
                  <div style="font-weight: 600; font-size: 1rem; color: #166534;">✅ Job Complete!</div>
                  <div style="font-size: 0.85rem; color: #166534; margin-top: 0.25rem;">Payment has been released to you.</div>
                </div>
              `;
            }
            
            applySection.appendChild(hustlerVerifySection);
            
            // Add event listener for arrival code verification
            if (!arrivalVerified) {
              const verifyBtn = document.getElementById(`verifyArrivalBtn_${job.id}`);
              const codeInput = document.getElementById(`hustlerArrivalInput_${job.id}`);
              if (verifyBtn && codeInput) {
                verifyBtn.addEventListener("click", async () => {
                  const code = codeInput.value.trim();
                  if (!code || code.length !== 4) {
                    showToast("Please enter a 4-digit code");
                    return;
                  }
                  try {
                    verifyBtn.disabled = true;
                    verifyBtn.textContent = "...";
                    const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-start`, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${authToken}`
                      },
                      body: JSON.stringify({ code })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                      throw new Error(data.error || "Verification failed");
                    }
                    showToast("✅ Arrival verified! Start the job.");
                    overlay.remove();
                    document.body.style.overflow = "";
                    openJobDetails(job.id); // Refresh
                  } catch (error) {
                    showToast("Error: " + (error.message || "Failed to verify"));
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = "I Arrived";
                  }
                });
                codeInput.addEventListener("keypress", (e) => {
                  if (e.key === "Enter") verifyBtn.click();
                });
              }
            }
          }
        } else {
          const applyTitle = document.createElement("h3");
          applyTitle.style.margin = "0 0 1rem 0";
          applyTitle.style.fontSize = "1.1rem";
          applyTitle.style.display = "flex";
          applyTitle.style.alignItems = "center";
          applyTitle.style.gap = "0.5rem";
          applyTitle.innerHTML = "🎯 Apply for this Job";
          applySection.appendChild(applyTitle);

          const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
          const originalAmount = job.payType === "flat" 
            ? Number(job.amount || 0)
            : (Number(job.hourlyRate || 0) * Number(job.estHours || 0) * teamSize);
          
          // Check if this is a hustler-suggested-price job
          const pricingOption = job.requirements?.pricing_option;
          const isHustlerSuggestedPrice = pricingOption === "hustlers_quote";
          
          // Enhanced Price Section - Uber-style
          const pricingSection = document.createElement("div");
          pricingSection.style.cssText = `
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
          `;

          // Show suggested price box only if hustler suggests price
          if (isHustlerSuggestedPrice) {
            const suggestedPriceBox = document.createElement("div");
            suggestedPriceBox.style.cssText = `
              background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
              border: 2px solid #f59e0b;
              border-radius: 12px;
              padding: 1rem;
              margin-bottom: 1rem;
              text-align: center;
            `;
            suggestedPriceBox.innerHTML = `
              <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.5rem; font-weight: 600;">💰 Suggested Price</div>
              <div style="font-size: 1.75rem; font-weight: 700; color: #78350f;">$${originalAmount.toFixed(0)}</div>
              <div style="font-size: 0.85rem; color: #92400e; margin-top: 0.25rem;">You can suggest your own price below</div>
            `;
            pricingSection.appendChild(suggestedPriceBox);
          }

          // Customer's offered price (only show if not hustler-suggested-price)
          if (!isHustlerSuggestedPrice) {
            const customerOffer = document.createElement("div");
            customerOffer.style.cssText = `
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-bottom: 0.75rem;
              padding-bottom: 0.75rem;
              border-bottom: 1px solid #bae6fd;
            `;
            
            let priceDisplay = "";
            if (job.payType === "hourly") {
              const hourlyRate = Number(job.hourlyRate || 0);
              const estHours = job.estHours || 0;
              priceDisplay = `$${hourlyRate.toFixed(0)}/hr`;
              if (teamSize > 1) {
                priceDisplay += ` × ${teamSize} people`;
              }
              priceDisplay += ` · ${estHours}h max`;
            } else {
              priceDisplay = `$${originalAmount.toFixed(0)}`;
            }
            
            customerOffer.innerHTML = `
              <div>
                <div style="font-size: 0.8rem; color: #0369a1; margin-bottom: 0.25rem;">💰 Customer's Offer</div>
                <div style="font-size: 1.5rem; font-weight: 700; color: #0c4a6e;">${priceDisplay}</div>
              </div>
              <div style="text-align: right;">
                <span style="background: #0ea5e9; color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600;">
                  ${job.payType === "hourly" ? "HOURLY" : "FLAT RATE"}
                </span>
              </div>
            `;
            pricingSection.appendChild(customerOffer);
          }

          // Your Price section
          const yourPrice = document.createElement("div");
          
          // Price toggle tabs
          yourPrice.innerHTML = `
            <div style="font-size: 0.85rem; font-weight: 600; color: #0369a1; margin-bottom: 0.5rem;">
              💵 Your Price
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
              <button type="button" id="acceptPriceBtn" class="price-toggle-btn" style="flex: 1; padding: 0.6rem; border: 2px solid #10b981; background: #ecfdf5; color: #059669; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                ✓ Accept $${job.payType === "hourly" ? Number(job.hourlyRate || 0).toFixed(0) : originalAmount.toFixed(0)}
              </button>
              <button type="button" id="counterPriceBtn" class="price-toggle-btn" style="flex: 1; padding: 0.6rem; border: 2px solid #e2e8f0; background: white; color: #64748b; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                💬 Counter Offer
              </button>
            </div>
            <div id="counterOfferSection" style="display: none;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 1.25rem; color: #0f172a;">$</span>
                <input type="number" id="proposedAmount" value="${job.payType === "hourly" ? Number(job.hourlyRate || 0).toFixed(2) : originalAmount.toFixed(2)}" 
                  style="flex: 1; padding: 0.75rem; font-size: 1.25rem; font-weight: 600; border: 2px solid #3b82f6; border-radius: 8px; text-align: center;"
                  min="0" step="0.01" />
                <span style="font-size: 0.85rem; color: #64748b;">${job.payType === "hourly" ? "/hr" : "total"}</span>
              </div>
              <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #64748b; text-align: center;">
                Customer will see your suggested price
              </p>
            </div>
          `;
          pricingSection.appendChild(yourPrice);
          applySection.appendChild(pricingSection);

          // Hidden checkbox for compatibility with existing logic
          const negotiateCheckbox = document.createElement("input");
          negotiateCheckbox.type = "checkbox";
          negotiateCheckbox.id = "negotiatePrice";
          negotiateCheckbox.style.display = "none";
          applySection.appendChild(negotiateCheckbox);
          
          const proposedAmountField = document.getElementById("proposedAmount") || document.querySelector('#proposedAmount');

          // Add click handlers for price toggle buttons
          setTimeout(() => {
            const acceptBtn = document.getElementById("acceptPriceBtn");
            const counterBtn = document.getElementById("counterPriceBtn");
            const counterSection = document.getElementById("counterOfferSection");
            const negotiateCheck = document.getElementById("negotiatePrice");
            
            if (acceptBtn && counterBtn) {
              acceptBtn.addEventListener("click", () => {
                acceptBtn.style.border = "2px solid #10b981";
                acceptBtn.style.background = "#ecfdf5";
                acceptBtn.style.color = "#059669";
                counterBtn.style.border = "2px solid #e2e8f0";
                counterBtn.style.background = "white";
                counterBtn.style.color = "#64748b";
                counterSection.style.display = "none";
                if (negotiateCheck) negotiateCheck.checked = false;
              });
              
              counterBtn.addEventListener("click", () => {
                counterBtn.style.border = "2px solid #3b82f6";
                counterBtn.style.background = "#eff6ff";
                counterBtn.style.color = "#2563eb";
                acceptBtn.style.border = "2px solid #e2e8f0";
                acceptBtn.style.background = "white";
                acceptBtn.style.color = "#64748b";
                counterSection.style.display = "block";
                if (negotiateCheck) negotiateCheck.checked = true;
                const amtField = document.getElementById("proposedAmount");
                if (amtField) amtField.focus();
              });
            }
          }, 0);

          // "Why I'm a Good Fit" Section - Mini Application
          const applicationSection = document.createElement("div");
          applicationSection.style.cssText = `
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
          `;
          
          applicationSection.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="font-size: 1.25rem;">📝</span>
              <h4 style="margin: 0; font-size: 1rem; color: var(--text-main);">Your Application</h4>
            </div>
            
            <!-- Why I'm a Good Fit -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Why are you a good fit for this job? <span style="color: #ef4444;">*</span>
              </label>
              <textarea id="applyNoteField" rows="4" placeholder="Tell the customer about your experience, skills, and why you're perfect for this job..."
                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 100px;"></textarea>
              <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                <span style="font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">💡 Mention your experience</span>
                <span style="font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">🚚 List equipment you have</span>
                <span style="font-size: 0.75rem; color: #6b7280; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px;">📅 When you're available</span>
              </div>
            </div>
            
            <!-- Equipment You Have -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                What equipment do you have? <span style="color: #6b7280; font-weight: 400;">(optional)</span>
              </label>
              <div id="hustlerEquipmentChecks" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="truck" style="accent-color: var(--primary);" />
                  🚛 Truck
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="trailer" style="accent-color: var(--primary);" />
                  🚛 Trailer
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="straps" style="accent-color: var(--primary);" />
                  🔗 Moving Straps
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="dolly" style="accent-color: var(--primary);" />
                  🛒 Dolly
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="tools" style="accent-color: var(--primary);" />
                  🔧 Tools
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                  <input type="checkbox" name="hustlerEquipment" value="mower" style="accent-color: var(--primary);" />
                  🌿 Lawn Mower
                </label>
              </div>
            </div>
            
            <!-- Estimated Time -->
            <div style="margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Estimated time to complete <span style="color: #6b7280; font-weight: 400;">(optional)</span>
              </label>
              <select id="estimatedTime" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem; background: white;">
                <option value="">Select estimated time...</option>
                <option value="30min">30 minutes</option>
                <option value="1hr">1 hour</option>
                <option value="2hr">2 hours</option>
                <option value="3hr">3 hours</option>
                <option value="4hr">4 hours</option>
                <option value="half-day">Half day (4-6 hours)</option>
                <option value="full-day">Full day (6-8 hours)</option>
                <option value="multi-day">Multiple days</option>
              </select>
            </div>
            
            <!-- Price Reason (only shown when counter offer) -->
            <div id="priceReasonSection" style="display: none; margin-bottom: 1rem;">
              <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Why are you suggesting a different price? <span style="color: #ef4444;">*</span>
              </label>
              <textarea id="priceReasonField" rows="2" placeholder="Explain why your price is different (e.g., more equipment needed, extra distance, etc.)"
                style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical;"></textarea>
            </div>
          `;
          applySection.appendChild(applicationSection);
          
          // Show/hide price reason based on counter offer selection
          setTimeout(() => {
            const counterBtn = document.getElementById("counterPriceBtn");
            const acceptBtn = document.getElementById("acceptPriceBtn");
            const priceReasonSection = document.getElementById("priceReasonSection");
            
            if (counterBtn && priceReasonSection) {
              counterBtn.addEventListener("click", () => {
                priceReasonSection.style.display = "block";
              });
            }
            if (acceptBtn && priceReasonSection) {
              acceptBtn.addEventListener("click", () => {
                priceReasonSection.style.display = "none";
              });
            }
          }, 10);

          // Review Profile button
          const reviewProfileBtn = document.createElement("button");
          reviewProfileBtn.className = "small-btn outline";
          reviewProfileBtn.textContent = "👤 Review Customer Profile";
          reviewProfileBtn.style.width = "100%";
          reviewProfileBtn.style.marginBottom = "0.75rem";
          reviewProfileBtn.style.padding = "0.6rem";
          reviewProfileBtn.style.fontSize = "0.9rem";
          reviewProfileBtn.addEventListener("click", () => {
            openUserProfile(job.customerId);
          });
          applySection.appendChild(reviewProfileBtn);

          // Hidden noteField for compatibility - we'll populate it with structured data
          const noteField = document.createElement("textarea");
          noteField.id = "applyNoteFieldHidden";
          noteField.style.display = "none";
          applySection.appendChild(noteField);

          const applyBtn = document.createElement("button");
          applyBtn.className = "btn btn-primary";
          applyBtn.textContent = "Apply as Hustler";
          applyBtn.style.width = "100%";
          applyBtn.style.minHeight = "48px"; // Better touch target
          applyBtn.style.fontSize = "1rem";
          applyBtn.style.fontWeight = "600";
          
          // Handle both click and touch events for better mobile support
          const handleApply = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // NOTE: We do NOT validate hustler's profile zip code
            // Hustlers can apply to any job in Tennessee, regardless of their profile location
            // The backend validates that the JOB is in Tennessee (via pickupZip)
            
            // Get "Why I'm a Good Fit" text
            const whyFitField = document.getElementById("applyNoteField");
            const whyFit = whyFitField ? whyFitField.value.trim() : "";
            if (!whyFit) {
              showToast("Please explain why you're a good fit for this job.");
              if (whyFitField) whyFitField.focus();
              return;
            }
            
            // Get equipment the hustler has
            const equipmentChecks = document.querySelectorAll('input[name="hustlerEquipment"]:checked');
            const equipment = Array.from(equipmentChecks).map(cb => cb.value);
            
            // Get estimated time
            const estTimeSelect = document.getElementById("estimatedTime");
            const estimatedTime = estTimeSelect ? estTimeSelect.value : "";
            
            // Get proposed amount if negotiating (counter offer)
            let proposedAmount = null;
            let priceReason = "";
            const negotiateCheck = document.getElementById("negotiatePrice");
            const amtField = document.getElementById("proposedAmount");
            const priceReasonField = document.getElementById("priceReasonField");
            
            if (negotiateCheck && negotiateCheck.checked && amtField) {
              proposedAmount = parseFloat(amtField.value);
              if (isNaN(proposedAmount) || proposedAmount <= 0) {
                showToast("Please enter a valid proposed amount.");
                amtField.focus();
                return;
              }
              // Require price reason when counter offering
              priceReason = priceReasonField ? priceReasonField.value.trim() : "";
              if (!priceReason) {
                showToast("Please explain why you're suggesting a different price.");
                if (priceReasonField) priceReasonField.focus();
                return;
              }
            }
            
            // Build structured note with all application info
            let structuredNote = whyFit;
            if (equipment.length > 0) {
              structuredNote += `\n\n📦 Equipment I have: ${equipment.join(", ")}`;
            }
            if (estimatedTime) {
              const timeLabels = {
                "30min": "30 minutes",
                "1hr": "1 hour",
                "2hr": "2 hours",
                "3hr": "3 hours",
                "4hr": "4 hours",
                "half-day": "Half day (4-6 hours)",
                "full-day": "Full day (6-8 hours)",
                "multi-day": "Multiple days"
              };
              structuredNote += `\n\n⏱️ Estimated time: ${timeLabels[estimatedTime] || estimatedTime}`;
            }
            if (priceReason) {
              structuredNote += `\n\n💰 Price reason: ${priceReason}`;
            }
            
            const note = structuredNote;
            
            // Disable button and show loading state
            applyBtn.disabled = true;
            applyBtn.style.opacity = "0.6";
            applyBtn.style.cursor = "not-allowed";
            applyBtn.textContent = "Applying...";

            try {
              const token = localStorage.getItem("hustl_token");
              if (!token) {
                showToast("You must be logged in to apply for jobs.");
                applyBtn.disabled = false;
                applyBtn.style.opacity = "1";
                applyBtn.style.cursor = "pointer";
                applyBtn.textContent = "Apply as Hustler";
                return;
              }
              
              console.log("Creating offer for job:", job.id, "with note:", note, "proposedAmount:", proposedAmount);
              
              const response = await fetch(`/offers/${job.id}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                  note,
                  proposedAmount: proposedAmount ? Number(proposedAmount) : null
                })
              });
              
              const result = await response.json();
              
              if (!response.ok) {
                throw new Error(result.error || `Failed to apply: ${response.statusText}`);
              }
              
              console.log("Offer created successfully:", result);
              
              // Show success confirmation modal
              const successOverlay = document.createElement("div");
              successOverlay.className = "modal-overlay";
              successOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
              
              const successModal = document.createElement("div");
              successModal.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
              
              successModal.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Application Sent!</h2>
                <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
                  You've successfully applied to this job.<br>
                  The customer will review your proposal and respond soon.
                </p>
                <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem;">
                  You can manage this application in:<br>
                  <strong style="color: var(--text-main);">Manage → Applied Jobs</strong>
                </p>
                <button class="btn btn-primary" id="gotItBtn2" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
                  Got it
                </button>
              `;
              
              successOverlay.appendChild(successModal);
              document.body.appendChild(successOverlay);
              
              // Handle "Got it" button
              successOverlay.querySelector('#gotItBtn2').addEventListener('click', () => {
                document.body.removeChild(successOverlay);
                setView('manage');
                setTimeout(() => {
                  const appliedTab = document.getElementById('appliedJobsTab');
                  if (appliedTab) {
                    appliedTab.click();
                    if (typeof loadAppliedJobs === 'function') {
                      loadAppliedJobs();
                    }
                  }
                }, 100);
              });
              
              successOverlay.addEventListener('click', (e) => {
                if (e.target === successOverlay) {
                  document.body.removeChild(successOverlay);
                  setView('manage');
                  setTimeout(() => {
                    const appliedTab = document.getElementById('appliedJobsTab');
                    if (appliedTab) {
                      appliedTab.click();
                      if (typeof loadAppliedJobs === 'function') {
                        loadAppliedJobs();
                      }
                    }
                  }, 100);
                }
              });
              
              // Small delay before closing to show success
              setTimeout(() => {
                overlay.remove();
                document.body.style.overflow = "";
                renderJobs();
              }, 500);
            } catch (error) {
              console.error("Error applying for job:", error);
              let errorMsg = error.message || error.toString() || "Failed to apply. Please try again.";
              
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // Check if it's a Stripe requirement error
              /*
              if \(errorMsg.includes\("Stripe"\) \|\| errorMsg.includes\("stripe"\) \|\| error\.requiresStripe\) \{
                errorMsg = "You must connect your Stripe account before applying to jobs. Go to your Profile to set it up.";
                showToast\("âš ï¸ " + errorMsg, 5000\);
                // Close modal and redirect to profile after a moment
                setTimeout\(\(\) => \{
                  overlay\.remove\(\);
                  document\.body\.style\.overflow = "";
                  setView\("profile"\);
                  renderAll\(\);
                  // Scroll to Stripe section
                  setTimeout\(\(\) => \{
                    const stripeSection = document\.querySelector\('\[id\*="stripe"\], \[class\*="stripe"\]'\);
                    if \(stripeSection\) \{
                      stripeSection\.scrollIntoView\(\{ behavior: "smooth", block: "center" \}\);
                    \}
                  \}, 500\);
                \}, 2000\);
                applyBtn\.disabled = false;
                applyBtn\.style\.opacity = "1";
                applyBtn\.style\.cursor = "pointer";
                applyBtn\.textContent = "Apply as Hustler";
                return;
              \}
              \*/
              
              // Show error message
              showToast("Error: " + errorMsg);
              
              applyBtn.disabled = false;
              applyBtn.style.opacity = "1";
              applyBtn.style.cursor = "pointer";
              applyBtn.textContent = "Apply as Hustler";
            }
          };
          
          applyBtn.addEventListener("click", handleApply);
          applyBtn.addEventListener("touchend", handleApply); // Mobile touch support
          applySection.appendChild(applyBtn);
        }

        contentSection.appendChild(applySection);
      }

      // Action Buttons Section
      const actionsSection = document.createElement("div");
      actionsSection.style.marginTop = "1.5rem";
      actionsSection.style.paddingTop = "1.5rem";
      actionsSection.style.borderTop = "1px solid var(--border)";

      // Customer Actions: Payment, Delete/Cancel job
      if (user && user.id === job.customerId && userMode === "customer") {
        
        // Show Applications Section (when job is OPEN and no hustler assigned yet)
        if (!job.hustlerId && (job.status || "").toUpperCase() === "OPEN") {
          const applicationsSection = document.createElement("div");
          applicationsSection.style.cssText = `
            margin-top: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 1px solid #bae6fd;
          `;
          
          // Fetch offers for this job
          let offers = [];
          try {
            const token = localStorage.getItem("hustl_token");
            const response = await fetch(`/offers/${jobId}`, {
              headers: token ? { "Authorization": `Bearer ${token}` } : {}
            });
            if (response.ok) {
              offers = await response.json();
            }
          } catch (error) {
            console.error("Error fetching offers:", error);
          }
          
          const pendingOffers = offers.filter(o => o.status === "PENDING");
          
          const sectionHeader = document.createElement("div");
          sectionHeader.style.cssText = `
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
          `;
          sectionHeader.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-size: 1.5rem;">📬</span>
              <div>
                <h3 style="margin: 0; font-size: 1.1rem; color: #0f172a;">Applications</h3>
                <div style="font-size: 0.8rem; color: #64748b;">${pendingOffers.length} ${pendingOffers.length === 1 ? 'hustler' : 'hustlers'} applied</div>
              </div>
            </div>
          `;
          applicationsSection.appendChild(sectionHeader);
          
          if (pendingOffers.length === 0) {
            const emptyState = document.createElement("div");
            emptyState.style.cssText = `
              text-align: center;
              padding: 2rem 1rem;
              color: #64748b;
            `;
            emptyState.innerHTML = `
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">⏳</div>
              <div style="font-weight: 500;">No applications yet</div>
              <div style="font-size: 0.85rem; margin-top: 0.25rem;">Hustlers will start applying soon!</div>
            `;
            applicationsSection.appendChild(emptyState);
          } else {
            // Display each application as a card
            const applicationsGrid = document.createElement("div");
            applicationsGrid.style.cssText = `
              display: flex;
              flex-direction: column;
              gap: 1rem;
            `;
            
            for (const offer of pendingOffers) {
              const hustler = offer.hustler || {};
              const offerCard = document.createElement("div");
              offerCard.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 2px solid transparent;
                transition: all 0.2s;
              `;
              
              // Parse the note for structured data
              const noteText = offer.note || "";
              const hasEquipment = noteText.includes("📦 Equipment I have:");
              const hasEstTime = noteText.includes("⏱️ Estimated time:");
              const hasPriceReason = noteText.includes("💰 Price reason:");
              
              // Extract main message (before structured data)
              let mainMessage = noteText.split("\n\n📦")[0].split("\n\n⏱️")[0].split("\n\n💰")[0];
              
              // Extract equipment
              let equipment = "";
              if (hasEquipment) {
                const eqMatch = noteText.match(/📦 Equipment I have: ([^\n]+)/);
                if (eqMatch) equipment = eqMatch[1];
              }
              
              // Extract estimated time
              let estTime = "";
              if (hasEstTime) {
                const timeMatch = noteText.match(/⏱️ Estimated time: ([^\n]+)/);
                if (timeMatch) estTime = timeMatch[1];
              }
              
              // Extract price reason
              let priceReason = "";
              if (hasPriceReason) {
                const priceMatch = noteText.match(/💰 Price reason: ([^\n]+)/);
                if (priceMatch) priceReason = priceMatch[1];
              }
              
              // Price comparison
              const originalAmount = job.payType === "flat" 
                ? Number(job.amount || 0)
                : (Number(job.hourlyRate || 0) * Number(job.estHours || 0));
              const proposedAmount = offer.proposedAmount ? Number(offer.proposedAmount) : null;
              const isCounterOffer = proposedAmount && Math.abs(proposedAmount - originalAmount) > 0.01;
              
              offerCard.innerHTML = `
                <!-- Hustler Header -->
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                  <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">
                    ${(hustler.name || "H")[0].toUpperCase()}
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 1rem;">${hustler.name || hustler.username || "Hustler"}</div>
                    <div style="font-size: 0.8rem; color: #64748b;">
                      ${hustler.ratingAvg > 0 ? `⭐ ${Number(hustler.ratingAvg).toFixed(1)} (${hustler.ratingCount || 0} reviews)` : "New hustler"}
                      ${hustler.jobsCompleted > 0 ? ` · ${hustler.jobsCompleted} jobs done` : ""}
                    </div>
                  </div>
                  <button class="view-profile-btn" data-hustler-id="${offer.hustlerId}" style="padding: 0.4rem 0.75rem; background: transparent; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.8rem; color: #374151; cursor: pointer;">
                    View Profile
                  </button>
                </div>
                
                <!-- Price Section -->
                <div style="padding: 0.75rem; background: ${isCounterOffer ? '#fef3c7' : '#dcfce7'}; border-radius: 8px; margin-bottom: 0.75rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-size: 0.75rem; color: ${isCounterOffer ? '#92400e' : '#059669'}; margin-bottom: 0.25rem;">
                        ${isCounterOffer ? '💬 Counter Offer' : '✓ Accepts Your Price'}
                      </div>
                      <div style="font-size: 1.5rem; font-weight: 700; color: ${isCounterOffer ? '#92400e' : '#059669'};">
                        $${proposedAmount ? proposedAmount.toFixed(0) : originalAmount.toFixed(0)}
                        ${job.payType === "hourly" ? '/hr' : ''}
                      </div>
                    </div>
                    ${isCounterOffer ? `
                      <div style="text-align: right;">
                        <div style="font-size: 0.7rem; color: #92400e;">Your offer: $${originalAmount.toFixed(0)}</div>
                        <div style="font-size: 0.75rem; color: ${proposedAmount > originalAmount ? '#dc2626' : '#059669'}; font-weight: 600;">
                          ${proposedAmount > originalAmount ? '+' : ''}$${(proposedAmount - originalAmount).toFixed(0)}
                        </div>
                      </div>
                    ` : ''}
                  </div>
                  ${priceReason ? `
                    <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid ${isCounterOffer ? '#fcd34d' : '#86efac'}; font-size: 0.85rem; color: ${isCounterOffer ? '#92400e' : '#166534'};">
                      <strong>Reason:</strong> ${priceReason}
                    </div>
                  ` : ''}
                </div>
                
                <!-- Why I'm a Good Fit -->
                <div style="margin-bottom: 0.75rem;">
                  <div style="font-size: 0.75rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">📝 Why I'm a Good Fit</div>
                  <div style="font-size: 0.9rem; color: #1f2937; line-height: 1.5; padding: 0.5rem; background: #f9fafb; border-radius: 6px;">
                    ${mainMessage || "No message provided"}
                  </div>
                </div>
                
                <!-- Equipment & Time -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                  ${equipment ? `
                    <div style="padding: 0.4rem 0.75rem; background: #e0f2fe; border-radius: 6px; font-size: 0.8rem; color: #0369a1;">
                      📦 ${equipment}
                    </div>
                  ` : ''}
                  ${estTime ? `
                    <div style="padding: 0.4rem 0.75rem; background: #f3e8ff; border-radius: 6px; font-size: 0.8rem; color: #7c3aed;">
                      ⏱️ ${estTime}
                    </div>
                  ` : ''}
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.5rem;">
                  <button class="accept-offer-btn" data-offer-id="${offer.id}" style="flex: 1; padding: 0.75rem; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.95rem; cursor: pointer;">
                    ✓ Accept ${hustler.name ? hustler.name.split(' ')[0] : 'Hustler'}
                  </button>
                  <button class="decline-offer-btn" data-offer-id="${offer.id}" style="padding: 0.75rem 1rem; background: transparent; color: #dc2626; border: 1px solid #fca5a5; border-radius: 8px; font-weight: 500; cursor: pointer;">
                    ✗
                  </button>
                </div>
              `;
              
              applicationsGrid.appendChild(offerCard);
            }
            
            applicationsSection.appendChild(applicationsGrid);
          }
          
          actionsSection.appendChild(applicationsSection);
          
          // Add event handlers for application actions
          setTimeout(() => {
            // View Profile buttons
            applicationsSection.querySelectorAll('.view-profile-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                const hustlerId = btn.dataset.hustlerId;
                if (hustlerId) openUserProfile(hustlerId);
              });
            });
            
            // Accept buttons
            applicationsSection.querySelectorAll('.accept-offer-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const offerId = btn.dataset.offerId;
                if (!offerId) return;
                
                btn.disabled = true;
                btn.textContent = "Accepting...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  
                  // First, try to accept the offer
                  let response = await fetch(`/offers/${offerId}/accept`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${token}`
                    }
                  });
                  
                  if (!response.ok) {
                    const errorData = await response.json();
                    
                    // If payment is required, create payment intent and show payment modal
                    if (errorData.requiresPayment) {
                      btn.disabled = false;
                      btn.textContent = "✓ Accept";
                      
                      // Create payment intent
                      const paymentResponse = await fetch(`/payments/create-intent/offer/${offerId}`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        }
                      });
                      
                      if (!paymentResponse.ok) {
                        const paymentError = await paymentResponse.json();
                        throw new Error(paymentError.error || "Failed to create payment");
                      }
                      
                      const paymentData = await paymentResponse.json();
                      
                      // Show Stripe payment modal
                      await showStripePaymentModal(paymentData.clientSecret, jobId, async (paymentIntentId) => {
                        // After payment succeeds, accept the offer with paymentIntentId
                        try {
                          const acceptResponse = await fetch(`/offers/${offerId}/accept`, {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                              "Authorization": `Bearer ${token}`
                            },
                            body: JSON.stringify({ paymentIntentId })
                          });
                          
                          if (!acceptResponse.ok) {
                            const acceptError = await acceptResponse.json();
                            throw new Error(acceptError.error || "Failed to accept offer");
                          }
                          
                          showToast("✓ Hustler accepted! You can now message them.");
                          overlay.remove();
                          document.body.style.overflow = "";
                          openJobDetails(jobId); // Refresh
                        } catch (acceptError) {
                          showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                        }
                      });
                      
                      return;
                    }
                    
                    throw new Error(errorData.error || "Failed to accept");
                  }
                  
                  showToast("✓ Hustler accepted! You can now message them.");
                  overlay.remove();
                  document.body.style.overflow = "";
                  openJobDetails(jobId); // Refresh
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to accept"));
                  btn.disabled = false;
                  btn.textContent = "✓ Accept";
                }
              });
            });
            
            // Decline buttons
            applicationsSection.querySelectorAll('.decline-offer-btn').forEach(btn => {
              btn.addEventListener('click', async () => {
                const offerId = btn.dataset.offerId;
                if (!offerId) return;
                
                const card = btn.closest('div[style*="background: white"]');
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  await fetch(`/offers/${offerId}/reject`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${token}`
                    }
                  });
                  
                  if (card) {
                    card.style.opacity = "0.5";
                    card.style.transform = "scale(0.95)";
                    setTimeout(() => card.remove(), 300);
                  }
                  showToast("Application declined");
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to decline"));
                }
              });
            });
          }, 0);
        }
        
        // Show accepted hustler info if one is assigned
        if (job.hustlerId && job.hustler) {
          const hustlerInfo = document.createElement("div");
          hustlerInfo.style.marginBottom = "1rem";
          hustlerInfo.style.padding = "1rem";
          hustlerInfo.style.background = "#dcfce7";
          hustlerInfo.style.borderRadius = "8px";
          hustlerInfo.style.border = "1px solid #86efac";
          
          const statusUpper = (job.status || "").toUpperCase();
          let statusText = "";
          // Simplified status messages with verification flow
          if (statusUpper === "SCHEDULED" || statusUpper === "ASSIGNED") {
            if (!job.startCodeVerified) {
              statusText = "Give the start code to the hustler when they arrive and are ready to begin.";
            } else if (!job.completionCodeVerified) {
              statusText = "Job in progress. Enter completion code when done.";
            } else {
              statusText = "Job verified. Payment released!";
            }
          } else if (statusUpper === "PAID") {
            statusText = "Job is complete. Payment released!";
          } else if (statusUpper === "COMPLETED_BY_HUSTLER" || statusUpper === "AWAITING_CUSTOMER_CONFIRM") {
            statusText = "Hustler marked job as complete. Please confirm completion.";
          } else {
            statusText = "Job status: " + (statusUpper === "OPEN" ? "Open" : statusUpper === "CANCELLED" ? "Cancelled" : statusUpper);
          }
          
          // Check for hustler status update
          // requirements already declared above at line 4066, reuse it
          const hustlerStatus = requirements.hustlerStatus;
          const statusUpdatedAt = requirements.hustlerStatusUpdatedAt;
          
          let statusUpdateDisplay = "";
          if (hustlerStatus) {
            const statusMessages = {
              on_the_way: "🚗 On the way",
              starting: "🏁 Starting the job",
              almost_done: "⚡ Almost done",
              just_finished: "✅ Just finished",
            };
            const statusMsg = statusMessages[hustlerStatus] || hustlerStatus;
            const updatedTime = statusUpdatedAt ? timeAgo(new Date(statusUpdatedAt).getTime()) : "recently";
            statusUpdateDisplay = `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 4px; border: 1px solid #86efac;">
                <div style="font-weight: 600; font-size: 0.85rem; color: #059669; margin-bottom: 0.25rem;">📱 Hustler Status:</div>
                <div style="font-size: 0.9rem; color: #047857; font-weight: 600;">${statusMsg}</div>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Updated ${updatedTime}</div>
              </div>
            `;
          }
          
          // Uber-style verification codes
          let verificationCodeDisplay = "";
          const arrivalCode = job.arrivalCode;
          const arrivalVerified = job.arrivalCodeVerified;
          const completionCode = job.completionCode;
          const completionVerified = job.completionCodeVerified;
          
          // Customer sees: arrival code to give to hustler, then completion code input
          if (statusUpper === "ASSIGNED" && arrivalCode) {
            if (!arrivalVerified) {
              // Step 1: Customer gives arrival code to hustler
              verificationCodeDisplay = `
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dbeafe; border-radius: 6px; border: 2px solid #3b82f6;">
                  <div style="font-weight: 600; font-size: 0.85rem; color: #1e40af; margin-bottom: 0.5rem;">🔐 Step 1: Arrival Code</div>
                  <div style="font-size: 0.8rem; color: #1e3a8a; margin-bottom: 0.5rem;">Give this code to the hustler when they arrive to verify their identity.</div>
                  <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #1e40af; text-align: center; font-family: 'Courier New', monospace; padding: 0.5rem; background: white; border-radius: 8px;">
                    ${arrivalCode}
                  </div>
                  <div style="font-size: 0.75rem; color: #dc2626; text-align: center; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 4px; font-weight: 600;">
                    ⚠️ Only share when the hustler arrives in person
                  </div>
                </div>
              `;
            } else if (!completionVerified) {
              // Step 2: Hustler arrived, now awaiting completion code
              verificationCodeDisplay = `
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dcfce7; border-radius: 6px; border: 2px solid #16a34a;">
                  <div style="font-weight: 600; font-size: 0.85rem; color: #166534; margin-bottom: 0.5rem;">✅ Hustler Arrived!</div>
                  <div style="font-size: 0.8rem; color: #166534; margin-bottom: 0.75rem;">Job in progress. When complete, the hustler will give you a completion code.</div>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border: 2px solid #f59e0b;">
                  <div style="font-weight: 600; font-size: 0.85rem; color: #92400e; margin-bottom: 0.5rem;">🔐 Step 2: Enter Completion Code</div>
                  <div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.5rem;">When the job is done, enter the code from the hustler to release payment.</div>
                  <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="completionCodeInput_${job.id}" placeholder="Enter 4-digit code" maxlength="4" 
                      style="flex: 1; padding: 0.75rem; font-size: 1.25rem; text-align: center; letter-spacing: 0.2em; border: 2px solid #f59e0b; border-radius: 8px; font-family: 'Courier New', monospace;" />
                    <button id="verifyCompletionBtn_${job.id}" class="btn btn-primary" style="padding: 0.75rem 1rem; background: #f59e0b; border: none;">Verify</button>
                  </div>
                </div>
              `;
            } else {
              // Both verified!
              verificationCodeDisplay = `
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dcfce7; border-radius: 6px; border: 2px solid #16a34a;">
                  <div style="font-weight: 600; font-size: 1rem; color: #166534; text-align: center;">✅ Job Complete!</div>
                  <div style="font-size: 0.85rem; color: #166534; text-align: center; margin-top: 0.25rem;">Payment has been released to the hustler.</div>
                </div>
              `;
            }
          }
          
          hustlerInfo.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #059669;">✓ Hustler Assigned</div>
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
              <strong>${job.hustler.name || job.hustler.username || "Hustler"}</strong>
              ${job.hustler.ratingAvg > 0 ? ` · ⭐ ${job.hustler.ratingAvg.toFixed(1)} (${job.hustler.ratingCount})` : ''}
            </div>
            <div style="font-size: 0.85rem; color: #047857;">
              ${statusText}
            </div>
            ${statusUpdateDisplay}
            ${verificationCodeDisplay}
          `;
          
          // Add message button for customer to message hustler
          const messageBtnRow = document.createElement("div");
          messageBtnRow.style.display = "flex";
          messageBtnRow.style.gap = "0.5rem";
          messageBtnRow.style.marginTop = "0.75rem";
          
          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-primary";
          messageBtn.style.flex = "1";
          messageBtn.textContent = "💬 Message Hustler";
          messageBtn.addEventListener("click", async () => {
            // Set active conversation and switch to messages view
            activeConversationJobId = job.id;
            overlay.remove();
            document.body.style.overflow = "";
            
            // Switch to messages view
            if (window.setView && typeof window.setView === 'function') {
              const funcStr = window.setView.toString();
              const isStub = funcStr.includes('not ready yet');
              if (!isStub) {
                await window.setView("messages");
              } else {
                // Use fallback
                activeView = "messages";
                window.activeView = "messages";
                document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
                const target = document.getElementById("view-messages");
                if (target) target.style.display = "block";
                document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === "messages"));
                await renderAll();
              }
            }
            
            // Small delay to ensure messages view is rendered, then open conversation
            setTimeout(async () => {
              await renderMessagesView();
              // Find and click the conversation for this job
              const conversationItems = document.querySelectorAll('[data-job-id]');
              conversationItems.forEach(item => {
                if (item.dataset.jobId === job.id) {
                  item.click();
                }
              });
            }, 300);
          });
          messageBtnRow.appendChild(messageBtn);
          
          // Add view profile button
          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "btn";
          viewProfileBtn.style.background = "#fff";
          viewProfileBtn.style.color = "#059669";
          viewProfileBtn.style.border = "1px solid #86efac";
          viewProfileBtn.style.flex = "1";
          viewProfileBtn.textContent = "View Profile & Reviews";
          viewProfileBtn.addEventListener("click", () => {
            overlay.remove();
            document.body.style.overflow = "";
            openUserProfile(job.hustlerId);
          });
          messageBtnRow.appendChild(viewProfileBtn);
          
          hustlerInfo.appendChild(messageBtnRow);
          actionsSection.appendChild(hustlerInfo);
          
          // Add completion code verification handler
          if (verificationCodeDisplay && !completionVerified && arrivalVerified) {
            const verifyBtn = document.getElementById(`verifyCompletionBtn_${job.id}`);
            const codeInput = document.getElementById(`completionCodeInput_${job.id}`);
            if (verifyBtn && codeInput) {
              verifyBtn.addEventListener("click", async () => {
                const code = codeInput.value.trim();
                if (!code || code.length !== 4) {
                  showToast("Please enter a 4-digit code");
                  return;
                }
                try {
                  verifyBtn.disabled = true;
                  verifyBtn.textContent = "...";
                  const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ code })
                  });
                  const data = await response.json();
                  if (!response.ok) {
                    throw new Error(data.error || "Verification failed");
                  }
                  
                  overlay.remove();
                  document.body.style.overflow = "";
                  
                  // Show congratulations modal, then force review
                  showJobCompletionFlow(data.jobId, data.customerId, data.hustlerId);
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to verify"));
                  verifyBtn.disabled = false;
                  verifyBtn.textContent = "Verify";
                }
              });
              // Allow Enter key
              codeInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") verifyBtn.click();
              });
            }
          }
        }
        
        // Check if payment is needed (job is assigned but payment not completed)
        const jobStatusCheck = (job.status || "").toUpperCase();
        if (job.hustlerId && (jobStatusCheck === "ASSIGNED" || jobStatusCheck === "OPEN")) {
          // Check payment status
          let paymentNeeded = false;
          let paymentStatus = null;
          try {
            const payment = await window.hustlAPI.payments.getByJobId(job.id);
            paymentStatus = payment?.status;
            if (!payment || payment.status === "PREAUTHORIZED") {
              paymentNeeded = true;
            }
          } catch (error) {
            // Payment might not exist yet, so payment is needed
            paymentNeeded = true;
          }
          
          if (paymentNeeded) {
            const payBtn = document.createElement("button");
            payBtn.className = "btn btn-primary";
            payBtn.textContent = "Complete Payment";
            payBtn.style.marginBottom = "0.5rem";
            payBtn.addEventListener("click", async () => {
              try {
                // For now, show message - payment flow will be implemented
                showToast("Payment processing will be available soon. The job is assigned and ready to proceed.");
              } catch (error) {
                showToast("Error: " + (error.message || "Cannot process payment"));
              }
            });
            actionsSection.appendChild(payBtn);
            
            const paymentNote = document.createElement("div");
            paymentNote.className = "muted";
            paymentNote.style.fontSize = "0.85rem";
            paymentNote.style.marginBottom = "0.5rem";
            paymentNote.textContent = "Complete payment to finalize the job assignment.";
            actionsSection.appendChild(paymentNote);
          }
        }
        
        // Customer confirmation when hustler marked job complete
        const customerStatusCheck = (job.status || "").toUpperCase();
        if ((customerStatusCheck === "COMPLETED_BY_HUSTLER" || customerStatusCheck === "AWAITING_CUSTOMER_CONFIRM") && user && user.id === job.customerId) {
          const confirmBanner = document.createElement("div");
          confirmBanner.style.padding = "1rem";
          confirmBanner.style.marginBottom = "1rem";
          confirmBanner.style.background = "#fef3c7";
          confirmBanner.style.borderRadius = "8px";
          confirmBanner.style.border = "2px solid #fbbf24";
          
          const bannerTitle = document.createElement("div");
          bannerTitle.style.fontWeight = "600";
          bannerTitle.style.fontSize = "1rem";
          bannerTitle.style.marginBottom = "0.5rem";
          bannerTitle.textContent = "✓ Hustler marked job as complete!";
          confirmBanner.appendChild(bannerTitle);
          
          const bannerText = document.createElement("div");
          bannerText.style.fontSize = "0.9rem";
          bannerText.style.marginBottom = "0.75rem";
          bannerText.innerHTML = `
            <div style="margin-bottom: 0.5rem;">Please confirm that the job was completed to your satisfaction.</div>
            <div style="font-weight: 600; color: #059669;">Once you confirm, payment will be immediately released to the hustler.</div>
          `;
          confirmBanner.appendChild(bannerText);
          
          // Verification code input
          const verificationCode = job.requirements?.verificationCode;
          if (verificationCode) {
            const codeSection = document.createElement("div");
            codeSection.style.marginTop = "0.75rem";
            codeSection.style.marginBottom = "0.75rem";
            codeSection.style.padding = "0.75rem";
            codeSection.style.background = "#dbeafe";
            codeSection.style.borderRadius = "6px";
            codeSection.style.border = "1px solid #93c5fd";
            
            const codeLabel = document.createElement("div");
            codeLabel.style.fontSize = "0.85rem";
            codeLabel.style.fontWeight = "600";
            codeLabel.style.marginBottom = "0.5rem";
            codeLabel.textContent = "🔐 Enter Verification Code:";
            codeSection.appendChild(codeLabel);
            
            const codeInput = document.createElement("input");
            codeInput.type = "text";
            codeInput.placeholder = "Enter 6-digit code from hustler";
            codeInput.maxLength = 6;
            codeInput.style.width = "100%";
            codeInput.style.padding = "0.75rem";
            codeInput.style.fontSize = "1.2rem";
            codeInput.style.textAlign = "center";
            codeInput.style.letterSpacing = "0.2em";
            codeInput.style.border = "2px solid #93c5fd";
            codeInput.style.borderRadius = "6px";
            codeInput.style.fontWeight = "600";
            codeInput.addEventListener("input", (e) => {
              e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
            });
            codeSection.appendChild(codeInput);
            
            const codeHint = document.createElement("div");
            codeHint.style.fontSize = "0.8rem";
            codeHint.style.marginTop = "0.5rem";
            codeHint.style.color = "#64748b";
            codeHint.textContent = "The hustler should have shared this code with you. It confirms you're both on the same page.";
            codeSection.appendChild(codeHint);
            
            confirmBanner.appendChild(codeSection);
            
            // Store code input for use in confirm button
            confirmBanner.codeInput = codeInput;
          }
          
          // Show completion photos only if there's an issue (optional)
          if (job.requirements && job.requirements.completionPhotos && job.requirements.completionPhotos.length > 0) {
            const photosDiv = document.createElement("div");
            photosDiv.style.marginTop = "0.75rem";
            photosDiv.style.marginBottom = "0.75rem";
            photosDiv.style.padding = "0.75rem";
            photosDiv.style.background = "#fff";
            photosDiv.style.borderRadius = "6px";
            photosDiv.style.border = "1px solid #e5e7eb";
            
            const photosLabel = document.createElement("div");
            photosLabel.style.fontSize = "0.85rem";
            photosLabel.style.fontWeight = "600";
            photosLabel.style.marginBottom = "0.5rem";
            photosLabel.textContent = "📸 Photos from hustler (optional):";
            photosDiv.appendChild(photosLabel);
            
            const photosGrid = document.createElement("div");
            photosGrid.style.display = "grid";
            photosGrid.style.gridTemplateColumns = "repeat(auto-fill, minmax(100px, 1fr))";
            photosGrid.style.gap = "0.5rem";
            
            job.requirements.completionPhotos.forEach(photoUrl => {
              const img = document.createElement("img");
              img.src = photoUrl;
              img.style.width = "100%";
              img.style.height = "100px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "4px";
              img.style.cursor = "pointer";
              img.addEventListener("click", () => {
                window.open(photoUrl, "_blank");
              });
              photosGrid.appendChild(img);
            });
            
            photosDiv.appendChild(photosGrid);
            confirmBanner.appendChild(photosDiv);
          }
          
          const buttonRow = document.createElement("div");
          buttonRow.style.display = "flex";
          buttonRow.style.gap = "0.5rem";
          
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "btn btn-primary";
          confirmBtn.style.flex = "1";
          confirmBtn.textContent = "✓ Confirm & Release Payment";
          confirmBtn.addEventListener("click", async () => {
            const codeInput = confirmBanner.codeInput;
            let enteredCode = codeInput ? codeInput.value.trim() : null;
            
            // Remove any non-digit characters
            if (enteredCode) {
              enteredCode = enteredCode.replace(/\D/g, '');
            }
            
            if (verificationCode && (!enteredCode || enteredCode.length !== 6)) {
              showToast("Please enter the 6-digit verification code from the hustler.");
              if (codeInput) codeInput.focus();
              return;
            }
            
            if (!confirm("Confirm that the job was completed successfully? Payment will be released to the hustler.")) return;
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Confirming...";
            
            try {
              const result = await window.hustlAPI.jobs.confirmComplete(job.id, enteredCode);
              showToast("✓ Job confirmed! Payment has been released to the hustler.");
              
              // Close the job details modal first
              overlay.remove();
              document.body.style.overflow = "";
              
              // Refresh jobs list and profile to show updated status (COMPLETED with purple badge)
              renderJobs();
              renderProfile();
              
              // Job is now COMPLETED - both parties can review each other
              // Show review modal for customer to review hustler
              if (job.hustlerId) {
                setTimeout(() => {
                  showReviewModal(job.id, job.hustlerId, job.hustler?.name || "Hustler");
                }, 300);
              }
              
              // Note: Hustler can also review customer - they'll see the option when they view the job
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to confirm completion"));
              confirmBtn.disabled = false;
              confirmBtn.textContent = "✓ Confirm & Release Payment";
            }
          });
          buttonRow.appendChild(confirmBtn);
          
          // Report issue button
          const reportBtn = document.createElement("button");
          reportBtn.className = "btn";
          reportBtn.style.background = "#fee2e2";
          reportBtn.style.color = "#991b1b";
          reportBtn.style.border = "1px solid #fecaca";
          reportBtn.textContent = "⚠ Report Issue";
          reportBtn.addEventListener("click", () => {
            const reason = prompt("What's the issue? (e.g., job not done, poor quality, wrong work)");
            if (reason) {
              showToast("Issue reported. Our team will review this. Payment is on hold until resolved.");
              // In production, this would call an API endpoint to create a dispute
            }
          });
          buttonRow.appendChild(reportBtn);
          
          confirmBanner.appendChild(buttonRow);
          actionsSection.appendChild(confirmBanner);
        }
        
        
        const canDelete = job.status === "OPEN" && !job.hustlerId;
        
        if (canDelete) {
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.style.marginLeft = "0.5rem";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          btnRow.appendChild(deleteBtn);

          contentSection.appendChild(btnRow);
        } else if (
          job.status === "open" &&
          job.paymentStatus !== "paid"
        ) {
          const deleteRow = document.createElement("div");
          deleteRow.style.marginTop = "0.4rem";
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          deleteRow.appendChild(deleteBtn);
          contentSection.appendChild(deleteRow);
        }
      }

            // Applicants & accept button (customer) - Enhanced view
      if (user && user.id === job.postedByUserId) {
        const appsBox = document.createElement("div");
        appsBox.className = "stat-card";
        appsBox.style.marginTop = "0.5rem";

        // Fetch offers from API
        let offers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (offersResponse.ok) {
            offers = await offersResponse.json();
            if (!Array.isArray(offers)) offers = [];
          }
        } catch (e) {
          console.error("Error fetching offers:", e);
        }

        if (!offers || offers.length === 0) {
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div><div class='muted'>No Hustlers have applied yet.</div>";
        } else {
          const hasAccepted = !!job.hustlerId || !!job.acceptedHustlerId;
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div>" +
            (hasAccepted
              ? "<div class='muted' style='margin-bottom: 1rem;'>You've already accepted a Hustler for this job.</div>"
              : "<div class='muted' style='margin-bottom: 1rem;'>Review applicants and select the best fit.</div>");

          offers.forEach((offer) => {
            const hustler = offer.hustler || state.users.find((x) => x.id === offer.hustlerId);
            if (!hustler) return;
            
            const isAccepted = (job.hustlerId === offer.hustlerId) || (job.acceptedHustlerId === offer.hustlerId);

            const applicantCard = document.createElement("div");
            applicantCard.style.cssText = "padding: 1rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #e5e7eb;";

            // Top row: Avatar + Name + Rating
            const topRow = document.createElement("div");
            topRow.style.cssText = "display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;";

            // Avatar
            const avatar = document.createElement("div");
            avatar.style.cssText = "width: 50px; height: 50px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.25rem; flex-shrink: 0; cursor: pointer;";
            avatar.textContent = (hustler.name || hustler.email || "U")[0].toUpperCase();
            if (hustler.photoUrl) {
              avatar.innerHTML = `<img src="${hustler.photoUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" />`;
            }
            avatar.addEventListener("click", () => openUserProfile(hustler.id));
            topRow.appendChild(avatar);

            // Name and Rating
            const nameRating = document.createElement("div");
            nameRating.style.cssText = "flex: 1;";
            
            const name = document.createElement("div");
            name.style.cssText = "font-weight: 600; color: var(--text-main); margin-bottom: 0.25rem; cursor: pointer;";
            name.textContent = hustler.name || hustler.username || hustler.email?.split('@')[0] || "Unknown User";
            name.addEventListener("click", () => openUserProfile(hustler.id));
            nameRating.appendChild(name);

            const rating = document.createElement("div");
            rating.style.cssText = "display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-muted);";
            const ratingValue = hustler.ratingAvg || hustler.rating || 5.0;
            const ratingCount = hustler.ratingCount || hustler.reviewCount || 0;
            rating.innerHTML = `⭐ ${Number(ratingValue).toFixed(1)}`;
            if (ratingCount > 0) {
              rating.innerHTML += ` <span>(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>`;
            } else {
              rating.innerHTML += ` <span style='color: #9ca3af;'>(No reviews yet)</span>`;
            }
            nameRating.appendChild(rating);
            topRow.appendChild(nameRating);

            applicantCard.appendChild(topRow);

            // Message from hustler
            if (offer.note) {
              const messageBox = document.createElement("div");
              messageBox.style.cssText = "padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.75rem; border: 1px solid #e5e7eb;";
              messageBox.innerHTML = `<div style="font-size: 0.85rem; color: var(--text-main); line-height: 1.5;">${offer.note}</div>`;
              applicantCard.appendChild(messageBox);
            }

            // Action buttons
            const actionsRow = document.createElement("div");
            actionsRow.style.cssText = "display: flex; gap: 0.5rem;";

            const viewProfileBtn = document.createElement("button");
            viewProfileBtn.className = "btn btn-ghost";
            viewProfileBtn.textContent = "View Profile";
            viewProfileBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
            viewProfileBtn.addEventListener("click", () => openUserProfile(hustler.id));
            actionsRow.appendChild(viewProfileBtn);

            if (isAccepted) {
              const acceptedBadge = document.createElement("div");
              acceptedBadge.style.cssText = "flex: 1; padding: 0.6rem; background: #dcfce7; color: #059669; border-radius: 8px; text-align: center; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; justify-content: center;";
              acceptedBadge.textContent = "✓ Accepted";
              actionsRow.appendChild(acceptedBadge);
            } else if (!hasAccepted) {
              const acceptBtn = document.createElement("button");
              acceptBtn.className = "btn btn-primary";
              acceptBtn.textContent = "Accept Hustler";
              acceptBtn.style.cssText = "flex: 1; padding: 0.6rem; font-size: 0.9rem;";
              acceptBtn.addEventListener("click", async () => {
                acceptBtn.disabled = true;
                acceptBtn.textContent = "Accepting...";
                
                try {
                  const token = localStorage.getItem("hustl_token");
                  
                  // First, try to accept the offer
                  let response = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });

                  if (!response.ok) {
                    const errorData = await response.json();
                    
                    // If payment is required, create payment intent and show payment modal
                    if (errorData.requiresPayment) {
                      acceptBtn.disabled = false;
                      acceptBtn.textContent = "Accept Hustler";
                      
                      // Create payment intent
                      const paymentResponse = await fetch(`${API_BASE}/payments/create-intent/offer/${offer.id}`, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Authorization": `Bearer ${token}`
                        }
                      });
                      
                      if (!paymentResponse.ok) {
                        const paymentError = await paymentResponse.json();
                        throw new Error(paymentError.error || "Failed to create payment");
                      }
                      
                      const paymentData = await paymentResponse.json();
                      
                      // Show Stripe payment modal
                      await showStripePaymentModal(paymentData.clientSecret, job.id, async (paymentIntentId) => {
                        // After payment succeeds, accept the offer with paymentIntentId
                        try {
                          const acceptResponse = await fetch(`${API_BASE}/offers/${offer.id}/accept`, {
                            method: 'POST',
                            headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ paymentIntentId })
                          });
                          
                          if (!acceptResponse.ok) {
                            const acceptError = await acceptResponse.json();
                            throw new Error(acceptError.error || "Failed to accept offer");
                          }
                          
                          showToast("✅ Hustler accepted for this job!");
                          openJobDetails(job.id);
                          renderJobs();
                        } catch (acceptError) {
                          showToast("Error accepting offer: " + (acceptError.message || "Unknown error"));
                        }
                      });
                      
                      return;
                    }
                    
                    throw new Error(errorData.error || 'Failed to accept hustler');
                  }

                  const data = await response.json();
                  
                  showToast("✅ Hustler accepted for this job!");
                  openJobDetails(job.id);
                  renderJobs();
                } catch (error) {
                  console.error("Error accepting hustler:", error);
                  showToast("Failed to accept hustler: " + (error.message || "Unknown error"));
                  acceptBtn.disabled = false;
                  acceptBtn.textContent = "Accept Hustler";
                }
              });
              actionsRow.appendChild(acceptBtn);
            }

            applicantCard.appendChild(actionsRow);
            appsBox.appendChild(applicantCard);
          });
        }
        contentSection.appendChild(appsBox);
      }


      // Apply area (hustler)
      if (
        user &&
        user.role === "hustler" &&
        job.status === "open" &&
        job.postedByUserId !== user.id
      ) {
        const already = job.applicants?.some((a) => a.userId === user.id);
        const applyBox = document.createElement("div");
        applyBox.className = "stat-card";
        applyBox.style.marginTop = "0.5rem";

        if (already) {
          applyBox.innerHTML =
            "<div class='stat-label'>Your application</div><div class='muted'>You’ve already applied. Use job chat to send updates.</div>";
        } else {
          applyBox.innerHTML =
            "<div class='stat-label'>Apply for this job</div>";
          const msgField = document.createElement("textarea");
          msgField.placeholder =
            "Tell them when you can do it, if you have a truck, etc.";
          msgField.style.marginTop = "0.25rem";

          const priceField = document.createElement("input");
          priceField.type = "number";
          priceField.min = "0";
          priceField.step = "1";
          priceField.placeholder = "Suggested flat price (optional)";
          priceField.style.marginTop = "0.25rem";

          const btn = document.createElement("button");
          btn.className = "btn btn-primary";
          btn.style.marginTop = "0.4rem";
          btn.textContent = "Apply as a Hustler";
          btn.addEventListener("click", () => {
            const msg = msgField.value.trim();
            const suggestedPrice = Number(priceField.value) || null;
            job.applicants = job.applicants || [];
            job.applicants.push({
              userId: user.id,
              message: msg,
              suggestedPrice,
              createdAt: Date.now(),
            });
            saveState();
            showToast("Applied for job.");
            renderAll();
            openJobDetails(job.id);
          });

          applyBox.appendChild(msgField);
          applyBox.appendChild(priceField);
          applyBox.appendChild(btn);
        }

        contentSection.appendChild(applyBox);

        if (options.focusApply) {
          setTimeout(() => {
            applyBox.scrollIntoView({ behavior: "smooth" });
          }, 50);
        }
      }

      // Job chat
      const chatBox = document.createElement("div");
      chatBox.className = "chat-box";
      const messagesList = document.createElement("div");
      messagesList.className = "chat-messages";
      job.chatMessages = job.chatMessages || [];
      job.chatMessages.forEach((m) => {
        const msgEl = document.createElement("div");
        msgEl.className =
          "chat-msg " + (m.fromUserId === (user && user.id) ? "me" : "them");
        msgEl.textContent = m.text;
        messagesList.appendChild(msgEl);

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const sender = state.users.find((u) => u.id === m.fromUserId);
        meta.innerHTML = "";
        if (sender) {
          const link = document.createElement("span");
          link.className = "linkish";
          link.textContent = sender.name || "Unknown";
          link.addEventListener("click", () => openUserProfile(sender.id));
          meta.appendChild(link);
        } else {
          meta.append("Unknown");
        }
        meta.append(" · " + timeAgo(m.createdAt));

        messagesList.appendChild(meta);
      });
      chatBox.appendChild(messagesList);

      const chatRow = document.createElement("div");
      chatRow.className = "chat-input-row";
      const chatInput = document.createElement("input");
      chatInput.type = "text";
      chatInput.placeholder =
        user && user.id
          ? "Type a quick update or question..."
          : "Log in to send messages.";
      if (!user) chatInput.disabled = true;

      const sendBtn = document.createElement("button");
      sendBtn.className = "btn btn-primary";
      sendBtn.textContent = "Send";
      if (!user) sendBtn.disabled = true;
      sendBtn.addEventListener("click", () => {
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        const txt = chatInput.value.trim();
        if (!txt) return;
        job.chatMessages.push({
          id: generateId("m"),
          jobId: job.id,
          fromUserId: user.id,
          text: txt,
          createdAt: Date.now(),
        });
        chatInput.value = "";
        saveState();
        openJobDetails(job.id);
      });

      chatRow.appendChild(chatInput);
      chatRow.appendChild(sendBtn);
      chatBox.appendChild(chatRow);

      contentSection.appendChild(chatBox);

      // Hustler actions around completion
      if (
        user &&
        job.status === "assigned" &&
        user.id === job.acceptedHustlerId
      ) {
        const hustlerRow = document.createElement("div");
        hustlerRow.style.marginTop = "0.45rem";

        if (!job.completionRequestedAt && !job.dispute) {
          const markFinishedBtn = document.createElement("button");
          markFinishedBtn.className = "small-btn";
          markFinishedBtn.textContent = "Mark job finished";
          markFinishedBtn.addEventListener("click", () => {
            job.completionRequestedAt = Date.now();
            job.completionRequesterId = user.id;
            job.autoCompleted = false;
            saveState();
            showToast("Marked finished. Customer will be asked to confirm or report a problem.");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(markFinishedBtn);
        } else if (job.completionRequestedAt && !job.dispute) {
          const nudge = document.createElement("div");
          nudge.className = "muted";
          nudge.style.marginBottom = "0.25rem";
          nudge.textContent =
            "Waiting for the customer to confirm. If it has been a while, you can flag an issue.";
          hustlerRow.appendChild(nudge);

          const disputeBtn = document.createElement("button");
          disputeBtn.className = "small-btn outline";
          disputeBtn.textContent = "Customer won’t confirm completion";
          disputeBtn.addEventListener("click", () => {
            const reason = prompt(
              "Briefly describe the issue (for example, 'Customer not responding')."
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "hustler",
              reason: reason || "Customer not confirming completion",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(disputeBtn);
        }

        if (hustlerRow.children.length > 0) {
          contentSection.appendChild(hustlerRow);
        }
      }

      // Complete / dispute buttons (customer)
      if (
        user &&
        user.id === job.postedByUserId &&
        job.status === "assigned"
      ) {
        const completeRow = document.createElement("div");
        completeRow.style.marginTop = "0.45rem";

        if (job.completionRequestedAt && !job.dispute) {
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "small-btn";
          confirmBtn.textContent = "Confirm completion";
          confirmBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(confirmBtn);

          const problemBtn = document.createElement("button");
          problemBtn.className = "small-btn outline";
          problemBtn.style.marginLeft = "0.4rem";
          problemBtn.textContent = "Problem with job";
          problemBtn.addEventListener("click", () => {
            const reason = prompt(
              "What went wrong? (e.g., not done, poor quality, other)"
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "customer",
              reason: reason || "Issue with job",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(problemBtn);
        } else if (!job.dispute) {
          const completeBtn = document.createElement("button");
          completeBtn.className = "small-btn";
          completeBtn.textContent = "Mark job complete";
          completeBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(completeBtn);
        }

        if (completeRow.children.length > 0) {
          contentSection.appendChild(completeRow);
        }
      }

      modalContent.appendChild(contentSection);
      modalOverlay.appendChild(modalContent);
    }
    // Demo-only: no real Stripe redirect handling in this prototype
    function handleStripeReturn() {
      // In a real app, you'd look at URL params from Stripe here.
      // For this demo, we do nothing so the rest of the app can run.
    }

   
    /* ---------- Messages view ---------- */

    async function renderMessagesView() {
      console.log('[MESSAGES] renderMessagesView called');
      // Use API-based authentication instead of state-based
      let user = null;
      try {
        if (window.hustlAPI && window.hustlAPI.auth && typeof window.hustlAPI.auth.getCurrentUser === 'function') {
          user = await window.hustlAPI.auth.getCurrentUser();
        } else {
          // Fallback: try to get user from token
          const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
          if (token) {
            const response = await fetch(`${API_BASE}/users/me`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              user = await response.json();
            }
          }
        }
      } catch (error) {
        console.error('[MESSAGES] Error getting current user:', error);
      }
      console.log('[MESSAGES] User:', user ? user.id : 'not logged in');
      
      const convList = document.getElementById("conversationList");
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      
      console.log('[MESSAGES] Elements found:', {
        convList: !!convList,
        convTitle: !!convTitle,
        convSummary: !!convSummary,
        convMessages: !!convMessages
      });
      
      if (!convList) {
        console.error('[MESSAGES] conversationList element not found!');
        return;
      }

      // Not logged in: nothing to show
      if (!user) {
        convList.innerHTML =
          "<div class='muted'>Log in to see your job conversations.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        activeConversationThreadId = null;
        return;
      }

      // Fetch threads from API (only for ASSIGNED jobs)
      convList.innerHTML = "<div class='muted'>Loading conversations...</div>";
      
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          throw new Error('No authentication token');
        }

        console.log('[MESSAGES] Fetching threads from:', `${API_BASE}/threads`);
        const response = await fetch(`${API_BASE}/threads`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[MESSAGES] Failed to fetch threads:', response.status, errorText);
          throw new Error(`Failed to load conversations: ${response.status}`);
        }

        const threads = await response.json();
        console.log('[MESSAGES] Received threads:', threads.length, threads);
        convList.innerHTML = "";

        if (threads.length === 0) {
          convList.innerHTML =
            "<div class='muted' style='padding: 2rem; text-align: center;'>No conversations yet.<br>Messages will appear here once you have an assigned job.</div>";
          convTitle.textContent = "Select a conversation";
          convSummary.textContent = "";
          convMessages.innerHTML = "";
          activeConversationJobId = null;
          activeConversationThreadId = null;
          return;
        }

        // If nothing is selected yet, auto-open the first thread
        if (!activeConversationJobId && threads.length > 0) {
          activeConversationJobId = threads[0].job.id;
          activeConversationThreadId = threads[0].id;
        }

        threads.forEach((thread) => {
          const otherUser = user.id === thread.userAId ? thread.userB : thread.userA;
          const job = thread.job;

        const item = document.createElement("div");
        item.className = "job-card";
        item.style.cursor = "pointer";
        item.dataset.jobId = job.id;
        item.dataset.threadId = thread.id;

        // Highlight the active conversation and unread messages
        const unreadCount = thread.unreadCount || 0;
        const hasUnread = unreadCount > 0;
        
        if (job.id === activeConversationJobId) {
          item.style.borderColor = "#2563eb";
          item.style.boxShadow = "0 0 0 1px #2563eb20";
        } else if (hasUnread) {
          // Blue background for unread conversations
          item.style.background = "#eff6ff";
          item.style.borderColor = "#3b82f6";
          item.style.borderWidth = "2px";
          item.style.fontWeight = "600";
        }

        // Add other user's profile picture and name at the top (most prominent)
        const userInfo = document.createElement("div");
        userInfo.style.display = "flex";
        userInfo.style.alignItems = "center";
        userInfo.style.gap = "0.75rem";
        userInfo.style.marginBottom = "0.5rem";
        
        if (otherUser) {
          if (otherUser.photoUrl) {
            const photo = document.createElement("img");
            photo.src = otherUser.photoUrl;
            photo.style.width = "48px";
            photo.style.height = "48px";
            photo.style.borderRadius = "50%";
            photo.style.objectFit = "cover";
            photo.style.flexShrink = "0";
            userInfo.appendChild(photo);
          } else {
            const avatar = document.createElement("div");
            avatar.style.width = "48px";
            avatar.style.height = "48px";
            avatar.style.borderRadius = "50%";
            avatar.style.background = "var(--primary-soft)";
            avatar.style.display = "flex";
            avatar.style.alignItems = "center";
            avatar.style.justifyContent = "center";
            avatar.style.fontWeight = "700";
            avatar.style.color = "var(--primary)";
            avatar.style.fontSize = "1.1rem";
            avatar.style.flexShrink = "0";
            avatar.textContent = (otherUser.name || "U")[0].toUpperCase();
            userInfo.appendChild(avatar);
          }
          
          const nameAndJob = document.createElement("div");
          nameAndJob.style.flex = "1";
          nameAndJob.style.minWidth = "0";
          
          const name = document.createElement("div");
          name.style.fontWeight = "600";
          name.style.color = "var(--text-main)";
          name.style.fontSize = "1rem";
          name.style.marginBottom = "0.25rem";
          name.textContent = otherUser.name || "Unknown";
          nameAndJob.appendChild(name);
          
          // Job title below the name
          const jobTitle = document.createElement("div");
          jobTitle.style.display = "flex";
          jobTitle.style.alignItems = "center";
          jobTitle.style.gap = "0.5rem";
          jobTitle.style.fontSize = "0.85rem";
          
          const titleText = document.createElement("span");
          titleText.style.color = "var(--text-muted)";
          titleText.textContent = job.title;
          jobTitle.appendChild(titleText);
          
          // Add "Completed Job" badge if job is PAID
          if (job.status === 'PAID') {
            const completedBadge = document.createElement("span");
            completedBadge.style.background = "#dcfce7";
            completedBadge.style.color = "#166534";
            completedBadge.style.padding = "0.15rem 0.5rem";
            completedBadge.style.borderRadius = "4px";
            completedBadge.style.fontSize = "0.7rem";
            completedBadge.style.fontWeight = "600";
            completedBadge.textContent = "✅ Completed";
            jobTitle.appendChild(completedBadge);
          }
          
          nameAndJob.appendChild(jobTitle);
          
          userInfo.appendChild(nameAndJob);
        }
        item.appendChild(userInfo);
        
        // Show latest message preview if available
        const latestMessage = thread.messages && thread.messages.length > 0 ? thread.messages[0] : null;
        const previewContainer = document.createElement("div");
        previewContainer.className = "preview-container"; // Add class for lightweight refresh
        previewContainer.style.display = "flex";
        previewContainer.style.alignItems = "center";
        previewContainer.style.justifyContent = "space-between";
        previewContainer.style.marginTop = "0.25rem";
        previewContainer.style.gap = "0.5rem";
        
        if (latestMessage) {
          const messagePreview = document.createElement("div");
          messagePreview.className = "job-meta";
          messagePreview.style.color = hasUnread ? "#1e40af" : "var(--text-muted)";
          messagePreview.style.fontSize = "0.85rem";
          messagePreview.style.fontWeight = hasUnread ? "600" : "400";
          messagePreview.style.flex = "1";
          const previewText = latestMessage.body.length > 50 ? latestMessage.body.substring(0, 50) + "..." : latestMessage.body;
          messagePreview.textContent = previewText;
          previewContainer.appendChild(messagePreview);
        } else {
          const meta = document.createElement("div");
          meta.className = "job-meta";
          meta.style.color = "var(--text-muted)";
          meta.style.fontSize = "0.85rem";
          meta.style.flex = "1";
          meta.textContent = "No messages yet";
          previewContainer.appendChild(meta);
        }
        
        // Add unread badge
        if (hasUnread) {
          const unreadBadge = document.createElement("div");
          unreadBadge.className = "unread-badge"; // Add class for lightweight refresh
          unreadBadge.style.background = "#3b82f6";
          unreadBadge.style.color = "#fff";
          unreadBadge.style.borderRadius = "12px";
          unreadBadge.style.padding = "0.2rem 0.5rem";
          unreadBadge.style.fontSize = "0.75rem";
          unreadBadge.style.fontWeight = "700";
          unreadBadge.style.minWidth = "24px";
          unreadBadge.style.textAlign = "center";
          unreadBadge.textContent = unreadCount > 99 ? "99+" : unreadCount.toString();
          previewContainer.appendChild(unreadBadge);
        }
        
        item.appendChild(previewContainer);

        // Archive/Delete buttons
        const actionsRow = document.createElement("div");
        actionsRow.style.display = "flex";
        actionsRow.style.gap = "0.5rem";
        actionsRow.style.marginTop = "0.5rem";
        actionsRow.style.justifyContent = "flex-end";
        
        // Archive/Unarchive button
        const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
        const isArchived = archived.includes(job.id);
        const archiveBtn = document.createElement("button");
        archiveBtn.className = "small-btn";
        archiveBtn.style.background = isArchived ? "#dbeafe" : "#f3f4f6";
        archiveBtn.style.color = isArchived ? "#1e40af" : "#6b7280";
        archiveBtn.style.padding = "0.25rem 0.5rem";
        archiveBtn.style.fontSize = "0.75rem";
        archiveBtn.textContent = isArchived ? "📦 Unarchive" : "📦 Archive";
        archiveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
          if (isArchived) {
            const index = archived.indexOf(job.id);
            if (index > -1) {
              archived.splice(index, 1);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation unarchived");
              renderMessagesView();
            }
          } else {
            if (!archived.includes(job.id)) {
              archived.push(job.id);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation archived");
              renderMessagesView();
            }
          }
        });
        actionsRow.appendChild(archiveBtn);
        
        // Delete/Restore button (available for all jobs)
        const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
        const isDeleted = deleted.includes(job.id);
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "small-btn";
        deleteBtn.style.background = isDeleted ? "#fecaca" : "#fee2e2";
        deleteBtn.style.color = "#991b1b";
        deleteBtn.style.padding = "0.25rem 0.5rem";
        deleteBtn.style.fontSize = "0.75rem";
        deleteBtn.textContent = isDeleted ? "↩ Restore" : "🗑 Delete";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
          if (isDeleted) {
            const index = deleted.indexOf(job.id);
            if (index > -1) {
              deleted.splice(index, 1);
              localStorage.setItem("deletedConversations", JSON.stringify(deleted));
              showToast("Conversation restored");
              renderMessagesView();
            }
          } else {
            if (confirm("Delete this conversation? This will hide it from your messages list. You can restore it later.")) {
              if (!deleted.includes(job.id)) {
                deleted.push(job.id);
                localStorage.setItem("deletedConversations", JSON.stringify(deleted));
                showToast("Conversation deleted");
                renderMessagesView();
              }
            }
          }
        });
        actionsRow.appendChild(deleteBtn);
        
        item.appendChild(actionsRow);

        item.addEventListener("click", () => {
          activeConversationJobId = job.id;
          activeConversationThreadId = thread.id;
          // Reset message tracking for new conversation
          resetMessageTracking();
          // Re-render list (to update highlight) + right-hand chat
          renderMessagesView();
        });

        convList.appendChild(item);
      });

      // Finally, render the messages for the active conversation
      await renderConversation();
      
      // Initialize message input handler
      if (typeof initConversationInput === 'function') {
        initConversationInput();
      }
      } catch (error) {
        console.error("Error loading conversations:", error);
        convList.innerHTML = "<div class='muted' style='padding: 2rem; text-align: center;'>Error loading conversations. Please try again.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
      }
    }



    async function renderConversation() {
      // Use cached user to avoid repeated auth checks during refresh
      // Only fetch if not cached
      if (!window._cachedCurrentUser) {
        try {
          if (window.hustlAPI && window.hustlAPI.auth && typeof window.hustlAPI.auth.getCurrentUser === 'function') {
            window._cachedCurrentUser = await window.hustlAPI.auth.getCurrentUser();
          } else {
            // Fallback: try to get user from token
            const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
            if (token) {
              const response = await fetch(`${API_BASE}/users/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (response.ok) {
                window._cachedCurrentUser = await response.json();
              }
            }
          }
        } catch (error) {
          console.error('[CONVERSATION] Error getting current user:', error);
          window._cachedCurrentUser = null;
        }
      }
      const user = window._cachedCurrentUser;
      
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      
      if (!activeConversationThreadId || !user) {
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "<div class='empty-chat' style='text-align: center; padding: 3rem; color: var(--text-muted);'><div style='font-size: 3rem; margin-bottom: 1rem;'>💬</div><div style='font-weight: 600; margin-bottom: 0.5rem;'>No conversation selected</div><div style='font-size: 0.9rem;'>Pick a job from the list to start chatting</div></div>";
        return;
      }

      // Fetch messages from API
      convMessages.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading messages...</div>";
      
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          throw new Error('No authentication token');
        }

        const response = await fetch(`${API_BASE}/threads/${activeConversationThreadId}/messages`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load messages');
        }

        const messages = await response.json();
        
        // Also fetch thread details for job info
        const threadResponse = await fetch(`${API_BASE}/threads`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const threads = threadResponse.ok ? await threadResponse.json() : [];
        const thread = threads.find(t => t.id === activeConversationThreadId);
        
        if (thread) {
          convTitle.textContent = thread.job.title;
          const statusText = thread.job.status === 'PAID' ? '✅ Completed Job' : thread.job.status;
          convSummary.textContent = `Job ID: ${thread.job.id} · Status: ${statusText}`;
        }

        convMessages.innerHTML = "";
        
        if (messages.length === 0) {
          convMessages.innerHTML = "<div style='text-align: center; padding: 3rem; color: var(--text-muted);'><div style='font-size: 2rem; margin-bottom: 1rem;'>💬</div><div>No messages yet. Start the conversation!</div></div>";
          convMessages.scrollTop = convMessages.scrollHeight;
          // Start auto-refresh polling
          startMessagePolling();
          return;
        }

        messages.forEach((m) => {
          const isMe = m.senderId === user.id;
          
          // Create wrapper for message bubble and timestamp
          const wrapper = document.createElement("div");
          wrapper.className = "chat-msg-wrapper " + (isMe ? "me" : "them");
          wrapper.dataset.messageId = m.id; // Track message ID for lightweight refresh
          wrapper.dataset.senderId = m.senderId; // Track sender for isMe detection
          
          // Create message bubble
          const bubble = document.createElement("div");
          bubble.className = "chat-msg " + (isMe ? "me" : "them");
          bubble.textContent = m.body;
          wrapper.appendChild(bubble);
          
          // Create timestamp
          const timestamp = document.createElement("div");
          timestamp.className = "chat-msg-timestamp";
          timestamp.textContent = timeAgo(m.createdAt);
          wrapper.appendChild(timestamp);
          
          convMessages.appendChild(wrapper);
        });
        
        // Set lastMessageId for lightweight refresh
        if (messages.length > 0) {
          lastMessageId = messages[messages.length - 1].id;
        }
        
        convMessages.scrollTop = convMessages.scrollHeight;
        
        // Start auto-refresh polling for messages (lightweight version)
        startMessagePolling();
      } catch (error) {
        console.error("Error loading messages:", error);
        convMessages.innerHTML = "<div style='text-align: center; padding: 2rem; color: #dc2626;'>Error loading messages. Please try again.</div>";
      }
    }

    function initConversationInput() {
      const sendBtn = document.getElementById("conversationSendButton");
      const input = document.getElementById("conversationInput");
      if (!sendBtn || !input) return;
      
      // Remove existing listeners to avoid duplicates
      const newSendBtn = sendBtn.cloneNode(true);
      sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      
      newSendBtn.addEventListener("click", async () => {
        // Use API-based authentication instead of state-based
        let user = null;
        try {
          if (window.hustlAPI && window.hustlAPI.auth && typeof window.hustlAPI.auth.getCurrentUser === 'function') {
            user = await window.hustlAPI.auth.getCurrentUser();
          } else {
            // Fallback: try to get user from token
            const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
            if (token) {
              const response = await fetch(`${API_BASE}/users/me`, {
                headers: { 'Authorization': `Bearer ${token}` }
              });
              if (response.ok) {
                user = await response.json();
              }
            }
          }
        } catch (error) {
          console.error('[MESSAGE INPUT] Error getting current user:', error);
        }
        
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        if (!activeConversationThreadId) {
          showToast("Please select a conversation first.");
          return;
        }
        const text = newInput.value.trim();
        if (!text) return;
        
        // Disable input while sending
        newSendBtn.disabled = true;
        newInput.disabled = true;
        
        try {
          const token = localStorage.getItem('hustl_token');
          if (!token) {
            throw new Error('No authentication token');
          }

          const response = await fetch(`${API_BASE}/threads/${activeConversationThreadId}/messages`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ body: text })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || 'Failed to send message');
          }

          // Clear input and reload messages
          newInput.value = '';
          await renderConversation();
        } catch (error) {
          console.error("Error sending message:", error);
          showToast(error.message || "Failed to send message. Please try again.");
        } finally {
          newSendBtn.disabled = false;
          newInput.disabled = false;
        }
      });
      
      newInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          newSendBtn.click();
        }
      });
    }
    
    // Lightweight refresh functions - NO auth checks, NO full re-renders
    let lastMessageId = null; // Track last message ID to only append new ones
    
    async function refreshMessagesOnly() {
      // Only refresh if we have an active conversation
      if (!activeConversationThreadId) return;
      
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) return; // Don't refresh if no token - but don't trigger logout
        
        const response = await fetch(`${API_BASE}/threads/${activeConversationThreadId}/messages`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) return; // Silently fail - don't show errors
        
        const messages = await response.json();
        const convMessages = document.getElementById("conversationMessages");
        if (!convMessages) return;
        
        // Only append NEW messages (messages after lastMessageId)
        let foundNewMessages = false;
        const currentMessageIds = new Set(
          Array.from(convMessages.querySelectorAll('.chat-msg-wrapper'))
            .map(el => el.dataset.messageId)
            .filter(id => id)
        );
        
        messages.forEach((m) => {
          // Skip if message already exists
          if (currentMessageIds.has(m.id)) return;
          
          foundNewMessages = true;
          
          // Get current user ID from cached user (no auth check)
          // If no cached user, skip this message (will be added on next full render)
          const cachedUser = window._cachedCurrentUser || window.hustlAPI?.auth?.currentUser;
          if (!cachedUser) return; // Skip if no cached user - don't trigger auth check
          const isMe = m.senderId === cachedUser.id;
          
          // Create message bubble (same structure as renderConversation)
          const wrapper = document.createElement("div");
          wrapper.className = "chat-msg-wrapper " + (isMe ? "me" : "them");
          wrapper.dataset.messageId = m.id;
          wrapper.dataset.senderId = m.senderId;
          
          const bubble = document.createElement("div");
          bubble.className = "chat-msg " + (isMe ? "me" : "them");
          bubble.textContent = m.body;
          wrapper.appendChild(bubble);
          
          const timestamp = document.createElement("div");
          timestamp.className = "chat-msg-timestamp";
          timestamp.textContent = timeAgo(m.createdAt);
          wrapper.appendChild(timestamp);
          
          convMessages.appendChild(wrapper);
        });
        
        // Update lastMessageId
        if (messages.length > 0) {
          lastMessageId = messages[messages.length - 1].id;
        }
        
        // Scroll to bottom only if new messages were added
        if (foundNewMessages) {
          convMessages.scrollTop = convMessages.scrollHeight;
        }
      } catch (error) {
        // Silently fail - don't log or show errors during background refresh
        console.debug('[MESSAGES] Background refresh error (silent):', error);
      }
    }
    
    async function refreshConversationListUnreadCounts() {
      // Only update unread badges - don't re-render entire list
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) return;
        
        const response = await fetch(`${API_BASE}/threads`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) return;
        
        const threads = await response.json();
        const convList = document.getElementById("conversationList");
        if (!convList) return;
        
        // Update unread badges for each conversation item
        threads.forEach((thread) => {
          const item = convList.querySelector(`[data-thread-id="${thread.id}"]`);
          if (!item) return;
          
          const unreadCount = thread.unreadCount || 0;
          const hasUnread = unreadCount > 0;
          
          // Update unread badge
          let badge = item.querySelector('.unread-badge');
          if (hasUnread) {
            if (!badge) {
              badge = document.createElement("div");
              badge.className = "unread-badge";
              badge.style.background = "#3b82f6";
              badge.style.color = "#fff";
              badge.style.borderRadius = "12px";
              badge.style.padding = "0.2rem 0.5rem";
              badge.style.fontSize = "0.75rem";
              badge.style.fontWeight = "700";
              badge.style.minWidth = "24px";
              badge.style.textAlign = "center";
              
              const previewContainer = item.querySelector('.preview-container');
              if (previewContainer) {
                previewContainer.appendChild(badge);
              }
            }
            badge.textContent = unreadCount > 99 ? "99+" : unreadCount.toString();
            
            // Update styling for unread
            if (item.dataset.jobId !== activeConversationJobId) {
              item.style.background = "#eff6ff";
              item.style.borderColor = "#3b82f6";
              item.style.borderWidth = "2px";
              item.style.fontWeight = "600";
            }
            
            // Update message preview styling
            const preview = item.querySelector('.job-meta');
            if (preview) {
              preview.style.color = "#1e40af";
              preview.style.fontWeight = "600";
            }
          } else {
            // Remove badge if no unread
            if (badge) badge.remove();
            
            // Reset styling if not active
            if (item.dataset.jobId !== activeConversationJobId) {
              item.style.background = "";
              item.style.borderColor = "";
              item.style.borderWidth = "";
              item.style.fontWeight = "";
            }
            
            // Reset preview styling
            const preview = item.querySelector('.job-meta');
            if (preview) {
              preview.style.color = "var(--text-muted)";
              preview.style.fontWeight = "400";
            }
          }
        });
      } catch (error) {
        // Silently fail
        console.debug('[MESSAGES] Background unread refresh error (silent):', error);
      }
    }
    
    // Auto-refresh polling for messages - LIGHTWEIGHT VERSION
    function startMessagePolling() {
      // Stop any existing polling
      stopMessagePolling();
      
      // Only poll if we're on the messages view
      if (activeView !== 'messages') {
        return;
      }
      
      console.log('[MESSAGES] Starting lightweight auto-refresh polling');
      
      // Poll every 3 seconds (slightly less aggressive)
      messagePollInterval = setInterval(async () => {
        // Only poll if still on messages view
        if (activeView !== 'messages') {
          stopMessagePolling();
          return;
        }
        
        // Lightweight refresh - NO auth checks, NO full re-renders
        try {
          // Update unread counts in conversation list (lightweight)
          await refreshConversationListUnreadCounts();
          
          // Only refresh messages if we have an active conversation
          if (activeConversationThreadId) {
            await refreshMessagesOnly();
          }
        } catch (error) {
          // Silently fail - don't log errors during background refresh
          console.debug('[MESSAGES] Background refresh error (silent):', error);
        }
      }, 3000); // 3 seconds (less aggressive)
    }
    
    function stopMessagePolling() {
      if (messagePollInterval) {
        clearInterval(messagePollInterval);
        messagePollInterval = null;
        console.log('[MESSAGES] Stopped auto-refresh polling');
      }
    }
    
    // Reset lastMessageId when conversation changes
    function resetMessageTracking() {
      lastMessageId = null;
    }

    /* ---------- Profile ---------- */

    // Render Basic Info Section - View Mode
    function renderBasicInfoView(user, ratingAvg, ratingCount, container) {
      if (!container) {
        return;
      }
      const avatarContent = user.photoUrl 
        ? `<img src="${user.photoUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` 
        : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; color: var(--primary); background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%);">${(user.name || 'U')[0].toUpperCase()}</div>`;
      
      const genderLabel = user.gender ? 
        (user.gender === 'male' ? 'Male' : 
         user.gender === 'female' ? 'Female' : 
         user.gender === 'other' ? 'Non-binary' : 
         user.gender === 'prefer_not_to_say' ? 'Prefer not to say' : user.gender) : '';
      
      container.innerHTML = `
        <div class="card" style="padding: 2rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white;">
          <div style="display: flex; gap: 2rem; align-items: flex-start;">
            <!-- Profile Photo -->
            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 3px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              ${avatarContent}
            </div>
            
            <!-- Info -->
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                <div>
                  <h2 style="margin: 0; font-size: 1.75rem; font-weight: 700; color: var(--text-main);">${user.name || 'User'}</h2>
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                    <span style="font-size: 1.1rem;">⭐</span>
                    <span style="font-weight: 600; color: var(--text-main);">${ratingAvg.toFixed(1)}</span>
                    <span style="color: var(--text-muted); font-size: 0.9rem;">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                  </div>
                </div>
                <button class="btn btn-primary" id="basicInfoEditBtn" style="padding: 0.5rem 1rem; font-size: 0.9rem; white-space: nowrap;">Edit</button>
              </div>
              
              ${genderLabel ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">${genderLabel}</div>` : ''}
              
              ${user.bio ? `<div style="color: var(--text-main); line-height: 1.6; margin-top: 0.75rem; font-size: 0.95rem;">${user.bio}</div>` : '<div style="color: var(--text-muted); font-style: italic; margin-top: 0.75rem; font-size: 0.9rem;">No description yet.</div>'}
            </div>
          </div>
        </div>
      `;
      
      // Add Edit button handler
      setTimeout(() => {
        const editBtn = document.getElementById("basicInfoEditBtn");
        if (editBtn) {
          editBtn.addEventListener("click", () => {
            renderBasicInfoEdit(user, ratingAvg, ratingCount, container);
          });
        }
      }, 100);
    }
    
    // Render Basic Info Section - Edit Mode
    function renderBasicInfoEdit(user, ratingAvg, ratingCount, container) {
      let photoPreview = user.photoUrl || null;
      let newPhotoFile = null;
      
      const avatarContent = photoPreview 
        ? `<img src="${photoPreview}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` 
        : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; color: var(--primary); background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%);">${(user.name || 'U')[0].toUpperCase()}</div>`;
      
      container.innerHTML = `
        <div class="card" style="padding: 2rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white;">
          <div style="display: flex; gap: 2rem; align-items: flex-start;">
            <!-- Profile Photo with Upload -->
            <div style="flex-shrink: 0;">
              <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 3px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 1rem;" id="basicInfoPhotoPreview">
                ${avatarContent}
              </div>
              <input type="file" id="basicInfoPhotoUpload" accept="image/*" style="display: none;" />
              <button class="btn btn-ghost" onclick="document.getElementById('basicInfoPhotoUpload').click();" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">Upload new photo</button>
            </div>
            
            <!-- Edit Fields -->
            <div style="flex: 1; min-width: 0;">
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Full Name</label>
                <input type="text" id="basicInfoName" value="${(user.name || '').replace(/"/g, '&quot;')}" placeholder="Your full name" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: white;" />
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Gender (Optional)</label>
                <select id="basicInfoGender" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: white;">
                  <option value="">Select...</option>
                  <option value="male" ${user.gender === 'male' ? 'selected' : ''}>Male</option>
                  <option value="female" ${user.gender === 'female' ? 'selected' : ''}>Female</option>
                  <option value="other" ${user.gender === 'other' ? 'selected' : ''}>Non-binary</option>
                  <option value="prefer_not_to_say" ${user.gender === 'prefer_not_to_say' ? 'selected' : ''}>Prefer not to say</option>
                </select>
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.9rem;">Description / Bio</label>
                <textarea id="basicInfoBio" placeholder="Tell people about yourself, your experience, and what jobs you like to do." rows="4" maxlength="300" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical; background: white;">${(user.bio || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                <div style="text-align: right; color: var(--text-muted); font-size: 0.8rem; margin-top: 0.25rem;">
                  <span id="basicInfoBioCount">0</span>/300 characters
                </div>
              </div>
              
              <!-- Rating Display (read-only) -->
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                <span style="font-size: 1.1rem;">⭐</span>
                <span style="font-weight: 600; color: var(--text-main);">${ratingAvg.toFixed(1)}</span>
                <span style="color: var(--text-muted); font-size: 0.9rem;">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
              </div>
              
              <!-- Save/Cancel Buttons -->
              <div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <button class="btn btn-ghost" id="basicInfoCancelBtn" style="padding: 0.75rem 1.5rem;">Cancel</button>
                <button class="btn btn-primary" id="basicInfoSaveBtn" style="padding: 0.75rem 1.5rem;">Save</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Update bio character count
      const bioInput = document.getElementById("basicInfoBio");
      const bioCount = document.getElementById("basicInfoBioCount");
      if (bioInput && bioCount) {
        bioCount.textContent = bioInput.value.length;
        bioInput.addEventListener("input", () => {
          bioCount.textContent = bioInput.value.length;
        });
      }
      
      // Photo upload handler
      const photoUpload = document.getElementById("basicInfoPhotoUpload");
      const photoPreviewDiv = document.getElementById("basicInfoPhotoPreview");
      if (photoUpload && photoPreviewDiv) {
        photoUpload.addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          if (!file.type.startsWith('image/')) {
            showToast("Please select an image file.");
            return;
          }
          
          // Show preview
          const reader = new FileReader();
          reader.onload = (event) => {
            photoPreview = event.target.result;
            newPhotoFile = file;
            photoPreviewDiv.innerHTML = `<img src="${photoPreview}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          };
          reader.readAsDataURL(file);
        });
      }
      
      // Cancel button handler
      const cancelBtn = document.getElementById("basicInfoCancelBtn");
      if (cancelBtn) {
        cancelBtn.addEventListener("click", () => {
          renderBasicInfoView(user, ratingAvg, ratingCount, container);
        });
      }
      
      // Save button handler
      const saveBtn = document.getElementById("basicInfoSaveBtn");
      if (saveBtn) {
        saveBtn.addEventListener("click", async () => {
          const nameInput = document.getElementById("basicInfoName");
          const genderSelect = document.getElementById("basicInfoGender");
          const bioInput = document.getElementById("basicInfoBio");
          
          const name = nameInput?.value.trim() || '';
          const gender = genderSelect?.value || '';
          const bio = bioInput?.value.trim() || '';
          
          if (!name) {
            showToast("Please enter your name.");
            if (nameInput) nameInput.focus();
            return;
          }
          
          if (bio.length > 300) {
            showToast("Description must be 300 characters or less.");
            if (bioInput) bioInput.focus();
            return;
          }
          
          saveBtn.disabled = true;
          saveBtn.textContent = "Saving...";
          
          try {
            const updates = { name, gender, bio };
            
            // Upload photo if new one selected
            if (newPhotoFile) {
              const formData = new FormData();
              formData.append('photo', newPhotoFile);
              
              const token = localStorage.getItem('hustl_token');
              const uploadResponse = await fetch(`${API_BASE}/users/me/photo`, {
                method: 'POST',
                headers: token ? { 'Authorization': `Bearer ${token}` } : {},
                body: formData
              });
              
              if (uploadResponse.ok) {
                const uploadData = await uploadResponse.json();
                updates.photoUrl = uploadData.photoUrl || uploadData.user?.photoUrl;
              } else {
                const errorData = await uploadResponse.json().catch(() => ({}));
                throw new Error(errorData.error || "Failed to upload photo");
              }
            }
            
            // Update profile
            await window.hustlAPI.users.updateProfile(updates);
            
            // Update local storage
            const storedUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
            Object.assign(storedUser, updates);
            localStorage.setItem('hustl_user', JSON.stringify(storedUser));
            
            // Update user object for re-render
            Object.assign(user, updates);
            if (updates.photoUrl) {
              photoPreview = updates.photoUrl;
            }
            
            // Show success toast
            showToast("Profile updated.");
            
            // Return to view mode
            renderBasicInfoView(user, ratingAvg, ratingCount, container);
            
            // Re-render profile to update other sections
            setTimeout(() => renderProfile(), 500);
          } catch (error) {
            console.error("Error saving profile:", error);
            showToast("Error saving profile. Please try again.");
            saveBtn.disabled = false;
            saveBtn.textContent = "Save";
          }
        });
      }
    }

    async function renderProfile() {
  // Use API to get current user - always fetch fresh data
  let user = null;
  try {
    // Force fresh fetch by calling the API directly (bypass cache)
    const token = localStorage.getItem('hustl_token') || sessionStorage.getItem('hustl_token');
    if (token) {
      const response = await fetch(`${API_BASE}/users/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.ok) {
        user = await response.json();
        // Update cache with fresh data
        localStorage.setItem('hustl_user', JSON.stringify(user));
        if (window.hustlAPI && window.hustlAPI.auth) {
          window.hustlAPI.auth.currentUser = user;
        }
      } else {
        // Fallback to cached method
        user = await window.hustlAPI.auth.getCurrentUser();
      }
    } else {
      user = await window.hustlAPI.auth.getCurrentUser();
    }
  } catch (error) {
    console.error("Error getting user for profile:", error);
    // Try to use cached user as fallback
    try {
      const cached = localStorage.getItem('hustl_user');
      if (cached) user = JSON.parse(cached);
    } catch (e) {
      console.error("Error parsing cached user:", e);
    }
  }
  
  if (!user) {
    console.warn("No user data available for profile render");
    return;
  }
  
  const basicInfoSection = document.getElementById("profileBasicInfo");
  const stripeContent = document.getElementById("stripeConnectContent");
  const quickStats = document.getElementById("profileQuickStats");
  
  // jobsList might not exist if we're on Settings tab, that's OK
  const jobsList = document.getElementById("profileJobsList");

  if (!user) {
    if (basicInfoSection) basicInfoSection.innerHTML = `
      <div class='muted' style='padding: 2rem; text-align: center;'>
        <div style="margin-bottom: 1rem; font-size: 1.1rem;">Please log in to see your profile.</div>
        <button class="btn btn-primary" onclick="if(window.openAuthModal) window.openAuthModal('login'); else setView('auth');" style="padding: 0.75rem 1.5rem;">Log In / Sign Up</button>
      </div>
    `;
    if (quickStats) quickStats.innerHTML = "";
    if (jobsList) jobsList.innerHTML = "";
    return;
  }

  // figure out jobs related to this user
  const activeJobs = state.jobs.filter(
    (j) =>
      j.status !== "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );
  const completedJobs = state.jobs.filter(
    (j) =>
      j.status === "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );

  const totalEarned = state.jobs.reduce((sum, j) => {
    if (j.acceptedHustlerId === user.id && j.paymentStatus === "paid") {
      return sum + (j.hustlerPayoutAmount || 0);
    }
    return sum;
  }, 0);

  const totalSpent = state.jobs.reduce((sum, j) => {
    if (j.postedByUserId === user.id && j.paymentStatus === "paid") {
      return sum + (j.chargedAmount || 0);
    }
    return sum;
  }, 0);

  // Fetch ratings/reviews for Basic Info section
  let ratingAvg = 5.0;
  let ratingCount = 0;
  try {
    const token = localStorage.getItem('hustl_token');
    const reviewsResponse = await fetch(`${API_BASE}/reviews/user/${user.id}`, {
      headers: token ? { 'Authorization': `Bearer ${token}` } : {}
    });
    if (reviewsResponse.ok) {
      const reviewsData = await reviewsResponse.json();
      const reviews = Array.isArray(reviewsData) ? reviewsData : (reviewsData.reviews || []);
      ratingCount = reviews.length;
      if (reviews.length > 0) {
        const sum = reviews.reduce((acc, r) => acc + (r.stars || 5), 0);
        ratingAvg = sum / reviews.length;
      }
    }
  } catch (error) {
    console.error("Error fetching reviews:", error);
    // Continue with default values if fetch fails
  }

  // Render Basic Info Section (View Mode by default)
  if (basicInfoSection) {
    try {
      renderBasicInfoView(user, ratingAvg, ratingCount, basicInfoSection);
    } catch (error) {
      console.error("Error rendering Basic Info:", error);
      // Fallback: show basic info even if render fails
      basicInfoSection.innerHTML = `
        <div class="card" style="padding: 2rem; margin-bottom: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white;">
          <div style="display: flex; gap: 2rem; align-items: flex-start;">
            <div style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; flex-shrink: 0; border: 3px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; color: var(--primary);">
              ${(user.name || 'U')[0].toUpperCase()}
            </div>
            <div style="flex: 1; min-width: 0;">
              <h2 style="margin: 0; font-size: 1.75rem; font-weight: 700; color: var(--text-main);">${user.name || 'User'}</h2>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                <span style="font-size: 1.1rem;">⭐</span>
                <span style="font-weight: 600; color: var(--text-main);">${ratingAvg.toFixed(1)}</span>
                <span style="color: var(--text-muted); font-size: 0.9rem;">(${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
              </div>
              ${user.bio ? `<div style="color: var(--text-main); line-height: 1.6; margin-top: 0.75rem; font-size: 0.95rem;">${user.bio}</div>` : '<div style="color: var(--text-muted); font-style: italic; margin-top: 0.75rem; font-size: 0.9rem;">No description yet.</div>'}
            </div>
          </div>
        </div>
      `;
    }
  } else {
    console.error("profileBasicInfo element not found in DOM");
  }
  
  // Render Quick Stats (already got quickStats above, but check again)
  if (quickStats) {
    const isHustler = user.role === "HUSTLER" || user.role === "hustler";
    quickStats.innerHTML = `
      <div class="quick-stat-card">
        <div class="quick-stat-icon">✅</div>
        <div class="quick-stat-value">${completedJobs.length}</div>
        <div class="quick-stat-label">Jobs Done</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-icon">${isHustler ? '💰' : '💸'}</div>
        <div class="quick-stat-value">$${isHustler ? totalEarned.toFixed(0) : totalSpent.toFixed(0)}</div>
        <div class="quick-stat-label">Earned</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-icon">⭐</div>
        <div class="quick-stat-value">${user.rating || '5.0'}</div>
        <div class="quick-stat-label">Rating</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-icon">🔥</div>
        <div class="quick-stat-value">${activeJobs.length}</div>
        <div class="quick-stat-label">Active Jobs</div>
      </div>
    `;
  }
  
  // Render Earnings Tab Content
  const earningsContent = document.getElementById("profileEarningsContent");
  if (earningsContent) {
    const isHustler = user.role === "HUSTLER" || user.role === "hustler";
    earningsContent.innerHTML = `
      <div style="text-align: center; padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">${isHustler ? '💰' : '📊'}</div>
        <div style="font-size: 2rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">
          $${isHustler ? totalEarned.toFixed(2) : totalSpent.toFixed(2)}
        </div>
        <div style="color: var(--text-muted); margin-bottom: 1.5rem;">
          Total Earned
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; text-align: left;">
          <div style="padding: 1rem; background: #f0fdf4; border-radius: 10px;">
            <div style="font-size: 1.25rem; font-weight: 700; color: #16a34a;">✅ ${completedJobs.length}</div>
            <div style="font-size: 0.85rem; color: #15803d;">Completed Jobs</div>
          </div>
          <div style="padding: 1rem; background: #fef3c7; border-radius: 10px;">
            <div style="font-size: 1.25rem; font-weight: 700; color: #d97706;">🔄 ${activeJobs.length}</div>
            <div style="font-size: 0.85rem; color: #b45309;">In Progress</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Initialize Profile Tabs (call after a short delay to ensure DOM is ready)
  setTimeout(() => {
    initProfileTabs();
    
    // Populate Ratings tab when clicked
    const ratingsTab = document.querySelector('.profile-tab[data-tab="ratings"]');
    if (ratingsTab && !ratingsTab.dataset.listenerAttached) {
      ratingsTab.dataset.listenerAttached = 'true';
      ratingsTab.addEventListener('click', async () => {
        const ratingsContent = document.getElementById("profileRatingsContent");
        if (ratingsContent) {
          try {
            // Fetch reviews for this user
            const token = localStorage.getItem('hustl_token');
            const reviewsResponse = await fetch(`${API_BASE}/reviews/user/${user.id}`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            
            let reviews = [];
            if (reviewsResponse.ok) {
              const reviewsData = await reviewsResponse.json();
              reviews = Array.isArray(reviewsData) ? reviewsData : (reviewsData.reviews || []);
            }
            
            const ratingValue = document.getElementById("profileRatingValue");
            const ratingCount = document.getElementById("profileRatingCount");
            const reviewsList = document.getElementById("profileReviewsList");
            
            if (ratingValue) {
              ratingValue.textContent = user.ratingAvg ? user.ratingAvg.toFixed(1) : '5.0';
            }
            if (ratingCount) {
              ratingCount.textContent = `Based on ${user.ratingCount || 0} ${user.ratingCount === 1 ? 'review' : 'reviews'}`;
            }
            
            if (reviewsList) {
              if (reviews.length === 0) {
                reviewsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>No reviews yet. Complete jobs to get reviews!</div>";
              } else {
                reviewsList.innerHTML = reviews.map(review => `
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                      <div>
                        <div style="font-weight: 600; color: var(--text-main);">${review.reviewer?.name || 'Anonymous'}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${new Date(review.createdAt).toLocaleDateString()}</div>
                      </div>
                      <div style="font-size: 1.25rem;">${'⭐'.repeat(review.stars)}</div>
                    </div>
                    <div style="color: var(--text-main); line-height: 1.5;">${review.text || ''}</div>
                  </div>
                `).join('');
              }
            }
          } catch (error) {
            console.error("Error loading ratings:", error);
            const reviewsList = document.getElementById("profileReviewsList");
            if (reviewsList) {
              reviewsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading reviews.</div>";
            }
          }
        }
      });
    }
    
    // Populate Jobs tab when clicked - Simple list (full management moved to Manage Jobs view)
    const jobsTab = document.querySelector('.profile-tab[data-tab="jobs"]');
    if (jobsTab && !jobsTab.dataset.listenerAttached) {
      jobsTab.dataset.listenerAttached = 'true';
      jobsTab.addEventListener('click', async () => {
        const postedJobsList = document.getElementById("postedJobsList");
        const activeJobsList = document.getElementById("activeJobsList");
        
        if (postedJobsList && postedJobsList.innerHTML.includes("Loading")) {
          try {
            // Fetch user's jobs
            const token = localStorage.getItem('hustl_token');
            const response = await fetch(`${API_BASE}/jobs/my-jobs`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            
            if (!response.ok) throw new Error('Failed to fetch jobs');
            const jobs = await response.json();
            
            // Separate posted jobs (as customer) from active jobs (as hustler)
            const postedJobs = jobs.filter(j => j.customerId === user.id);
            const activeJobs = jobs.filter(j => j.hustlerId === user.id && j.status !== 'PAID' && j.status !== 'CANCELLED');
            
            // Render Posted Jobs
            if (postedJobs.length === 0) {
              postedJobsList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">📋</div>
                  <div>You haven't posted any jobs yet.</div>
                  <button class="btn btn-primary" onclick="setView('post')" style="margin-top: 1rem; padding: 0.75rem 1.5rem;">Post Your First Job</button>
                </div>
              `;
            } else {
              postedJobsList.innerHTML = "";
              for (const job of postedJobs) {
                // Fetch offer count for this job
                let offerCount = 0;
                try {
                  const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
                    headers: token ? { 'Authorization': `Bearer ${token}` } : {}
                  });
                  if (offersResponse.ok) {
                    const offers = await offersResponse.json();
                    offerCount = offers.filter(o => o.status === 'PENDING').length;
                  }
                } catch (e) {
                  console.error("Error fetching offers:", e);
                }
                
                const statusColors = {
                  'OPEN': '#10b981',
                  'SCHEDULED': '#f59e0b', // Orange for scheduled (waiting for start)
                  'ASSIGNED': '#3b82f6', // Blue for assigned (backwards compatibility)
                  'IN_PROGRESS': '#3b82f6', // Blue for in progress
                  'COMPLETED_BY_HUSTLER': '#10b981', // Green for completed
                  'AWAITING_CUSTOMER_CONFIRM': '#f59e0b',
                  'PAID': '#10b981', // Green for completed
                  'CANCELLED': '#ef4444'
                };
                
                const statusLabels = {
                  'OPEN': 'Open',
                  'SCHEDULED': 'Scheduled',
                  'ASSIGNED': 'Assigned',
                  'IN_PROGRESS': 'In Progress',
                  'COMPLETED_BY_HUSTLER': 'Awaiting Confirmation',
                  'AWAITING_CUSTOMER_CONFIRM': 'Awaiting Confirmation',
                  'PAID': 'Completed',
                  'CANCELLED': 'Cancelled'
                };
                
                const jobStatus = (job.status || 'OPEN').toUpperCase();
                const statusColor = statusColors[jobStatus] || '#6b7280';
                const statusLabel = statusLabels[jobStatus] || jobStatus;
                
                const jobCard = document.createElement("div");
                jobCard.style.cssText = "padding: 1.25rem; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1rem; background: white; transition: all 0.2s;";
                jobCard.style.cursor = "default";
                jobCard.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted);">
                        <span>📅 ${new Date(job.createdAt).toLocaleDateString()}</span>
                        <span>💰 $${parseFloat(job.amount || 0).toFixed(2)}</span>
                        <span style="padding: 0.25rem 0.75rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 6px; font-weight: 600;">${statusLabel}</span>
                      </div>
                    </div>
                  </div>
                  
                  ${jobStatus === 'OPEN' ? `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px;">
                      <span style="font-weight: 600; color: #059669;">👥 ${offerCount} ${offerCount === 1 ? 'applicant' : 'applicants'}</span>
                    </div>
                  ` : job.hustlerId ? `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; padding: 0.75rem; background: #dbeafe; border-radius: 8px;">
                      <span style="font-weight: 600; color: #1e40af;">✅ Hustler assigned</span>
                    </div>
                  ` : ''}
                  
                  <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-ghost viewJobBtn" data-job-id="${job.id}" style="padding: 0.5rem 1rem; font-size: 0.9rem;">View Details</button>
                    ${jobStatus === 'OPEN' ? `
                      <button class="btn btn-primary manageApplicantsBtn" data-job-id="${job.id}" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Manage Applicants (${offerCount})</button>
                      <button class="btn btn-ghost deleteJobBtn" data-job-id="${job.id}" style="padding: 0.5rem 1rem; font-size: 0.9rem; color: #dc2626; border-color: #fecaca;">Delete Job</button>
                    ` : ''}
                  </div>
                `;
                
                // Add event listeners
                jobCard.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
                  e.stopPropagation();
                  setView('jobs');
                  setTimeout(() => {
                    if (typeof openJobDetails === 'function') {
                      openJobDetails(job.id);
                    } else if (typeof renderJobDetail === 'function') {
                      renderJobDetail(job.id);
                    }
                  }, 100);
                });
                
                jobCard.querySelector('.manageApplicantsBtn')?.addEventListener('click', (e) => {
                  e.stopPropagation();
                  showApplicantsModal(job.id);
                });
                
                jobCard.querySelector('.deleteJobBtn')?.addEventListener('click', (e) => {
                  e.stopPropagation();
                  deleteJob(job.id, job.title);
                });
                
                postedJobsList.appendChild(jobCard);
              }
            }
            
            // Render Active Jobs (as Hustler)
            if (activeJobs.length === 0) {
              activeJobsList.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">💼</div>
                  <div>No active jobs as a Hustler.</div>
                </div>
              `;
            } else {
              activeJobsList.innerHTML = "";
              activeJobs.forEach(job => {
                const card = document.createElement("div");
                card.className = "job-card";
                card.dataset.jobId = job.id;
                card.innerHTML = `
                  <div class="job-card-top">
                    <div class="job-title">${job.title || 'Untitled'}</div>
                    <span class="badge">${(job.status || 'open').toLowerCase()}</span>
                  </div>
                  <div class="job-meta">${timeAgo(new Date(job.createdAt).getTime())}</div>
                `;
                card.addEventListener("click", () => {
                  setView("jobs");
                  setTimeout(() => {
                    if (typeof openJobDetails === 'function') {
                      openJobDetails(job.id);
                    } else if (typeof renderJobDetail === 'function') {
                      renderJobDetail(job.id);
                    }
                  }, 100);
                });
                activeJobsList.appendChild(card);
              });
            }
          } catch (error) {
            console.error("Error loading jobs:", error);
            if (postedJobsList) postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading jobs.</div>";
            if (activeJobsList) activeJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading jobs.</div>";
          }
        }
      });
    }
  }, 200);
  
  // Initialize Change Password button
  setTimeout(() => {
    const changePasswordBtn = document.getElementById("changePasswordBtn");
    if (changePasswordBtn) {
      changePasswordBtn.addEventListener("click", () => {
        showChangePasswordModal();
      });
    }
    
    // Profile sign out button
    const profileSignOutBtn = document.getElementById("profileSignOutBtn");
    if (profileSignOutBtn) {
      profileSignOutBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Profile sign out button clicked');
        // Call handleSignOut directly
        if (window.handleSignOut) {
          window.handleSignOut();
        } else {
          console.error('handleSignOut not available');
        }
      });
    }
  }, 100);

  // Stripe Connect Content (clear first to prevent duplicates)
  if (stripeContent) {
    stripeContent.innerHTML = ''; // Clear any existing content first
    const isConnected = user.stripeAccountId && user.stripePayoutsEnabled;
    if (isConnected) {
      stripeContent.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #dcfce7; border-radius: 8px;">
          <span style="font-size: 1.5rem;">✅</span>
          <div>
            <div style="font-weight: 600; color: #166534;">Stripe Connected</div>
            <div style="font-size: 0.85rem; color: #15803d;">You can receive payments instantly!</div>
          </div>
        </div>
      `;
    } else {
      stripeContent.innerHTML = `
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
          Connect with Stripe to receive payments directly to your bank. Instant payouts available!
        </p>
        <button class="btn btn-primary" id="stripeConnectBtnInCard" style="width: 100%; background: #22c55e; border: none;">
          💳 Connect Stripe & Start Earning
        </button>
      `;
      
      // Add click handler for Stripe button in Payment Setup card
      setTimeout(() => {
        const stripeBtn = document.getElementById("stripeConnectBtnInCard");
        if (stripeBtn) {
          stripeBtn.addEventListener("click", async () => {
            stripeBtn.disabled = true;
            stripeBtn.textContent = "Connecting...";
            
            try {
              const token = localStorage.getItem("hustl_token");
              if (!token) {
                showToast("Please log in to connect Stripe.");
                stripeBtn.disabled = false;
                stripeBtn.textContent = "💳 Connect Stripe & Start Earning";
                return;
              }
              
              // First create account if needed
              await fetch("/stripe-connect/create-account", {
                method: "POST",
                headers: { 
                  "Authorization": "Bearer " + token,
                  "Content-Type": "application/json"
                }
              });
              
              // Then get onboarding link
              const res = await fetch("/stripe-connect/onboarding-link", {
                headers: { "Authorization": "Bearer " + token }
              });
              const data = await res.json();
              
              if (data.url) {
                // Open Stripe checkout in popup
                const popup = window.open(
                  data.url,
                  'StripeCheckout',
                  'width=800,height=600,scrollbars=yes,resizable=yes'
                );
                if (!popup || popup.closed || typeof popup.closed === 'undefined') {
                  // Popup blocked - fallback to redirect
                  window.location.href = data.url;
                }
              } else {
                showToast("Could not get Stripe link. Try again.");
                stripeBtn.disabled = false;
                stripeBtn.textContent = "💳 Connect Stripe & Start Earning";
              }
            } catch (e) {
              console.error("Stripe connect error:", e);
              showToast("Error connecting to Stripe. Please try again.");
              stripeBtn.disabled = false;
              stripeBtn.textContent = "💳 Connect Stripe & Start Earning";
            }
          });
        }
      }, 100);
    }
  }

  // Old duplicate profile form removed - using Basic Info section at top with Edit Profile button
  // All profile editing is handled through renderBasicInfoEdit function

  // ----- RIGHT SIDE: JOBS -----
  // jobsList might not exist if we're on Settings tab, that's OK
  if (jobsList) {
    jobsList.innerHTML = "";

  // A) Jobs you posted
  const postedHeader = document.createElement("div");
  postedHeader.className = "section-title";
  postedHeader.textContent = "Jobs you posted";
  jobsList.appendChild(postedHeader);

  const myPostedJobs = state.jobs.filter((j) => j.postedByUserId === user.id);
  if (myPostedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven’t posted any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myPostedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You posted this · " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // B) Jobs you're doing as a Hustler
  const doingHeader = document.createElement("div");
  doingHeader.className = "section-title";
  doingHeader.style.marginTop = "0.8rem";
  doingHeader.textContent = "Jobs you’re doing as a Hustler";
  jobsList.appendChild(doingHeader);

  const myHustlerJobs = state.jobs.filter(
    (j) => j.acceptedHustlerId === user.id
  );

  if (myHustlerJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven’t been accepted on any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myHustlerJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You’re the Hustler · " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // C) Jobs you've applied for
  const appliedHeader = document.createElement("div");
  appliedHeader.className = "section-title";
  appliedHeader.style.marginTop = "0.8rem";
  appliedHeader.textContent = "Jobs you’ve applied for";
  jobsList.appendChild(appliedHeader);

  const myAppliedJobs = state.jobs.filter((j) =>
    (j.applicants || []).some((a) => a.userId === user.id)
  );

  if (myAppliedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven’t applied for any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myAppliedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent =
        "You applied · " +
        timeAgo(job.createdAt) +
        (job.acceptedHustlerId === user.id
          ? " · (accepted)"
          : job.status === "assigned"
          ? " · (assigned to someone else)"
          : "");
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }
  }

  // Image compression function
  function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          // Calculate new dimensions
          if (width > height) {
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // Convert to base64 with compression
          const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(compressedDataUrl);
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Old duplicate form handlers removed - all profile editing is handled through Basic Info edit mode
  // (basicInfoPhotoUpload, basicInfoBio, basicInfoGender, basicInfoSaveBtn, etc.)
  
  // Tools save/edit handler
  setTimeout(() => {
    const saveToolsBtn = document.getElementById("saveToolsButton");
    const toolsInput = document.getElementById("profileToolsInput");
    if (saveToolsBtn && toolsInput) {
      saveToolsBtn.addEventListener("click", async () => {
        // If button says "Edit Tools", make field editable
        if (saveToolsBtn.textContent === "Edit Tools") {
          toolsInput.removeAttribute('readonly');
          toolsInput.style.background = 'white';
          toolsInput.style.cursor = 'text';
          saveToolsBtn.textContent = "Save Tools";
          toolsInput.focus();
          return;
        }
        
        // Otherwise, save the tools
        const tools = toolsInput.value.trim();
        saveToolsBtn.disabled = true;
        saveToolsBtn.textContent = "Saving...";
        try {
          await window.hustlAPI.users.updateProfile({ tools });
          const storedUser = JSON.parse(localStorage.getItem('hustl_user') || '{}');
          storedUser.tools = tools;
          localStorage.setItem('hustl_user', JSON.stringify(storedUser));
          
          // Make field read-only and change button to "Edit Tools"
          toolsInput.setAttribute('readonly', 'readonly');
          toolsInput.style.background = 'var(--bg-light)';
          toolsInput.style.cursor = 'default';
          saveToolsBtn.textContent = "Saved";
          saveToolsBtn.style.background = "#16a34a";
          setTimeout(() => {
            saveToolsBtn.textContent = "Edit Tools";
            saveToolsBtn.style.background = "";
            saveToolsBtn.disabled = false;
          }, 2000);
          showToast("✅ Tools updated!");
        } catch (error) {
          saveToolsBtn.textContent = "Save Tools";
          saveToolsBtn.disabled = false;
          showToast("Failed to save tools.");
        }
      });
    }
  }, 100);
// Manual payout options removed - Stripe only

  // hook up "View active jobs"
  const activeLink = document.getElementById("activeJobsLink");
  if (activeLink) {
    activeLink.addEventListener("click", () => {
      setView("jobs");
      activeJobsStatusFilter = "open";
      renderJobs(true); // Reset pagination when filter changes
    });
  }
}

    /* ---------- Feedback ---------- */

    function initFeedback() {
      const btn = document.getElementById("feedbackButton");
      btn.addEventListener("click", () => {
        const name = document.getElementById("feedbackName").value.trim();
        const email = document.getElementById("feedbackEmail").value.trim();
        const message = document
          .getElementById("feedbackMessage")
          .value.trim();
        if (!message) {
          showToast("Please type a bit of feedback first.");
          return;
        }
        state.feedback.push({
          id: generateId("f"),
          name,
          email,
          message,
          createdAt: Date.now(),
        });
        saveState();
        document.getElementById("feedbackMessage").value = "";
        showToast("Feedback saved (demo). In a live app this would email Hustl.");
      });
    }

   /* ---------- Footer links ---------- */

function initFooterLinks() {
  document
    .getElementById("footerTermsLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });

  document
    .getElementById("footerPrivacyLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });
}

   /* ---------- Public profile popup ---------- */
async function openUserProfile(userId) {
  // Try to find user in state first
  let user = state.users.find((u) => u.id === userId);
  
  // If not found, try to fetch from API
  if (!user) {
    try {
      const token = localStorage.getItem("hustl_token");
      const response = await fetch(`${API_BASE}/users/${userId}`, {
        headers: token ? { "Authorization": `Bearer ${token}` } : {}
      });
      if (response.ok) {
        user = await response.json();
        // Add to state for future use
        if (user && !state.users.find(u => u.id === userId)) {
          state.users.push(user);
        }
      } else {
        showToast("User not found.");
        return;
      }
    } catch (error) {
      console.error("Error fetching user:", error);
      showToast("Error loading user profile.");
      return;
    }
  }
  
  if (!user) {
    showToast("User not found.");
    return;
  }

  // remove any existing popup
  const existing = document.getElementById("profilePopupOverlay");
  if (existing) existing.remove();

  const overlay = document.createElement("div");
  overlay.id = "profilePopupOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(15,23,42,0.55)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "80";

  const card = document.createElement("div");
  card.className = "card";
  card.style.maxWidth = "500px";
  card.style.width = "100%";
  card.style.maxHeight = "90vh";
  card.style.overflowY = "auto";
  card.style.position = "relative";
  card.style.background = "white";
  card.style.borderRadius = "16px";
  card.style.boxShadow = "0 20px 25px -5px rgba(0, 0, 0, 0.3)";
  
  // Prevent click from closing when clicking inside card
  card.addEventListener("click", (e) => {
    e.stopPropagation();
  });

  // Header
  const header = document.createElement("div");
  header.className = "card-header";
  const title = document.createElement("div");
  title.className = "card-title";
  title.textContent = user.name || "Profile";
  const closeBtn = document.createElement("button");
  closeBtn.innerHTML = "×";
  closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: #f3f4f6; border: none; font-size: 1.75rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; z-index: 10;";
  closeBtn.addEventListener("click", () => {
    overlay.remove();
    document.body.style.overflow = "";
  });
  header.appendChild(title);
  header.appendChild(closeBtn);
  card.appendChild(header);

  // Avatar + basic info (role only, no money / jobs / email)
  const row = document.createElement("div");
  row.className = "profile-row";

  const avatar = document.createElement("div");
  avatar.className = "profile-avatar";
  if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.src = user.avatarDataUrl;
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  row.appendChild(avatar);

  const info = document.createElement("div");
  info.innerHTML =
    "<span class='muted'>" +
    (user.role === "hustler" ? "Hustler" : "Customer") +
    "</span>";
  row.appendChild(info);

  card.appendChild(row);

  // Bio / description
  const bioWrap = document.createElement("div");
  bioWrap.className = "field";
  bioWrap.style.marginTop = "0.6rem";

  const bioLabel = document.createElement("div");
  bioLabel.className = "stat-label";
  bioLabel.textContent = "About this person";
  bioWrap.appendChild(bioLabel);

  const bioText = document.createElement("div");
  bioText.className = "about-text";
  bioText.style.cssText = "color: var(--text-main); line-height: 1.6; white-space: pre-wrap;";
  bioText.textContent = user.bio || "This person hasn't added anything about themselves yet.";
  bioWrap.appendChild(bioText);
  
  // Tools/Equipment if hustler
  if (user.tools && user.tools.trim()) {
    const toolsWrap = document.createElement("div");
    toolsWrap.className = "field";
    toolsWrap.style.marginTop = "0.6rem";
    
    const toolsLabel = document.createElement("div");
    toolsLabel.className = "stat-label";
    toolsLabel.textContent = "🔧 Tools & Equipment";
    toolsWrap.appendChild(toolsLabel);
    
    const toolsText = document.createElement("div");
    toolsText.className = "about-text";
    toolsText.style.cssText = "color: var(--text-main); line-height: 1.6; white-space: pre-wrap;";
    toolsText.textContent = user.tools;
    toolsWrap.appendChild(toolsText);
    
    card.appendChild(toolsWrap);
  }
  
  // Completed jobs count
  const jobsCount = document.createElement("div");
  jobsCount.className = "field";
  jobsCount.style.marginTop = "0.6rem";
  
  const jobsLabel = document.createElement("div");
  jobsLabel.className = "stat-label";
  jobsLabel.textContent = "📋 Completed Jobs";
  jobsCount.appendChild(jobsLabel);
  
  const jobsText = document.createElement("div");
  jobsText.className = "about-text";
  jobsText.textContent = user.completedJobsCount || "0";
  jobsCount.appendChild(jobsText);
  
  card.appendChild(jobsCount);

  card.appendChild(bioWrap);

  // Reviews (demo only – will show once we start filling user.reviews)
  const reviewsWrap = document.createElement("div");
  reviewsWrap.className = "field";
  reviewsWrap.style.marginTop = "0.6rem";

  const reviewLabel = document.createElement("div");
  reviewLabel.className = "stat-label";
  reviewLabel.textContent = "Reviews";
  reviewsWrap.appendChild(reviewLabel);

  const reviews = user.reviews || [];
  if (reviews.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "No reviews yet.";
    reviewsWrap.appendChild(empty);
  } else {
    reviews.forEach((r) => {
      const rCard = document.createElement("div");
      rCard.className = "stat-card";
      rCard.style.marginTop = "0.35rem";

      const top = document.createElement("div");
      top.className = "stat-value";
      top.style.fontSize = "0.8rem";
      top.textContent = (r.rating ? "★".repeat(r.rating) + " · " : "") + (r.fromName || "Someone on Hustl");
      rCard.appendChild(top);

      const body = document.createElement("div");
      body.className = "muted";
      body.style.marginTop = "0.2rem";
      body.textContent = r.text || "";
      rCard.appendChild(body);

      reviewsWrap.appendChild(rCard);
    });
  }

  card.appendChild(reviewsWrap);

  overlay.appendChild(card);
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.remove();
  });

  document.body.appendChild(overlay);
}


    /* ---------- Owner view ---------- */

    function renderOwnerView() {
      const user = getCurrentUser();
      const tab = document.getElementById("ownerTab");
      const view = document.getElementById("view-owner");
      const paidList = document.getElementById("ownerPaidList");
      const assignedList = document.getElementById("ownerAssignedList");

      const isOwner = !!(user && user.email && user.email.toLowerCase() === "team.hustlapp@outlook.com");
      if (tab) tab.style.display = isOwner ? "" : "none";
      if (!isOwner) {
        if (view) view.style.display = "none";
        return;
      }

      // Paid jobs
      const paidJobs = state.jobs.filter(j => j.paymentStatus === "paid");
      if (paidList) {
        paidList.innerHTML = "";
        if (paidJobs.length === 0) {
          paidList.innerHTML = "<div class='muted'>No paid jobs yet.</div>";
        } else {
          paidJobs.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
           const custUser = state.users.find(u => u.id === j.postedByUserId);
const hustUser = state.users.find(u => u.id === j.acceptedHustlerId);
const cust = custUser?.name || "Customer";
const hust = hustUser?.name || "Hustler";

let payoutInfo = "";
if (hustUser && hustUser.payoutMethod && hustUser.payoutHandle) {
  const label =
    hustUser.payoutMethod === "venmo" ? "Venmo" :
    hustUser.payoutMethod === "cashapp" ? "Cash App" :
    hustUser.payoutMethod === "zelle" ? "Zelle" : "Payout";
  payoutInfo = ` · ${label}: ${hustUser.payoutHandle}`;
}

meta.textContent =
  `Paid ${formatMoney(j.chargedAmount || 0)} · Your fee ${formatMoney(j.platformFeeAmount || 0)} · ${cust} → ${hust}${payoutInfo}`;
            row.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "job-card-actions";

            const left = document.createElement("div");
            const payoutBadge = document.createElement("span");
            payoutBadge.className = "badge";
            if (j.adminPayoutDone) {
              payoutBadge.classList.add("status-completed");
              payoutBadge.textContent = "Payout marked done";
            } else {
              payoutBadge.classList.add("status-assigned");
              payoutBadge.textContent = "Payout pending";
            }
            left.appendChild(payoutBadge);

            const right = document.createElement("div");
            const markBtn = document.createElement("button");
            markBtn.className = "small-btn";
            markBtn.textContent = j.adminPayoutDone ? "Unmark payout" : "Mark payout done";
            markBtn.addEventListener("click", () => {
              j.adminPayoutDone = !j.adminPayoutDone;
              saveState();
              showToast(j.adminPayoutDone ? "Marked payout done." : "Payout unmarked.");
              renderOwnerView();
            });
            right.appendChild(markBtn);

            actions.appendChild(left);
            actions.appendChild(right);
            row.appendChild(actions);

            paidList.appendChild(row);
          });
        }
      }

      // Assigned but not paid
      const assigned = state.jobs.filter(j => j.status === "assigned" && j.paymentStatus !== "paid");
      if (assignedList) {
        assignedList.innerHTML = "";
        if (assigned.length === 0) {
          assignedList.innerHTML = "<div class='muted'>No assigned-but-unpaid jobs.</div>";
        } else {
          assigned.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
            const cust = state.users.find(u => u.id === j.postedByUserId)?.name || "Customer";
            const hust = state.users.find(u => u.id === j.acceptedHustlerId)?.name || "Hustler";
            meta.textContent = `Assigned · ${cust} ↔ ${hust} · posted ${timeAgo(j.createdAt)}`;
            row.appendChild(meta);

            assignedList.appendChild(row);
          });
        }
      }
    }

    /* ---------- Main render ---------- */

    async function renderAll() {
      console.log("🔵 renderAll called");
      // Update header auth state first
      await updateHeaderAuth();
      
      renderAuthPill();
      renderAuthSectionVisibility();
      renderOwnerView();

      // CRITICAL: Use window.activeView if it's set (from fallback), otherwise use local activeView
      // This ensures fallback code can properly set the view
      const currentView = window.activeView || activeView || "home";
      // Also update local activeView to keep them in sync
      if (window.activeView && window.activeView !== activeView) {
        activeView = window.activeView;
      }
      console.log("🔵 renderAll - activeView:", activeView, "window.activeView:", window.activeView, "currentView:", currentView);
      
      if (currentView === "jobs") {
        console.log("🔵 Rendering jobs view");
        renderJobs();
      } else if (currentView === "messages") {
        console.log("🔵 Rendering messages view");
        try {
          await renderMessagesView();
          // Start polling when messages view is rendered
          startMessagePolling();
        } catch (err) {
          console.error("Error rendering messages:", err);
        }
      } else if (currentView === "profile") {
        console.log("🔵 Rendering profile view");
        renderProfile();
        stopMessagePolling(); // Stop polling when leaving messages view
      } else if (currentView === "manage-jobs") {
        console.log("🔵 Rendering manage-jobs view - calling renderManageJobs");
        renderManageJobs();
        stopMessagePolling(); // Stop polling when leaving messages view
      } else if (currentView === "owner") {
        console.log("🔵 Rendering owner view");
        renderOwnerView();
        stopMessagePolling(); // Stop polling when leaving messages view
      } else if (currentView === "home") {
        console.log("🔵 Rendering home view (no special rendering needed)");
        // Home view doesn't need special rendering - it's the default
        stopMessagePolling(); // Stop polling when leaving messages view
      } else {
        console.log("⚠️ renderAll - unknown view:", currentView);
        stopMessagePolling(); // Stop polling when leaving messages view
      }
      
      // Unread message count - function not implemented yet
      // countUnreadMessages();
    }
    
    // Expose renderAll and renderProfile on window for fallback access
    window.renderAll = renderAll;
    window.renderProfile = renderProfile;
    
    // Render Manage Jobs View - Professional job management interface
    async function renderManageJobs() {
      console.log("🔵 renderManageJobs called");
      
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user) {
        console.warn("No user found in renderManageJobs");
        showToast("Please log in to manage jobs.");
        setView('home');
        return;
      }
      
      console.log("✅ User authenticated:", user.id);
      
      // Show/hide tabs based on user role
      const hasHustlerRole = (user.roles && Array.isArray(user.roles) && user.roles.some(r => r.toUpperCase() === 'HUSTLER')) || 
                             (user.role && user.role.toUpperCase() === 'HUSTLER') ||
                             (user.isHustler === true);
      const appliedTab = document.getElementById('appliedJobsTab');
      if (appliedTab) {
        appliedTab.style.display = hasHustlerRole ? '' : 'none';
        console.log("🔵 Applied tab visibility:", hasHustlerRole ? 'visible' : 'hidden', 'user roles:', user.roles, 'user.role:', user.role, 'user.isHustler:', user.isHustler);
      }
      
      // Initialize tabs - use setTimeout to ensure DOM is ready
      setTimeout(() => {
        const manageTabs = document.querySelectorAll('[data-manage-tab]');
        console.log("Found manage tabs:", manageTabs.length);
        
        if (manageTabs.length === 0) {
          console.warn("Manage tabs not found, retrying...");
          setTimeout(() => renderManageJobs(), 100);
          return;
        }
        
        manageTabs.forEach(tab => {
          // Remove old listener if exists
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
          
          // Get fresh reference
          const freshTab = document.querySelector(`[data-manage-tab="${newTab.dataset.manageTab}"]`);
          if (!freshTab) return;
          
          freshTab.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Remove active from all tabs
            document.querySelectorAll('[data-manage-tab]').forEach(t => {
              t.classList.remove('active');
              const indicator = t.querySelector('.tab-indicator');
              if (indicator) indicator.style.display = 'none';
            });
            
            // Add active to clicked tab
            freshTab.classList.add('active');
            const indicator = freshTab.querySelector('.tab-indicator');
            if (indicator) indicator.style.display = 'block';
            
            // Hide all tab content
            document.querySelectorAll('#manageTabPosted, #manageTabActive, #manageTabCompleted, #manageTabApplied').forEach(content => {
              content.style.display = 'none';
              content.classList.remove('active');
            });
            
            // Show selected tab content
            const tabName = freshTab.dataset.manageTab;
            let tabContentId = '';
            if (tabName === 'posted') {
              tabContentId = 'manageTabPosted';
            } else if (tabName === 'active') {
              tabContentId = 'manageTabActive';
            } else if (tabName === 'completed') {
              tabContentId = 'manageTabCompleted';
            } else if (tabName === 'applied') {
              tabContentId = 'manageTabApplied';
            }
            
            const tabContent = document.getElementById(tabContentId);
            if (tabContent) {
              tabContent.style.display = 'block';
              tabContent.classList.add('active');
              
              // Load content for that tab
              if (tabName === 'posted') {
                loadPostedJobs();
              } else if (tabName === 'active') {
                loadActiveJobs();
              } else if (tabName === 'completed') {
                loadCompletedJobs();
              } else if (tabName === 'applied') {
                loadAppliedJobs();
              }
            }
          });
        });
      }, 100);
      
      // Load initial tab (Posted Jobs)
      setTimeout(() => {
        console.log("🔵 Loading initial tab (Posted Jobs)");
        const postedTab = document.getElementById('manageTabPosted');
        const postedList = document.getElementById('managePostedJobsList');
        console.log("Posted tab element:", postedTab ? "found" : "NOT FOUND");
        console.log("Posted list element:", postedList ? "found" : "NOT FOUND");
        
        if (postedList) {
          loadPostedJobs();
        } else {
          console.error("❌ managePostedJobsList element not found in DOM");
          // Retry after a bit more time
          setTimeout(() => {
            const retryList = document.getElementById('managePostedJobsList');
            if (retryList) {
              console.log("✅ Found on retry, loading...");
              loadPostedJobs();
            } else {
              console.error("❌ Still not found after retry");
            }
          }, 500);
        }
      }, 200);
    }
    
    // Load Posted Jobs - Professional Dashboard Cards
    async function loadPostedJobs() {
      console.log("🔵 loadPostedJobs called");
      
      const postedJobsList = document.getElementById("managePostedJobsList");
      
      // Prevent duplicate calls
      if (postedJobsList && postedJobsList.dataset.loading === 'true') {
        console.log("⏸️ loadPostedJobs already in progress, skipping");
        return;
      }
      
      if (postedJobsList) {
        postedJobsList.dataset.loading = 'true';
      }
      if (!postedJobsList) {
        console.error("❌ managePostedJobsList element not found in DOM");
        // Try to find it again
        setTimeout(() => {
          const retry = document.getElementById("managePostedJobsList");
          if (retry) {
            console.log("✅ Found on retry, calling loadPostedJobs again");
            loadPostedJobs();
          } else {
            console.error("❌ Still not found after retry - DOM may not be ready");
          }
        }, 100);
        return;
      }
      
      console.log("✅ managePostedJobsList element found");
      
      // Show loading state
      postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading...</div>";
      postedJobsList.dataset.loaded = 'false';
      
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          console.warn("No user found");
          postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your jobs.</div>";
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          console.warn("No token found");
          postedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your jobs.</div>";
          return;
        }
        
        console.log("🔵 Loading posted jobs for user:", user.id);
        console.log("🔵 API_BASE:", API_BASE);
        console.log("🔵 Endpoint:", `${API_BASE}/jobs/user-posted`);
        
        // Use the dedicated endpoint for posted jobs
        const response = await fetch(`${API_BASE}/jobs/user-posted`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        console.log("🔵 Response status:", response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("❌ Failed to fetch jobs:", response.status, errorText);
          throw new Error(`Failed to fetch jobs: ${response.status} - ${errorText}`);
        }
        
        const jobs = await response.json();
        console.log("🔵 Raw response:", jobs);
        
        // Ensure jobs is an array
        if (!Array.isArray(jobs)) {
          console.error("❌ Jobs is not an array:", typeof jobs, jobs);
          throw new Error("Invalid response format from server");
        }
        
        console.log("✅ Fetched posted jobs:", jobs.length, "jobs");
        if (jobs.length > 0) {
          console.log("✅ Sample job:", {
            id: jobs[0].id,
            title: jobs[0].title,
            customerId: jobs[0].customerId,
            status: jobs[0].status,
            category: jobs[0].category
          });
        }
        
        // The API endpoint already filters for customer's posted jobs, but add client-side filter for completed jobs (safety check)
        const postedJobs = jobs.filter(job => 
          job.status !== 'PAID' && 
          !(job.status === 'COMPLETED_BY_HUSTLER' && job.completionCodeVerified)
        );
        
        if (postedJobs.length === 0) {
          postedJobsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No posted jobs yet</div>
              <div style="color: var(--text-muted); margin-bottom: 1.5rem;">Post your first job to get started!</div>
              <button class="btn btn-primary" onclick="setView('post')" style="padding: 0.75rem 1.5rem;">Post Your First Job</button>
            </div>
          `;
          postedJobsList.dataset.loaded = 'true';
        } else {
          postedJobsList.innerHTML = "";
          for (const job of postedJobs) {
            // Fetch offer count
            let offerCount = 0;
            let pendingOffers = [];
            try {
              const offersResponse = await fetch(`${API_BASE}/offers/${job.id}`, {
                headers: token ? { 'Authorization': `Bearer ${token}` } : {}
              });
              if (offersResponse.ok) {
                const offers = await offersResponse.json();
                pendingOffers = offers.filter(o => o.status === 'PENDING');
                offerCount = pendingOffers.length;
              }
            } catch (e) {
              console.error("Error fetching offers:", e);
            }
            
            // Get requirements for additional fields
            const requirements = job.requirements || {};
            const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
            const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
            const keepActiveFor = requirements.keepActiveFor;
            const expiresAt = requirements.expiresAt ? new Date(requirements.expiresAt) : null;
            const pricingOption = requirements.pricing_option;
            
            // Format location (pickup/dropoff)
            const pickupArea = requirements.pickup_area || requirements.pickupArea;
            const pickupCity = requirements.pickup_city || requirements.pickupCity;
            const pickupZip = requirements.pickup_zip;
            const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
            const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
            const dropoffZip = requirements.dropoff_zip;
            const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
            
            let locationDisplay = job.address || 'Location not specified';
            if (pickupArea || pickupCity) {
              const pickupParts = [];
              if (pickupArea) pickupParts.push(pickupArea);
              if (pickupCity) pickupParts.push(pickupCity);
              if (pickupZip) pickupParts.push(pickupZip);
              locationDisplay = pickupParts.join(', ');
              
              if (!onSiteOnly && (dropoffArea || dropoffCity)) {
                const dropoffParts = [];
                if (dropoffArea) dropoffParts.push(dropoffArea);
                if (dropoffCity) dropoffParts.push(dropoffCity);
                if (dropoffZip) dropoffParts.push(dropoffZip);
                locationDisplay += ` → ${dropoffParts.join(', ')}`;
              } else if (onSiteOnly) {
                locationDisplay += ' (Single location)';
              }
            }
            const shortLocation = locationDisplay.length > 50 ? locationDisplay.substring(0, 50) + '...' : locationDisplay;
            
            // Format timing
            let timingDisplay = '';
            if (deadlinePreference === 'until_completed') {
              timingDisplay = 'Until completed';
            } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
              timingDisplay = 'Flexible this week';
            } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
              timingDisplay = 'Today – ASAP';
            } else if (deadlinePreference === 'tomorrow') {
              timingDisplay = 'Tomorrow';
            } else if (job.startTime) {
              const deadlineDate = new Date(job.startTime);
              timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
              timingDisplay = 'Not specified';
            }
            
            // Format pay
            const payType = job.payType || 'flat';
            let payDisplay = '';
            if (pricingOption === 'hustlers_quote') {
              payDisplay = 'Hustler suggests price';
            } else if (payType === 'hourly') {
              const hourlyRate = parseFloat(job.hourlyRate || 0);
              if (teamSize > 1) {
                const perPersonRate = hourlyRate / teamSize;
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs) · ${teamSize} workers → $${perPersonRate.toFixed(0)}/hr each`;
              } else {
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs)`;
              }
            } else {
              payDisplay = `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
            }
            
            // Format workers
            let workersDisplay = '';
            if (teamSize === 0) {
              workersDisplay = 'Company/crew';
            } else if (teamSize === 1) {
              workersDisplay = '1 worker';
            } else {
              workersDisplay = `${teamSize} workers`;
            }
            
            // Format expiration
            let expirationDisplay = '';
            if (expiresAt && expiresAt > new Date()) {
              const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
              expirationDisplay = `Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}`;
            } else if (expiresAt && expiresAt <= new Date()) {
              expirationDisplay = 'Expired — Repost?';
            }
            
            // Posted date
            const postedDate = new Date(job.createdAt);
            const daysAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60 * 24));
            const postedText = daysAgo === 0 ? 'Posted today' : daysAgo === 1 ? 'Posted 1 day ago' : `Posted ${daysAgo} days ago`;
            
            const jobCard = document.createElement("div");
            jobCard.style.cssText = "padding: 0; border: 2px solid var(--border); border-radius: 16px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s; overflow: hidden;";
            jobCard.onmouseenter = () => { 
              jobCard.style.boxShadow = '0 8px 24px rgba(0,0,0,0.12)';
              jobCard.style.transform = 'translateY(-2px)';
              jobCard.style.borderColor = 'var(--primary)';
            };
            jobCard.onmouseleave = () => { 
              jobCard.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
              jobCard.style.transform = 'translateY(0)';
              jobCard.style.borderColor = 'var(--border)';
            };
            
            // Get category icon - handle both display names and API values
            const categoryMap = {
              'Moving / Hauling': '🚚',
              'moving': '🚚',
              'Yard work / Outdoor': '🌿',
              'yard-work': '🌿',
              'yard': '🌿',
              'Cleaning / Organizing': '🧹',
              'cleaning': '🧹',
              'Furniture / Assembly': '🛠',
              'furniture-assembly': '🛠',
              'furniture': '🛠',
              'Other': '⭐',
              'other': '⭐'
            };
            const categoryIcon = categoryMap[job.category] || '📋';
            
            // Normalize category name for display
            const categoryDisplayNames = {
              'moving': 'Moving / Hauling',
              'yard-work': 'Yard work / Outdoor',
              'yard': 'Yard work / Outdoor',
              'cleaning': 'Cleaning / Organizing',
              'furniture-assembly': 'Furniture / Assembly',
              'furniture': 'Furniture / Assembly',
              'other': 'Other'
            };
            const categoryDisplay = categoryDisplayNames[job.category] || job.category || 'General';
            
            // Status badge with better styling
            let statusBadge = '';
            let statusColor = '#6b7280';
            if (job.status === 'OPEN') {
              statusBadge = 'Open for Applications';
              statusColor = '#10b981';
            } else if (job.status === 'SCHEDULED' || job.status === 'ASSIGNED' || job.status === 'REQUESTED') {
              statusBadge = job.status === 'SCHEDULED' ? 'Scheduled' : 'Hustler Assigned';
              statusColor = job.status === 'SCHEDULED' ? '#f59e0b' : '#3b82f6';
            } else if (job.status === 'COMPLETED_BY_HUSTLER') {
              statusBadge = 'Awaiting Completion';
              statusColor = '#f59e0b';
            }
            
            // Calculate hours/minutes since posted for better time display
            const hoursAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60));
            const minutesAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60));
            let timeAgo = '';
            if (minutesAgo < 60) {
              timeAgo = minutesAgo < 1 ? 'Just now' : `${minutesAgo} ${minutesAgo === 1 ? 'minute' : 'minutes'} ago`;
            } else if (hoursAgo < 24) {
              timeAgo = `${hoursAgo} ${hoursAgo === 1 ? 'hour' : 'hours'} ago`;
            } else {
              timeAgo = postedText;
            }
            
            jobCard.innerHTML = `
              <!-- Header Section with Status -->
              <div style="padding: 1.5rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 2px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      <span style="font-size: 2rem;">${categoryIcon}</span>
                      <div style="flex: 1;">
                        <h3 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main); line-height: 1.2;">${job.title || 'Untitled Job'}</h3>
                        <div style="margin-top: 0.25rem; font-size: 0.9rem; color: var(--text-muted);">${categoryDisplay}</div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem;">
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-weight: 700; color: var(--text-main);">💰</span>
                        <span style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">${payDisplay}</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>⏰</span>
                        <span style="color: var(--text-muted);">${timingDisplay}</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>👥</span>
                        <span style="color: var(--text-muted);">${workersDisplay}</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>📍</span>
                        <span style="color: var(--text-muted);">${shortLocation}</span>
                      </div>
                      ${expirationDisplay ? `
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>⏳</span>
                        <span style="color: ${expiresAt && expiresAt <= new Date() ? '#dc2626' : '#d97706'}; font-weight: 600;">${expirationDisplay}</span>
                      </div>
                      ` : ''}
                      <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>📅</span>
                        <span style="color: var(--text-muted);">${timeAgo}</span>
                      </div>
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="text-align: right;">
                      <div style="padding: 0.5rem 1rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 2px solid ${statusColor}40; margin-bottom: 0.5rem;">
                        ${statusBadge}
                      </div>
                      ${(() => {
                        const requirements = job.requirements || {};
                        if (requirements.keepOpenUntilAccepted === true) {
                          return `<div style="padding: 0.35rem 0.75rem; background: #dbeafe; color: #1e40af; border-radius: 6px; font-weight: 600; font-size: 0.75rem; border: 1px solid #3b82f6; margin-top: 0.25rem;">
                            ✓ Auto-close when assigned
                          </div>`;
                        }
                        return '';
                      })()}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Metrics Section - Prominent Applicant Count -->
              <div style="padding: 1.5rem; background: white;">
                ${offerCount > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; border: 2px solid #10b98140;">
                  <div style="text-align: center;">
                    <div style="font-size: 3rem; font-weight: 700; color: #059669; line-height: 1;">${offerCount}</div>
                    <div style="font-size: 0.9rem; color: #047857; font-weight: 600; margin-top: 0.5rem;">${offerCount === 1 ? 'Applicant' : 'Applicants'}</div>
                    <div style="font-size: 0.75rem; color: #065f46; margin-top: 0.25rem;">Waiting for review</div>
                  </div>
                  <div style="display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                      <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">👥</div>
                      <div style="font-size: 0.85rem; color: #047857; font-weight: 600;">Review & Accept</div>
                      <div style="font-size: 0.75rem; color: #065f46; margin-top: 0.25rem;">Click below to view</div>
                    </div>
                  </div>
                </div>
                ` : `
                <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf2440; margin-bottom: 1.5rem; text-align: center;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">👤</div>
                  <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">No applicants yet</div>
                  <div style="font-size: 0.85rem; color: #78350f;">Share your job to get more applicants!</div>
                </div>
                `}
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 200px; padding: 1rem; font-size: 1rem; font-weight: 700; border-radius: 10px;">
                    ${offerCount > 0 ? '👥 View Applicants & Manage' : '🔍 View Job Details'}
                  </button>
                  ${job.status === 'OPEN' ? `
                  <button class="btn btn-ghost editJobBtn" data-job-id="${job.id}" style="padding: 1rem 1.5rem; font-weight: 600; border-radius: 10px;">✏️ Edit</button>
                  <button class="btn btn-ghost cancelJobBtn" data-job-id="${job.id}" style="padding: 1rem 1.5rem; font-weight: 600; border-radius: 10px; color: #dc2626; border-color: #fecaca;">🚫 Cancel</button>
                  ` : ''}
                </div>
              </div>
            `;
            
            // Add click handlers
            jobCard.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              showViewJobModal(job.id, 'customer');
            });
            
            jobCard.querySelector('.editJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              showToast("Edit job feature coming soon");
            });
            
            jobCard.querySelector('.cancelJobBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              const requirements = job.requirements || {};
              const keepOpenEnabled = requirements.keepOpenUntilAccepted === true;
              if (confirm(`Are you sure you want to cancel this job?${keepOpenEnabled ? ' (Note: Auto-close when assigned setting is active)' : ' It will no longer accept new applicants.'}`)) {
                await cancelJob(job.id, false);
                loadPostedJobs();
              }
            });
            
            // Make card clickable (but not buttons)
            jobCard.addEventListener('click', (e) => {
              if (!e.target.closest('button') && !e.target.closest('.btn')) {
                showViewJobModal(job.id, 'customer');
              }
            });
            
            postedJobsList.appendChild(jobCard);
            console.log("✅ Added job card for:", job.title || job.id);
          }
          
          console.log("✅ Total job cards rendered:", postedJobs.length);
          postedJobsList.dataset.loaded = 'true';
        }
      } catch (error) {
        console.error("Error loading posted jobs:", error);
        postedJobsList.innerHTML = `
          <div style='text-align: center; padding: 2rem; color: var(--text-muted);'>
            <div style="font-size: 1.1rem; font-weight: 600; color: #dc2626; margin-bottom: 0.5rem;">Error loading jobs</div>
            <div style="margin-bottom: 1rem;">${error.message || 'Please refresh and try again.'}</div>
            <button class="btn btn-primary" onclick="loadPostedJobs()" style="padding: 0.75rem 1.5rem;">Retry</button>
          </div>
        `;
        postedJobsList.dataset.loaded = 'true';
      } finally {
        // Always clear loading flag
        if (postedJobsList) {
          postedJobsList.dataset.loading = 'false';
        }
      }
    }
    
    // Load Active Jobs - Role-based (Customer vs Hustler)
    async function loadActiveJobs() {
      const activeJobsList = document.getElementById("manageActiveJobsList");
      if (!activeJobsList) return;
      
      activeJobsList.dataset.loaded = 'false'; // Always reload
      
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user || !token) {
          activeJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view active jobs.</div>";
          return;
        }
        
        // Use the dedicated endpoint for active jobs
        const response = await fetch(`${API_BASE}/jobs/active`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("Failed to fetch active jobs:", response.status, errorText);
          throw new Error(`Failed to fetch active jobs: ${response.status}`);
        }
        
        const jobs = await response.json();
        
        // Ensure jobs is an array
        if (!Array.isArray(jobs)) {
          console.error("Active jobs is not an array:", typeof jobs, jobs);
          throw new Error("Invalid response format from server");
        }
        
        console.log("✅ Fetched active jobs:", jobs.length, "jobs");
        
        // The API endpoint already filters for active jobs, but add client-side filter for completed jobs (safety check)
        const activeJobs = jobs.filter(job => 
          job.status !== 'PAID' && 
          !(job.status === 'COMPLETED_BY_HUSTLER' && job.completionCodeVerified)
        );
        
        if (activeJobs.length === 0) {
          activeJobsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">🟡</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No active jobs</div>
              <div style="color: var(--text-muted);">You're not working on any jobs right now.</div>
            </div>
          `;
        } else {
          activeJobsList.innerHTML = "";
          for (const job of activeJobs) {
            const isCustomer = job.customerId === user.id;
            const isHustler = job.hustlerId === user.id;
            
            // Get requirements for additional fields
            const requirements = job.requirements || {};
            const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
            const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
            const pricingOption = requirements.pricing_option;
            
            // Format location
            const pickupArea = requirements.pickup_area || requirements.pickupArea;
            const pickupCity = requirements.pickup_city || requirements.pickupCity;
            const pickupZip = requirements.pickup_zip;
            const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
            const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
            const dropoffZip = requirements.dropoff_zip;
            const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
            
            let locationDisplay = job.address || 'Location not specified';
            if (pickupArea || pickupCity) {
              const pickupParts = [];
              if (pickupArea) pickupParts.push(pickupArea);
              if (pickupCity) pickupParts.push(pickupCity);
              if (pickupZip) pickupParts.push(pickupZip);
              locationDisplay = pickupParts.join(', ');
              
              if (!onSiteOnly && (dropoffArea || dropoffCity)) {
                const dropoffParts = [];
                if (dropoffArea) dropoffParts.push(dropoffArea);
                if (dropoffCity) dropoffParts.push(dropoffCity);
                if (dropoffZip) dropoffParts.push(dropoffZip);
                locationDisplay += ` → ${dropoffParts.join(', ')}`;
              } else if (onSiteOnly) {
                locationDisplay += ' (Single location)';
              }
            }
            
            // Format timing
            let timingDisplay = '';
            if (deadlinePreference === 'until_completed') {
              timingDisplay = 'Until completed';
            } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
              timingDisplay = 'Flexible this week';
            } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
              timingDisplay = 'Today – ASAP';
            } else if (deadlinePreference === 'tomorrow') {
              timingDisplay = 'Tomorrow';
            } else if (job.startTime) {
              const deadlineDate = new Date(job.startTime);
              timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
              timingDisplay = 'Not specified';
            }
            
            // Format pay
            const payType = job.payType || 'flat';
            let payDisplay = '';
            if (pricingOption === 'hustlers_quote') {
              payDisplay = 'Hustler suggests price';
            } else if (payType === 'hourly') {
              const hourlyRate = parseFloat(job.hourlyRate || 0);
              if (teamSize > 1) {
                const perPersonRate = hourlyRate / teamSize;
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs) · ${teamSize} workers → $${perPersonRate.toFixed(0)}/hr each`;
              } else {
                payDisplay = `$${hourlyRate.toFixed(0)}/hr total (Max ${job.estHours || '?'} hrs)`;
              }
            } else {
              payDisplay = `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
            }
            
            // Format workers
            let workersDisplay = '';
            if (teamSize === 0) {
              workersDisplay = 'Company/crew';
            } else if (teamSize === 1) {
              workersDisplay = '1 worker';
            } else {
              workersDisplay = `${teamSize} workers`;
            }
            
            // Format scheduled time
            const jobDate = new Date(job.date);
            const dateStr = jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            const card = document.createElement("div");
            card.style.cssText = "padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;";
            card.onmouseenter = () => { card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
            card.onmouseleave = () => { card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)'; };
            
            // Category icon
            const categoryIcons = {
              'Moving / Hauling': '🚚',
              'Yard work / Outdoor': '🌿',
              'Cleaning / Organizing': '🧹',
              'Furniture / Assembly': '🛠',
              'Other': '⭐'
            };
            const categoryIcon = categoryIcons[job.category] || '📋';
            
            if (isCustomer) {
              // Customer View: Shows hired hustler
              const hustler = job.hustler || {};
              card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="font-size: 1.5rem;">${categoryIcon}</span>
                      <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      ${hustler.photoUrl ? `<img src="${hustler.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;" class="viewHustlerProfileBtn" data-user-id="${hustler.id}">` : `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); cursor: pointer;" class="viewHustlerProfileBtn" data-user-id="${hustler.id}">${(hustler.name || 'H')[0].toUpperCase()}</div>`}
                      <div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${job.status === 'IN_PROGRESS' ? '🔄 In Progress' : '✅ Assigned'}</div>
                        <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewHustlerProfileBtn" data-user-id="${hustler.id}">${hustler.name || 'Unknown'}</div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                      <span style="font-weight: 600; color: var(--text-main);">💰 ${payDisplay}</span>
                      <span>📅 ${dateStr} at ${timeStr}</span>
                      <span style="padding: 0.25rem 0.75rem; background: ${job.status === 'IN_PROGRESS' ? '#f59e0b20' : '#3b82f620'}; color: ${job.status === 'IN_PROGRESS' ? '#f59e0b' : '#3b82f6'}; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">${job.status === 'IN_PROGRESS' ? 'In Progress' : (job.status || 'Active')}</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                      <span>📍 ${job.address || 'Location not specified'}</span>
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary messageBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">💬 Message</button>
                  <button class="btn btn-ghost viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem;">🔍 View Job</button>
                  <button class="btn btn-ghost mapBtn" data-address="${job.address || ''}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">🗺️ Map</button>
                  ${job.status === 'ASSIGNED' && !job.startCodeVerified ? `<button class="btn btn-ghost unacceptBtn" data-job-id="${job.id}" style="padding: 0.75rem 1rem; color: #dc2626; border-color: #fecaca; font-size: 0.9rem;">Unaccept</button>` : ''}
                </div>
              `;
            } else if (isHustler) {
              // Hustler View: Shows customer who hired them
              const customer = job.customer || {};
              card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <span style="font-size: 1.5rem;">${categoryIcon}</span>
                      <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                      ${customer.photoUrl ? `<img src="${customer.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${customer.id}">` : `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${customer.id}">${(customer.name || 'C')[0].toUpperCase()}</div>`}
                      <div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${job.status === 'IN_PROGRESS' ? '🔄 In Progress' : '✅ Assigned'}</div>
                        <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${customer.id}">${customer.name || 'Unknown'}</div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                      <span style="font-weight: 600; color: var(--text-main);">💰 ${payDisplay}</span>
                      <span>⏰ ${timingDisplay}</span>
                      <span>👥 ${workersDisplay}</span>
                      <span>📅 ${dateStr} at ${timeStr}</span>
                      <span style="padding: 0.25rem 0.75rem; background: ${job.status === 'IN_PROGRESS' ? '#f59e0b20' : '#3b82f620'}; color: ${job.status === 'IN_PROGRESS' ? '#f59e0b' : '#3b82f6'}; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">${job.status === 'IN_PROGRESS' ? 'In Progress' : (job.status || 'Active')}</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                      <span>📍 ${locationDisplay}</span>
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary messageBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">💬 Message</button>
                  <button class="btn btn-ghost viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem;">🔍 View Job</button>
                  <button class="btn btn-ghost mapBtn" data-address="${locationDisplay || job.address || ''}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">🗺️ Map</button>
                  ${job.status === 'ASSIGNED' && !job.startCodeVerified ? `<button class="btn btn-primary markStartedBtn" data-job-id="${job.id}" style="padding: 0.75rem 1rem; font-weight: 600; background: #10b981; font-size: 0.9rem;">✅ Mark Started</button>` : ''}
                  ${job.status === 'ASSIGNED' && job.startCodeVerified ? `<button class="btn btn-primary markFinishedBtn" data-job-id="${job.id}" style="padding: 0.75rem 1rem; font-weight: 600; background: #10b981; font-size: 0.9rem;">✅ Mark Finished</button>` : ''}
                  ${job.status === 'ASSIGNED' && !job.startCodeVerified ? `<button class="btn btn-ghost cancelApplicationBtn" data-job-id="${job.id}" style="padding: 0.75rem 1rem; color: #dc2626; border-color: #fecaca; font-size: 0.9rem;">Cancel</button>` : ''}
                </div>
              `;
            }
            
            // Event listeners
            card.querySelector('.messageBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              // Set the active conversation to this job
              if (typeof window !== 'undefined' && window.activeConversationJobId !== undefined) {
                window.activeConversationJobId = job.id;
              }
              setView('messages');
            });
            
            card.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              showViewJobModal(job.id, isCustomer ? 'customer' : 'hustler');
            });
            
            card.querySelector('.mapBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const address = e.target.dataset.address || job.address;
              if (address) {
                window.open(`https://maps.google.com/?q=${encodeURIComponent(address)}`, '_blank');
              } else {
                showToast("Address not available");
              }
            });
            
            card.querySelector('.unacceptBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('Are you sure you want to unaccept this hustler? The job will be open for applicants again.')) {
                await unacceptHustler(job.id);
                loadActiveJobs();
                loadPostedJobs();
              }
            });
            
            card.querySelector('.markStartedBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              await verifyStartCode(job.id);
              loadActiveJobs();
            });
            
            card.querySelector('.markFinishedBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              await submitCompletionCode(job.id);
              loadActiveJobs();
            });
            
            card.querySelector('.cancelApplicationBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              if (confirm('Are you sure you want to cancel your application? This cannot be undone.')) {
                await cancelApplication(job.id);
                loadActiveJobs();
              }
            });
            
            // View profile buttons
            card.querySelectorAll('.viewHustlerProfileBtn, .viewCustomerProfileBtn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const userId = btn.dataset.userId;
                showApplicantProfileModal(userId);
              });
            });
            
            // Make entire card clickable
            card.addEventListener('click', (e) => {
              if (!e.target.closest('button') && !e.target.closest('img') && !e.target.closest('.viewHustlerProfileBtn') && !e.target.closest('.viewCustomerProfileBtn')) {
                showViewJobModal(job.id, isCustomer ? 'customer' : 'hustler');
              }
            });
            
            activeJobsList.appendChild(card);
          }
          activeJobsList.dataset.loaded = 'true';
        }
      } catch (error) {
        console.error("Error loading active jobs:", error);
        activeJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading jobs.</div>";
      }
    }
    
    // Load Applied Jobs (Hustler only)
    async function loadAppliedJobs() {
      console.log("🔵 loadAppliedJobs called");
      const appliedJobsList = document.getElementById("manageAppliedJobsList");
      if (!appliedJobsList) {
        console.error("❌ manageAppliedJobsList element not found");
        setTimeout(() => {
          const retry = document.getElementById("manageAppliedJobsList");
          if (retry) {
            console.log("✅ Found on retry, calling loadAppliedJobs again");
            loadAppliedJobs();
          } else {
            console.error("❌ Still not found after retry - DOM may not be ready");
          }
        }, 200);
        return;
      }
      
      if (appliedJobsList.dataset.loading === 'true') {
        console.log("⏸️ loadAppliedJobs already in progress, skipping");
        return;
      }
      appliedJobsList.dataset.loading = 'true';
      
      // Show loading state
      appliedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Loading...</div>";
      
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          appliedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your applications.</div>";
          appliedJobsList.dataset.loading = 'false';
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          appliedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view your applications.</div>";
          appliedJobsList.dataset.loading = 'false';
          return;
        }
        
        console.log("🔵 Loading applied jobs for user:", user.id);
        
        // Fetch offers (applications)
        const response = await fetch(`${API_BASE}/offers/user/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("❌ Failed to fetch applied jobs:", response.status, errorText);
          throw new Error(`Failed to fetch applications: ${response.status} - ${errorText}`);
        }
        
        const allOffers = await response.json();
        console.log("🔵 Fetched all offers:", allOffers.length);
        
        // Filter to show only PENDING and ACCEPTED offers (not DECLINED)
        // ACCEPTED offers should auto-move to "Active Jobs" when job status becomes IN_PROGRESS
        // So we only show ACCEPTED if job is SCHEDULED/ASSIGNED but not started yet
        const relevantOffers = allOffers.filter(offer => {
          // Always show PENDING offers (waiting for customer review)
          if (offer.status === 'PENDING') return true;
          // Show ACCEPTED offers only if job is SCHEDULED/ASSIGNED but start code not verified (can still cancel)
          // Once start code is verified, job moves to IN_PROGRESS and should appear in Active Jobs, not Applied Jobs
          if (offer.status === 'ACCEPTED' && offer.job && (offer.job.status === 'SCHEDULED' || offer.job.status === 'ASSIGNED') && !offer.job.startCodeVerified) return true;
          // Don't show DECLINED offers or jobs that have started (those are in Active Jobs)
          return false;
        });
        
        console.log("🔵 Filtered to relevant applied jobs:", relevantOffers.length);
        
        if (relevantOffers.length === 0) {
          appliedJobsList.innerHTML = `
            <div style='text-align: center; padding: 3rem; color: var(--text-muted);'>
              <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
              <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem;">No active applications</div>
              <div>Start browsing jobs and apply to get started!</div>
            </div>
          `;
          appliedJobsList.dataset.loading = 'false';
          return;
        }
        
        appliedJobsList.innerHTML = "";
        
        // Render each application as a job card
        for (const offer of relevantOffers) {
          const job = offer.job;
          if (!job) continue;
          
          // Determine status badge and color
          let statusBadge = '';
          let statusColor = '';
          if (offer.status === 'ACCEPTED') {
            statusBadge = '✅ Accepted';
            statusColor = '#10b981';
          } else if (offer.status === 'PENDING') {
            statusBadge = '⏳ Pending Review';
            statusColor = '#f59e0b';
          } else {
            statusBadge = '📋 ' + offer.status;
            statusColor = '#6b7280';
          }
          
          // Format pay display
          const requirements = job.requirements || {};
          const pricingOption = requirements.pricing_option;
          let payDisplay = '';
          if (pricingOption === 'hustlers_quote') {
            payDisplay = 'Hustler suggests price';
          } else if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
            const hr = Number(job.hourlyRate);
            const maxHrs = job.estHours;
            payDisplay = `$${hr.toFixed(0)}/hr total (max ${maxHrs} hrs)`;
          } else {
            payDisplay = `$${Number(job.amount || 0).toFixed(0)} flat`;
          }
          
          // Format original price
          let originalPriceDisplay = '';
          if (job.payType === 'hourly' && job.hourlyRate && job.estHours) {
            originalPriceDisplay = `$${Number(job.hourlyRate).toFixed(0)}/hr total (max ${job.estHours} hrs)`;
          } else {
            originalPriceDisplay = `$${Number(job.amount || 0).toFixed(0)} flat`;
          }
          
          // Format proposed price
          let proposedPriceDisplay = '';
          if (offer.proposedAmount) {
            if (job.payType === 'hourly') {
              proposedPriceDisplay = `$${Number(offer.proposedAmount).toFixed(0)}/hr`;
            } else {
              proposedPriceDisplay = `$${Number(offer.proposedAmount).toFixed(0)} flat`;
            }
          }
          
          // Format location
          const pickupCity = requirements.pickup_city || requirements.pickupCity;
          const pickupZip = requirements.pickup_zip;
          let locationDisplay = job.address || 'Location TBD';
          if (pickupCity) {
            locationDisplay = pickupCity;
            if (pickupZip) locationDisplay += ` ${pickupZip}`;
          }
          
          const jobCard = document.createElement('div');
          jobCard.className = 'job-card';
          jobCard.style.cssText = `
            background: white;
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          `;
          
          jobCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                  📍 ${locationDisplay}
                </div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">
                  💰 ${payDisplay}
                </div>
              </div>
              <div style="padding: 0.5rem 1rem; background: ${statusColor}20; color: ${statusColor}; border-radius: 8px; font-weight: 700; font-size: 0.85rem; border: 2px solid ${statusColor}40; white-space: nowrap; margin-left: 1rem;">
                ${statusBadge}
              </div>
            </div>
            
            <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600;">Status:</div>
              <div style="color: var(--text-main); font-weight: 600; margin-bottom: 0.75rem;">${offer.status === 'PENDING' ? 'Waiting for customer review' : offer.status === 'ACCEPTED' ? 'Customer accepted your offer' : offer.status}</div>
              
              ${proposedPriceDisplay ? `
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Your offer:</div>
              <div style="color: var(--primary); font-weight: 600; margin-bottom: 0.75rem;">${proposedPriceDisplay}</div>
              ` : ''}
              
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Their original price:</div>
              <div style="color: var(--text-main); margin-bottom: ${offer.note ? '0.75rem' : '0'};">${originalPriceDisplay}</div>
            </div>
            
            ${offer.note ? `
            <div style="padding: 1rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #10b981;">
              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600;">You wrote:</div>
              <div style="color: var(--text-main); line-height: 1.5;">"${offer.note}"</div>
            </div>
            ` : ''}
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; font-weight: 600; border-radius: 10px;">View Full Job →</button>
              ${offer.status === 'PENDING' ? `
              <button class="btn btn-ghost cancelApplicationBtn" data-offer-id="${offer.id}" style="padding: 0.75rem 1.5rem; font-weight: 600; border-radius: 10px; color: #dc2626; border-color: #fecaca;">Cancel Application</button>
              ` : offer.status === 'ACCEPTED' && (job.status === 'SCHEDULED' || job.status === 'ASSIGNED') && !job.startCodeVerified ? `
              <button class="btn btn-ghost cancelApplicationBtn" data-job-id="${job.id}" style="padding: 0.75rem 1.5rem; font-weight: 600; border-radius: 10px; color: #dc2626; border-color: #fecaca;">🚫 Cancel - Can't Do Job</button>
              ` : ''}
            </div>
          `;
          
          // Add click handlers
          jobCard.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            showViewJobModal(job.id, 'hustler');
          });
          
          jobCard.querySelector('.cancelApplicationBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const offerId = e.target.dataset.offerId;
            const jobId = e.target.dataset.jobId;
            const isAccepted = offer.status === 'ACCEPTED';
            const confirmMessage = isAccepted 
              ? 'Are you sure you want to cancel this job? You cannot do it anymore. The customer will be notified and the job will be reopened for other applicants. This action cannot be undone.'
              : 'Are you sure you want to cancel this application?';
            
            if (confirm(confirmMessage)) {
              try {
                const token = localStorage.getItem('hustl_token');
                if (!token) {
                  showToast('Please log in to cancel applications');
                  return;
                }
                
                if (offerId) {
                  // Cancel pending application
                  if (offer.status === 'PENDING') {
                    const response = await fetch(`${API_BASE}/offers/${offerId}/cancel`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.error || 'Failed to cancel application');
                    }
                    
                    showToast('✅ Application cancelled');
                  } else if (offer.status === 'ACCEPTED') {
                    // Cancel accepted offer (use hustler-cancel endpoint)
                    const response = await fetch(`${API_BASE}/offers/${offerId}/hustler-cancel`, {
                      method: 'POST',
                      headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                      }
                    });
                    
                    if (!response.ok) {
                      const error = await response.json();
                      throw new Error(error.error || 'Failed to cancel job');
                    }
                    
                    showToast('✅ Job cancelled. The job is now open for other applicants.');
                  }
                } else if (jobId) {
                  // Cancel via job ID (for accepted offers)
                  const response = await fetch(`${API_BASE}/offers/${offer.id}/hustler-cancel`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to cancel job');
                  }
                  
                  showToast('✅ Job cancelled. The job is now open for other applicants.');
                }
                
                // Reload applied jobs
                loadAppliedJobs();
              } catch (error) {
                console.error('Error cancelling application:', error);
                showToast(error.message || 'Failed to cancel application');
              }
            }
          });
          
          // Make card clickable
          jobCard.addEventListener('click', (e) => {
            if (!e.target.closest('button') && !e.target.closest('.btn')) {
              showViewJobModal(job.id, 'hustler');
            }
          });
          
          appliedJobsList.appendChild(jobCard);
        }
        
        appliedJobsList.dataset.loading = 'false';
        console.log("✅ Rendered applied jobs:", relevantOffers.length);
      } catch (error) {
        console.error("Error loading applied jobs:", error);
        appliedJobsList.innerHTML = `
          <div style='text-align: center; padding: 2rem; color: var(--text-muted);'>
            <div style="margin-bottom: 1rem;">❌ Error loading applications</div>
            <button class="btn btn-primary" onclick="loadAppliedJobs()" style="padding: 0.75rem 1.5rem;">Retry</button>
          </div>
        `;
      }
    }
    
    // Load Completed Jobs
    async function loadCompletedJobs() {
      const completedJobsList = document.getElementById("manageCompletedJobsList");
      if (!completedJobsList) return;
      
      completedJobsList.dataset.loaded = 'false'; // Always reload
      
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user || !token) {
          completedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Please log in to view completed jobs.</div>";
          return;
        }
        
        // Use the dedicated endpoint for completed jobs
        const response = await fetch(`${API_BASE}/jobs/completed`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error("Failed to fetch completed jobs:", response.status, errorText);
          throw new Error(`Failed to fetch completed jobs: ${response.status}`);
        }
        
        const jobs = await response.json();
        
        // Ensure jobs is an array
        if (!Array.isArray(jobs)) {
          console.error("Completed jobs is not an array:", typeof jobs, jobs);
          throw new Error("Invalid response format from server");
        }
        
        console.log("✅ Fetched completed jobs:", jobs.length, "jobs");
        
        // Filter out deleted jobs (client-side only, for personal organization)
        const deleted = JSON.parse(localStorage.getItem('deletedCompletedJobs') || '[]');
        const completedJobs = jobs.filter(job => !deleted.includes(job.id));
        
        if (completedJobs.length === 0) {
          completedJobsList.innerHTML = `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No completed jobs</div>
              <div style="color: var(--text-muted);">Completed jobs will appear here.</div>
            </div>
          `;
        } else {
          completedJobsList.innerHTML = "";
          completedJobs.forEach(job => {
            const isCustomer = job.customerId === user.id;
            const role = isCustomer ? 'Customer' : 'Hustler';
            const otherUser = isCustomer ? job.hustler : job.customer;
            
            // Get requirements for additional fields
            const requirements = job.requirements || {};
            const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
            const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
            const pricingOption = requirements.pricing_option;
            
            // Format location
            const pickupArea = requirements.pickup_area || requirements.pickupArea;
            const pickupCity = requirements.pickup_city || requirements.pickupCity;
            const pickupZip = requirements.pickup_zip;
            const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
            const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
            const dropoffZip = requirements.dropoff_zip;
            const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
            
            let locationDisplay = job.address || 'Location not specified';
            if (pickupArea || pickupCity) {
              const pickupParts = [];
              if (pickupArea) pickupParts.push(pickupArea);
              if (pickupCity) pickupParts.push(pickupCity);
              if (pickupZip) pickupParts.push(pickupZip);
              locationDisplay = pickupParts.join(', ');
              
              if (!onSiteOnly && (dropoffArea || dropoffCity)) {
                const dropoffParts = [];
                if (dropoffArea) dropoffParts.push(dropoffArea);
                if (dropoffCity) dropoffParts.push(dropoffCity);
                if (dropoffZip) dropoffParts.push(dropoffZip);
                locationDisplay += ` → ${dropoffParts.join(', ')}`;
              } else if (onSiteOnly) {
                locationDisplay += ' (Single location)';
              }
            }
            
            // Format timing
            let timingDisplay = '';
            if (deadlinePreference === 'until_completed') {
              timingDisplay = 'Until completed';
            } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
              timingDisplay = 'Flexible this week';
            } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
              timingDisplay = 'Today – ASAP';
            } else if (deadlinePreference === 'tomorrow') {
              timingDisplay = 'Tomorrow';
            } else if (job.startTime) {
              const deadlineDate = new Date(job.startTime);
              timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else {
              timingDisplay = 'Not specified';
            }
            
            // Format pay (final pay)
            const payType = job.payType || 'flat';
            const finalPay = job.payment?.amount || job.amount || 0;
            let payDisplay = '';
            if (pricingOption === 'hustlers_quote') {
              payDisplay = 'Hustler suggested price';
            } else if (payType === 'hourly') {
              payDisplay = `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr${job.estHours ? ` (max ${job.estHours} hrs)` : ''}`;
            } else {
              payDisplay = `$${parseFloat(finalPay).toFixed(2)} flat`;
            }
            
            // Format workers
            let workersDisplay = '';
            if (teamSize === 0) {
              workersDisplay = 'Company/crew';
            } else if (teamSize === 1) {
              workersDisplay = '1 worker';
            } else {
              workersDisplay = `${teamSize} workers`;
            }
            
            // Category icon
            const categoryIcons = {
              'Moving / Hauling': '🚚',
              'Yard work / Outdoor': '🌿',
              'Cleaning / Organizing': '🧹',
              'Furniture / Assembly': '🛠',
              'Other': '⭐'
            };
            const categoryIcon = categoryIcons[job.category] || '📋';
            
            // Check if user has already rated
            const hasRated = job.reviews && job.reviews.some(r => r.reviewerId === user.id);
            
            // Posted date
            const postedDate = new Date(job.createdAt);
            const daysAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60 * 24));
            const postedText = daysAgo === 0 ? 'Completed today' : daysAgo === 1 ? 'Completed 1 day ago' : `Completed ${daysAgo} days ago`;
            
            const card = document.createElement("div");
            card.style.cssText = "padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s;";
            card.onmouseenter = () => { card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)'; };
            card.onmouseleave = () => { card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)'; };
            
            card.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">${categoryIcon}</span>
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; color: var(--text-main);">${job.title || 'Untitled Job'}</h3>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: var(--text-main);">💰 Final Pay: ${payDisplay}</span>
                    <span>⏰ ${timingDisplay}</span>
                    <span>👥 ${workersDisplay}</span>
                    <span>📅 ${postedText}</span>
                  </div>
                  ${otherUser ? `
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px;">
                    ${otherUser.photoUrl ? `<img src="${otherUser.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;" class="viewOtherUserProfile" data-user-id="${otherUser.id}">` : `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); cursor: pointer;" class="viewOtherUserProfile" data-user-id="${otherUser.id}">${(otherUser.name || 'U')[0].toUpperCase()}</div>`}
                    <div style="flex: 1;">
                      <div style="font-size: 0.85rem; color: var(--text-muted);">${isCustomer ? 'Worked with' : 'Worked for'}</div>
                      <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewOtherUserProfile" data-user-id="${otherUser.id}">${otherUser.name || 'Unknown'}</div>
                      ${otherUser.ratingAvg ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">⭐ ${otherUser.ratingAvg.toFixed(1)} (${otherUser.ratingCount || 0} reviews)</div>` : ''}
                    </div>
                  </div>
                  ` : ''}
                  <div style="font-size: 0.85rem; color: var(--text-muted);">
                    <span>📍 ${locationDisplay}</span>
                  </div>
                </div>
                <span style="padding: 0.25rem 0.75rem; background: #10b98120; color: #10b981; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">✅ Completed</span>
              </div>
              
              <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                <button class="btn btn-primary viewJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">🔍 View Job</button>
                ${!hasRated && otherUser ? `<button class="btn btn-primary rateWorkerBtn" data-job-id="${job.id}" data-user-id="${otherUser.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600; background: #f59e0b;">⭐ Rate Worker</button>` : ''}
                ${otherUser ? `<button class="btn btn-ghost viewReviewsBtn" data-user-id="${otherUser.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">📝 View Reviews</button>` : ''}
                ${otherUser ? `<button class="btn btn-ghost rehireBtn" data-user-id="${otherUser.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">🔄 Re-hire</button>` : ''}
                ${otherUser ? `<button class="btn btn-ghost favoriteBtn" data-user-id="${otherUser.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">⭐ Favorite</button>` : ''}
                <button class="btn btn-ghost deleteCompletedJobBtn" data-job-id="${job.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem; color: #dc2626; border-color: #fecaca;">🗑️ Delete</button>
              </div>
            `;
            
            // Event listeners
            card.querySelector('.viewJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              showViewJobModal(job.id, isCustomer ? 'customer' : 'hustler');
            });
            
            card.querySelector('.rateWorkerBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const userId = e.target.dataset.userId;
              const jobId = e.target.dataset.jobId;
              showRateWorkerModal(userId, jobId);
            });
            
            card.querySelector('.viewReviewsBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const userId = e.target.dataset.userId;
              showApplicantProfileModal(userId);
            });
            
            card.querySelector('.rehireBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const userId = e.target.dataset.userId;
              // Navigate to post job view with pre-filled worker
              setView('post');
              showToast("You can post a new job and this worker will be notified!");
            });
            
            card.querySelector('.favoriteBtn')?.addEventListener('click', async (e) => {
              e.stopPropagation();
              const userId = e.target.dataset.userId;
              await favoriteWorker(userId);
            });
            
            card.querySelectorAll('.viewOtherUserProfile').forEach(btn => {
              btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const userId = btn.dataset.userId;
                showApplicantProfileModal(userId);
              });
            });
            
            // Delete completed job (client-side only, for personal organization)
            card.querySelector('.deleteCompletedJobBtn')?.addEventListener('click', (e) => {
              e.stopPropagation();
              const jobId = e.target.dataset.jobId;
              if (confirm('Delete this completed job from your list? This will only hide it from your dashboard. The job, payment history, and messages will remain in the system.')) {
                const deleted = JSON.parse(localStorage.getItem('deletedCompletedJobs') || '[]');
                if (!deleted.includes(jobId)) {
                  deleted.push(jobId);
                  localStorage.setItem('deletedCompletedJobs', JSON.stringify(deleted));
                  showToast('✅ Job removed from your completed jobs list');
                  loadCompletedJobs(); // Refresh list
                }
              }
            });
            
            completedJobsList.appendChild(card);
          });
          completedJobsList.dataset.loaded = 'true';
        }
      } catch (error) {
        console.error("Error loading completed jobs:", error);
        completedJobsList.innerHTML = "<div style='text-align: center; padding: 2rem; color: var(--text-muted);'>Error loading jobs.</div>";
      }
    }
    
    window.renderManageJobs = renderManageJobs;
    
    // Job Management Modal - Shows full job details + applicants
    async function showJobManagementModal(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        // Fetch full job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        // Fetch applicants
        const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const offers = offersResponse.ok ? await offersResponse.json() : [];
        const pendingOffers = offers.filter(o => o.status === 'PENDING');
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Format pay
        const payType = job.payType || 'flat';
        const payDisplay = payType === 'hourly' 
          ? `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr (est. ${job.estHours || 0} hrs)` 
          : `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
        
        // Format date/time
        const jobDate = new Date(job.date);
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        modalOverlay.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
          ">
            <!-- Close Button -->
            <button class="closeModalBtn" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: #f3f4f6;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.25rem;
              z-index: 1;
              transition: all 0.2s;
            ">×</button>
            
            <!-- Modal Content -->
            <div style="padding: 2rem;">
              <!-- Job Info Section -->
              <div style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Category</div>
                    <div style="font-weight: 600; color: var(--text-main);">${job.category || 'General'}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Pay</div>
                    <div style="font-weight: 600; color: var(--text-main);">${payDisplay}</div>
                  </div>
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Status</div>
                    <div style="font-weight: 600; color: #10b981;">Open</div>
                  </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Description</div>
                  <div style="color: var(--text-main); line-height: 1.6; white-space: pre-wrap;">${job.description || 'No description provided.'}</div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">📍 Address</div>
                  <a href="https://maps.google.com/?q=${encodeURIComponent(job.address)}" target="_blank" style="
                    color: var(--primary);
                    text-decoration: none;
                    font-weight: 500;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                  ">
                    ${job.address || 'Address not specified'}
                    <span>🔗</span>
                  </a>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">📅 Scheduled</div>
                  <div style="color: var(--text-main); font-weight: 500;">${dateStr} at ${timeStr}</div>
                </div>
                
                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                  ${job.customer?.photoUrl ? `<img src="${job.customer.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary);">' + (job.customer?.name?.[0] || 'U') + '</div>'}
                  <div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">Posted by</div>
                    <div style="font-weight: 600; color: var(--text-main); cursor: pointer;" class="viewCustomerProfile" data-user-id="${job.customerId}">${job.customer?.name || 'Unknown'}</div>
                  </div>
                </div>
              </div>
              
              <!-- Applicants Section -->
              <div style="border-top: 2px solid var(--border); padding-top: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">
                  👥 Applicants (${pendingOffers.length})
                </h3>
                
                <div id="applicantsList" style="display: flex; flex-direction: column; gap: 1rem;">
                  ${pendingOffers.length === 0 ? `
                    <div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                      <div style="font-size: 2rem; margin-bottom: 0.5rem;">👤</div>
                      <div>No applicants yet. Share your job to get more applicants!</div>
                    </div>
                  ` : pendingOffers.map(offer => {
                    const hustler = offer.hustler || {};
                    const rating = hustler.ratingAvg || 0;
                    const ratingCount = hustler.ratingCount || 0;
                    const proposedPrice = offer.proposedAmount ? `$${parseFloat(offer.proposedAmount).toFixed(2)}` : null;
                    const appliedDate = new Date(offer.createdAt);
                    
                    return `
                      <div data-offer-id="${offer.id}" style="
                        padding: 1.5rem;
                        border: 1px solid var(--border);
                        border-radius: 12px;
                        background: white;
                      ">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                          ${hustler.photoUrl ? `<img src="${hustler.photoUrl}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">` : `<div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.5rem; flex-shrink: 0;">${(hustler.name || 'U')[0].toUpperCase()}</div>`}
                          <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                              <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem; cursor: pointer;" class="viewHustlerProfile" data-user-id="${hustler.id}">${hustler.name || 'Unknown'}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                              <span style="font-size: 1rem;">${'⭐'.repeat(Math.floor(rating))}${rating % 1 >= 0.5 ? '⭐' : ''}</span>
                              <span style="color: var(--text-muted); font-size: 0.85rem;">${rating.toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                            </div>
                            ${hustler.bio ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem; line-height: 1.5;">${hustler.bio}</div>` : ''}
                            ${offer.note ? `<div style="padding: 0.75rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.5rem;">
                              <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Why I'm a good fit:</div>
                              <div style="color: var(--text-main); line-height: 1.5;">${offer.note}</div>
                            </div>` : ''}
                            ${proposedPrice ? `<div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                              💵 Suggested price: <span style="font-weight: 600; color: var(--primary);">${proposedPrice}</span>
                            </div>` : ''}
                            <div style="font-size: 0.8rem; color: var(--text-muted);">Applied ${appliedDate.toLocaleDateString()}</div>
                          </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                          <button class="btn btn-primary acceptOfferBtn" data-offer-id="${offer.id}" style="flex: 1; min-width: 120px; padding: 0.75rem; font-weight: 600;">✅ Accept</button>
                          <button class="btn btn-ghost declineOfferBtn" data-offer-id="${offer.id}" style="flex: 1; min-width: 120px; padding: 0.75rem; color: #dc2626; border-color: #fecaca;">❌ Reject</button>
                          <button class="btn btn-ghost viewProfileBtn" data-user-id="${hustler.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">View Profile</button>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modalOverlay);
        
        // Close button
        modalOverlay.querySelector('.closeModalBtn').addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        // Click outside to close
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
        
        // Accept/Decline buttons
        modalOverlay.querySelectorAll('.acceptOfferBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const offerId = btn.dataset.offerId;
            await acceptOffer(offerId, modalOverlay);
          });
        });
        
        modalOverlay.querySelectorAll('.declineOfferBtn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const offerId = btn.dataset.offerId;
            await declineOffer(offerId, jobId, modalOverlay);
          });
        });
        
        // View profile buttons
        modalOverlay.querySelectorAll('.viewHustlerProfile, .viewCustomerProfile, .viewProfileBtn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const userId = btn.dataset.userId;
            // Open profile popup (reuse existing function if available)
            if (typeof showUserProfile === 'function') {
              showUserProfile(userId);
            } else {
              setView('profile');
              // Could navigate to user profile if we have that view
            }
          });
        });
        
      } catch (error) {
        console.error("Error showing job management modal:", error);
        showToast("Error loading job details. Please try again.");
      }
    }
    
    window.showJobManagementModal = showJobManagementModal;
    
    // Active Job Modal - Role-based (Customer vs Hustler)
    async function showActiveJobModal(jobId, role) {
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        
        // Fetch full job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Format pay
        const payType = job.payType || 'flat';
        const payDisplay = payType === 'hourly' 
          ? `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr (est. ${job.estHours || 0} hrs)` 
          : `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
        
        // Format date/time
        const jobDate = new Date(job.date);
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        if (role === 'customer') {
          // Customer View Modal
          const hustler = job.hustler || {};
          const rating = hustler.ratingAvg || 0;
          const ratingCount = hustler.ratingCount || 0;
          
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 800px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeModalBtn" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
              ">×</button>
              
              <div style="padding: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1.5rem 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                
                <!-- Accepted Hustler Section -->
                <div style="padding: 1.5rem; background: #f0fdf4; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #10b981;">
                  <div style="font-size: 0.85rem; color: #059669; margin-bottom: 0.75rem; font-weight: 600;">✅ HUSTLER ACCEPTED</div>
                  <div style="display: flex; gap: 1rem; align-items: center;">
                    ${hustler.photoUrl ? `<img src="${hustler.photoUrl}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">` : `<div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.5rem;">${(hustler.name || 'H')[0].toUpperCase()}</div>`}
                    <div style="flex: 1;">
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem;">${hustler.name || 'Unknown'}</div>
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span>${'⭐'.repeat(Math.floor(rating))}</span>
                        <span style="color: var(--text-muted); font-size: 0.9rem;">${rating.toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                      </div>
                      ${hustler.bio ? `<div style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.5;">${hustler.bio}</div>` : ''}
                    </div>
                    <button class="btn btn-primary messageHustlerBtn" data-job-id="${job.id}" style="padding: 0.75rem 1.5rem; font-weight: 600;">💬 Message</button>
                  </div>
                </div>
                
                <!-- Job Details -->
                <div style="margin-bottom: 2rem;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Job Details</h3>
                  <div style="display: grid; gap: 1rem;">
                    <div><strong>Category:</strong> ${job.category || 'General'}</div>
                    <div><strong>Pay:</strong> ${payDisplay}</div>
                    <div><strong>Scheduled:</strong> ${dateStr} at ${timeStr}</div>
                    <div><strong>Status:</strong> <span style="color: #3b82f6; font-weight: 600;">In Progress</span></div>
                    <div><strong>Description:</strong><br><div style="margin-top: 0.5rem; line-height: 1.6; white-space: pre-wrap;">${job.description || 'No description provided.'}</div></div>
                    <div><strong>📍 Address:</strong><br><a href="https://maps.google.com/?q=${encodeURIComponent(job.address)}" target="_blank" style="color: var(--primary); text-decoration: none; margin-top: 0.5rem; display: inline-block;">${job.address || 'Address not specified'} 🔗</a></div>
                  </div>
                </div>
                
                <!-- Verification Codes Section -->
                ${job.startCode ? `
                  <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 0.75rem;">🔐 Start Code</div>
                    <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #92400e; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;">${job.startCode}</div>
                    <div style="font-size: 0.85rem; color: #92400e;">${job.startCodeVerified ? '✅ Verified by hustler' : '⏳ Waiting for hustler to verify'}</div>
                  </div>
                ` : ''}
                
                ${job.completionCode && job.status === 'COMPLETED_BY_HUSTLER' ? `
                  <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 0.75rem;">✅ Completion Code (from Hustler)</div>
                    <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;">The hustler should have provided you with a completion code. Enter it below to release payment.</div>
                    ${!job.completionCodeVerified ? `
                      <input type="text" id="completionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 0.75rem; border: 2px solid #3b82f6; border-radius: 8px; font-size: 1.25rem; text-align: center; letter-spacing: 0.3em; font-family: 'Courier New', monospace;">
                      <button class="btn btn-primary verifyCompletionBtn" data-job-id="${job.id}" style="width: 100%; margin-top: 0.75rem; padding: 0.75rem; font-weight: 600;">Verify & Release Payment</button>
                    ` : `
                      <div style="padding: 1rem; background: #dcfce7; border-radius: 8px;">
                        <div style="font-weight: 600; color: #166534;">✅ Completion verified - Payment released</div>
                      </div>
                    `}
                  </div>
                ` : job.status === 'COMPLETED_BY_HUSTLER' && !job.completionCode ? `
                  <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: #92400e;">⏳ Waiting for completion code from hustler</div>
                  </div>
                ` : ''}
                
                <!-- Payment Status -->
                ${job.payment ? `
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Payment Status</div>
                    <div style="color: var(--text-muted);">${job.payment.status || 'Pending'}</div>
                  </div>
                ` : ''}
                
                <!-- Actions -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary messageHustlerBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.75rem; font-weight: 600;">💬 Message Hustler</button>
                  ${job.status === 'ASSIGNED' && !job.startCodeVerified ? `<button class="btn btn-ghost cancelJobBtn" data-job-id="${job.id}" style="padding: 0.75rem 1rem; color: #dc2626; border-color: #fecaca;">Cancel Job</button>` : ''}
                </div>
              </div>
            </div>
          `;
        } else {
          // Hustler View Modal
          const customer = job.customer || {};
          
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 800px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeModalBtn" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
              ">×</button>
              
              <div style="padding: 2rem;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1.5rem 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                
                <!-- Customer Info -->
                <div style="padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 2rem;">
                  <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 600;">CUSTOMER</div>
                  <div style="display: flex; gap: 1rem; align-items: center;">
                    ${customer.photoUrl ? `<img src="${customer.photoUrl}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">` : `<div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.5rem;">${(customer.name || 'C')[0].toUpperCase()}</div>`}
                    <div style="flex: 1;">
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem;">${customer.name || 'Unknown'}</div>
                    </div>
                    <button class="btn btn-primary messageCustomerBtn" data-job-id="${job.id}" style="padding: 0.75rem 1.5rem; font-weight: 600;">💬 Message</button>
                  </div>
                </div>
                
                <!-- Job Details -->
                <div style="margin-bottom: 2rem;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Job Details</h3>
                  <div style="display: grid; gap: 1rem;">
                    <div><strong>Category:</strong> ${job.category || 'General'}</div>
                    <div><strong>Pay:</strong> ${payDisplay}</div>
                    <div><strong>Scheduled:</strong> ${dateStr} at ${timeStr}</div>
                    <div><strong>Status:</strong> <span style="color: #3b82f6; font-weight: 600;">In Progress</span></div>
                    <div><strong>Description:</strong><br><div style="margin-top: 0.5rem; line-height: 1.6; white-space: pre-wrap;">${job.description || 'No description provided.'}</div></div>
                    <div><strong>📍 Address:</strong><br><a href="https://maps.google.com/?q=${encodeURIComponent(job.address)}" target="_blank" style="color: var(--primary); text-decoration: none; margin-top: 0.5rem; display: inline-block;">${job.address || 'Address not specified'} 🔗</a></div>
                  </div>
                </div>
                
                <!-- Start Code Entry -->
                ${job.startCode && !job.startCodeVerified ? `
                  <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #fbbf24;">
                    <div style="font-weight: 700; color: #92400e; margin-bottom: 0.75rem;">🔐 Enter Start Code</div>
                    <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 1rem;">Ask the customer for the start code to begin the job.</div>
                    <input type="text" id="startCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 0.75rem; border: 2px solid #fbbf24; border-radius: 8px; font-size: 1.25rem; text-align: center; letter-spacing: 0.3em; font-family: 'Courier New', monospace;">
                    <button class="btn btn-primary verifyStartCodeBtn" data-job-id="${job.id}" style="width: 100%; margin-top: 0.75rem; padding: 0.75rem; font-weight: 600; background: #f59e0b;">Verify Start Code</button>
                  </div>
                ` : job.startCodeVerified ? `
                  <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: #166534;">✅ Start code verified - Job in progress</div>
                  </div>
                ` : ''}
                
                <!-- Mark Complete Section -->
                ${job.startCodeVerified && job.status !== 'COMPLETED_BY_HUSTLER' && job.status !== 'PAID' ? `
                  <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 1.5rem; border: 2px solid #3b82f6;">
                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 0.75rem;">✅ Mark Job Complete</div>
                    <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;">When you finish the job, click below to mark it complete. A verification code will be sent to the customer.</div>
                    <button class="btn btn-primary submitEndCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-weight: 600;">Mark Complete</button>
                  </div>
                ` : job.status === 'COMPLETED_BY_HUSTLER' ? `
                  <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="font-weight: 600; color: #166534;">✅ Job marked as complete - Waiting for customer confirmation</div>
                  </div>
                ` : ''}
                
                <!-- Payment Overview -->
                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1.5rem;">
                  <div style="font-weight: 600; margin-bottom: 0.5rem;">Payment Overview</div>
                  <div style="color: var(--text-muted);">You'll receive ${payDisplay} upon completion.</div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                  <button class="btn btn-primary messageCustomerBtn" data-job-id="${job.id}" style="flex: 1; padding: 0.75rem; font-weight: 600;">💬 Message Customer</button>
                </div>
              </div>
            </div>
          `;
        }
        
        document.body.appendChild(modalOverlay);
        
        // Close button
        modalOverlay.querySelector('.closeModalBtn').addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        // Click outside to close
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
        
        // Event listeners based on role
        if (role === 'customer') {
          modalOverlay.querySelectorAll('.messageHustlerBtn').forEach(btn => {
            btn.addEventListener('click', async () => {
              const jobId = btn.dataset.jobId || job.id;
              
              // Set active conversation job ID
              activeConversationJobId = jobId;
              
              document.body.removeChild(modalOverlay);
              
              // Switch to messages view
              if (window.setView && typeof window.setView === 'function') {
                const funcStr = window.setView.toString();
                const isStub = funcStr.includes('not ready yet');
                if (!isStub) {
                  await window.setView('messages');
                } else {
                  // Use fallback
                  activeView = 'messages';
                  window.activeView = 'messages';
                  document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
                  const target = document.getElementById("view-messages");
                  if (target) target.style.display = "block";
                  document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === 'messages'));
                  await renderAll();
                }
              }
              
              // Wait for view to switch, then render and open conversation
              setTimeout(async () => {
                await renderMessagesView();
                // Find and click the conversation for this job
                const conversationItems = document.querySelectorAll('[data-job-id]');
                conversationItems.forEach(item => {
                  if (item.dataset.jobId === jobId) {
                    item.click();
                  }
                });
              }, 300);
            });
          });
          
          modalOverlay.querySelector('.verifyCompletionBtn')?.addEventListener('click', async () => {
            const code = document.getElementById('completionCodeInput')?.value.trim();
            if (!code || code.length !== 6) {
              showToast("Please enter a valid 6-digit completion code.");
              return;
            }
            
            try {
              const token = localStorage.getItem('hustl_token');
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code })
              });
              
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to verify completion code');
              }
              
              const data = await response.json();
              
              // Close the job modal
              document.body.removeChild(modalOverlay);
              
              // Show congratulations modal, then force review
              showJobCompletionFlow(data.jobId, data.customerId, data.hustlerId);
              
              // Refresh jobs
              loadActiveJobs(); // Refresh list
              loadCompletedJobs(); // Refresh completed list
            } catch (error) {
              console.error("Error verifying completion:", error);
              showToast(error.message || "Invalid completion code. Please check and try again.");
            }
          });
          
          modalOverlay.querySelector('.cancelJobBtn')?.addEventListener('click', async () => {
            if (confirm('Are you sure you want to cancel this job?')) {
              await cancelJob(job.id);
              document.body.removeChild(modalOverlay);
            }
          });
        } else {
          modalOverlay.querySelectorAll('.messageCustomerBtn').forEach(btn => {
            btn.addEventListener('click', () => {
              // Set the active conversation to this job
              if (typeof window !== 'undefined' && window.activeConversationJobId !== undefined) {
                window.activeConversationJobId = job.id;
              }
              document.body.removeChild(modalOverlay);
              setView('messages');
            });
          });
          
          modalOverlay.querySelector('.verifyStartCodeBtn')?.addEventListener('click', async () => {
            const verified = await verifyStartCode(job.id);
            if (verified) {
              document.body.removeChild(modalOverlay);
              // Refresh the modal to show updated state
              setTimeout(() => {
                showActiveJobModal(job.id, 'hustler');
              }, 500);
            }
          });
          
          modalOverlay.querySelector('.submitEndCodeBtn')?.addEventListener('click', async () => {
            const code = document.getElementById('endCodeInput')?.value.trim();
            if (!code) {
              showToast("Please enter the completion code.");
              return;
            }
            // Note: The completion code is generated when hustler marks complete, not before
            // So we just call submitCompletionCode which will generate the code
            await submitCompletionCode(job.id);
            document.body.removeChild(modalOverlay);
          });
        }
        
      } catch (error) {
        console.error("Error showing active job modal:", error);
        showToast("Error loading job details. Please try again.");
      }
    }
    
    window.showActiveJobModal = showActiveJobModal;
    
    // View Job Modal - Comprehensive job view with all features (Customer & Hustler views)
    async function showViewJobModal(jobId, role = 'customer') {
      try {
        const token = localStorage.getItem('hustl_token');
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          showToast("Please log in to view job details.");
          return;
        }
        
        // Fetch full job details
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        // Determine actual role
        const isCustomer = job.customerId === user.id;
        const isHustler = job.hustlerId === user.id;
        const actualRole = isCustomer ? 'customer' : (isHustler ? 'hustler' : role);
        
        // Fetch applicants/offers for customer view
        let offers = [];
        let pendingOffers = [];
        if (actualRole === 'customer') {
          try {
            const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
              headers: token ? { 'Authorization': `Bearer ${token}` } : {}
            });
            if (offersResponse.ok) {
              offers = await offersResponse.json();
              pendingOffers = offers.filter(o => o.status === 'PENDING');
            }
          } catch (e) {
            console.error("Error fetching offers:", e);
          }
        }
        
        // Create modal overlay
        const modalOverlay = document.createElement('div');
        modalOverlay.id = 'viewJobModal';
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        // Get requirements for additional fields
        const requirements = job.requirements || {};
        const pricingOption = requirements.pricing_option;
        const deadlinePreference = requirements.deadline_preference || job.deadlinePreference;
        const teamSize = job.teamSize || requirements.teamSize || requirements.team_size || 1;
        const keepActiveFor = requirements.keepActiveFor;
        const expiresAt = requirements.expiresAt ? new Date(requirements.expiresAt) : null;
        
        // Format pay
        const payType = job.payType || 'flat';
        let payDisplay = '';
        if (pricingOption === 'hustlers_quote') {
          payDisplay = '💰 Hustler suggests price';
        } else if (payType === 'hourly') {
          payDisplay = `$${parseFloat(job.hourlyRate || 0).toFixed(2)}/hr${job.estHours ? ` (max ${job.estHours} hrs)` : ''}`;
        } else {
          payDisplay = `$${parseFloat(job.amount || 0).toFixed(2)} flat`;
        }
        
        // Format timing display
        let timingDisplay = '';
        if (deadlinePreference === 'until_completed') {
          timingDisplay = 'Until completed (no strict deadline)';
        } else if (deadlinePreference === 'whenever' || deadlinePreference === 'flexible') {
          timingDisplay = 'Flexible this week';
        } else if (deadlinePreference === 'this_morning' || deadlinePreference === 'this_afternoon' || deadlinePreference === 'this_evening') {
          timingDisplay = 'Today – ASAP';
        } else if (deadlinePreference === 'tomorrow') {
          timingDisplay = 'Tomorrow';
        } else if (deadlinePreference === 'custom' && job.startTime) {
          const deadlineDate = new Date(job.startTime);
          timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } else if (job.startTime) {
          const deadlineDate = new Date(job.startTime);
          timingDisplay = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        } else {
          timingDisplay = 'Not specified';
        }
        
        // Format date/time
        const jobDate = new Date(job.date);
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = jobDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        // Format location
        const pickupArea = requirements.pickup_area || requirements.pickupArea;
        const pickupCity = requirements.pickup_city || requirements.pickupCity;
        const pickupZip = requirements.pickup_zip;
        const dropoffArea = requirements.dropoff_area || requirements.dropoffArea;
        const dropoffCity = requirements.dropoff_city || requirements.dropoffCity;
        const dropoffZip = requirements.dropoff_zip;
        const onSiteOnly = requirements.on_site_only || requirements.onSiteOnly;
        
        let locationDisplay = job.address || 'Address not specified';
        if (pickupArea || pickupCity) {
          const pickupParts = [];
          if (pickupArea) pickupParts.push(pickupArea);
          if (pickupCity) pickupParts.push(pickupCity);
          if (pickupZip) pickupParts.push(pickupZip);
          locationDisplay = pickupParts.join(', ');
          
          if (!onSiteOnly && (dropoffArea || dropoffCity)) {
            const dropoffParts = [];
            if (dropoffArea) dropoffParts.push(dropoffArea);
            if (dropoffCity) dropoffParts.push(dropoffCity);
            if (dropoffZip) dropoffParts.push(dropoffZip);
            locationDisplay += ` → ${dropoffParts.join(', ')}`;
          } else if (onSiteOnly) {
            locationDisplay += ' (Single location job)';
          }
        }
        
        // Format workers display
        let workersDisplay = '';
        if (teamSize === 0) {
          workersDisplay = 'Company / crew job';
        } else if (teamSize === 1) {
          workersDisplay = '1 worker';
        } else {
          workersDisplay = `${teamSize} workers`;
        }
        
        // Format expiration
        let expirationDisplay = '';
        if (expiresAt && expiresAt > new Date()) {
          const daysLeft = Math.ceil((expiresAt - new Date()) / (1000 * 60 * 60 * 24));
          expirationDisplay = `Expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}`;
        } else if (expiresAt && expiresAt <= new Date()) {
          expirationDisplay = 'Expired — Repost?';
        }
        
        // Category icon
        const categoryIcons = {
          'Moving / Hauling': '🚚',
          'Yard work / Outdoor': '🌿',
          'Cleaning / Organizing': '🧹',
          'Furniture / Assembly': '🛠',
          'Other': '⭐'
        };
        const categoryIcon = categoryIcons[job.category] || '📋';
        
        // Posted date
        const postedDate = new Date(job.createdAt);
        const daysAgo = Math.floor((Date.now() - postedDate.getTime()) / (1000 * 60 * 60 * 24));
        const postedText = daysAgo === 0 ? 'Posted today' : daysAgo === 1 ? 'Posted 1 day ago' : `Posted ${daysAgo} days ago`;
        
        if (actualRole === 'customer') {
          // CUSTOMER VIEW - Full job details with applicants
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 900px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeViewJobModal" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
                transition: all 0.2s;
              ">×</button>
              
              <div style="padding: 2rem;">
                <!-- Job Header -->
                <div style="margin-bottom: 2rem;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <span style="font-size: 2rem;">${categoryIcon}</span>
                    <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                    <span style="padding: 0.35rem 0.75rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-weight: 600;">${job.category || 'General'}</span>
                    <span style="font-weight: 600; color: var(--text-main);">💰 ${payDisplay}</span>
                    <span style="padding: 0.35rem 0.75rem; background: #10b98120; color: #10b981; border-radius: 6px; font-weight: 600;">${job.status || 'Open'}</span>
                    <span>📅 ${postedText}</span>
                  </div>
                </div>
                
                <!-- Full Job Description -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid var(--border);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">📝 Full Description</h3>
                  <div style="color: var(--text-main); line-height: 1.7; white-space: pre-wrap;">${job.description || 'No description provided.'}</div>
                </div>
                
                <!-- Job Details Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">💰 Pay</div>
                    <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">${payDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">⏰ Timing</div>
                    <div style="font-weight: 600; color: var(--text-main);">${timingDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">👥 Workers</div>
                    <div style="font-weight: 600; color: var(--text-main);">${workersDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">📍 Location</div>
                    <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem;">${locationDisplay}</div>
                  </div>
                  ${expirationDisplay ? `
                  <div style="padding: 1rem; background: ${expiresAt && expiresAt <= new Date() ? '#fee2e2' : '#fef3c7'}; border-radius: 8px; border: 1px solid ${expiresAt && expiresAt <= new Date() ? '#fca5a5' : '#fbbf24'};">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">⏳ Visibility</div>
                    <div style="font-weight: 600; color: ${expiresAt && expiresAt <= new Date() ? '#dc2626' : '#d97706'};">${expirationDisplay}</div>
                  </div>
                  ` : ''}
                </div>
                
                ${requirements.notes ? `
                <!-- Notes Section -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 1px solid #fbbf24;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #92400e;">📝 Additional Notes</h3>
                  <div style="color: #92400e; line-height: 1.7; white-space: pre-wrap;">${requirements.notes}</div>
                </div>
                ` : ''}
                
                <!-- Job Timeline -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">📊 Job Timeline</h3>
                  <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                      <span style="padding: 0.5rem; background: #10b981; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">1</span>
                      <div>
                        <div style="font-weight: 600; color: var(--text-main);">Posted</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">${postedText}</div>
                      </div>
                    </div>
                    ${job.hustlerId ? `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                      <span style="padding: 0.5rem; background: #3b82f6; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">2</span>
                      <div>
                        <div style="font-weight: 600; color: var(--text-main);">Accepted</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Hustler accepted the job</div>
                      </div>
                    </div>
                    ` : ''}
                    ${job.status === 'ASSIGNED' || job.status === 'REQUESTED' ? `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                      <span style="padding: 0.5rem; background: #f59e0b; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">3</span>
                      <div>
                        <div style="font-weight: 600; color: var(--text-main);">Active</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Job is in progress</div>
                      </div>
                    </div>
                    ` : ''}
                    ${job.status === 'PAID' ? `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                      <span style="padding: 0.5rem; background: #10b981; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">4</span>
                      <div>
                        <div style="font-weight: 600; color: var(--text-main);">Completed</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Job finished and paid</div>
                      </div>
                    </div>
                    ` : ''}
                  </div>
                </div>
                
                <!-- Start Code Section (Customer) - NOT for completed jobs -->
                ${job.hustlerId && job.startCode && !job.startCodeVerified && job.status === 'ASSIGNED' && job.status !== 'PAID' ? `
                <div style="border-top: 2px solid var(--border); padding-top: 2rem; margin-bottom: 2rem;">
                  <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 2px solid #fbbf24;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: #92400e; margin-bottom: 0.75rem;">🔐 Start Code (Give to Hustler)</div>
                    <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #92400e; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;">${job.startCode}</div>
                    <div style="padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;">
                      <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">⚠️ Safety Warning</div>
                      <div style="font-size: 0.85rem; color: #991b1b;">Do not give the Start Code until the hustler is physically there and ready to begin the job.</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #92400e; margin-bottom: 0.75rem;">
                      Share this 6-digit code with your hustler when they arrive to start the job.
                    </div>
                    <button class="btn btn-ghost regenerateStartCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">🔄 Regenerate Code</button>
                  </div>
                </div>
                ` : ''}
                
                <!-- Completion Code Section (Customer) - NOT for completed jobs -->
                ${job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified ? `
                <div style="border-top: 2px solid var(--border); padding-top: 2rem; margin-bottom: 2rem;">
                  <div style="padding: 1.5rem; background: #dcfce7; border-radius: 12px; border: 2px solid #16a34a;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: #166534; margin-bottom: 0.75rem;">🔐 Completion Code (For Hustler)</div>
                    <div style="font-size: 2rem; font-weight: 700; letter-spacing: 0.3em; color: #166534; text-align: center; padding: 1rem; background: white; border-radius: 8px; font-family: 'Courier New', monospace; margin-bottom: 0.75rem;">${job.completionCode}</div>
                    <div style="padding: 0.75rem; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 6px; margin-bottom: 0.75rem;">
                      <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">⚠️ Safety Warning</div>
                      <div style="font-size: 0.85rem; color: #991b1b;">Only give the Completion Code after the job is fully done and you are satisfied with the work.</div>
                    </div>
                    <div style="font-size: 0.9rem; color: #166534; margin-bottom: 0.75rem;">
                      The hustler will enter this code when the job is complete. Do not share it until you are satisfied with the work.
                    </div>
                    <button class="btn btn-ghost regenerateCompletionCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">🔄 Regenerate Code</button>
                  </div>
                </div>
                ` : ''}
                
                <!-- Assigned Hustler Section (when job is assigned) -->
                ${job.hustlerId ? `
                <div style="border-top: 2px solid var(--border); padding-top: 2rem; margin-bottom: 2rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0; color: var(--text-main);">
                      ✅ Assigned Hustler
                    </h3>
                  </div>
                  <div style="padding: 1.5rem; border: 2px solid var(--border); border-radius: 12px; background: white;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                      <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.5rem;">👤</div>
                      <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem; margin-bottom: 0.25rem;">Assigned</div>
                        <div style="font-size: 0.9rem; color: var(--text-muted);">Job has been assigned to a hustler</div>
                      </div>
                    </div>
                  </div>
                </div>
                ` : ''}
                
                <!-- Applicants Section (only show if job is OPEN and has pending offers) -->
                ${job.status === 'OPEN' && pendingOffers.length > 0 ? `
                <div style="border-top: 2px solid var(--border); padding-top: 2rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin: 0; color: var(--text-main);">
                      👥 Applicants (${pendingOffers.length})
                    </h3>
                    ${pendingOffers.length === 0 && job.status === 'OPEN' ? `
                    <button class="btn btn-ghost repostJobBtn" data-job-id="${job.id}" style="padding: 0.5rem 1rem; font-size: 0.9rem;">🔄 Repost Job</button>
                    ` : ''}
                  </div>
                  
                  <div id="applicantsListContainer" style="display: flex; flex-direction: column; gap: 1rem;">
                    ${pendingOffers.length === 0 ? `
                      <div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">👤</div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No applicants yet</div>
                        <div style="margin-bottom: 1.5rem;">Share your job to get more applicants!</div>
                        <button class="btn btn-primary repostJobBtn" data-job-id="${job.id}" style="padding: 0.75rem 1.5rem;">🔄 Repost Job</button>
                      </div>
                    ` : pendingOffers.map(offer => {
                      const hustler = offer.hustler || {};
                      const rating = hustler.ratingAvg || 0;
                      const ratingCount = hustler.ratingCount || 0;
                      const jobAmount = parseFloat(job.amount || 0);
                      const proposedAmount = offer.proposedAmount ? parseFloat(offer.proposedAmount) : null;
                      const proposedPrice = proposedAmount ? `$${proposedAmount.toFixed(2)}` : null;
                      
                      // Check if customer negotiated (proposedAmount exists and differs from job amount)
                      // Also check if this was recently negotiated (within last hour) by checking localStorage
                      const negotiationKey = `negotiated_${offer.id}`;
                      const wasRecentlyNegotiated = localStorage.getItem(negotiationKey) === 'true';
                      const hasNegotiation = proposedAmount && Math.abs(proposedAmount - jobAmount) > 0.01;
                      
                      const appliedDate = new Date(offer.createdAt);
                      const appliedText = daysAgo === 0 ? 'Applied today' : daysAgo === 1 ? 'Applied 1 day ago' : `Applied ${daysAgo} days ago`;
                      
                      return `
                        <div data-offer-id="${offer.id}" style="
                          padding: 1.5rem;
                          border: 2px solid var(--border);
                          border-radius: 12px;
                          background: white;
                          transition: all 0.2s;
                        " class="applicant-card">
                          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            ${hustler.photoUrl ? `<img src="${hustler.photoUrl}" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer;" class="viewApplicantProfile" data-user-id="${hustler.id}">` : `<div style="width: 70px; height: 70px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.75rem; flex-shrink: 0; cursor: pointer;" class="viewApplicantProfile" data-user-id="${hustler.id}">${(hustler.name || 'U')[0].toUpperCase()}</div>`}
                            <div style="flex: 1;">
                              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="font-weight: 700; color: var(--text-main); font-size: 1.2rem; cursor: pointer;" class="viewApplicantProfile" data-user-id="${hustler.id}">${hustler.name || 'Unknown'}</div>
                              </div>
                              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1rem;">${'⭐'.repeat(Math.floor(rating))}${rating % 1 >= 0.5 ? '⭐' : ''}</span>
                                <span style="color: var(--text-muted); font-size: 0.9rem;">${rating.toFixed(1)} (${ratingCount} ${ratingCount === 1 ? 'review' : 'reviews'})</span>
                              </div>
                              ${hustler.bio ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.75rem; line-height: 1.5;">${hustler.bio}</div>` : ''}
                              ${offer.note ? `<div style="padding: 0.75rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem; font-weight: 600;">Why I'm a good fit:</div>
                                <div style="color: var(--text-main); line-height: 1.5;">${offer.note}</div>
                              </div>` : ''}
                              ${hasNegotiation ? `
                                <div style="padding: 1rem; background: ${wasRecentlyNegotiated ? '#dbeafe' : '#f0fdf4'}; border: 2px solid ${wasRecentlyNegotiated ? '#3b82f6' : '#86efac'}; border-radius: 8px; margin-bottom: 0.75rem;">
                                  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.2rem;">${wasRecentlyNegotiated ? '💬' : '💰'}</span>
                                    <div style="font-size: 0.9rem; font-weight: 700; color: ${wasRecentlyNegotiated ? '#1e40af' : '#166534'};">
                                      ${wasRecentlyNegotiated ? 'You sent a price negotiation!' : 'Negotiated Price'}
                                    </div>
                                  </div>
                                  <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.25rem;">
                                    Your offer: <span style="color: var(--primary);">${proposedPrice}</span>
                                  </div>
                                  ${jobAmount > 0 ? `<div style="font-size: 0.85rem; color: var(--text-muted);">
                                    Original job price: $${jobAmount.toFixed(2)}
                                  </div>` : ''}
                                </div>
                              ` : proposedPrice ? `
                                <div style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                                  💵 Hustler's suggested price: <span style="font-weight: 700; color: var(--primary); font-size: 1.1rem;">${proposedPrice}</span>
                                </div>
                              ` : ''}
                              <div style="font-size: 0.85rem; color: var(--text-muted);">${appliedText}</div>
                            </div>
                          </div>
                          
                          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn btn-primary acceptApplicantBtn" data-offer-id="${offer.id}" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">✅ Accept</button>
                            <button class="btn btn-ghost declineApplicantBtn" data-offer-id="${offer.id}" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; color: #dc2626; border-color: #fecaca;">❌ Decline</button>
                            <button class="btn btn-ghost negotiatePriceBtn" data-offer-id="${offer.id}" data-job-id="${job.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem; ${hasNegotiation ? 'border: 2px solid var(--primary); background: var(--primary-soft);' : ''}">${hasNegotiation ? '💰 Edit Negotiation' : '💰 Negotiate Price'}</button>
                            <button class="btn btn-ghost viewApplicantProfileBtn" data-user-id="${hustler.id}" style="padding: 0.75rem 1rem; font-size: 0.9rem;">👤 View Profile</button>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
                ` : ''}
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--border);">
                  ${job.status === 'OPEN' ? `
                  <button class="btn btn-ghost editJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">✏️ Edit Job</button>
                  <button class="btn btn-ghost cancelJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; color: #dc2626; border-color: #fecaca; font-weight: 600;">🚫 Cancel Job</button>
                  ${(() => {
                    const requirements = job.requirements || {};
                    const isKeepOpenEnabled = requirements.keepOpenUntilAccepted === true;
                    return `
                  <div style="width: 100%; margin-top: 1rem; padding: 1rem; background: ${isKeepOpenEnabled ? '#dbeafe' : '#f9fafb'}; border: 2px solid ${isKeepOpenEnabled ? '#3b82f6' : '#e5e7eb'}; border-radius: 8px;">
                    ${isKeepOpenEnabled ? `
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem; background: #3b82f6; color: white; border-radius: 6px; font-weight: 700; font-size: 0.9rem;">
                      <span>✅</span>
                      <span>Setting Active: Job will stay open until you accept a hustler</span>
                    </div>
                    ` : ''}
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                      <input type="checkbox" id="keepOpenUntilAccepted" ${isKeepOpenEnabled ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer;">
                      <span style="font-size: 0.95rem; color: var(--text-main); font-weight: 600;">✓ Keep active until hustler assigned</span>
                    </label>
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; margin-left: 2rem;">
                      ${isKeepOpenEnabled ? '✅ Active - Job will automatically close once you assign a hustler' : 'Job will automatically close once you assign a hustler'}
                    </div>
                    <button class="btn btn-primary saveKeepOpenSettingBtn" data-job-id="${job.id}" style="margin-top: 0.75rem; padding: 0.5rem 1rem; font-size: 0.9rem; font-weight: 600;">💾 Save Setting</button>
                  </div>
                  `;
                  })()}
                  ` : ''}
                  ${pendingOffers.length === 0 && job.status === 'OPEN' ? `
                  <button class="btn btn-primary repostJobBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">🔄 Repost Job</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        } else {
          // HUSTLER VIEW - Job details with apply option
          modalOverlay.innerHTML = `
            <div style="
              background: white;
              border-radius: 16px;
              max-width: 800px;
              width: 100%;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              position: relative;
            ">
              <button class="closeViewJobModal" style="
                position: absolute;
                top: 1rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                border: none;
                background: #f3f4f6;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                z-index: 1;
              ">×</button>
              
              <div style="padding: 2rem;">
                <!-- Job Header -->
                <div style="margin-bottom: 2rem;">
                  <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <span style="font-size: 2rem;">${categoryIcon}</span>
                    <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0; color: var(--text-main);">${job.title || 'Untitled Job'}</h2>
                  </div>
                  
                  <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 1rem;">
                    <span style="padding: 0.35rem 0.75rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-weight: 600;">${job.category || 'General'}</span>
                    <span style="font-weight: 600; color: var(--text-main);">💰 ${payDisplay}</span>
                    <span style="padding: 0.35rem 0.75rem; background: #10b98120; color: #10b981; border-radius: 6px; font-weight: 600;">${job.status || 'Open'}</span>
                  </div>
                </div>
                
                <!-- Full Job Description -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px; border: 1px solid var(--border);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">📝 Full Description</h3>
                  <div style="color: var(--text-main); line-height: 1.7; white-space: pre-wrap;">${job.description || 'No description provided.'}</div>
                </div>
                
                <!-- Job Details Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">💰 Pay</div>
                    <div style="font-weight: 700; color: var(--text-main); font-size: 1.1rem;">${payDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">⏰ Timing</div>
                    <div style="font-weight: 600; color: var(--text-main);">${timingDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">👥 Workers</div>
                    <div style="font-weight: 600; color: var(--text-main);">${workersDisplay}</div>
                  </div>
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">📍 Location</div>
                    <div style="font-weight: 600; color: var(--text-main); font-size: 0.9rem;">${locationDisplay}</div>
                  </div>
                </div>
                
                ${requirements.notes ? `
                <!-- Notes Section -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 1px solid #fbbf24;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #92400e;">📝 Additional Notes</h3>
                  <div style="color: #92400e; line-height: 1.7; white-space: pre-wrap;">${requirements.notes}</div>
                </div>
                ` : ''}
                
                ${requirements.equipment_needed && requirements.equipment_needed.length > 0 ? `
                <!-- Equipment Needed -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #eff6ff; border-radius: 12px; border: 1px solid #3b82f6;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: #1e40af;">🔧 Equipment Needed</h3>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${requirements.equipment_needed.map(eq => `<span style="padding: 0.5rem 1rem; background: white; border: 1px solid #3b82f6; border-radius: 6px; font-size: 0.9rem; color: #1e40af; font-weight: 600;">${eq}</span>`).join('')}
                  </div>
                </div>
                ` : ''}
                
                <!-- Customer Info -->
                ${job.customer ? `
                <div style="padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 2rem; border: 1px solid var(--border);">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">👤 Job Poster</h3>
                  <div style="display: flex; gap: 1rem; align-items: center;">
                    ${job.customer.photoUrl ? `<img src="${job.customer.photoUrl}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${job.customerId}">` : `<div style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 1.5rem; cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${job.customerId}">${(job.customer.name || 'C')[0].toUpperCase()}</div>`}
                    <div style="flex: 1;">
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem; cursor: pointer;" class="viewCustomerProfileBtn" data-user-id="${job.customerId}">${job.customer.name || 'Unknown'}</div>
                      <div style="color: var(--text-muted); font-size: 0.9rem;">${job.customer.city || ''} ${job.customer.zip || ''}</div>
                    </div>
                    <button class="btn btn-ghost viewCustomerProfileBtn" data-user-id="${job.customerId}" style="padding: 0.75rem 1rem;">View Profile</button>
                  </div>
                </div>
                ` : ''}
                
                <!-- Apply Section -->
                ${job.status === 'OPEN' && !isHustler ? `
                <div style="padding: 1.5rem; background: #f0fdf4; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #10b981;">
                  <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💼 Apply for This Job</h3>
                  
                  <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.75rem;">💰 Pay Rate</label>
                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem; border: 2px solid var(--border);">
                      <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.25rem;">Current Rate:</div>
                      <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${payDisplay}</div>
                      <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">${payType === 'hourly' ? 'Hourly Rate' : 'Flat Rate'}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding: 0.75rem; background: #f0fdf4; border-radius: 8px; border: 2px solid #10b981;">
                      <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; flex: 1;">
                        <input type="checkbox" id="negotiatePriceCheck" style="width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer;">
                        <span style="font-size: 0.95rem; font-weight: 600; color: var(--text-main);">💵 Suggest a different ${payType === 'hourly' ? 'hourly' : 'flat'} rate</span>
                      </label>
                    </div>
                    <div id="proposedPriceContainer" style="display: none; margin-top: 1rem;">
                      <label style="display: block; font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.75rem;">💰 Your Proposed ${payType === 'hourly' ? 'Hourly' : 'Flat'} Rate</label>
                      <div style="position: relative;">
                        <span style="position: absolute; left: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 2rem; font-weight: 700; color: var(--primary); z-index: 1;">$</span>
                        <input type="number" id="proposedPriceInput" placeholder="${payType === 'hourly' ? 'e.g., 25.00' : 'e.g., 150.00'}" step="0.01" min="0" style="width: 100%; padding: 2rem 1.5rem 2rem 3.5rem; border: 4px solid var(--primary); border-radius: 16px; font-size: 2.5rem; font-weight: 700; text-align: left; background: #f0fdf4; color: var(--text-main); min-height: 80px; box-sizing: border-box; transition: all 0.2s;">
                        ${payType === 'hourly' ? '<span style="position: absolute; right: 1.5rem; top: 50%; transform: translateY(-50%); font-size: 1.5rem; font-weight: 600; color: var(--text-muted); z-index: 1;">/hr</span>' : ''}
                      </div>
                      <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dbeafe; border-radius: 8px; font-size: 0.85rem; color: #1e40af;">
                        💡 Customer will see your proposed ${payType === 'hourly' ? 'hourly' : 'flat'} rate when reviewing your application
                      </div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">💬 Why I'm a good fit</label>
                    <textarea id="applicationNoteInput" placeholder="Tell the customer why you're perfect for this job..." style="width: 100%; min-height: 120px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
                  </div>
                  
                  <button class="btn btn-primary applyToJobBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600;">✅ Apply to Job</button>
                </div>
                ` : isHustler ? `
                <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; color: #1e40af; margin-bottom: 0.5rem;">✅ You've been accepted for this job!</div>
                  <div style="color: var(--text-muted); font-size: 0.9rem;">You can message the customer and view job details.</div>
                </div>
                ` : ''}
                
                <!-- Start Code Input (Hustler) - NOT for completed jobs -->
                ${isHustler && job.startCode && !job.startCodeVerified && job.status === 'ASSIGNED' && job.status !== 'PAID' ? `
                <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;">🔐 Enter Start Code</div>
                  <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;">Ask the customer for the 6-digit start code to begin the job.</div>
                  <input type="text" id="hustlerStartCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;">
                  <button class="btn btn-primary verifyHustlerStartCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-weight: 600;">Verify & Start Job</button>
                </div>
                ` : ''}
                
                <!-- Completion Code Input (Hustler) - NOT for completed jobs -->
                ${isHustler && job.startCodeVerified && job.status === 'IN_PROGRESS' && job.status !== 'PAID' && job.completionCode && !job.completionCodeVerified ? `
                <div style="padding: 1.5rem; background: #dbeafe; border-radius: 12px; margin-bottom: 2rem; border: 2px solid #3b82f6;">
                  <div style="font-weight: 700; font-size: 1.1rem; color: #1e40af; margin-bottom: 0.75rem;">🔐 Enter Completion Code</div>
                  <div style="font-size: 0.9rem; color: #1e40af; margin-bottom: 1rem;">Ask the customer for the 6-digit completion code to finish the job and release payment.</div>
                  <input type="text" id="hustlerCompletionCodeInput" placeholder="Enter 6-digit code" maxlength="6" style="width: 100%; padding: 1rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.3em; border: 2px solid #3b82f6; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 600; margin-bottom: 0.75rem;">
                  <button class="btn btn-primary verifyHustlerCompletionCodeBtn" data-job-id="${job.id}" style="width: 100%; padding: 0.75rem; font-weight: 600;">Verify & Complete Job</button>
                </div>
                ` : ''}
                
                ${isHustler ? `
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 2rem;">
                  <button class="btn btn-primary messageCustomerBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; font-weight: 600;">💬 Message Customer</button>
                  ${job.status === 'ASSIGNED' && !job.startCodeVerified ? `
                  <button class="btn btn-ghost cancelApplicationBtn" data-job-id="${job.id}" style="flex: 1; min-width: 140px; padding: 0.75rem; color: #dc2626; border-color: #fecaca; font-weight: 600;">🚫 Cancel - Can't Do Job</button>
                  ` : ''}
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        document.body.appendChild(modalOverlay);
        
        // Close button
        modalOverlay.querySelector('.closeViewJobModal')?.addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        // Click outside to close
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
        
        // Event listeners for customer view
        if (actualRole === 'customer') {
          // Accept/Decline applicants
          modalOverlay.querySelectorAll('.acceptApplicantBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId;
              await acceptOffer(offerId, jobId, modalOverlay);
            });
          });
          
          modalOverlay.querySelectorAll('.declineApplicantBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId || job.id;
              if (confirm('Are you sure you want to decline this applicant? They will be removed from the applicants list.')) {
                await declineOffer(offerId, jobId, modalOverlay);
              }
            });
          });
          
          // Negotiate price
          modalOverlay.querySelectorAll('.negotiatePriceBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const offerId = btn.dataset.offerId;
              const jobId = btn.dataset.jobId;
              showNegotiatePriceModal(offerId, jobId, modalOverlay);
            });
          });
          
          // View applicant profile
          modalOverlay.querySelectorAll('.viewApplicantProfile, .viewApplicantProfileBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const userId = btn.dataset.userId;
              showApplicantProfileModal(userId);
            });
          });
          
          // Edit/Close/Repost job
          modalOverlay.querySelector('.editJobBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            document.body.removeChild(modalOverlay);
            // Navigate to edit job (could be a separate view or modal)
            showToast("Edit job feature coming soon");
          });
          
          // Save keep open setting button
          modalOverlay.querySelector('.saveKeepOpenSettingBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const keepOpenUntilAccepted = modalOverlay.querySelector('#keepOpenUntilAccepted')?.checked || false;
            await cancelJob(job.id, keepOpenUntilAccepted, true); // true = just updating setting, not canceling
          });
          
          modalOverlay.querySelector('.cancelJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const keepOpenUntilAccepted = modalOverlay.querySelector('#keepOpenUntilAccepted')?.checked || false;
            if (confirm(`Are you sure you want to cancel this job?${keepOpenUntilAccepted ? ' (Job will stay active until a hustler is assigned)' : ''}`)) {
              await cancelJob(job.id, keepOpenUntilAccepted);
              document.body.removeChild(modalOverlay);
              loadPostedJobs();
            }
          });
          
          modalOverlay.querySelectorAll('.repostJobBtn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.stopPropagation();
              await repostJob(job.id);
              document.body.removeChild(modalOverlay);
              loadPostedJobs();
            });
          });
        } else {
          // Event listeners for hustler view
          // Negotiate price checkbox
          const negotiateCheck = modalOverlay.querySelector('#negotiatePriceCheck');
          const priceContainer = modalOverlay.querySelector('#proposedPriceContainer');
          if (negotiateCheck && priceContainer) {
            negotiateCheck.addEventListener('change', (e) => {
              priceContainer.style.display = e.target.checked ? 'block' : 'none';
              if (e.target.checked) {
                // Focus the input when shown
                setTimeout(() => {
                  const input = priceContainer.querySelector('#proposedPriceInput');
                  if (input) input.focus();
                }, 100);
              }
            });
          }
          
          // Apply to job
          modalOverlay.querySelector('.applyToJobBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const note = document.getElementById('applicationNoteInput')?.value.trim() || '';
            const negotiatePrice = document.getElementById('negotiatePriceCheck')?.checked || false;
            const proposedPrice = negotiatePrice ? parseFloat(document.getElementById('proposedPriceInput')?.value || 0) : null;
            
            if (negotiatePrice && !proposedPrice) {
              showToast("Please enter a proposed price or uncheck negotiable.");
              return;
            }
            
            await applyToJob(job.id, note, proposedPrice);
            document.body.removeChild(modalOverlay);
            showToast("Application submitted!");
          });
          
          // Cancel application
          modalOverlay.querySelector('.cancelApplicationBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            if (confirm('Are you sure you want to cancel this job? You cannot do it anymore. The customer will be notified and the job will be reopened for other applicants. This action cannot be undone.')) {
              await cancelApplication(job.id);
              document.body.removeChild(modalOverlay);
              loadActiveJobs();
            }
          });
          
          // Message customer
          modalOverlay.querySelector('.messageCustomerBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            // Set the active conversation to this job
            if (typeof window !== 'undefined' && window.activeConversationJobId !== undefined) {
              window.activeConversationJobId = job.id;
            }
            document.body.removeChild(modalOverlay);
            setView('messages');
          });
          
          // Start code verification (hustler)
          modalOverlay.querySelector('.verifyHustlerStartCodeBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const codeInput = modalOverlay.querySelector('#hustlerStartCodeInput');
            const code = codeInput?.value.trim() || '';
            if (code.length !== 6) {
              showToast("Please enter a 6-digit code");
              return;
            }
            try {
              const btn = e.target;
              btn.disabled = true;
              btn.textContent = "Verifying...";
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-start`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ code })
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.error || "Verification failed");
              }
              showToast("✅ Start code verified! Job is now active.");
              document.body.removeChild(modalOverlay);
              showViewJobModal(job.id, 'hustler');
              if (typeof loadActiveJobs === 'function') loadActiveJobs();
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to verify"));
              e.target.disabled = false;
              e.target.textContent = "Verify & Start Job";
            }
          });
          
          // Completion code verification (hustler)
          modalOverlay.querySelector('.verifyHustlerCompletionCodeBtn')?.addEventListener('click', async (e) => {
            e.stopPropagation();
            const codeInput = modalOverlay.querySelector('#hustlerCompletionCodeInput');
            const code = codeInput?.value.trim() || '';
            if (code.length !== 6) {
              showToast("Please enter a 6-digit code");
              return;
            }
            try {
              const btn = e.target;
              btn.disabled = true;
              btn.textContent = "Verifying...";
              const token = localStorage.getItem("hustl_token");
              const response = await fetch(`${API_BASE}/verification/job/${job.id}/verify-completion`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ code })
              });
              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.error || "Verification failed");
              }
              
              // Close the job modal
              document.body.removeChild(modalOverlay);
              
              // Show congratulations modal, then force review
              showJobCompletionFlow(data.jobId, data.customerId, data.hustlerId);
              
              // Refresh jobs
              if (typeof loadActiveJobs === 'function') loadActiveJobs();
              if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to verify"));
              e.target.disabled = false;
              e.target.textContent = "Verify & Complete Job";
            }
          });
          
          // Input validation for code inputs
          modalOverlay.querySelector('#hustlerStartCodeInput')?.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, "");
          });
          modalOverlay.querySelector('#hustlerCompletionCodeInput')?.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, "");
          });
          
          // View customer profile
          modalOverlay.querySelectorAll('.viewCustomerProfileBtn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const userId = btn.dataset.userId;
              showApplicantProfileModal(userId);
            });
          });
        }
        
      } catch (error) {
        console.error("Error showing view job modal:", error);
        showToast("Error loading job details. Please try again.");
      }
    }
    
    window.showViewJobModal = showViewJobModal;
    
    // Helper functions for job actions
    async function verifyStartCode(jobId) {
      try {
        const code = document.getElementById('startCodeInput')?.value.trim();
        if (!code || code.length !== 6) {
          showToast("Please enter a valid 6-digit start code.");
          return;
        }
        
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/verification/job/${jobId}/verify-start`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ code })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to verify start code');
        }
        
        const data = await response.json();
        showToast("✅ Start code verified! Job is now active. You can begin work.");
        loadActiveJobs(); // Refresh list
        return true;
      } catch (error) {
        console.error("Error verifying start code:", error);
        showToast(error.message || "Error verifying start code. Please check the code and try again.");
        return false;
      }
    }
    
    async function submitCompletionCode(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to complete job');
        }
        
        showToast("✅ Job marked as complete! Waiting for customer confirmation.");
        loadActiveJobs(); // Refresh list
      } catch (error) {
        console.error("Error completing job:", error);
        showToast(error.message || "Error completing job. Please try again.");
      }
    }
    
    async function confirmJobComplete(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/confirm-complete`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to confirm completion');
        }
        
        showToast("✅ Job confirmed complete! Payment will be processed.");
        loadActiveJobs(); // Refresh list
        loadCompletedJobs(); // Refresh completed list
      } catch (error) {
        console.error("Error confirming completion:", error);
        showToast(error.message || "Error confirming completion. Please try again.");
      }
    }
    
    async function cancelJob(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to cancel job');
        }
        
        showToast("Job cancelled successfully.");
        loadActiveJobs(); // Refresh list
        loadPostedJobs(); // Refresh posted list
      } catch (error) {
        console.error("Error cancelling job:", error);
        showToast(error.message || "Error cancelling job. Please try again.");
      }
    }
    
    // Show Applicants Modal - Professional management interface
    window.showApplicantsModal = async function(jobId) {
      const token = localStorage.getItem('hustl_token');
      
      // Fetch job and offers
      let job, offers;
      try {
        const [jobRes, offersRes] = await Promise.all([
          fetch(`${API_BASE}/jobs/${jobId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
          }),
          fetch(`${API_BASE}/offers/${jobId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : {}
          })
        ]);
        
        if (!jobRes.ok || !offersRes.ok) throw new Error('Failed to fetch data');
        job = await jobRes.json();
        offers = await offersRes.ok ? await offersRes.json() : [];
      } catch (error) {
        console.error("Error fetching job/offers:", error);
        showToast("Error loading applicants. Please try again.");
        return;
      }
      
      // Filter to only pending offers
      const pendingOffers = offers.filter(o => o.status === 'PENDING');
      
      // Create modal
      const overlay = document.createElement("div");
      overlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
      overlay.id = "applicantsModalOverlay";
      
      const modal = document.createElement("div");
      modal.style.cssText = "background: white; border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);";
      
      modal.innerHTML = `
        <div style="padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: var(--text-main);">Manage Applicants</h2>
            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--text-muted);">${job.title}</p>
          </div>
          <button id="closeApplicantsModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.5rem; line-height: 1;">&times;</button>
        </div>
        <div style="flex: 1; overflow-y: auto; padding: 1.5rem 2rem;">
          ${pendingOffers.length === 0 ? `
            <div style="text-align: center; padding: 3rem 1rem;">
              <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
              <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No applicants yet</div>
              <div style="color: var(--text-muted);">Share your job to get more applicants!</div>
            </div>
          ` : pendingOffers.map(offer => {
            const hustler = offer.hustler;
            const rating = hustler.ratingAvg || 5.0;
            const reviewCount = hustler.ratingCount || 0;
            const proposedPrice = offer.proposedAmount ? `$${parseFloat(offer.proposedAmount).toFixed(2)}` : null;
            const jobPrice = `$${parseFloat(job.amount || 0).toFixed(2)}`;
            
            return `
              <div style="padding: 1.5rem; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1rem; background: white;">
                <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                  <div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, #e0e7ff 0%, #fce7f3 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; color: var(--primary);">
                    ${hustler.photoUrl ? `<img src="${hustler.photoUrl}" style="width: 100%; height: 100%; object-fit: cover;">` : (hustler.name || 'H')[0].toUpperCase()}
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-main); margin-bottom: 0.25rem;">${hustler.name || 'Hustler'}</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">
                      <span>⭐ ${rating.toFixed(1)}</span>
                      <span>(${reviewCount} ${reviewCount === 1 ? 'review' : 'reviews'})</span>
                    </div>
                    ${hustler.bio ? `<div style="font-size: 0.9rem; color: var(--text-main); line-height: 1.5; margin-top: 0.5rem;">${hustler.bio.substring(0, 150)}${hustler.bio.length > 150 ? '...' : ''}</div>` : ''}
                  </div>
                </div>
                
                ${offer.note ? `
                  <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="font-weight: 600; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">Why I'm a good fit:</div>
                    <div style="color: var(--text-main); line-height: 1.6; font-size: 0.9rem;">${offer.note}</div>
                  </div>
                ` : ''}
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div>
                    ${proposedPrice ? `
                      <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Proposed Price</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">${proposedPrice}</div>
                      <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Your price: ${jobPrice}</div>
                    ` : `
                      <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Price</div>
                      <div style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">${jobPrice}</div>
                    `}
                  </div>
                  <div style="display: flex; gap: 0.75rem;">
                    <button class="btn btn-ghost declineOfferBtn" data-offer-id="${offer.id}" style="padding: 0.75rem 1.5rem; color: #6b7280;">Decline</button>
                    <button class="btn btn-primary acceptOfferBtn" data-offer-id="${offer.id}" data-job-id="${jobId}" style="padding: 0.75rem 1.5rem;">
                      💳 Accept & Pay
                    </button>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding: 0.5rem; background: #f0f9ff; border-radius: 6px; border: 1px solid #bae6fd;">
                      💰 Payment will be held in escrow until job completion
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Close button
      overlay.querySelector('#closeApplicantsModal')?.addEventListener('click', () => {
        document.body.removeChild(overlay);
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          document.body.removeChild(overlay);
        }
      });
      
      // Accept/Decline buttons
      modal.querySelectorAll('.acceptOfferBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const offerId = btn.dataset.offerId;
          const jobId = btn.dataset.jobId;
          await acceptOffer(offerId, jobId, overlay);
        });
      });
      
      modal.querySelectorAll('.declineOfferBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const offerId = btn.dataset.offerId;
          await declineOffer(offerId, jobId, overlay);
        });
      });
    };
    
    // Delete Job function
    window.deleteJob = async function(jobId, jobTitle) {
      if (!confirm(`Are you sure you want to delete "${jobTitle}"? This cannot be undone.`)) {
        return;
      }
      
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}`, {
          method: 'DELETE',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete job');
        }
        
        showToast("Job deleted successfully.");
        
        // Refresh the manage jobs view if we're on it
        if (activeView === 'manage-jobs') {
          const postedJobsList = document.getElementById("managePostedJobsList");
          if (postedJobsList) {
            postedJobsList.dataset.loaded = 'false'; // Force reload
            loadPostedJobs();
          }
        } else {
          // Otherwise refresh profile jobs tab
          const jobsTab = document.querySelector('.profile-tab[data-tab="jobs"]');
          if (jobsTab) {
            jobsTab.click();
          }
        }
      } catch (error) {
        console.error("Error deleting job:", error);
        showToast(error.message || "Error deleting job. Please try again.");
      }
    };
    
    // Accept Offer helper
    async function acceptOffer(offerId, jobId, modalOverlay) {
      try {
        showToast("Processing...");
        
        const token = localStorage.getItem('hustl_token');
        
        // Check if payment is needed by trying to accept first
        const offerRes = await fetch(`${API_BASE}/offers/${offerId}/accept`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        if (!offerRes.ok) {
          const error = await offerRes.json().catch(() => ({}));
          if (error.requiresStripe || error.error?.includes('Stripe')) {
            // Stripe account required
            showToast("⚠️ This hustler needs to connect their Stripe account before you can accept them. They've been notified via email.");
            return;
          }
          if (error.requiresPayment) {
            // Show embedded payment modal
            await showPaymentModal(offerId, jobId, modalOverlay);
            return;
          }
          throw new Error(error.error || 'Failed to accept offer');
        }
        
        // Payment not required (test mode) or already paid
        showToast("✅ Hustler accepted! Payment is held in escrow until job completion.");
        if (modalOverlay && modalOverlay.parentNode) {
          document.body.removeChild(modalOverlay);
        }
        
        // Refresh the manage jobs view if we're on it
        if (activeView === 'manage-jobs') {
          const postedJobsList = document.getElementById("managePostedJobsList");
          if (postedJobsList) {
            postedJobsList.dataset.loaded = 'false'; // Force reload
            loadPostedJobs();
          }
          // Also refresh active jobs since job moved there
          const activeJobsList = document.getElementById("manageActiveJobsList");
          if (activeJobsList) {
            activeJobsList.dataset.loaded = 'false';
            loadActiveJobs();
          }
        } else {
          // Otherwise refresh profile jobs tab
          const jobsTab = document.querySelector('.profile-tab[data-tab="jobs"]');
          if (jobsTab) {
            jobsTab.click();
          }
        }
      } catch (error) {
        console.error("Error accepting offer:", error);
        showToast(error.message || "Error accepting offer. Please try again.");
      }
    }
    
    // Decline Offer helper
    async function declineOffer(offerId, jobId, modalOverlay) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/offers/${offerId}/decline`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to decline offer');
        }
        
        showToast("✅ Applicant declined and removed from view.");
        
        // Refresh the modal to remove the declined offer
        if (modalOverlay && jobId) {
          document.body.removeChild(modalOverlay);
          showViewJobModal(jobId, 'customer');
        }
        
        // Remove the offer from the modal
        const offerCard = document.querySelector(`[data-offer-id="${offerId}"]`)?.closest('div[style*="border: 1px solid"]');
        if (offerCard) {
          offerCard.style.transition = 'opacity 0.3s';
          offerCard.style.opacity = '0';
          setTimeout(() => {
            offerCard.remove();
            // If no more offers, show empty state
            const offersContainer = modalOverlay.querySelector('div[style*="flex: 1"]');
            if (offersContainer && offersContainer.querySelectorAll('div[style*="border: 1px solid"]').length === 0) {
              offersContainer.innerHTML = `
                <div style="text-align: center; padding: 3rem 1rem;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                  <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">No applicants</div>
                  <div style="color: var(--text-muted);">All applicants have been reviewed.</div>
                </div>
              `;
            }
          }, 300);
        }
      } catch (error) {
        console.error("Error declining offer:", error);
        showToast("Error declining offer. Please try again.");
      }
    }
    
    // Negotiate Price Modal
    async function showNegotiatePriceModal(offerId, jobId, parentModal) {
      const token = localStorage.getItem('hustl_token');
      
      // Fetch offer details
      let offer = null;
      try {
        const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        if (offersResponse.ok) {
          const offers = await offersResponse.json();
          offer = offers.find(o => o.id === offerId);
        }
      } catch (e) {
        console.error("Error fetching offer:", e);
      }
      
      const modalOverlay = document.createElement('div');
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      modalOverlay.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          max-width: 500px;
          width: 100%;
          padding: 2rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
        ">
          <button class="closeNegotiateModal" style="
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 1.25rem;
          ">×</button>
          
          <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💰 Negotiate Price</h3>
          
          <div style="margin-bottom: 1.5rem;">
            <label for="negotiatePriceInput" style="display: block; font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin-bottom: 0.75rem;">💰 Proposed Price ($)</label>
            <input type="number" id="negotiatePriceInput" placeholder="Enter your proposed price" step="0.01" min="0" value="${offer?.proposedAmount || ''}" style="width: 100%; padding: 1.75rem; border: 3px solid var(--primary); border-radius: 12px; font-size: 2rem; font-weight: 700; text-align: center; background: #f0fdf4; color: var(--text-main); min-height: 70px; box-sizing: border-box;">
            <div style="margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-muted); text-align: center;">Enter the amount you'd like to propose</div>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-primary submitNegotiateBtn" data-offer-id="${offerId}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Submit</button>
            <button class="btn btn-ghost cancelNegotiateBtn" style="flex: 1; padding: 0.75rem;">Cancel</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modalOverlay);
      
      modalOverlay.querySelector('.closeNegotiateModal')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.cancelNegotiateBtn')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.submitNegotiateBtn')?.addEventListener('click', async () => {
        const price = parseFloat(document.getElementById('negotiatePriceInput')?.value || 0);
        if (!price || price <= 0) {
          showToast("Please enter a valid price.");
          return;
        }
        
        try {
          const response = await fetch(`${API_BASE}/offers/${offerId}/negotiate`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ proposedAmount: price })
          });
          
          if (!response.ok) throw new Error('Failed to negotiate price');
          
          // Mark this offer as recently negotiated in localStorage
          const negotiationKey = `negotiated_${offerId}`;
          localStorage.setItem(negotiationKey, 'true');
          
          // Remove the flag after 1 hour (3600000 ms)
          setTimeout(() => {
            localStorage.removeItem(negotiationKey);
          }, 3600000);
          
          showToast("✅ Price negotiation sent to applicant!");
          document.body.removeChild(modalOverlay);
          // Refresh the parent modal
          if (parentModal) {
            const viewJobModal = document.getElementById('viewJobModal');
            if (viewJobModal) {
              showViewJobModal(jobId, 'customer');
            }
          }
        } catch (error) {
          console.error("Error negotiating price:", error);
          showToast("Error negotiating price. Please try again.");
        }
      });
      
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
        }
      });
    }
    
    // Show Payment Modal with embedded Stripe Payment Element
    async function showPaymentModal(offerId, jobId, parentModal) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        // Get Stripe publishable key
        const configRes = await fetch(`${API_BASE}/payments/config`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!configRes.ok) {
          throw new Error('Failed to get Stripe configuration');
        }
        const { publishableKey } = await configRes.json();
        
        // Check if Stripe.js is loaded
        if (typeof Stripe === 'undefined') {
          // Load Stripe.js if not loaded
          const script = document.createElement('script');
          script.src = 'https://js.stripe.com/v3/';
          script.onload = () => {
            initializePaymentModal(publishableKey, offerId, jobId, parentModal, token);
          };
          document.head.appendChild(script);
        } else {
          await initializePaymentModal(publishableKey, offerId, jobId, parentModal, token);
        }
      } catch (error) {
        console.error("Error showing payment modal:", error);
        showToast(error.message || "Failed to load payment form. Please try again.");
      }
    }
    
    async function initializePaymentModal(publishableKey, offerId, jobId, parentModal, token) {
      try {
        // Check if we're in test mode (no Stripe key or SKIP_STRIPE_CHECK)
        const isTestMode = !publishableKey || publishableKey.includes('test') || publishableKey.length < 10;
        
        // Create payment intent
        const intentRes = await fetch(`${API_BASE}/payments/create-intent/offer/${offerId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!intentRes.ok) {
          const error = await intentRes.json().catch(() => ({}));
          throw new Error(error.message || error.error || 'Failed to create payment');
        }
        
        const { clientSecret, paymentIntentId, isTestMode: backendTestMode } = await intentRes.json();
        const useTestMode = isTestMode || backendTestMode || !clientSecret || clientSecret.includes('test');
        
        // Create payment modal
        const paymentModal = document.createElement('div');
        paymentModal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          z-index: 10002;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
        `;
        
        paymentModal.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
          ">
            <button class="closePaymentModal" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: #f3f4f6;
              cursor: pointer;
              font-size: 1.5rem;
              z-index: 10;
            ">×</button>
            
            <div style="padding: 2rem;">
              <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">💳 Complete Payment</h3>
              ${useTestMode ? `
              <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px;">
                <div style="font-weight: 700; color: #92400e; margin-bottom: 0.5rem;">🧪 TEST MODE</div>
                <div style="color: #78350f; font-size: 0.9rem; line-height: 1.6;">
                  This is a test payment. Click "Simulate Payment" below to see how the payment flow works without actually processing a payment.
                </div>
              </div>
              <div id="payment-element" style="margin-bottom: 1.5rem; padding: 2rem; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 12px; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">💳</div>
                <div style="font-weight: 700; color: var(--text-main); margin-bottom: 0.5rem;">Stripe Payment Form</div>
                <div style="color: var(--text-muted); font-size: 0.9rem;">In production, this would show the Stripe payment form with card, Apple Pay, and Google Pay options.</div>
              </div>
              ` : `
              <div style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">
                Secure payment powered by Stripe. Supports card, Apple Pay, and Google Pay.
              </div>
              <div id="payment-element" style="margin-bottom: 1.5rem;">
                <!-- Stripe Payment Element will be inserted here -->
              </div>
              `}
              
              <button id="submit-payment" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 600;">
                ${useTestMode ? '✅ Simulate Payment' : 'Pay Now'}
              </button>
              
              <div id="payment-error" style="margin-top: 1rem; color: #dc2626; font-size: 0.9rem; display: none;"></div>
            </div>
          </div>
        `;
        
        document.body.appendChild(paymentModal);
        
        // Close button
        paymentModal.querySelector('.closePaymentModal')?.addEventListener('click', () => {
          document.body.removeChild(paymentModal);
        });
        
        paymentModal.addEventListener('click', (e) => {
          if (e.target === paymentModal) {
            document.body.removeChild(paymentModal);
          }
        });
        
        // Initialize Payment Element (only if not in test mode)
        let elements, paymentElement;
        if (!useTestMode && publishableKey && typeof Stripe !== 'undefined') {
          const stripe = Stripe(publishableKey);
          elements = stripe.elements({ clientSecret });
          paymentElement = elements.create('payment', {
            layout: 'tabs'
          });
          paymentElement.mount('#payment-element');
        }
        
        // Handle form submission
        const submitButton = paymentModal.querySelector('#submit-payment');
        const errorDiv = paymentModal.querySelector('#payment-error');
        let isProcessing = false;
        
        submitButton.addEventListener('click', async (e) => {
          e.preventDefault();
          if (isProcessing) return;
          
          isProcessing = true;
          submitButton.disabled = true;
          submitButton.textContent = useTestMode ? 'Simulating...' : 'Processing...';
          errorDiv.style.display = 'none';
          
          try {
            if (useTestMode) {
              // Test mode - simulate payment with a delay
              await new Promise(resolve => setTimeout(resolve, 1500));
              
              // Confirm payment on backend (will use test mode)
              submitButton.textContent = 'Processing payment...';
            } else {
              // Real payment - confirm with Stripe
              const { error: confirmError } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                  return_url: `${window.location.origin}${window.location.pathname}?payment=success&offerId=${offerId}&jobId=${jobId}`,
                },
                redirect: 'if_required'
              });
              
              if (confirmError) {
                errorDiv.textContent = confirmError.message || 'Payment failed. Please try again.';
                errorDiv.style.display = 'block';
                submitButton.disabled = false;
                submitButton.textContent = 'Pay Now';
                isProcessing = false;
                return;
              }
              
              submitButton.textContent = 'Processing payment...';
            }
            
            // Confirm payment on backend
            const confirmRes = await fetch(`${API_BASE}/payments/confirm-payment`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ paymentIntentId, offerId })
            });
            
            if (!confirmRes.ok) {
              const errorData = await confirmRes.json().catch(() => ({}));
              const errorMessage = errorData.message || errorData.error || 'Failed to confirm payment';
              console.error('[PAYMENT] Confirm payment error:', errorData);
              throw new Error(errorMessage);
            }
            
            const confirmData = await confirmRes.json();
            console.log('[PAYMENT] Payment confirmed successfully:', confirmData);
            
            showToast("✅ Payment successful! Hustler accepted.");
            
            // Close modals
            document.body.removeChild(paymentModal);
            if (parentModal && parentModal.parentNode) {
              document.body.removeChild(parentModal);
            }
            
            // Refresh job lists
            if (activeView === 'manage-jobs') {
              loadPostedJobs();
              loadActiveJobs();
            }
          } catch (error) {
            console.error("Payment error:", error);
            errorDiv.textContent = error.message || 'Payment failed. Please try again.';
            errorDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = useTestMode ? '✅ Simulate Payment' : 'Pay Now';
            isProcessing = false;
          }
        });
      } catch (error) {
        console.error("Error initializing payment modal:", error);
        showToast(error.message || "Failed to load payment form. Please try again.");
      }
    }
    
    // Repost Job
    async function repostJob(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/repost`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Failed to repost job');
        
        showToast("✅ Job reposted! It's now visible to hustlers again.");
      } catch (error) {
        console.error("Error reposting job:", error);
        showToast("Error reposting job. Please try again.");
      }
    }
    
    // Cancel Job (or update keep open setting)
    async function cancelJob(jobId, keepOpenUntilAccepted = false, justUpdatingSetting = false) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/jobs/${jobId}/cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ keepOpenUntilAccepted, justUpdatingSetting })
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to update job');
        }
        
        if (justUpdatingSetting) {
          showToast(`✅ Setting saved! ${keepOpenUntilAccepted ? 'Job will stay open until you accept a hustler.' : 'Setting removed. You can manually cancel the job.'}`);
          // Refresh the modal to show updated state
          if (activeView === 'manage-jobs') {
            const modal = document.getElementById('viewJobModal');
            if (modal && modal.querySelector(`[data-job-id="${jobId}"]`)) {
              document.body.removeChild(modal);
              showViewJobModal(jobId, 'customer');
            }
          }
        } else if (keepOpenUntilAccepted) {
          showToast("✅ Job settings updated. Job will close automatically when you assign a hustler.");
        } else {
          showToast("✅ Job cancelled. It will no longer accept new applicants.");
        }
        // Refresh the list
        loadPostedJobs();
      } catch (error) {
        console.error("Error updating job:", error);
        showToast(error.message || "Error updating job. Please try again.");
      }
    }
    
    // Apply to Job (Hustler)
    async function applyToJob(jobId, note, proposedPrice) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/offers`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            jobId: jobId,
            note: note || null,
            proposedAmount: proposedPrice || null
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to apply to job');
        }
        
        // Show success confirmation modal
        const successOverlay = document.createElement("div");
        successOverlay.className = "modal-overlay";
        successOverlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
        
        const successModal = document.createElement("div");
        successModal.style.cssText = "background: white; border-radius: 16px; max-width: 500px; width: 100%; padding: 2rem; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);";
        
        successModal.innerHTML = `
          <div style="font-size: 4rem; margin-bottom: 1rem;">✅</div>
          <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">Application Sent!</h2>
          <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
            You've successfully applied to this job.<br>
            The customer will review your proposal and respond soon.
          </p>
          <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem;">
            You can manage this application in:<br>
            <strong style="color: var(--text-main);">Manage → Applied Jobs</strong>
          </p>
          <button class="btn btn-primary" id="gotItBtn3" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 12px;">
            Got it
          </button>
        `;
        
        successOverlay.appendChild(successModal);
        document.body.appendChild(successOverlay);
        
        // Handle "Got it" button
        successOverlay.querySelector('#gotItBtn3').addEventListener('click', () => {
          document.body.removeChild(successOverlay);
          setView('manage');
          setTimeout(() => {
            const appliedTab = document.getElementById('appliedJobsTab');
            if (appliedTab) {
              appliedTab.click();
              if (typeof loadAppliedJobs === 'function') {
                loadAppliedJobs();
              }
            }
          }, 100);
        });
        
        successOverlay.addEventListener('click', (e) => {
          if (e.target === successOverlay) {
            document.body.removeChild(successOverlay);
            setView('manage');
            setTimeout(() => {
              const appliedTab = document.getElementById('appliedJobsTab');
              if (appliedTab) {
                appliedTab.click();
                if (typeof loadAppliedJobs === 'function') {
                  loadAppliedJobs();
                }
              }
            }, 100);
          }
        });
        
        // Refresh the jobs list if we're on the jobs view
        if (typeof renderJobs === 'function') {
          renderJobs(true);
        }
      } catch (error) {
        console.error("Error applying to job:", error);
        showToast(error.message || "Error applying to job. Please try again.");
      }
    }
    
    // Cancel Application (Hustler) - For accepted hustlers to cancel after being assigned
    async function cancelApplication(offerIdOrJobId, isOfferId = false) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        let offerId = offerIdOrJobId;
        
        // If jobId was passed, find the offer
        if (!isOfferId) {
          const jobId = offerIdOrJobId;
          // First find the offer for this job
          const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!offersResponse.ok) throw new Error('Failed to fetch offers');
          const offers = await offersResponse.json();
          const user = await window.hustlAPI.auth.getCurrentUser();
          const myOffer = offers.find(o => o.hustlerId === user.id && o.status === 'ACCEPTED');
          
          if (!myOffer) {
            showToast("No active application found for this job.");
            return;
          }
          
          offerId = myOffer.id;
        }
        
        // Use the new hustler-cancel endpoint
        const response = await fetch(`${API_BASE}/offers/${offerId}/hustler-cancel`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to cancel application');
        }
        
        const result = await response.json();
        showToast("✅ You have cancelled this job. The customer has been notified and the job is now open for other applicants.");
        
        // Refresh the view
        if (activeView === 'manage-jobs') {
          loadActiveJobs();
        }
      } catch (error) {
        console.error("Error cancelling application:", error);
        showToast(error.message || "Error cancelling application. Please try again.");
      }
    }
    
    // Show Applicant Profile Modal
    async function showApplicantProfileModal(userId) {
      try {
        const token = localStorage.getItem('hustl_token');
        if (!token) {
          showToast('Please log in to view profiles');
          return;
        }
        
        console.log("🔵 Fetching user profile for applicant ID:", userId);
        console.log("🔵 API URL:", `${API_BASE}/users/${userId}`);
        const response = await fetch(`${API_BASE}/users/${userId}`, {
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Failed to fetch user profile:', response.status, errorText);
          showToast(`Failed to load profile: ${response.status === 401 ? 'Please log in' : response.status === 404 ? 'User not found' : 'Error'}`);
          return;
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          console.error('Response is not JSON:', contentType);
          showToast('Invalid response format');
          return;
        }
        
        const user = await response.json();
        console.log("✅ Fetched user profile:", user);
        
        // Fetch user's jobs and reviews
        const jobsResponse = await fetch(`${API_BASE}/jobs/my-jobs`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const allJobs = jobsResponse.ok ? await jobsResponse.json() : [];
        const userJobs = allJobs.filter(j => j.hustlerId === user.id && j.status === 'PAID');
        console.log("✅ User jobs:", userJobs.length);
        
        const reviewsResponse = await fetch(`${API_BASE}/reviews?userId=${userId}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        const reviews = reviewsResponse.ok ? await reviewsResponse.json() : [];
        console.log("✅ User reviews:", reviews.length);
        
        const modalOverlay = document.createElement('div');
        modalOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 10001;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 1rem;
          overflow-y: auto;
        `;
        
        modalOverlay.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
          ">
            <button class="closeProfileModal" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: #f3f4f6;
              cursor: pointer;
              font-size: 1.25rem;
              z-index: 1;
            ">×</button>
            
            <div style="padding: 2rem;">
              <!-- Profile Header -->
              <div style="text-align: center; margin-bottom: 2rem;">
                ${user.photoUrl ? `<img src="${user.photoUrl}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem;">` : `<div style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary-soft); display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary); font-size: 2.5rem; margin: 0 auto 1rem;">${(user.name || 'U')[0].toUpperCase()}</div>`}
                <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main);">${user.name || 'Unknown'}</h2>
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.25rem;">${'⭐'.repeat(Math.floor(user.ratingAvg || 0))}</span>
                  <span style="font-weight: 600; color: var(--text-main);">${(user.ratingAvg || 0).toFixed(1)}</span>
                  <span style="color: var(--text-muted); font-size: 0.9rem;">(${user.ratingCount || 0} ${(user.ratingCount || 0) === 1 ? 'review' : 'reviews'})</span>
                </div>
                ${user.city || user.zip ? `<div style="color: var(--text-muted); font-size: 0.9rem;">📍 ${user.city || ''} ${user.zip || ''}</div>` : ''}
                ${user.gender ? `<div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem;">${user.gender === 'male' ? '👨' : user.gender === 'female' ? '👩' : '👤'} ${user.gender.charAt(0).toUpperCase() + user.gender.slice(1)}</div>` : ''}
              </div>
              
              <!-- Bio -->
              ${user.bio ? `
              <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 12px;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">📝 Bio</h3>
                <div style="color: var(--text-main); line-height: 1.6;">${user.bio}</div>
              </div>
              ` : ''}
              
              <!-- Tools -->
              ${user.tools && (typeof user.tools === 'string' ? user.tools.trim() : (Array.isArray(user.tools) ? user.tools.length > 0 : false)) ? `
              <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">🛠 Tools They Have</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                  ${typeof user.tools === 'string' 
                    ? user.tools.split(',').filter(t => t.trim()).map(tool => `<span style="padding: 0.5rem 1rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">${tool.trim()}</span>`).join('')
                    : Array.isArray(user.tools) 
                      ? user.tools.map(tool => `<span style="padding: 0.5rem 1rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">${tool}</span>`).join('')
                      : `<span style="padding: 0.5rem 1rem; background: var(--primary-soft); color: var(--primary); border-radius: 6px; font-size: 0.9rem; font-weight: 600;">${user.tools}</span>`
                  }
                </div>
              </div>
              ` : ''}
              
              <!-- Job History -->
              <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">💼 Job History</h3>
                <div style="padding: 1rem; background: #f9fafb; border-radius: 8px;">
                  <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${userJobs.length}</div>
                  <div style="color: var(--text-muted); font-size: 0.9rem;">Completed jobs</div>
                </div>
              </div>
              
              <!-- Reviews -->
              ${reviews.length > 0 ? `
              <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.1rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text-main);">⭐ Reviews</h3>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  ${reviews.slice(0, 5).map(review => `
                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid var(--border);">
                      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span>${'⭐'.repeat(review.stars || 0)}</span>
                        <span style="font-weight: 600; color: var(--text-main);">${(review.stars || 0)}/5</span>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">${new Date(review.createdAt).toLocaleDateString()}</span>
                        ${review.reviewer ? `<span style="color: var(--text-muted); font-size: 0.85rem; margin-left: auto;">- ${review.reviewer.name || 'Anonymous'}</span>` : ''}
                      </div>
                      ${review.text ? `<div style="color: var(--text-main); line-height: 1.5;">${review.text}</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        document.body.appendChild(modalOverlay);
        
        modalOverlay.querySelector('.closeProfileModal')?.addEventListener('click', () => {
          document.body.removeChild(modalOverlay);
        });
        
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) {
            document.body.removeChild(modalOverlay);
          }
        });
      } catch (error) {
        console.error("Error showing applicant profile:", error);
        showToast("Error loading profile. Please try again.");
      }
    }
    
    // Show Rate Worker Modal
    async function showRateWorkerModal(userId, jobId) {
      const modalOverlay = document.createElement('div');
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      let selectedRating = 0;
      
      modalOverlay.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          max-width: 500px;
          width: 100%;
          padding: 2rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          position: relative;
        ">
          <button class="closeRateModal" style="
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            font-size: 1.25rem;
          ">×</button>
          
          <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">⭐ Rate Worker</h3>
          
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Rating</div>
            <div id="ratingStars" style="display: flex; gap: 0.5rem; font-size: 2rem; cursor: pointer;">
              ${[1,2,3,4,5].map(i => `<span class="ratingStar" data-rating="${i}" style="color: #d1d5db; transition: color 0.2s;">⭐</span>`).join('')}
            </div>
            <div id="ratingText" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);">Select a rating</div>
          </div>
          
          <div style="margin-bottom: 1.5rem;">
            <label style="display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem;">Review (optional)</label>
            <textarea id="reviewCommentInput" placeholder="Share your experience..." style="width: 100%; min-height: 100px; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
          </div>
          
          <div style="display: flex; gap: 0.75rem;">
            <button class="btn btn-primary submitRatingBtn" data-user-id="${userId}" data-job-id="${jobId}" style="flex: 1; padding: 0.75rem; font-weight: 600;">Submit Rating</button>
            <button class="btn btn-ghost cancelRatingBtn" style="flex: 1; padding: 0.75rem;">Cancel</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modalOverlay);
      
      // Rating stars interaction
      const stars = modalOverlay.querySelectorAll('.ratingStar');
      const ratingText = modalOverlay.querySelector('#ratingText');
      const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
      };
      
      stars.forEach(star => {
        star.addEventListener('mouseenter', (e) => {
          const rating = parseInt(e.target.dataset.rating);
          stars.forEach((s, i) => {
            if (i < rating) {
              s.style.color = '#fbbf24';
            } else {
              s.style.color = '#d1d5db';
            }
          });
          ratingText.textContent = ratingTexts[rating] || '';
        });
        
        star.addEventListener('click', (e) => {
          selectedRating = parseInt(e.target.dataset.rating);
          stars.forEach((s, i) => {
            if (i < selectedRating) {
              s.style.color = '#fbbf24';
            } else {
              s.style.color = '#d1d5db';
            }
          });
          ratingText.textContent = ratingTexts[selectedRating] || '';
        });
      });
      
      modalOverlay.querySelector('#ratingStars').addEventListener('mouseleave', () => {
        if (selectedRating === 0) {
          stars.forEach(s => s.style.color = '#d1d5db');
          ratingText.textContent = 'Select a rating';
        } else {
          stars.forEach((s, i) => {
            if (i < selectedRating) {
              s.style.color = '#fbbf24';
            } else {
              s.style.color = '#d1d5db';
            }
          });
        }
      });
      
      modalOverlay.querySelector('.closeRateModal')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.cancelRatingBtn')?.addEventListener('click', () => {
        document.body.removeChild(modalOverlay);
      });
      
      modalOverlay.querySelector('.submitRatingBtn')?.addEventListener('click', async () => {
        if (selectedRating === 0) {
          showToast("Please select a rating.");
          return;
        }
        
        const comment = document.getElementById('reviewCommentInput')?.value.trim() || null;
        
        try {
          const token = localStorage.getItem('hustl_token');
          const response = await fetch(`${API_BASE}/reviews`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              jobId: jobId,
              revieweeId: userId,
              rating: selectedRating,
              comment: comment
            })
          });
          
          if (!response.ok) throw new Error('Failed to submit rating');
          
          showToast("✅ Rating submitted! Thank you for your feedback.");
          document.body.removeChild(modalOverlay);
          loadCompletedJobs();
        } catch (error) {
          console.error("Error submitting rating:", error);
          showToast("Error submitting rating. Please try again.");
        }
      });
      
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          document.body.removeChild(modalOverlay);
        }
      });
    }
    
    // Show Job Completion Flow: Congratulations → Forced Review
    async function showJobCompletionFlow(jobId, customerId, hustlerId) {
      const user = await window.hustlAPI.auth.getCurrentUser();
      if (!user) return;
      
      const isCustomer = user.id === customerId;
      const isHustler = user.id === hustlerId;
      const otherUserId = isCustomer ? hustlerId : customerId;
      
      // Step 1: Show Congratulations Modal
      const congratsModal = document.createElement('div');
      congratsModal.id = 'jobCompletionCongrats';
      congratsModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10002;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      congratsModal.innerHTML = `
        <div style="
          background: white;
          border-radius: 24px;
          max-width: 600px;
          width: 100%;
          padding: 3rem 2rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          text-align: center;
        ">
          <div style="font-size: 5rem; margin-bottom: 1rem;">🎉</div>
          <h2 style="font-size: 2rem; font-weight: 700; margin: 0 0 1rem 0; color: var(--text-main);">
            Job Completed Successfully!
          </h2>
          <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; line-height: 1.6;">
            Great work! Please take a moment to leave a review for ${isCustomer ? 'your hustler' : 'your customer'}.
          </p>
          <button class="btn btn-primary continueToReviewBtn" style="
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            width: 100%;
            max-width: 300px;
          ">Continue to Review →</button>
        </div>
      `;
      
      document.body.appendChild(congratsModal);
      
      // Continue button - show review modal
      congratsModal.querySelector('.continueToReviewBtn')?.addEventListener('click', () => {
        document.body.removeChild(congratsModal);
        showForcedReviewModal(jobId, otherUserId, isCustomer);
      });
    }
    
    // Show Forced Review Modal (no cancel, must submit)
    async function showForcedReviewModal(jobId, revieweeId, isCustomer) {
      // Fetch reviewee info
      const token = localStorage.getItem('hustl_token');
      let revieweeName = 'the other party';
      try {
        const userResponse = await fetch(`${API_BASE}/users/${revieweeId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (userResponse.ok) {
          const userData = await userResponse.json();
          revieweeName = userData.name || revieweeName;
        }
      } catch (e) {
        console.error("Error fetching reviewee:", e);
      }
      
      const modalOverlay = document.createElement('div');
      modalOverlay.id = 'forcedReviewModal';
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10003;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      `;
      
      let selectedRating = 0;
      
      modalOverlay.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          max-width: 600px;
          width: 100%;
          padding: 2.5rem;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          position: relative;
        ">
          <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem 0; color: var(--text-main); text-align: center;">
            ⭐ Rate ${revieweeName}
          </h2>
          <p style="font-size: 0.95rem; color: var(--text-muted); margin-bottom: 2rem; text-align: center;">
            Your feedback helps build trust in our community
          </p>
          
          <div style="margin-bottom: 2rem;">
            <div style="font-size: 1rem; font-weight: 600; color: var(--text-main); margin-bottom: 1rem; text-align: center;">Rating *</div>
            <div id="ratingStars" style="display: flex; gap: 0.75rem; font-size: 3rem; cursor: pointer; justify-content: center;">
              ${[1,2,3,4,5].map(i => `<span class="ratingStar" data-rating="${i}" style="color: #d1d5db; transition: all 0.2s; user-select: none;">⭐</span>`).join('')}
            </div>
            <div id="ratingText" style="margin-top: 0.75rem; font-size: 1rem; color: var(--text-muted); text-align: center; min-height: 1.5rem;">Select a rating</div>
          </div>
          
          <div style="margin-bottom: 2rem;">
            <label style="display: block; font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 0.75rem;">Review (optional)</label>
            <textarea id="reviewCommentInput" placeholder="Share your experience... (minimum 10 characters)" style="width: 100%; min-height: 120px; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; resize: vertical;"></textarea>
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">Optional: Tell others about your experience</div>
          </div>
          
          <button class="btn btn-primary submitForcedReviewBtn" data-reviewee-id="${revieweeId}" data-job-id="${jobId}" style="
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--primary);
          ">Submit Review</button>
        </div>
      `;
      
      document.body.appendChild(modalOverlay);
      
      // Rating stars interaction
      const stars = modalOverlay.querySelectorAll('.ratingStar');
      const ratingText = modalOverlay.querySelector('#ratingText');
      const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
      };
      
      stars.forEach(star => {
        star.addEventListener('mouseenter', (e) => {
          const rating = parseInt(e.target.dataset.rating);
          stars.forEach((s, i) => {
            if (i < rating) {
              s.style.color = '#fbbf24';
              s.style.transform = 'scale(1.1)';
            } else {
              s.style.color = '#d1d5db';
              s.style.transform = 'scale(1)';
            }
          });
          ratingText.textContent = ratingTexts[rating] || '';
        });
        
        star.addEventListener('click', (e) => {
          selectedRating = parseInt(e.target.dataset.rating);
          stars.forEach((s, i) => {
            if (i < selectedRating) {
              s.style.color = '#fbbf24';
              s.style.transform = 'scale(1.1)';
            } else {
              s.style.color = '#d1d5db';
              s.style.transform = 'scale(1)';
            }
          });
          ratingText.textContent = ratingTexts[selectedRating] || '';
        });
      });
      
      modalOverlay.querySelector('#ratingStars').addEventListener('mouseleave', () => {
        if (selectedRating === 0) {
          stars.forEach(s => {
            s.style.color = '#d1d5db';
            s.style.transform = 'scale(1)';
          });
          ratingText.textContent = 'Select a rating';
        } else {
          stars.forEach((s, i) => {
            if (i < selectedRating) {
              s.style.color = '#fbbf24';
              s.style.transform = 'scale(1.1)';
            } else {
              s.style.color = '#d1d5db';
              s.style.transform = 'scale(1)';
            }
          });
        }
      });
      
      // Submit review (required)
      modalOverlay.querySelector('.submitForcedReviewBtn')?.addEventListener('click', async () => {
        if (selectedRating === 0) {
          showToast("Please select a rating before submitting.");
          return;
        }
        
        const comment = document.getElementById('reviewCommentInput')?.value.trim() || '';
        
        // Validate comment length if provided (API requires min 10 chars)
        if (comment && comment.length < 10) {
          showToast("Review must be at least 10 characters if provided.");
          return;
        }
        
        // Use default text if no comment provided (API requires text field)
        const reviewText = comment.length >= 10 ? comment : 'Great job!';
        
        const btn = modalOverlay.querySelector('.submitForcedReviewBtn');
        btn.disabled = true;
        btn.textContent = "Submitting...";
        
        try {
          const token = localStorage.getItem('hustl_token');
          const response = await fetch(`${API_BASE}/reviews`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              jobId: jobId,
              revieweeId: revieweeId,
              stars: selectedRating,
              text: reviewText
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'Failed to submit review');
          }
          
          showToast("✅ Review submitted! Thank you for your feedback.");
          document.body.removeChild(modalOverlay);
          
          // Refresh jobs
          if (typeof loadActiveJobs === 'function') loadActiveJobs();
          if (typeof loadCompletedJobs === 'function') loadCompletedJobs();
          
          // Navigate to completed jobs
          if (typeof setView === 'function') {
            setView('manage-jobs');
            setTimeout(() => {
              const completedTab = document.querySelector('[data-status="done"]');
              if (completedTab) completedTab.click();
            }, 300);
          }
        } catch (error) {
          console.error("Error submitting review:", error);
          showToast("Error: " + (error.message || "Failed to submit review. Please try again."));
          btn.disabled = false;
          btn.textContent = "Submit Review";
        }
      });
      
      // Prevent closing by clicking outside
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
          // Don't allow closing - review is required
          showToast("Please submit a review to continue.");
        }
      });
    }
    
    // Favorite Worker
    async function favoriteWorker(userId) {
      try {
        const token = localStorage.getItem('hustl_token');
        const response = await fetch(`${API_BASE}/users/${userId}/favorite`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          // Check if already favorited
          if (response.status === 409) {
            showToast("Worker already in favorites!");
            return;
          }
          throw new Error('Failed to favorite worker');
        }
        
        showToast("✅ Worker added to favorites!");
      } catch (error) {
        console.error("Error favoriting worker:", error);
        showToast("Error favoriting worker. Please try again.");
      }
    }
    
    // Unaccept Hustler (Customer can unaccept before start code exchanged)
    async function unacceptHustler(jobId) {
      try {
        const token = localStorage.getItem('hustl_token');
        
        // Fetch job to check if start code has been exchanged
        const jobResponse = await fetch(`${API_BASE}/jobs/${jobId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!jobResponse.ok) throw new Error('Failed to fetch job');
        const job = await jobResponse.json();
        
        if (job.startCodeVerified) {
          showToast("Cannot unaccept: Start code has already been exchanged.");
          return;
        }
        
        // Find the accepted offer
        const offersResponse = await fetch(`${API_BASE}/offers/${jobId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!offersResponse.ok) throw new Error('Failed to fetch offers');
        const offers = await offersResponse.json();
        const acceptedOffer = offers.find(o => o.status === 'ACCEPTED');
        
        if (!acceptedOffer) {
          showToast("No accepted offer found for this job.");
          return;
        }
        
        const response = await fetch(`${API_BASE}/offers/${acceptedOffer.id}/unaccept`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Failed to unaccept hustler');
        
        showToast("Hustler unaccepted. Job is now open for applicants again.");
        loadPostedJobs();
        loadActiveJobs();
      } catch (error) {
        console.error("Error unaccepting hustler:", error);
        showToast(error.message || "Error unaccepting hustler. Please try again.");
      }
    }

    /* ---------- Mode Toggle ---------- */
    
    function initModeToggle() {
      const customerBtn = document.getElementById("modeCustomerBtn");
      const hustlerBtn = document.getElementById("modeHustlerBtn");
      
      if (customerBtn) {
        customerBtn.addEventListener("click", () => {
          userMode = "customer";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
      
      if (hustlerBtn) {
        hustlerBtn.addEventListener("click", () => {
          userMode = "hustler";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
    }

    /* ---------- Init ---------- */

    function initNav() {
      const navContainer = document.querySelector(".nav-tabs");
      if (!navContainer) {
        console.log("Nav container not found, retrying in 50ms...");
        setTimeout(initNav, 50);
        return;
      }
      
      if (navContainer.dataset.listenerAttached) {
        console.log("Nav listener already attached");
        return;
      }
      navContainer.dataset.listenerAttached = 'true';
      console.log("✅ Nav listener attached");
      
      navContainer.addEventListener("click", async (e) => {
        const tab = e.target.closest(".nav-tab");
        if (!tab) return;
        e.preventDefault();
        e.stopPropagation();
        const v = tab.dataset.view;
        console.log("Nav tab clicked:", v);
        if (v) {
          // Try to call setView - if it's the stub, use fallback
          if (window.setView && typeof window.setView === 'function') {
            // Check if it's the real function (not the stub)
            // Real setView is async, stub is not. Also check for 'not ready yet' string
            const funcStr = window.setView.toString();
            const isAsync = funcStr.includes('async') || window.setView.constructor.name === 'AsyncFunction';
            const isStub = funcStr.includes('not ready yet');
            
            if (isAsync && !isStub) {
              console.log("✅ Calling real window.setView with:", v);
              try {
                await window.setView(v);
                return; // Success - exit early
              } catch (error) {
                console.error("Error calling setView:", error);
                // Fall through to fallback
              }
            } else {
              console.log("⚠️ setView is stub (isAsync:", isAsync, "isStub:", isStub, "), using fallback");
            }
          }
          
          // Fallback: manual view switching
          console.log("Using fallback view switching for:", v);
          // CRITICAL: Set activeView so renderAll knows which view to render
          activeView = v;
          window.activeView = v;
          document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
          const target = document.getElementById("view-" + v);
          if (target) {
            target.style.display = "block";
          } else {
            console.error("View target not found:", "view-" + v);
          }
          document.querySelectorAll(".nav-tab").forEach((t) => t.classList.toggle("active", t.dataset.view === v));
          window.scrollTo({ top: 0, behavior: 'instant' });
          // IMPORTANT: Also call renderAll to actually render the content
          setTimeout(async () => {
            try {
              // Ensure activeView is set before calling renderAll
              activeView = v;
              window.activeView = v;
              console.log("🔵 Calling renderAll with activeView:", window.activeView);
              if (typeof window.renderAll === 'function') {
                await window.renderAll();
              } else if (typeof renderAll === 'function') {
                await renderAll();
              } else {
                console.error("❌ renderAll function not found!");
              }
            } catch (error) {
              console.error("Error in fallback render:", error);
            }
          }, 100);
        }
      });
      
      // Home CTA buttons
      const homeCtaPost = document.getElementById("homeCtaPost");
      if (homeCtaPost && !homeCtaPost.dataset.listenerAttached) {
        homeCtaPost.dataset.listenerAttached = 'true';
        console.log("✅ CTA Post button listener attached");
        homeCtaPost.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("CTA Post button clicked");
          if (window.setView && typeof window.setView === 'function') {
            const funcStr = window.setView.toString();
            if (!funcStr.includes('not ready yet')) {
              window.setView("post");
              setTimeout(() => {
                const formCard = document.getElementById("jobFormCard");
                if (formCard) {
                  formCard.scrollIntoView({ behavior: "smooth" });
                }
              }, 100);
            } else {
              console.warn("setView is stub, using fallback");
              document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
              const target = document.getElementById("view-post");
              if (target) target.style.display = "block";
              window.scrollTo({ top: 0, behavior: 'instant' });
            }
          } else {
            console.warn("setView not available, using fallback");
            document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
            const target = document.getElementById("view-post");
            if (target) target.style.display = "block";
            window.scrollTo({ top: 0, behavior: 'instant' });
          }
        });
      }
      
      const homeCtaBrowse = document.getElementById("homeCtaBrowse");
      if (homeCtaBrowse && !homeCtaBrowse.dataset.listenerAttached) {
        homeCtaBrowse.dataset.listenerAttached = 'true';
        console.log("✅ CTA Browse button listener attached");
        homeCtaBrowse.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("CTA Browse button clicked");
          if (window.setView && typeof window.setView === 'function') {
            const funcStr = window.setView.toString();
            if (!funcStr.includes('not ready yet')) {
              window.setView("jobs");
            } else {
              console.warn("setView is stub, using fallback");
              document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
              const target = document.getElementById("view-jobs");
              if (target) target.style.display = "block";
              window.scrollTo({ top: 0, behavior: 'instant' });
            }
          } else {
            console.warn("setView not available, using fallback");
            document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
            const target = document.getElementById("view-jobs");
            if (target) target.style.display = "block";
            window.scrollTo({ top: 0, behavior: 'instant' });
          }
        });
      }
      
      // Jobs status filter with improved highlighting
      const jobsStatusFilter = document.getElementById("jobsStatusFilter");
      if (jobsStatusFilter) {
        const updateStatusTabStyles = () => {
          jobsStatusFilter.querySelectorAll(".job-status-tab").forEach((el) => {
            if (el.dataset.status === activeJobsStatusFilter) {
              el.classList.add("active");
              el.style.background = "var(--primary)";
              el.style.color = "white";
              el.style.fontWeight = "600";
              el.style.border = "2px solid var(--primary)";
            } else {
              el.classList.remove("active");
              el.style.background = "white";
              el.style.color = "var(--text-main)";
              el.style.fontWeight = "normal";
              el.style.border = "2px solid var(--border)";
            }
          });
        };
        
        updateStatusTabStyles();
        
        jobsStatusFilter.querySelectorAll(".job-status-tab").forEach((el) => {
          el.addEventListener("click", () => {
            activeJobsStatusFilter = el.dataset.status;
            updateStatusTabStyles();
            if (typeof renderJobs === 'function') {
              renderJobs(true); // Reset pagination when filter changes
            }
          });
        });
      }
      
      // Location filter handlers
      const locationZipFilter = document.getElementById("locationZipFilter");
      const locationRadiusFilter = document.getElementById("locationRadiusFilter");
      const radiusValueDisplay = document.getElementById("radiusValueDisplay");
      const clearLocationFilter = document.getElementById("clearLocationFilter");
      
      if (locationRadiusFilter && radiusValueDisplay) {
        locationRadiusFilter.addEventListener("input", (e) => {
          radiusValueDisplay.textContent = e.target.value + " mi";
        });
        radiusValueDisplay.textContent = locationRadiusFilter.value + " mi";
      }
      
      if (locationZipFilter) {
        locationZipFilter.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
        });
        locationZipFilter.addEventListener("change", () => {
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      }
      
      if (locationRadiusFilter) {
        locationRadiusFilter.addEventListener("change", () => {
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      }
      
      if (clearLocationFilter) {
        clearLocationFilter.addEventListener("click", () => {
          if (locationZipFilter) locationZipFilter.value = "";
          if (locationRadiusFilter) {
            locationRadiusFilter.value = "25";
            if (radiusValueDisplay) radiusValueDisplay.textContent = "25 mi";
          }
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      }
      
      // Category filter chips
      const categoryChipsContainer = document.getElementById("categoryFilterChips");
      if (categoryChipsContainer) {
        categoryChipsContainer.querySelectorAll(".filter-chip").forEach(chip => {
          chip.addEventListener("click", () => {
            // Update active state
            categoryChipsContainer.querySelectorAll(".filter-chip").forEach(c => {
              c.classList.remove("active");
              c.style.border = "1.5px solid var(--border)";
              c.style.background = "white";
              c.style.color = "var(--text-main)";
            });
            chip.classList.add("active");
            chip.style.border = "1.5px solid var(--primary)";
            chip.style.background = "var(--primary-soft)";
            chip.style.color = "var(--primary)";
            
            // Update filter and reload
            activeCategoryFilter = chip.dataset.category;
            if (typeof renderJobs === 'function') {
              renderJobs(true);
            }
          });
        });
      }
      
      // Sort dropdown
      const sortSelect = document.getElementById("jobsSortBy");
      if (sortSelect) {
        sortSelect.addEventListener("change", () => {
          activeSortBy = sortSelect.value;
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
        });
      }
      
      // Refresh button
      const refreshBtn = document.getElementById("refreshJobsBtn");
      if (refreshBtn) {
        refreshBtn.addEventListener("click", () => {
          if (typeof renderJobs === 'function') {
            renderJobs(true);
          }
          if (typeof showToast === 'function') {
            showToast("Jobs refreshed!");
          }
        });
      }
    }
    
    async function startPayment(jobId) {
  const job = state.jobs.find((j) => j.id === jobId);
  const user = getCurrentUser();

  if (!job || !user || user.id !== job.postedByUserId) {
    showToast("Only the customer who posted can pay for this job.");
    return;
  }

  if (!job.acceptedHustlerId) {
    showToast("Accept a Hustler before paying.");
    return;
  }

  // Calculate total
  let total = 0;
  if (job.paymentType === "flat") {
    total = job.flatAmount || 0;
  } else {
    total = (job.hourlyRate || 0) * (job.maxHours || 0);
  }

  if (total <= 0) {
    showToast("Job total must be greater than zero.");
    return;
  }

  // Stripe expects amount in cents
  const platformPercent = 0.12; // 12% cut
  const platformFee = Math.round(total * platformPercent);
  const amountToCharge = total * 100; // Convert to cents

try {
    const res = await fetch("http://localhost:8080/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amountTotalCents: amountToCharge,
        customerEmail: user.email,
        description: `Hustl job payment for: ${job.title}`,
      }),
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast("Failed to start Stripe Checkout session.");
    }
  } catch (err) {
    console.error("Payment error:", err);
    showToast("Error connecting to payment server.");
  }
}

  // ========== HAMBURGER MENU ==========
  function initHamburgerMenu() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (!hamburgerBtn || !mobileMenu) {
      // Retry if elements not ready
      setTimeout(initHamburgerMenu, 100);
      return;
    }
    
    // Remove old event listeners by cloning elements
    const newHamburgerBtn = hamburgerBtn.cloneNode(true);
    const newMobileMenu = mobileMenu.cloneNode(true);
    hamburgerBtn.parentNode.replaceChild(newHamburgerBtn, hamburgerBtn);
    mobileMenu.parentNode.replaceChild(newMobileMenu, mobileMenu);
    
    // Get fresh references after cloning
    const freshHamburgerBtn = document.getElementById('hamburgerBtn');
    const freshMobileMenu = document.getElementById('mobileMenu');
    
    if (!freshHamburgerBtn || !freshMobileMenu) {
      console.warn("Hamburger menu elements not found after cloning");
      return;
    }
    
    // Prevent double-click issues
    let isToggling = false;
    freshHamburgerBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (isToggling) return;
      isToggling = true;
      
      const isOpen = freshMobileMenu.classList.contains('open');
      
      if (isOpen) {
        // Closing menu
        freshHamburgerBtn.classList.remove('open');
        freshMobileMenu.classList.remove('open');
        document.body.classList.remove('mobile-menu-open');
        document.body.style.overflow = '';
      } else {
        // Opening menu
        freshHamburgerBtn.classList.add('open');
        freshMobileMenu.classList.add('open');
        document.body.classList.add('mobile-menu-open');
        document.body.style.overflow = 'hidden';
      }
      
      setTimeout(() => {
        isToggling = false;
      }, 300);
    });
    
    // Handle mobile menu item clicks using event delegation (works with dynamically added items)
    freshMobileMenu.addEventListener('click', (e) => {
        const item = e.target.closest('.mobile-menu-item');
        if (!item) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const view = item.dataset.view;
        const action = item.dataset.action;
        
        // Call window.setView
        if (view && window.setView && typeof window.setView === 'function') {
          const funcStr = window.setView.toString();
          if (!funcStr.includes('not ready yet')) {
            window.setView(view);
            
            // Handle special actions
            if (action === 'earnings') {
              setTimeout(() => {
                const earningsTab = document.querySelector('.profile-tab[data-tab="earnings"]');
                if (earningsTab) earningsTab.click();
              }, 100);
            }
          } else {
            // Fallback if setView is stub
            document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
            const target = document.getElementById("view-" + view);
            if (target) target.style.display = "block";
          }
        }
        
        // Close menu
        freshHamburgerBtn.classList.remove('open');
        freshMobileMenu.classList.remove('open');
        document.body.classList.remove('mobile-menu-open');
        document.body.style.overflow = '';
        
        // Update active state
        freshMobileMenu.querySelectorAll('.mobile-menu-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
      });
      
      // Mobile auth buttons - use event delegation for dynamically added buttons
      freshMobileMenu.addEventListener('click', (e) => {
        // Handle login button
        if (e.target.id === 'mobileLoginBtn' || e.target.closest('#mobileLoginBtn')) {
          e.preventDefault();
          e.stopPropagation();
          freshHamburgerBtn.classList.remove('open');
          freshMobileMenu.classList.remove('open');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
          if (typeof window.openAuthModal === 'function') {
            window.openAuthModal('login');
          }
        } 
        // Handle signup button
        else if (e.target.id === 'mobileSignupBtn' || e.target.closest('#mobileSignupBtn')) {
          e.preventDefault();
          e.stopPropagation();
          freshHamburgerBtn.classList.remove('open');
          freshMobileMenu.classList.remove('open');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
          if (typeof window.openAuthModal === 'function') {
            window.openAuthModal('create');
          }
        }
        // Handle sign out button - check for ID, data-action, or text content
        else if (e.target.id === 'mobileSignOutBtn' || 
                 e.target.closest('#mobileSignOutBtn') ||
                 e.target.dataset.action === 'signout' || 
                 e.target.closest('[data-action="signout"]')) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Mobile sign out button clicked');
          freshHamburgerBtn.classList.remove('open');
          freshMobileMenu.classList.remove('open');
          document.body.classList.remove('mobile-menu-open');
          document.body.style.overflow = '';
          // Call handleSignOut directly
          if (window.handleSignOut) {
            window.handleSignOut();
          } else {
            console.error('handleSignOut not available');
          }
        }
      });
    
    // Desktop auth buttons are now handled in updateHeaderAuth() to avoid duplicate listeners
  }
  
  // ========== AUTH MODAL ==========
  // Define and assign to window immediately
  window.openAuthModal = function openAuthModal(mode = 'create') {
    // Check if user is already logged in
    const user = getCurrentUser();
    if (user) {
      if (typeof window.setView === 'function') {
        window.setView('profile');
      }
      return;
    }
    
    // Switch to home view first, then show auth section
    if (typeof window.setView === 'function') {
      window.setView('home');
    }
    
    // Small delay to ensure home view is rendered
    setTimeout(() => {
      const authSection = document.getElementById('authSection');
      if (authSection) {
        authSection.style.display = 'block';
        authSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Toggle to correct mode
        const authTitle = document.getElementById("authCardTitle");
        const authBodyCreate = document.getElementById("authBodyCreate");
        const authBodyLogin = document.getElementById("authBodyLogin");
        
        if (mode === 'login') {
          if (authTitle) authTitle.textContent = "👋 Welcome Back";
          if (authBodyCreate) authBodyCreate.style.display = 'none';
          if (authBodyLogin) authBodyLogin.style.display = 'block';
        } else {
          if (authTitle) authTitle.textContent = "🚀 Join Hustl";
          if (authBodyCreate) authBodyCreate.style.display = 'block';
          if (authBodyLogin) authBodyLogin.style.display = 'none';
        }
      }
    }, 50);
  }
  // Expose openAuthModal globally immediately after definition
  window.openAuthModal = openAuthModal;
  
  // Define and assign closeAuthModal to window immediately
  window.closeAuthModal = function closeAuthModal() {
    const overlay = document.getElementById('authModalOverlay');
    if (overlay) {
      overlay.classList.remove('open');
      document.body.style.overflow = '';
    }
  };
  
  // Function is already assigned above, just log confirmation
  console.log('✅ closeAuthModal function assigned to window.closeAuthModal');
  
  // Update header when logged in/out - uses API to get current user
  async function updateHeaderAuth() {
    let user = null;
    try {
      user = await window.hustlAPI.auth.getCurrentUser();
    } catch (error) {
      console.error("Error getting current user:", error);
      user = null;
    }
    
    const desktopAuth = document.getElementById('headerAuthDesktop');
    const mobileAuth = document.querySelector('.mobile-menu .header-auth');
    
    // Add/remove logged-in class on body
    if (user) {
      document.body.classList.add('logged-in');
      // Show Manage Jobs tab when logged in
      const manageJobsTab = document.getElementById('manageJobsTab');
      if (manageJobsTab) manageJobsTab.style.display = 'block';
    } else {
      document.body.classList.remove('logged-in');
      // Hide Manage Jobs tab when logged out
      const manageJobsTab = document.getElementById('manageJobsTab');
      if (manageJobsTab) manageJobsTab.style.display = 'none';
    }
    
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (user) {
      // Logged in state - simplified header
      const firstName = user.name?.split(' ')[0] || user.email?.split('@')[0] || 'User';
      if (desktopAuth) {
        desktopAuth.innerHTML = `
          <span style="color: var(--text-main); font-size: 0.85rem; font-weight: 500; margin-right: 0.75rem;">👋 ${firstName}</span>
          <button class="btn-login-header" id="desktopProfileBtn" data-action="profile">Profile</button>
          <button class="btn-signup-header" id="desktopLogoutBtn" data-action="signout" style="background: #fee2e2; color: #dc2626; border-color: #fca5a5; cursor: pointer;">Logout</button>
        `;
        // Add event listeners for desktop buttons - use setTimeout to ensure DOM is ready
        setTimeout(() => {
          const desktopProfileBtn = document.getElementById('desktopProfileBtn');
          const desktopLogoutBtn = document.getElementById('desktopLogoutBtn');
          if (desktopProfileBtn) {
            desktopProfileBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Desktop profile button clicked');
              if (window.setView && typeof window.setView === 'function') {
                window.setView('profile');
              }
            });
          } else {
            console.warn('desktopProfileBtn not found');
          }
          if (desktopLogoutBtn) {
            desktopLogoutBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Desktop logout button clicked');
              // Call handleSignOut directly - it's always defined
              if (window.handleSignOut) {
                window.handleSignOut();
              } else {
                console.error('handleSignOut not available');
              }
            });
          } else {
            console.warn('desktopLogoutBtn not found');
          }
        }, 50);
      }
      // Update entire mobile menu for logged-in users
      if (mobileMenu) {
        mobileMenu.innerHTML = `
          <button class="mobile-menu-item active" data-view="home">🏠 Home</button>
          <button class="mobile-menu-item" data-view="jobs">💼 Browse Jobs</button>
          <button class="mobile-menu-item" data-view="post">➕ Post a Job</button>
          <button class="mobile-menu-item" data-view="manage-jobs">📋 Manage Jobs</button>
          <button class="mobile-menu-item" data-view="messages">💬 Messages</button>
          <button class="mobile-menu-item" data-view="profile">👤 Profile</button>
          <div class="header-auth" id="mobileMenuAuth">
            <div style="padding: 0.5rem; color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border);">👋 Signed in as ${firstName}</div>
            <button class="btn-signup-header" id="mobileSignOutBtn" data-action="signout" style="width:100%; margin-top: 0.5rem; padding: 1rem; background: #fee2e2 !important; color: #dc2626 !important; border: 2px solid #fca5a5 !important; font-weight: 600; font-size: 1rem; z-index: 1; position: relative; opacity: 1 !important; visibility: visible !important; display: block !important;">🚪 Sign Out</button>
          </div>
        `;
      }
    } else {
      // Logged out state - restore default buttons
      if (desktopAuth) {
        desktopAuth.innerHTML = `
          <button class="btn-login-header" id="headerLoginBtn">Log In</button>
          <button class="btn-signup-header" id="headerSignupBtn">Sign Up Free</button>
        `;
        // Add event listeners for desktop buttons - use setTimeout to ensure DOM is ready
        setTimeout(() => {
          const headerLoginBtn = document.getElementById('headerLoginBtn');
          const headerSignupBtn = document.getElementById('headerSignupBtn');
          if (headerLoginBtn) {
            headerLoginBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Header login button clicked');
              if (window.openAuthModal && typeof window.openAuthModal === 'function') {
                window.openAuthModal('login');
              }
            });
          } else {
            console.warn('headerLoginBtn not found');
          }
          if (headerSignupBtn) {
            headerSignupBtn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              console.log('Header signup button clicked');
              if (window.openAuthModal && typeof window.openAuthModal === 'function') {
                window.openAuthModal('create');
              }
            });
          } else {
            console.warn('headerSignupBtn not found');
          }
        }, 50);
      }
      // Update entire mobile menu for logged-out users
      if (mobileMenu) {
        mobileMenu.innerHTML = `
          <button class="mobile-menu-item active" data-view="home">🏠 Home</button>
          <button class="mobile-menu-item" data-view="jobs">💼 Browse Jobs</button>
          <button class="mobile-menu-item" data-view="post">➕ Post a Job</button>
          <button class="mobile-menu-item" data-view="manage-jobs">📋 Manage Jobs</button>
          <button class="mobile-menu-item" data-view="messages">💬 Messages</button>
          <button class="mobile-menu-item" data-view="profile">👤 Profile</button>
          <div class="header-auth" id="mobileMenuAuth">
            <button class="btn-login-header" id="mobileLoginBtn">Log In</button>
            <button class="btn-signup-header" id="mobileSignupBtn">Sign Up Free</button>
          </div>
        `;
      }
    }
    
    // Re-initialize hamburger menu after updating HTML to ensure event listeners work
    // Use setTimeout to avoid immediate re-initialization issues
    setTimeout(() => {
      initHamburgerMenu();
    }, 100);
  }
  
  // Handle sign out - COMPLETE and IMMEDIATE logout
  // Define and assign to window immediately
  window.handleSignOut = async function handleSignOut() {
    console.log('handleSignOut called - starting logout process');
    // IMMEDIATELY clear everything FIRST (don't wait for API)
    // Clear ALL localStorage
    localStorage.removeItem('hustl_token');
    localStorage.removeItem('hustl_user');
    localStorage.removeItem('hustl_state_v3');
    
    // Clear ALL sessionStorage
    sessionStorage.removeItem('hustl_token');
    sessionStorage.removeItem('hustl_user');
    
    // Clear cookies
    document.cookie.split(";").forEach((c) => {
      document.cookie = c
        .replace(/^ +/, "")
        .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });
    
    // Clear state
    state.currentUserId = null;
    state.users = [];
    saveState();
    
    // Clear any cached user data
    if (window.hustlAPI && window.hustlAPI.auth) {
      window.hustlAPI.auth.currentUser = null;
    }
    
    // Clear cached current user for messages
    window._cachedCurrentUser = null;
    
    // Force clear any cached API responses
    if (window.optimizedApi) {
      window.optimizedApi.invalidateCache();
    }
    
    // Close mobile menu if open
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    if (hamburgerBtn) hamburgerBtn.classList.remove('open');
    if (mobileMenu) mobileMenu.classList.remove('open');
    document.body.style.overflow = '';
    
    // Call API sign out (non-blocking - don't wait)
    window.hustlAPI.auth.signOut().catch(err => {
      console.warn("Backend logout call failed (non-critical):", err);
    });
    
    // IMMEDIATELY redirect to home and show login
    // Hide all views
    document.querySelectorAll("[id^='view-']").forEach((sec) => (sec.style.display = "none"));
    const homeView = document.getElementById("view-home");
    if (homeView) {
      homeView.style.display = "block";
      activeView = 'home';
    }
    
    // Show auth section immediately
    const authSection = document.getElementById("authSection");
    if (authSection) {
      authSection.style.display = 'block';
    }
    
    // Update UI immediately (don't wait)
    updateHeaderAuth().then(() => {
      // Open login modal after UI updates
      setTimeout(() => {
        if (window.openAuthModal && typeof window.openAuthModal === 'function') {
          window.openAuthModal('login');
        }
      }, 100);
    });
    
    // Update nav tabs
    document.querySelectorAll(".nav-tab").forEach((tab) => {
      tab.classList.toggle("active", tab.dataset.view === 'home');
    });
    
    // Update mobile bottom nav
    if (window.mobileCore && window.mobileCore.bottomNav) {
      window.mobileCore.bottomNav.updateActiveTab('home');
    }
    
    showToast("✅ Signed out successfully");
    
    // Use replaceState to prevent back button from going to logged-in state
    if (window.history && window.history.replaceState) {
      window.history.replaceState(null, '', window.location.pathname);
    }
    
    // Render all (non-blocking)
    renderAll().catch(err => console.error("Render error:", err));
  };
  
  // Function is already assigned above, just log confirmation
  console.log('✅ handleSignOut function assigned to window.handleSignOut');
  
  // Profile Tabs
  function initProfileTabs() {
    const tabs = document.querySelectorAll('.profile-tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active from all tabs
        tabs.forEach(t => t.classList.remove('active'));
        // Add active to clicked tab
        tab.classList.add('active');
        
        // Hide all tab content
        document.querySelectorAll('.profile-tab-content').forEach(content => {
          content.style.display = 'none';
          content.classList.remove('active');
        });
        
        // Show selected tab content
        const tabName = tab.dataset.tab;
        const tabContent = document.getElementById('profileTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
        if (tabContent) {
          tabContent.style.display = 'block';
          tabContent.classList.add('active');
        }
      });
    });
  }

  // Functions are already exposed globally at their definition points:
  // - setView: line 3538-3539
  // - openAuthModal: line 10246-10247
  // - closeAuthModal: line 10237-10238
  // - handleSignOut: line 10363-10364
  // goToStripeSetup, startExploring, closeWelcomeModal are already defined globally above

  // Prevent back button from showing logged-in content
  window.addEventListener('popstate', async (event) => {
    // Check if user is actually logged in
    const user = await window.hustlAPI.auth.getCurrentUser();
    if (!user) {
      // Not logged in - redirect to home
      if (window.setView && typeof window.setView === 'function') {
        window.setView('home');
      }
      // Show login if on protected view
      const protectedViews = ['profile', 'messages', 'post'];
      if (protectedViews.includes(activeView)) {
        setTimeout(() => {
          if (window.openAuthModal && typeof window.openAuthModal === 'function') {
            window.openAuthModal('login');
          }
        }, 300);
      }
    }
  });

  // Boot - initialize when DOM is ready
  function initializeApp() {
    try {
      loadState();
      initAgeGate();
      initNav();
      initAuthCard();
      initHamburgerMenu();
      initJobsForm();
      initConversationInput();
      initFeedback();
      initFooterLinks();
      checkAgeGate();
      handleStripeReturn();
      checkAutoCompleteJobs();
      setInterval(checkAutoCompleteJobs, 60 * 1000);
      
      // Initialize auth state and render
      (async () => {
        try {
          // Check auth on page load
          const user = await window.hustlAPI.auth.getCurrentUser();
          
          // If on a protected view and not authenticated, redirect to home
          const protectedViews = ['profile', 'messages', 'post'];
          const currentView = activeView || 'home';
          
          if (protectedViews.includes(currentView) && !user) {
            // Not authenticated on protected view - redirect to home
            if (window.setView && typeof window.setView === 'function') {
              window.setView('home');
            }
            // Show login modal
            setTimeout(() => {
              if (window.openAuthModal && typeof window.openAuthModal === 'function') {
                window.openAuthModal('login');
              }
            }, 500);
          }
          
          await updateHeaderAuth();
          await renderAll();
        } catch (error) {
          console.error('Error initializing auth state:', error);
          // If auth check fails, assume not logged in
          await updateHeaderAuth();
          await renderAll();
        }
      })();
      
      // Start token auto-refresh for persistent login
      if (window.appCore && window.appCore.tokenManager) {
        window.appCore.tokenManager.startAutoRefresh();
      }
    } catch (error) {
      console.error('Error initializing app:', error);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    // DOM is already ready
    initializeApp();
  }
  
  // Check for payment success/cancel in URL (run after initialization)
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const paymentStatus = urlParams.get('payment');
    const sessionId = urlParams.get('session_id');
    const offerId = urlParams.get('offerId');
    const jobId = urlParams.get('jobId');
    
    if (paymentStatus === 'success' && sessionId) {
      // Payment completed - show success and refresh
      if (typeof showToast === 'function') {
        showToast('✅ Payment successful! Hustler accepted and job activated.');
      }
      
      // Clean URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      
      // Refresh job lists if on manage-jobs view
      setTimeout(() => {
        if (typeof activeView !== 'undefined' && activeView === 'manage-jobs') {
          if (typeof loadPostedJobs === 'function') loadPostedJobs();
          if (typeof loadActiveJobs === 'function') loadActiveJobs();
        }
        
        // Also refresh if we have jobId
        if (jobId && typeof showViewJobModal === 'function') {
          // Refresh the job modal if it's open
        }
      }, 1000);
      
      if (offerId) {
        console.log('Payment completed for offer:', offerId);
      }
    } else if (paymentStatus === 'cancelled') {
      // Payment cancelled
      if (typeof showToast === 'function') {
        showToast('Payment cancelled. You can try again when ready.');
      }
      
      // Clean URL
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
  }, 1000);
  </script>
  
  <!-- Performance-optimized script loading -->
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css" />
  <script src="/app-core.js" defer></script>
  <script src="/mobile-core.js" defer></script>
</body>
</html>


