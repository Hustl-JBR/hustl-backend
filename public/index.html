
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Hustl ‚Äì Local help, real hustle</title>
  
  <!-- Mobile App Experience -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#2563eb" />
  
  <!-- Performance: Preconnect to external resources -->
  <link rel="preconnect" href="https://hustl-production.up.railway.app" crossorigin />
  
  <!-- Mobile Optimizations CSS (load early for faster paint) -->
  <link rel="stylesheet" href="mobile-optimizations.css" />
  
  <!-- Preload critical scripts -->
  <link rel="modulepreload" href="app-core.js" />
  <link rel="modulepreload" href="mobile-core.js" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-light: #1e293b;
      --card: #1e293b;
      --card-glass: rgba(30, 41, 59, 0.8);
      --primary: #3b82f6;
      --primary-glow: rgba(59, 130, 246, 0.5);
      --primary-soft: rgba(59, 130, 246, 0.15);
      --accent: #06b6d4;
      --accent-glow: rgba(6, 182, 212, 0.4);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.2);
      --danger: #ef4444;
      --success: #22c55e;
      --success-glow: rgba(34, 197, 94, 0.4);
      --radius: 16px;
      --radius-lg: 24px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
    }
    
    /* Modern gradient background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      cursor: pointer;
      font-family: inherit;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* MODERN GLASSMORPHISM HEADER */
    header {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-mark {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.08em;
      font-size: 1rem;
      box-shadow: 0 4px 20px var(--primary-glow);
    }

    .logo-text-main {
      font-weight: 800;
      font-size: 1.3rem;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* Desktop nav tabs */
    .nav-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      font-size: 0.85rem;
    }

    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .nav-tab:hover {
      color: var(--text-main);
      background: var(--primary-soft);
    }

    .nav-tab.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      box-shadow: 0 2px 10px var(--primary-glow);
    }

    /* Header auth buttons */
    .header-auth {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn-login-header {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-main);
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-login-header:hover {
      background: var(--primary-soft);
      border-color: var(--primary);
    }

    .btn-signup-header {
      padding: 0.5rem 1.25rem;
      border: none;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: #fff;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 2px 15px var(--primary-glow);
      transition: all 0.2s ease;
    }

    .btn-signup-header:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px var(--primary-glow);
    }

    /* HAMBURGER MENU */
    .hamburger-btn {
      display: none;
      width: 44px;
      height: 44px;
      border: none;
      background: var(--card);
      border-radius: 12px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .hamburger-btn span {
      display: block;
      width: 20px;
      height: 2px;
      background: var(--text-main);
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .hamburger-btn.open span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger-btn.open span:nth-child(2) {
      opacity: 0;
    }

    .hamburger-btn.open span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    /* Mobile menu overlay */
    .mobile-menu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.98);
      backdrop-filter: blur(20px);
      z-index: 99;
      padding: 80px 1.5rem 2rem;
      flex-direction: column;
      gap: 0.5rem;
    }

    .mobile-menu.open {
      display: flex;
    }

    .mobile-menu-item {
      width: 100%;
      padding: 1rem 1.25rem;
      font-size: 1.1rem;
      text-align: left;
      border-radius: var(--radius);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .mobile-menu-item:hover,
    .mobile-menu-item.active {
      background: var(--primary-soft);
      color: var(--text-main);
    }

    .mobile-menu .header-auth {
      margin-top: auto;
      flex-direction: column;
      width: 100%;
    }

    .mobile-menu .btn-login-header,
    .mobile-menu .btn-signup-header {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
    }

    /* Hide old auth pill */
    .auth-pill {
      display: none;
    }

    main {
      flex: 1;
      padding: 1rem;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 1rem;
    }

    /* GLASSMORPHISM CARDS */
    .card {
      background: var(--card-glass);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1.25rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    /* Mobile responsive for hamburger */
    @media (max-width: 768px) {
      .nav-tabs {
        display: none !important;
      }

      .header-auth.desktop-only {
        display: none !important;
      }

      .hamburger-btn {
        display: flex !important;
      }
    }

    /* Floating animation */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    /* Auth Modal Popup */
    .auth-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .auth-modal-overlay.open {
      display: flex;
    }

    .auth-modal {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalSlideIn 0.3s ease;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .auth-modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-light);
      border-radius: 50%;
      color: var(--text-muted);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .auth-modal-close:hover {
      background: var(--danger);
      color: white;
    }

    /* Modern form inputs for dark theme */
    .auth-modal input {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 0.875rem 1rem;
      border-radius: 12px;
      font-size: 1rem;
      width: 100%;
      transition: all 0.2s ease;
    }

    .auth-modal input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-soft);
    }

    .auth-modal input::placeholder {
      color: var(--text-muted);
    }

    .auth-modal label {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .auth-modal .field {
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      color: var(--text-muted);
      background: #f9fafb;
    }

    .badge.hot {
      background: #fef2f2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .badge.status-open {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--success);
    }

    .badge.status-assigned {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: var(--primary);
    }

    .badge.status-completed {
      background: #f5f3ff;
      border-color: #ddd6fe;
      color: #6d28d9;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .hero-heading {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .hero-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .hero-cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.95rem;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .step-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .step-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .step-emoji {
      margin-right: 0.25rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.3rem;
    }

    .pill {
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      border: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .field {
      margin-bottom: 0.6rem;
    }

    label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 0.15rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 0.35rem 0.45rem;
      font-size: 0.8rem;
      font-family: inherit;
      background: #f9fafb;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .field-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }

    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    .job-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .job-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.25rem;
    }

    .job-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .job-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .small-btn {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
    }

    .small-btn.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease;
      pointer-events: auto !important; /* Ensure overlay is clickable */
    }
    

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg);
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
      }
      
      .modal-content {
        max-width: 100%;
        max-height: 95vh;
        border-radius: 16px 16px 0 0;
        animation: slideUpMobile 0.3s ease;
      }
      
      @keyframes slideUpMobile {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Smooth page transitions */
    [id^="view-"] {
      animation: fadeIn 0.2s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Better input focus for mobile */
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      transform: scale(1.01);
      transition: all 0.2s;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text);
      z-index: 10;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #fff;
      transform: scale(1.1);
    }

    .job-detail {
      margin-top: 0.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.75rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }
/* High-contrast styling just for the job detail panel */
.job-detail-contrast {
  background: #111827;           /* light dark slate */
  color: #e5e7eb;                /* light text */
  border-color: #0b1220;
  box-shadow: 0 16px 40px rgba(0,0,0,0.35);
}

/* labels & muted text inside the dark panel */
.job-detail-contrast .detail-label { 
  color: #93c5fd;                /* soft blue for labels */
}

.job-detail-contrast .muted {
  color: #cbd5e1;                /* lighter muted */
}

/* buttons inside the dark panel */
.job-detail-contrast .small-btn.outline {
  border-color: #334155;
  color: #e5e7eb;
  background: transparent;
}
.job-detail-contrast .small-btn {
  background: #1f2937;           /* subtle dark chip */
  color: #e5e7eb;
}

/* links inside the dark panel */
.job-detail-contrast .linkish {
  color: #93c5fd;
}

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .detail-value {
      font-weight: 500;
    }

    .chat-box {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      margin-top: 0.5rem;
      background: #fff;
    }

    .chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .chat-msg {
      font-size: 0.75rem;
      padding: 0.3rem 0.45rem;
      border-radius: 999px;
      max-width: 85%;
    }

    .chat-msg.me {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
    }

    .chat-msg.them {
      align-self: flex-start;
      background: #e5e7eb;
      color: var(--text-main);
    }

    .chat-meta {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.4rem;
    }

    .chat-input-row input {
      flex: 1;
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.5rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-weight: 600;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-muted);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }

   .linkish {
  color: var(--primary);
  font-size: 0.75rem;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
  text-decoration-thickness: 1.5px;
  font-weight: 600;
}
.linkish:hover {
  text-decoration-thickness: 2px;
  opacity: 0.9;
}

    .job-status-group {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-status-group span {
      margin-right: 0.35rem;
      cursor: pointer;
    }

    .job-status-group span.active {
      color: var(--primary);
      font-weight: 600;
    }

    .feedback-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .about-text {
      font-size: 0.8rem;
      color: var(--text-main);
      line-height: 1.45;
      white-space: pre-line;
    }

    .legal-subtitle {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.6rem;
    }

    .legal-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    footer {
      border-top: 1px solid var(--border);
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: #111827;
      color: #e5e7eb;
    }

    .footer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    .footer-links span {
      cursor: pointer;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: #111827;
      color: #f9fafb;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-size: 0.75rem;
      z-index: 50;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .age-gate-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.84);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .age-gate-card {
      background: #ffffff;
      padding: 1.2rem;
      border-radius: 14px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }

    .age-gate-card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    .age-gate-card p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.7rem;
    }

    .age-gate-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.3rem;
    }

@media (max-width: 800px) {
      header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .jobs-list {
        max-height: none; /* let the page scroll instead of tiny inner scroll */
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-row">
        <div class="logo-mark">H</div>
        <div>
          <div class="logo-text-main">HUSTL</div>
          <div class="logo-sub">Tennessee's Gig Marketplace</div>
        </div>
      </div>
      
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="home">Home</button>
        <button class="nav-tab" data-view="jobs">Browse Jobs</button>
        <button class="nav-tab" data-view="post">Post a Job</button>
        <button class="nav-tab" data-view="messages">Messages</button>
        <button class="nav-tab" data-view="profile">Profile</button>
        <button class="nav-tab" data-view="owner" id="ownerTab" style="display:none;">Owner</button>
      </nav>
      
      <div class="header-auth desktop-only" id="headerAuthDesktop">
        <button class="btn-login-header" id="headerLoginBtn">Log In</button>
        <button class="btn-signup-header" id="headerSignupBtn">Sign Up Free</button>
      </div>
      
      <!-- Hamburger for mobile -->
      <button class="hamburger-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
      </button>
      
      <!-- Old auth pill (hidden but kept for JS compatibility) -->
      <div class="auth-pill" id="authPill" style="display:none;">
        Not signed in
        <button id="openAuthButton">Sign in / Create account</button>
      </div>
    </header>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
      <button class="mobile-menu-item active" data-view="home">üè† Home</button>
      <button class="mobile-menu-item" data-view="jobs">üíº Browse Jobs</button>
      <button class="mobile-menu-item" data-view="post">‚ûï Post a Job</button>
      <button class="mobile-menu-item" data-view="messages">üí¨ Messages</button>
      <button class="mobile-menu-item" data-view="profile">üë§ Profile</button>
      <div class="header-auth">
        <button class="btn-login-header" id="mobileLoginBtn">Log In</button>
        <button class="btn-signup-header" id="mobileSignupBtn">Sign Up Free</button>
      </div>
    </div>

    <main>
      <!-- AUTH CARD -->
      <section id="authSection" class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--card-glass) 100%); display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
          <div>
            <div class="card-title" id="authCardTitle" style="font-size: 1.3rem; margin-bottom: 0.25rem;">üöÄ Join Hustl</div>
            <div style="color: var(--text-muted); font-size: 0.85rem;">Start earning or get help today</div>
          </div>
          <div id="authModeToggle">
            <span class="linkish" data-auth-mode="login" style="background: var(--bg-light); padding: 0.5rem 1rem; border-radius: 999px; font-weight: 500; color: var(--text-main); cursor: pointer; border: 1px solid var(--border);">Log in</span>
          </div>
        </div>
        
        <div id="authBodyCreate">
          <!-- Step indicator -->
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <div style="flex: 1; height: 4px; background: var(--primary); border-radius: 2px;"></div>
            <div style="flex: 1; height: 4px; background: var(--border); border-radius: 2px;"></div>
          </div>
          
          <div class="field">
            <label for="createName">Your Name</label>
            <input id="createName" type="text" placeholder="John Smith" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="createEmail">Email Address</label>
            <input id="createEmail" type="email" placeholder="john@example.com" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="createPassword">Create Password</label>
            <input id="createPassword" type="password" placeholder="At least 8 characters" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field" style="display: none;">
            <label for="createRole">I want to</label>
            <select id="createRole" style="font-size: 1rem; padding: 0.75rem;">
              <option value="both" selected>Do both - Post jobs & earn money</option>
              <option value="customer">Only post jobs (Customer)</option>
              <option value="hustler">Only earn money (Hustler)</option>
            </select>
          </div>
          
          <!-- Hidden fields for backwards compatibility -->
          <div style="display: none;">
            <select id="createPayoutMethod"><option value="">Choose one</option></select>
            <input id="createPayoutHandle" type="text" />
            <input id="createPayoutName" type="text" />
          </div>
          
          <button class="btn btn-primary" id="createAccountButton" style="width: 100%; padding: 0.9rem; font-size: 1rem; margin-top: 0.5rem;">
            Create Free Account ‚Üí
          </button>
          
          <p class="muted" style="text-align: center; margin-top: 0.75rem; font-size: 0.75rem;">
            By signing up, you agree to our Terms of Service.<br>
            <span style="color: var(--success);">‚úì Free to join</span> ‚Ä¢ <span style="color: var(--success);">‚úì No monthly fees</span>
          </p>
        </div>

        <div id="authBodyLogin" style="display:none;">
          <div style="text-align: center; margin-bottom: 1rem;">
            <span style="font-size: 2rem;">üëã</span>
            <div style="font-weight: 600; margin-top: 0.25rem;">Welcome back!</div>
          </div>
          
          <div class="field">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" placeholder="you@example.com" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <div class="field">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" placeholder="Your password" style="font-size: 1rem; padding: 0.75rem;" />
          </div>
          
          <button class="btn btn-primary" id="loginButton" style="width: 100%; padding: 0.9rem; font-size: 1rem;">
            Log In ‚Üí
          </button>
          
          <p class="muted" style="text-align: center; margin-top: 0.75rem; font-size: 0.8rem;">
            Don't have an account? <span class="linkish" data-auth-mode="create">Sign up free</span>
          </p>
        </div>
      </section>

      <!-- HOME VIEW - MODERN HERO -->
      <section id="view-home">
        <!-- Hero Section -->
        <div style="text-align: center; padding: 2rem 1rem 3rem; max-width: 700px; margin: 0 auto;">
          
          <!-- Animated Briefcase Icon -->
          <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px var(--primary-glow); animation: float 3s ease-in-out infinite;">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
          </div>
          
          <!-- Main Headline -->
          <h1 style="font-size: 2.5rem; font-weight: 800; line-height: 1.1; margin: 0 0 1rem; background: linear-gradient(135deg, #fff 0%, var(--accent) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            Find Help or<br>Make Extra Cash
          </h1>
          
          <!-- Subheadline -->
          <p style="font-size: 1.1rem; color: var(--text-muted); margin: 0 0 2rem; line-height: 1.6;">
            Connect with local hustlers in Tennessee for <span style="color: var(--accent);">moving</span>, <span style="color: var(--primary);">yard work</span>, <span style="color: var(--success);">errands</span>, and more.
          </p>
          
          <!-- CTA Buttons -->
          <div style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 320px; margin: 0 auto 2rem;">
            <button class="btn btn-primary" id="homeCtaPost" style="width: 100%; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 999px; background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%); border: none; color: white; box-shadow: 0 4px 20px var(--primary-glow); transition: all 0.3s ease;">
              ‚ú® Post a Job
            </button>
            <button class="btn btn-ghost" id="homeCtaBrowse" style="width: 100%; padding: 1rem 2rem; font-size: 1.1rem; font-weight: 600; border-radius: 999px; background: transparent; border: 2px solid var(--border); color: var(--text-main); transition: all 0.3s ease;">
              üíº Browse Jobs & Earn
            </button>
          </div>
          
          <!-- Trust badges -->
          <div style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
              <span style="color: var(--success);">‚úì</span> Free to join
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
              <span style="color: var(--success);">‚úì</span> Secure payments
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
              <span style="color: var(--success);">‚úì</span> Instant payouts
            </div>
          </div>
        </div>
        
        <!-- How It Works Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          
          <!-- Card 1: Post -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(251, 191, 36, 0.3); background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üìù</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: #fbbf24;">1. Post Your Job</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Describe what you need, set your price. Takes 30 seconds.</p>
          </div>
          
          <!-- Card 2: Connect -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(59, 130, 246, 0.3); background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üí™</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--primary);">2. Get Offers</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Local hustlers apply. Compare, chat, and pick your favorite.</p>
          </div>
          
          <!-- Card 3: Pay -->
          <div class="card" style="text-align: center; padding: 1.5rem; border: 1px solid rgba(34, 197, 94, 0.3); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);">
            <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">üí∞</div>
            <h3 style="font-size: 1.1rem; margin: 0 0 0.5rem; color: var(--success);">3. Pay Securely</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin: 0;">Pay through Stripe. Hustler gets paid instantly to their bank.</p>
          </div>
        </div>
        
        <!-- Why Stripe Section -->
        <div class="card" style="margin-bottom: 1.5rem; border: 1px solid rgba(99, 91, 255, 0.3);">
          <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #635bff 0%, #a855f7 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <span style="font-size: 1.5rem;">üí≥</span>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.1rem;">Powered by Stripe</h3>
              <p style="margin: 0; color: var(--text-muted); font-size: 0.85rem;">Same payments as Uber, Lyft, DoorDash & Instacart</p>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; font-size: 0.85rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">‚úì</span> Bank-level security
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">‚úì</span> Instant payouts
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">‚úì</span> Money held safely
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
              <span style="color: var(--success);">‚úì</span> Fraud protection
            </div>
          </div>
        </div>
        
        <!-- Quick Info -->
        <div class="card" style="background: var(--card-glass);">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
            <span style="font-size: 1.25rem;">üìç</span>
            <span style="font-weight: 600;">Currently serving Tennessee</span>
          </div>
          <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
            <li>‚Ä¢ Knoxville, Nashville, Memphis & surrounding areas</li>
            <li>‚Ä¢ Hustl takes only 15% ‚Äî the rest goes to hustlers</li>
            <li>‚Ä¢ Chat with hustlers before you hire</li>
              <li>You must be 18+ to use Hustl. This prototype runs in your browser only.</li>
            </ul>
            <div class="section-title" style="margin-top:0.8rem;">Example categories</div>
            <div class="pill-row">
              <div class="pill">üöö Moving & dump runs</div>
              <div class="pill">üåø Yard work</div>
              <div class="pill">üßπ Clean-up & organizing</div>
              <div class="pill">üõ† Furniture & set-up</div>
              <div class="pill">‚≠ê Other local odd jobs</div>
            </div>
          </div>
        </div>
      </section>

      <!-- POST JOB VIEW (separate page) -->
      <section id="view-post" style="display:none;">
        <div class="card" id="jobFormCard">
          <div class="card-header">
            <div class="card-title">Post a job</div>
            <span class="badge">Customer only</span>
          </div>
          <div class="muted" style="margin-bottom:0.5rem;">
            You must be logged in as a <strong>Customer</strong> to post jobs. Hustlers will see them in the Jobs list.
          </div>

          <div class="field">
            <label for="jobTitle">Job title</label>
            <input id="jobTitle" type="text" placeholder="Example: Dump run from West Knoxville" />
          </div>

          <div class="field">
            <label for="jobCategory">Category</label>
            <select id="jobCategory">
              <option value="">Choose a category</option>
              <option value="moving">üöö Moving / Hauling</option>
              <option value="yard">üåø Yard work / Outdoor</option>
              <option value="cleaning">üßπ Cleaning / Organizing</option>
              <option value="furniture">üõ† Furniture / Assembly</option>
              <option value="other">‚≠ê Other</option>
            </select>
          </div>

          <div class="field">
            <label for="jobDescription">Description</label>
            <textarea id="jobDescription" placeholder="What needs to be done? Stairs, heavy items, timing, access, etc."></textarea>
          </div>

          <div class="field-inline">
            <div class="field">
              <label for="pickupArea">Pickup area / neighborhood</label>
              <input id="pickupArea" type="text" placeholder="Example: West Knoxville near UTK" />
            </div>
            <div class="field">
              <label for="pickupCity">City</label>
              <input id="pickupCity" type="text" placeholder="Example: Knoxville, TN" />
            </div>
          </div>

          <div class="field">
            <label for="pickupAddress">Pickup address (optional)</label>
            <input id="pickupAddress" type="text" placeholder="Street address (shared in chat or after accept)" />
          </div>

          <div class="field">
            <label>
              <input type="checkbox" id="jobOnSiteOnly" />
              This job happens only at the pickup location (no separate dropoff).
            </label>
          </div>

          <div id="dropoffFields">
            <div class="field-inline">
              <div class="field">
                <label for="dropoffArea">Dropoff area / neighborhood</label>
                <input id="dropoffArea" type="text" placeholder="Example: Fountain City" />
              </div>
              <div class="field">
                <label for="dropoffCity">Dropoff city</label>
                <input id="dropoffCity" type="text" placeholder="Example: Knoxville, TN" />
              </div>
            </div>
            <div class="field">
              <label for="dropoffAddress">Dropoff address (optional)</label>
              <input id="dropoffAddress" type="text" placeholder="Street address (shared in chat or after accept)" />
            </div>
          </div>

          <div class="section-title" style="margin-top:0.5rem;">Payment</div>
          <div class="field-inline">
            <div class="field">
              <label for="paymentType">Payment type</label>
              <select id="paymentType">
                <option value="flat">Flat amount (one-time)</option>
                <option value="hourly">Hourly + max hours</option>
              </select>
            </div>
            <div class="field" id="flatAmountField">
              <label for="flatAmount">Pay ($ flat)</label>
              <input id="flatAmount" type="number" min="0" step="1" value="80" />
            </div>
          </div>

          <div class="field-inline" id="hourlyFields" style="display:none;">
            <div class="field">
              <label for="hourlyRate">Hourly rate ($/hr)</label>
              <input id="hourlyRate" type="number" min="0" step="1" value="20" />
            </div>
            <div class="field">
              <label for="maxHours">Max hours</label>
              <input id="maxHours" type="number" min="1" step="1" value="3" />
            </div>
          </div>

          <div class="field">
            <label for="jobNotes">Extra notes (optional)</label>
            <textarea id="jobNotes" placeholder="Parking, gate codes, equipment, pets, any special requests."></textarea>
          </div>

          <div class="field">
            <label for="jobPhoto">Optional photo (not uploaded in this demo)</label>
            <input id="jobPhoto" type="file" accept="image/*" />
          </div>

          <button class="btn btn-primary" id="postJobButton">Post job to Hustl</button>

          <div class="muted" style="margin-top:0.4rem;">
            In this prototype, your job is stored only in this browser so you can test flows. In a live version,
            this would send email confirmations and save to a shared database.
          </div>
        </div>
      </section>

      <!-- JOBS VIEW -->
      <section id="view-jobs" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title" id="jobsCardTitle">Jobs near you (demo)</div>
            <span class="muted" id="jobsFilterSummary"></span>
          </div>
          <div class="job-status-group" id="jobsStatusFilter">
            <span data-status="all" class="active">All</span>
            <span data-status="open">Open</span>
            <span data-status="assigned">Assigned</span>
            <span data-status="completed">Completed</span>
          </div>
          <div class="jobs-list" id="jobsList"></div>
          <div id="jobDetailContainer"></div>
        </div>
      </section>

      <!-- MESSAGES VIEW -->
      <section id="view-messages" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Messages</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Each conversation is tied to a specific job. Think of it like texting, but only about that job.
            </div>
            <div class="jobs-list" id="conversationList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title" id="conversationTitle">Select a conversation</div>
            </div>
            <div id="conversationJobSummary" class="muted" style="margin-bottom:0.5rem;"></div>
            <div class="chat-box">
              <div class="chat-messages" id="conversationMessages"></div>
              <div class="chat-input-row">
                <input id="conversationInput" type="text" placeholder="Type a message..." />
                <button class="btn btn-primary" id="conversationSendButton">Send</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Your profile</div>
            </div>
            <div id="profileContent"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Your jobs</div>
            </div>
            <div class="jobs-list" id="profileJobsList"></div>
          </div>
        </div>
      </section>

      <!-- OWNER VIEW -->
      <section id="view-owner" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Owner dashboard (demo)</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Shows paid jobs, your 15% fee, and whether you‚Äôve sent the Hustler their payout.
            </div>
            <div id="ownerPaidList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Assigned but not paid yet</div>
            </div>
            <div id="ownerAssignedList"></div>
          </div>
        </div>
      </section>

      <!-- FEEDBACK VIEW -->
      <section id="view-feedback" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Send feedback to Hustl</div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            This isn‚Äôt a public review wall. It‚Äôs a private way to send feedback directly to the Hustl team
            (<strong>team.hustlapp@outlook.com</strong>) about bugs, ideas, or issues.
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="feedbackName">Name (optional)</label>
              <input id="feedbackName" type="text" placeholder="Your name or leave blank" />
            </div>
            <div class="field">
              <label for="feedbackEmail">Email (optional)</label>
              <input id="feedbackEmail" type="email" placeholder="So we can reply if needed" />
            </div>
          </div>
          <div class="field">
            <label for="feedbackMessage">Feedback</label>
            <textarea id="feedbackMessage" placeholder="Tell us what‚Äôs working, what‚Äôs confusing, or what you‚Äôd love to see."></textarea>
          </div>
          <button class="btn btn-primary" id="feedbackButton">Send feedback</button>
          <div class="feedback-note">
            In this prototype, feedback is just stored on your device and not actually emailed. In a live version,
            this would send to the Hustl team inbox and be used to improve the app.
          </div>
        </div>
      </section>

          <!-- ABOUT / LEGAL VIEW -->
      <section id="view-about" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">About Hustl</div>
          </div>
          <div class="about-text">
Hustl was built in Knoxville, Tennessee with a simple goal:  
make it easier for people to help each other and make real money on the side.

If you need help ‚Äì moving a couch, doing a dump run, cleaning out a garage,
tackling yard work, or knocking out random errands ‚Äì you shouldn‚Äôt have to
blast group chats or scroll through sketchy posts. You should be able to
describe the job, set a fair price, and connect with someone local who‚Äôs
ready to work.

If you‚Äôre a Hustler, Hustl is a way to turn your time, truck, or muscle into
extra cash on your own schedule. No long-term commitments, no complicated
contracts ‚Äì just clear jobs, clear payouts, and a straightforward platform fee.

Hustl is also about supporting small, local businesses and solo operators.
As the platform grows, the same tools that help with one-time jobs can help
people build regular clients, repeat work, and real side-income here in the
community.

Post a job, apply to one, show up, do solid work, and get paid ‚Äì that‚Äôs the
heart of Hustl.
          </div>
        </div>
      </section>

    </main>

    <footer>
      <div class="footer-row">
        <div>¬© 2025 Hustl. All rights reserved.</div>
        <div class="footer-links">
          <span id="footerTermsLink">Terms of Use</span>
          <span>‚Ä¢</span>
          <span id="footerPrivacyLink">Privacy Policy</span>
          <span>‚Ä¢</span>
          <span>team.hustlapp@outlook.com</span>
          <span>¬∑</span>
          <span>@team.hustlapp</span>
        </div>
      </div>
    </footer>

       <div class="toast" id="toast"></div>

    <!-- Age gate disabled: popup hidden -->
    <div class="age-gate-overlay" id="ageGate" style="display:none;">
      <div class="age-gate-card">
        <h2>Are you 18 or older?</h2>
        <p>
          Hustl is for adults only. By continuing, you confirm that you are at least 18 years old
          and understand this is a prototype, not a fully live service.
        </p>
        <div class="age-gate-buttons">
          <button class="btn btn-primary" id="ageYesButton">Yes, I‚Äôm 18+</button>
          <button class="btn btn-ghost" id="ageNoButton">No</button>
        </div>
        <div class="muted" style="margin-top:0.4rem;">
          If you tap ‚ÄúNo‚Äù, we‚Äôll just hide the app. You can come back when you‚Äôre older.
        </div>
      </div>
    </div>
  </div>

<!-- Backend API Configuration -->
<script>
  // Set your Railway backend URL here
  window.HUSTL_CONFIG = {
    API_URL: 'https://hustl-production.up.railway.app' // Railway backend URL
  };
  
  // Auto-detect localhost for development
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.HUSTL_CONFIG.API_URL = 'http://localhost:4000';
  }
</script>
<script src="/api-integration.js?v=2"></script>
<script>
  // Backend API configuration - using NestJS API with Neon database
  // No Supabase needed - we use Railway backend with Neon PostgreSQL
  
  const STORAGE_KEY = "hustl_state_v3";
    // Get backend URL from config or default
    const BACKEND_URL = (window.HUSTL_CONFIG && window.HUSTL_CONFIG.API_URL) || 
                        (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                          ? 'http://localhost:4000' 
                          : 'https://hustl-production.up.railway.app');

    // üîî Auto-complete after 72 hours of no customer response
    const AUTO_COMPLETE_HOURS = 72;
    const AUTO_COMPLETE_MS = AUTO_COMPLETE_HOURS * 60 * 60 * 1000;

    let state = {
      users: [],
      currentUserId: null,
      jobs: [],
      feedback: [],
    };

    let activeView = "home";
    let activeJobsStatusFilter = "all";
    let activeConversationJobId = null;
    
    // Pagination state
    let currentJobsPage = 1;
    let jobsPagination = { hasMore: false };
    let allLoadedJobs = []; // Always initialize as empty array

    /* ---------- Utilities ---------- */

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
        }
      } catch (e) {
        console.error("Error loading state", e);
      }
    }

    function getCurrentUser() {
      return state.users.find((u) => u.id === state.currentUserId) || null;
    }

    function generateId(prefix) {
      return (
        prefix +
        "_" +
        Date.now().toString(36) +
        "_" +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function formatMoney(amount) {
      const n = Number(amount) || 0;
      return "$" + n.toFixed(2);
    }

    function timeAgo(timestamp) {
      if (!timestamp) return "";
      const now = Date.now();
      const diffMs = now - timestamp;
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return diffMin + " min ago";
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return diffHr + " hr ago";
      const diffDay = Math.floor(diffHr / 24);
      if (diffDay === 1) return "yesterday";
      return diffDay + " days ago";
    }

    let toastTimeout = null;
    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        el.classList.remove("show");
      }, 2200);
    }

    // ‚è± Auto-complete checker: if Hustler marked finished and no dispute + no response in time
    function checkAutoCompleteJobs() {
      const now = Date.now();
      let changed = false;

      state.jobs.forEach((job) => {
        if (
          job &&
          job.status === "assigned" &&
          job.completionRequestedAt &&
          !job.dispute &&
          !job.autoCompleted
        ) {
          if (now - job.completionRequestedAt >= AUTO_COMPLETE_MS) {
            job.status = "completed";// If there's a hustler, this will now appear in Owner payout queue
if (job.acceptedHustlerId) {
  console.log("Job moved to payout queue:", job.id);
}

            job.autoCompleted = true;
            changed = true;
          }
        }
      });

      if (changed) {
        saveState();
        renderAll();
      }
    }

    /* ---------- Age gate (disabled) ---------- */

    function checkAgeGate() {
      // Always keep it hidden
      const overlay = document.getElementById("ageGate");
      if (overlay) overlay.style.display = "none";
    }

    function initAgeGate() {
      // No-op ‚Äì age gate disabled
    }

    /* ---------- View navigation ---------- */

    function setView(view) {
      activeView = view;
      document
        .querySelectorAll("[id^='view-']")
        .forEach((sec) => (sec.style.display = "none"));
      const target = document.getElementById("view-" + view);
      if (target) target.style.display = "block";

      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.view === view);
      });

      renderAll();
    }

    /* ---------- Auth visibility ---------- */

    async function renderAuthSectionVisibility() {
  const authSection = document.getElementById("authSection");
  const user = await window.hustlAPI.auth.getCurrentUser();
  authSection.style.display = user ? "none" : "block";
}

    
/* ---------- Auth ---------- */

async function renderAuthPill() {
  const pill = document.getElementById("authPill");
  const user = await window.hustlAPI.auth.getCurrentUser();

  if (!user) {
    pill.innerHTML =
      'Not signed in <button id="openAuthButton">Sign in / Create account</button>';

    const openBtn = document.getElementById("openAuthButton");
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        document
          .getElementById("authSection")
          .scrollIntoView({ behavior: "smooth" });
      });
    }
  } else {
    const displayName = user.name || user.email;
    const role = user.roles && user.roles.length > 0 ? user.roles[0].toLowerCase() : "user";
    pill.innerHTML =
      `Signed in as <strong>${displayName}</strong> ¬∑ ${role}` +
      '<button id="logoutButton">Log out</button>';

    const logoutBtn = document.getElementById("logoutButton");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await window.hustlAPI.auth.signOut();
        showToast("Logged out.");
        renderAll();
      });
    }
  }
}

function initAuthCard() {
  const authTitle = document.getElementById("authCardTitle");
  const authToggle = document.getElementById("authModeToggle");
  const authBodyCreate = document.getElementById("authBodyCreate");
  const authBodyLogin = document.getElementById("authBodyLogin");
  let mode = "create";

  function wireToggle() {
    const span = authToggle.querySelector("span.linkish");
    if (span) {
      span.addEventListener("click", (e) => {
        const m = e.target.dataset.authMode;
        setMode(m);
      });
    }
  }

  function setMode(next) {
    mode = next;
    if (mode === "create") {
      authTitle.textContent = "Create account";
      authBodyCreate.style.display = "";
      authBodyLogin.style.display = "none";
      authToggle.innerHTML =
        'Already have an account? <span class="linkish" data-auth-mode="login">Log in</span>';
    } else {
      authTitle.textContent = "Log in";
      authBodyCreate.style.display = "none";
      authBodyLogin.style.display = "";
      authToggle.innerHTML =
        'Need a new account? <span class="linkish" data-auth-mode="create">Create one</span>';
    }
    wireToggle();
  }

  setMode("create");

document.getElementById("createAccountButton").addEventListener("click", async () => {
  const name = document.getElementById("createName").value.trim();
  const email = document.getElementById("createEmail").value.trim();
  const password = document.getElementById("createPassword").value.trim();
  const role = document.getElementById("createRole").value;

  const payoutMethod = document.getElementById("createPayoutMethod").value;
  const payoutHandle = document.getElementById("createPayoutHandle").value.trim();
  const payoutName = document.getElementById("createPayoutName").value.trim();

  if (!name || !email || !password) {
    showToast("Please fill name, email, and password.");
    return;
  }
  if (password.length < 8) {
    showToast("Password should be at least 8 characters.");
    return;
  }
  if (!payoutMethod) {
    showToast("Choose a payout method.");
    return;
  }
  if (!payoutHandle) {
    showToast("Enter your payout handle/account.");
    return;
  }
  if (payoutMethod === "zelle" && !payoutName) {
    showToast("Enter the payout name for Zelle.");
    return;
  }

// Generate username from email (take part before @, make alphanumeric)
  let username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
  // Ensure it's at least 3 characters and max 20
  if (username.length < 3) {
    username = username + '123';
  }
  if (username.length > 20) {
    username = username.substring(0, 20);
  }
  // Add random suffix to ensure uniqueness
  const randomSuffix = Math.floor(Math.random() * 1000);
  username = username + randomSuffix;

  try {
    // Use backend API for signup (simple - no city/zip needed)
    const result = await window.hustlAPI.auth.signUp(
      email,
      password,
      name,
      username,
      role
    );

    showToast("Account created.");
    setView("jobs");
    renderAll();
  } catch (error) {
    console.error("Sign up error:", error);
    // Filter out any city/zip related error messages
    let errorMsg = error.message || "Unknown error";
    const lowerMsg = errorMsg.toLowerCase();
    if (lowerMsg.includes('zip') || lowerMsg.includes('city') || lowerMsg.includes('location')) {
      errorMsg = "Account creation failed. Please try again.";
    }
    showToast("Sign up error: " + errorMsg);
  }
});

  document
    .getElementById("loginButton")
    .addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password =
        document.getElementById("loginPassword").value.trim();
      if (!email || !password)
        return showToast("Enter email and password.");

      try {
        await window.hustlAPI.auth.signIn(email, password);
        showToast("Logged in.");
        setView("jobs");
        renderAll();
      } catch (error) {
        showToast("Login error: " + (error.message || "Unknown error"));
      }
    });
}

    /* ---------- Jobs ---------- */

    function clearJobForm() {
      document.getElementById("jobTitle").value = "";
      document.getElementById("jobCategory").value = "";
      document.getElementById("jobDescription").value = "";
      document.getElementById("pickupArea").value = "";
      document.getElementById("pickupCity").value = "";
      document.getElementById("pickupAddress").value = "";
      document.getElementById("jobOnSiteOnly").checked = false;
      document.getElementById("dropoffArea").value = "";
      document.getElementById("dropoffCity").value = "";
      document.getElementById("dropoffAddress").value = "";
      document.getElementById("paymentType").value = "flat";
      document.getElementById("flatAmount").value = "80";
      document.getElementById("hourlyRate").value = "20";
      document.getElementById("maxHours").value = "3";
      document.getElementById("jobNotes").value = "";
      document.getElementById("jobPhoto").value = "";
      document.getElementById("flatAmountField").style.display = "block";
      document.getElementById("hourlyFields").style.display = "none";
      document.getElementById("dropoffFields").style.display = "block";
    }
    function initJobsForm() {
      const jobOnSiteOnly = document.getElementById("jobOnSiteOnly");
      const dropoffFields = document.getElementById("dropoffFields");
      jobOnSiteOnly.addEventListener("change", () => {
        dropoffFields.style.display = jobOnSiteOnly.checked ? "none" : "block";
      });

      const paymentTypeSelect = document.getElementById("paymentType");
      const flatField = document.getElementById("flatAmountField");
      const hourlyFields = document.getElementById("hourlyFields");
      paymentTypeSelect.addEventListener("change", () => {
        if (paymentTypeSelect.value === "flat") {
          flatField.style.display = "block";
          hourlyFields.style.display = "none";
        } else {
          flatField.style.display = "none";
          hourlyFields.style.display = "grid";
        }
      });

      document
        .getElementById("postJobButton")
        .addEventListener("click", async () => {
          const user = await window.hustlAPI.auth.getCurrentUser();
          if (!user)
            return showToast(
              "You must be logged in as a Customer to post jobs."
            );

          const userRole = user.roles && user.roles.length > 0 ? user.roles[0].toLowerCase() : null;
          if (userRole !== "customer")
            return showToast("Switch your role to Customer to post.");

          const title = document.getElementById("jobTitle").value.trim();
          const category = document.getElementById("jobCategory").value;
          const desc = document.getElementById("jobDescription").value.trim();
          const pickupArea = document
            .getElementById("pickupArea")
            .value.trim();
          const pickupCity = document
            .getElementById("pickupCity")
            .value.trim();
          const pickupAddress = document
            .getElementById("pickupAddress")
            .value.trim();
          const onSiteOnly =
            document.getElementById("jobOnSiteOnly").checked;
          const dropoffArea = document
            .getElementById("dropoffArea")
            .value.trim();
          const dropoffCity = document
            .getElementById("dropoffCity")
            .value.trim();
          const dropoffAddress = document
            .getElementById("dropoffAddress")
            .value.trim();
          const paymentType =
            document.getElementById("paymentType").value;
          const flatAmount = Number(
            document.getElementById("flatAmount").value
          );
          const hourlyRate = Number(
            document.getElementById("hourlyRate").value
          );
          const maxHours = Number(
            document.getElementById("maxHours").value
          );
          const notes = document
            .getElementById("jobNotes")
            .value.trim();

          if (!title || !category || !desc)
            return showToast(
              "Please fill title, category, and description."
            );

          let flat_amount_cents = null,
            hourly_rate_cents = null;
          if (paymentType === "flat") {
            if (!flatAmount || flatAmount <= 0)
              return showToast("Flat amount must be > 0.");
            flat_amount_cents = Math.round(flatAmount * 100);
          } else {
            if (
              !hourlyRate ||
              hourlyRate <= 0 ||
              !maxHours ||
              maxHours <= 0
            )
              return showToast(
                "Hourly rate and max hours must be valid."
              );
            hourly_rate_cents = Math.round(hourlyRate * 100);
          }

          try {
            const jobData = {
              title,
              category,
              description: desc,
              pickup_area: pickupArea,
              pickup_city: pickupCity,
              pickup_address: pickupAddress,
              on_site_only: onSiteOnly,
              dropoff_area: onSiteOnly ? null : dropoffArea,
              dropoff_city: onSiteOnly ? null : dropoffCity,
              dropoff_address: onSiteOnly ? null : dropoffAddress,
              payment_type: paymentType,
              flat_amount_cents,
              hourly_rate_cents,
              max_hours: paymentType === "hourly" ? maxHours : null,
              notes,
            };

            await window.hustlAPI.jobs.create(jobData);

            showToast("Job posted.");
            setView("jobs");
            clearJobForm();
            renderJobs();
          } catch (error) {
            console.error("Post job error:", error);
            showToast("Post error: " + (error.message || "Unknown error"));
          }
        });
    }

    
async function renderJobs(reset = false) {
  console.log('üîµ NEW RENDERJOBS VERSION LOADED - v2.0');
  const jobsList = document.getElementById("jobsList");
  const jobsCardTitle = document.getElementById("jobsCardTitle");
  const jobsFilterSummary = document.getElementById("jobsFilterSummary");

  // Reset pagination if needed
  if (reset) {
    currentJobsPage = 1;
    allLoadedJobs = [];
    if (jobsList) jobsList.innerHTML = ""; // Clear existing jobs
  }

  try {
    // Get saved zip filter
    const savedZip = localStorage.getItem('savedZipFilter') || '';
    
    // Build filters for API
    const filters = {
      page: currentJobsPage,
      limit: 20,
    };
    
    if (savedZip) {
      filters.zip = savedZip;
    }

    // Load jobs from API (use window.hustlAPI if available, otherwise fallback)
    let response;
    if (window.hustlAPI && window.hustlAPI.jobs) {
      response = await window.hustlAPI.jobs.list(filters);
    } else {
      // Fallback: Try direct API call
      const params = new URLSearchParams();
      if (filters.page) params.append('page', filters.page);
      if (filters.limit) params.append('limit', filters.limit);
      if (filters.zip) params.append('zip', filters.zip);
      
      const apiResponse = await fetch(`${BACKEND_URL}/api/jobs?${params.toString()}`);
      response = await apiResponse.json();
    }
    
    // Handle paginated response - ensure we always have an array
    let newJobs = [];
    if (response) {
      console.log('[renderJobs] Response type:', typeof response, 'Is array:', Array.isArray(response));
      // New API format: response has jobs and pagination properties
      if (response.jobs && Array.isArray(response.jobs)) {
        newJobs = response.jobs;
        if (response.pagination) {
          jobsPagination = response.pagination;
        }
        console.log('[renderJobs] Using response.jobs, length:', newJobs.length);
      } else if (Array.isArray(response)) {
        // Old format: response is directly an array
        newJobs = response;
        console.log('[renderJobs] Using response as array, length:', newJobs.length);
      } else if (Array.isArray(response.data)) {
        // Alternative format: response.data is an array
        newJobs = response.data;
        console.log('[renderJobs] Using response.data, length:', newJobs.length);
      } else {
        console.warn('[renderJobs] Unexpected response format:', response);
      }
    } else {
      console.warn('[renderJobs] No response received');
    }
    
    console.log('[renderJobs] newJobs is array:', Array.isArray(newJobs), 'length:', newJobs.length);
    
    const pagination = (response && response.pagination) || jobsPagination || { hasMore: false };
    
    // Ensure allLoadedJobs is always an array
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('[renderJobs] allLoadedJobs was not an array, resetting');
      allLoadedJobs = [];
    }
    
    // Ensure newJobs is an array before spreading
    if (!Array.isArray(newJobs)) {
      console.warn('[renderJobs] newJobs was not an array, resetting');
      newJobs = [];
    }
    
    // Append new jobs to existing list
    allLoadedJobs = [...allLoadedJobs, ...newJobs];
    console.log('[renderJobs] allLoadedJobs after append, length:', allLoadedJobs.length, 'is array:', Array.isArray(allLoadedJobs));
    jobsPagination = pagination;

    // Filter by status (client-side) - ensure filteredJobs is always an array
    // Double-check allLoadedJobs is an array before filtering
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('allLoadedJobs is not an array, resetting to empty array');
      allLoadedJobs = [];
    }
    
    let filteredJobs = allLoadedJobs;
    if (activeJobsStatusFilter === "all") {
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => j.status !== "COMPLETED") : [];
    } else if (activeJobsStatusFilter) {
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => j.status === activeJobsStatusFilter) : [];
    }
    
    // Final safety check
    if (!Array.isArray(filteredJobs)) {
      console.warn('filteredJobs is not an array, resetting to empty array');
      filteredJobs = [];
    }

    // Get user role for card title
    let role = null;
    try {
      if (window.hustlAPI && window.hustlAPI.auth) {
        const user = await window.hustlAPI.auth.getCurrentUser();
        role = user?.roles?.[0] || null;
      }
    } catch (e) {
      console.error("Error getting user role:", e);
    }
    
    // Update card title
    let cardTitle = "Jobs near you";
    if (role === "CUSTOMER" || role === "customer") cardTitle = "Your jobs & local jobs";
    if (role === "HUSTLER" || role === "hustler") cardTitle = "Jobs you can apply for";
    if (jobsCardTitle) jobsCardTitle.textContent = cardTitle;

    // Update summary
    if (jobsFilterSummary) {
      jobsFilterSummary.textContent = filteredJobs.length === 0 
        ? "No jobs yet." 
        : `Showing ${filteredJobs.length} job(s)${pagination.total ? ` of ${pagination.total}` : ''}`;
    }

    if (filteredJobs.length === 0 && currentJobsPage === 1) {
      if (jobsList) jobsList.innerHTML = "<div class='muted'>No jobs found.</div>";
      return;
    }

    // Render each job card (only new ones if not resetting)
    filteredJobs.forEach((job) => {
      // Check if job card already exists
      if (!reset) {
        const existingCard = jobsList?.querySelector(`[data-job-id="${job.id}"]`);
        if (existingCard) return; // Skip if already rendered
      }

      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      // Top row: title and pay
      const titleRow = document.createElement("div");
      titleRow.className = "job-card-top";
      const titleEl = document.createElement("div");
      titleEl.className = "job-title";
      titleEl.textContent = job.title;
      titleRow.appendChild(titleEl);

      const pay = document.createElement("div");
      pay.className = "job-title";

      if (job.payType === "flat") {
        const total = job.amount || 0;
        pay.textContent = `$${total.toFixed(2)}`;
      } else {
        const hr = job.hourlyRate || 0;
        const maxH = job.estHours || 0;
        pay.textContent = `$${hr.toFixed(2)}/hr ¬∑ max ${maxH}h`;
      }
      titleRow.appendChild(pay);
      card.appendChild(titleRow);

      // Category + time
      const meta = document.createElement("div");
      meta.className = "job-meta";

      const cat =
        job.category === "moving"
          ? "üöö moving"
          : job.category === "yard"
          ? "üåø yard"
          : job.category === "cleaning"
          ? "üßπ cleaning"
          : job.category === "furniture"
          ? "üõ† furniture"
          : "‚≠ê other";

      const createdMs = job.createdAt
        ? new Date(job.createdAt).getTime()
        : Date.now();

      meta.textContent = `${cat} ‚Ä¢ posted ${timeAgo(createdMs)}`;
      card.appendChild(meta);

      // Location line
      const loc = document.createElement("div");
      loc.className = "job-meta";

      const requirements = job.requirements || {};
      if (requirements.onSiteOnly || job.onSiteOnly) {
        loc.textContent = `üìç ${requirements.pickupArea || requirements.pickupCity || job.address || "TBD"} ‚Ä¢ On-site only`;
      } else {
        const pick = requirements.pickupArea || requirements.pickupCity || "TBD";
        const drop = requirements.dropoffArea || requirements.dropoffCity || "TBD";
        loc.textContent = `üìç Pickup: ${pick} ‚Üí Dropoff: ${drop}`;
      }
      card.appendChild(loc);

      // Actions row
      const actions = document.createElement("div");
      actions.className = "job-card-actions";

      const left = document.createElement("div");
      const statusBadge = document.createElement("span");
      statusBadge.className = "badge";

      if (job.status === "OPEN" || job.status === "open") {
        statusBadge.classList.add("status-open");
        statusBadge.textContent = "Open";
      } else if (job.status === "ASSIGNED" || job.status === "assigned") {
        statusBadge.classList.add("status-assigned");
        statusBadge.textContent = "Assigned";
      } else if (job.status === "COMPLETED" || job.status === "completed") {
        statusBadge.classList.add("status-completed");
        statusBadge.style.backgroundColor = "#9333ea";
        statusBadge.style.color = "#ffffff";
        statusBadge.textContent = "‚úì Completed!";
      } else {
        statusBadge.textContent = job.status || "Open";
      }

      left.appendChild(statusBadge);
      actions.appendChild(left);

      const right = document.createElement("div");
      const viewBtn = document.createElement("button");
      viewBtn.className = "small-btn outline";
      viewBtn.textContent = "View";
      viewBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openJobDetails(job.id);
      });
      right.appendChild(viewBtn);
      actions.appendChild(right);

      card.appendChild(actions);

      // Clicking the whole card opens details
      card.addEventListener("click", () => openJobDetails(job.id));

      if (jobsList) jobsList.appendChild(card);    });

    // Add "Load More" button if there are more pages
    const existingLoadMore = jobsList?.querySelector("#loadMoreJobsBtn");
    if (existingLoadMore) {
      existingLoadMore.remove();
    }

    if (pagination.hasMore && jobsList) {
      const loadMoreBtn = document.createElement("button");
      loadMoreBtn.id = "loadMoreJobsBtn";
      loadMoreBtn.className = "btn btn-primary";
      loadMoreBtn.style.width = "100%";
      loadMoreBtn.style.marginTop = "1rem";
      loadMoreBtn.textContent = "Load More Jobs";
      loadMoreBtn.addEventListener("click", async () => {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = "Loading...";
        currentJobsPage++;
        await renderJobs(false); // Don't reset, just append
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = "Load More Jobs";
      });
      jobsList.appendChild(loadMoreBtn);
    }

  } catch (error) {
    console.error("Error loading jobs:", error);
    if (jobsList) {
      jobsList.innerHTML = "<div class='muted'>Error loading jobs. Please try again.</div>";
    }
  }
}

    function openJobDetails(jobId, options = {}) {
      const job = state.jobs.find((j) => j.id === jobId);
      const container = document.getElementById("jobDetailContainer");
      const user = getCurrentUser();
      if (!job || !container) return;

      container.innerHTML = "";
      const detail = document.createElement("div");
      detail.className = "job-detail job-detail-contrast";


      const headerRow = document.createElement("div");
      headerRow.className = "detail-row";
      const title = document.createElement("div");
      title.innerHTML =
        "<strong>" +
        job.title +
        "</strong><br><span class='muted'>" +
        (job.category === "moving"
          ? "üöö moving / hauling"
          : job.category === "yard"
          ? "üåø yard / outdoor"
          : job.category === "cleaning"
          ? "üßπ cleaning / organizing"
          : job.category === "furniture"
          ? "üõ† furniture / setup"
          : "‚≠ê other") +
        " ‚Ä¢ " +
        (job.paymentType === "flat"
          ? formatMoney(job.flatAmount || 0) + " flat"
          : formatMoney(job.hourlyRate || 0) +
            "/hr ¬∑ max " +
            (job.maxHours || 0) +
            "h") +
        " ‚Ä¢ posted " +
        timeAgo(job.createdAt) +
        "</span>";
      headerRow.appendChild(title);

      const closeBtn = document.createElement("button");
      closeBtn.className = "small-btn outline";
      closeBtn.textContent = "Close";
      closeBtn.addEventListener("click", () => {
        container.innerHTML = "";
      });
      headerRow.appendChild(closeBtn);
      detail.appendChild(headerRow);

      const whoRow = document.createElement("div");
      whoRow.className = "detail-row";

      // Posted by (clickable profile)
      const left = document.createElement("div");
      const poster = state.users.find((u) => u.id === job.postedByUserId);
      const postedByWrap = document.createElement("div");
      postedByWrap.innerHTML = "<div class='detail-label'>Posted by</div>";
      const postedVal = document.createElement("div");
      postedVal.className = "detail-value";
      if (poster) {
        const link = document.createElement("span");
        link.className = "linkish";
        link.textContent = poster.name || "Unknown";
        link.addEventListener("click", () => openUserProfile(poster.id));
        postedVal.appendChild(link);
      } else {
        postedVal.textContent = "Unknown";
      }
      left.appendChild(postedByWrap);
      left.appendChild(postedVal);
      whoRow.appendChild(left);

           const right = document.createElement("div");
      let statusText =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";

      if (job.paymentStatus === "paid") {
        statusText += " ¬∑ Paid";
      }

      let statusHtml =
        "<div class='detail-label'>Status</div><div class='detail-value'>" +
        statusText +
        "</div>";

      if (job.status === "completed") {
        if (job.autoCompleted) {
          statusHtml +=
            "<div class='muted'>Job was auto-completed after no response from the customer.</div>";
        } else {
          statusHtml +=
            "<div class='muted'>Job marked done by the customer.</div>";
        }
      }

      right.innerHTML = statusHtml;
      whoRow.appendChild(right);
      detail.appendChild(whoRow);

      const locRow = document.createElement("div");
      locRow.className = "detail-row";
      const locLeft = document.createElement("div");
      locLeft.innerHTML =
        "<div class='detail-label'>Pickup</div><div class='detail-value'>" +
        (job.pickupArea || job.pickupCity || "TBD") +
        "</div>";
      locRow.appendChild(locLeft);

      const locRight = document.createElement("div");
      locRight.innerHTML =
        "<div class='detail-label'>Dropoff</div><div class='detail-value'>" +
        (job.onSiteOnly
          ? "On-site only"
          : job.dropoffArea || job.dropoffCity || "TBD") +
        "</div>";
      locRow.appendChild(locRight);
      detail.appendChild(locRow);

      const desc = document.createElement("div");
      desc.className = "muted";
      desc.style.marginTop = "0.35rem";
      desc.textContent = job.description || "";
      detail.appendChild(desc);

      if (job.notes) {
        const notesEl = document.createElement("div");
        notesEl.className = "muted";
        notesEl.style.marginTop = "0.25rem";
        notesEl.textContent = "Notes: " + job.notes;
        detail.appendChild(notesEl);
      }

      // Info when Hustler has marked job finished
      if (job.completionRequestedAt && job.status === "assigned" && !job.dispute) {
        const compInfo = document.createElement("div");
        compInfo.className = "muted";
        compInfo.style.marginTop = "0.25rem";
        compInfo.textContent =
          "Hustler marked this job as finished " +
          timeAgo(job.completionRequestedAt) +
          ". Waiting for the customer to confirm or report a problem.";
        detail.appendChild(compInfo);
      }

      // Dispute box (if any issue has been reported)
      if (job.dispute) {
        const dBox = document.createElement("div");
        dBox.className = "stat-card";
        dBox.style.marginTop = "0.4rem";
        const who =
          job.dispute.openedBy === "hustler"
            ? "Hustler"
            : "Customer";
        let html =
          "<div class='stat-label'>Issue reported</div>" +
          "<div class='muted'>" +
          who +
          " reported: " +
          (job.dispute.reason || "Issue") +
          "</div>";
        if (job.dispute.message) {
          html +=
            "<div class='muted' style='margin-top:0.2rem;'>" +
            job.dispute.message +
            "</div>";
        }
        dBox.innerHTML = html;
        detail.appendChild(dBox);
      }

            // Payment summary for customer
      if (user && user.id === job.postedByUserId) {
        const payBox = document.createElement("div");
        payBox.className = "stat-card";
        payBox.style.marginTop = "0.4rem";

        let total = 0;
        if (job.paymentType === "flat") {
          total = job.flatAmount || 0;
        } else {
          total = (job.hourlyRate || 0) * (job.maxHours || 0);
        }
        const platformPercent = 0.15;
        const platformFee = Math.round(total * platformPercent);
        const hustlerPayout = total - platformFee;

        let html =
          "<div class='stat-label'>Payment breakdown (demo)</div>" +
          "<div class='stat-value'>" +
          formatMoney(total) +
          " total</div>" +
          "<div class='muted'>Hustl fee (15%): " +
          formatMoney(platformFee) +
          " ¬∑ Hustler receives approx " +
          formatMoney(hustlerPayout) +
          "</div>";

        if (job.paymentStatus === "paid") {
          html +=
            "<div class='muted' style='margin-top:0.25rem;'>Marked as paid in this prototype only ‚Äì no real money moved.</div>";
        }

        payBox.innerHTML = html;
        detail.appendChild(payBox);

        if (
          job.status === "assigned" &&
          job.paymentStatus !== "paid" &&
          job.acceptedHustlerId
        ) {
          const btnRow = document.createElement("div");
          btnRow.style.marginTop = "0.4rem";
          const payBtn = document.createElement("button");
          payBtn.className = "btn btn-primary";
          payBtn.textContent = "Pay & lock in this job (Stripe test)";
          payBtn.addEventListener("click", () => startPayment(job.id));
          btnRow.appendChild(payBtn);

            const hustlerInfo = document.createElement("div");
            const hustlerName = document.createElement("div");
            hustlerName.style.fontWeight = "600";
            hustlerName.style.fontSize = "1rem";
            hustlerName.textContent = offer.hustler?.name || offer.hustler?.username || "Hustler";
            hustlerInfo.appendChild(hustlerName);

            // Rating if available - show prominently
            const ratingRow = document.createElement("div");
            ratingRow.style.display = "flex";
            ratingRow.style.alignItems = "center";
            ratingRow.style.gap = "0.5rem";
            ratingRow.style.marginTop = "0.25rem";
            
            if (offer.hustler?.ratingAvg) {
              const ratingStars = document.createElement("span");
              ratingStars.style.fontSize = "0.95rem";
              ratingStars.style.fontWeight = "600";
              ratingStars.style.color = "#f59e0b";
              const ratingValue = offer.hustler.ratingAvg.toFixed(1);
              const maxRating = 5;
              ratingStars.textContent = `‚òÖ ${ratingValue} / ${maxRating}`;
              ratingRow.appendChild(ratingStars);
              
              if (offer.hustler.ratingCount) {
                const ratingCount = document.createElement("span");
                ratingCount.className = "muted";
                ratingCount.style.fontSize = "0.85rem";
                ratingCount.textContent = `(${offer.hustler.ratingCount} review${offer.hustler.ratingCount !== 1 ? 's' : ''})`;
                ratingRow.appendChild(ratingCount);
              }
            } else {
              const noRating = document.createElement("span");
              noRating.className = "muted";
              noRating.style.fontSize = "0.85rem";
              noRating.textContent = "No ratings yet";
              ratingRow.appendChild(noRating);
            }
            hustlerInfo.appendChild(ratingRow);

            headerRow.appendChild(hustlerInfo);

            // Status badge
            const statusBadge = document.createElement("span");
            statusBadge.className = "badge";
            const offerStatus = (offer.status || "PENDING").toUpperCase();
            if (offerStatus === "ACCEPTED") {
              statusBadge.classList.add("status-assigned");
              statusBadge.textContent = "Accepted";
            } else if (offerStatus === "DECLINED") {
              statusBadge.style.background = "#fee2e2";
              statusBadge.style.color = "#991b1b";
              statusBadge.textContent = "Declined";
            } else {
              statusBadge.classList.add("status-open");
              statusBadge.textContent = "Pending";
            }
            headerRow.appendChild(statusBadge);
            offerCard.appendChild(headerRow);

            // Show proposed amount if different from job amount
            if (offer.proposedAmount && offer.proposedAmount !== Number(job.amount)) {
              const proposedAmountDiv = document.createElement("div");
              proposedAmountDiv.style.marginTop = "0.5rem";
              proposedAmountDiv.style.padding = "0.5rem";
              proposedAmountDiv.style.background = "#fef3c7";
              proposedAmountDiv.style.borderRadius = "4px";
              proposedAmountDiv.style.fontSize = "0.9rem";
              proposedAmountDiv.style.fontWeight = "600";
              const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
              const originalAmount = Number(job.amount);
              proposedAmountDiv.innerHTML = `
                <div>üí∞ Proposed Amount: $${Number(offer.proposedAmount).toFixed(2)}</div>
                <div class="muted" style="font-size: 0.85rem; margin-top: 0.25rem;">Original: $${originalAmount.toFixed(2)}${teamSize > 1 && job.payType === "hourly" ? ` (${teamSize} people)` : ""}</div>
              `;
              offerCard.appendChild(proposedAmountDiv);
            }

            if (offer.note) {
              const note = document.createElement("div");
              note.className = "muted";
              note.style.marginTop = "0.5rem";
              note.style.padding = "0.5rem";
              note.style.background = "#f9fafb";
              note.style.borderRadius = "4px";
              note.style.fontSize = "0.9rem";
              note.textContent = offer.note;
              offerCard.appendChild(note);
            }

            const actionsRow = document.createElement("div");
            actionsRow.style.display = "flex";
            actionsRow.style.flexDirection = "column";
            actionsRow.style.gap = "0.5rem";
            actionsRow.style.marginTop = "0.75rem";

            // View Profile button (optional - not required)
            const viewProfileBtn = document.createElement("button");
            viewProfileBtn.className = "small-btn outline";
            viewProfileBtn.textContent = "View Profile & Reviews";
            viewProfileBtn.style.width = "100%";
            viewProfileBtn.addEventListener("click", () => {
              openUserProfile(offer.hustlerId);
            });
            actionsRow.appendChild(viewProfileBtn);

            // Accept/Decline buttons (only if pending)
            let payAndAcceptBtn = null;
            if (offer.status === "PENDING" && job.status === "OPEN" && !job.hustlerId) {
              payAndAcceptBtn = document.createElement("button");
              payAndAcceptBtn.className = "small-btn btn-primary";
              payAndAcceptBtn.textContent = "Pay & Accept";
              payAndAcceptBtn.style.width = "100%";
              
              payAndAcceptBtn.addEventListener("click", async () => {
                // Show payment modal first - payment must complete before accepting
                overlay.remove();
                document.body.style.overflow = "";
                
                // Show payment modal - on success, it will accept the offer
                setTimeout(async () => {
                  await showPaymentModal(job.id, offer.id);
                }, 500);
              });
              actionsRow.appendChild(payAndAcceptBtn);

              const declineBtn = document.createElement("button");
              declineBtn.className = "small-btn";
              declineBtn.style.background = "#fee2e2";
              declineBtn.style.color = "#991b1b";
              declineBtn.style.width = "100%";
              declineBtn.textContent = "Decline";
              declineBtn.addEventListener("click", async () => {
                if (!confirm("Decline this application?")) return;
                declineBtn.disabled = true;
                declineBtn.textContent = "Declining...";
                try {
                  await window.hustlAPI.offers.decline(offer.id);
                  showToast("Application declined.");
                  overlay.remove();
                  document.body.style.overflow = "";
                  renderJobs();
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to decline"));
                  declineBtn.disabled = false;
                  declineBtn.textContent = "Decline";
                }
              });
              actionsRow.appendChild(declineBtn);
            }

            offerCard.appendChild(actionsRow);
            applicantsSection.appendChild(offerCard);
          });
        }

        content.appendChild(applicantsSection);
      }

      // Show application count for hustlers (before apply section)
      if (user && userMode === "hustler" && job.status === "OPEN" && job.customerId !== user.id) {
        // Get application count
        const applicationCount = job._count?.offers || 0;
        if (applicationCount > 0) {
          const countSection = document.createElement("div");
          countSection.style.marginTop = "1.5rem";
          countSection.style.padding = "0.75rem";
          countSection.style.background = "#f0f9ff";
          countSection.style.borderRadius = "8px";
          countSection.style.border = "1px solid #bae6fd";
          countSection.style.textAlign = "center";
          
          const countText = document.createElement("div");
          countText.style.fontSize = "1rem";
          countText.style.fontWeight = "600";
          countText.style.color = "#1e40af";
          countText.innerHTML = `üë• <span>${applicationCount} ${applicationCount === 1 ? 'person has' : 'people have'} applied for this job</span>`;
          countSection.appendChild(countText);
          
          content.appendChild(countSection);
        }
      }

      // Hustler View: Apply to Job (if open and not already applied/accepted)
      if (user && userMode === "hustler" && job.status === "OPEN" && job.customerId !== user.id) {
        // Check if user already applied
        let userOffer = null;
        let allOffers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const response = await fetch(`/offers/${jobId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (response.ok) {
            const offersData = await response.json();
            allOffers = Array.isArray(offersData) ? offersData : [];
            userOffer = allOffers.find(o => o.hustlerId === user?.id);
          }
        } catch (error) {
          console.error("Error fetching offers:", error);
        }

        const applySection = document.createElement("div");
        applySection.style.marginTop = "1.5rem";
        applySection.style.padding = "1rem";
        applySection.style.background = "#f0f9ff";
        applySection.style.borderRadius = "8px";
        applySection.style.border = "1px solid #bae6fd";

        if (userOffer) {
          const appliedTitle = document.createElement("h3");
          appliedTitle.style.margin = "0 0 0.5rem 0";
          appliedTitle.style.fontSize = "1.1rem";
          appliedTitle.textContent = "You've Applied";
          applySection.appendChild(appliedTitle);

          const appliedStatus = document.createElement("div");
          appliedStatus.className = "muted";
          appliedStatus.style.marginBottom = "0.5rem";
          const offerStatus = (userOffer.status || "PENDING").toUpperCase();
          if (offerStatus === "ACCEPTED") {
            appliedStatus.textContent = "‚úì Your application was accepted!";
            appliedStatus.style.color = "#059669";
          } else if (offerStatus === "DECLINED") {
            appliedStatus.textContent = "Your application was declined.";
            appliedStatus.style.color = "#dc2626";
          } else {
            appliedStatus.textContent = "Your application is pending customer review.";
          }
          applySection.appendChild(appliedStatus);

          if (userOffer.note) {
            const note = document.createElement("div");
            note.style.marginTop = "0.5rem";
            note.style.padding = "0.75rem";
            note.style.background = "#fff";
            note.style.borderRadius = "6px";
            note.style.fontSize = "0.9rem";
            note.textContent = userOffer.note;
            applySection.appendChild(note);
          }
          
          // Add message button if accepted
          if (offerStatus === "ACCEPTED" && job.customerId) {
            const messageBtn = document.createElement("button");
            messageBtn.className = "btn btn-primary";
            messageBtn.style.marginTop = "0.75rem";
            messageBtn.style.width = "100%";
            messageBtn.textContent = "üí¨ Message Customer";
            messageBtn.addEventListener("click", () => {
              // Set active conversation and switch to messages view
              activeConversationJobId = job.id;
              overlay.remove();
              document.body.style.overflow = "";
              setView("messages");
              // Small delay to ensure messages view is rendered
              setTimeout(() => {
                renderMessagesView();
              }, 100);
            });
            applySection.appendChild(messageBtn);
          }
        } else {
          const applyTitle = document.createElement("h3");
          applyTitle.style.margin = "0 0 1rem 0";
          applyTitle.style.fontSize = "1.1rem";
          applyTitle.textContent = "Apply for this Job";
          applySection.appendChild(applyTitle);

          // Show job amount and allow negotiation
          const jobAmountDisplay = document.createElement("div");
          jobAmountDisplay.style.marginBottom = "0.75rem";
          jobAmountDisplay.style.padding = "0.75rem";
          jobAmountDisplay.style.background = "#fff";
          jobAmountDisplay.style.borderRadius = "6px";
          jobAmountDisplay.style.border = "1px solid var(--border)";
          
          const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
          const originalAmount = job.payType === "flat" 
            ? Number(job.amount || 0)
            : (Number(job.hourlyRate || 0) * Number(job.estHours || 0) * teamSize);
          
          let amountDescription = "";
          if (job.payType === "hourly") {
            const hourlyRate = Number(job.hourlyRate || 0);
            const estHours = job.estHours || 0;
            if (teamSize > 1) {
              amountDescription = `$${hourlyRate.toFixed(2)}/hr per person (${teamSize} people) ¬∑ max ${estHours}h`;
            } else {
              amountDescription = `$${hourlyRate.toFixed(2)}/hr ¬∑ max ${estHours}h`;
            }
          } else {
            amountDescription = `$${originalAmount.toFixed(2)}`;
          }
          
          jobAmountDisplay.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Job Amount: ${amountDescription}</div>
            <div class="muted" style="font-size: 0.85rem;">${job.payType === "hourly" ? "You can propose a different hourly rate if needed" : "You can propose a different amount if needed"}</div>
          `;
          applySection.appendChild(jobAmountDisplay);
          
          // Price negotiation field (optional)
          const negotiateContainer = document.createElement("div");
          negotiateContainer.style.marginBottom = "0.75rem";
          
          const negotiateCheckbox = document.createElement("input");
          negotiateCheckbox.type = "checkbox";
          negotiateCheckbox.id = "negotiatePrice";
          negotiateCheckbox.style.marginRight = "0.5rem";
          
          const negotiateLabel = document.createElement("label");
          negotiateLabel.htmlFor = "negotiatePrice";
          negotiateLabel.textContent = "Propose different amount";
          negotiateLabel.style.cursor = "pointer";
          
          negotiateContainer.appendChild(negotiateCheckbox);
          negotiateContainer.appendChild(negotiateLabel);
          applySection.appendChild(negotiateContainer);
          
          const proposedAmountField = document.createElement("input");
          proposedAmountField.type = "number";
          proposedAmountField.id = "proposedAmount";
          // For hourly jobs, show hourly rate placeholder; for flat, show total amount
          if (job.payType === "hourly") {
            proposedAmountField.placeholder = "Your proposed hourly rate ($/hr)";
            proposedAmountField.value = Number(job.hourlyRate || 0).toFixed(2);
          } else {
            proposedAmountField.placeholder = "Your proposed amount ($)";
            proposedAmountField.value = originalAmount.toFixed(2);
          }
          proposedAmountField.style.width = "100%";
          proposedAmountField.style.padding = "0.75rem";
          proposedAmountField.style.border = "1px solid var(--border)";
          proposedAmountField.style.borderRadius = "6px";
          proposedAmountField.style.display = "none";
          proposedAmountField.style.marginTop = "0.5rem";
          proposedAmountField.min = "0";
          proposedAmountField.step = "0.01";
          
          negotiateCheckbox.addEventListener("change", () => {
            proposedAmountField.style.display = negotiateCheckbox.checked ? "block" : "none";
          });
          applySection.appendChild(proposedAmountField);

          // Review Profile button (before note field)
          const reviewProfileBtn = document.createElement("button");
          reviewProfileBtn.className = "small-btn outline";
          reviewProfileBtn.textContent = "üë§ Review Customer Profile";
          reviewProfileBtn.style.width = "100%";
          reviewProfileBtn.style.marginBottom = "0.75rem";
          reviewProfileBtn.addEventListener("click", () => {
            openUserProfile(job.customerId);
          });
          applySection.appendChild(reviewProfileBtn);

          const noteField = document.createElement("textarea");
          noteField.id = "applyNoteField";
          noteField.placeholder = "Tell the customer why you're a good fit, when you can do it, if you have a truck, etc.";
          noteField.style.width = "100%";
          noteField.style.minHeight = "100px";
          noteField.style.padding = "0.75rem";
          noteField.style.border = "1px solid var(--border)";
          noteField.style.borderRadius = "6px";
          noteField.style.fontFamily = "inherit";
          noteField.style.fontSize = "0.9rem";
          noteField.style.marginBottom = "0.75rem";
          applySection.appendChild(noteField);

          const applyBtn = document.createElement("button");
          applyBtn.className = "btn btn-primary";
          applyBtn.textContent = "Apply as Hustler";
          applyBtn.style.width = "100%";
          applyBtn.style.minHeight = "48px"; // Better touch target
          applyBtn.style.fontSize = "1rem";
          applyBtn.style.fontWeight = "600";
          
          // Handle both click and touch events for better mobile support
          const handleApply = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // NOTE: We do NOT validate hustler's profile zip code
            // Hustlers can apply to any job in Tennessee, regardless of their profile location
            // The backend validates that the JOB is in Tennessee (via pickupZip)
            
            const note = noteField.value.trim();
            if (!note) {
              showToast("Please add a note explaining why you're a good fit.");
              noteField.focus();
              return;
            }

            // Get proposed amount if negotiating
            let proposedAmount = null;
            if (negotiateCheckbox.checked) {
              proposedAmount = parseFloat(proposedAmountField.value);
              if (isNaN(proposedAmount) || proposedAmount <= 0) {
                showToast("Please enter a valid proposed amount.");
                proposedAmountField.focus();
                return;
              }
            }
            
            // Disable button and show loading state
            applyBtn.disabled = true;
            applyBtn.style.opacity = "0.6";
            applyBtn.style.cursor = "not-allowed";
            applyBtn.textContent = "Applying...";

            try {
              const token = localStorage.getItem("hustl_token");
              if (!token) {
                showToast("You must be logged in to apply for jobs.");
                applyBtn.disabled = false;
                applyBtn.style.opacity = "1";
                applyBtn.style.cursor = "pointer";
                applyBtn.textContent = "Apply as Hustler";
                return;
              }
              
              console.log("Creating offer for job:", job.id, "with note:", note, "proposedAmount:", proposedAmount);
              
              const response = await fetch(`/offers/${job.id}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                  note,
                  proposedAmount: proposedAmount ? Number(proposedAmount) : null
                })
              });
              
              const result = await response.json();
              
              if (!response.ok) {
                throw new Error(result.error || `Failed to apply: ${response.statusText}`);
              }
              
              console.log("Offer created successfully:", result);
              // Show appropriate message based on job type
              if (job.payType === "hourly" && proposedAmount) {
                showToast(`‚úì Application submitted with proposed hourly rate of $${proposedAmount.toFixed(2)}/hr!`);
              } else if (proposedAmount) {
                showToast(`‚úì Application submitted with proposed amount of $${proposedAmount.toFixed(2)}!`);
              } else {
                showToast("‚úì Application submitted!");
              }
              
              // Small delay before closing to show success
              setTimeout(() => {
                overlay.remove();
                document.body.style.overflow = "";
                renderJobs();
              }, 500);
            } catch (error) {
              console.error("Error applying for job:", error);
              let errorMsg = error.message || error.toString() || "Failed to apply. Please try again.";
              
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // Check if it's a Stripe requirement error
              /*
              if \(errorMsg.includes\("Stripe"\) \|\| errorMsg.includes\("stripe"\) \|\| error\.requiresStripe\) \{
                errorMsg = "You must connect your Stripe account before applying to jobs. Go to your Profile to set it up.";
                showToast\("√¢≈°¬†√Ø¬∏¬è " + errorMsg, 5000\);
                // Close modal and redirect to profile after a moment
                setTimeout\(\(\) => \{
                  overlay\.remove\(\);
                  document\.body\.style\.overflow = "";
                  setView\("profile"\);
                  renderAll\(\);
                  // Scroll to Stripe section
                  setTimeout\(\(\) => \{
                    const stripeSection = document\.querySelector\('\[id\*="stripe"\], \[class\*="stripe"\]'\);
                    if \(stripeSection\) \{
                      stripeSection\.scrollIntoView\(\{ behavior: "smooth", block: "center" \}\);
                    \}
                  \}, 500\);
                \}, 2000\);
                applyBtn\.disabled = false;
                applyBtn\.style\.opacity = "1";
                applyBtn\.style\.cursor = "pointer";
                applyBtn\.textContent = "Apply as Hustler";
                return;
              \}
              \*/
              
              // TEMPORARY: Just show error without Stripe redirect
              }
              */
              
              // TEMPORARY: Just show error without Stripe redirect
              showToast("Error: " + errorMsg);
              
              applyBtn.disabled = false;
              applyBtn.style.opacity = "1";
              applyBtn.style.cursor = "pointer";
              applyBtn.textContent = "Apply as Hustler";
            }
          };
          
          applyBtn.addEventListener("click", handleApply);
          applyBtn.addEventListener("touchend", handleApply); // Mobile touch support
          applySection.appendChild(applyBtn);
        }

        content.appendChild(applySection);
      }

      // Hustler View: Show Customer Profile if Accepted
      if (user && user.id === job.hustlerId && userMode === "hustler" && job.status !== "OPEN") {
        const customerSection = document.createElement("div");
        customerSection.style.marginTop = "1.5rem";
        customerSection.style.padding = "1rem";
        customerSection.style.background = "#f9fafb";
        customerSection.style.borderRadius = "8px";

        const customerTitle = document.createElement("h3");
        customerTitle.style.margin = "0 0 1rem 0";
        customerTitle.style.fontSize = "1.1rem";
        customerTitle.textContent = "Customer";
        customerSection.appendChild(customerTitle);

        // Fetch customer info
        if (job.customer) {
          const customerCard = document.createElement("div");
          customerCard.style.padding = "0.75rem";
          customerCard.style.background = "#fff";
          customerCard.style.borderRadius = "6px";

          const customerName = document.createElement("div");
          customerName.style.fontWeight = "600";
          customerName.textContent = job.customer.name || job.customer.username || "Customer";
          customerCard.appendChild(customerName);

          if (job.customer.email) {
            const email = document.createElement("div");
            email.className = "muted";
            email.style.marginTop = "0.25rem";
            email.textContent = job.customer.email;
            customerCard.appendChild(email);
          }

          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "small-btn";
          viewProfileBtn.style.marginTop = "0.5rem";
          viewProfileBtn.textContent = "View Profile";
          viewProfileBtn.addEventListener("click", () => {
            // TODO: Open customer profile modal
            showToast("Profile view coming soon!");
          });
          customerCard.appendChild(viewProfileBtn);

          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-primary";
          messageBtn.style.marginTop = "0.5rem";
          messageBtn.style.width = "100%";
          messageBtn.textContent = "üí¨ Message Customer";
          messageBtn.addEventListener("click", () => {
            // Set active conversation and switch to messages view
            activeConversationJobId = job.id;
            overlay.remove();
            document.body.style.overflow = "";
            setView("messages");
            // Small delay to ensure messages view is rendered
            setTimeout(() => {
              renderMessagesView();
            }, 100);
          });
          customerCard.appendChild(messageBtn);

          customerSection.appendChild(customerCard);
        }

        content.appendChild(customerSection);
      }

      // Action Buttons Section
      const actionsSection = document.createElement("div");
      actionsSection.style.marginTop = "1.5rem";
      actionsSection.style.paddingTop = "1.5rem";
      actionsSection.style.borderTop = "1px solid var(--border)";

      // Customer Actions: Payment, Delete/Cancel job
      if (user && user.id === job.customerId && userMode === "customer") {
        // Show accepted hustler info if one is assigned
        if (job.hustlerId && job.hustler) {
          const hustlerInfo = document.createElement("div");
          hustlerInfo.style.marginBottom = "1rem";
          hustlerInfo.style.padding = "1rem";
          hustlerInfo.style.background = "#dcfce7";
          hustlerInfo.style.borderRadius = "8px";
          hustlerInfo.style.border = "1px solid #86efac";
          
          const statusUpper = (job.status || "").toUpperCase();
          let statusText = "";
          // Simplified status messages
          if (statusUpper === "ASSIGNED") {
            statusText = "Job is assigned. Share the start code with your hustler to begin.";
          } else if (statusUpper === "PAID") {
            statusText = "Job is in progress. The hustler will mark it complete when done.";
          } else if (statusUpper === "COMPLETED_BY_HUSTLER" || statusUpper === "AWAITING_CUSTOMER_CONFIRM") {
            statusText = "Hustler marked job as complete. Please confirm completion.";
          } else {
            statusText = "Job status: " + (statusUpper === "OPEN" ? "Open" : statusUpper === "CANCELLED" ? "Cancelled" : statusUpper);
          }
          
          // Check for hustler status update
          // requirements already declared above at line 4066, reuse it
          const hustlerStatus = requirements.hustlerStatus;
          const statusUpdatedAt = requirements.hustlerStatusUpdatedAt;
          
          let statusUpdateDisplay = "";
          if (hustlerStatus) {
            const statusMessages = {
              on_the_way: "üöó On the way",
              starting: "üèÅ Starting the job",
              almost_done: "‚ö° Almost done",
              just_finished: "‚úÖ Just finished",
            };
            const statusMsg = statusMessages[hustlerStatus] || hustlerStatus;
            const updatedTime = statusUpdatedAt ? timeAgo(new Date(statusUpdatedAt).getTime()) : "recently";
            statusUpdateDisplay = `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 4px; border: 1px solid #86efac;">
                <div style="font-weight: 600; font-size: 0.85rem; color: #059669; margin-bottom: 0.25rem;">üì± Hustler Status:</div>
                <div style="font-size: 0.9rem; color: #047857; font-weight: 600;">${statusMsg}</div>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Updated ${updatedTime}</div>
              </div>
            `;
          }
          
          // Show start code for customer (if job is ASSIGNED and not started yet)
          let startCodeDisplay = "";
          const startCode = requirements.startCode;
          // startCodeUsed already declared above at line 4067, reuse it
          
          if (statusUpper === "ASSIGNED" && startCode && !startCodeUsed) {
            startCodeDisplay = `
              <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dbeafe; border-radius: 6px; border: 2px solid #3b82f6;">
                <div style="font-weight: 600; font-size: 0.85rem; color: #1e40af; margin-bottom: 0.5rem;">üîê Start Code (Give to Hustler)</div>
                <div style="font-size: 1.5rem; font-weight: 700; letter-spacing: 0.2em; color: #1e40af; text-align: center; font-family: 'Courier New', monospace; margin: 0.5rem 0;">
                  ${startCode}
                </div>
                <div style="font-size: 0.75rem; color: #dc2626; text-align: center; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 4px; font-weight: 600;">
                  ‚ö†Ô∏è Important: Only give this code to the hustler when they arrive and the job is starting. Do not share it beforehand.
                </div>
                <div style="font-size: 0.75rem; color: #1e3a8a; text-align: center; margin-top: 0.25rem;">
                  Share this code with your hustler to officially start the job
                </div>
                <button id="regenerateStartCode_${job.id}" class="btn" style="width: 100%; margin-top: 0.5rem; background: #fff; color: #3b82f6; border: 1px solid #3b82f6; font-size: 0.8rem;">
                  üîÑ Regenerate Code
                </button>
              </div>
            `;
          }
          
          hustlerInfo.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #059669;">‚úì Hustler Assigned</div>
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
              <strong>${job.hustler.name || job.hustler.username || "Hustler"}</strong>
              ${job.hustler.ratingAvg > 0 ? ` ¬∑ ‚≠ê ${job.hustler.ratingAvg.toFixed(1)} (${job.hustler.ratingCount})` : ''}
            </div>
            <div style="font-size: 0.85rem; color: #047857;">
              ${statusText}
            </div>
            ${statusUpdateDisplay}
            ${startCodeDisplay}
          `;
          
          // Add message button for customer to message hustler
          const messageBtnRow = document.createElement("div");
          messageBtnRow.style.display = "flex";
          messageBtnRow.style.gap = "0.5rem";
          messageBtnRow.style.marginTop = "0.75rem";
          
          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-primary";
          messageBtn.style.flex = "1";
          messageBtn.textContent = "üí¨ Message Hustler";
          messageBtn.addEventListener("click", () => {
            // Set active conversation and switch to messages view
            activeConversationJobId = job.id;
            overlay.remove();
            document.body.style.overflow = "";
            setView("messages");
            // Small delay to ensure messages view is rendered
            setTimeout(() => {
              renderMessagesView();
            }, 100);
          });
          messageBtnRow.appendChild(messageBtn);
          
          // Add view profile button
          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "btn";
          viewProfileBtn.style.background = "#fff";
          viewProfileBtn.style.color = "#059669";
          viewProfileBtn.style.border = "1px solid #86efac";
          viewProfileBtn.style.flex = "1";
          viewProfileBtn.textContent = "View Profile & Reviews";
          viewProfileBtn.addEventListener("click", () => {
            overlay.remove();
            document.body.style.overflow = "";
            openUserProfile(job.hustlerId);
          });
          messageBtnRow.appendChild(viewProfileBtn);
          
          hustlerInfo.appendChild(messageBtnRow);
          actionsSection.appendChild(hustlerInfo);
          
          // Add regenerate start code button handler
          if (startCodeDisplay) {
            const regenerateBtn = document.getElementById(`regenerateStartCode_${job.id}`);
            if (regenerateBtn) {
              regenerateBtn.addEventListener("click", async () => {
                try {
                  const result = await window.hustlAPI.jobs.getStartCode(job.id, true);
                  showToast("‚úì Start code regenerated");
                  overlay.remove();
                  document.body.style.overflow = "";
                  openJobDetails(job.id);
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to regenerate code"));
                }
              });
            }
          }
        }
        
        // Check if payment is needed (job is assigned but payment not completed)
        const jobStatusCheck = (job.status || "").toUpperCase();
        if (job.hustlerId && (jobStatusCheck === "ASSIGNED" || jobStatusCheck === "OPEN")) {
          // Check payment status
          let paymentNeeded = false;
          let paymentStatus = null;
          try {
            const payment = await window.hustlAPI.payments.getByJobId(job.id);
            paymentStatus = payment?.status;
            if (!payment || payment.status === "PREAUTHORIZED") {
              paymentNeeded = true;
            }
          } catch (error) {
            // Payment might not exist yet, so payment is needed
            paymentNeeded = true;
          }
          
          if (paymentNeeded) {
            const payBtn = document.createElement("button");
            payBtn.className = "btn btn-primary";
            payBtn.textContent = "Complete Payment";
            payBtn.style.marginBottom = "0.5rem";
            payBtn.addEventListener("click", async () => {
              try {
                // For now, show message - payment flow will be implemented
                showToast("Payment processing will be available soon. The job is assigned and ready to proceed.");
              } catch (error) {
                showToast("Error: " + (error.message || "Cannot process payment"));
              }
            });
            actionsSection.appendChild(payBtn);
            
            const paymentNote = document.createElement("div");
            paymentNote.className = "muted";
            paymentNote.style.fontSize = "0.85rem";
            paymentNote.style.marginBottom = "0.5rem";
            paymentNote.textContent = "Complete payment to finalize the job assignment.";
            actionsSection.appendChild(paymentNote);
          }
        }
        
        // Customer confirmation when hustler marked job complete
        const customerStatusCheck = (job.status || "").toUpperCase();
        if ((customerStatusCheck === "COMPLETED_BY_HUSTLER" || customerStatusCheck === "AWAITING_CUSTOMER_CONFIRM") && user && user.id === job.customerId) {
          const confirmBanner = document.createElement("div");
          confirmBanner.style.padding = "1rem";
          confirmBanner.style.marginBottom = "1rem";
          confirmBanner.style.background = "#fef3c7";
          confirmBanner.style.borderRadius = "8px";
          confirmBanner.style.border = "2px solid #fbbf24";
          
          const bannerTitle = document.createElement("div");
          bannerTitle.style.fontWeight = "600";
          bannerTitle.style.fontSize = "1rem";
          bannerTitle.style.marginBottom = "0.5rem";
          bannerTitle.textContent = "‚úì Hustler marked job as complete!";
          confirmBanner.appendChild(bannerTitle);
          
          const bannerText = document.createElement("div");
          bannerText.style.fontSize = "0.9rem";
          bannerText.style.marginBottom = "0.75rem";
          bannerText.innerHTML = `
            <div style="margin-bottom: 0.5rem;">Please confirm that the job was completed to your satisfaction.</div>
            <div style="font-weight: 600; color: #059669;">Once you confirm, payment will be immediately released to the hustler.</div>
          `;
          confirmBanner.appendChild(bannerText);
          
          // Verification code input
          const verificationCode = job.requirements?.verificationCode;
          if (verificationCode) {
            const codeSection = document.createElement("div");
            codeSection.style.marginTop = "0.75rem";
            codeSection.style.marginBottom = "0.75rem";
            codeSection.style.padding = "0.75rem";
            codeSection.style.background = "#dbeafe";
            codeSection.style.borderRadius = "6px";
            codeSection.style.border = "1px solid #93c5fd";
            
            const codeLabel = document.createElement("div");
            codeLabel.style.fontSize = "0.85rem";
            codeLabel.style.fontWeight = "600";
            codeLabel.style.marginBottom = "0.5rem";
            codeLabel.textContent = "üîê Enter Verification Code:";
            codeSection.appendChild(codeLabel);
            
            const codeInput = document.createElement("input");
            codeInput.type = "text";
            codeInput.placeholder = "Enter 6-digit code from hustler";
            codeInput.maxLength = 6;
            codeInput.style.width = "100%";
            codeInput.style.padding = "0.75rem";
            codeInput.style.fontSize = "1.2rem";
            codeInput.style.textAlign = "center";
            codeInput.style.letterSpacing = "0.2em";
            codeInput.style.border = "2px solid #93c5fd";
            codeInput.style.borderRadius = "6px";
            codeInput.style.fontWeight = "600";
            codeInput.addEventListener("input", (e) => {
              e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
            });
            codeSection.appendChild(codeInput);
            
            const codeHint = document.createElement("div");
            codeHint.style.fontSize = "0.8rem";
            codeHint.style.marginTop = "0.5rem";
            codeHint.style.color = "#64748b";
            codeHint.textContent = "The hustler should have shared this code with you. It confirms you're both on the same page.";
            codeSection.appendChild(codeHint);
            
            confirmBanner.appendChild(codeSection);
            
            // Store code input for use in confirm button
            confirmBanner.codeInput = codeInput;
          }
          
          // Show completion photos only if there's an issue (optional)
          if (job.requirements && job.requirements.completionPhotos && job.requirements.completionPhotos.length > 0) {
            const photosDiv = document.createElement("div");
            photosDiv.style.marginTop = "0.75rem";
            photosDiv.style.marginBottom = "0.75rem";
            photosDiv.style.padding = "0.75rem";
            photosDiv.style.background = "#fff";
            photosDiv.style.borderRadius = "6px";
            photosDiv.style.border = "1px solid #e5e7eb";
            
            const photosLabel = document.createElement("div");
            photosLabel.style.fontSize = "0.85rem";
            photosLabel.style.fontWeight = "600";
            photosLabel.style.marginBottom = "0.5rem";
            photosLabel.textContent = "üì∏ Photos from hustler (optional):";
            photosDiv.appendChild(photosLabel);
            
            const photosGrid = document.createElement("div");
            photosGrid.style.display = "grid";
            photosGrid.style.gridTemplateColumns = "repeat(auto-fill, minmax(100px, 1fr))";
            photosGrid.style.gap = "0.5rem";
            
            job.requirements.completionPhotos.forEach(photoUrl => {
              const img = document.createElement("img");
              img.src = photoUrl;
              img.style.width = "100%";
              img.style.height = "100px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "4px";
              img.style.cursor = "pointer";
              img.addEventListener("click", () => {
                window.open(photoUrl, "_blank");
              });
              photosGrid.appendChild(img);
            });
            
            photosDiv.appendChild(photosGrid);
            confirmBanner.appendChild(photosDiv);
          }
          
          const buttonRow = document.createElement("div");
          buttonRow.style.display = "flex";
          buttonRow.style.gap = "0.5rem";
          
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "btn btn-primary";
          confirmBtn.style.flex = "1";
          confirmBtn.textContent = "‚úì Confirm & Release Payment";
          confirmBtn.addEventListener("click", async () => {
            const codeInput = confirmBanner.codeInput;
            let enteredCode = codeInput ? codeInput.value.trim() : null;
            
            // Remove any non-digit characters
            if (enteredCode) {
              enteredCode = enteredCode.replace(/\D/g, '');
            }
            
            if (verificationCode && (!enteredCode || enteredCode.length !== 6)) {
              showToast("Please enter the 6-digit verification code from the hustler.");
              if (codeInput) codeInput.focus();
              return;
            }
            
            if (!confirm("Confirm that the job was completed successfully? Payment will be released to the hustler.")) return;
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Confirming...";
            
            try {
              const result = await window.hustlAPI.jobs.confirmComplete(job.id, enteredCode);
              showToast("‚úì Job confirmed! Payment has been released to the hustler.");
              
              // Close the job details modal first
              overlay.remove();
              document.body.style.overflow = "";
              
              // Refresh jobs list and profile to show updated status (COMPLETED with purple badge)
              renderJobs();
              renderProfile();
              
              // Job is now COMPLETED - both parties can review each other
              // Show review modal for customer to review hustler
              if (job.hustlerId) {
                setTimeout(() => {
                  showReviewModal(job.id, job.hustlerId, job.hustler?.name || "Hustler");
                }, 300);
              }
              
              // Note: Hustler can also review customer - they'll see the option when they view the job
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to confirm completion"));
              confirmBtn.disabled = false;
              confirmBtn.textContent = "‚úì Confirm & Release Payment";
            }
          });
          buttonRow.appendChild(confirmBtn);
          
          // Report issue button
          const reportBtn = document.createElement("button");
          reportBtn.className = "btn";
          reportBtn.style.background = "#fee2e2";
          reportBtn.style.color = "#991b1b";
          reportBtn.style.border = "1px solid #fecaca";
          reportBtn.textContent = "‚ö† Report Issue";
          reportBtn.addEventListener("click", () => {
            const reason = prompt("What's the issue? (e.g., job not done, poor quality, wrong work)");
            if (reason) {
              showToast("Issue reported. Our team will review this. Payment is on hold until resolved.");
              // In production, this would call an API endpoint to create a dispute
            }
          });
          buttonRow.appendChild(reportBtn);
          
          confirmBanner.appendChild(buttonRow);
          actionsSection.appendChild(confirmBanner);
        }
        
        
        const canDelete = job.status === "OPEN" && !job.hustlerId;
        
        if (canDelete) {
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.style.marginLeft = "0.5rem";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          btnRow.appendChild(deleteBtn);

          detail.appendChild(btnRow);
        } else if (
          job.status === "open" &&
          job.paymentStatus !== "paid"
        ) {
          const deleteRow = document.createElement("div");
          deleteRow.style.marginTop = "0.4rem";
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          deleteRow.appendChild(deleteBtn);
          detail.appendChild(deleteRow);
        }
      }

            // Applicants & accept button (customer)
      if (user && user.id === job.postedByUserId) {
        const appsBox = document.createElement("div");
        appsBox.className = "stat-card";
        appsBox.style.marginTop = "0.5rem";

        if (!job.applicants || job.applicants.length === 0) {
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div><div class='muted'>No Hustlers have applied yet.</div>";
        } else {
          const hasAccepted = !!job.acceptedHustlerId;
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div>" +
            (hasAccepted
              ? "<div class='muted'>You‚Äôve already accepted a Hustler for this job.</div>"
              : "<div class='muted'>Tap accept to assign.</div>");

          job.applicants.forEach((a) => {
            const u = state.users.find((x) => x.id === a.userId);
            const isAccepted = job.acceptedHustlerId === a.userId;

            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.justifyContent = "space-between";
            row.style.alignItems = "center";
            row.style.marginTop = "0.25rem";
            row.style.gap = "0.4rem";

            const leftPart = document.createElement("div");

            // clickable name + role chip
            const line1 = document.createElement("div");
            const nameEl = document.createElement("span");
            nameEl.className = "linkish";
            nameEl.textContent = u?.name || "Unknown";
            if (u) {
              nameEl.addEventListener("click", () => openUserProfile(u.id));
            }
            line1.appendChild(nameEl);
            const roleChip = document.createElement("span");
            roleChip.className = "muted";
            roleChip.textContent =
              " ¬∑ " + (u?.role === "hustler" ? "Hustler" : "Customer");
            line1.appendChild(roleChip);

            const line2 = document.createElement("div");
            line2.className = "muted";
            line2.textContent =
              (a.message || "") +
              (a.suggestedPrice
                ? " ¬∑ suggested " + formatMoney(a.suggestedPrice)
                : "");

            const line3 = document.createElement("div");
            line3.className = "muted";
            line3.style.fontSize = "0.7rem";
            line3.style.marginTop = "0.1rem";
            line3.textContent = u?.bio
              ? "About: " + u.bio
              : "About: (no bio yet)";

            leftPart.appendChild(line1);
            leftPart.appendChild(line2);
            leftPart.appendChild(line3);
            row.appendChild(leftPart);

            const rightPart = document.createElement("div");

            if (isAccepted) {
              const badge = document.createElement("span");
              badge.className = "badge status-assigned";
              badge.textContent = "Hustler accepted";
              rightPart.appendChild(badge);
            } else if (!hasAccepted) {
              const acceptBtn = document.createElement("button");
              acceptBtn.className = "small-btn";
              acceptBtn.textContent = "Accept this Hustler";
              acceptBtn.addEventListener("click", () => {
                job.acceptedHustlerId = a.userId;
                job.status = "assigned";
                saveState();
                showToast("Hustler accepted for this job.");
                renderAll();
                openJobDetails(job.id);
              });
              rightPart.appendChild(acceptBtn);
            } else {
              const note = document.createElement("span");
              note.className = "muted";
              note.textContent = "Not selected";
              rightPart.appendChild(note);
            }

            row.appendChild(rightPart);
            appsBox.appendChild(row);
          });
        }
        detail.appendChild(appsBox);
      }


      // Apply area (hustler)
      if (
        user &&
        user.role === "hustler" &&
        job.status === "open" &&
        job.postedByUserId !== user.id
      ) {
        const already = job.applicants?.some((a) => a.userId === user.id);
        const applyBox = document.createElement("div");
        applyBox.className = "stat-card";
        applyBox.style.marginTop = "0.5rem";

        if (already) {
          applyBox.innerHTML =
            "<div class='stat-label'>Your application</div><div class='muted'>You‚Äôve already applied. Use job chat to send updates.</div>";
        } else {
          applyBox.innerHTML =
            "<div class='stat-label'>Apply for this job</div>";
          const msgField = document.createElement("textarea");
          msgField.placeholder =
            "Tell them when you can do it, if you have a truck, etc.";
          msgField.style.marginTop = "0.25rem";

          const priceField = document.createElement("input");
          priceField.type = "number";
          priceField.min = "0";
          priceField.step = "1";
          priceField.placeholder = "Suggested flat price (optional)";
          priceField.style.marginTop = "0.25rem";

          const btn = document.createElement("button");
          btn.className = "btn btn-primary";
          btn.style.marginTop = "0.4rem";
          btn.textContent = "Apply as a Hustler";
          btn.addEventListener("click", () => {
            const msg = msgField.value.trim();
            const suggestedPrice = Number(priceField.value) || null;
            job.applicants = job.applicants || [];
            job.applicants.push({
              userId: user.id,
              message: msg,
              suggestedPrice,
              createdAt: Date.now(),
            });
            saveState();
            showToast("Applied for job.");
            renderAll();
            openJobDetails(job.id);
          });

          applyBox.appendChild(msgField);
          applyBox.appendChild(priceField);
          applyBox.appendChild(btn);
        }

        detail.appendChild(applyBox);

        if (options.focusApply) {
          setTimeout(() => {
            applyBox.scrollIntoView({ behavior: "smooth" });
          }, 50);
        }
      }

      // Job chat
      const chatBox = document.createElement("div");
      chatBox.className = "chat-box";
      const messagesList = document.createElement("div");
      messagesList.className = "chat-messages";
      job.chatMessages = job.chatMessages || [];
      job.chatMessages.forEach((m) => {
        const msgEl = document.createElement("div");
        msgEl.className =
          "chat-msg " + (m.fromUserId === (user && user.id) ? "me" : "them");
        msgEl.textContent = m.text;
        messagesList.appendChild(msgEl);

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const sender = state.users.find((u) => u.id === m.fromUserId);
        meta.innerHTML = "";
        if (sender) {
          const link = document.createElement("span");
          link.className = "linkish";
          link.textContent = sender.name || "Unknown";
          link.addEventListener("click", () => openUserProfile(sender.id));
          meta.appendChild(link);
        } else {
          meta.append("Unknown");
        }
        meta.append(" ¬∑ " + timeAgo(m.createdAt));

        messagesList.appendChild(meta);
      });
      chatBox.appendChild(messagesList);

      const chatRow = document.createElement("div");
      chatRow.className = "chat-input-row";
      const chatInput = document.createElement("input");
      chatInput.type = "text";
      chatInput.placeholder =
        user && user.id
          ? "Type a quick update or question..."
          : "Log in to send messages.";
      if (!user) chatInput.disabled = true;

      const sendBtn = document.createElement("button");
      sendBtn.className = "btn btn-primary";
      sendBtn.textContent = "Send";
      if (!user) sendBtn.disabled = true;
      sendBtn.addEventListener("click", () => {
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        const txt = chatInput.value.trim();
        if (!txt) return;
        job.chatMessages.push({
          id: generateId("m"),
          jobId: job.id,
          fromUserId: user.id,
          text: txt,
          createdAt: Date.now(),
        });
        chatInput.value = "";
        saveState();
        openJobDetails(job.id);
      });

      chatRow.appendChild(chatInput);
      chatRow.appendChild(sendBtn);
      chatBox.appendChild(chatRow);

      detail.appendChild(chatBox);

      // Hustler actions around completion
      if (
        user &&
        job.status === "assigned" &&
        user.id === job.acceptedHustlerId
      ) {
        const hustlerRow = document.createElement("div");
        hustlerRow.style.marginTop = "0.45rem";

        if (!job.completionRequestedAt && !job.dispute) {
          const markFinishedBtn = document.createElement("button");
          markFinishedBtn.className = "small-btn";
          markFinishedBtn.textContent = "Mark job finished";
          markFinishedBtn.addEventListener("click", () => {
            job.completionRequestedAt = Date.now();
            job.completionRequesterId = user.id;
            job.autoCompleted = false;
            saveState();
            showToast("Marked finished. Customer will be asked to confirm or report a problem.");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(markFinishedBtn);
        } else if (job.completionRequestedAt && !job.dispute) {
          const nudge = document.createElement("div");
          nudge.className = "muted";
          nudge.style.marginBottom = "0.25rem";
          nudge.textContent =
            "Waiting for the customer to confirm. If it has been a while, you can flag an issue.";
          hustlerRow.appendChild(nudge);

          const disputeBtn = document.createElement("button");
          disputeBtn.className = "small-btn outline";
          disputeBtn.textContent = "Customer won‚Äôt confirm completion";
          disputeBtn.addEventListener("click", () => {
            const reason = prompt(
              "Briefly describe the issue (for example, 'Customer not responding')."
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "hustler",
              reason: reason || "Customer not confirming completion",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(disputeBtn);
        }

        if (hustlerRow.children.length > 0) {
          detail.appendChild(hustlerRow);
        }
      }

      // Complete / dispute buttons (customer)
      if (
        user &&
        user.id === job.postedByUserId &&
        job.status === "assigned"
      ) {
        const completeRow = document.createElement("div");
        completeRow.style.marginTop = "0.45rem";

        if (job.completionRequestedAt && !job.dispute) {
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "small-btn";
          confirmBtn.textContent = "Confirm completion";
          confirmBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(confirmBtn);

          const problemBtn = document.createElement("button");
          problemBtn.className = "small-btn outline";
          problemBtn.style.marginLeft = "0.4rem";
          problemBtn.textContent = "Problem with job";
          problemBtn.addEventListener("click", () => {
            const reason = prompt(
              "What went wrong? (e.g., not done, poor quality, other)"
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "customer",
              reason: reason || "Issue with job",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(problemBtn);
        } else if (!job.dispute) {
          const completeBtn = document.createElement("button");
          completeBtn.className = "small-btn";
          completeBtn.textContent = "Mark job complete";
          completeBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(completeBtn);
        }

        if (completeRow.children.length > 0) {
          detail.appendChild(completeRow);
        }
      }

      container.appendChild(detail);
    }
    // Demo-only: no real Stripe redirect handling in this prototype
    function handleStripeReturn() {
      // In a real app, you'd look at URL params from Stripe here.
      // For this demo, we do nothing so the rest of the app can run.
    }

   
    /* ---------- Messages view ---------- */

    function renderMessagesView() {
      const user = getCurrentUser();      const convList = document.getElementById("conversationList");
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      if (!convList) return;

      // Not logged in: nothing to show
      if (!user) {
        convList.innerHTML =
          "<div class='muted'>Log in to see your job conversations.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        return;
      }

      // Jobs that involve this user in ANY way
      const myJobs = state.jobs.filter(
        (j) =>
          j.postedByUserId === user.id ||
          j.acceptedHustlerId === user.id ||
          (j.applicants || []).some((a) => a.userId === user.id)
      );
      convList.innerHTML = "";

      if (myJobs.length === 0) {
        convList.innerHTML =
          "<div class='muted'>No jobs yet. Post or apply to a job to start messaging.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        return;
      }

      // If nothing is selected yet, auto-open the first job
      if (!activeConversationJobId) {
        activeConversationJobId = myJobs[0].id;
      }

      myJobs.forEach((job) => {
        const otherId =
          user.id === job.postedByUserId
            ? job.acceptedHustlerId
            : job.postedByUserId;
        const otherUser =
          otherId && state.users.find((u) => u.id === otherId);

        const item = document.createElement("div");
        item.className = "job-card";
        item.style.cursor = "pointer";
        item.dataset.jobId = job.id;

        // Highlight the active conversation
        if (job.id === activeConversationJobId) {
          item.style.borderColor = "#2563eb";
          item.style.boxShadow = "0 0 0 1px #2563eb20";
        }

        const top = document.createElement("div");
        top.className = "job-card-top";

        const title = document.createElement("div");
        title.className = "job-title";
        title.textContent = job.title;
        top.appendChild(title);

        const status = document.createElement("span");
        status.className = "badge";
        status.textContent =
          job.status === "open"
            ? "Open"
            : job.status === "assigned"
            ? "Assigned"
            : "Completed";
        top.appendChild(status);
        item.appendChild(top);

        const meta = document.createElement("div");
        meta.className = "job-meta";
        meta.textContent =
          (otherUser
            ? "With " + otherUser.name + " ¬∑ "
            : "Job chat ¬∑ ") + timeAgo(job.createdAt);
        item.appendChild(meta);

        // Archive/Delete buttons
        const actionsRow = document.createElement("div");
        actionsRow.style.display = "flex";
        actionsRow.style.gap = "0.5rem";
        actionsRow.style.marginTop = "0.5rem";
        actionsRow.style.justifyContent = "flex-end";
        
        // Archive/Unarchive button
        const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
        const isArchived = archived.includes(job.id);
        const archiveBtn = document.createElement("button");
        archiveBtn.className = "small-btn";
        archiveBtn.style.background = isArchived ? "#dbeafe" : "#f3f4f6";
        archiveBtn.style.color = isArchived ? "#1e40af" : "#6b7280";
        archiveBtn.style.padding = "0.25rem 0.5rem";
        archiveBtn.style.fontSize = "0.75rem";
        archiveBtn.textContent = isArchived ? "üì¶ Unarchive" : "üì¶ Archive";
        archiveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
          if (isArchived) {
            const index = archived.indexOf(job.id);
            if (index > -1) {
              archived.splice(index, 1);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation unarchived");
              renderMessagesView();
            }
          } else {
            if (!archived.includes(job.id)) {
              archived.push(job.id);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation archived");
              renderMessagesView();
            }
          }
        });
        actionsRow.appendChild(archiveBtn);
        
        // Delete/Restore button (available for all jobs)
        const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
        const isDeleted = deleted.includes(job.id);
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "small-btn";
        deleteBtn.style.background = isDeleted ? "#fecaca" : "#fee2e2";
        deleteBtn.style.color = "#991b1b";
        deleteBtn.style.padding = "0.25rem 0.5rem";
        deleteBtn.style.fontSize = "0.75rem";
        deleteBtn.textContent = isDeleted ? "‚Ü© Restore" : "üóë Delete";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
          if (isDeleted) {
            const index = deleted.indexOf(job.id);
            if (index > -1) {
              deleted.splice(index, 1);
              localStorage.setItem("deletedConversations", JSON.stringify(deleted));
              showToast("Conversation restored");
              renderMessagesView();
            }
          } else {
            if (confirm("Delete this conversation? This will hide it from your messages list. You can restore it later.")) {
              if (!deleted.includes(job.id)) {
                deleted.push(job.id);
                localStorage.setItem("deletedConversations", JSON.stringify(deleted));
                showToast("Conversation deleted");
                renderMessagesView();
              }
            }
          }
        });
        actionsRow.appendChild(deleteBtn);
        
        item.appendChild(actionsRow);

        item.addEventListener("click", () => {
          activeConversationJobId = job.id;
          // Re-render list (to update highlight) + right-hand chat
          renderMessagesView();
        });

        convList.appendChild(item);
      });

      // Finally, render the messages for the active conversation
      renderConversation();
    }



    function renderConversation() {
      const user = getCurrentUser();
      const job = state.jobs.find((j) => j.id === activeConversationJobId);
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      if (!job || !user) {
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        return;
      }

      convTitle.textContent = job.title;
      convSummary.textContent =
        (job.category === "moving"
          ? "üöö moving / hauling ¬∑ "
          : job.category === "yard"
          ? "üåø yard ¬∑ "
          : job.category === "cleaning"
          ? "üßπ cleaning ¬∑ "
          : job.category === "furniture"
          ? "üõ† furniture ¬∑ "
          : "‚≠ê other ¬∑ ") +
        (job.paymentType === "flat"
          ? formatMoney(job.flatAmount || 0) + " flat"
          : formatMoney(job.hourlyRate || 0) +
            "/hr ¬∑ max " +
            (job.maxHours || 0) +
            "h");
      convMessages.innerHTML = "";
      job.chatMessages = job.chatMessages || [];
      job.chatMessages.forEach((m) => {
        const bubble = document.createElement("div");
        bubble.className =
          "chat-msg " + (m.fromUserId === user.id ? "me" : "them");
        bubble.textContent = m.text;
        convMessages.appendChild(bubble);
        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const sender = state.users.find((u) => u.id === m.fromUserId);
        meta.innerHTML = "";
        if (sender) {
          const link = document.createElement("span");
          link.className = "linkish";
          link.textContent = sender.name || "Unknown";
          link.addEventListener("click", () => openUserProfile(sender.id));
          meta.appendChild(link);
        } else {
          meta.append("Unknown");
        }
        meta.append(" ¬∑ " + timeAgo(m.createdAt));

        convMessages.appendChild(meta);
      });
      convMessages.scrollTop = convMessages.scrollHeight;    }

    function initConversationInput() {
      const sendBtn = document.getElementById("conversationSendButton");
      const input = document.getElementById("conversationInput");
      sendBtn.addEventListener("click", () => {
        const user = getCurrentUser();
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        const job = state.jobs.find((j) => j.id === activeConversationJobId);
        if (!job) return;
        const text = input.value.trim();
        if (!text) return;
        job.chatMessages = job.chatMessages || [];
        job.chatMessages.push({
          id: generateId("m"),
          jobId: job.id,
          fromUserId: user.id,
          text,
          createdAt: Date.now(),
        });
        input.value = "";
        saveState();
        renderConversation();      });
    }

    /* ---------- Profile ---------- */

    function renderProfile() {
  const user = getCurrentUser();
  const container = document.getElementById("profileContent");
  const jobsList = document.getElementById("profileJobsList");
  if (!container || !jobsList) return;

  if (!user) {
    container.innerHTML =
      "<div class='muted'>Log in to see your profile.</div>";
    jobsList.innerHTML = "";
    return;
  }

  // figure out jobs related to this user
  const activeJobs = state.jobs.filter(
    (j) =>
      j.status !== "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );
  const completedJobs = state.jobs.filter(
    (j) =>
      j.status === "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );

  const totalEarned = state.jobs.reduce((sum, j) => {
    if (j.acceptedHustlerId === user.id && j.paymentStatus === "paid") {
      return sum + (j.hustlerPayoutAmount || 0);
    }
    return sum;
  }, 0);

  const totalSpent = state.jobs.reduce((sum, j) => {
    if (j.postedByUserId === user.id && j.paymentStatus === "paid") {
      return sum + (j.chargedAmount || 0);
    }
    return sum;
  }, 0);

  container.innerHTML = "";

  // top row: avatar + basic info
  const profileRow = document.createElement("div");
  profileRow.className = "profile-row";

  const avatar = document.createElement("div");
  avatar.className = "profile-avatar";
  if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.src = user.avatarDataUrl;
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  profileRow.appendChild(avatar);

  const info = document.createElement("div");
  info.innerHTML =
    "<strong>" +
    user.name +
    "</strong><br><span class='muted'>" +
    user.email +
    "</span><br><span class='muted'>" +
    (user.role === "customer" ? "Customer" : "Hustler") +
    "</span>";
  profileRow.appendChild(info);

  container.appendChild(profileRow);

  // avatar upload
  const avatarUploadField = document.createElement("div");
  avatarUploadField.className = "field";
  avatarUploadField.innerHTML =
    "<label>Profile photo (demo)</label>" +
    "<input id='avatarUploadInput' type='file' accept='image/*' />";
  container.appendChild(avatarUploadField);

  // about you / bio
  const bioField = document.createElement("div");
  bioField.className = "field";
  bioField.innerHTML =
    "<label for='profileBioInput'>About you (profile bio)</label>" +
    "<textarea id='profileBioInput' placeholder='Tell people a little about yourself. Jobs you like, if you have a truck, experience, etc.'></textarea>" +
    "<button class='btn btn-primary' id='saveBioButton' style='margin-top:0.35rem;'>Save profile</button>";
  container.appendChild(bioField);
// --- Stripe Connect Section (for automatic payouts) ---
const stripeConnectWrap = document.createElement("div");
stripeConnectWrap.className = "field";
stripeConnectWrap.style.marginTop = "0.8rem";
stripeConnectWrap.style.padding = "1rem";
stripeConnectWrap.style.background = "linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)";
stripeConnectWrap.style.borderRadius = "var(--radius)";
stripeConnectWrap.style.border = "1px solid #bae6fd";
stripeConnectWrap.innerHTML = `
  <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
    <span style="font-size: 1.5rem;">üí≥</span>
    <strong style="color: #0369a1;">Get Paid Automatically</strong>
  </div>
  <p class="muted" style="margin: 0 0 0.75rem 0; font-size: 0.85rem;">
    Connect your Stripe account to receive payments directly when customers pay for completed jobs. No more waiting for manual payouts!
  </p>
  <div id="stripeConnectStatus" style="margin-bottom: 0.75rem;"></div>
  <button class="btn btn-primary" id="connectStripeBtn" style="background: #635bff; width: 100%;">
    üîó Connect Stripe Account
  </button>
`;
container.appendChild(stripeConnectWrap);

// Check Stripe Connect status
setTimeout(async () => {
  const statusDiv = document.getElementById("stripeConnectStatus");
  const connectBtn = document.getElementById("connectStripeBtn");
  if (!statusDiv || !connectBtn) return;
  
  try {
    const token = localStorage.getItem("hustl_token");
    if (!token) {
      statusDiv.innerHTML = '<span class="muted">Log in to connect Stripe</span>';
      return;
    }
    
    const res = await fetch("/stripe-connect/status", {
      headers: { "Authorization": "Bearer " + token }
    });
    const data = await res.json();
    
    if (data.connected) {
      statusDiv.innerHTML = '<span style="color: var(--success); font-weight: 600;">‚úÖ Stripe Connected!</span><br><span class="muted" style="font-size: 0.8rem;">You\'ll receive payments automatically</span>';
      connectBtn.textContent = "‚úì Connected - Manage Account";
      connectBtn.style.background = "var(--success)";
    } else {
      statusDiv.innerHTML = '<span style="color: #dc2626; font-size: 0.85rem;">‚ö†Ô∏è Not connected yet</span>';
    }
  } catch (e) {
    console.error("Error checking Stripe status:", e);
  }
}, 100);

// Handle Stripe Connect button click
setTimeout(() => {
  const connectBtn = document.getElementById("connectStripeBtn");
  if (connectBtn) {
    connectBtn.addEventListener("click", async () => {
      connectBtn.disabled = true;
      connectBtn.textContent = "Connecting...";
      
      try {
        const token = localStorage.getItem("hustl_token");
        
        // First create account if needed
        await fetch("/stripe-connect/create-account", {
          method: "POST",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        // Then get onboarding link
        const res = await fetch("/stripe-connect/onboarding-link", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        
        if (data.url) {
          window.location.href = data.url;
        } else {
          showToast("Could not get Stripe link. Try again.");
          connectBtn.disabled = false;
          connectBtn.textContent = "üîó Connect Stripe Account";
        }
      } catch (e) {
        console.error("Stripe connect error:", e);
        showToast("Error connecting to Stripe. Please try again.");
        connectBtn.disabled = false;
        connectBtn.textContent = "üîó Connect Stripe Account";
      }
    });
  }
}, 150);

// --- Manual Payout preferences (backup option) ---
const payoutWrap = document.createElement("div");
payoutWrap.className = "field";
payoutWrap.style.marginTop = "0.8rem";
payoutWrap.innerHTML = `
  <details style="cursor: pointer;">
    <summary style="font-weight: 600; color: var(--text-muted); padding: 0.5rem 0;">
      üì± Manual Payout Options (Venmo/Cash App/Zelle)
    </summary>
    <div style="padding-top: 0.5rem;">
      <p class="muted" style="font-size: 0.8rem; margin-bottom: 0.5rem;">
        If you can't use Stripe, you can receive manual payouts via Venmo, Cash App, or Zelle (may take 1-2 business days).
      </p>
      <div class="field-inline">
        <div class="field">
          <label for="profilePayoutMethod">Payout method</label>
          <select id="profilePayoutMethod">
            <option value="">Choose one</option>
            <option value="venmo">Venmo</option>
            <option value="cashapp">Cash App</option>
            <option value="zelle">Zelle</option>
          </select>
        </div>
        <div class="field">
          <label for="profilePayoutHandle">Payout handle / account</label>
          <input id="profilePayoutHandle" type="text" placeholder="@username or email/phone" />
        </div>
      </div>
      <div class="field" style="margin-top:0.35rem;">
        <label for="profilePayoutName">Payout name (for Zelle)</label>
        <input id="profilePayoutName" type="text" placeholder="Full name on Zelle account" />
      </div>
      <button class="btn btn-ghost" id="savePayoutButton" style="margin-top:0.35rem;">Save manual payout info</button>
    </div>
  </details>
`;
container.appendChild(payoutWrap);

  // if user already has a bio, prefill
setTimeout(() => {
  const bioInput = document.getElementById("profileBioInput");
  if (bioInput) {
    bioInput.value = user.bio || "";
  }

  // Prefill payout fields
  const pm = document.getElementById("profilePayoutMethod");
  const ph = document.getElementById("profilePayoutHandle");
  const pn = document.getElementById("profilePayoutName");
  const payout = user.payout || {};
  if (pm) pm.value = payout.method || "";
  if (ph) ph.value = payout.handle || "";
  if (pn) pn.value = payout.name || "";
}, 0);
  // stats row
  const statsRow = document.createElement("div");
  statsRow.className = "stat-row";

  const statActive = document.createElement("div");
  statActive.className = "stat-card";
  statActive.innerHTML =
    "<div class='stat-label'>Active jobs</div><div class='stat-value'>" +
    activeJobs.length +
    "</div><div class='linkish' id='activeJobsLink'>View</div>";
  statsRow.appendChild(statActive);

  const statCompleted = document.createElement("div");
  statCompleted.className = "stat-card";
  statCompleted.innerHTML =
    "<div class='stat-label'>Completed jobs</div><div class='stat-value'>" +
    completedJobs.length +
    "</div>";
  statsRow.appendChild(statCompleted);

  const statEarned = document.createElement("div");
  statEarned.className = "stat-card";
  statEarned.innerHTML =
    "<div class='stat-label'>Estimated total earned (as Hustler)</div><div class='stat-value'>" +
    formatMoney(totalEarned) +
    "</div>";
  statsRow.appendChild(statEarned);

  const statSpent = document.createElement("div");
  statSpent.className = "stat-card";
  statSpent.innerHTML =
    "<div class='stat-label'>Estimated total spent (as Customer)</div><div class='stat-value'>" +
    formatMoney(totalSpent) +
    "</div>";
  statsRow.appendChild(statSpent);

  container.appendChild(statsRow);

  const note = document.createElement("div");
  note.className = "muted";
  note.textContent =
    "These estimates are based on jobs marked paid/completed in this demo on your device only.";
  container.appendChild(note);

  // ----- RIGHT SIDE: JOBS -----
  jobsList.innerHTML = "";

  // A) Jobs you posted
  const postedHeader = document.createElement("div");
  postedHeader.className = "section-title";
  postedHeader.textContent = "Jobs you posted";
  jobsList.appendChild(postedHeader);

  const myPostedJobs = state.jobs.filter((j) => j.postedByUserId === user.id);
  if (myPostedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven‚Äôt posted any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myPostedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You posted this ¬∑ " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // B) Jobs you're doing as a Hustler
  const doingHeader = document.createElement("div");
  doingHeader.className = "section-title";
  doingHeader.style.marginTop = "0.8rem";
  doingHeader.textContent = "Jobs you‚Äôre doing as a Hustler";
  jobsList.appendChild(doingHeader);

  const myHustlerJobs = state.jobs.filter(
    (j) => j.acceptedHustlerId === user.id
  );

  if (myHustlerJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven‚Äôt been accepted on any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myHustlerJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You‚Äôre the Hustler ¬∑ " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // C) Jobs you've applied for
  const appliedHeader = document.createElement("div");
  appliedHeader.className = "section-title";
  appliedHeader.style.marginTop = "0.8rem";
  appliedHeader.textContent = "Jobs you‚Äôve applied for";
  jobsList.appendChild(appliedHeader);

  const myAppliedJobs = state.jobs.filter((j) =>
    (j.applicants || []).some((a) => a.userId === user.id)
  );

  if (myAppliedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven‚Äôt applied for any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myAppliedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent =
        "You applied ¬∑ " +
        timeAgo(job.createdAt) +
        (job.acceptedHustlerId === user.id
          ? " ¬∑ (accepted)"
          : job.status === "assigned"
          ? " ¬∑ (assigned to someone else)"
          : "");
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // hook up avatar upload
  const avatarInput = document.getElementById("avatarUploadInput");
  if (avatarInput) {
    avatarInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        user.avatarDataUrl = ev.target.result;
        saveState();
        renderProfile();
      };
      reader.readAsDataURL(file);
    });
  }

  // hook up bio save
  const bioInput = document.getElementById("profileBioInput");
  const saveBioBtn = document.getElementById("saveBioButton");
  if (bioInput && saveBioBtn) {
    saveBioBtn.addEventListener("click", () => {
      user.bio = bioInput.value.trim();
      saveState();
      showToast("Profile updated.");
    });
  }
// hook up payout save
const payoutMethodEl = document.getElementById("profilePayoutMethod");
const payoutHandleEl = document.getElementById("profilePayoutHandle");
const payoutNameEl   = document.getElementById("profilePayoutName");
const savePayoutBtn  = document.getElementById("savePayoutButton");

if (savePayoutBtn && payoutMethodEl && payoutHandleEl && payoutNameEl) {
  savePayoutBtn.addEventListener("click", () => {
    const method = payoutMethodEl.value;
    const handle = (payoutHandleEl.value || "").trim();
    const name   = (payoutNameEl.value || "").trim();

    if (!method) {
      showToast("Choose a payout method.");
      return;
    }
    if (!handle) {
      showToast("Enter your payout handle/account.");
      return;
    }
    if (method === "zelle" && !name) {
      showToast("Enter the payout name used on your Zelle account.");
      return;
    }

    user.payout = {
      method,                     // "venmo" | "cashapp" | "zelle"
      handle,                     // @handle or phone/email
      name: name || null          // optional (but required for Zelle above)
    };
    saveState();
    showToast("Payout preferences saved.");
  });
}

  // hook up "View active jobs"
  const activeLink = document.getElementById("activeJobsLink");
  if (activeLink) {
    activeLink.addEventListener("click", () => {
      setView("jobs");
      activeJobsStatusFilter = "open";
      renderJobs(true); // Reset pagination when filter changes
    });
  }
}

    /* ---------- Feedback ---------- */

    function initFeedback() {
      const btn = document.getElementById("feedbackButton");
      btn.addEventListener("click", () => {
        const name = document.getElementById("feedbackName").value.trim();
        const email = document.getElementById("feedbackEmail").value.trim();
        const message = document
          .getElementById("feedbackMessage")
          .value.trim();
        if (!message) {
          showToast("Please type a bit of feedback first.");
          return;
        }
        state.feedback.push({
          id: generateId("f"),
          name,
          email,
          message,
          createdAt: Date.now(),
        });
        saveState();
        document.getElementById("feedbackMessage").value = "";
        showToast("Feedback saved (demo). In a live app this would email Hustl.");
      });
    }

   /* ---------- Footer links ---------- */

function initFooterLinks() {
  document
    .getElementById("footerTermsLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });

  document
    .getElementById("footerPrivacyLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });
}

   /* ---------- Public profile popup ---------- */
function openUserProfile(userId) {
  const user = state.users.find((u) => u.id === userId);
  if (!user) return showToast("User not found (demo).");

  // remove any existing popup
  const existing = document.getElementById("profilePopupOverlay");
  if (existing) existing.remove();

  const overlay = document.createElement("div");
  overlay.id = "profilePopupOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(15,23,42,0.55)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "80";

  const card = document.createElement("div");
  card.className = "card";
  card.style.maxWidth = "360px";
  card.style.width = "90%";

  // Header
  const header = document.createElement("div");
  header.className = "card-header";
  const title = document.createElement("div");
  title.className = "card-title";
  title.textContent = user.name || "Profile";
  const closeBtn = document.createElement("button");
  closeBtn.className = "small-btn outline";
  closeBtn.textContent = "Close";
  closeBtn.addEventListener("click", () => overlay.remove());
  header.appendChild(title);
  header.appendChild(closeBtn);
  card.appendChild(header);

  // Avatar + basic info (role only, no money / jobs / email)
  const row = document.createElement("div");
  row.className = "profile-row";

  const avatar = document.createElement("div");
  avatar.className = "profile-avatar";
  if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.src = user.avatarDataUrl;
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  row.appendChild(avatar);

  const info = document.createElement("div");
  info.innerHTML =
    "<span class='muted'>" +
    (user.role === "hustler" ? "Hustler" : "Customer") +
    "</span>";
  row.appendChild(info);

  card.appendChild(row);

  // Bio / description
  const bioWrap = document.createElement("div");
  bioWrap.className = "field";
  bioWrap.style.marginTop = "0.6rem";

  const bioLabel = document.createElement("div");
  bioLabel.className = "stat-label";
  bioLabel.textContent = "About this person";
  bioWrap.appendChild(bioLabel);

  const bioText = document.createElement("div");
  bioText.className = "about-text";
  bioText.textContent =
    user.bio || "This person hasn‚Äôt added anything about themselves yet.";
  bioWrap.appendChild(bioText);

  card.appendChild(bioWrap);

  // Reviews (demo only ‚Äì will show once we start filling user.reviews)
  const reviewsWrap = document.createElement("div");
  reviewsWrap.className = "field";
  reviewsWrap.style.marginTop = "0.6rem";

  const reviewLabel = document.createElement("div");
  reviewLabel.className = "stat-label";
  reviewLabel.textContent = "Reviews";
  reviewsWrap.appendChild(reviewLabel);

  const reviews = user.reviews || [];
  if (reviews.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "No reviews yet.";
    reviewsWrap.appendChild(empty);
  } else {
    reviews.forEach((r) => {
      const rCard = document.createElement("div");
      rCard.className = "stat-card";
      rCard.style.marginTop = "0.35rem";

      const top = document.createElement("div");
      top.className = "stat-value";
      top.style.fontSize = "0.8rem";
      top.textContent = (r.rating ? "‚òÖ".repeat(r.rating) + " ¬∑ " : "") + (r.fromName || "Someone on Hustl");
      rCard.appendChild(top);

      const body = document.createElement("div");
      body.className = "muted";
      body.style.marginTop = "0.2rem";
      body.textContent = r.text || "";
      rCard.appendChild(body);

      reviewsWrap.appendChild(rCard);
    });
  }

  card.appendChild(reviewsWrap);

  overlay.appendChild(card);
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.remove();
  });

  document.body.appendChild(overlay);
}


    /* ---------- Owner view ---------- */

    function renderOwnerView() {
      const user = getCurrentUser();
      const tab = document.getElementById("ownerTab");
      const view = document.getElementById("view-owner");
      const paidList = document.getElementById("ownerPaidList");
      const assignedList = document.getElementById("ownerAssignedList");

      const isOwner = !!(user && user.email && user.email.toLowerCase() === "team.hustlapp@outlook.com");
      if (tab) tab.style.display = isOwner ? "" : "none";
      if (!isOwner) {
        if (view) view.style.display = "none";
        return;
      }

      // Paid jobs
      const paidJobs = state.jobs.filter(j => j.paymentStatus === "paid");
      if (paidList) {
        paidList.innerHTML = "";
        if (paidJobs.length === 0) {
          paidList.innerHTML = "<div class='muted'>No paid jobs yet.</div>";
        } else {
          paidJobs.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
           const custUser = state.users.find(u => u.id === j.postedByUserId);
const hustUser = state.users.find(u => u.id === j.acceptedHustlerId);
const cust = custUser?.name || "Customer";
const hust = hustUser?.name || "Hustler";

let payoutInfo = "";
if (hustUser && hustUser.payoutMethod && hustUser.payoutHandle) {
  const label =
    hustUser.payoutMethod === "venmo" ? "Venmo" :
    hustUser.payoutMethod === "cashapp" ? "Cash App" :
    hustUser.payoutMethod === "zelle" ? "Zelle" : "Payout";
  payoutInfo = ` ¬∑ ${label}: ${hustUser.payoutHandle}`;
}

meta.textContent =
  `Paid ${formatMoney(j.chargedAmount || 0)} ¬∑ Your fee ${formatMoney(j.platformFeeAmount || 0)} ¬∑ ${cust} ‚Üí ${hust}${payoutInfo}`;
            row.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "job-card-actions";

            const left = document.createElement("div");
            const payoutBadge = document.createElement("span");
            payoutBadge.className = "badge";
            if (j.adminPayoutDone) {
              payoutBadge.classList.add("status-completed");
              payoutBadge.textContent = "Payout marked done";
            } else {
              payoutBadge.classList.add("status-assigned");
              payoutBadge.textContent = "Payout pending";
            }
            left.appendChild(payoutBadge);

            const right = document.createElement("div");
            const markBtn = document.createElement("button");
            markBtn.className = "small-btn";
            markBtn.textContent = j.adminPayoutDone ? "Unmark payout" : "Mark payout done";
            markBtn.addEventListener("click", () => {
              j.adminPayoutDone = !j.adminPayoutDone;
              saveState();
              showToast(j.adminPayoutDone ? "Marked payout done." : "Payout unmarked.");
              renderOwnerView();
            });
            right.appendChild(markBtn);

            actions.appendChild(left);
            actions.appendChild(right);
            row.appendChild(actions);

            paidList.appendChild(row);
          });
        }
      }

      // Assigned but not paid
      const assigned = state.jobs.filter(j => j.status === "assigned" && j.paymentStatus !== "paid");
      if (assignedList) {
        assignedList.innerHTML = "";
        if (assigned.length === 0) {
          assignedList.innerHTML = "<div class='muted'>No assigned-but-unpaid jobs.</div>";
        } else {
          assigned.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
            const cust = state.users.find(u => u.id === j.postedByUserId)?.name || "Customer";
            const hust = state.users.find(u => u.id === j.acceptedHustlerId)?.name || "Hustler";
            meta.textContent = `Assigned ¬∑ ${cust} ‚Üî ${hust} ¬∑ posted ${timeAgo(j.createdAt)}`;
            row.appendChild(meta);

            assignedList.appendChild(row);
          });
        }
      }
    }

    /* ---------- Main render ---------- */

    function renderAll() {
      renderAuthPill();
      renderAuthSectionVisibility();
      renderOwnerView();

      if (activeView === "jobs") {
        renderJobs();
      } else if (activeView === "messages") {
        renderMessagesView();
      } else if (activeView === "profile") {
        renderProfile();
      } else if (activeView === "owner") {
        renderOwnerView();
      }
      
      // Always update unread message count (works even when not on messages view)
      countUnreadMessages();
    }

    /* ---------- Mode Toggle ---------- */
    
    function initModeToggle() {
      const customerBtn = document.getElementById("modeCustomerBtn");
      const hustlerBtn = document.getElementById("modeHustlerBtn");
      
      if (customerBtn) {
        customerBtn.addEventListener("click", () => {
          userMode = "customer";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
      
      if (hustlerBtn) {
        hustlerBtn.addEventListener("click", () => {
          userMode = "hustler";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
    }

    /* ---------- Init ---------- */

    function initNav() {
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const v = tab.dataset.view;
          setView(v);
        });
      });

      document
        .getElementById("homeCtaPost")
        .addEventListener("click", () => {
          setView("post");
          const formCard = document.getElementById("jobFormCard");
          if (formCard) {
            formCard.scrollIntoView({ behavior: "smooth" });
          }
        });
      document
        .getElementById("homeCtaBrowse")
        .addEventListener("click", () => setView("jobs"));

      document
        .getElementById("jobsStatusFilter")
        .querySelectorAll("span")
        .forEach((el) => {
          el.addEventListener("click", () => {
            activeJobsStatusFilter = el.dataset.status;
            document
              .getElementById("jobsStatusFilter")
              .querySelectorAll("span")
              .forEach((s) =>
                s.classList.toggle("active", s.dataset.status === activeJobsStatusFilter)
              );
            renderJobs(true); // Reset pagination when filter changes
          });
        });
    }
async function startPayment(jobId) {
  const job = state.jobs.find((j) => j.id === jobId);
  const user = getCurrentUser();

  if (!job || !user || user.id !== job.postedByUserId) {
    showToast("Only the customer who posted can pay for this job.");
    return;
  }

  if (!job.acceptedHustlerId) {
    showToast("Accept a Hustler before paying.");
    return;
  }

  // Calculate total
  let total = 0;
  if (job.paymentType === "flat") {
    total = job.flatAmount || 0;
  } else {
    total = (job.hourlyRate || 0) * (job.maxHours || 0);
  }

  if (total <= 0) {
    showToast("Job total must be greater than zero.");
    return;
  }

  // Stripe expects amount in cents
  const platformPercent = 0.15; // 15% cut
  const platformFee = Math.round(total * platformPercent);
  const amountToCharge = total * 100; // Convert to cents

try {
    const res = await fetch("http://localhost:8080/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amountTotalCents: amountToCharge,
        customerEmail: user.email,
        description: `Hustl job payment for: ${job.title}`,
      }),
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast("Failed to start Stripe Checkout session.");
    }
  } catch (err) {
    console.error("Payment error:", err);
    showToast("Error connecting to payment server.");
  }
}

  // ========== HAMBURGER MENU ==========
  function initHamburgerMenu() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    
    if (hamburgerBtn && mobileMenu) {
      hamburgerBtn.addEventListener('click', () => {
        hamburgerBtn.classList.toggle('open');
        mobileMenu.classList.toggle('open');
        document.body.style.overflow = mobileMenu.classList.contains('open') ? 'hidden' : '';
      });
      
      // Handle mobile menu item clicks
      mobileMenu.querySelectorAll('.mobile-menu-item').forEach(item => {
        item.addEventListener('click', () => {
          const view = item.dataset.view;
          if (view && typeof setView === 'function') {
            setView(view);
          }
          // Close menu
          hamburgerBtn.classList.remove('open');
          mobileMenu.classList.remove('open');
          document.body.style.overflow = '';
          
          // Update active state
          mobileMenu.querySelectorAll('.mobile-menu-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
        });
      });
      
      // Mobile auth buttons
      const mobileLoginBtn = document.getElementById('mobileLoginBtn');
      const mobileSignupBtn = document.getElementById('mobileSignupBtn');
      
      if (mobileLoginBtn) {
        mobileLoginBtn.addEventListener('click', () => {
          hamburgerBtn.classList.remove('open');
          mobileMenu.classList.remove('open');
          document.body.style.overflow = '';
          openAuthModal('login');
        });
      }
      
      if (mobileSignupBtn) {
        mobileSignupBtn.addEventListener('click', () => {
          hamburgerBtn.classList.remove('open');
          mobileMenu.classList.remove('open');
          document.body.style.overflow = '';
          openAuthModal('create');
        });
      }
    }
    
    // Desktop auth buttons
    const headerLoginBtn = document.getElementById('headerLoginBtn');
    const headerSignupBtn = document.getElementById('headerSignupBtn');
    
    if (headerLoginBtn) {
      headerLoginBtn.addEventListener('click', () => openAuthModal('login'));
    }
    if (headerSignupBtn) {
      headerSignupBtn.addEventListener('click', () => openAuthModal('create'));
    }
  }
  
  // ========== AUTH MODAL ==========
  function openAuthModal(mode = 'create') {
    // Check if user is already logged in
    const user = getCurrentUser();
    if (user) {
      setView('profile');
      return;
    }
    
    // Show auth section and scroll to it, or show modal
    const authSection = document.getElementById('authSection');
    if (authSection) {
      authSection.style.display = 'block';
      authSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Toggle to correct mode
      const authTitle = document.getElementById("authCardTitle");
      const authToggle = document.getElementById("authModeToggle");
      const authBodyCreate = document.getElementById("authBodyCreate");
      const authBodyLogin = document.getElementById("authBodyLogin");
      
      if (mode === 'login') {
        if (authTitle) authTitle.textContent = "üëã Welcome Back";
        if (authBodyCreate) authBodyCreate.style.display = 'none';
        if (authBodyLogin) authBodyLogin.style.display = 'block';
      } else {
        if (authTitle) authTitle.textContent = "üöÄ Join Hustl";
        if (authBodyCreate) authBodyCreate.style.display = 'block';
        if (authBodyLogin) authBodyLogin.style.display = 'none';
      }
    }
  }
  
  function closeAuthModal() {
    const overlay = document.getElementById('authModalOverlay');
    if (overlay) {
      overlay.classList.remove('open');
      document.body.style.overflow = '';
    }
  }
  
  // Update header when logged in
  function updateHeaderAuth() {
    const user = getCurrentUser();
    const desktopAuth = document.getElementById('headerAuthDesktop');
    const mobileAuth = document.querySelector('.mobile-menu .header-auth');
    
    if (user) {
      if (desktopAuth) {
        desktopAuth.innerHTML = `
          <span style="color: var(--text-muted); font-size: 0.85rem;">Hey, ${user.name?.split(' ')[0] || 'there'}!</span>
          <button class="btn-login-header" onclick="setView('profile')">Profile</button>
        `;
      }
      if (mobileAuth) {
        mobileAuth.innerHTML = `
          <button class="btn-signup-header" onclick="setView('profile')" style="width:100%;">üë§ My Profile</button>
        `;
      }
    }
  }

  // Boot - initialize immediately
  loadState();
  initAgeGate();
  initNav();
  initAuthCard();
  initHamburgerMenu();
  initJobsForm();
  initConversationInput();
  initFeedback();
  initFooterLinks();
  checkAgeGate();
  handleStripeReturn();
  checkAutoCompleteJobs();
  setInterval(checkAutoCompleteJobs, 60 * 1000);
  renderAll();
  updateHeaderAuth();
  
  // Start token auto-refresh for persistent login
  if (window.appCore && window.appCore.tokenManager) {
    window.appCore.tokenManager.startAutoRefresh();
  }
  </script>
  
  <!-- Performance-optimized script loading -->
  <script src="/app-core.js" defer></script>
  <script src="/mobile-core.js" defer></script>
</body>
</html>


