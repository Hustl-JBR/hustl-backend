
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hustl ‚Äì Local help, real hustle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíº</text></svg>" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
      --radius: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      /* Prevent text selection on mobile for app-like feel */
      -webkit-tap-highlight-color: transparent;
      /* Smooth scrolling */
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden;
      pointer-events: auto !important;
      overflow: visible !important;
    }
    
    /* CRITICAL: Prevent any overlay from blocking */
    html, body {
      pointer-events: auto !important;
      overflow: visible !important;
    }
    
    /* Ensure app-shell and all containers are clickable */
    .app-shell, header, nav, main, section {
      pointer-events: auto !important;
    }
    
    /* App-like smooth scrolling */
    * {
      -webkit-overflow-scrolling: touch;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      cursor: pointer;
      font-family: inherit;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    @media (max-width: 768px) {
      header {
        padding: 0.5rem 0.75rem;
      }
      
      /* Add bottom padding to all views to prevent nav overlap */
      section[id^="view-"] {
        padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)) !important;
      }
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.08em;
      font-size: 1.1rem;
    }

    .logo-text-main {
      font-weight: 800;
      font-size: 1.15rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .nav-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.85rem;
      align-items: center;
      position: relative;
    }

    .nav-tab {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .nav-tab.active {
      background: var(--primary-soft);
      color: var(--primary);
      border-color: var(--primary);
    }

    /* Notification badge for unread messages */
    .nav-tab-badge {
      position: relative;
    }

    .nav-tab-badge::after {
      content: attr(data-badge-count);
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.15rem 0.35rem;
      border-radius: 999px;
      min-width: 1.2rem;
      text-align: center;
      line-height: 1.2;
      border: 2px solid var(--bg);
      display: none;
    }

    .nav-tab-badge[data-badge-count]:not([data-badge-count="0"])::after {
      display: block;
    }

    /* Mobile menu badge */
    .mobile-menu-item-badge {
      position: relative;
    }

    .mobile-menu-item-badge::after {
      content: attr(data-badge-count);
      position: absolute;
      top: -2px;
      right: -2px;
      background: #ef4444;
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.15rem 0.35rem;
      border-radius: 999px;
      min-width: 1.2rem;
      text-align: center;
      line-height: 1.2;
      border: 2px solid var(--bg);
      display: none;
    }

    .mobile-menu-item-badge[data-badge-count]:not([data-badge-count="0"])::after {
      display: block;
    }

    /* Notifications Bell */
    #notificationsBell:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    #notificationsDropdown {
      animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f3f4f6;
      cursor: pointer;
      transition: background 0.2s;
    }

    .notification-item:hover {
      background: #f9fafb;
    }

    .notification-item.unread {
      background: #eff6ff;
      border-left: 3px solid #2563eb;
    }

    .notification-item .notification-icon {
      font-size: 1.5rem;
      margin-right: 0.75rem;
    }

    .notification-item .notification-content {
      flex: 1;
    }

    .notification-item .notification-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      color: #111827;
    }

    .notification-item .notification-message {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 0.25rem;
    }

    .notification-item .notification-time {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    /* Loading spinner */
    .btn-loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Error messages */
    .error-message {
      background: #fee2e2;
      border: 1px solid #fca5a5;
      color: #991b1b;
      padding: 0.75rem;
      border-radius: 8px;
      margin: 0.75rem 0;
      font-size: 0.9rem;
    }

    .error-message .retry-btn {
      margin-top: 0.5rem;
      background: #dc2626;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    /* Mobile Menu Button */
    .mobile-menu-btn {
      display: none; /* Hidden by default, shown on mobile */
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-main);
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-left: auto; /* Push to the right when visible */
    }

    .mobile-menu-btn:hover {
      background: var(--primary-soft);
    }

    /* Mobile Menu Dropdown */
    .mobile-menu {
      display: none;
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0.75rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      min-width: 200px;
      max-width: 90vw;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      header {
        position: relative; /* Make header a positioning context for the menu */
      }
      
      .mobile-menu {
        position: absolute;
        top: calc(100% + 0.25rem);
        right: 0.75rem;
      }
    }

    .mobile-menu.show {
      display: block;
    }

    .mobile-menu-item {
      display: block;
      padding: 0.75rem 1rem;
      color: var(--text-main);
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 0.9rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }

    .mobile-menu-item:last-child {
      border-bottom: none;
    }

    .mobile-menu-item:hover {
      background: var(--primary-soft);
      color: var(--primary);
    }

    .mobile-menu-item.active {
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
    }

    .auth-pill {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    @media (max-width: 768px) {
      .auth-pill {
        font-size: 0.7rem;
        gap: 0.5rem;
        flex-direction: column;
        align-items: flex-end;
      }
      
      .auth-pill span {
        font-size: 0.7rem;
      }
      
      .how-it-works-toggle {
        cursor: pointer;
      }
    }

    .auth-pill button {
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.7rem;
    }

    /* Mode Toggle - More visible and clear */
    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 0.15rem;
      padding: 0.15rem;
      background: #f3f4f6;
      border-radius: 6px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .mode-toggle button {
      padding: 0.3rem 0.6rem;
      border-radius: 5px;
      border: none;
      font-size: 0.7rem;
      font-weight: 600;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      min-height: 26px;
      white-space: nowrap;
    }

    .mode-toggle button.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 1px 2px rgba(37, 99, 235, 0.2);
      font-weight: 600;
    }
    
    .mode-toggle button:not(.active):hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--primary);
    }
    
    @media (max-width: 768px) {
      .mode-toggle {
        padding: 0.1rem;
        gap: 0.1rem;
      }
      
      .mode-toggle button {
        padding: 0.25rem 0.5rem;
        font-size: 0.65rem;
        min-height: 24px;
      }
      
      .auth-pill {
        position: relative;
        margin-top: 0.5rem;
      }
    }

    /* Job tabs styling */
    .job-tabs {
      position: relative;
      z-index: 10;
    }
    
    .job-tab {
      position: relative;
      z-index: 11;
      pointer-events: auto !important;
      user-select: none;
    }
    
    .job-tab.active {
      color: var(--primary) !important;
      font-weight: 600 !important;
      border-bottom: 2px solid var(--primary);
    }

    main {
      flex: 1;
      padding: 1rem;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }

    /* Mobile-first: single column on small screens */
    @media (max-width: 768px) {
      main {
        padding: 0.75rem;
      }
      
      header {
        padding: 0.4rem 0.75rem;
        flex-wrap: wrap;
        position: relative;
      }
      
      .logo-text-main {
        font-size: 0.9rem;
      }

      .logo-mark {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }

      .logo-sub {
        font-size: 0.65rem;
      }
      
      .nav-tabs {
        font-size: 0.75rem;
        gap: 0.25rem;
        flex: 1;
        justify-content: space-between;
      }
      
      .nav-tab {
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
      }

      /* Hide Profile and About on mobile - they go in menu */
      .nav-tab[data-view="profile"],
      .nav-tab[data-view="about"] {
        display: none;
      }

      /* Show mobile menu button on mobile */
      .mobile-menu-btn {
        display: block !important;
      }

      /* Make mode toggle part of nav on mobile - show first */
      .mode-toggle {
        order: -1;
        margin-right: auto;
        flex-shrink: 0;
      }

      /* Stack nav items better on mobile */
      .nav-tabs {
        flex-wrap: wrap;
        row-gap: 0.5rem;
      }

      /* Make auth pill more compact on mobile */
      .auth-pill {
        width: 100%;
        margin-top: 0.5rem;
        justify-content: space-between;
      }
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 1rem;
    }
    
    @media (max-width: 768px) {
      .layout-grid {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1.25rem;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
      margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
      .card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      color: var(--text-muted);
      background: #f9fafb;
    }

    .badge.hot {
      background: #fef2f2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .badge.status-open {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--success);
    }

    .badge.status-assigned {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: var(--primary);
    }

    .badge.status-completed {
      background: #f5f3ff;
      border-color: #ddd6fe;
      color: #6d28d9;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .hero-heading {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .hero-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .hero-cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      min-height: 44px; /* Touch-friendly on mobile */
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      touch-action: manipulation;
    }
    
    .btn:active {
      transform: scale(0.96);
      opacity: 0.8;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    @media (max-width: 768px) {
      .btn {
        padding: 0.7rem 1.4rem;
        font-size: 0.9rem;
        min-height: 48px;
      }
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .step-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .step-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .step-emoji {
      margin-right: 0.25rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.3rem;
    }

    .pill {
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      border: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .field {
      margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
      .field {
        margin-bottom: 1.25rem;
      }
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: var(--text-main);
    }
    
    @media (max-width: 768px) {
      label {
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
      }
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 0.6rem 0.75rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: #ffffff;
      min-height: 44px; /* Touch-friendly on mobile */
      transition: border-color 0.2s;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    @media (max-width: 768px) {
      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="number"],
      select,
      textarea {
        padding: 0.75rem;
        font-size: 1rem; /* Prevents zoom on iOS */
        min-height: 48px;
      }
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .field-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }

    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    .job-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1rem;
      background: #ffffff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .job-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    
    .job-card:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 768px) {
      .job-card {
        padding: 1rem;
        gap: 0.6rem;
      }
    }

    .job-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.25rem;
    }

    .job-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .job-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .small-btn {
      border-radius: 999px;
      border: none;
      padding: 0.5rem 0.9rem;
      font-size: 0.8rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
      min-height: 36px;
      transition: all 0.2s;
    }
    
    .small-btn:active {
      transform: scale(0.95);
    }
    
    @media (max-width: 768px) {
      .small-btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        min-height: 40px;
      }
    }

    /* Filter buttons (TaskRabbit/Thumbtack style) */
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: #374151;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .filter-btn:hover {
      border-color: #9ca3af;
      background: #f9fafb;
    }

    .filter-btn.active {
      border-color: #3b82f6;
      background: #3b82f6;
      color: white;
    }

    .filter-btn.active:hover {
      background: #2563eb;
      border-color: #2563eb;
    }

    .filter-btn:active {
      transform: scale(0.95);
    }

    @media (max-width: 768px) {
      .filter-btn {
        padding: 0.45rem 0.9rem;
        font-size: 0.8rem;
      }
    }

    .small-btn.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      animation: fadeIn 0.2s ease;
      pointer-events: auto !important; /* Ensure overlay is clickable */
    }
    

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--bg);
      border-radius: 12px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 768px) {
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
      }
      
      .modal-content {
        max-width: 100%;
        max-height: 95vh;
        border-radius: 16px 16px 0 0;
        animation: slideUpMobile 0.3s ease;
      }
      
      @keyframes slideUpMobile {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Smooth page transitions */
    [id^="view-"] {
      animation: fadeIn 0.2s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Better input focus for mobile */
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      transform: scale(1.01);
      transition: all 0.2s;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text);
      z-index: 10;
      transition: all 0.2s;
    }

    @media (max-width: 768px) {
      .modal-close {
        top: 4rem;
        width: 36px;
        height: 36px;
      }
    }

    .modal-close:hover {
      background: #fff;
      transform: scale(1.1);
    }

    .job-detail {
      margin-top: 0.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.75rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }
/* High-contrast styling just for the job detail panel */
.job-detail-contrast {
  background: #111827;           /* light dark slate */
  color: #e5e7eb;                /* light text */
  border-color: #0b1220;
  box-shadow: 0 16px 40px rgba(0,0,0,0.35);
}

/* labels & muted text inside the dark panel */
.job-detail-contrast .detail-label { 
  color: #93c5fd;                /* soft blue for labels */
}

.job-detail-contrast .muted {
  color: #cbd5e1;                /* lighter muted */
}

/* buttons inside the dark panel */
.job-detail-contrast .small-btn.outline {
  border-color: #334155;
  color: #e5e7eb;
  background: transparent;
}
.job-detail-contrast .small-btn {
  background: #1f2937;           /* subtle dark chip */
  color: #e5e7eb;
}

/* links inside the dark panel */
.job-detail-contrast .linkish {
  color: #93c5fd;
}

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .detail-value {
      font-weight: 500;
    }

    .chat-box {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      margin-top: 0.5rem;
      background: #fff;
    }

    .chat-messages {
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 1rem;
    }

    .chat-msg {
      font-size: 0.75rem;
      padding: 0.3rem 0.45rem;
      border-radius: 999px;
      max-width: 85%;
    }

    .chat-msg.me {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
    }

    .chat-msg.them {
      align-self: flex-start;
      background: #e5e7eb;
      color: var(--text-main);
    }
    
    /* Modern message styling - like iMessage/WhatsApp */
    .chat-message {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      max-width: 85%;
    }
    
    .chat-message.sent {
      flex-direction: row-reverse;
      margin-left: auto;
    }
    
    .chat-message.received {
      flex-direction: row;
      margin-right: auto;
    }

    .chat-meta {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.4rem;
    }

    .chat-input-row input {
      flex: 1;
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.5rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-weight: 600;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-muted);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }

   .linkish {
  color: var(--primary);
  font-size: 0.75rem;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
  text-decoration-thickness: 1.5px;
  font-weight: 600;
}
.linkish:hover {
  text-decoration-thickness: 2px;
  opacity: 0.9;
}

    .job-status-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      margin-bottom: 0.5rem;
      padding: 0.25rem;
      background: #f3f4f6;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .job-status-group span {
      flex: 1;
      padding: 0.5rem 0.75rem;
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      color: #6b7280;
      font-weight: 500;
      background: transparent;
      border: 1px solid transparent;
    }

    .job-status-group span:hover {
      background: rgba(255, 255, 255, 0.8);
      color: #374151;
    }

    .job-status-group span.active {
      background: #fff;
      color: var(--primary);
      font-weight: 700;
      border-color: var(--primary);
      box-shadow: 0 1px 3px rgba(37, 99, 235, 0.2);
    }

    .feedback-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .about-text {
      font-size: 0.8rem;
      color: var(--text-main);
      line-height: 1.45;
      white-space: pre-line;
    }

    .legal-subtitle {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.6rem;
    }

    .legal-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    footer {
      border-top: 1px solid var(--border);
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: #111827;
      color: #e5e7eb;
    }

    .footer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    .footer-links span {
      cursor: pointer;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: #111827;
      color: #f9fafb;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-size: 0.75rem;
      z-index: 50;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .age-gate-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.84);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .age-gate-card {
      background: #ffffff;
      padding: 1.2rem;
      border-radius: 14px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }

    .age-gate-card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    .age-gate-card p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.7rem;
    }

    .age-gate-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.3rem;
    }

    @media (max-width: 768px) {
      header {
        padding: 0.5rem 0.75rem;
        flex-wrap: nowrap;
        align-items: center;
        gap: 0.5rem;
        justify-content: space-between;
        position: relative;
      }
      
      .logo-row {
        gap: 0.5rem;
        flex-shrink: 0;
        order: 0; /* Logo on the left */
      }
      
      .logo-mark {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }
      
      .logo-text-main {
        font-size: 0.95rem;
      }
      
      .logo-sub {
        display: none; /* Hide on mobile to save space */
      }
      
      .nav-tabs {
        display: none; /* Hide all nav tabs on mobile */
      }
      
      /* Show hamburger menu button - make it more prominent */
      .mobile-menu-btn {
        display: block !important;
        flex-shrink: 0;
        padding: 0.5rem 0.75rem;
        font-size: 1.2rem;
        order: 999; /* Put it at the end (right side) */
      }
      
      /* Show mode toggle on mobile, centered between logo and hamburger */
      .mode-toggle {
        display: flex !important;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        order: 1; /* Put it in the middle */
        z-index: 10;
        padding: 0.1rem;
        gap: 0.1rem;
      }
      
      .mode-toggle button {
        padding: 0.25rem 0.5rem;
        font-size: 0.65rem;
        min-height: 24px;
      }
      
      .mobile-menu-btn {
        order: 2; /* Hamburger on the right */
        margin-left: auto;
      }
      
      .auth-pill {
        display: none; /* Hide auth pill on mobile, show in hamburger */
      }
      
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      
      .jobs-list {
        max-height: none;
      }
      
      /* Mobile messages modal */
      #view-messages {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg);
        z-index: 1000;
        overflow-y: auto;
        padding: 0;
      }
      
      #view-messages .layout-grid {
        grid-template-columns: 1fr;
        height: 100%;
        margin: 0;
        gap: 0;
      }
      
      #view-messages .card {
        border-radius: 0;
        margin: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      
      #view-messages .card-header {
        position: sticky;
        top: 0;
        background: var(--card);
        z-index: 10;
        border-bottom: 1px solid var(--border);
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      #view-messages .card-header .card-title {
        flex: 1;
        margin: 0;
      }
      
      /* Mobile conversation view - hide list when conversation is open */
      #view-messages.mobile-conversation-open #conversationListContainer {
        display: none;
      }
      
      #view-messages.mobile-conversation-open #conversationContainer {
        display: block;
      }
      
      #view-messages:not(.mobile-conversation-open) #conversationContainer {
        display: none;
      }
      
      /* Back button for mobile */
      .mobile-back-btn {
        display: none;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        color: var(--text-main);
      }
      
      @media (max-width: 768px) {
        .mobile-back-btn {
          display: block !important;
        }
        
        /* Show conversation container on desktop, hide on mobile until conversation is selected */
        #view-messages:not(.mobile-conversation-open) #conversationContainer {
          display: none !important;
        }
        
        #view-messages.mobile-conversation-open #conversationListContainer {
          display: none !important;
        }
      }
      
      /* Desktop: show both side by side */
      @media (min-width: 769px) {
        #view-messages .layout-grid {
          grid-template-columns: 1fr 1fr;
        }
        
        #view-messages #conversationListContainer,
        #view-messages #conversationContainer {
          display: block !important;
        }
        
        .mobile-back-btn {
          display: none !important;
        }
      }
    }
    
    @media (max-width: 800px) {
      header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .jobs-list {
        max-height: none; /* let the page scroll instead of tiny inner scroll */
      }
    }
  </style>
  <script>
    // CRITICAL: Global error handler to prevent page freeze
    // This catches syntax errors and prevents them from completely freezing the page
    window.addEventListener('error', function(e) {
      console.error('Global error caught:', e.error, e.message, e.filename, e.lineno);
      // Log but don't let errors stop execution
      e.preventDefault();
      return true;
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      console.error('Unhandled promise rejection:', e.reason);
      // Log but don't let promise rejections stop execution
      e.preventDefault();
      return true;
    });
    
    // PREVENTION: Check for common issues before page loads
    // This helps catch duplicate declarations early
    document.addEventListener('DOMContentLoaded', function() {
      // Check for duplicate IDs (common cause of issues)
      const ids = {};
      document.querySelectorAll('[id]').forEach(function(el) {
        const id = el.id;
        if (ids[id]) {
          console.warn('Duplicate ID found:', id, 'This can cause issues.');
        }
        ids[id] = true;
      });
      
      // üöÄ Initialize modern optimizations
      initModernFeatures();
      
      // üöÄ Start persistent login (auto-refresh tokens)
      if (window.appCore && window.appCore.tokenManager) {
        window.appCore.tokenManager.startAutoRefresh();
      }
      
      // üöÄ Restore view from URL hash (persistent on reload)
      if (window.appCore && window.appCore.routeManager) {
        const savedView = window.appCore.routeManager.getCurrentRoute();
        if (savedView && savedView !== 'home' && typeof setView === 'function') {
          setTimeout(() => {
            setView(savedView);
          }, 100);
        }
      }
      
      // üöÄ Initialize mobile bottom navigation
      if (window.mobileCore && window.mobileCore.bottomNav) {
        window.mobileCore.bottomNav.init();
      }
      
      // üöÄ Initialize lazy image loading
      if (window.mobileCore && window.mobileCore.lazyImages) {
        window.mobileCore.lazyImages.observeAll();
      }
    });
    
    // Initialize modern features (debounced search, optimized handlers, etc.)
    function initModernFeatures() {
      // Debounced search input (optimize API calls)
      const searchInput = document.getElementById('jobsSearchInput');
      if (searchInput && window.appCore) {
        const debouncedSearch = window.appCore.debounce(() => {
          if (document.getElementById('view-jobs')?.style.display !== 'none') {
            renderJobs(true);
          }
        }, 500); // Wait 500ms after user stops typing
        
        searchInput.addEventListener('input', debouncedSearch);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            debouncedSearch.flush?.(); // Force immediate execution
            renderJobs(true);
          }
        });
      }
      
      // Optimize filter buttons with throttling
      const filtersBar = document.getElementById('jobFiltersBar');
      if (filtersBar && window.appCore) {
        const throttledRender = window.appCore.throttle(() => {
          renderJobs(true);
        }, 300);
        
        // Filter buttons are already wired up, but we can optimize them further
        filtersBar.querySelectorAll('.filter-btn').forEach(btn => {
          const originalClick = btn.onclick;
          btn.onclick = null; // Remove inline handler if any
          btn.addEventListener('click', throttledRender);
        });
      }
      
      // Subscribe to error handler for better UX
      if (window.appCore && window.appCore.errorHandler) {
        window.appCore.errorHandler.subscribe((error, message, context) => {
          // Errors are already handled by showToast, but we can add additional handling here
          console.error(`[${context}]`, error);
        });
      }
      
      // Subscribe to loading states
      if (window.appCore && window.appCore.loadingManager) {
        window.appCore.loadingManager.subscribe((loadingStates) => {
          // Update UI based on loading states
          // Could show global loading indicator
        });
      }
      
      console.log('‚úÖ Modern features initialized - Optimizations active');
    }
    
    // ULTRA-AGGRESSIVE cleanup - runs IMMEDIATELY before anything else
    (function() {
      try {
        // Remove ALL possible blocking elements
        var all = document.querySelectorAll('*');
        for (var i = 0; i < all.length; i++) {
          var el = all[i];
          try {
            var style = window.getComputedStyle(el);
            if (style.position === 'fixed' && parseInt(style.zIndex) >= 1000) {
              var rect = el.getBoundingClientRect();
              if (rect.width > window.innerWidth * 0.5 || rect.height > window.innerHeight * 0.5) {
                el.remove();
              }
            }
          } catch(e) {}
        }
        // Remove by class/id
        var overlays = document.querySelectorAll('.modal-overlay, [id*="Modal"], [id*="Overlay"], [class*="overlay"], [class*="modal"]');
        for (var j = 0; j < overlays.length; j++) {
          overlays[j].remove();
        }
        // Reset body
        if (document.body) {
          document.body.style.cssText = 'overflow: visible !important; pointer-events: auto !important;';
        }
        if (document.documentElement) {
          document.documentElement.style.cssText = 'overflow: visible !important; pointer-events: auto !important;';
        }
      } catch(e) {
        console.error('Cleanup error (non-fatal):', e);
      }
    })();
  </script>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-row">
        <div class="logo-mark">H</div>
        <div>
         <div class="logo-text-main">
  HUSTL
</div>
          <div class="logo-sub">Local help. Real hustle. All of Tennessee.</div>
        </div>
      </div>
      <!-- Mode Toggle (shown when logged in, centered on mobile) -->
      <div class="mode-toggle" id="modeToggle" style="display: none;">
        <button id="modeCustomerBtn" class="active">Customer</button>
        <button id="modeHustlerBtn">Hustler</button>
      </div>
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="home">Home</button>
        <button class="nav-tab" data-view="jobs">Jobs</button>
        <button class="nav-tab" data-view="post">Post a job</button>
        <button class="nav-tab nav-tab-badge" data-view="messages" title="Messages" data-badge-count="0">üí¨</button>
        <button class="nav-tab" data-view="profile">Profile</button>
        <button class="nav-tab" data-view="owner" id="ownerTab" style="display:none;">Owner</button>
        <button class="nav-tab" data-view="about">About</button>
      </nav>
      <!-- Mobile Menu Button (outside nav, shown on mobile only) -->
      <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
      <!-- Mobile Menu Dropdown -->
      <div class="mobile-menu" id="mobileMenu" style="display: none;">
        <div id="mobileMenuAuth" style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);">
          <div id="mobileMenuAuthText" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">Not signed in</div>
          <button id="mobileMenuAuthButton" class="btn btn-primary" style="width: 100%; padding: 0.5rem; font-size: 0.8rem;">Sign in / Create account</button>
        </div>
        <button class="mobile-menu-item" data-view="home">üè† Home</button>
        <button class="mobile-menu-item" data-view="jobs">üíº Find Jobs</button>
        <button class="mobile-menu-item" data-view="post">‚ûï Post a job</button>
        <button class="mobile-menu-item mobile-menu-item-badge" data-view="messages" data-badge-count="0">üí¨ Messages</button>
        <button class="mobile-menu-item" data-view="profile">üë§ Profile</button>
        <button class="mobile-menu-item" data-view="owner" id="mobileMenuOwner" style="display: none;">‚öôÔ∏è Owner</button>
        <button class="mobile-menu-item" data-view="about">‚ÑπÔ∏è About</button>
      </div>
      <div style="display: flex; align-items: center; gap: 0.75rem;">
        <!-- Notifications Bell -->
        <div id="notificationsContainer" style="position: relative; display: none;">
          <button 
            id="notificationsBell" 
            style="position: relative; background: transparent; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 1.2rem; color: #374151; transition: all 0.2s;"
          >
            üîî
            <span id="notificationsBadge" style="position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; font-size: 0.7rem; font-weight: 700; padding: 0.15rem 0.35rem; border-radius: 999px; min-width: 1.2rem; text-align: center; display: none;">0</span>
          </button>
          <!-- Notifications Dropdown -->
          <div id="notificationsDropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); min-width: 320px; max-width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000;">
            <div style="padding: 1rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600; font-size: 1rem;">Notifications</div>
              <button onclick="markAllNotificationsRead()" style="background: transparent; border: none; color: #2563eb; font-size: 0.85rem; cursor: pointer; padding: 0.25rem 0.5rem;">Mark all read</button>
            </div>
            <div id="notificationsList" style="padding: 0.5rem;">
              <div class="loading" style="text-align: center; padding: 2rem; color: #6b7280;">Loading notifications...</div>
            </div>
            <div id="notificationsEmpty" style="display: none; text-align: center; padding: 2rem; color: #6b7280; font-size: 0.9rem;">No notifications yet</div>
          </div>
        </div>
        <div class="auth-pill" id="authPill">
          <span id="authPillText">Not signed in</span>
          <button id="openAuthButton">Sign in / Create account</button>
        </div>
      </div>
    </header>

    <main>
      <!-- AUTH CARD -->
      <section id="authSection" class="card" style="margin-bottom: 0.8rem;">
        <div class="card-header">
          <div class="card-title" id="authCardTitle">Create account</div>
          <div class="muted" id="authModeToggle">
            Already have an account?
            <span class="linkish" data-auth-mode="login">Log in</span>
          </div>
        </div>
        <div id="authBodyCreate">
          <div class="field-inline">
            <div class="field">
              <label for="createName">Name</label>
              <input id="createName" type="text" placeholder="Example: Alex Johnson" />
            </div>
            <div class="field">
              <label for="createEmail">Email</label>
              <input id="createEmail" type="email" placeholder="you@example.com" />
            </div>
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="createPassword">Password</label>
              <input id="createPassword" type="password" placeholder="At least 8 characters" />
            </div>
            <div class="field">
              <label for="createRole">Role</label>
              <select id="createRole">
                <option value="customer">Customer (post jobs)</option>
                <option value="hustler">Hustler (do jobs)</option>
              </select>
            </div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            Create an account to get started.
          </div>
          
          <!-- Terms and Age Checkboxes -->
          <div style="margin: 1rem 0 0.75rem 0; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; font-size: 0.9rem; line-height: 1.5;">
              <input type="checkbox" id="agreeTerms" style="margin-top: 0.2rem; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;" />
              <span style="color: #374151;">
                I agree to the <a href="terms.html" target="_blank" style="color: #2563eb; text-decoration: underline; cursor: pointer;" onclick="event.stopPropagation(); window.open('terms.html', '_blank'); return false;">Terms of Service</a> and <a href="privacy.html" target="_blank" style="color: #2563eb; text-decoration: underline; cursor: pointer;" onclick="event.stopPropagation(); window.open('privacy.html', '_blank'); return false;">Privacy Policy</a>
              </span>
            </label>
          </div>
          <div style="margin: 0.5rem 0 0.75rem 0; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; font-size: 0.9rem; line-height: 1.5;">
              <input type="checkbox" id="confirmAge" style="margin-top: 0.2rem; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;" />
              <span style="color: #374151;">
                I confirm that I am 18 years of age or older
              </span>
            </label>
          </div>
          
          <div id="stripeNoticeForHustlers" style="display: none; padding: 0.75rem; background: #fef3c7; border-radius: 8px; border: 1px solid #fbbf24; margin-bottom: 0.75rem; font-size: 0.85rem; line-height: 1.5;">
            <div style="font-weight: 600; color: #92400e; margin-bottom: 0.25rem;">üí≥ Stripe Account Required</div>
            <div style="color: #78350f;">
              As a hustler, you <strong>must</strong> create and link your Stripe account to receive money. You'll set this up right after creating your account. Stripe is secure and free to use.
            </div>
          </div>
          <button class="btn btn-primary" id="createAccountButton">Create account</button>
        </div>

        <div id="authBodyLogin" style="display:none;">
          <div class="field-inline">
            <div class="field">
              <label for="loginEmail">Email</label>
              <input id="loginEmail" type="email" placeholder="you@example.com" />
            </div>
            <div class="field">
              <label for="loginPassword">Password</label>
              <input id="loginPassword" type="password" placeholder="Your password" />
            </div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            Enter your email and password to log in.
          </div>
          <button class="btn btn-primary" id="loginButton">Log in</button>
        </div>
      </section>

      <!-- HOME VIEW -->
      <section id="view-home">
        <div class="layout-grid">
          <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <div style="text-align: center; padding: 1rem 0;">
              <div style="font-size: 3rem; margin-bottom: 0.5rem;">üíº</div>
              <div class="hero-heading" style="color: white; margin-bottom: 0.5rem;">Find help or make extra cash</div>
              <div class="hero-sub" style="color: rgba(255,255,255,0.9); margin-bottom: 1.5rem;">
                Connect with local hustlers in Tennessee for moving, yard work, errands, and more
              </div>
              <div class="hero-cta-row" style="justify-content: center;">
                <button class="btn btn-primary" id="homeCtaPost" style="background: white; color: #667eea; border: none; font-weight: 600;">Post a job</button>
                <button class="btn btn-ghost" id="homeCtaBrowse" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">Browse jobs</button>
              </div>
            </div>
          </div>

          <!-- Stripe Section (Moved up) -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üí≥ About Stripe Payments</div>
            </div>
            <div style="font-size: 0.9rem; line-height: 1.7; color: #374151;">
              <p style="margin-bottom: 1rem;">
                <strong>Hustlers must connect a Stripe account to receive payments.</strong> Stripe is a secure payment platform used by millions of businesses worldwide.
              </p>
              <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #2563eb; margin-bottom: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #1e40af;">Why Stripe?</div>
                <ul style="margin: 0; padding-left: 1.25rem; color: #1e3a8a;">
                  <li>Secure and trusted by millions</li>
                  <li>Free to set up and use</li>
                  <li>Automatic payments to your bank account</li>
                  <li>Required to receive payments on Hustl</li>
                </ul>
              </div>
              <p style="margin: 0; color: #6b7280; font-size: 0.85rem;">
                When you sign up as a hustler, you'll be guided through connecting your Stripe account. It only takes a few minutes!
              </p>
            </div>
            <div class="section-title" style="margin-top:1.5rem;">Popular job types</div>
            <div class="pill-row">
              <div class="pill">üöö Moving & dump runs</div>
              <div class="pill">üåø Yard work</div>
              <div class="pill">üßπ Clean-up & organizing</div>
              <div class="pill">üõ† Furniture & set-up</div>
              <div class="pill">üîß Handyman & repairs</div>
              <div class="pill">üé® Painting</div>
              <div class="pill">üå≥ Landscaping</div>
              <div class="pill">üêï Pet care</div>
              <div class="pill">üéâ Event help</div>
              <div class="pill">üíª Tech support</div>
              <div class="pill">‚≠ê Other odd jobs</div>
            </div>
          </div>

          <!-- Quick Step-by-Step Guide (Always Dropdown) -->
          <div class="card">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: #f9fafb; border-radius: 8px; cursor: pointer; user-select: none; border: 1px solid #e5e7eb; transition: all 0.2s; margin-bottom: 0.5rem;" id="howItWorksToggle" class="how-it-works-toggle">
              <div class="section-title" style="margin-top: 0; margin-bottom: 0;">üìã How it works</div>
              <span id="howItWorksArrow" style="transition: transform 0.2s; color: #6b7280; font-size: 0.9rem;">‚ñº</span>
            </div>
            <div id="howItWorksContent" style="display: none; font-size: 0.85rem; line-height: 1.6; color: #374151; padding: 0.5rem 0.25rem;">
              
              <!-- Customer Flow -->
              <div style="margin-bottom: 1rem;">
                <div style="font-weight: 700; font-size: 0.95rem; color: #1f2937; margin-bottom: 0.5rem; padding-bottom: 0.4rem; border-bottom: 1px solid #e5e7eb;">
                  üë§ For Customers
                </div>
                
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.5rem; background: #f9fafb; border-radius: 6px; border-left: 2px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem; font-size: 0.85rem;">1. Post a job</div>
                  <div style="font-size: 0.8rem; color: #374151; line-height: 1.4;">Fill in details, set payment, and wait for hustlers to apply.</div>
                </div>

                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.5rem; background: #f9fafb; border-radius: 6px; border-left: 2px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem; font-size: 0.85rem;">2. Review & accept</div>
                  <div style="font-size: 0.8rem; color: #374151; line-height: 1.4;">Check applications, pick a hustler, and pay securely.</div>
                </div>

                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.5rem; background: #f9fafb; border-radius: 6px; border-left: 2px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.25rem; font-size: 0.85rem;">3. Job completion</div>
                  <div style="font-size: 0.8rem; color: #374151; line-height: 1.4;">Hustler marks complete, you get a verification code. Enter it to release payment.</div>
                </div>
              </div>

              <!-- Hustler Flow -->
              <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <div style="font-weight: 700; font-size: 0.95rem; color: #1f2937; margin-bottom: 0.5rem; padding-bottom: 0.4rem; border-bottom: 1px solid #e5e7eb;">
                  üí™ For Hustlers
                </div>
                
                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.5rem; background: #f9fafb; border-radius: 6px; border-left: 2px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.25rem; font-size: 0.85rem;">1. Connect Stripe <strong style="color: #dc2626;">(REQUIRED FIRST!)</strong></div>
                  <div style="font-size: 0.8rem; color: #374151; line-height: 1.4;"><strong>You cannot apply to jobs until Stripe is connected!</strong> Set up Stripe in your Profile first to receive payments.</div>
                </div>

                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.5rem; background: #f9fafb; border-radius: 6px; border-left: 2px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.25rem; font-size: 0.85rem;">2. Apply to jobs</div>
                  <div style="font-size: 0.8rem; color: #374151; line-height: 1.4;">Browse available jobs, apply with a message, and wait for acceptance. (Stripe must be connected first!)</div>
                </div>

                <div style="margin-bottom: 0.5rem; padding: 0.4rem 0.5rem; background: #f9fafb; border-radius: 6px; border-left: 2px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.25rem; font-size: 0.85rem;">3. Complete & get paid</div>
                  <div style="font-size: 0.8rem; color: #374151; line-height: 1.4;">Mark job complete, share verification code with customer. Payment released after confirmation.</div>
                </div>
              </div>

              <div style="margin-top: 0.75rem; padding: 0.5rem; background: #eff6ff; border-radius: 6px; border-left: 2px solid #2563eb;">
                <div style="font-size: 0.8rem; color: #1e40af; line-height: 1.4;">
                  <strong>üí° Tip:</strong> See the <strong>"About"</strong> page for the complete detailed guide with all steps explained.
                </div>
              </div>

            </div>
          </div>
          
          <div id="homeNoticeCard" class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #fbbf24; padding: 0.75rem 1rem;">
            <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;">
              <div style="flex: 1; font-size: 0.85rem; line-height: 1.6; color: #78350f;">
                <p style="margin: 0; font-weight: 600; margin-bottom: 0.25rem;">
                  ‚ö†Ô∏è Check the <strong>"About"</strong> page for a complete step-by-step guide.
                </p>
                <p style="margin: 0; color: #92400e; font-size: 0.8rem;">
                  Don't miss a step! Learn how everything works before posting or accepting jobs.
                </p>
              </div>
              <button id="dismissHomeNotice" style="flex-shrink: 0; padding: 0.4rem 0.75rem; background: #92400e; color: white; border: none; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap;">Done</button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">Quick facts</div>
            </div>
            <ul class="muted" style="list-style:disc;margin-left:1rem;font-size:0.85rem; line-height: 1.8;">
              <li>Currently serving all of Tennessee</li>
              <li>16% platform fee - the rest goes to the hustler</li>
              <li>Chat with your hustler directly in the app</li>
              <li>Must be 18+ to use Hustl</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- POST JOB VIEW (separate page) -->
      <section id="view-post" style="display:none;">
        <div class="card" id="jobFormCard">
          <div class="card-header">
            <div class="card-title">Post a job</div>
            <span class="badge">Customer only</span>
          </div>
          <div class="muted" style="margin-bottom:0.5rem;">
            You must be logged in as a <strong>Customer</strong> to post jobs. Hustlers will see them in the Jobs list.
          </div>

          <div class="field">
            <label for="jobTitle">Job title</label>
            <input id="jobTitle" type="text" placeholder="Example: Dump run needed" />
          </div>
          
          <div class="field">
            <label for="teamSize">Number of people needed (optional)</label>
            <input 
              id="teamSize" 
              type="number" 
              min="1" 
              max="10" 
              value="1" 
              placeholder="1"
            />
            <div class="muted" style="font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.4;">
              Pick your number. For jobs needing multiple helpers, you hire 1 person who brings their team. For hourly jobs, you pay the hourly rate √ó number of people.
            </div>
          </div>

          <div class="field">
            <label for="jobCategory">Category</label>
            <select id="jobCategory">
              <option value="">Choose a category</option>
              <option value="moving">üöö Moving / Hauling</option>
              <option value="yard">üåø Yard work / Outdoor</option>
              <option value="cleaning">üßπ Cleaning / Organizing</option>
              <option value="furniture">üõ† Furniture / Assembly</option>
              <option value="handyman">üîß Handyman / Repairs</option>
              <option value="painting">üé® Painting</option>
              <option value="landscaping">üå≥ Landscaping / Lawn Care</option>
              <option value="petcare">üêï Pet Care / Dog Walking</option>
              <option value="event">üéâ Event Help / Setup</option>
              <option value="tech">üíª Tech Support / Setup</option>
              <option value="other">‚≠ê Other</option>
            </select>
          </div>

          <div class="field">
            <label for="jobDescription">Description</label>
            <textarea id="jobDescription" placeholder="What needs to be done? Stairs, heavy items, timing, access, etc."></textarea>
          </div>

          <div class="field-inline">
            <div class="field">
              <label for="pickupArea">Pickup area / neighborhood</label>
              <input id="pickupArea" type="text" placeholder="Example: Downtown area" />
            </div>
            <div class="field">
              <label for="pickupCity">City</label>
              <input id="pickupCity" type="text" placeholder="Example: City, TN" />
            </div>
          </div>

          <div class="field-inline">
            <div class="field" style="flex: 2;">
              <label for="pickupAddress">Pickup address (optional)</label>
              <input id="pickupAddress" type="text" placeholder="Street address (shared in chat or after accept)" onblur="this.value = this.value.replace(/[^a-zA-Z0-9,\s]/g, '').replace(/\s+/g, ' ').trim();" />
            </div>
            <div class="field" style="flex: 1;">
              <label for="pickupZip">Zip code</label>
              <input id="pickupZip" type="text" placeholder="37011" maxlength="5" pattern="[0-9]{5}" />
            </div>
          </div>
          
          <div class="field" style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
            <div style="font-size: 0.9rem; color: #1e40af;">
              <strong>üìç Zip Code Info:</strong> Your zip code is required and will always be visible to hustlers. This helps them find jobs in their area and personalize their job feed.
            </div>
          </div>

          <div class="field">
            <label>
              <input type="checkbox" id="jobOnSiteOnly" />
              This job happens only at the pickup location (no separate dropoff).
            </label>
          </div>

          <div id="dropoffFields">
            <div class="field-inline">
              <div class="field">
                <label for="dropoffArea">Dropoff area / neighborhood</label>
                <input id="dropoffArea" type="text" placeholder="Example: Fountain City" />
              </div>
              <div class="field">
                <label for="dropoffCity">Dropoff city</label>
                <input id="dropoffCity" type="text" placeholder="Example: City, TN" />
              </div>
            </div>
            <div class="field">
              <label for="dropoffAddress">Dropoff address (optional)</label>
              <input id="dropoffAddress" type="text" placeholder="Street address (shared in chat or after accept)" />
            </div>
          </div>

          <div class="section-title" style="margin-top:0.5rem;">Payment</div>
          <div class="field-inline">
            <div class="field">
              <label for="paymentType">Payment type</label>
              <select id="paymentType">
                <option value="flat">Flat amount (one-time)</option>
                <option value="hourly">Hourly + max hours</option>
              </select>
            </div>
            <div class="field" id="flatAmountField">
              <label for="flatAmount">Pay ($ flat)</label>
              <input id="flatAmount" type="number" min="0" step="1" value="80" />
            </div>
          </div>

          <div class="field-inline" id="hourlyFields" style="display:none;">
            <div class="field">
              <label for="hourlyRate">Hourly rate per person ($/hr)</label>
              <input id="hourlyRate" type="number" min="0" step="1" value="20" />
              <div class="muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
                This is the rate per person. If you need 3 people at $10/hr, you'll pay $30/hr total.
              </div>
            </div>
            <div class="field">
              <label for="maxHours">Max hours</label>
              <input id="maxHours" type="number" min="1" step="1" value="3" />
              <div class="muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
                You pay for the full max hours even if they finish early. No refunds for early completion.
              </div>
            </div>
          </div>

          <div class="section-title" style="margin-top:0.5rem;">When</div>
          <div class="field-inline">
            <div class="field">
              <label for="jobDateFilter">Date</label>
              <select id="jobDateFilter">
                <option value="today">Today</option>
                <option value="tomorrow">Tomorrow</option>
                <option value="custom">Custom Date</option>
              </select>
            </div>
            <div class="field" id="customDateField" style="display:none;">
              <label for="jobDate">Custom Date</label>
              <input id="jobDate" type="date" />
            </div>
          </div>
          
          <div class="field-inline">
            <div class="field">
              <label for="jobTimeFilter">Time of Day</label>
              <select id="jobTimeFilter">
                <option value="morning">Morning (6am - 12pm)</option>
                <option value="afternoon">Afternoon (12pm - 5pm)</option>
                <option value="evening">Evening (5pm - 9pm)</option>
                <option value="night">Night (9pm - 6am)</option>
                <option value="custom">Custom Time</option>
              </select>
            </div>
            <div class="field-inline" id="customTimeFields" style="display:none;">
              <div class="field">
                <label for="jobStartTime">Start Time</label>
                <input id="jobStartTime" type="time" />
              </div>
              <div class="field">
                <label for="jobEndTime">End Time</label>
                <input id="jobEndTime" type="time" />
              </div>
            </div>
          </div>

          <div class="section-title" style="margin-top:0.5rem;">Job Details</div>
          
          <div class="field">
            <label for="estimatedDuration">Estimated Duration <span style="color: #dc2626;">*</span></label>
            <select id="estimatedDuration" required>
              <option value="">Select duration</option>
              <option value="under-1h">Under 1 hour</option>
              <option value="1-2h">1-2 hours</option>
              <option value="2-4h">2-4 hours</option>
              <option value="4-6h">4-6 hours</option>
              <option value="6-8h">6-8 hours</option>
              <option value="full-day">Full day (8+ hours)</option>
              <option value="multi-day">Multiple days</option>
            </select>
            <div class="muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
              Help hustlers provide accurate quotes by estimating how long the job will take.
            </div>
          </div>

          <div class="field">
            <label>Tools/Equipment Needed <span style="color: #dc2626;">*</span></label>
            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">
              Select at least one tool or equipment that will be needed for this job.
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="toolTruck" value="truck" />
                <span>üöö Truck/Vehicle</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="toolLadder" value="ladder" />
                <span>ü™ú Ladder</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="toolPowerTools" value="power-tools" />
                <span>üîß Power Tools</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="toolHandTools" value="hand-tools" />
                <span>üõ†Ô∏è Hand Tools</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="toolDolly" value="dolly" />
                <span>üì¶ Dolly/Cart</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                <input type="checkbox" id="toolCleaning" value="cleaning-supplies" />
                <span>üßπ Cleaning Supplies</span>
              </label>
            </div>
            <input 
              type="text" 
              id="toolsOther" 
              placeholder="Other tools needed (optional)" 
              style="margin-top: 0.5rem;"
            />
            <div class="muted" style="font-size: 0.85rem; margin-top: 0.25rem;">
              Select all tools/equipment that hustlers need to bring or that you'll provide.
            </div>
          </div>

          <div class="field">
            <label for="jobNotes">Extra notes (optional)</label>
            <textarea id="jobNotes" placeholder="Parking, gate codes, equipment, pets, any special requests."></textarea>
          </div>

          <div class="field">
            <label for="jobPhoto">Optional photo</label>
            <input id="jobPhoto" type="file" accept="image/*" />
          </div>

          <button class="btn btn-primary" id="postJobButton">Post job to Hustl</button>

          <div class="muted" style="margin-top:0.4rem;">
            Your job will be posted and visible to hustlers in your area.
          </div>
        </div>
      </section>

      <!-- JOBS VIEW -->
      <section id="view-jobs" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title" id="jobsCardTitle">Jobs</div>
            <span class="muted" id="jobsFilterSummary"></span>
          </div>
          <!-- Mode-based tabs: Customer sees "My Jobs" and "Available Jobs", Hustler sees "Available Jobs" and "My Hustles" -->
          <div class="job-tabs" id="jobsTabs" style="display: none; margin-bottom: 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
            <span data-tab="my-jobs" class="job-tab active" style="cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; color: var(--text-muted);">My Jobs</span>
            <span data-tab="available" class="job-tab" style="cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; color: var(--text-muted);">Available Jobs</span>
            <span data-tab="my-hustles" class="job-tab" style="cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); display: none;">My Hustles (In Progress)</span>
          </div>
          <!-- Status filters (only shown on My Jobs/My Hustles tabs) -->
          <div class="job-status-group" id="jobsStatusFilter" style="display: none;">
            <!-- Status filters will be dynamically shown based on mode and tab -->
          </div>
          
          <!-- Simple Search Bar -->
          <div style="margin-bottom: 1rem;">
            <div style="position: relative;">
              <input 
                id="jobsSearchInput" 
                type="text" 
                placeholder="üîç Search jobs..." 
                style="width: 100%; padding: 0.75rem 1rem; padding-right: 3rem; font-size: 0.95rem; border: 1px solid #e5e7eb; border-radius: 8px;" 
              />
              <button 
                id="clearSearchBtn" 
                style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; cursor: pointer; font-size: 1.2rem; color: #9ca3af; display: none; padding: 0.25rem;"
                onclick="clearJobSearch()"
              >√ó</button>
            </div>
          </div>
          
          <!-- Simple Filter Buttons (only show most important) -->
          <div id="jobFiltersBar" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
            <button class="filter-btn" data-filter="near-me" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 20px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #374151; transition: all 0.2s;">
              üìç Near Me
            </button>
            <button class="filter-btn active" data-filter="newest" style="padding: 0.5rem 1rem; border: 1px solid #3b82f6; border-radius: 20px; background: #3b82f6; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: white; transition: all 0.2s;">
              ‚è∞ Newest
            </button>
            <button class="filter-btn" data-filter="highest-pay" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 20px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #374151; transition: all 0.2s;">
              üí∞ Highest Pay
            </button>
            <!-- Collapsible "More Filters" button with arrow icon -->
            <button id="showMoreFiltersBtn" class="filter-btn" style="padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 20px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #374151; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.4rem; -webkit-tap-highlight-color: transparent;">
              <span id="showMoreFiltersText">More Filters</span>
              <span id="showMoreFiltersArrow" style="transition: transform 0.3s ease; font-size: 0.9rem;">‚ñº</span>
            </button>
          </div>
          
          <!-- Filters Applied Label - Tappable to reopen filters -->
          <div id="filtersAppliedLabel" style="display: none; margin-bottom: 0.75rem; padding: 0.75rem 1rem; background: #dcfce7; border: 1px solid #16a34a; border-radius: 8px; font-size: 0.9rem; color: #166534; font-weight: 500; cursor: pointer; transition: all 0.2s; user-select: none; -webkit-tap-highlight-color: transparent;">
            <span style="font-size: 1.1rem; margin-right: 0.5rem;">‚úì</span> <span id="filtersAppliedText"></span>
            <span style="float: right; font-size: 0.8rem; color: #059669; margin-left: 0.5rem;">Tap to edit ‚Üí</span>
            <style>
              @media (max-width: 768px) {
                #filtersAppliedLabel {
                  padding: 1rem !important;
                  min-height: 56px;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                }
                #filtersAppliedLabel:active {
                  background: #bbf7d0;
                  transform: scale(0.98);
                }
              }
            </style>
          </div>
          
          <!-- Hidden Advanced Filters (shown when "More" is clicked) - Mobile-optimized -->
          <div id="advancedFiltersContainer" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #f5f7fa; border-radius: 10px; border: 1px solid #e5e7eb; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease, height 0.3s ease; height: 0; overflow: hidden;">
            <style>
              @media (max-width: 768px) {
                #advancedFiltersContainer {
                  position: relative;
                  width: 100%;
                  margin-left: 0;
                  margin-right: 0;
                  padding: 1rem !important;
                  border-radius: 12px !important;
                  margin-top: 0.75rem;
                  margin-bottom: 1.5rem !important;
                  height: 250px !important;
                  overflow-y: auto !important;
                  overflow-x: hidden;
                  -webkit-overflow-scrolling: touch;
                  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                  z-index: 100;
                }
                #applyFiltersBtn {
                  position: sticky;
                  bottom: 0;
                  background: var(--primary) !important;
                  color: white !important;
                  font-weight: 700 !important;
                  font-size: 1rem !important;
                  padding: 1rem !important;
                  min-height: 56px !important;
                  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
                  margin-top: 1rem !important;
                  width: 100%;
                }
              }
            </style>
            <!-- Distance Slider -->
            <div style="margin-bottom: 1rem;">
              <label for="jobsRadiusSlider" style="font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; display: block; font-weight: 500;">Distance (miles)</label>
              <input type="range" id="jobsRadiusSlider" min="1" max="50" step="1" value="10" style="width: 100%; height: 8px; border-radius: 4px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;" />
              <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">
                <span>0 mi</span>
                <span id="radiusValueDisplay" style="font-weight: 600; color: #2563eb;">10 mi</span>
                <span>50 mi</span>
              </div>
              <!-- Hidden select for backward compatibility -->
              <select id="jobsRadiusFilter" style="display: none;">
                <option value="5">5 mi</option>
                <option value="10" selected>10 mi</option>
                <option value="15">15 mi</option>
                <option value="20">20 mi</option>
                <option value="25">25 mi</option>
                <option value="30">30 mi</option>
                <option value="40">40 mi</option>
                <option value="50">50 mi</option>
              </select>
            </div>
            
            <!-- Location Input (ZIP or City) -->
            <div style="margin-bottom: 1rem;">
              <label for="jobsLocationFilter" style="font-size: 0.9rem; color: #374151; margin-bottom: 0.5rem; display: block; font-weight: 500;">Location (optional)</label>
              <input id="jobsLocationFilter" type="text" placeholder="ZIP or City (leave blank for 'Near Me')" style="width: 100%; padding: 0.6rem; font-size: 0.9rem; border: 1px solid #d1d5db; border-radius: 8px; background: white;" />
              <div id="locationStatus" style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem; font-style: italic;">If blank, uses your device location</div>
            </div>
            
            <!-- Apply Filters and Reset Buttons -->
            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
              <button id="applyFiltersBtn" class="btn btn-primary" style="flex: 1; padding: 0.6rem 1rem; font-size: 0.9rem; font-weight: 600; min-height: 44px;">
                ‚úì Apply Filters
              </button>
              <button id="resetFiltersBtn" class="btn outline" style="padding: 0.6rem 1rem; font-size: 0.85rem; white-space: nowrap; min-height: 44px;">
                Reset
              </button>
            </div>
          </div>
          
          <!-- Hidden date/time filters (removed from main view, kept for backward compatibility) -->
          <div style="display: none;">
            <select id="jobsDateFilter">
              <option value="">All Dates</option>
              <option value="today">Today</option>
              <option value="tomorrow">Tomorrow</option>
            </select>
            <select id="jobsTimeFilter">
              <option value="">All Times</option>
              <option value="morning">Morning</option>
              <option value="afternoon">Afternoon</option>
              <option value="evening">Evening</option>
              <option value="night">Night</option>
            </select>
          </div>
          <div class="jobs-list" id="jobsList"></div>
          <div id="loadMoreJobsContainer" style="text-align: center; margin-top: 1rem; display: none;">
            <button id="loadMoreJobsBtn" class="btn outline" style="padding: 0.75rem 2rem;">Load More Jobs</button>
          </div>
          <div id="jobDetailContainer"></div>
        </div>
      </section>

      <!-- MESSAGES VIEW -->
      <section id="view-messages" style="display:none; padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));">
        <div class="layout-grid">
          <!-- Conversation List Container (shown on mobile when no conversation selected) -->
          <div class="card" id="conversationListContainer">
            <div class="card-header">
              <button class="mobile-back-btn" id="messagesBackBtn" style="display: none;">‚Üê</button>
              <div class="card-title">Messages</div>
            </div>
            <!-- Applications section for customers -->
            <div id="applicationsQuickAccess" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #fbbf24;">
              <div style="font-weight: 600; font-size: 0.9rem; color: #92400e; margin-bottom: 0.5rem;">üìã Pending Applications</div>
              <div id="applicationsQuickList" style="font-size: 0.85rem; color: #78350f;"></div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Each conversation is tied to a specific job. Think of it like texting, but only about that job.
            </div>
            <div style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem;">
              <button id="showArchivedBtn" class="small-btn" style="background: #f3f4f6; color: #6b7280;">
                üì¶ Show Archived
              </button>
              <button id="showDeletedBtn" class="small-btn" style="background: #fee2e2; color: #991b1b;">
                üóë Show Deleted
              </button>
            </div>
            <div class="jobs-list" id="conversationList"></div>
          </div>
          
          <!-- Conversation Container (shown on mobile when conversation is selected) -->
          <div class="card" id="conversationContainer">
            <div class="card-header">
              <button class="mobile-back-btn" id="conversationBackBtn" style="display: none;">‚Üê</button>
              <div class="card-title" id="conversationTitle">Select a conversation</div>
            </div>
            <div id="conversationJobSummary" class="muted" style="margin-bottom:0.5rem;"></div>
            <div class="chat-box">
              <div class="chat-messages" id="conversationMessages"></div>
              <div class="chat-input-row">
                <input id="conversationInput" type="text" placeholder="Type a message..." />
                <button class="btn btn-primary" id="conversationSendButton">Send</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header" style="margin-bottom: 1rem;">
              <div class="card-title" style="margin-bottom: 0;">Your profile</div>
            </div>
            <div id="profileContent"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Your jobs</div>
            </div>
            <div class="jobs-list" id="profileJobsList"></div>
          </div>
        </div>
      </section>

      <!-- OWNER VIEW -->
      <section id="view-owner" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Owner dashboard</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Shows paid jobs, your 16% fee, and whether you've sent the Hustler their payout.
            </div>
            <div id="ownerPaidList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Assigned but not paid yet</div>
            </div>
            <div id="ownerAssignedList"></div>
          </div>
        </div>
      </section>

      <!-- ABOUT / LEGAL VIEW -->
      <section id="view-about" style="display:none;">
        <div class="layout-grid">
          <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
            <div style="text-align: center; padding: 1rem 0;">
              <div style="font-size: 3rem; margin-bottom: 0.5rem;">üíº</div>
              <h1 style="margin: 0; font-size: 2rem; font-weight: 700; color: white;">About Hustl</h1>
              <div style="font-size: 0.95rem; opacity: 0.9; margin-top: 0.5rem;">Built in Tennessee</div>
            </div>
          </div>
          
          <div class="card">
            <div style="font-size: 1.1rem; line-height: 1.8; color: #374151;">
              <p style="margin: 0 0 1.25rem 0; font-weight: 500;">
                Hustl was built with a simple goal: make it easier for people to help each other and make real money on the side.
              </p>
              
              <div style="margin: 1.5rem 0;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 1.05rem;">For Customers</div>
                <p style="margin: 0; color: #6b7280;">
                  Need help moving a couch, doing a dump run, cleaning out a garage, tackling yard work, or knocking out random errands? You shouldn't have to blast group chats or scroll through sketchy posts. Describe the job, set a fair price, and connect with someone local who's ready to work.
                </p>
              </div>
              
              <div style="margin: 1.5rem 0;">
                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem; font-size: 1.05rem;">For Hustlers</div>
                <p style="margin: 0; color: #6b7280;">
                  Turn your time, truck, or muscle into extra cash on your own schedule. No long-term commitments, no complicated contracts ‚Äì just clear jobs, clear payouts, and a straightforward platform fee.
                </p>
              </div>
              
              <div style="margin: 1.5rem 0 0 0; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                <p style="margin: 0; color: #6b7280;">
                  Hustl is about supporting small, local businesses and solo operators. As the platform grows, the same tools that help with one-time jobs can help people build regular clients, repeat work, and real side-income in the community.
                </p>
              </div>
              
              <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #2563eb;">
                <p style="margin: 0; font-weight: 600; color: #1e40af; font-size: 1.05rem;">
                  Post a job, apply to one, show up, do solid work, and get paid ‚Äì that's the heart of Hustl.
                </p>
              </div>
            </div>
          </div>

          <!-- Complete Step-by-Step Guide -->
          <div class="card">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: #f9fafb; border-radius: 8px; cursor: pointer; user-select: none; border: 1px solid #e5e7eb; transition: all 0.2s; margin-bottom: 0.5rem;" id="stepByStepToggle">
              <div class="card-title" style="margin: 0; font-size: 1rem;">üìã Complete Step-by-Step Guide</div>
              <span id="stepByStepArrow" style="transition: transform 0.2s; color: #6b7280; font-size: 0.9rem;">‚ñº</span>
            </div>
            <div id="stepByStepContent" style="display: none; font-size: 0.9rem; line-height: 1.7; color: #374151;">
              
              <!-- Customer Flow -->
              <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 700; font-size: 1.05rem; color: #1f2937; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
                  üë§ For Customers: How to Post a Job and Get It Done
                </div>
                
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 1: Create Your Account</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Click "Sign in / Create account"</li>
                    <li>Fill in your name, email, password, city, and zip code</li>
                    <li><strong>Agree to Terms of Service and confirm you're 18+</strong></li>
                    <li>Select "Customer" role (or both Customer and Hustler)</li>
                    <li>You're all set! Complete your profile with a photo if you want</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 2: Post Your Job</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Go to "Post a job" tab</li>
                    <li>Fill in job title, description, category, location, date, and budget</li>
                    <li>Add zip code (required for location matching - will be visible to hustlers)</li>
                    <li>Upload photos if helpful</li>
                    <li>Click "Post job" - it will appear in the Jobs list for hustlers to see</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 3: Review Applications</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Hustlers will apply to your job with a message</li>
                    <li><strong>You'll receive an email notification</strong> when someone applies</li>
                    <li>Go to your job details to see "Pending Applications"</li>
                    <li>Review each hustler's profile, rating, and message</li>
                    <li>Choose who you want to work with</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 4: Accept a Hustler & Pay</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li><strong>Important:</strong> Hustler must have Stripe connected (they'll be notified if not)</li>
                    <li>Click "Accept" on the hustler you want</li>
                    <li>You'll be taken to payment - <strong>payment is required before the job date</strong></li>
                    <li>Payment is pre-authorized (held securely) until job completion</li>
                    <li>After payment, you can message the hustler directly</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 5: Communicate & Coordinate</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Use the Messages tab to chat with your hustler</li>
                    <li><strong>You'll get email notifications</strong> when they send you a message</li>
                    <li>Coordinate details like exact address, timing, access codes, etc.</li>
                    <li>Remember: Don't share contact info before job is assigned (for safety)</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 6: Job Completion & Verification Code</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>When the hustler finishes, they'll mark the job as complete</li>
                    <li><strong>You'll receive an email with a 6-digit verification code</strong></li>
                    <li>The hustler will also see this code in the app</li>
                    <li>Go to your job details and you'll see "Hustler marked job as complete"</li>
                    <li><strong>Enter the verification code</strong> the hustler gives you</li>
                    <li>Confirm completion - payment will be released to the hustler</li>
                    <li>You can then leave a review!</li>
                  </ul>
                </div>

                <div style="padding: 0.75rem; background: #fef3c7; border-radius: 8px; border-left: 3px solid #fbbf24;">
                  <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem; font-size: 0.9rem;">‚ö†Ô∏è Important Reminders for Customers:</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #78350f; line-height: 1.6; font-size: 0.85rem;">
                    <li>Payment must be completed <strong>before the job date</strong></li>
                    <li>Always verify the completion code matches before confirming</li>
                    <li>Check your email for notifications about applications and messages</li>
                    <li>You can message hustlers anytime after accepting them</li>
                  </ul>
                </div>
              </div>

              <!-- Hustler Flow -->
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                <div style="font-weight: 700; font-size: 1.05rem; color: #1f2937; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb;">
                  üí™ For Hustlers: How to Find Jobs and Get Paid
                </div>
                
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 1: Create Your Account & Connect Stripe</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Click "Sign in / Create account"</li>
                    <li>Fill in your name, email, password, city, and zip code</li>
                    <li><strong>Agree to Terms of Service and confirm you're 18+</strong></li>
                    <li>Select "Hustler" role (or both Customer and Hustler)</li>
                    <li><strong>CRITICAL:</strong> Go to your Profile and connect your Stripe account</li>
                    <li><strong>You CANNOT be accepted for jobs without Stripe connected!</strong></li>
                    <li>Stripe is free and secure - it's how you get paid</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 2: Browse Available Jobs</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Go to the "Jobs" tab</li>
                    <li>Use "Use My Location" or enter a zip code to find nearby jobs</li>
                    <li>Filter by category, date, or price</li>
                    <li>Click on any job to see full details</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 3: Apply to Jobs</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>When you find a job you want, click "Apply"</li>
                    <li>Write a message to the customer (introduce yourself, explain why you're a good fit)</li>
                    <li>You can propose a different price if needed</li>
                    <li>Click "Submit application"</li>
                    <li><strong>The customer will receive an email notification</strong> about your application</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 4: Get Accepted & Communicate</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>If the customer accepts you, <strong>you'll receive an email notification</strong></li>
                    <li>The job will move to "Jobs you're doing" in your profile</li>
                    <li>You can now message the customer directly</li>
                    <li><strong>You'll get email notifications</strong> when they send you messages</li>
                    <li>Coordinate details like exact address, timing, access, etc.</li>
                    <li>Wait for customer to complete payment (required before job date)</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 5: Complete the Job</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Show up on time and do the work</li>
                    <li>When finished, go to the job details and click "Mark Job as Complete"</li>
                    <li><strong>You'll receive a 6-digit verification code</strong></li>
                    <li><strong>Share this code with the customer</strong> (they need it to confirm)</li>
                    <li>The customer will also receive the code via email</li>
                    <li>Wait for customer to enter the code and confirm completion</li>
                  </ul>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #047857; margin-bottom: 0.5rem; font-size: 0.95rem;">Step 6: Get Paid</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #374151; line-height: 1.6; font-size: 0.85rem;">
                    <li>Once customer confirms with the verification code, payment is released</li>
                    <li><strong>You'll receive an email</strong> when payment is released</li>
                    <li>Payment goes to your Stripe account (minus 16% platform fee)</li>
                    <li>Stripe automatically transfers to your bank account</li>
                    <li>You can see payment status in the job details</li>
                    <li>Customer can leave you a review!</li>
                  </ul>
                </div>

                <div style="padding: 0.75rem; background: #d1fae5; border-radius: 8px; border-left: 3px solid #10b981;">
                  <div style="font-weight: 600; color: #065f46; margin-bottom: 0.5rem; font-size: 0.9rem;">‚úÖ Important Reminders for Hustlers:</div>
                  <ul style="margin: 0; padding-left: 1.25rem; color: #047857; line-height: 1.6; font-size: 0.85rem;">
                    <li><strong>You MUST connect Stripe before you can be accepted for any job</strong></li>
                    <li>Always share your verification code with the customer after completing work</li>
                    <li>Check your email for notifications about job assignments and messages</li>
                    <li>Payment status is shown in job details - you'll see when payment is secured</li>
                    <li>16% platform fee is deducted automatically (you keep 84%)</li>
                  </ul>
                </div>
              </div>

              <!-- Verification Code Explanation -->
              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                <div style="font-weight: 700; font-size: 1.05rem; color: #1f2937; margin-bottom: 0.75rem;">
                  üîê About Verification Codes
                </div>
                <div style="padding: 0.75rem; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #2563eb;">
                  <p style="margin: 0 0 0.75rem 0; color: #1e3a8a; line-height: 1.6; font-size: 0.85rem;">
                    Verification codes ensure both parties confirm the job is complete before payment is released. Here's how it works:
                  </p>
                  <ol style="margin: 0; padding-left: 1.25rem; color: #1e40af; line-height: 1.6; font-size: 0.85rem;">
                    <li><strong>Hustler marks job complete</strong> ‚Üí System generates a 6-digit code</li>
                    <li><strong>Code is sent to customer via email</strong> and shown to hustler in app</li>
                    <li><strong>Hustler shares code with customer</strong> (in person or via message)</li>
                    <li><strong>Customer enters code</strong> to confirm completion</li>
                    <li><strong>Code is verified</strong> ‚Üí Payment is released to hustler</li>
                  </ol>
                  <p style="margin: 0.75rem 0 0 0; color: #1e3a8a; font-weight: 600; font-size: 0.85rem;">
                    This protects both parties and ensures everyone agrees the work is done!
                  </p>
                </div>
              </div>

            </div>
          </div>
        </div>
        
        <!-- Feedback Form (moved from separate tab) -->
        <div class="card" style="margin-top: 1.5rem;">
          <div class="card-header">
            <div class="card-title">Send Feedback</div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            This isn't a public review wall. It's a private way to send feedback directly to the Hustl team
            (<strong>team.hustlapp@outlook.com</strong>) about bugs, ideas, or issues.
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="feedbackName">Name (optional)</label>
              <input id="feedbackName" type="text" placeholder="Your name or leave blank" />
            </div>
            <div class="field">
              <label for="feedbackEmail">Email (optional)</label>
              <input id="feedbackEmail" type="email" placeholder="So we can reply if needed" />
            </div>
          </div>
          <div class="field">
            <label for="feedbackMessage">Feedback</label>
            <textarea id="feedbackMessage" placeholder="Tell us what's working, what's confusing, or what you'd love to see."></textarea>
          </div>
          <button class="btn btn-primary" id="feedbackButton">Send feedback</button>
          <div class="feedback-note">
            Your feedback will be sent to the Hustl team.
          </div>
        </div>
      </section>

    </main>

    <footer>
      <div class="footer-row">
        <div>¬© 2025 Hustl. All rights reserved.</div>
        <div class="footer-links">
          <span id="footerTermsLink" style="cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Terms of Use</span>
          <span>‚Ä¢</span>
          <span id="footerPrivacyLink" style="cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Privacy Policy</span>
          <span>‚Ä¢</span>
          <a href="mailto:team.hustlapp@outlook.com" style="display: inline-flex; align-items: center; gap: 0.4rem; color: #e5e7eb; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <span>team.hustlapp@outlook.com</span>
          </a>
          <span>‚Ä¢</span>
          <a href="https://instagram.com/team.hustlapp" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.4rem; color: #e5e7eb; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
            </svg>
            <span>@team.hustlapp</span>
          </a>
        </div>
      </div>
    </footer>

       <div class="toast" id="toast"></div>

    <!-- Age gate disabled: popup hidden -->
    <div class="age-gate-overlay" id="ageGate" style="display:none !important; pointer-events:none !important; z-index:-1 !important;">
      <div class="age-gate-card">
        <h2>Are you 18 or older?</h2>
        <p>
          Hustl is for adults only. By continuing, you confirm that you are at least 18 years old
          and understand our terms of service.
        </p>
        <div class="age-gate-buttons">
          <button class="btn btn-primary" id="ageYesButton">Yes, I‚Äôm 18+</button>
          <button class="btn btn-ghost" id="ageNoButton">No</button>
        </div>
        <div class="muted" style="margin-top:0.4rem;">
          If you tap ‚ÄúNo‚Äù, we‚Äôll just hide the app. You can come back when you‚Äôre older.
        </div>
      </div>
    </div>
  </div>

<!-- Mobile-First Optimizations - TaskRabbit/Rover-level mobile experience -->
<link rel="stylesheet" href="/mobile-optimizations.css">
<!-- Mobile-First Core - TaskRabbit/Rover-level mobile experience -->
<script src="/mobile-core.js"></script>
<!-- Modern App Core - Performance optimizations, caching, debouncing -->
<script src="/app-core.js"></script>
<script src="/api-integration.js?v=3"></script>
  <script>
// ==== API Integration (replaces Supabase) ====
// All API calls now go through window.hustlAPI

    const STORAGE_KEY = "hustl_state_v3";
    const BACKEND_URL = window.location.origin; // Use same origin (backend serves frontend)

    // üîî Auto-complete after 72 hours of no customer response
    const AUTO_COMPLETE_HOURS = 72;
    const AUTO_COMPLETE_MS = AUTO_COMPLETE_HOURS * 60 * 60 * 1000;

    let state = {
      users: [],
      currentUserId: null,
      jobs: [],
      feedback: [],
    };

    let activeView = "home";
    let activeJobsStatusFilter = "all";
    let activeJobFilter = 'newest'; // Default filter: newest jobs first
    let filtersDrawerOpen = false; // Track if filters drawer is open
    let activeConversationJobId = null;
    let showArchivedConversations = false;
    let showDeletedConversations = false;
    let userMode = "customer"; // "customer" or "hustler" - simple toggle like Airbnb/Rover
    
    // Pagination state
    let currentJobsPage = 1;
    let allLoadedJobs = [];
    let jobsPagination = { hasMore: false };
    
    // Modern state management - dismissed jobs (for hustlers)
    const DISMISSED_JOBS_KEY = "hustl_dismissed_jobs_v1";
    let dismissedJobIds = new Set();
    
    // Load dismissed jobs from localStorage
    function loadDismissedJobs() {
      try {
        const stored = localStorage.getItem(DISMISSED_JOBS_KEY);
        if (stored) {
          dismissedJobIds = new Set(JSON.parse(stored));
        }
      } catch (e) {
        console.error("Error loading dismissed jobs:", e);
      }
    }
    
    // Save dismissed jobs to localStorage
    function saveDismissedJobs() {
      try {
        localStorage.setItem(DISMISSED_JOBS_KEY, JSON.stringify(Array.from(dismissedJobIds)));
      } catch (e) {
        console.error("Error saving dismissed jobs:", e);
      }
    }
    
    // Dismiss a job (for hustlers)
    function dismissJob(jobId) {
      dismissedJobIds.add(jobId);
      saveDismissedJobs();
      // Re-render jobs to hide the dismissed one
      renderJobs(false);
      showToast("‚úì Job removed from your feed");
    }
    
    // Load dismissed jobs on page load
    loadDismissedJobs();

    /* ---------- Utilities ---------- */

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
        }
      } catch (e) {
        console.error("Error loading state", e);
      }
    }

    function getCurrentUser() {
      return state.users.find((u) => u.id === state.currentUserId) || null;
    }

    function generateId(prefix) {
      return (
        prefix +
        "_" +
        Date.now().toString(36) +
        "_" +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function formatMoney(amount) {
      const n = Number(amount) || 0;
      return "$" + n.toFixed(2);
    }

    // Calculate distance between two coordinates (Haversine formula) - returns miles
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function timeAgo(timestamp) {
      if (!timestamp) return "";
      const now = Date.now();
      const diffMs = now - timestamp;
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return diffMin + " min ago";
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return diffHr + " hr ago";
      const diffDay = Math.floor(diffHr / 24);
      if (diffDay === 1) return "yesterday";
      return diffDay + " days ago";
    }

    let toastTimeout = null;
    // üöÄ MOBILE: Show "YOU'RE HIRED!" banner when hustler gets accepted
    function showHiredBanner(jobId, jobTitle = "Job") {
      // Remove any existing hired banner
      const existing = document.getElementById("hiredBannerOverlay");
      if (existing) existing.remove();
      
      const isMobile = window.innerWidth <= 768;
      
      const overlay = document.createElement("div");
      overlay.id = "hiredBannerOverlay";
      overlay.style.position = "fixed";
      overlay.style.top = "0";
      overlay.style.left = "0";
      overlay.style.width = "100%";
      overlay.style.height = "100%";
      overlay.style.background = isMobile ? "white" : "rgba(0, 0, 0, 0.7)";
      overlay.style.zIndex = "10001";
      overlay.style.display = "flex";
      overlay.style.alignItems = isMobile ? "flex-start" : "center";
      overlay.style.justifyContent = "center";
      overlay.style.padding = isMobile ? "1rem" : "2rem";
      overlay.style.overflowY = "auto";
      overlay.style.webkitOverflowScrolling = "touch";
      
      const modal = document.createElement("div");
      modal.className = isMobile ? "hired-banner-mobile" : "hired-banner";
      modal.style.cssText = isMobile 
        ? "width: 100%; max-width: 100%; padding: 1.5rem; background: white;"
        : "max-width: 500px; width: 100%;";
      
      modal.innerHTML = `
        <div class="hired-banner" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: ${isMobile ? '2rem 1rem' : '3rem 2rem'}; text-align: center; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
          <div class="hired-banner-title" style="font-size: ${isMobile ? '2rem' : '2.5rem'}; font-weight: 700; margin-bottom: 0.5rem;">
            üéâ YOU'RE HIRED! üéâ
          </div>
          <div class="hired-banner-subtitle" style="font-size: ${isMobile ? '1rem' : '1.2rem'}; opacity: 0.95; margin-bottom: 1.5rem;">
            Congratulations! You were picked as the Hustler for this job.
          </div>
          <div style="background: rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem;">Job: ${jobTitle}</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Check your email for details. You can now message the customer!</div>
          </div>
          <button id="viewHiredJobBtn" class="mobile-job-details-action-btn" style="width: 100%; padding: 1rem; background: white; color: #059669; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; min-height: 56px; -webkit-tap-highlight-color: transparent;">
            View Job Details ‚Üí
          </button>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      document.body.style.overflow = "hidden";
      
      // View job button
      const viewBtn = modal.querySelector("#viewHiredJobBtn");
      viewBtn.addEventListener("click", () => {
        overlay.remove();
        document.body.style.overflow = "";
        setView("jobs");
        setTimeout(() => {
          openJobDetails(jobId);
        }, 300);
      });
      
      // Close on overlay click (desktop only)
      if (!isMobile) {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            overlay.remove();
            document.body.style.overflow = "";
          }
        });
      }
      
      // Close on Escape
      const escapeHandler = (e) => {
        if (e.key === "Escape") {
          overlay.remove();
          document.body.style.overflow = "";
          document.removeEventListener("keydown", escapeHandler);
        }
      };
      document.addEventListener("keydown", escapeHandler);
      
      // Prevent closing on modal click
      modal.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    }

    // Show verification code modal popup (mobile-optimized)
    function showVerificationCodeModal(code, jobId, jobTitle = "Job") {
      // Remove any existing verification code modal
      const existing = document.getElementById("verificationCodeModal");
      if (existing) existing.remove();
      
      const isMobile = window.innerWidth <= 768;
      
      const overlay = document.createElement("div");
      overlay.id = "verificationCodeModal";
      overlay.className = isMobile ? "mobile-job-details-overlay" : "modal-overlay";
      overlay.style.position = "fixed";
      overlay.style.top = "0";
      overlay.style.left = "0";
      overlay.style.width = "100%";
      overlay.style.height = "100%";
      overlay.style.background = isMobile ? "white" : "rgba(0, 0, 0, 0.7)";
      overlay.style.zIndex = "10000";
      overlay.style.display = "flex";
      overlay.style.alignItems = isMobile ? "flex-start" : "center";
      overlay.style.justifyContent = "center";
      overlay.style.padding = isMobile ? "1rem" : "2rem";
      overlay.style.overflowY = "auto";
      overlay.style.webkitOverflowScrolling = "touch";
      
      const modal = document.createElement("div");
      modal.className = isMobile ? "hired-code-box" : "";
      modal.style.cssText = isMobile
        ? "width: 100%; max-width: 100%; background: white; padding: 1.5rem;"
        : "background: #fff; border-radius: 12px; padding: 2rem; max-width: 400px; width: 100%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);";
      
      // üöÄ MOBILE: Back button on mobile
      if (isMobile) {
        const backBtn = document.createElement("button");
        backBtn.innerHTML = "‚Üê Back";
        backBtn.style.cssText = "width: 100%; padding: 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; min-height: 48px; -webkit-tap-highlight-color: transparent;";
        backBtn.addEventListener("click", () => {
          overlay.remove();
          document.body.style.overflow = "";
        });
        modal.appendChild(backBtn);
      }
      
      const codeSection = document.createElement("div");
      codeSection.innerHTML = `
        <div style="text-align: center; margin-bottom: ${isMobile ? '1rem' : '1.5rem'};">
          <div style="font-size: ${isMobile ? '1.3rem' : '1.5rem'}; font-weight: 700; margin-bottom: 0.5rem; color: #059669;">üîê Verification Code</div>
          <div style="font-size: ${isMobile ? '0.85rem' : '0.9rem'}; color: #6b7280;">Share this code with the customer to confirm job completion</div>
        </div>
        
        <div class="hired-code-box" style="background: #f0fdf4; border: ${isMobile ? '2px' : '3px'} solid #059669; border-radius: ${isMobile ? '12px' : '8px'}; padding: ${isMobile ? '1.5rem 1rem' : '1.5rem'}; margin-bottom: ${isMobile ? '1rem' : '1.5rem'}; text-align: center;">
          <div style="font-size: ${isMobile ? '0.75rem' : '0.85rem'}; font-weight: 600; margin-bottom: 0.5rem; color: #047857; text-transform: uppercase; letter-spacing: 0.1em;">Your Code</div>
          <div class="hired-code" style="font-size: ${isMobile ? '2rem' : '2.5rem'}; font-weight: 700; letter-spacing: ${isMobile ? '0.2em' : '0.3em'}; color: #059669; font-family: 'Courier New', monospace; margin: 0.5rem 0;">
            ${code}
          </div>
          <div style="font-size: ${isMobile ? '0.75rem' : '0.8rem'}; color: #047857; margin-top: 0.5rem;">
            Job: ${jobTitle}
          </div>
        </div>
        
        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px; padding: 0.75rem; margin-bottom: 1.5rem; font-size: 0.85rem; color: #92400e;">
          <strong>‚ö†Ô∏è Important:</strong> The customer has 48 hours to enter this code. If they don't enter it and don't report an issue, payment will be automatically released to you.
        </div>
        
        <div style="display: flex; gap: 0.5rem; flex-direction: ${isMobile ? 'column' : 'row'};">
          <button id="copyCodeBtn" class="mobile-job-details-action-btn" style="flex: 1; padding: ${isMobile ? '1rem' : '0.75rem'}; background: #059669; color: white; border: none; border-radius: 8px; font-size: ${isMobile ? '1rem' : '0.9rem'}; font-weight: 600; cursor: pointer; min-height: ${isMobile ? '56px' : '44px'}; -webkit-tap-highlight-color: transparent;">
            üìã Copy Code
          </button>
          ${!isMobile ? `<button id="closeCodeModalBtn" class="btn" style="flex: 1; background: #f3f4f6; color: #374151; min-height: 44px;">
            Close
          </button>` : ''}
        </div>
        
        <div style="margin-top: ${isMobile ? '1rem' : '1rem'}; text-align: center;">
          <button id="viewInActiveJobsBtn" class="btn" style="background: transparent; color: #059669; text-decoration: underline; font-size: ${isMobile ? '0.95rem' : '0.9rem'}; padding: 0.5rem; min-height: ${isMobile ? '48px' : 'auto'};">
            View in Active Jobs ‚Üí
          </button>
        </div>
      `;
      
      codeSection.style.padding = isMobile ? "0" : "";
      modal.appendChild(codeSection);
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Copy code button
      const copyBtn = modal.querySelector("#copyCodeBtn");
      copyBtn.addEventListener("click", () => {
        navigator.clipboard.writeText(code).then(() => {
          copyBtn.textContent = "‚úì Copied!";
          copyBtn.style.background = "#10b981";
          setTimeout(() => {
            copyBtn.textContent = "üìã Copy Code";
            copyBtn.style.background = "";
          }, 2000);
        }).catch(() => {
          showToast("Failed to copy code");
        });
      });
      
      // Close button
      const closeBtn = modal.querySelector("#closeCodeModalBtn");
      closeBtn.addEventListener("click", () => {
        overlay.remove();
      });
      
      // View in Active Jobs button
      const viewBtn = modal.querySelector("#viewInActiveJobsBtn");
      viewBtn.addEventListener("click", () => {
        overlay.remove();
        setView("jobs");
        // Filter to show active jobs and scroll to this job
        setTimeout(() => {
          const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
          if (jobCard) {
            jobCard.scrollIntoView({ behavior: "smooth", block: "center" });
            jobCard.style.background = "#fef3c7";
            setTimeout(() => {
              jobCard.style.background = "";
            }, 3000);
          }
        }, 100);
      });
      
      // Close on overlay click
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) {
          overlay.remove();
          document.body.style.overflow = "";
        }
      });
      
      // Close on Escape key
      const escapeHandler = (e) => {
        if (e.key === "Escape") {
          overlay.remove();
          document.body.style.overflow = "";
          document.removeEventListener("keydown", escapeHandler);
        }
      };
      document.addEventListener("keydown", escapeHandler);
      
      // Prevent closing on modal click
      modal.addEventListener("click", (e) => {
        e.stopPropagation();
      });
    }

    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        el.classList.remove("show");
      }, 2200);
    }

    // Show review modal after job payment
    async function showReviewModal(jobId, revieweeId, revieweeName) {
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      overlay.style.zIndex = "3000";
      
      const modal = document.createElement("div");
      modal.className = "modal-content";
      modal.style.padding = "2rem";
      modal.style.maxWidth = "500px";
      
      let selectedStars = 0;
      
      modal.innerHTML = `
        <h2 style="margin: 0 0 1rem 0;">Leave a Review</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-muted);">
          How was your experience with <strong>${revieweeName}</strong>?
        </p>
        
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Rating</label>
          <div id="starRating" style="display: flex; gap: 0.5rem; font-size: 2rem; cursor: pointer;">
            ${[1,2,3,4,5].map(i => `<span data-star="${i}" style="color: #d1d5db;">‚òÖ</span>`).join('')}
          </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
          <label for="reviewText" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Review</label>
          <textarea id="reviewText" placeholder="Tell others about your experience (min 10 characters)" 
            style="width: 100%; min-height: 100px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit;"></textarea>
        </div>
        
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button id="skipReviewBtn" class="btn outline">Skip</button>
          <button id="submitReviewBtn" class="btn btn-primary" disabled>Submit Review</button>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      document.body.style.overflow = "hidden";
      
      // Star rating interaction
      const stars = modal.querySelectorAll('[data-star]');
      const reviewText = modal.querySelector('#reviewText');
      const submitBtn = modal.querySelector('#submitReviewBtn');
      
      stars.forEach((star, index) => {
        star.addEventListener('click', () => {
          selectedStars = index + 1;
          stars.forEach((s, i) => {
            s.style.color = i < selectedStars ? '#fbbf24' : '#d1d5db';
          });
          submitBtn.disabled = selectedStars === 0 || reviewText.value.trim().length < 10;
        });
      });
      
      reviewText.addEventListener('input', () => {
        submitBtn.disabled = selectedStars === 0 || reviewText.value.trim().length < 10;
      });
      
      // Skip button
      modal.querySelector('#skipReviewBtn').addEventListener('click', () => {
        overlay.remove();
        document.body.style.overflow = "";
        renderJobs();
      });
      
      // Submit button
      submitBtn.addEventListener('click', async () => {
        if (selectedStars === 0 || reviewText.value.trim().length < 10) {
          showToast("Please select a rating and write at least 10 characters.");
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        
        try {
          await window.hustlAPI.reviews.create(jobId, revieweeId, selectedStars, reviewText.value.trim());
          showToast("‚úì Review submitted! Thank you.");
          if (overlay && overlay.parentNode) {
            overlay.remove();
          }
          if (document.body) {
            document.body.style.overflow = "";
          }
          renderJobs();
        } catch (error) {
          showToast("Error: " + (error.message || "Failed to submit review"));
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Review";
        }
      });
      
      // Close on overlay click
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
          document.body.style.overflow = "";
          renderJobs();
        }
      });
    }

    // ‚è± Auto-complete checker: if Hustler marked finished and no dispute + no response in time
    function checkAutoCompleteJobs() {
      const now = Date.now();
      let changed = false;

      state.jobs.forEach((job) => {
        if (
          job &&
          job.status === "assigned" &&
          job.completionRequestedAt &&
          !job.dispute &&
          !job.autoCompleted
        ) {
          if (now - job.completionRequestedAt >= AUTO_COMPLETE_MS) {
            job.status = "completed";// If there's a hustler, this will now appear in Owner payout queue
if (job.acceptedHustlerId) {
  console.log("Job moved to payout queue:", job.id);
}

            job.autoCompleted = true;
            changed = true;
          }
        }
      });

      if (changed) {
        saveState();
        renderAll();
      }
    }

    /* ---------- Age gate (disabled) ---------- */

    function checkAgeGate() {
      // Always keep it hidden and ensure it doesn't block clicks
      const overlay = document.getElementById("ageGate");
      if (overlay) {
        overlay.style.display = "none";
        overlay.style.pointerEvents = "none";
        overlay.style.zIndex = "-1";
      }
    }

    function initAgeGate() {
      // Ensure age gate doesn't block anything
      const overlay = document.getElementById("ageGate");
      if (overlay) {
        overlay.style.display = "none";
        overlay.style.pointerEvents = "none";
        overlay.style.zIndex = "-1";
      }
    }

    /* ---------- View navigation ---------- */

    function setView(view) {
      activeView = view;
      
      // Save route to URL hash (for page reload persistence)
      if (window.appCore && window.appCore.routeManager) {
        window.appCore.routeManager.saveRoute(view);
      } else {
        // Fallback: use URL hash directly
        if (view && view !== 'home') {
          window.location.hash = view;
        } else {
          window.location.hash = '';
        }
      }
      
      document
        .querySelectorAll("[id^='view-']")
        .forEach((sec) => (sec.style.display = "none"));
      const target = document.getElementById("view-" + view);
      if (target) target.style.display = "block";

      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.view === view);
      });

      // Update mobile menu items
      document.querySelectorAll(".mobile-menu-item").forEach((item) => {
        item.classList.toggle("active", item.dataset.view === view);
      });

      // Close mobile menu when navigating
      const mobileMenu = document.getElementById("mobileMenu");
      if (mobileMenu) {
        mobileMenu.classList.remove("show");
        mobileMenu.style.display = "none";
      }

      renderAll();
      
      // üöÄ MOBILE: Update bottom nav active tab
      if (window.mobileCore && window.mobileCore.bottomNav) {
        window.mobileCore.bottomNav.updateActiveTab(view);
      }
      
      // Start/stop real-time polling based on view (optimized)
      if (window.appCore && window.appCore.pollingManager) {
        const polling = window.appCore.pollingManager;
        
        // Stop all polling first
        polling.stopAll();
        
        // Small delay before starting polling to avoid immediate calls
        setTimeout(() => {
          // Start polling based on current view (only when view is visible)
          if (view === "jobs" && document.getElementById('view-jobs')?.style.display !== 'none') {
            // Poll for jobs every 30 seconds
            polling.startJobsPolling(() => {
              if (document.getElementById('view-jobs')?.style.display !== 'none') {
                renderJobs(false); // Don't reset pagination
              }
            }, 30000);
          } else if (view === "messages" && document.getElementById('view-messages')?.style.display !== 'none') {
            // Poll for messages every 15 seconds
            polling.startMessagesPolling(() => {
              if (document.getElementById('view-messages')?.style.display !== 'none') {
                if (typeof renderMessagesView === 'function') {
                  renderMessagesView();
                }
              }
            }, 15000);
          }
        }, 1000); // Wait 1 second before starting polling
      }
      
      // Check for accepted offers when switching to jobs view
      if (view === "jobs" && typeof checkForAcceptedOffers === 'function') {
        setTimeout(() => {
          checkForAcceptedOffers();
        }, 1500); // Wait for jobs to load first
      }
    }

    /* ---------- Auth visibility ---------- */

    async function renderAuthSectionVisibility() {
  const authSection = document.getElementById("authSection");
  const user = await window.hustlAPI.auth.getCurrentUser();
  authSection.style.display = user ? "none" : "block";
}

    
/* ---------- Auth ---------- */

async function renderAuthPill() {
  const pill = document.getElementById("authPill");
  const modeToggle = document.getElementById("modeToggle");
  const authPillText = document.getElementById("authPillText");
  const openAuthButton = document.getElementById("openAuthButton");
  const mobileMenuAuthText = document.getElementById("mobileMenuAuthText");
  const mobileMenuAuthButton = document.getElementById("mobileMenuAuthButton");
  const user = await window.hustlAPI.auth.getCurrentUser();

  if (!user) {
    if (modeToggle) modeToggle.style.display = "none";
    if (authPillText) authPillText.textContent = "Not signed in";
    if (openAuthButton) openAuthButton.style.display = "inline-block";
    if (mobileMenuAuthText) mobileMenuAuthText.textContent = "Not signed in";
    if (mobileMenuAuthButton) {
      mobileMenuAuthButton.textContent = "Sign in / Create account";
      mobileMenuAuthButton.onclick = () => {
        document.getElementById("openAuthButton")?.click();
        const mobileMenu = document.getElementById("mobileMenu");
        if (mobileMenu) {
          mobileMenu.classList.remove("show");
          mobileMenu.style.display = "none";
        }
      };
    }

    const openBtn = document.getElementById("openAuthButton");
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        document
          .getElementById("authSection")
          .scrollIntoView({ behavior: "smooth" });
      });
    }
  } else {
    // Show mode toggle when logged in
    if (modeToggle) modeToggle.style.display = "flex";
    if (authPillText) {
      const displayName = user.name || user.email;
      authPillText.textContent = `Signed in as ${displayName}`;
    }
    if (openAuthButton) openAuthButton.style.display = "none";
    if (mobileMenuAuthText) {
      const displayName = user.name || user.email;
      mobileMenuAuthText.textContent = `Signed in as ${displayName}`;
    }
    if (mobileMenuAuthButton) {
      mobileMenuAuthButton.textContent = "Log out";
      mobileMenuAuthButton.onclick = async () => {
        await window.hustlAPI.auth.signOut();
        showToast("Logged out.");
        const mobileMenu = document.getElementById("mobileMenu");
        if (mobileMenu) {
          mobileMenu.classList.remove("show");
          mobileMenu.style.display = "none";
        }
        renderAll();
      };
    }
    
    // Update mode toggle buttons and wire up click handlers
    const customerBtn = document.getElementById("modeCustomerBtn");
    const hustlerBtn = document.getElementById("modeHustlerBtn");
    if (customerBtn && hustlerBtn) {
      // Remove old listeners by cloning
      const newCustomerBtn = customerBtn.cloneNode(true);
      const newHustlerBtn = hustlerBtn.cloneNode(true);
      customerBtn.parentNode.replaceChild(newCustomerBtn, customerBtn);
      hustlerBtn.parentNode.replaceChild(newHustlerBtn, hustlerBtn);
      
      // Set active state
      if (userMode === "customer") {
        newCustomerBtn.classList.add("active");
        newHustlerBtn.classList.remove("active");
      } else {
        newCustomerBtn.classList.remove("active");
        newHustlerBtn.classList.add("active");
      }
      
      // Add click handlers - go to home when switching modes
      newCustomerBtn.addEventListener("click", () => {
        userMode = "customer";
        localStorage.setItem("hustl_userMode", userMode);
        setView("home"); // Go to home page when switching mode
        renderAll();
      });
      
      newHustlerBtn.addEventListener("click", () => {
        userMode = "hustler";
        localStorage.setItem("hustl_userMode", userMode);
        setView("home"); // Go to home page when switching mode
        renderAll();
      });
    }

    // Add logout button if not exists
    let logoutBtn = document.getElementById("logoutButton");
    if (!logoutBtn) {
      logoutBtn = document.createElement("button");
      logoutBtn.id = "logoutButton";
      logoutBtn.textContent = "Log out";
      logoutBtn.style.marginLeft = "0.5rem";
      pill.appendChild(logoutBtn);
    }
    
    logoutBtn.addEventListener("click", async () => {
      await window.hustlAPI.auth.signOut();
      showToast("Logged out.");
      renderAll();
    });
  }
}

function initAuthCard() {
  const authTitle = document.getElementById("authCardTitle");
  const authToggle = document.getElementById("authModeToggle");
  const authBodyCreate = document.getElementById("authBodyCreate");
  const authBodyLogin = document.getElementById("authBodyLogin");
  let mode = "create";

  function wireToggle() {
    const span = authToggle.querySelector("span.linkish");
    if (span) {
      span.addEventListener("click", (e) => {
        const m = e.target.dataset.authMode;
        setMode(m);
      });
    }
  }

  function setMode(next) {
    mode = next;
    if (mode === "create") {
      authTitle.textContent = "Create account";
      authBodyCreate.style.display = "";
      authBodyLogin.style.display = "none";
      authToggle.innerHTML =
        'Already have an account? <span class="linkish" data-auth-mode="login">Log in</span>';
    } else {
      authTitle.textContent = "Log in";
      authBodyCreate.style.display = "none";
      authBodyLogin.style.display = "";
      authToggle.innerHTML =
        'Need a new account? <span class="linkish" data-auth-mode="create">Create one</span>';
    }
    wireToggle();
  }

  setMode("create");

  // Show/hide Stripe notice based on role selection
  const createRoleSelect = document.getElementById("createRole");
  const stripeNotice = document.getElementById("stripeNoticeForHustlers");
  if (createRoleSelect && stripeNotice) {
    createRoleSelect.addEventListener("change", () => {
      if (createRoleSelect.value === "hustler") {
        stripeNotice.style.display = "block";
      } else {
        stripeNotice.style.display = "none";
      }
    });
  }

// Wrap in try-catch to prevent errors from freezing the page
try {
  const createAccountBtn = document.getElementById("createAccountButton");
  if (createAccountBtn) {
    createAccountBtn.addEventListener("click", async () => {
      try {
        const name = document.getElementById("createName")?.value.trim();
        const email = document.getElementById("createEmail")?.value.trim();
        const password = document.getElementById("createPassword")?.value.trim();
        const role = document.getElementById("createRole")?.value;
        const agreeTerms = document.getElementById("agreeTerms")?.checked;
        const confirmAge = document.getElementById("confirmAge")?.checked;

        if (!name || !email || !password) {
          showToast("Please fill name, email, and password.");
          return;
        }
        if (password.length < 8) {
          showToast("Password should be at least 8 characters.");
          return;
        }
        if (!agreeTerms) {
          showToast("Please agree to the Terms of Service and Privacy Policy.");
          return;
        }
        if (!confirmAge) {
          showToast("You must be 18 years or older to use Hustl.");
          return;
        }

        // Sign up with new API - NO city/zip required
        // Generate username from email (take part before @, make alphanumeric)
        let username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
        // Ensure it's at least 3 characters and max 20
        if (username.length < 3) {
          username = username + '123';
        }
        if (username.length > 20) {
          username = username.substring(0, 20);
        }
        // Add random suffix to ensure uniqueness
        const randomSuffix = Math.floor(Math.random() * 1000);
        username = username + randomSuffix;

        await window.hustlAPI.auth.signUp(email, password, name, username, role);
        
        showToast("Account created successfully!");
        
        // If hustler, redirect to profile to set up Stripe
        if (role === "hustler") {
          showToast("Now let's set up your Stripe account to receive payments!", 5000);
          setView("profile");
          renderAll();
          // Scroll to Stripe section after a moment
          setTimeout(() => {
            const stripeSection = document.querySelector('[id*="stripe"], [class*="stripe"]');
            if (stripeSection) {
              stripeSection.scrollIntoView({ behavior: "smooth", block: "center" });
            }
          }, 1000);
        } else {
          setView("jobs");
          renderAll();
        }
      } catch (error) {
        console.error("Sign up error:", error);
        // Filter out any city/zip related error messages
        let errorMsg = error.message || "Unknown error";
        const lowerMsg = errorMsg.toLowerCase();
        if (lowerMsg.includes('zip') || lowerMsg.includes('city') || lowerMsg.includes('location')) {
          errorMsg = "Account creation failed. Please try again.";
        }
        showToast("Sign up error: " + errorMsg);
        // Ensure button is never stuck disabled
        const btn = document.getElementById("createAccountButton");
        if (btn) btn.disabled = false;
      }
    });
  }
} catch (error) {
  console.error("Failed to attach createAccountButton listener:", error);
}

  document
    .getElementById("loginButton")
    .addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password =
        document.getElementById("loginPassword").value.trim();
      if (!email || !password)
        return showToast("Enter email and password.");

      try {
        await window.hustlAPI.auth.signIn(email, password);
        showToast("Logged in.");
        setView("jobs");
        renderAll();
      } catch (error) {
        showToast("Login error: " + (error.message || "Unknown error"));
      }
    });
}

    /* ---------- Jobs ---------- */

    function clearJobForm() {
      document.getElementById("jobTitle").value = "";
      document.getElementById("jobCategory").value = "";
      document.getElementById("jobDescription").value = "";
      document.getElementById("pickupArea").value = "";
      document.getElementById("pickupCity").value = "";
      document.getElementById("pickupAddress").value = "";
      document.getElementById("pickupZip").value = "";
      // Zip code visibility is now always on - no checkbox to reset
      document.getElementById("jobOnSiteOnly").checked = false;
      document.getElementById("estimatedDuration").value = "";
      document.getElementById("toolTruck").checked = false;
      document.getElementById("toolLadder").checked = false;
      document.getElementById("toolPowerTools").checked = false;
      document.getElementById("toolHandTools").checked = false;
      document.getElementById("toolDolly").checked = false;
      document.getElementById("toolCleaning").checked = false;
      document.getElementById("toolsOther").value = "";
      document.getElementById("dropoffArea").value = "";
      document.getElementById("dropoffCity").value = "";
      document.getElementById("dropoffAddress").value = "";
      document.getElementById("paymentType").value = "flat";
      document.getElementById("flatAmount").value = "80";
      document.getElementById("hourlyRate").value = "20";
      document.getElementById("maxHours").value = "3";
      document.getElementById("jobNotes").value = "";
      document.getElementById("jobPhoto").value = "";
      document.getElementById("flatAmountField").style.display = "block";
      document.getElementById("hourlyFields").style.display = "none";
      document.getElementById("dropoffFields").style.display = "block";
      document.getElementById("jobDateFilter").value = "today";
      document.getElementById("jobTimeFilter").value = "morning";
      document.getElementById("customDateField").style.display = "none";
      document.getElementById("customTimeFields").style.display = "none";
    }
    function initJobsForm() {
      const jobOnSiteOnly = document.getElementById("jobOnSiteOnly");
      const dropoffFields = document.getElementById("dropoffFields");
      jobOnSiteOnly.addEventListener("change", () => {
        dropoffFields.style.display = jobOnSiteOnly.checked ? "none" : "block";
      });

      const paymentTypeSelect = document.getElementById("paymentType");
      const flatField = document.getElementById("flatAmountField");
      const hourlyFields = document.getElementById("hourlyFields");
      paymentTypeSelect.addEventListener("change", () => {
        if (paymentTypeSelect.value === "flat") {
          flatField.style.display = "block";
          hourlyFields.style.display = "none";
        } else {
          flatField.style.display = "none";
          hourlyFields.style.display = "grid";
        }
      });

      // Date filter handler
      const dateFilter = document.getElementById("jobDateFilter");
      const customDateField = document.getElementById("customDateField");
      dateFilter.addEventListener("change", () => {
        customDateField.style.display = dateFilter.value === "custom" ? "block" : "none";
      });

      // Time filter handler
      const timeFilter = document.getElementById("jobTimeFilter");
      const customTimeFields = document.getElementById("customTimeFields");
      timeFilter.addEventListener("change", () => {
        customTimeFields.style.display = timeFilter.value === "custom" ? "flex" : "none";
      });

      document
        .getElementById("postJobButton")
        .addEventListener("click", async () => {
          // Get JWT token - try multiple possible keys
          let token = localStorage.getItem("hustl_token") || 
                      localStorage.getItem("token") || 
                      localStorage.getItem("auth_token");
          
          // Debug: log all localStorage keys to help find the token
          if (!token) {
            console.log("Available localStorage keys:", Object.keys(localStorage));
            console.log("hustl_token:", localStorage.getItem("hustl_token"));
            console.log("token:", localStorage.getItem("token"));
            console.log("auth_token:", localStorage.getItem("auth_token"));
            return showToast("You must be logged in to post jobs. Please log in first. (No token found in localStorage)");
          }
          
          console.log("Found token, length:", token.length);
          
          // Get current user from token (optional - backend will validate token)
          let user = null;
          try {
            const response = await fetch("/users/me", {
              headers: { "Authorization": `Bearer ${token}` }
            });
            if (response.ok) {
              user = await response.json();
            } else {
              // If auth fails, token might be invalid - but let backend handle it
              console.warn("Failed to get user, will try posting anyway");
            }
          } catch (error) {
            // Don't block - backend will validate token
            console.warn("Error getting user:", error);
          }

          const title = document.getElementById("jobTitle").value.trim();
          const category = document.getElementById("jobCategory").value;
          const desc = document.getElementById("jobDescription").value.trim();
          const pickupArea = document
            .getElementById("pickupArea")
            .value.trim();
          const pickupCity = document
            .getElementById("pickupCity")
            .value.trim();
          const pickupAddress = document
            .getElementById("pickupAddress")
            .value.trim();
          const pickupZip = document
            .getElementById("pickupZip")
            .value.trim();
          // Zip code must always be visible - required for location matching
          const hideZipCode = false;
          const onSiteOnly =
            document.getElementById("jobOnSiteOnly").checked;
          const dropoffArea = document
            .getElementById("dropoffArea")
            .value.trim();
          const dropoffCity = document
            .getElementById("dropoffCity")
            .value.trim();
          const dropoffAddress = document
            .getElementById("dropoffAddress")
            .value.trim();
          const paymentType =
            document.getElementById("paymentType").value;
          const flatAmount = Number(
            document.getElementById("flatAmount").value
          );
          const hourlyRate = Number(
            document.getElementById("hourlyRate").value
          );
          const maxHours = Number(
            document.getElementById("maxHours").value
          );
          const teamSize = Number(
            document.getElementById("teamSize").value || 1
          );
          const notes = document
            .getElementById("jobNotes")
            .value.trim();
          const estimatedDuration = document
            .getElementById("estimatedDuration")
            .value;
          
          // Collect tools needed
          const toolsNeeded = [];
          if (document.getElementById("toolTruck").checked) toolsNeeded.push("truck");
          if (document.getElementById("toolLadder").checked) toolsNeeded.push("ladder");
          if (document.getElementById("toolPowerTools").checked) toolsNeeded.push("power-tools");
          if (document.getElementById("toolHandTools").checked) toolsNeeded.push("hand-tools");
          if (document.getElementById("toolDolly").checked) toolsNeeded.push("dolly");
          if (document.getElementById("toolCleaning").checked) toolsNeeded.push("cleaning-supplies");
          const toolsOther = document.getElementById("toolsOther")?.value.trim();
          if (toolsOther) toolsNeeded.push(toolsOther);

          if (!title || !category || !desc)
            return showToast(
              "Please fill title, category, and description."
            );
          
          if (!estimatedDuration)
            return showToast(
              "Please select an estimated duration to help hustlers provide accurate quotes."
            );
          
          // Validate tools/equipment is required
          if (toolsNeeded.length === 0)
            return showToast(
              "Please select at least one tool or equipment needed. This helps hustlers prepare properly."
            );

          // Validate payment fields
          if (paymentType === "flat") {
            if (!flatAmount || flatAmount <= 0)
              return showToast("Flat amount must be > 0.");
          } else {
            if (
              !hourlyRate ||
              hourlyRate <= 0 ||
              !maxHours ||
              maxHours <= 0
            )
              return showToast(
                "Hourly rate and max hours must be valid."
              );
          }
          
          // Validate team size
          if (teamSize < 1 || teamSize > 10) {
            return showToast("Team size must be between 1 and 10.");
          }

          // Validate Tennessee location - prioritize pickupZip
          if (!pickupZip) {
            return showToast("Please enter a pickup zip code (required for Tennessee validation).");
          }
          
          const zipNum = parseInt(pickupZip, 10);
          if (isNaN(zipNum) || zipNum < 37000 || zipNum > 38999) {
            return showToast("Please enter a valid Tennessee zip code (37000-38999).");
          }

          try {
            // Build address string for geocoding - include zip code for accuracy
            const addressParts = [];
            if (pickupAddress) addressParts.push(pickupAddress);
            if (pickupArea) addressParts.push(pickupArea);
            if (pickupCity) addressParts.push(pickupCity);
            if (pickupZip) addressParts.push(pickupZip);
            const address = addressParts.length > 0 ? addressParts.join(", ") : `${pickupCity || pickupArea || "Tennessee"}, ${pickupZip || ""}`;
            
            if (!address || address.trim() === "") {
              return showToast("Please provide location information (city and zip code).");
            }
            
            // Calculate amount - for hourly, multiply by teamSize (each person gets hourly rate)
            // For hourly jobs: hourlyRate is per person, so total = hourlyRate * maxHours * teamSize
            const calculatedAmount = paymentType === "flat" 
              ? Number(flatAmount) 
              : Number(hourlyRate) * Number(maxHours) * Number(teamSize || 1);
            
            if (isNaN(calculatedAmount) || calculatedAmount <= 0) {
              return showToast("Invalid payment amount. Please check your payment details.");
            }
            
            // Calculate date from filter
            const dateFilter = document.getElementById("jobDateFilter").value;
            const customDate = document.getElementById("jobDate").value;
            let jobDate = new Date();
            
            if (dateFilter === "today") {
              jobDate = new Date();
            } else if (dateFilter === "tomorrow") {
              jobDate = new Date();
              jobDate.setDate(jobDate.getDate() + 1);
            } else if (dateFilter === "custom" && customDate) {
              jobDate = new Date(customDate);
            }
            
            // Calculate time from filter
            const timeFilter = document.getElementById("jobTimeFilter").value;
            const customStartTime = document.getElementById("jobStartTime").value;
            const customEndTime = document.getElementById("jobEndTime").value;
            let startTime = new Date(jobDate);
            let endTime = new Date(jobDate);
            
            if (timeFilter === "custom" && customStartTime && customEndTime) {
              const [startHour, startMin] = customStartTime.split(':').map(Number);
              const [endHour, endMin] = customEndTime.split(':').map(Number);
              startTime.setHours(startHour, startMin, 0, 0);
              endTime.setHours(endHour, endMin, 0, 0);
            } else if (timeFilter === "morning") {
              startTime.setHours(6, 0, 0, 0);
              endTime.setHours(12, 0, 0, 0);
            } else if (timeFilter === "afternoon") {
              startTime.setHours(12, 0, 0, 0);
              endTime.setHours(17, 0, 0, 0);
            } else if (timeFilter === "evening") {
              startTime.setHours(17, 0, 0, 0);
              endTime.setHours(21, 0, 0, 0);
            } else if (timeFilter === "night") {
              startTime.setHours(21, 0, 0, 0);
              endTime.setDate(endTime.getDate() + 1);
              endTime.setHours(6, 0, 0, 0);
            }
            
            const jobData = {
              title,
              category,
              description: desc,
              address: cleanedAddress || address.trim(),
              date: jobDate.toISOString(),
              startTime: startTime.toISOString(),
              endTime: endTime.toISOString(),
              payType: paymentType,
              amount: calculatedAmount,
              teamSize: teamSize || 1,
              pickupArea: pickupArea || null,
              pickupCity: pickupCity || null,
              pickupAddress: pickupAddress || null,
              dropoffArea: onSiteOnly ? null : (dropoffArea || null),
              dropoffCity: onSiteOnly ? null : (dropoffCity || null),
              dropoffAddress: onSiteOnly ? null : (dropoffAddress || null),
              requirements: {
                onSiteOnly,
                notes: notes || null,
                pickupZip: pickupZip || null,
                hideZipCode: false, // Always false - zip code must be visible for location matching
                estimatedDuration: estimatedDuration || null,
                toolsNeeded: toolsNeeded.length > 0 ? toolsNeeded : null,
              },
            };
            
            // Only include hourly fields if payment type is hourly
            if (paymentType === "hourly") {
              jobData.hourlyRate = Number(hourlyRate);
              jobData.estHours = Number(maxHours);
            }

            // Get JWT token
            const token = localStorage.getItem("hustl_token");
            if (!token) {
              return showToast("You must be logged in to post jobs. Please log in first.");
            }
            
            // Call API directly
            const response = await fetch("/jobs", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify(jobData)
            });
            
            const data = await response.json();
            if (!response.ok) {
              return showToast(data.error || "Post error: " + response.statusText);
            }
            
            // Clear draft after successful post
            localStorage.removeItem('jobDraft');
            showToast("‚úì Job posted successfully!");
            setView("jobs");
            clearJobForm();
            renderJobs();
          } catch (error) {
            console.error("Job posting error:", error);
            showToast("Post error: " + (error.message || "Unknown error"));
          }
        });
    }

    
async function renderJobs(reset = false) {
  // Use optimized loading state
  loadingManager?.setLoading('jobs', true);
  try {
  const jobsList = document.getElementById("jobsList");
  const jobsCardTitle = document.getElementById("jobsCardTitle");
  const jobsFilterSummary = document.getElementById("jobsFilterSummary");
  const loadMoreContainer = document.getElementById("loadMoreJobsContainer");

  // Reset pagination if needed
  if (reset) {
    currentJobsPage = 1;
    allLoadedJobs = [];
    if (jobsList) jobsList.innerHTML = "";
    if (loadMoreContainer) loadMoreContainer.style.display = "none";
  }

  // 1) Get logged-in user from token
  let user = null;
  try {
    const token = localStorage.getItem("hustl_token");
    if (token) {
      const response = await fetch("/users/me", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (response.ok) {
        user = await response.json();
      }
    }
  } catch (error) {
    console.warn("Error getting user:", error);
  }

  // 2) Figure out their role
  let role = null;
  if (user && user.roles && user.roles.length > 0) {
    role = user.roles[0].toLowerCase();
  }

  // 3) Load jobs from API
  let jobs = [];
  try {
    // Handle "in-progress" filter specially
    let statusFilter = undefined;
    if (activeJobsStatusFilter === "in-progress") {
      // Don't filter by status in API - we'll filter client-side for ASSIGNED/PAID
      statusFilter = undefined;
    } else if (activeJobsStatusFilter === "open") {
      statusFilter = "OPEN";
    } else if (activeJobsStatusFilter === "active") {
      statusFilter = "ASSIGNED";
    } else if (activeJobsStatusFilter === "done" || activeJobsStatusFilter === "completed") {
      statusFilter = "COMPLETED_BY_HUSTLER";
    } else if (activeJobsStatusFilter !== "all") {
      // Try to map other statuses
      const statusUpper = activeJobsStatusFilter.toUpperCase();
      if (statusUpper === "COMPLETED" || statusUpper === "PAID" || statusUpper === "DONE") {
        statusFilter = "COMPLETED_BY_HUSTLER";
      } else if (statusUpper === "IN_PROGRESS" || statusUpper === "IN-PROGRESS") {
        statusFilter = "ASSIGNED";
      } else {
        statusFilter = statusUpper;
      }
    }
    // Determine sortBy from active filter
    // Ensure activeJobFilter is defined (default to 'newest' if not set)
    if (typeof activeJobFilter === 'undefined') {
      activeJobFilter = 'newest';
    }
    
    let sortByValue = 'newest'; // Default: newest first (like major apps)
    if (activeJobFilter === 'near-me') {
      sortByValue = 'distance'; // Sort by distance
    } else if (activeJobFilter === 'highest-pay') {
      sortByValue = 'pay'; // Sort by highest pay
    } else if (activeJobFilter === 'newest') {
      sortByValue = 'newest'; // Sort by newest
    }
    
    const listParams = {
      page: currentJobsPage,
      limit: 20,
      sortBy: sortByValue, // Use filter-based sort
    };
    if (statusFilter) {
      listParams.status = statusFilter;
    }
    
    // Add date filter
    const dateFilter = document.getElementById("jobsDateFilter")?.value;
    if (dateFilter) {
      const now = new Date();
      let dateFrom, dateTo;
      
      if (dateFilter === "today") {
        dateFrom = new Date(now);
        dateFrom.setHours(0, 0, 0, 0);
        dateTo = new Date(now);
        dateTo.setHours(23, 59, 59, 999);
      } else if (dateFilter === "tomorrow") {
        dateFrom = new Date(now);
        dateFrom.setDate(dateFrom.getDate() + 1);
        dateFrom.setHours(0, 0, 0, 0);
        dateTo = new Date(dateFrom);
        dateTo.setHours(23, 59, 59, 999);
      }
      
      if (dateFrom && dateTo) {
        listParams.dateFrom = dateFrom.toISOString();
        listParams.dateTo = dateTo.toISOString();
      }
    }
    
    // Location-based filtering: Auto-filter by user location with default radius (10 miles)
    // Production-ready with validation and fallbacks
    // Check slider first (preferred for mobile), then select (backward compatibility)
    const radiusSlider = document.getElementById("jobsRadiusSlider");
    const radiusSelect = document.getElementById("jobsRadiusFilter");
    const radiusFilter = radiusSlider?.value || radiusSelect?.value || '10'; // Default 10 miles
    const radiusNum = parseInt(radiusFilter, 10) || 10;
    const userLocation = JSON.parse(localStorage.getItem('userLocation') || 'null');
    const locationFilterInput = document.getElementById("jobsLocationFilter")?.value.trim();
    const savedZipFilter = localStorage.getItem('savedZipFilter');
    
    // Priority order: location filter input (ZIP or city) > saved zip > user profile zip > geolocation > default
    // Check if it's a 5-digit ZIP code
    if (locationFilterInput && locationFilterInput.length === 5 && /^\d{5}$/.test(locationFilterInput)) {
      listParams.zip = locationFilterInput;
      listParams.radius = radiusNum;
    } else if (savedZipFilter && savedZipFilter.length === 5 && /^\d{5}$/.test(savedZipFilter)) {
      listParams.zip = savedZipFilter;
      listParams.radius = radiusNum;
    } else if (user && user.zip && user.zip.length === 5 && /^\d{5}$/.test(user.zip)) {
      // Use user's profile zip code (validated)
      listParams.zip = user.zip;
      listParams.radius = radiusNum;
    } else if (userLocation && userLocation.lat && userLocation.lng) {
      // Validate geolocation coordinates
      const lat = parseFloat(userLocation.lat);
      const lng = parseFloat(userLocation.lng);
      
      if (!isNaN(lat) && !isNaN(lng) && 
          lat >= -90 && lat <= 90 && 
          lng >= -180 && lng <= 180) {
        // Check if location is recent (within 1 hour) for accuracy
        const locationAge = userLocation.timestamp ? Date.now() - userLocation.timestamp : Infinity;
        if (locationAge < 60 * 60 * 1000) { // 1 hour
          listParams.lat = lat;
          listParams.lng = lng;
          listParams.radius = radiusNum;
        } else {
          // Location too old, fall back to profile zip or default
          if (user && user.zip && user.zip.length === 5) {
            listParams.zip = user.zip;
            listParams.radius = radiusNum;
          } else {
            listParams.radius = radiusNum;
          }
        }
      } else {
        // Invalid coordinates, use profile zip or default
        if (user && user.zip && user.zip.length === 5) {
          listParams.zip = user.zip;
          listParams.radius = radiusNum;
        } else {
          listParams.radius = radiusNum;
        }
      }
    } else {
      // Default: use radius, backend will use user's profile location if available
      listParams.radius = radiusNum;
    }
    
    // Add search term if provided
    const searchInput = document.getElementById("jobsSearchInput");
    if (searchInput && searchInput.value.trim()) {
      listParams.search = searchInput.value.trim();
    }
    
    // Fetch jobs from API (optimized with caching)
    perfMonitor.start('fetchJobs');
    let jobsData;
    try {
      const queryString = new URLSearchParams(listParams).toString();
      const jobsUrl = `/jobs${queryString ? `?${queryString}` : ''}`;
      
      // Use optimized API client if available, otherwise fallback to fetch
      if (window.optimizedApi) {
        jobsData = await window.optimizedApi.get(jobsUrl, { useCache: true });
      } else {
        const token = localStorage.getItem("hustl_token");
        const jobsResponse = await fetch(jobsUrl, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        
        if (!jobsResponse.ok) {
          throw new Error(`Failed to load jobs: ${jobsResponse.statusText}`);
        }
        
        jobsData = await jobsResponse.json();
      }
      perfMonitor.end('fetchJobs');
    } catch (error) {
      perfMonitor.end('fetchJobs');
      const message = errorHandler.handle(error, 'Loading jobs');
      throw new Error(message);
    }
    // Handle paginated response format: { jobs: [], pagination: {} }
    let newJobs = Array.isArray(jobsData) ? jobsData : (jobsData.jobs || []);
    
    // Ensure newJobs is always an array
    if (!Array.isArray(newJobs)) {
      console.warn('[renderJobs] newJobs is not an array, resetting to empty array');
      newJobs = [];
    }
    
    // Store pagination info
    jobsPagination = jobsData.pagination || { hasMore: false };
    
    // Append new jobs to existing list (or replace if reset)
    if (reset) {
      allLoadedJobs = newJobs;
    } else {
      allLoadedJobs = [...allLoadedJobs, ...newJobs];
    }
    
    // Use allLoadedJobs for filtering
    jobs = allLoadedJobs;
    
    // Apply filter-based filtering (hourly/flat, etc.)
    // Ensure activeJobFilter is defined (safety check)
    if (typeof activeJobFilter === 'undefined') {
      activeJobFilter = 'newest';
    }
    
    if (activeJobFilter === 'hourly') {
      jobs = jobs.filter(j => j.payType === 'hourly');
    } else if (activeJobFilter === 'flat') {
      jobs = jobs.filter(j => j.payType === 'flat');
    }
    // 'newest', 'near-me', 'highest-pay' are handled by sortBy in API
    
  // Filter out dismissed jobs (for hustlers)
  if (userMode === "hustler") {
    jobs = jobs.filter(j => !dismissedJobIds.has(j.id));
  }
  
  // üöÄ MOBILE OPTIMIZATION: Limit to 10 jobs per page on mobile, group by distance
  const isMobile = window.innerWidth <= 768;
  if (isMobile && window.mobileCore) {
    // Group by distance on mobile
    const grouped = window.mobileCore.jobFeed.groupByDistance(jobs);
    
    // Limit jobs per page (10 on mobile)
    const limitedJobs = window.mobileCore.jobFeed.limitJobs(jobs, currentJobsPage);
    jobs = limitedJobs;
    
    // Store grouped jobs for display
    jobs.groupedByDistance = grouped;
    jobs.hasMore = window.mobileCore.jobFeed.hasMore(allLoadedJobs);
  }
    
    // Filter out COMPLETED jobs that are older than 48 hours OR allow immediate deletion
    // COMPLETED jobs should disappear from the main view
    const now = Date.now();
    const fortyEightHours = 48 * 60 * 60 * 1000; // 48 hours in milliseconds
    jobs = jobs.filter(job => {
      const status = (job.status || "").toUpperCase();
      if (status === "COMPLETED") {
        // Check if job was completed more than 48 hours ago
        const updatedAt = job.updatedAt ? new Date(job.updatedAt).getTime() : 0;
        const completedAt = job.requirements?.completedAtTimestamp || updatedAt;
        const hoursSinceCompleted = now - completedAt;
        
        // Remove if older than 48 hours OR if it's been completed (allow immediate removal)
        // For now, remove all COMPLETED jobs from main listing immediately
        return false; // Don't show COMPLETED jobs in main listing
      }
      return true; // Keep all other jobs
    });
    
    // Note: Distance filtering is now handled on the backend
    // The backend already filters by radius and calculates distances
    // We don't need client-side distance filtering anymore
    
    // Filter by time if needed (client-side for now)
    const timeFilter = document.getElementById("jobsTimeFilter")?.value;
    if (timeFilter && jobs.length > 0) {
      const timeRanges = {
        morning: [6, 12],
        afternoon: [12, 17],
        evening: [17, 21],
        night: [21, 6],
      };
      
      if (timeRanges[timeFilter]) {
        const [startHour, endHour] = timeRanges[timeFilter];
        jobs = jobs.filter(job => {
          if (!job.startTime) return false;
          const jobStart = new Date(job.startTime);
          const jobHour = jobStart.getHours();
          
          if (startHour < endHour) {
            return jobHour >= startHour && jobHour < endHour;
          } else {
            // Night time spans midnight
            return jobHour >= startHour || jobHour < endHour;
          }
        });
      }
    }
  } catch (error) {
    perfMonitor.end('fetchJobs');
    const message = errorHandler?.handle(error, 'Loading jobs') || error.message || 'Unknown error';
    console.error("Error loading jobs", error);
    jobsList.innerHTML = `<div class='muted'>‚ùå ${message}</div>`;
    jobsCardTitle.textContent = "Jobs";
    jobsFilterSummary.textContent = "Error loading jobs";
    showToast(message);
    return;
  }
  
  // Debug: Log jobs received
  console.log(`[renderJobs] Loaded ${jobs.length} jobs from API`);
  if (jobs.length === 0) {
    console.log("[renderJobs] No jobs returned - check backend filters");
  }

  // 4) Filter by status (already done by API, but double-check client-side)
  // Create "My Active Gigs" section - prominently show active jobs
  const activeJobs = jobs.filter((j) => {
    const status = (j.status || "").toUpperCase();
    const requirements = j.requirements || {};
    const isInProgress = requirements.startCodeUsed === true || status === "PAID";
    return status === "ASSIGNED" || isInProgress;
  });
  
  if (activeJobsStatusFilter !== "all") {
    if (activeJobsStatusFilter === "in-progress" || activeJobsStatusFilter === "active") {
      // "Active Jobs" = jobs that are ASSIGNED or PAID (In Progress)
      // This is the main view - only show work currently in progress
      jobs = activeJobs;
    } else {
      const filterStatus = activeJobsStatusFilter.toUpperCase();
      jobs = jobs.filter((j) => (j.status || "").toUpperCase() === filterStatus);
    }
  }
  
  // Show "My Active Gigs" dashboard prominently if user has active jobs
  if (activeJobs.length > 0 && user) {
    const activeGigsSection = document.createElement("div");
    activeGigsSection.id = "activeGigsDashboard";
    activeGigsSection.style.marginBottom = "1.5rem";
    activeGigsSection.style.padding = "1rem";
    activeGigsSection.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
    activeGigsSection.style.borderRadius = "12px";
    activeGigsSection.style.color = "#fff";
    activeGigsSection.style.boxShadow = "0 4px 6px rgba(0,0,0,0.1)";
    
    activeGigsSection.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700;">üéØ My Active Gigs</h3>
        <span style="font-size: 0.9rem; opacity: 0.9;">${activeJobs.length} ${activeJobs.length === 1 ? 'job' : 'jobs'}</span>
      </div>
      <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.75rem;">
        Jobs currently assigned or in progress
      </div>
      <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        ${activeJobs.slice(0, 3).map(job => {
          const status = (job.status || "").toUpperCase();
          const requirements = job.requirements || {};
          const isInProgress = requirements.startCodeUsed === true || status === "PAID";
          const statusText = isInProgress ? "In Progress" : "Assigned";
          return `
            <div style="background: rgba(255,255,255,0.2); padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; flex: 1; min-width: 150px;" 
                 onclick="openJobDetails('${job.id}')">
              <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 0.25rem;">${job.title || 'Untitled Job'}</div>
              <div style="font-size: 0.75rem; opacity: 0.9;">${statusText}</div>
            </div>
          `;
        }).join('')}
      </div>
      ${activeJobs.length > 3 ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.9; text-align: center;">
        +${activeJobs.length - 3} more active ${activeJobs.length - 3 === 1 ? 'job' : 'jobs'}
      </div>` : ''}
    `;
    
    // Insert at the top of jobs list
    if (jobsList && jobsList.firstChild) {
      jobsList.insertBefore(activeGigsSection, jobsList.firstChild);
    } else if (jobsList) {
      jobsList.appendChild(activeGigsSection);
    }
  }

  // 5) Show/hide tabs based on mode and update title
  const jobsTabs = document.getElementById("jobsTabs");
  const myJobsTab = jobsTabs?.querySelector('[data-tab="my-jobs"]');
  const availableTab = jobsTabs?.querySelector('[data-tab="available"]');
  const myHustlesTab = jobsTabs?.querySelector('[data-tab="my-hustles"]');
  
  if (jobsTabs && user) {
    jobsTabs.style.display = "flex";
    
    if (userMode === "customer") {
      if (myJobsTab) {
        myJobsTab.style.display = "inline-block";
        myJobsTab.textContent = "My Jobs";
      }
      if (availableTab) {
        availableTab.style.display = "inline-block";
        availableTab.textContent = "Browse Jobs";
      }
      if (myHustlesTab) myHustlesTab.style.display = "none";
      jobsCardTitle.textContent = "Jobs";
    } else {
      // Hustler mode
      if (myJobsTab) myJobsTab.style.display = "none";
      if (availableTab) {
        availableTab.style.display = "inline-block";
        availableTab.textContent = "Find Jobs";
      }
      if (myHustlesTab) {
        myHustlesTab.style.display = "inline-block";
        myHustlesTab.textContent = "My Hustles";
        
        // Update badge asynchronously (don't await - let it update in background)
        updateMyHustlesBadge(user.id);
        
        // Check if hustler has any assigned jobs - if so, make this the default active tab
        // This will be set after jobs are loaded
      }
      jobsCardTitle.textContent = "Jobs";
      
      // Set default tab for hustlers - prefer "My Hustles" if they have any
      // We'll check this after jobs load
    }
  } else if (jobsTabs) {
    jobsTabs.style.display = "none";
  }
  
  // 6) Create simplified status filters based on mode and active tab
  const statusFilterContainer = document.getElementById("jobsStatusFilter");
  if (statusFilterContainer && user) {
    const activeTab = jobsTabs?.querySelector('.job-tab.active')?.dataset.tab;
    
    // Clear existing filters
    statusFilterContainer.innerHTML = '';
    
    // Simplified filters: Only show relevant options
    // Determine which filters are available for this tab
    let availableFilters = [];
    if (userMode === "hustler") {
      // For hustlers: Just "All" and "Open" when browsing, or "All" and "Active" for their hustles
      if (activeTab === "available" || !activeTab) {
        availableFilters = ["all", "open"];
      } else if (activeTab === "my-hustles") {
        availableFilters = ["all", "active"];
      }
    } else {
      // For customers: "All", "Open", "Active", "Done" for their jobs
      if (activeTab === "my-jobs" || !activeTab) {
        availableFilters = ["all", "open", "active", "done"];
      } else if (activeTab === "available") {
        availableFilters = ["all", "open"];
      }
    }
    
    // If current filter is not available for this tab, reset to "all"
    if (!availableFilters.includes(activeJobsStatusFilter)) {
      activeJobsStatusFilter = "all";
    }
    
    // Build filter HTML with correct active state
    const filterLabels = {
      "all": "All",
      "open": "Open",
      "active": "Active",
      "done": "Done"
    };
    
    statusFilterContainer.innerHTML = availableFilters.map(filter => {
      const isActive = filter === activeJobsStatusFilter;
      return `<span data-status="${filter}" ${isActive ? 'class="active"' : ''}>${filterLabels[filter]}</span>`;
    }).join('');
    
    // Show the filter container if we have filters
    if (statusFilterContainer.innerHTML.trim()) {
      statusFilterContainer.style.display = "flex";
      
      // Add click handlers to status filter buttons
      statusFilterContainer.querySelectorAll('[data-status]').forEach(btn => {
        btn.addEventListener('click', () => {
          // Remove active class from all
          statusFilterContainer.querySelectorAll('[data-status]').forEach(b => b.classList.remove('active'));
          // Add active to clicked
          btn.classList.add('active');
          activeJobsStatusFilter = btn.dataset.status;
          renderJobs(true); // Reset pagination when status filter changes
        });
      });
    } else {
      statusFilterContainer.style.display = "none";
    }
  } else if (statusFilterContainer) {
    statusFilterContainer.style.display = "none";
  }
  
  // Wire up tab click handlers using event delegation on parent
  // This works even when tabs are modified
  if (jobsTabs) {
    // Remove old handler if exists
    if (jobsTabs._tabClickHandler) {
      jobsTabs.removeEventListener("click", jobsTabs._tabClickHandler);
    }
    
    // Create new handler
    jobsTabs._tabClickHandler = function(e) {
      const clickedTab = e.target.closest(".job-tab");
      if (!clickedTab || !clickedTab.parentNode) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      // Remove active class from all tabs
      const allTabs = jobsTabs.querySelectorAll(".job-tab");
      allTabs.forEach(t => t.classList.remove("active"));
      
      // Add active class to clicked tab
      clickedTab.classList.add("active");
      
      // Don't reset status filter when switching tabs - keep the current selection if it's valid for the new tab
      // The renderJobs function will handle resetting if needed
      
      // Re-render jobs with new filter (this will also update status filters)
      renderJobs(true); // Reset pagination when tab changes
    };
    
    // Attach handler
    jobsTabs.addEventListener("click", jobsTabs._tabClickHandler, true);
  }
  
  // Filter jobs based on active tab
  let activeTab = "available";
  if (jobsTabs) {
    const activeTabEl = jobsTabs.querySelector(".job-tab.active");
    if (activeTabEl) activeTab = activeTabEl.dataset.tab;
  }
  
  if (user && activeTab === "my-jobs" && userMode === "customer") {
    // Show only jobs posted by this customer
    jobs = jobs.filter(j => j.customerId === user.id);
  } else if (user && activeTab === "my-hustles" && userMode === "hustler") {
    // Show only jobs where this user is the hustler (all statuses - in progress, completed, etc.)
    jobs = jobs.filter(j => j.hustlerId === user.id);
    // Sort by status: ASSIGNED/PAID first (in progress), then others
    jobs.sort((a, b) => {
      const aStatus = (a.status || "").toUpperCase();
      const bStatus = (b.status || "").toUpperCase();
      const inProgress = ["ASSIGNED", "PAID", "AWAITING_CUSTOMER_CONFIRM"];
      const aInProgress = inProgress.includes(aStatus);
      const bInProgress = inProgress.includes(bStatus);
      if (aInProgress && !bInProgress) return -1;
      if (!aInProgress && bInProgress) return 1;
      return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
    });
  } else if (user && !activeTab && userMode === "hustler") {
    // If no active tab and hustler has assigned jobs, default to "my-hustles"
    const assignedJobs = jobs.filter(j => j.hustlerId === user.id);
    if (assignedJobs.length > 0 && myHustlesTab) {
      // Switch to "my-hustles" tab
      const allTabs = jobsTabs?.querySelectorAll(".job-tab");
      allTabs?.forEach(t => t.classList.remove("active"));
      myHustlesTab.classList.add("active");
      // Re-filter jobs for this tab
      jobs = assignedJobs;
      jobs.sort((a, b) => {
        const aStatus = (a.status || "").toUpperCase();
        const bStatus = (b.status || "").toUpperCase();
        const inProgress = ["ASSIGNED", "PAID", "AWAITING_CUSTOMER_CONFIRM"];
        const aInProgress = inProgress.includes(aStatus);
        const bInProgress = inProgress.includes(bStatus);
        if (aInProgress && !bInProgress) return -1;
        if (!aInProgress && bInProgress) return 1;
        return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
      });
    }
  } else if (activeTab === "available") {
    // Show only open jobs
    jobs = jobs.filter(j => (j.status || "").toUpperCase() === "OPEN");
  }
  
  // Final filter: Remove COMPLETED jobs from all views (they're done and reviewed)
  // This ensures COMPLETED jobs don't show up anywhere in the main listing
  jobs = jobs.filter(j => {
    const status = (j.status || "").toUpperCase();
    return status !== "COMPLETED";
  });

  // 6) Summary text
  jobsFilterSummary.textContent =
    jobs.length === 0 ? "No jobs found." : `${jobs.length} job(s) shown`;

  // 7) Clear list
  jobsList.innerHTML = "";
  if (jobs.length === 0) {
    // Show helpful message based on filters
    const noJobsMsg = document.createElement("div");
    noJobsMsg.className = "muted";
    noJobsMsg.style.padding = "2rem";
    noJobsMsg.style.textAlign = "center";
    
    const locationFilter = document.getElementById("jobsLocationFilter")?.value.trim();
    const distanceFilter = document.getElementById("jobsDistanceFilter")?.value;
    
    if (locationFilter || distanceFilter) {
      noJobsMsg.innerHTML = `
        <div style="margin-bottom: 0.5rem;">No jobs found with current location filters.</div>
        <div style="font-size: 0.9rem;">Try removing location filters or checking a different area.</div>
      `;
    } else if (activeJobsStatusFilter && activeJobsStatusFilter !== "all" && activeJobsStatusFilter !== "open") {
      noJobsMsg.innerHTML = `
        <div style="margin-bottom: 0.5rem;">No jobs found with status: ${activeJobsStatusFilter}.</div>
        <div style="font-size: 0.9rem;">Try selecting "All" or "Open" to see available jobs.</div>
      `;
    } else {
      noJobsMsg.innerHTML = `
        <div style="margin-bottom: 0.5rem;">No jobs available yet.</div>
        <div style="font-size: 0.9rem;">Be the first to post a job!</div>
      `;
    }
    jobsList.appendChild(noJobsMsg);
    return;
  }

  // 8) Render each job card
  // üöÄ MOBILE: Use simplified mobile cards on mobile screens
  const isMobile = window.innerWidth <= 768;
  
  jobs.forEach((job) => {
    // Use mobile-optimized card on mobile
    if (isMobile && window.mobileCore && typeof createMobileJobCard === 'function') {
      const mobileCard = createMobileJobCard(job, user, userMode);
      jobsList.appendChild(mobileCard);
      return; // Skip desktop card creation on mobile
    }
    
    // Desktop card (existing code)
    const card = document.createElement("div");
    card.className = "job-card";
    card.dataset.jobId = job.id;

    // top row
    const titleRow = document.createElement("div");
    titleRow.className = "job-card-top";

    const titleEl = document.createElement("div");
    titleEl.className = "job-title";
    titleEl.textContent = job.title;
    titleRow.appendChild(titleEl);

    const pay = document.createElement("div");
    pay.className = "job-title";

    if (job.payType === "flat") {
      const total = Number(job.amount) || 0;
      pay.textContent = `$${total.toFixed(2)}`;
    } else {
      const hr = Number(job.hourlyRate) || 0;
      const maxH = job.estHours || 0;
      const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
      if (teamSize > 1) {
        const totalPerHour = hr * teamSize;
        pay.textContent = `$${hr.toFixed(2)}/hr/person (${teamSize} = $${totalPerHour.toFixed(2)}/hr) ¬∑ max ${maxH}h`;
      } else {
        pay.textContent = `$${hr.toFixed(2)}/hr ¬∑ max ${maxH}h`;
      }
    }
    titleRow.appendChild(pay);
    card.appendChild(titleRow);

    // category + time + distance
    const meta = document.createElement("div");
    meta.className = "job-meta";

      const cat =
        job.category === "moving"
          ? "üöö moving"
          : job.category === "yard"
          ? "üåø yard"
          : job.category === "cleaning"
          ? "üßπ cleaning"
          : job.category === "furniture"
          ? "üõ† furniture"
          : job.category === "handyman"
          ? "üîß handyman"
          : job.category === "painting"
          ? "üé® painting"
          : job.category === "landscaping"
          ? "üå≥ landscaping"
          : job.category === "petcare"
          ? "üêï pet care"
          : job.category === "event"
          ? "üéâ event help"
          : job.category === "tech"
          ? "üíª tech support"
          : "‚≠ê other";

    const createdMs = job.createdAt
      ? new Date(job.createdAt).getTime()
      : Date.now();

    // Add poster name
    const posterName = job.customer?.name || job.customer?.username || "User";
    meta.innerHTML = `${cat} ‚Ä¢ posted by <span class="linkish" style="cursor: pointer; color: #2563eb;" data-poster-id="${job.customerId}">${posterName}</span> ‚Ä¢ ${timeAgo(createdMs)}`;
    
    // Add click handler for poster name
    const posterLink = meta.querySelector('[data-poster-id]');
    if (posterLink) {
      posterLink.addEventListener('click', (e) => {
        e.stopPropagation();
        openUserProfile(job.customerId);
      });
    }
    
    card.appendChild(meta);

    // Date and time line
    const dateTimeLine = document.createElement("div");
    dateTimeLine.className = "job-meta";
    dateTimeLine.style.fontWeight = "500";
    
    if (job.date && job.startTime && job.endTime) {
      const jobDate = new Date(job.date);
      const startTime = new Date(job.startTime);
      const endTime = new Date(job.endTime);
      const now = new Date();
      
      // Check if job date has passed and job is still OPEN (no one applied)
      // Compare dates only (ignore time) - if the calendar date has passed, show "Flexible"
      const jobStatus = (job.status || "").toUpperCase();
      const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
      const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const dateHasPassed = jobDateOnly < todayOnly;
      const isStillOpen = jobStatus === "OPEN";
      
      if (dateHasPassed && isStillOpen) {
        // Date passed but job still needed - show "Flexible" like TaskRabbit/Handy
        const startStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const endStr = endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const originalDateStr = jobDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        dateTimeLine.innerHTML = `üìÖ <span style="color: #dc2626; font-weight: 600;">Flexible</span> ‚Ä¢ ‚è∞ ${startStr} - ${endStr} <span class="muted" style="font-size: 0.85em;">(originally ${originalDateStr})</span>`;
      } else {
        // Normal date display
        const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const startStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const endStr = endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        dateTimeLine.textContent = `üìÖ ${dateStr} ‚Ä¢ ‚è∞ ${startStr} - ${endStr}`;
      }
    } else {
      dateTimeLine.textContent = "Date/time TBD";
    }
    card.appendChild(dateTimeLine);

    // location line - use pickup info from requirements, not geocoded address
    const loc = document.createElement("div");
    loc.className = "job-meta";

    const requirements = job.requirements || {};
    const pickupZip = requirements.pickupZip || '';
    const pickupCity = requirements.pickupCity || job.customer?.city || '';
    const pickupArea = requirements.pickupArea || '';
    const pickupAddress = requirements.pickupAddress || '';
    
    // Add distance if available
    const distance = job.distance !== null && job.distance !== undefined ? job.distance : null;
    const distanceText = job.distanceFormatted || (distance !== null ? `${distance.toFixed(1)} mi` : '');
    
    // Build location string from pickup fields (NEVER use geocoded address - it can be wrong)
    let locParts = [];
    if (pickupAddress) {
      locParts.push(pickupAddress);
    }
    if (pickupArea) {
      locParts.push(pickupArea);
    }
    if (pickupCity) {
      locParts.push(pickupCity);
    }
    // Always show zip code - required for location matching
    if (pickupZip) {
      locParts.push(pickupZip);
    }
    
    // Always use pickup fields, never fall back to geocoded address
    let locText = `üìç ${locParts.length > 0 ? locParts.join(' ‚Ä¢ ') : "Location TBD"}`;
    if (distanceText && distanceText !== 'Distance unknown') {
      locText += ` ‚Ä¢ ${distanceText} away`;
    }
    if (requirements.onSiteOnly) {
      locText += " ‚Ä¢ On-site only";
    }
    
    loc.textContent = locText;
    card.appendChild(loc);
    
    // Add applicant count badge - visible to both customers and hustlers
    if (job._count && job._count.offers !== undefined) {
      const applicantCount = job._count.offers;
      if (applicantCount > 0) {
        const countBadge = document.createElement("div");
        countBadge.style.marginTop = "0.5rem";
        countBadge.style.display = "inline-flex";
        countBadge.style.alignItems = "center";
        countBadge.style.gap = "0.25rem";
        countBadge.style.padding = "0.25rem 0.5rem";
        countBadge.style.background = "#dbeafe";
        countBadge.style.color = "#1e40af";
        countBadge.style.borderRadius = "6px";
        countBadge.style.fontSize = "0.85rem";
        countBadge.style.fontWeight = "600";
        countBadge.innerHTML = `üë• <span>${applicantCount} ${applicantCount === 1 ? 'person applied' : 'people applied'}</span>`;
        card.appendChild(countBadge);
      }
    }
    
    // Payment and team size info at bottom
    const paymentInfo = document.createElement("div");
    paymentInfo.className = "job-meta";
    paymentInfo.style.marginTop = "0.5rem";
    
    const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
    let paymentText = "";
    if (job.payType === "flat") {
      paymentText = `üí∞ Payment: $${(Number(job.amount) || 0).toFixed(2)} flat`;
    } else {
      const hr = Number(job.hourlyRate) || 0;
      const maxH = job.estHours || 0;
      if (teamSize > 1) {
        const totalPerHour = hr * teamSize;
        const maxTotal = totalPerHour * maxH;
        paymentText = `üí∞ Payment: $${hr.toFixed(2)}/hr per person (${teamSize} people = $${totalPerHour.toFixed(2)}/hr) ¬∑ Max: $${maxTotal.toFixed(2)} for ${maxH}h`;
      } else {
        const maxTotal = hr * maxH;
        paymentText = `üí∞ Payment: $${hr.toFixed(2)}/hr ¬∑ Max: $${maxTotal.toFixed(2)} for ${maxH}h`;
      }
    }
    
    // Add team size info
    if (teamSize > 1) {
      paymentText += ` ‚Ä¢ üë• Needs ${teamSize} people (you hire 1 person who brings ${teamSize - 1} friend${teamSize - 1 > 1 ? 's' : ''})`;
    }
    
    paymentInfo.textContent = paymentText;
    card.appendChild(paymentInfo);

    // actions row
    const actions = document.createElement("div");
    actions.className = "job-card-actions";

    const left = document.createElement("div");
    const statusBadge = document.createElement("span");
    statusBadge.className = "badge";

    const status = (job.status || "OPEN").toUpperCase();
    // requirements already declared above, reuse it
    const startCodeUsed = requirements.startCodeUsed === true;
    
    // Simplified status display: Open, Assigned, In Progress, Completed
    // Check if job is actually in progress (start code used) even if status is ASSIGNED
    if (status === "OPEN") {
      statusBadge.classList.add("status-open");
      statusBadge.textContent = "Open";
    } else if (status === "ASSIGNED" && !startCodeUsed) {
      statusBadge.classList.add("status-assigned");
      statusBadge.textContent = "Assigned";
    } else if (status === "PAID" || startCodeUsed) {
      // Job is In Progress if status is PAID OR start code has been used
      statusBadge.classList.add("status-assigned");
      statusBadge.style.background = "#fbbf24";
      statusBadge.style.color = "#78350f";
      statusBadge.textContent = "In Progress";
    } else if (status === "COMPLETED_BY_HUSTLER" || status === "AWAITING_CUSTOMER_CONFIRM") {
      statusBadge.classList.add("status-completed");
      statusBadge.textContent = "Completed";
    } else {
      // Fallback for any other status
      statusBadge.textContent = status === "CANCELLED" ? "Cancelled" : "Open";
    }

    left.appendChild(statusBadge);
    
    // Check if user has applied to this job (for hustlers) - async check
    // Only check if job is OPEN and user is not the customer
    const jobStatusForApply = (job.status || "").toUpperCase();
    if (user && userMode === "hustler" && jobStatusForApply === "OPEN" && job.customerId !== user.id) {
      // Check offers asynchronously and add badge when ready
      // Silently fail if we don't have permission (403) - that's okay, just means they haven't applied
      window.hustlAPI.offers.list(job.id).then(offers => {
        const userOffer = offers.find(o => o.hustlerId === user.id);
        if (userOffer) {
          const appliedBadge = document.createElement("span");
          appliedBadge.className = "badge";
          appliedBadge.style.background = "#dbeafe";
          appliedBadge.style.color = "#1e40af";
          appliedBadge.style.marginLeft = "0.5rem";
          const offerStatus = (userOffer.status || "PENDING").toUpperCase();
          if (offerStatus === "ACCEPTED") {
            appliedBadge.textContent = "üéâ Accepted!";
            appliedBadge.style.background = "#10b981";
            appliedBadge.style.color = "#ffffff";
            appliedBadge.style.fontWeight = "700";
            appliedBadge.style.animation = "pulse 2s infinite";
          } else if (offerStatus === "DECLINED") {
            appliedBadge.textContent = "Declined";
            appliedBadge.style.background = "#fee2e2";
            appliedBadge.style.color = "#991b1b";
          } else {
            appliedBadge.textContent = "Applied";
          }
          left.appendChild(appliedBadge);
        }
      }).catch(error => {
        // Silently fail - 403 means user hasn't applied or doesn't have permission
        // This is expected behavior, so we don't need to log or show errors
      });
    }
    
    actions.appendChild(left);

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "0.5rem";
    right.style.alignItems = "center";
    
    // "Seen" dismiss button (for hustlers viewing open jobs they don't want)
    if (user && userMode === "hustler" && (job.status || "").toUpperCase() === "OPEN" && job.customerId !== user.id) {
      const seenBtn = document.createElement("button");
      seenBtn.className = "small-btn outline";
      seenBtn.textContent = "‚úì Seen";
      seenBtn.title = "Remove this job from your feed";
      seenBtn.style.padding = "0.5rem 0.9rem";
      seenBtn.style.fontSize = "0.8rem";
      seenBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        dismissJob(job.id);
      });
      right.appendChild(seenBtn);
    }
    
    const viewBtn = document.createElement("button");
    viewBtn.className = "small-btn outline";
    viewBtn.textContent = "View";
    viewBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      openJobDetails(job.id);
    });
    right.appendChild(viewBtn);
    actions.appendChild(right);

    card.appendChild(actions);

    // clicking the whole card opens details too (but not if clicking buttons)
    card.style.cursor = "pointer";
    card.addEventListener("click", (e) => {
      // Don't open if clicking on a button or action element
      if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.closest('.job-card-actions')) {
        return;
      }
      console.log('Job card clicked:', job.id);
      setView("jobs");
      setTimeout(() => openJobDetails(job.id), 50);
    });

    // Only append desktop card if not mobile (mobile cards already appended above)
    if (!isMobile) {
      jobsList.appendChild(card);
    }
  });
  
  // Add "Load More" button for mobile (if more jobs available)
  if (window.innerWidth <= 768 && window.mobileCore && jobsPagination.hasMore) {
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.className = 'job-feed-load-more mobile-only';
    loadMoreBtn.textContent = 'Load More Jobs';
    loadMoreBtn.addEventListener('click', () => {
      currentJobsPage++;
      renderJobs(false); // Don't reset
    });
    if (loadMoreContainer) {
      loadMoreContainer.innerHTML = '';
      loadMoreContainer.appendChild(loadMoreBtn);
      loadMoreContainer.style.display = 'block';
    }
  }
  
  // Wire up filter buttons if they exist
  const filtersBar = document.getElementById("jobFiltersBar");
  if (filtersBar) {
    filtersBar.querySelectorAll('.filter-btn').forEach(btn => {
      // Skip the "More" button - it has its own handler
      if (btn.id === 'showMoreFiltersBtn') return;
      
      btn.addEventListener('click', () => {
        // Remove active class from all buttons (except More button)
        filtersBar.querySelectorAll('.filter-btn').forEach(b => {
          if (b.id === 'showMoreFiltersBtn') return;
          b.classList.remove('active');
          b.style.borderColor = '#d1d5db';
          b.style.background = 'white';
          b.style.color = '#374151';
        });
        
        // Also update advanced filters container buttons
        const advancedContainer = document.getElementById('advancedFiltersContainer');
        if (advancedContainer) {
          advancedContainer.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.remove('active');
            b.style.borderColor = '#d1d5db';
            b.style.background = 'white';
            b.style.color = '#374151';
          });
        }
        
        // Add active class to clicked button
        btn.classList.add('active');
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#3b82f6';
        btn.style.color = 'white';
        
        // Update active filter
        activeJobFilter = btn.dataset.filter || 'newest';
        
        // Re-render jobs with new filter
        renderJobs(true); // Reset pagination
      });
    });
    
    // Set initial active state
    const activeFilterBtn = filtersBar.querySelector(`[data-filter="${activeJobFilter}"]`);
    if (activeFilterBtn) {
      activeFilterBtn.classList.add('active');
      activeFilterBtn.style.borderColor = '#3b82f6';
      activeFilterBtn.style.background = '#3b82f6';
      activeFilterBtn.style.color = 'white';
    }
  }
  
  // Wire up "More Filters" toggle button with smooth animations
  // Use a persistent state variable to track if filters are open
  if (!window.filtersDrawerState) {
    window.filtersDrawerState = { isOpen: false };
  }
  
  const showMoreFiltersBtn = document.getElementById('showMoreFiltersBtn');
  const advancedFiltersContainer = document.getElementById('advancedFiltersContainer');
  const showMoreFiltersArrow = document.getElementById('showMoreFiltersArrow');
  const showMoreFiltersText = document.getElementById('showMoreFiltersText');
  const filtersAppliedLabel = document.getElementById('filtersAppliedLabel');
  
  // Function to toggle filters drawer state
  function toggleFiltersDrawer(open) {
    if (!showMoreFiltersBtn || !advancedFiltersContainer) return;
    
    // Determine if we should open or close
    if (open === undefined) {
      open = !filtersDrawerOpen;
    }
    
    filtersDrawerOpen = open;
    
    if (open) {
      // Open it - expand drawer
      advancedFiltersContainer.style.display = 'block';
      // Force reflow
      advancedFiltersContainer.offsetHeight;
      const isMobile = window.innerWidth <= 768;
      advancedFiltersContainer.style.height = isMobile ? '250px' : 'auto';
      advancedFiltersContainer.style.opacity = '1';
      advancedFiltersContainer.style.transform = 'translateY(0)';
      if (showMoreFiltersText) showMoreFiltersText.textContent = 'Less Filters';
      if (showMoreFiltersArrow) showMoreFiltersArrow.style.transform = 'rotate(180deg)';
      showMoreFiltersBtn.style.background = '#eff6ff';
      showMoreFiltersBtn.style.borderColor = '#3b82f6';
      // Auto-scroll into view on mobile
      if (isMobile) {
        setTimeout(() => {
          advancedFiltersContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    } else {
      // Close it - collapse drawer
      advancedFiltersContainer.style.opacity = '0';
      advancedFiltersContainer.style.transform = 'translateY(-10px)';
      advancedFiltersContainer.style.height = '0';
      setTimeout(() => {
        advancedFiltersContainer.style.display = 'none';
      }, 300);
      if (showMoreFiltersText) showMoreFiltersText.textContent = 'More Filters';
      if (showMoreFiltersArrow) showMoreFiltersArrow.style.transform = 'rotate(0deg)';
      showMoreFiltersBtn.style.background = 'white';
      showMoreFiltersBtn.style.borderColor = '#d1d5db';
    }
  }
  
  // Don't restore state here - let the click listener handle it
  // Just ensure it starts closed if state says closed
  if (!filtersDrawerOpen && advancedFiltersContainer) {
    advancedFiltersContainer.style.display = 'none';
    advancedFiltersContainer.style.opacity = '0';
    advancedFiltersContainer.style.height = '0';
  }
  
  // Initial attach of click listener (only once using data attribute)
  if (showMoreFiltersBtn && advancedFiltersContainer && !showMoreFiltersBtn.dataset.listenerAttached) {
    showMoreFiltersBtn.dataset.listenerAttached = 'true';
    showMoreFiltersBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      filtersDrawerOpen = !filtersDrawerOpen;
      toggleFiltersDrawer(filtersDrawerOpen);
    }, { once: false, passive: false });
    
    // Restore state after a brief delay to ensure DOM is ready
    setTimeout(() => {
      if (filtersDrawerOpen && advancedFiltersContainer.style.display !== 'block') {
        toggleFiltersDrawer(true);
      }
    }, 100);
    
    // Wire up radius slider (sync with hidden select for backward compatibility)
    const radiusSlider = document.getElementById('jobsRadiusSlider');
    const radiusSelect = document.getElementById('jobsRadiusFilter');
    const radiusValueDisplay = document.getElementById('radiusValueDisplay');
    
    if (radiusSlider && radiusValueDisplay) {
      radiusSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        radiusValueDisplay.textContent = `${value} mi`;
        if (radiusSelect) {
          // Update select value if slider value matches an option
          const matchingOption = Array.from(radiusSelect.options).find(opt => opt.value === value);
          if (matchingOption) {
            radiusSelect.value = value;
          } else {
            // If no exact match, set closest value
            radiusSelect.value = value <= 10 ? '10' : value <= 25 ? '25' : '50';
          }
        }
      }, { passive: true });
      
      // Sync slider with select on load
      if (radiusSelect) {
        radiusSlider.value = radiusSelect.value || '10';
        radiusValueDisplay.textContent = `${radiusSlider.value} mi`;
      }
    }
    
    // Wire up Apply Filters button
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    if (applyFiltersBtn) {
      applyFiltersBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Close filters panel first
        filtersDrawerOpen = false;
        toggleFiltersDrawer(false);
        // Then re-render with new filters
        updateFiltersAppliedLabel();
        setTimeout(() => {
          renderJobs(true);
          // Scroll job list into view on mobile
          if (window.innerWidth <= 768) {
            setTimeout(() => {
              const jobsList = document.getElementById('jobsList');
              if (jobsList) jobsList.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
          }
        }, 350);
      }, { passive: false });
    }
    
    // Make "Filters Applied" label tappable to toggle filters panel (only attach once)
    if (filtersAppliedLabel && !filtersAppliedLabel.dataset.listenerAttached) {
      filtersAppliedLabel.dataset.listenerAttached = 'true';
      filtersAppliedLabel.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        filtersDrawerOpen = true;
        toggleFiltersDrawer(true); // Always open when clicking the label
      }, { once: false, passive: false });
    }
    
    // Wire up Reset Filters button
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    if (resetFiltersBtn) {
      resetFiltersBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Reset all filters to defaults
        if (radiusSelect) radiusSelect.value = '10';
        if (radiusSlider) {
          radiusSlider.value = '10';
          if (radiusValueDisplay) radiusValueDisplay.textContent = '10 mi';
        }
        const locationFilter = document.getElementById('jobsLocationFilter');
        if (locationFilter) locationFilter.value = '';
        
        // Reset filter buttons
        document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
          if (btn.id !== 'showMoreFiltersBtn') {
            btn.classList.remove('active');
            btn.style.borderColor = '#d1d5db';
            btn.style.background = 'white';
            btn.style.color = '#374151';
          }
        });
        
        // Set default filter
        const newestBtn = document.querySelector('[data-filter="newest"]');
        if (newestBtn) {
          newestBtn.classList.add('active');
          newestBtn.style.borderColor = '#3b82f6';
          newestBtn.style.background = '#3b82f6';
          newestBtn.style.color = 'white';
          activeJobFilter = 'newest';
        }
        
        renderJobs(true);
        updateFiltersAppliedLabel();
      }, { passive: false });
    }
    
    // Function to update "Filters Applied" label
    function updateFiltersAppliedLabel() {
      if (!filtersAppliedLabel) return;
      
      const activeFilters = [];
      const activeFilterBtns = document.querySelectorAll('.filter-btn.active[data-filter]');
      activeFilterBtns.forEach(btn => {
        const filter = btn.dataset.filter;
        if (filter === 'near-me') activeFilters.push('Near Me');
        else if (filter === 'newest') activeFilters.push('Newest');
        else if (filter === 'highest-pay') activeFilters.push('Highest Pay');
        else if (filter === 'hourly') activeFilters.push('Hourly');
        else if (filter === 'flat') activeFilters.push('Flat Rate');
      });
      
      const radius = radiusSelect?.value || radiusSlider?.value || '10';
      if (radius !== '10') {
        activeFilters.push(`${radius} mi radius`);
      }
      
      const location = document.getElementById('jobsLocationFilter')?.value?.trim();
      if (location) {
        if (location.length === 5 && /^\d{5}$/.test(location)) {
          activeFilters.push(`ZIP ${location}`);
        } else {
          activeFilters.push(`Location: ${location}`);
        }
      }
      
      if (activeFilters.length > 0) {
        filtersAppliedLabel.style.display = 'block';
        const filtersText = activeFilters.length === 1 
          ? `Filtering by ${activeFilters[0]}`
          : `${activeFilters.length} filters applied`;
        document.getElementById('filtersAppliedText').textContent = filtersText;
      } else {
        filtersAppliedLabel.style.display = 'none';
      }
    }
    
    // Update label when filters change
    document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
      if (btn.id !== 'showMoreFiltersBtn') {
        btn.addEventListener('click', () => {
          setTimeout(updateFiltersAppliedLabel, 100);
        });
      }
    });
    
    if (radiusSelect || radiusSlider) {
      (radiusSelect || radiusSlider).addEventListener('change', updateFiltersAppliedLabel);
      (radiusSelect || radiusSlider).addEventListener('input', updateFiltersAppliedLabel);
    }
    
    const locationFilter = document.getElementById('jobsLocationFilter');
    if (locationFilter) {
      locationFilter.addEventListener('input', updateFiltersAppliedLabel);
      locationFilter.addEventListener('blur', updateFiltersAppliedLabel);
    }
    
    // Initial update
    setTimeout(updateFiltersAppliedLabel, 500);
  }
  
  // Wire up advanced filter buttons (hourly/flat) if they exist
  if (advancedFiltersContainer) {
    advancedFiltersContainer.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove active from all filter buttons (main + advanced)
        const allFilterBtns = [
          ...(filtersBar?.querySelectorAll('.filter-btn') || []),
          ...advancedFiltersContainer.querySelectorAll('.filter-btn')
        ];
        allFilterBtns.forEach(b => {
          if (b.id === 'showMoreFiltersBtn') return;
          b.classList.remove('active');
          b.style.borderColor = '#d1d5db';
          b.style.background = 'white';
          b.style.color = '#374151';
        });
        
        // Add active to clicked button
        btn.classList.add('active');
        btn.style.borderColor = '#3b82f6';
        btn.style.background = '#3b82f6';
        btn.style.color = 'white';
        
        // Update active filter
        activeJobFilter = btn.dataset.filter || 'newest';
        
        // Re-render jobs
        renderJobs(true);
      });
    });
  }
  
  // 9) Show/hide Load More button
  if (loadMoreContainer) {
    if (jobsPagination.hasMore) {
      loadMoreContainer.style.display = "block";
    } else {
      loadMoreContainer.style.display = "none";
    }
  }
  } finally {
    // Always clear loading state
    loadingManager?.setLoading('jobs', false);
  }
}

    async function openJobDetails(jobId, options = {}) {
      // CRITICAL: Remove ANY existing overlays first
      document.querySelectorAll('.modal-overlay, [id^="jobModalOverlay"], #verificationCodeModal, [id^="jobDetailsOverlay"]').forEach(ov => {
        if (ov && ov.parentNode) {
          ov.remove();
        }
      });
      if (document.body) {
        document.body.style.overflow = "";
        document.body.style.pointerEvents = "";
      }

      // Get current user from token
      let user = null;
      try {
        const token = localStorage.getItem("hustl_token");
        if (token) {
          const response = await fetch("/users/me", {
            headers: { "Authorization": `Bearer ${token}` }
          });
          if (response.ok) {
            user = await response.json();
          }
        }
      } catch (error) {
        console.warn("Error getting user:", error);
      }
      
      // Fetch job from API
      let job;
      try {
        const token = localStorage.getItem("hustl_token");
        const response = await fetch(`/jobs/${jobId}`, {
          headers: token ? { "Authorization": `Bearer ${token}` } : {}
        });
        if (!response.ok) {
          throw new Error(`Failed to fetch job: ${response.statusText}`);
        }
        job = await response.json();
      } catch (error) {
        console.error("Error fetching job:", error);
        showToast("Error loading job details.");
        return;
      }

      if (!job) {
        showToast("Job not found.");
        return;
      }
      
      // üöÄ MOBILE: Use full-screen one-scroll page on mobile, modal on desktop
      const isMobile = window.innerWidth <= 768;
      
      // Create overlay/page container
      const overlay = document.createElement("div");
      overlay.id = "jobModalOverlay";
      overlay.className = isMobile ? "mobile-job-details-overlay" : "modal-overlay";
      if (isMobile) {
        // Full-screen on mobile
        overlay.style.cssText = "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 2000; overflow-y: auto; -webkit-overflow-scrolling: touch;";
      }
      
      // Store cleanup function
      let escapeHandler = null;
      const cleanup = function() {
        if (overlay && overlay.parentNode) {
          overlay.remove();
        }
        if (document.body) {
          document.body.style.overflow = "";
          document.body.style.pointerEvents = "";
        }
        if (escapeHandler) {
          document.removeEventListener("keydown", escapeHandler);
        }
        // üöÄ MOBILE: Update bottom nav if returning to jobs view
        if (isMobile && window.mobileCore && window.mobileCore.bottomNav) {
          window.mobileCore.bottomNav.updateActiveTab('jobs');
        }
      };
      
      // Only close on overlay click for desktop (not mobile - mobile uses back button)
      if (!isMobile) {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            cleanup();
          }
        });
      }
      
      // Close on Escape key
      escapeHandler = (e) => {
        if (e.key === "Escape" && document.getElementById("jobModalOverlay")) {
          cleanup();
        }
      };
      document.addEventListener("keydown", escapeHandler);

      // Create modal/content container
      const modal = document.createElement("div");
      modal.className = isMobile ? "mobile-job-details" : "modal-content";
      if (isMobile) {
        // Full-width on mobile, padding for scroll
        modal.style.cssText = "padding: 1rem; max-width: 100%; padding-bottom: 180px;";
      } else {
        modal.style.padding = "1.5rem";
      }

      // üöÄ MOBILE: Back button at top (full-width, thumb-friendly)
      if (isMobile) {
        const backBtn = document.createElement("button");
        backBtn.innerHTML = "‚Üê Back to Jobs";
        backBtn.style.cssText = "width: 100%; padding: 1rem; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; min-height: 48px; -webkit-tap-highlight-color: transparent;";
        backBtn.addEventListener("click", cleanup);
        modal.appendChild(backBtn);
      } else {
        // Desktop: Close button (X)
        const closeBtn = document.createElement("button");
        closeBtn.className = "modal-close";
        closeBtn.innerHTML = "√ó";
        closeBtn.addEventListener("click", cleanup);
        modal.appendChild(closeBtn);
      }

      // Build modal content
      const content = document.createElement("div");
      content.style.padding = "0.5rem 0";

      // Job Title Header
      const titleSection = document.createElement("div");
      titleSection.style.marginBottom = "1.5rem";
      const title = document.createElement("h2");
      title.style.margin = "0 0 0.5rem 0";
      title.style.fontSize = "1.5rem";
      title.textContent = job.title;
      titleSection.appendChild(title);

      // Category & Payment Info
      const metaInfo = document.createElement("div");
      metaInfo.className = "muted";
      metaInfo.style.marginBottom = "0.5rem";
      
      const categoryEmoji = {
        moving: "üöö",
        yard: "üåø",
        cleaning: "üßπ",
        furniture: "üõ†",
        handyman: "üîß",
        painting: "üé®",
        landscaping: "üå≥",
        petcare: "üêï",
        event: "üéâ",
        tech: "üíª",
      };
      const catText = categoryEmoji[job.category] || "‚≠ê";
      // Payment display - for hourly, show per person rate and team size
      let payText;
      if (job.payType === "flat") {
        payText = `$${(Number(job.amount) || 0).toFixed(2)} flat`;
      } else {
        const hourlyRate = Number(job.hourlyRate) || 0;
        const estHours = job.estHours || 0;
        const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
        if (teamSize > 1) {
          const totalPerHour = hourlyRate * teamSize;
          payText = `$${hourlyRate.toFixed(2)}/hr per person (${teamSize} people = $${totalPerHour.toFixed(2)}/hr) ¬∑ max ${estHours}h`;
        } else {
          payText = `$${hourlyRate.toFixed(2)}/hr ¬∑ max ${estHours}h`;
        }
      }
      const createdDate = job.createdAt ? new Date(job.createdAt).getTime() : Date.now();
      
      metaInfo.textContent = `${catText} ${job.category || "other"} ‚Ä¢ ${payText} ‚Ä¢ posted ${timeAgo(createdDate)}`;
      titleSection.appendChild(metaInfo);
      
      // Show Customer/Hustler names after hiring (prominently at top)
      if (job.status && (job.status.toUpperCase() === "ASSIGNED" || job.status.toUpperCase() === "PAID" || 
          job.status.toUpperCase() === "COMPLETED_BY_HUSTLER" || job.status.toUpperCase() === "AWAITING_CUSTOMER_CONFIRM" ||
          job.status.toUpperCase() === "COMPLETED")) {
        const participantsSection = document.createElement("div");
        participantsSection.style.marginTop = "1rem";
        participantsSection.style.padding = "1rem";
        participantsSection.style.background = "#f0f9ff";
        participantsSection.style.borderRadius = "8px";
        participantsSection.style.border = "2px solid #bae6fd";
        
        const participantsTitle = document.createElement("div");
        participantsTitle.style.fontWeight = "700";
        participantsTitle.style.fontSize = "1.1rem";
        participantsTitle.style.marginBottom = "0.75rem";
        participantsTitle.style.color = "#1e40af";
        participantsTitle.textContent = "üë• Job Participants";
        participantsSection.appendChild(participantsTitle);
        
        // Customer info
        if (job.customer) {
          const customerRow = document.createElement("div");
          customerRow.style.display = "flex";
          customerRow.style.alignItems = "center";
          customerRow.style.gap = "0.75rem";
          customerRow.style.marginBottom = "0.5rem";
          
          const customerLabel = document.createElement("span");
          customerLabel.style.fontWeight = "600";
          customerLabel.style.color = "#64748b";
          customerLabel.textContent = "Customer:";
          customerRow.appendChild(customerLabel);
          
          const customerName = document.createElement("span");
          customerName.style.fontWeight = "600";
          customerName.style.color = "#1f2937";
          customerName.style.fontSize = "1.05rem";
          customerName.textContent = job.customer.name || job.customer.username || "Customer";
          customerRow.appendChild(customerName);
          
          participantsSection.appendChild(customerRow);
        }
        
        // Hustler info
        if (job.hustler) {
          const hustlerRow = document.createElement("div");
          hustlerRow.style.display = "flex";
          hustlerRow.style.alignItems = "center";
          hustlerRow.style.gap = "0.75rem";
          
          const hustlerLabel = document.createElement("span");
          hustlerLabel.style.fontWeight = "600";
          hustlerLabel.style.color = "#64748b";
          hustlerLabel.textContent = "Hustler:";
          hustlerRow.appendChild(hustlerLabel);
          
          const hustlerName = document.createElement("span");
          hustlerName.style.fontWeight = "600";
          hustlerName.style.color = "#1f2937";
          hustlerName.style.fontSize = "1.05rem";
          hustlerName.textContent = job.hustler.name || job.hustler.username || "Hustler";
          hustlerRow.appendChild(hustlerName);
          
          participantsSection.appendChild(hustlerRow);
        }
        
        titleSection.appendChild(participantsSection);
      }
      
      content.appendChild(titleSection);

      // Job Details Section
      const detailsSection = document.createElement("div");
      detailsSection.style.marginBottom = "1.5rem";
      
      // Status Badge and Application Count
      const badgeContainer = document.createElement("div");
      badgeContainer.style.display = "flex";
      badgeContainer.style.alignItems = "center";
      badgeContainer.style.gap = "0.5rem";
      badgeContainer.style.flexWrap = "wrap";
      
      const statusBadge = document.createElement("span");
      statusBadge.className = "badge";
      const status = (job.status || "OPEN").toUpperCase();
      const requirements = job.requirements || {};
      const startCodeUsed = requirements.startCodeUsed === true;
      
      // Simplified status display: Open, Assigned, In Progress, Completed
      if (status === "COMPLETED") {
        // Purple badge for completed jobs
        statusBadge.classList.add("status-completed");
        statusBadge.style.background = "#9333ea";
        statusBadge.style.color = "#ffffff";
        statusBadge.textContent = "‚úì Completed!";
      } else if (status === "OPEN") {
        statusBadge.classList.add("status-open");
        statusBadge.textContent = "Open";
      } else if (status === "ASSIGNED" && !startCodeUsed) {
        statusBadge.classList.add("status-assigned");
        statusBadge.textContent = "Assigned";
      } else if (status === "COMPLETED") {
        // Purple badge for completed jobs
        statusBadge.classList.add("status-completed");
        statusBadge.style.background = "#9333ea";
        statusBadge.style.color = "#ffffff";
        statusBadge.textContent = "‚úì Completed!";
      } else if (status === "PAID" || startCodeUsed) {
        // Job is In Progress if status is PAID OR start code has been used
        statusBadge.classList.add("status-assigned");
        statusBadge.style.background = "#fbbf24";
        statusBadge.style.color = "#78350f";
        statusBadge.textContent = "In Progress";
      } else if (status === "COMPLETED_BY_HUSTLER" || status === "AWAITING_CUSTOMER_CONFIRM") {
        statusBadge.classList.add("status-assigned");
        statusBadge.style.background = "#fbbf24";
        statusBadge.style.color = "#78350f";
        statusBadge.textContent = "Awaiting Confirmation";
      } else {
        statusBadge.textContent = status === "CANCELLED" ? "Cancelled" : "Open";
      }
      badgeContainer.appendChild(statusBadge);
      
      // Application count badge - visible to everyone
      const applicationCount = job._count?.offers || 0;
      if (applicationCount > 0 && status === "OPEN") {
        const countBadge = document.createElement("span");
        countBadge.className = "badge";
        countBadge.style.background = "#2563eb";
        countBadge.style.color = "#fff";
        countBadge.innerHTML = `üë• ${applicationCount} ${applicationCount === 1 ? 'applicant' : 'applicants'}`;
        badgeContainer.appendChild(countBadge);
      }
      
      detailsSection.appendChild(badgeContainer);
      
      // 24-Hour Response Timer (for assigned jobs that haven't started)
      // Once start code is used, job is "In Progress" and refunds are disabled
      // Note: startCodeUsed already declared above at line 4040
      const isInProgress = startCodeUsed || status === "PAID";
      
      if (status === "ASSIGNED" && job.requirements?.assignedAt && job.customerId === user?.id && !isInProgress) {
        const assignedAt = new Date(job.requirements.assignedAt);
        const now = new Date();
        const hoursSinceAssigned = (now - assignedAt) / (1000 * 60 * 60);
        const hoursRemaining = 24 - hoursSinceAssigned;
        
        if (hoursRemaining > 0) {
          const timerContainer = document.createElement("div");
          timerContainer.id = `responseTimer_${job.id}`;
          timerContainer.style.marginTop = "1rem";
          timerContainer.style.padding = "0.75rem";
          timerContainer.style.background = hoursRemaining < 4 ? "#fee2e2" : "#fef3c7";
          timerContainer.style.borderRadius = "6px";
          timerContainer.style.border = `2px solid ${hoursRemaining < 4 ? "#dc2626" : "#f59e0b"}`;
          
          const timerHeader = document.createElement("div");
          timerHeader.style.fontWeight = "600";
          timerHeader.style.marginBottom = "0.25rem";
          timerHeader.style.color = hoursRemaining < 4 ? "#991b1b" : "#92400e";
          timerHeader.innerHTML = `‚è±Ô∏è Response Timer: <span id="timerCountdown_${job.id}">${Math.ceil(hoursRemaining)} hours remaining</span>`;
          timerContainer.appendChild(timerHeader);
          
          const timerDesc = document.createElement("div");
          timerDesc.style.fontSize = "0.85rem";
          timerDesc.style.lineHeight = "1.4";
          timerDesc.style.color = hoursRemaining < 4 ? "#991b1b" : "#78350f";
          if (hoursRemaining < 4) {
            timerDesc.innerHTML = `<strong>‚ö†Ô∏è Warning:</strong> If the hustler doesn't respond within ${Math.ceil(hoursRemaining)} hours, you can request a full refund and the job will be reopened.`;
          } else {
            timerDesc.textContent = `If the hustler doesn't respond within 24 hours of assignment, you can request a full refund and the job will be reopened for other hustlers.`;
          }
          timerContainer.appendChild(timerDesc);
          
          // Request refund button (only show if 24 hours passed AND job hasn't started)
          if (hoursRemaining <= 0 && !startCodeUsed) {
            const refundBtn = document.createElement("button");
            refundBtn.className = "btn";
            refundBtn.style.background = "#dc2626";
            refundBtn.style.color = "#fff";
            refundBtn.style.marginTop = "0.5rem";
            refundBtn.style.width = "100%";
            refundBtn.textContent = "Request Refund (24 Hours Passed)";
            refundBtn.addEventListener("click", async () => {
              if (!confirm("Request a refund? This will reopen the job for other hustlers.")) return;
              try {
                await window.hustlAPI.jobs.requestRefund(job.id);
                showToast("Refund requested. Job reopened.");
                overlay.remove();
                document.body.style.overflow = "";
                renderJobs();
              } catch (error) {
                showToast("Error requesting refund: " + (error.message || "Unknown error"));
              }
            });
            timerContainer.appendChild(refundBtn);
          }
          
          detailsSection.appendChild(timerContainer);
          
          // Update timer every minute
          const updateTimer = () => {
            const now = new Date();
            const hoursSince = (now - assignedAt) / (1000 * 60 * 60);
            const remaining = 24 - hoursSince;
            const countdownEl = document.getElementById(`timerCountdown_${job.id}`);
            if (countdownEl) {
              if (remaining > 0 && !startCodeUsed) {
                countdownEl.textContent = `${Math.ceil(remaining)} hours remaining`;
              } else {
                countdownEl.textContent = "24 hours passed - Refund available";
                // Reload to show refund button
                if (hoursRemaining > 0) {
                  setTimeout(() => openJobDetails(jobId), 1000);
                }
              }
            }
          };
          const timerInterval = setInterval(updateTimer, 60000); // Update every minute
          overlay.addEventListener("remove", () => clearInterval(timerInterval));
        }
      }
      
      // Show "Job In Progress" notice if start code has been used
      if (isInProgress && job.customerId === user?.id) {
        const inProgressNotice = document.createElement("div");
        inProgressNotice.style.marginTop = "1rem";
        inProgressNotice.style.padding = "0.75rem";
        inProgressNotice.style.background = "#dcfce7";
        inProgressNotice.style.borderRadius = "6px";
        inProgressNotice.style.border = "2px solid #16a34a";
        inProgressNotice.innerHTML = `
          <div style="font-weight: 600; font-size: 0.9rem; color: #166534; margin-bottom: 0.25rem;">
            ‚úÖ Job In Progress
          </div>
          <div style="font-size: 0.85rem; color: #15803d;">
            The hustler has started the job. Refunds are no longer available.
          </div>
        `;
        detailsSection.appendChild(inProgressNotice);
      }
      
      // Description (prominently displayed, collapsible for long descriptions)
      if (job.description) {
        const descContainer = document.createElement("div");
        descContainer.style.marginTop = "1rem";
        descContainer.style.padding = "0.75rem";
        descContainer.style.background = "#f9fafb";
        descContainer.style.borderRadius = "6px";
        descContainer.style.border = "1px solid #e5e7eb";
        
        const descLabel = document.createElement("div");
        descLabel.style.fontWeight = "600";
        descLabel.style.marginBottom = "0.5rem";
        descLabel.textContent = "üìù Description";
        descContainer.appendChild(descLabel);
        
        const desc = document.createElement("div");
        desc.style.lineHeight = "1.6";
        desc.style.color = "var(--text-main)";
        
        // Show more lines on mobile (4-6 lines ‚âà 160-200px) before collapsing
        const isLong = job.description.length > 250;
        const descId = `job-desc-${job.id}`;
        desc.id = descId;
        desc.textContent = job.description;
        desc.style.transition = "max-height 0.3s ease, opacity 0.3s ease";
        
        if (isLong) {
          // Show 4-6 lines initially (‚âà160px for mobile-friendly reading)
          const initialHeight = window.innerWidth <= 768 ? "200px" : "160px";
          desc.style.maxHeight = initialHeight;
          desc.style.overflow = "hidden";
          desc.style.position = "relative";
          
          // Add fade gradient at bottom when collapsed
          desc.style.setProperty("--mask-image", "linear-gradient(to bottom, black 0%, black 90%, transparent 100%)");
          
          const toggleBtn = document.createElement("button");
          toggleBtn.style.cssText = "margin-top: 0.75rem; padding: 0.5rem 1rem; background: #e5e7eb; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.4rem; transition: all 0.2s; -webkit-tap-highlight-color: transparent; user-select: none; min-height: 44px;";
          toggleBtn.innerHTML = '<span class="toggle-text">Show More</span> <span class="toggle-arrow" style="transition: transform 0.3s ease; font-size: 0.9rem;">‚ñº</span>';
          toggleBtn.dataset.expanded = "false";
          
          // Single-tap toggle with smooth animation (no double-tap)
          toggleBtn.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const expanded = toggleBtn.dataset.expanded === "true";
            const toggleArrow = toggleBtn.querySelector('.toggle-arrow');
            const toggleText = toggleBtn.querySelector('.toggle-text');
            
            if (expanded) {
              // Collapsing
              desc.style.maxHeight = initialHeight;
              desc.style.overflow = "hidden";
              toggleText.textContent = "Show More";
              if (toggleArrow) toggleArrow.style.transform = "rotate(0deg)";
              toggleBtn.dataset.expanded = "false";
              toggleBtn.style.background = "#e5e7eb";
            } else {
              // Expanding
              desc.style.maxHeight = "none";
              desc.style.overflow = "visible";
              toggleText.textContent = "Show Less";
              if (toggleArrow) toggleArrow.style.transform = "rotate(180deg)";
              toggleBtn.dataset.expanded = "true";
              toggleBtn.style.background = "#dbeafe";
              
              // Auto-scroll description into view on mobile so bottom nav doesn't block
              setTimeout(() => {
                desc.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }, 150);
            }
          }, { passive: false }); // Not passive so we can preventDefault
          
          descContainer.appendChild(desc);
          descContainer.appendChild(toggleBtn);
        } else {
          desc.textContent = job.description;
          descContainer.appendChild(desc);
        }
        
        detailsSection.appendChild(descContainer);
      }
      
      // Team Size Display (always show, even if 1 person)
      const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
      const teamInfo = document.createElement("div");
      teamInfo.style.marginTop = "1rem";
      teamInfo.style.padding = "0.75rem";
      teamInfo.style.background = teamSize > 1 ? "#fef3c7" : "#f9fafb";
      teamInfo.style.borderRadius = "6px";
      teamInfo.style.border = teamSize > 1 ? "2px solid #fbbf24" : "1px solid #e5e7eb";
      
      if (teamSize > 1) {
        teamInfo.innerHTML = `
          <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            üë• <span>Team Job: ${teamSize} People Needed</span>
          </div>
          <div style="font-size: 0.9rem; line-height: 1.5;">
            <strong>How it works:</strong> You'll be hired as the main hustler. You can bring ${teamSize - 1} friend${teamSize - 1 > 1 ? 's' : ''} to help, and you'll split the payment with them. The customer pays you, and you pay your team.
          </div>
        `;
      } else {
        teamInfo.innerHTML = `
          <div style="font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
            üë• <span>1 Person</span>
          </div>
        `;
      }
      detailsSection.appendChild(teamInfo);
      
      // Date and Time (prominently displayed)
      if (job.date && job.startTime && job.endTime) {
        const dateTimeContainer = document.createElement("div");
        dateTimeContainer.style.marginTop = "1rem";
        dateTimeContainer.style.padding = "0.75rem";
        
        const jobDate = new Date(job.date);
        const startTime = new Date(job.startTime);
        const endTime = new Date(job.endTime);
        const now = new Date();
        
        // Check if job date has passed and job is still OPEN
        // Compare dates only (ignore time) - if the calendar date has passed, show "Flexible"
        const jobStatus = (job.status || "").toUpperCase();
        const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
        const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dateHasPassed = jobDateOnly < todayOnly;
        const isStillOpen = jobStatus === "OPEN";
        
        if (dateHasPassed && isStillOpen) {
          // Date passed but still needed - show with warning style
          dateTimeContainer.style.background = "#fef3c7";
          dateTimeContainer.style.borderRadius = "6px";
          dateTimeContainer.style.border = "1px solid #fbbf24";
          
          const dateTimeText = document.createElement("div");
          dateTimeText.style.fontWeight = "600";
          dateTimeText.style.marginBottom = "0.25rem";
          dateTimeText.style.color = "#92400e";
          dateTimeText.innerHTML = `üìÖ <span style="color: #dc2626;">Flexible - Still Needed</span>`;
          dateTimeContainer.appendChild(dateTimeText);
          
          const originalDateText = document.createElement("div");
          originalDateText.className = "muted";
          originalDateText.style.fontSize = "0.85rem";
          originalDateText.style.marginBottom = "0.5rem";
          const originalDateStr = jobDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
          originalDateText.textContent = `Originally scheduled for: ${originalDateStr}`;
          dateTimeContainer.appendChild(originalDateText);
          
          const timeText = document.createElement("div");
          timeText.className = "muted";
          const startStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const endStr = endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          timeText.textContent = `‚è∞ Preferred time: ${startStr} - ${endStr}`;
          dateTimeContainer.appendChild(timeText);
        } else {
          // Normal date display
          dateTimeContainer.style.background = "#eff6ff";
          dateTimeContainer.style.borderRadius = "6px";
          dateTimeContainer.style.border = "1px solid #bfdbfe";
          
          const dateStr = jobDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
          const startStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const endStr = endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          
          const dateTimeText = document.createElement("div");
          dateTimeText.style.fontWeight = "600";
          dateTimeText.style.marginBottom = "0.25rem";
          dateTimeText.textContent = `üìÖ ${dateStr}`;
          dateTimeContainer.appendChild(dateTimeText);
          
          const timeText = document.createElement("div");
          timeText.className = "muted";
          timeText.textContent = `‚è∞ ${startStr} - ${endStr}`;
          dateTimeContainer.appendChild(timeText);
        }
        
        detailsSection.appendChild(dateTimeContainer);
      }

      // Locations - Show pickup and dropoff separately if both exist
      const pickupAddress = requirements.pickupAddress || job.address || '';
      const dropoffAddress = requirements.dropoffAddress || '';
      const pickupArea = requirements.pickupArea || '';
      const pickupCity = requirements.pickupCity || '';
      const pickupZip = requirements.pickupZip || '';
      const dropoffArea = requirements.dropoffArea || '';
      const dropoffCity = requirements.dropoffCity || '';
      const dropoffZip = requirements.dropoffZip || '';
      const onSiteOnly = requirements.onSiteOnly === true || job.requirements?.onSiteOnly === true;
      
      if (pickupAddress || pickupArea || pickupCity || pickupZip) {
        const locationContainer = document.createElement("div");
        locationContainer.style.marginTop = "1rem";
        locationContainer.style.padding = "0.75rem";
        locationContainer.style.background = "#f0fdf4";
        locationContainer.style.borderRadius = "6px";
        locationContainer.style.border = "1px solid #86efac";
        
        // Map Preview (move higher - right after location label)
        // Only show if we have valid lat/lng coordinates
        if (job.lat && job.lng && !isNaN(parseFloat(job.lat)) && !isNaN(parseFloat(job.lng))) {
          const mapPreview = document.createElement("div");
          mapPreview.id = `mapPreview-${job.id}`;
          mapPreview.style.cssText = "margin-bottom: 0.75rem; border-radius: 8px; overflow: hidden; height: 200px; width: 100%; background: #e5e7eb; cursor: pointer; border: 2px solid #86efac; position: relative;";
          
          // Use Mapbox Static Image API for preview
          const mapboxToken = "pk.eyJ1IjoiaHVzdGxtYXAiLCJhIjoiY21qNGUzc2pqMGVxbzJrcjhuYm1icGNueSJ9.YzIpkBWGqqn0dEHz-n_puQ";
          const lat = parseFloat(job.lat);
          const lng = parseFloat(job.lng);
          const mapImageUrl = `https://api.mapbox.com/styles/v1/mapbox/streets-v12/static/pin-s+2563eb(${lng},${lat})/${lng},${lat},14,0/400x200@2x?access_token=${mapboxToken}`;
          
          const mapImg = document.createElement("img");
          mapImg.loading = "lazy";
          mapImg.src = mapImageUrl;
          mapImg.style.cssText = "width: 100%; height: 100%; object-fit: cover; display: block;";
          mapImg.alt = "Job location map";
          
          // Add error handling for failed image loads
          mapImg.onerror = function() {
            this.style.display = "none";
            mapPreview.innerHTML = '<div style="padding: 2rem; text-align: center; color: #6b7280; height: 100%; display: flex; align-items: center; justify-content: center;">Map preview unavailable</div>';
          };
          
          mapPreview.appendChild(mapImg);
          
          mapPreview.addEventListener("click", () => {
            const address = pickupAddress || (pickupCity && pickupZip ? `${pickupCity}, ${pickupZip}` : pickupZip || '');
            if (address) {
              const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
              window.open(mapUrl, "_blank");
            } else if (lat && lng) {
              // Fallback to coordinates if no address
              const mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
              window.open(mapUrl, "_blank");
            }
          });
          
          locationContainer.appendChild(mapPreview);
        }
        
        // Pickup Location
        const pickupLabel = document.createElement("div");
        pickupLabel.style.fontWeight = "600";
        pickupLabel.style.marginBottom = "0.5rem";
        pickupLabel.textContent = "üìç Pickup Location";
        locationContainer.appendChild(pickupLabel);
        
        const pickupParts = [];
        if (pickupAddress) pickupParts.push(pickupAddress);
        if (pickupArea) pickupParts.push(pickupArea);
        if (pickupCity) pickupParts.push(pickupCity);
        if (pickupZip) pickupParts.push(pickupZip);
        
        const pickupText = document.createElement("div");
        pickupText.style.marginBottom = "0.5rem";
        pickupText.style.lineHeight = "1.5";
        pickupText.textContent = pickupParts.length > 0 ? pickupParts.join(', ') : 'Address shared after acceptance';
        locationContainer.appendChild(pickupText);
        
        // Map link for pickup - only use address and zipcode
        const pickupMapParts = [];
        if (pickupAddress) pickupMapParts.push(pickupAddress);
        if (pickupZip) pickupMapParts.push(pickupZip);
        
        if (pickupMapParts.length > 0) {
          const pickupMapLink = document.createElement("a");
          const pickupFullAddress = pickupMapParts.join(', ');
          pickupMapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(pickupFullAddress)}`;
          pickupMapLink.target = "_blank";
          pickupMapLink.rel = "noopener noreferrer";
          pickupMapLink.style.display = "inline-block";
          pickupMapLink.style.marginTop = "0.25rem";
          pickupMapLink.style.color = "#16a34a";
          pickupMapLink.style.textDecoration = "none";
          pickupMapLink.style.fontSize = "0.9rem";
          pickupMapLink.textContent = "üìç Open Pickup Location in Maps";
          pickupMapLink.addEventListener("mouseenter", () => {
            pickupMapLink.style.textDecoration = "underline";
          });
          pickupMapLink.addEventListener("mouseleave", () => {
            pickupMapLink.style.textDecoration = "none";
          });
          locationContainer.appendChild(pickupMapLink);
        }
        
        // Dropoff Location (if exists and not on-site only)
        if (!onSiteOnly && (dropoffAddress || dropoffArea || dropoffCity || dropoffZip)) {
          const dropoffLabel = document.createElement("div");
          dropoffLabel.style.fontWeight = "600";
          dropoffLabel.style.marginTop = "1rem";
          dropoffLabel.style.marginBottom = "0.5rem";
          dropoffLabel.textContent = "üìç Dropoff Location";
          locationContainer.appendChild(dropoffLabel);
          
          const dropoffParts = [];
          if (dropoffAddress) dropoffParts.push(dropoffAddress);
          if (dropoffArea) dropoffParts.push(dropoffArea);
          if (dropoffCity) dropoffParts.push(dropoffCity);
          if (dropoffZip) dropoffParts.push(dropoffZip);
          
          const dropoffText = document.createElement("div");
          dropoffText.style.marginBottom = "0.5rem";
          dropoffText.style.lineHeight = "1.5";
          dropoffText.textContent = dropoffParts.length > 0 ? dropoffParts.join(', ') : 'Address shared after acceptance';
          locationContainer.appendChild(dropoffText);
          
          // Map link for dropoff - only use address and zipcode
          const dropoffMapParts = [];
          if (dropoffAddress) dropoffMapParts.push(dropoffAddress);
          if (dropoffZip) dropoffMapParts.push(dropoffZip);
          
          if (dropoffMapParts.length > 0) {
            const dropoffMapLink = document.createElement("a");
            const dropoffFullAddress = dropoffMapParts.join(', ');
            dropoffMapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(dropoffFullAddress)}`;
            dropoffMapLink.target = "_blank";
            dropoffMapLink.rel = "noopener noreferrer";
            dropoffMapLink.style.display = "inline-block";
            dropoffMapLink.style.marginTop = "0.25rem";
            dropoffMapLink.style.color = "#16a34a";
            dropoffMapLink.style.textDecoration = "none";
            dropoffMapLink.style.fontSize = "0.9rem";
            dropoffMapLink.textContent = "üìç Open Dropoff Location in Maps";
            dropoffMapLink.addEventListener("mouseenter", () => {
              dropoffMapLink.style.textDecoration = "underline";
            });
            dropoffMapLink.addEventListener("mouseleave", () => {
              dropoffMapLink.style.textDecoration = "none";
            });
            locationContainer.appendChild(dropoffMapLink);
          }
        } else if (onSiteOnly) {
          const onSiteNote = document.createElement("div");
          onSiteNote.style.marginTop = "0.5rem";
          onSiteNote.style.fontSize = "0.85rem";
          onSiteNote.style.color = "#6b7280";
          onSiteNote.textContent = "On-site only (no separate dropoff location)";
          locationContainer.appendChild(onSiteNote);
        }
        
        detailsSection.appendChild(locationContainer);
      } else if (job.address) {
        // Fallback to old address format if new format not available
        const addrContainer = document.createElement("div");
        addrContainer.style.marginTop = "1rem";
        addrContainer.style.padding = "0.75rem";
        addrContainer.style.background = "#f0fdf4";
        addrContainer.style.borderRadius = "6px";
        addrContainer.style.border = "1px solid #86efac";
        
        const addr = document.createElement("div");
        addr.style.fontWeight = "600";
        addr.style.marginBottom = "0.5rem";
        addr.textContent = "üìç Location";
        addrContainer.appendChild(addr);
        
        const addrText = document.createElement("div");
        addrText.style.marginBottom = "0.5rem";
        addrText.textContent = job.address;
        addrContainer.appendChild(addrText);

        // Map link
        const mapLink = document.createElement("a");
        mapLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(job.address)}`;
        mapLink.target = "_blank";
        mapLink.rel = "noopener noreferrer";
        mapLink.style.display = "inline-block";
        mapLink.style.color = "#16a34a";
        mapLink.style.textDecoration = "none";
        mapLink.style.fontSize = "0.9rem";
        mapLink.textContent = "üìç Open in Maps";
        mapLink.addEventListener("mouseenter", () => {
          mapLink.style.textDecoration = "underline";
        });
        mapLink.addEventListener("mouseleave", () => {
          mapLink.style.textDecoration = "none";
        });
        addrContainer.appendChild(mapLink);

        detailsSection.appendChild(addrContainer);
      }
      
      // Estimated Duration and Tools Needed (from requirements)
      if (requirements.estimatedDuration || (requirements.toolsNeeded && requirements.toolsNeeded.length > 0)) {
        const requirementsContainer = document.createElement("div");
        requirementsContainer.style.marginTop = "1rem";
        requirementsContainer.style.padding = "0.75rem";
        requirementsContainer.style.background = "#f9fafb";
        requirementsContainer.style.borderRadius = "6px";
        requirementsContainer.style.border = "1px solid #e5e7eb";
        
        const reqTitle = document.createElement("div");
        reqTitle.style.fontWeight = "600";
        reqTitle.style.marginBottom = "0.5rem";
        reqTitle.textContent = "Job Requirements";
        requirementsContainer.appendChild(reqTitle);
        
        if (requirements.estimatedDuration) {
          const durationMap = {
            'under-1h': 'Under 1 hour',
            '1-2h': '1-2 hours',
            '2-4h': '2-4 hours',
            '4-6h': '4-6 hours',
            '6-8h': '6-8 hours',
            'full-day': 'Full day (8+ hours)',
            'multi-day': 'Multiple days'
          };
          const durationText = durationMap[requirements.estimatedDuration] || requirements.estimatedDuration;
          const durationEl = document.createElement("div");
          durationEl.style.marginBottom = "0.5rem";
          durationEl.innerHTML = `<strong>‚è±Ô∏è Estimated Duration:</strong> ${durationText}`;
          requirementsContainer.appendChild(durationEl);
        }
        
        if (requirements.toolsNeeded && Array.isArray(requirements.toolsNeeded) && requirements.toolsNeeded.length > 0) {
          const toolsEl = document.createElement("div");
          const toolsMap = {
            'truck': 'üöö Truck/Vehicle',
            'ladder': 'ü™ú Ladder',
            'power-tools': 'üîß Power Tools',
            'hand-tools': 'üõ†Ô∏è Hand Tools',
            'dolly': 'üì¶ Dolly/Cart',
            'cleaning-supplies': 'üßπ Cleaning Supplies'
          };
          const toolsList = requirements.toolsNeeded.map(tool => {
            return toolsMap[tool] || tool;
          }).join(', ');
          toolsEl.innerHTML = `<strong>üõ†Ô∏è Tools/Equipment Needed:</strong> ${toolsList}`;
          requirementsContainer.appendChild(toolsEl);
        }
        
        detailsSection.appendChild(requirementsContainer);
      }
      
      // Job Photos Carousel (mobile-friendly horizontal scroll)
      if (job.photos && Array.isArray(job.photos) && job.photos.length > 0) {
        const photosSection = document.createElement("div");
        photosSection.style.marginTop = "1rem";
        photosSection.style.marginBottom = "1rem";
        
        const photosLabel = document.createElement("div");
        photosLabel.style.fontWeight = "600";
        photosLabel.style.marginBottom = "0.75rem";
        photosLabel.style.fontSize = "1rem";
        photosLabel.textContent = `üì∏ Job Photos (${job.photos.length})`;
        photosSection.appendChild(photosLabel);
        
        const photosCarousel = document.createElement("div");
        photosCarousel.style.cssText = "display: flex; gap: 0.75rem; overflow-x: auto; padding: 0.5rem 0; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;";
        photosCarousel.style.scrollSnapType = "x mandatory";
        
        job.photos.forEach((photoUrl, index) => {
          const photoWrapper = document.createElement("div");
          photoWrapper.style.cssText = "flex-shrink: 0; width: 280px; height: 200px; border-radius: 8px; overflow: hidden; border: 2px solid #e5e7eb; cursor: pointer; scroll-snap-align: start; position: relative;";
          
          const img = document.createElement("img");
          img.loading = "lazy"; // Lazy load job photos
          img.src = photoUrl;
          img.style.cssText = "width: 100%; height: 100%; object-fit: cover;";
          img.alt = `Job photo ${index + 1}`;
          // Add error handling for failed image loads
          img.onerror = function() {
            this.style.display = "none";
          };
          
          img.addEventListener("click", () => {
            // Open photo in fullscreen modal
            const photoModal = document.createElement("div");
            photoModal.style.cssText = "position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;";
            
            const fullImg = document.createElement("img");
            // Don't lazy load fullscreen images - they're loaded on demand
            fullImg.src = photoUrl;
            fullImg.style.cssText = "max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;";
            // Add error handling for failed image loads
            fullImg.onerror = function() {
              photoModal.innerHTML = '<div style="padding: 2rem; text-align: center; color: white;">Failed to load image</div>';
            };
            
            const closeBtn = document.createElement("button");
            closeBtn.innerHTML = "√ó";
            closeBtn.style.cssText = "position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.9); border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 2rem; cursor: pointer; color: #1f2937; font-weight: 700; display: flex; align-items: center; justify-content: center;";
            closeBtn.addEventListener("click", () => photoModal.remove());
            
            photoModal.appendChild(fullImg);
            photoModal.appendChild(closeBtn);
            photoModal.addEventListener("click", (e) => {
              if (e.target === photoModal) photoModal.remove();
            });
            
            document.body.appendChild(photoModal);
          });
          
          photoWrapper.appendChild(img);
          photosCarousel.appendChild(photoWrapper);
        });
        
        photosSection.appendChild(photosCarousel);
        detailsSection.appendChild(photosSection);
      }
      
      content.appendChild(detailsSection);

      // Customer View: Show Applicants/Offers
      if (user && user.id === job.customerId && userMode === "customer") {
        const applicantsSection = document.createElement("div");
        applicantsSection.style.marginTop = "1.5rem";
        applicantsSection.style.padding = "1rem";
        applicantsSection.style.background = "#f9fafb";
        applicantsSection.style.borderRadius = "8px";
        
        const applicantsTitle = document.createElement("h3");
        applicantsTitle.style.margin = "0 0 1rem 0";
        applicantsTitle.style.fontSize = "1.1rem";
        applicantsTitle.textContent = "Hustlers Who Applied";
        applicantsSection.appendChild(applicantsTitle);

        // Fetch offers for this job
        let offers = [];
        try {
          const offersData = await window.hustlAPI.offers.list(jobId);
          offers = Array.isArray(offersData) ? offersData : [];
        } catch (error) {
          console.error("Error fetching offers:", error);
        }
        
        // Update title with count
        const offersCount = offers.length;
        applicantsTitle.textContent = `Hustlers Who Applied${offersCount > 0 ? ` (${offersCount})` : ""}`;
        
        // Add notification badge if there are applications
        if (offersCount > 0) {
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.style.background = "#2563eb";
          badge.style.color = "#fff";
          badge.style.marginLeft = "0.5rem";
          badge.textContent = offersCount;
          applicantsTitle.appendChild(badge);
        }

        if (offers.length === 0) {
          const noOffers = document.createElement("div");
          noOffers.className = "muted";
          noOffers.textContent = "No Hustlers have applied yet.";
          applicantsSection.appendChild(noOffers);
        } else {
          offers.forEach((offer) => {
            const offerCard = document.createElement("div");
            offerCard.style.padding = "0.75rem";
            offerCard.style.marginBottom = "0.5rem";
            offerCard.style.background = "#fff";
            offerCard.style.borderRadius = "6px";
            offerCard.style.border = "1px solid var(--border)";

            const headerRow = document.createElement("div");
            headerRow.style.display = "flex";
            headerRow.style.justifyContent = "space-between";
            headerRow.style.alignItems = "center";
            headerRow.style.marginBottom = "0.5rem";

            const hustlerInfo = document.createElement("div");
            const hustlerName = document.createElement("div");
            hustlerName.style.fontWeight = "600";
            hustlerName.style.fontSize = "1rem";
            hustlerName.textContent = offer.hustler?.name || offer.hustler?.username || "Hustler";
            hustlerInfo.appendChild(hustlerName);

            // Rating if available - show prominently
            const ratingRow = document.createElement("div");
            ratingRow.style.display = "flex";
            ratingRow.style.alignItems = "center";
            ratingRow.style.gap = "0.5rem";
            ratingRow.style.marginTop = "0.25rem";
            
            if (offer.hustler?.ratingAvg) {
              const ratingStars = document.createElement("span");
              ratingStars.style.fontSize = "0.95rem";
              ratingStars.style.fontWeight = "600";
              ratingStars.style.color = "#f59e0b";
              const ratingValue = offer.hustler.ratingAvg.toFixed(1);
              const maxRating = 5;
              ratingStars.textContent = `‚òÖ ${ratingValue} / ${maxRating}`;
              ratingRow.appendChild(ratingStars);
              
              if (offer.hustler.ratingCount) {
                const ratingCount = document.createElement("span");
                ratingCount.className = "muted";
                ratingCount.style.fontSize = "0.85rem";
                ratingCount.textContent = `(${offer.hustler.ratingCount} review${offer.hustler.ratingCount !== 1 ? 's' : ''})`;
                ratingRow.appendChild(ratingCount);
              }
            } else {
              const noRating = document.createElement("span");
              noRating.className = "muted";
              noRating.style.fontSize = "0.85rem";
              noRating.textContent = "No ratings yet";
              ratingRow.appendChild(noRating);
            }
            hustlerInfo.appendChild(ratingRow);

            headerRow.appendChild(hustlerInfo);

            // Status badge
            const statusBadge = document.createElement("span");
            statusBadge.className = "badge";
            const offerStatus = (offer.status || "PENDING").toUpperCase();
            if (offerStatus === "ACCEPTED") {
              statusBadge.classList.add("status-assigned");
              statusBadge.textContent = "Accepted";
            } else if (offerStatus === "DECLINED") {
              statusBadge.style.background = "#fee2e2";
              statusBadge.style.color = "#991b1b";
              statusBadge.textContent = "Declined";
            } else {
              statusBadge.classList.add("status-open");
              statusBadge.textContent = "Pending";
            }
            headerRow.appendChild(statusBadge);
            offerCard.appendChild(headerRow);

            // Show proposed amount if different from job amount
            if (offer.proposedAmount && offer.proposedAmount !== Number(job.amount)) {
              const proposedAmountDiv = document.createElement("div");
              proposedAmountDiv.style.marginTop = "0.5rem";
              proposedAmountDiv.style.padding = "0.5rem";
              proposedAmountDiv.style.background = "#fef3c7";
              proposedAmountDiv.style.borderRadius = "4px";
              proposedAmountDiv.style.fontSize = "0.9rem";
              proposedAmountDiv.style.fontWeight = "600";
              const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
              const originalAmount = Number(job.amount);
              proposedAmountDiv.innerHTML = `
                <div>üí∞ Proposed Amount: $${Number(offer.proposedAmount).toFixed(2)}</div>
                <div class="muted" style="font-size: 0.85rem; margin-top: 0.25rem;">Original: $${originalAmount.toFixed(2)}${teamSize > 1 && job.payType === "hourly" ? ` (${teamSize} people)` : ""}</div>
              `;
              offerCard.appendChild(proposedAmountDiv);
            }

            if (offer.note) {
              const note = document.createElement("div");
              note.className = "muted";
              note.style.marginTop = "0.5rem";
              note.style.padding = "0.5rem";
              note.style.background = "#f9fafb";
              note.style.borderRadius = "4px";
              note.style.fontSize = "0.9rem";
              note.textContent = offer.note;
              offerCard.appendChild(note);
            }

            const actionsRow = document.createElement("div");
            actionsRow.style.display = "flex";
            actionsRow.style.flexDirection = "column";
            actionsRow.style.gap = "0.5rem";
            actionsRow.style.marginTop = "0.75rem";

            // View Profile button (optional - not required)
            const viewProfileBtn = document.createElement("button");
            viewProfileBtn.className = "small-btn outline";
            viewProfileBtn.textContent = "View Profile & Reviews";
            viewProfileBtn.style.width = "100%";
            viewProfileBtn.addEventListener("click", () => {
              openUserProfile(offer.hustlerId);
            });
            actionsRow.appendChild(viewProfileBtn);

            // Accept/Decline buttons (only if pending)
            let payAndAcceptBtn = null;
            if (offer.status === "PENDING" && job.status === "OPEN" && !job.hustlerId) {
              payAndAcceptBtn = document.createElement("button");
              payAndAcceptBtn.className = "small-btn btn-primary";
              payAndAcceptBtn.textContent = "Pay & Accept";
              payAndAcceptBtn.style.width = "100%";
              
              payAndAcceptBtn.addEventListener("click", async () => {
                // Show payment modal first - payment must complete before accepting
                overlay.remove();
                document.body.style.overflow = "";
                
                // Show payment modal - on success, it will accept the offer
                setTimeout(async () => {
                  await showPaymentModal(job.id, offer.id);
                }, 500);
              });
              actionsRow.appendChild(payAndAcceptBtn);

              const declineBtn = document.createElement("button");
              declineBtn.className = "small-btn";
              declineBtn.style.background = "#fee2e2";
              declineBtn.style.color = "#991b1b";
              declineBtn.style.width = "100%";
              declineBtn.textContent = "Decline";
              declineBtn.addEventListener("click", async () => {
                if (!confirm("Decline this application?")) return;
                declineBtn.disabled = true;
                declineBtn.textContent = "Declining...";
                try {
                  await window.hustlAPI.offers.decline(offer.id);
                  showToast("Application declined.");
                  overlay.remove();
                  document.body.style.overflow = "";
                  renderJobs();
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to decline"));
                  declineBtn.disabled = false;
                  declineBtn.textContent = "Decline";
                }
              });
              actionsRow.appendChild(declineBtn);
            }

            offerCard.appendChild(actionsRow);
            applicantsSection.appendChild(offerCard);
          });
        }

        content.appendChild(applicantsSection);
      }

      // Show application count for hustlers (before apply section)
      if (user && userMode === "hustler" && job.status === "OPEN" && job.customerId !== user.id) {
        // Get application count
        const applicationCount = job._count?.offers || 0;
        if (applicationCount > 0) {
          const countSection = document.createElement("div");
          countSection.style.marginTop = "1.5rem";
          countSection.style.padding = "0.75rem";
          countSection.style.background = "#f0f9ff";
          countSection.style.borderRadius = "8px";
          countSection.style.border = "1px solid #bae6fd";
          countSection.style.textAlign = "center";
          
          const countText = document.createElement("div");
          countText.style.fontSize = "1rem";
          countText.style.fontWeight = "600";
          countText.style.color = "#1e40af";
          countText.innerHTML = `üë• <span>${applicationCount} ${applicationCount === 1 ? 'person has' : 'people have'} applied for this job</span>`;
          countSection.appendChild(countText);
          
          content.appendChild(countSection);
        }
      }

      // Hustler View: Apply to Job (if open and not already applied/accepted)
      if (user && userMode === "hustler" && job.status === "OPEN" && job.customerId !== user.id) {
        // Check if user already applied
        let userOffer = null;
        let allOffers = [];
        try {
          const token = localStorage.getItem("hustl_token");
          const response = await fetch(`/offers/${jobId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          if (response.ok) {
            const offersData = await response.json();
            allOffers = Array.isArray(offersData) ? offersData : [];
            userOffer = allOffers.find(o => o.hustlerId === user?.id);
          }
        } catch (error) {
          console.error("Error fetching offers:", error);
        }

        const applySection = document.createElement("div");
        applySection.style.marginTop = "1.5rem";
        applySection.style.padding = "1rem";
        applySection.style.background = "#f0f9ff";
        applySection.style.borderRadius = "8px";
        applySection.style.border = "1px solid #bae6fd";

        if (userOffer) {
          const appliedTitle = document.createElement("h3");
          appliedTitle.style.margin = "0 0 0.5rem 0";
          appliedTitle.style.fontSize = "1.1rem";
          appliedTitle.textContent = "You've Applied";
          applySection.appendChild(appliedTitle);

          const appliedStatus = document.createElement("div");
          appliedStatus.className = "muted";
          appliedStatus.style.marginBottom = "0.5rem";
          const offerStatus = (userOffer.status || "PENDING").toUpperCase();
          if (offerStatus === "ACCEPTED") {
            appliedStatus.innerHTML = `
              <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; color: #047857;">
                üéâ Congratulations! You were picked!
              </div>
              <div style="font-size: 0.95rem; color: #065f46; line-height: 1.6;">
                You've been selected as the Hustler for <strong>"${job.title}"</strong>! 
                Check your email for details and view the job to get started.
              </div>
            `;
            appliedStatus.style.color = "#047857";
            appliedStatus.style.fontWeight = "600";
            appliedStatus.style.padding = "1.25rem";
            appliedStatus.style.background = "linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)";
            appliedStatus.style.borderRadius = "12px";
            appliedStatus.style.border = "3px solid #10b981";
            appliedStatus.style.marginBottom = "1rem";
            
            // Add "View Job Details" button
            const viewJobBtn = document.createElement("button");
            viewJobBtn.className = "btn btn-primary";
            viewJobBtn.style.width = "100%";
            viewJobBtn.style.marginTop = "0.75rem";
            viewJobBtn.textContent = "üëâ View Job Details & Get Started";
            viewJobBtn.addEventListener("click", () => {
              overlay.remove();
              document.body.style.overflow = "";
              setTimeout(() => {
                openJobDetails(job.id);
              }, 100);
            });
            appliedStatus.appendChild(viewJobBtn);
          } else if (offerStatus === "DECLINED") {
            appliedStatus.textContent = "Your application was declined.";
            appliedStatus.style.color = "#dc2626";
          } else {
            appliedStatus.textContent = "Your application is pending customer review.";
          }
          applySection.appendChild(appliedStatus);

          if (userOffer.note) {
            const note = document.createElement("div");
            note.style.marginTop = "0.5rem";
            note.style.padding = "0.75rem";
            note.style.background = "#fff";
            note.style.borderRadius = "6px";
            note.style.fontSize = "0.9rem";
            note.textContent = userOffer.note;
            applySection.appendChild(note);
          }
          
          // Add message button if accepted
          if (offerStatus === "ACCEPTED" && job.customerId) {
            const messageBtn = document.createElement("button");
            messageBtn.className = "btn btn-primary";
            messageBtn.style.marginTop = "0.75rem";
            messageBtn.style.width = "100%";
            messageBtn.textContent = "üí¨ Message Customer";
            messageBtn.addEventListener("click", () => {
              // Set active conversation and switch to messages view
              activeConversationJobId = job.id;
              overlay.remove();
              document.body.style.overflow = "";
              setView("messages");
              // Small delay to ensure messages view is rendered
              setTimeout(() => {
                renderMessagesView();
              }, 100);
            });
            applySection.appendChild(messageBtn);
          }
        } else {
          const applyTitle = document.createElement("h3");
          applyTitle.style.margin = "0 0 1rem 0";
          applyTitle.style.fontSize = "1.1rem";
          applyTitle.textContent = "Apply for this Job";
          applySection.appendChild(applyTitle);

          // Show job amount and allow negotiation
          const jobAmountDisplay = document.createElement("div");
          jobAmountDisplay.style.marginBottom = "0.75rem";
          jobAmountDisplay.style.padding = "0.75rem";
          jobAmountDisplay.style.background = "#fff";
          jobAmountDisplay.style.borderRadius = "6px";
          jobAmountDisplay.style.border = "1px solid var(--border)";
          
          const teamSize = (job.requirements?.teamSize || job.teamSize || 1);
          const originalAmount = job.payType === "flat" 
            ? Number(job.amount || 0)
            : (Number(job.hourlyRate || 0) * Number(job.estHours || 0) * teamSize);
          
          let amountDescription = "";
          if (job.payType === "hourly") {
            const hourlyRate = Number(job.hourlyRate || 0);
            const estHours = job.estHours || 0;
            if (teamSize > 1) {
              amountDescription = `$${hourlyRate.toFixed(2)}/hr per person (${teamSize} people) ¬∑ max ${estHours}h`;
            } else {
              amountDescription = `$${hourlyRate.toFixed(2)}/hr ¬∑ max ${estHours}h`;
            }
          } else {
            amountDescription = `$${originalAmount.toFixed(2)}`;
          }
          
          jobAmountDisplay.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">Job Amount: ${amountDescription}</div>
            <div class="muted" style="font-size: 0.85rem;">${job.payType === "hourly" ? "You can propose a different hourly rate if needed" : "You can propose a different amount if needed"}</div>
          `;
          applySection.appendChild(jobAmountDisplay);
          
          // Price negotiation field (optional)
          const negotiateContainer = document.createElement("div");
          negotiateContainer.style.marginBottom = "0.75rem";
          
          const negotiateCheckbox = document.createElement("input");
          negotiateCheckbox.type = "checkbox";
          negotiateCheckbox.id = "negotiatePrice";
          negotiateCheckbox.style.marginRight = "0.5rem";
          
          const negotiateLabel = document.createElement("label");
          negotiateLabel.htmlFor = "negotiatePrice";
          negotiateLabel.textContent = "Propose different amount";
          negotiateLabel.style.cursor = "pointer";
          
          negotiateContainer.appendChild(negotiateCheckbox);
          negotiateContainer.appendChild(negotiateLabel);
          applySection.appendChild(negotiateContainer);
          
          const proposedAmountField = document.createElement("input");
          proposedAmountField.type = "number";
          proposedAmountField.id = "proposedAmount";
          // For hourly jobs, show hourly rate placeholder; for flat, show total amount
          if (job.payType === "hourly") {
            proposedAmountField.placeholder = "Your proposed hourly rate ($/hr)";
            proposedAmountField.value = Number(job.hourlyRate || 0).toFixed(2);
          } else {
            proposedAmountField.placeholder = "Your proposed amount ($)";
            proposedAmountField.value = originalAmount.toFixed(2);
          }
          proposedAmountField.style.width = "100%";
          proposedAmountField.style.padding = "0.75rem";
          proposedAmountField.style.border = "1px solid var(--border)";
          proposedAmountField.style.borderRadius = "6px";
          proposedAmountField.style.display = "none";
          proposedAmountField.style.marginTop = "0.5rem";
          proposedAmountField.min = "0";
          proposedAmountField.step = "0.01";
          
          negotiateCheckbox.addEventListener("change", () => {
            proposedAmountField.style.display = negotiateCheckbox.checked ? "block" : "none";
          });
          applySection.appendChild(proposedAmountField);

          // Review Profile button (before note field)
          const reviewProfileBtn = document.createElement("button");
          reviewProfileBtn.className = "small-btn outline";
          reviewProfileBtn.textContent = "üë§ Review Customer Profile";
          reviewProfileBtn.style.width = "100%";
          reviewProfileBtn.style.marginBottom = "0.75rem";
          reviewProfileBtn.addEventListener("click", () => {
            openUserProfile(job.customerId);
          });
          applySection.appendChild(reviewProfileBtn);

          const noteField = document.createElement("textarea");
          noteField.id = "applyNoteField";
          noteField.placeholder = "Tell the customer why you're a good fit, when you can do it, if you have a truck, etc.";
          noteField.style.width = "100%";
          noteField.style.minHeight = "100px";
          noteField.style.padding = "0.75rem";
          noteField.style.border = "1px solid var(--border)";
          noteField.style.borderRadius = "6px";
          noteField.style.fontFamily = "inherit";
          noteField.style.fontSize = "0.9rem";
          noteField.style.marginBottom = "0.75rem";
          applySection.appendChild(noteField);

          const applyBtn = document.createElement("button");
          applyBtn.className = "btn btn-primary";
          applyBtn.textContent = "Apply as Hustler";
          applyBtn.style.width = "100%";
          applyBtn.style.minHeight = "48px"; // Better touch target
          applyBtn.style.fontSize = "1rem";
          applyBtn.style.fontWeight = "600";
          
          // Handle both click and touch events for better mobile support
          const handleApply = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // NOTE: We do NOT validate hustler's profile zip code
            // Hustlers can apply to any job in Tennessee, regardless of their profile location
            // The backend validates that the JOB is in Tennessee (via pickupZip)
            
            const note = noteField.value.trim();
            if (!note) {
              showToast("Please add a note explaining why you're a good fit.");
              noteField.focus();
              return;
            }

            // Get proposed amount if negotiating
            let proposedAmount = null;
            if (negotiateCheckbox.checked) {
              proposedAmount = parseFloat(proposedAmountField.value);
              if (isNaN(proposedAmount) || proposedAmount <= 0) {
                showToast("Please enter a valid proposed amount.");
                proposedAmountField.focus();
                return;
              }
            }
            
            // Disable button and show loading state
            applyBtn.disabled = true;
            applyBtn.style.opacity = "0.6";
            applyBtn.style.cursor = "not-allowed";
            applyBtn.textContent = "Applying...";

            try {
              const token = localStorage.getItem("hustl_token");
              if (!token) {
                showToast("You must be logged in to apply for jobs.");
                applyBtn.disabled = false;
                applyBtn.style.opacity = "1";
                applyBtn.style.cursor = "pointer";
                applyBtn.textContent = "Apply as Hustler";
                return;
              }
              
              console.log("Creating offer for job:", job.id, "with note:", note, "proposedAmount:", proposedAmount);
              
              const response = await fetch(`/offers/${job.id}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                  note,
                  proposedAmount: proposedAmount ? Number(proposedAmount) : null
                })
              });
              
              const result = await response.json();
              
              if (!response.ok) {
                throw new Error(result.error || `Failed to apply: ${response.statusText}`);
              }
              
              console.log("Offer created successfully:", result);
              // Show appropriate message based on job type
              if (job.payType === "hourly" && proposedAmount) {
                showToast(`‚úì Application submitted with proposed hourly rate of $${proposedAmount.toFixed(2)}/hr!`);
              } else if (proposedAmount) {
                showToast(`‚úì Application submitted with proposed amount of $${proposedAmount.toFixed(2)}!`);
              } else {
                showToast("‚úì Application submitted!");
              }
              
              // Small delay before closing to show success
              setTimeout(() => {
                overlay.remove();
                document.body.style.overflow = "";
                renderJobs();
              }, 500);
            } catch (error) {
              console.error("Error applying for job:", error);
              let errorMsg = error.message || error.toString() || "Failed to apply. Please try again.";
              
              // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
              // Check if it's a Stripe requirement error
              /*
              if (errorMsg.includes("Stripe") || errorMsg.includes("stripe") || error.requiresStripe) {
                errorMsg = "You must connect your Stripe account before applying to jobs. Go to your Profile to set it up.";
                showToast("‚ö†Ô∏è " + errorMsg, 5000);
                // Close modal and redirect to profile after a moment
                setTimeout(() => {
                  overlay.remove();
                  document.body.style.overflow = "";
                  setView("profile");
                  renderAll();
                  // Scroll to Stripe section
                  setTimeout(() => {
                    const stripeSection = document.querySelector('[id*="stripe"], [class*="stripe"]');
                    if (stripeSection) {
                      stripeSection.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                  }, 500);
                }, 2000);
                applyBtn.disabled = false;
                applyBtn.style.opacity = "1";
                applyBtn.style.cursor = "pointer";
                applyBtn.textContent = "Apply as Hustler";
                return;
              }
              */
              
              // TEMPORARY: Just show error without Stripe redirect
              showToast("Error: " + errorMsg);
              
              applyBtn.disabled = false;
              applyBtn.style.opacity = "1";
              applyBtn.style.cursor = "pointer";
              applyBtn.textContent = "Apply as Hustler";
            }
          };
          
          applyBtn.addEventListener("click", handleApply);
          applyBtn.addEventListener("touchend", handleApply); // Mobile touch support
          applySection.appendChild(applyBtn);
        }

        content.appendChild(applySection);
      }

      // Hustler View: Show Customer Profile if Accepted
      if (user && user.id === job.hustlerId && userMode === "hustler" && job.status !== "OPEN") {
        const customerSection = document.createElement("div");
        customerSection.style.marginTop = "1.5rem";
        customerSection.style.padding = "1rem";
        customerSection.style.background = "#f9fafb";
        customerSection.style.borderRadius = "8px";

        const customerTitle = document.createElement("h3");
        customerTitle.style.margin = "0 0 1rem 0";
        customerTitle.style.fontSize = "1.1rem";
        customerTitle.textContent = "Customer";
        customerSection.appendChild(customerTitle);

        // Fetch customer info
        if (job.customer) {
          const customerCard = document.createElement("div");
          customerCard.style.padding = "0.75rem";
          customerCard.style.background = "#fff";
          customerCard.style.borderRadius = "6px";

          const customerName = document.createElement("div");
          customerName.style.fontWeight = "600";
          customerName.textContent = job.customer.name || job.customer.username || "Customer";
          customerCard.appendChild(customerName);

          if (job.customer.email) {
            const email = document.createElement("div");
            email.className = "muted";
            email.style.marginTop = "0.25rem";
            email.textContent = job.customer.email;
            customerCard.appendChild(email);
          }

          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "small-btn";
          viewProfileBtn.style.marginTop = "0.5rem";
          viewProfileBtn.textContent = "View Profile";
          viewProfileBtn.addEventListener("click", () => {
            // TODO: Open customer profile modal
            showToast("Profile view coming soon!");
          });
          customerCard.appendChild(viewProfileBtn);

          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-primary";
          messageBtn.style.marginTop = "0.5rem";
          messageBtn.style.width = "100%";
          messageBtn.textContent = "üí¨ Message Customer";
          messageBtn.addEventListener("click", () => {
            // Set active conversation and switch to messages view
            activeConversationJobId = job.id;
            overlay.remove();
            document.body.style.overflow = "";
            setView("messages");
            // Small delay to ensure messages view is rendered
            setTimeout(() => {
              renderMessagesView();
            }, 100);
          });
          customerCard.appendChild(messageBtn);

          customerSection.appendChild(customerCard);
        }

        content.appendChild(customerSection);
      }

      // Action Buttons Section
      const actionsSection = document.createElement("div");
      actionsSection.style.marginTop = "1.5rem";
      actionsSection.style.paddingTop = "1.5rem";
      actionsSection.style.borderTop = "1px solid var(--border)";

      // Customer Actions: Payment, Delete/Cancel job
      if (user && user.id === job.customerId && userMode === "customer") {
        // Show accepted hustler info if one is assigned
        if (job.hustlerId && job.hustler) {
          const hustlerInfo = document.createElement("div");
          hustlerInfo.style.marginBottom = "1rem";
          hustlerInfo.style.padding = "1rem";
          hustlerInfo.style.background = "#dcfce7";
          hustlerInfo.style.borderRadius = "8px";
          hustlerInfo.style.border = "1px solid #86efac";
          
          const statusUpper = (job.status || "").toUpperCase();
          let statusText = "";
          // Simplified status messages
          if (statusUpper === "ASSIGNED") {
            statusText = "Job is assigned. Share the start code with your hustler to begin.";
          } else if (statusUpper === "PAID") {
            statusText = "Job is in progress. The hustler will mark it complete when done.";
          } else if (statusUpper === "COMPLETED_BY_HUSTLER" || statusUpper === "AWAITING_CUSTOMER_CONFIRM") {
            statusText = "Hustler marked job as complete. Please confirm completion.";
          } else {
            statusText = "Job status: " + (statusUpper === "OPEN" ? "Open" : statusUpper === "CANCELLED" ? "Cancelled" : statusUpper);
          }
          
          // Check for hustler status update
          // requirements already declared above at line 4066, reuse it
          const hustlerStatus = requirements.hustlerStatus;
          const statusUpdatedAt = requirements.hustlerStatusUpdatedAt;
          
          let statusUpdateDisplay = "";
          if (hustlerStatus) {
            const statusMessages = {
              on_the_way: "üöó On the way",
              starting: "üèÅ Starting the job",
              almost_done: "‚ö° Almost done",
              just_finished: "‚úÖ Just finished",
            };
            const statusMsg = statusMessages[hustlerStatus] || hustlerStatus;
            const updatedTime = statusUpdatedAt ? timeAgo(new Date(statusUpdatedAt).getTime()) : "recently";
            statusUpdateDisplay = `
              <div style="margin-top: 0.5rem; padding: 0.5rem; background: #fff; border-radius: 4px; border: 1px solid #86efac;">
                <div style="font-weight: 600; font-size: 0.85rem; color: #059669; margin-bottom: 0.25rem;">üì± Hustler Status:</div>
                <div style="font-size: 0.9rem; color: #047857; font-weight: 600;">${statusMsg}</div>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Updated ${updatedTime}</div>
              </div>
            `;
          }
          
          // Show start code for customer (if job is ASSIGNED and not started yet)
          let startCodeDisplay = "";
          const startCode = requirements.startCode;
          // startCodeUsed already declared above at line 4067, reuse it
          
          if (statusUpper === "ASSIGNED" && startCode && !startCodeUsed) {
            startCodeDisplay = `
              <div style="margin-top: 0.75rem; padding: 0.75rem; background: #dbeafe; border-radius: 6px; border: 2px solid #3b82f6;">
                <div style="font-weight: 600; font-size: 0.85rem; color: #1e40af; margin-bottom: 0.5rem;">üîê Start Code (Give to Hustler)</div>
                <div style="font-size: 1.5rem; font-weight: 700; letter-spacing: 0.2em; color: #1e40af; text-align: center; font-family: 'Courier New', monospace; margin: 0.5rem 0;">
                  ${startCode}
                </div>
                <div style="font-size: 0.75rem; color: #dc2626; text-align: center; margin-top: 0.5rem; padding: 0.5rem; background: #fee2e2; border-radius: 4px; font-weight: 600;">
                  ‚ö†Ô∏è Important: Only give this code to the hustler when they arrive and the job is starting. Do not share it beforehand.
                </div>
                <div style="font-size: 0.75rem; color: #1e3a8a; text-align: center; margin-top: 0.25rem;">
                  Share this code with your hustler to officially start the job
                </div>
                <button id="regenerateStartCode_${job.id}" class="btn" style="width: 100%; margin-top: 0.5rem; background: #fff; color: #3b82f6; border: 1px solid #3b82f6; font-size: 0.8rem;">
                  üîÑ Regenerate Code
                </button>
              </div>
            `;
          }
          
          hustlerInfo.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #059669;">‚úì Hustler Assigned</div>
            <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
              <strong>${job.hustler.name || job.hustler.username || "Hustler"}</strong>
              ${job.hustler.ratingAvg > 0 ? ` ¬∑ ‚≠ê ${job.hustler.ratingAvg.toFixed(1)} (${job.hustler.ratingCount})` : ''}
            </div>
            <div style="font-size: 0.85rem; color: #047857;">
              ${statusText}
            </div>
            ${statusUpdateDisplay}
            ${startCodeDisplay}
          `;
          
          // Add message button for customer to message hustler
          const messageBtnRow = document.createElement("div");
          messageBtnRow.style.display = "flex";
          messageBtnRow.style.gap = "0.5rem";
          messageBtnRow.style.marginTop = "0.75rem";
          
          // Big Action Buttons (Message, Directions, etc.) - bigger, more prominent
          const messageBtn = document.createElement("button");
          messageBtn.className = "btn btn-primary";
          messageBtn.style.width = "100%";
          messageBtn.style.minHeight = "56px";
          messageBtn.style.fontSize = "1.1rem";
          messageBtn.style.fontWeight = "700";
          messageBtn.style.marginBottom = "0.75rem";
          messageBtn.innerHTML = "üí¨ Message Hustler";
          messageBtn.addEventListener("click", () => {
            // Set active conversation and switch to messages view
            activeConversationJobId = job.id;
            overlay.remove();
            document.body.style.overflow = "";
            setView("messages");
            // Small delay to ensure messages view is rendered
            setTimeout(() => {
              renderMessagesView();
            }, 100);
          });
          messageBtnRow.appendChild(messageBtn);
          
          // Directions button (big, prominent)
          if (pickupAddress || pickupZip) {
            const directionsBtn = document.createElement("button");
            directionsBtn.className = "btn outline";
            directionsBtn.style.width = "100%";
            directionsBtn.style.minHeight = "56px";
            directionsBtn.style.fontSize = "1.1rem";
            directionsBtn.style.fontWeight = "700";
            directionsBtn.style.border = "2px solid #2563eb";
            directionsBtn.style.color = "#2563eb";
            directionsBtn.style.marginBottom = "0.75rem";
            directionsBtn.innerHTML = "üìç Get Directions";
            directionsBtn.addEventListener("click", () => {
              const address = pickupAddress || (pickupCity && pickupZip ? `${pickupCity}, ${pickupZip}` : pickupZip || '');
              if (address) {
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                window.open(mapUrl, "_blank");
              } else {
                showToast("Address not available");
              }
            });
            messageBtnRow.appendChild(directionsBtn);
          }
          
          // Add view profile button
          const viewProfileBtn = document.createElement("button");
          viewProfileBtn.className = "btn";
          viewProfileBtn.style.background = "#fff";
          viewProfileBtn.style.color = "#059669";
          viewProfileBtn.style.border = "1px solid #86efac";
          viewProfileBtn.style.width = "100%";
          viewProfileBtn.style.minHeight = "48px";
          viewProfileBtn.style.fontSize = "1rem";
          viewProfileBtn.style.fontWeight = "600";
          viewProfileBtn.textContent = "üë§ View Profile & Reviews";
          viewProfileBtn.addEventListener("click", () => {
            overlay.remove();
            document.body.style.overflow = "";
            openUserProfile(job.hustlerId);
          });
          messageBtnRow.appendChild(viewProfileBtn);
          
          messageBtnRow.style.flexDirection = "column";
          hustlerInfo.appendChild(messageBtnRow);
          actionsSection.appendChild(hustlerInfo);
          
          // Add regenerate start code button handler
          if (startCodeDisplay) {
            const regenerateBtn = document.getElementById(`regenerateStartCode_${job.id}`);
            if (regenerateBtn) {
              regenerateBtn.addEventListener("click", async () => {
                try {
                  const result = await window.hustlAPI.jobs.getStartCode(job.id, true);
                  showToast("‚úì Start code regenerated");
                  overlay.remove();
                  document.body.style.overflow = "";
                  openJobDetails(job.id);
                } catch (error) {
                  showToast("Error: " + (error.message || "Failed to regenerate code"));
                }
              });
            }
          }
        }
        
        // Check if payment is needed (job is assigned but payment not completed)
        const jobStatusCheck = (job.status || "").toUpperCase();
        if (job.hustlerId && (jobStatusCheck === "ASSIGNED" || jobStatusCheck === "OPEN")) {
          // Check payment status
          let paymentNeeded = false;
          let paymentStatus = null;
          try {
            const payment = await window.hustlAPI.payments.getByJobId(job.id);
            paymentStatus = payment?.status;
            if (!payment || payment.status === "PREAUTHORIZED") {
              paymentNeeded = true;
            }
          } catch (error) {
            // Payment might not exist yet, so payment is needed
            paymentNeeded = true;
          }
          
          if (paymentNeeded) {
            const payBtn = document.createElement("button");
            payBtn.className = "btn btn-primary";
            payBtn.textContent = "Complete Payment";
            payBtn.style.marginBottom = "0.5rem";
            payBtn.addEventListener("click", async () => {
              try {
                // For now, show message - payment flow will be implemented
                showToast("Payment processing will be available soon. The job is assigned and ready to proceed.");
              } catch (error) {
                showToast("Error: " + (error.message || "Cannot process payment"));
              }
            });
            actionsSection.appendChild(payBtn);
            
            const paymentNote = document.createElement("div");
            paymentNote.className = "muted";
            paymentNote.style.fontSize = "0.85rem";
            paymentNote.style.marginBottom = "0.5rem";
            paymentNote.textContent = "Complete payment to finalize the job assignment.";
            actionsSection.appendChild(paymentNote);
          }
        }
        
        // Customer confirmation when hustler marked job complete
        const customerStatusCheck = (job.status || "").toUpperCase();
        if ((customerStatusCheck === "COMPLETED_BY_HUSTLER" || customerStatusCheck === "AWAITING_CUSTOMER_CONFIRM") && user && user.id === job.customerId) {
          const confirmBanner = document.createElement("div");
          confirmBanner.style.padding = "1rem";
          confirmBanner.style.marginBottom = "1rem";
          confirmBanner.style.background = "#fef3c7";
          confirmBanner.style.borderRadius = "8px";
          confirmBanner.style.border = "2px solid #fbbf24";
          
          const bannerTitle = document.createElement("div");
          bannerTitle.style.fontWeight = "600";
          bannerTitle.style.fontSize = "1rem";
          bannerTitle.style.marginBottom = "0.5rem";
          bannerTitle.textContent = "‚úì Hustler marked job as complete!";
          confirmBanner.appendChild(bannerTitle);
          
          const bannerText = document.createElement("div");
          bannerText.style.fontSize = "0.9rem";
          bannerText.style.marginBottom = "0.75rem";
          bannerText.innerHTML = `
            <div style="margin-bottom: 0.5rem;">Please confirm that the job was completed to your satisfaction.</div>
            <div style="font-weight: 600; color: #059669;">Once you confirm, payment will be immediately released to the hustler.</div>
          `;
          confirmBanner.appendChild(bannerText);
          
          // Verification code input
          const verificationCode = job.requirements?.verificationCode;
          if (verificationCode) {
            const codeSection = document.createElement("div");
            codeSection.style.marginTop = "0.75rem";
            codeSection.style.marginBottom = "0.75rem";
            codeSection.style.padding = "0.75rem";
            codeSection.style.background = "#dbeafe";
            codeSection.style.borderRadius = "6px";
            codeSection.style.border = "1px solid #93c5fd";
            
            const codeLabel = document.createElement("div");
            codeLabel.style.fontSize = "0.85rem";
            codeLabel.style.fontWeight = "600";
            codeLabel.style.marginBottom = "0.5rem";
            codeLabel.textContent = "üîê Enter Verification Code:";
            codeSection.appendChild(codeLabel);
            
            const codeInput = document.createElement("input");
            codeInput.type = "text";
            codeInput.id = "verificationCodeInput";
            codeInput.placeholder = "Enter 6-digit code";
            codeInput.maxLength = 6;
            codeInput.style.width = "100%";
            codeInput.style.padding = "1.25rem";
            codeInput.style.fontSize = "1.8rem";
            codeInput.style.textAlign = "center";
            codeInput.style.letterSpacing = "0.3em";
            codeInput.style.border = "3px solid #93c5fd";
            codeInput.style.borderRadius = "12px";
            codeInput.style.fontWeight = "700";
            codeInput.style.fontFamily = "monospace";
            codeInput.style.minHeight = "64px";
            codeInput.style.background = "#f0f9ff";
            codeInput.addEventListener("input", (e) => {
              e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
              // Auto-submit when 6 digits entered
              if (e.target.value.length === 6) {
                e.target.style.borderColor = "#10b981";
                e.target.style.background = "#f0fdf4";
                // Trigger confirm button click after brief delay
                setTimeout(() => {
                  const confirmBtn = confirmBanner.querySelector('.btn-primary');
                  if (confirmBtn) confirmBtn.click();
                }, 300);
              } else {
                e.target.style.borderColor = "#93c5fd";
                e.target.style.background = "#f0f9ff";
              }
            });
            codeInput.addEventListener("focus", (e) => {
              e.target.style.borderColor = "#3b82f6";
              e.target.style.boxShadow = "0 0 0 3px rgba(59, 130, 246, 0.1)";
            });
            codeInput.addEventListener("blur", (e) => {
              e.target.style.boxShadow = "none";
            });
            codeSection.appendChild(codeInput);
            
            const codeHint = document.createElement("div");
            codeHint.style.fontSize = "0.8rem";
            codeHint.style.marginTop = "0.5rem";
            codeHint.style.color = "#64748b";
            codeHint.textContent = "The hustler should have shared this code with you. It confirms you're both on the same page.";
            codeSection.appendChild(codeHint);
            
            confirmBanner.appendChild(codeSection);
            
            // Store code input for use in confirm button
            confirmBanner.codeInput = codeInput;
          }
          
          // Show completion photos only if there's an issue (optional)
          if (job.requirements && job.requirements.completionPhotos && job.requirements.completionPhotos.length > 0) {
            const photosDiv = document.createElement("div");
            photosDiv.style.marginTop = "0.75rem";
            photosDiv.style.marginBottom = "0.75rem";
            photosDiv.style.padding = "0.75rem";
            photosDiv.style.background = "#fff";
            photosDiv.style.borderRadius = "6px";
            photosDiv.style.border = "1px solid #e5e7eb";
            
            const photosLabel = document.createElement("div");
            photosLabel.style.fontSize = "0.85rem";
            photosLabel.style.fontWeight = "600";
            photosLabel.style.marginBottom = "0.5rem";
            photosLabel.textContent = "üì∏ Photos from hustler (optional):";
            photosDiv.appendChild(photosLabel);
            
            const photosGrid = document.createElement("div");
            photosGrid.style.display = "grid";
            photosGrid.style.gridTemplateColumns = "repeat(auto-fill, minmax(100px, 1fr))";
            photosGrid.style.gap = "0.5rem";
            
            job.requirements.completionPhotos.forEach(photoUrl => {
              const img = document.createElement("img");
              img.loading = "lazy"; // Lazy load completion photos
              img.src = photoUrl;
              img.style.width = "100%";
              img.style.height = "100px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "4px";
              img.style.cursor = "pointer";
              // Add error handling for failed image loads
              img.onerror = function() {
                this.style.display = "none";
              };
              img.addEventListener("click", () => {
                window.open(photoUrl, "_blank");
              });
              photosGrid.appendChild(img);
            });
            
            photosDiv.appendChild(photosGrid);
            confirmBanner.appendChild(photosDiv);
          }
          
          const buttonRow = document.createElement("div");
          buttonRow.style.display = "flex";
          buttonRow.style.gap = "0.5rem";
          
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "btn btn-primary";
          confirmBtn.style.flex = "1";
          confirmBtn.textContent = "‚úì Confirm & Release Payment";
          confirmBtn.addEventListener("click", async () => {
            const codeInput = confirmBanner.codeInput;
            let enteredCode = codeInput ? codeInput.value.trim() : null;
            
            // Remove any non-digit characters
            if (enteredCode) {
              enteredCode = enteredCode.replace(/\D/g, '');
            }
            
            if (verificationCode && (!enteredCode || enteredCode.length !== 6)) {
              showToast("Please enter the 6-digit verification code from the hustler.");
              if (codeInput) codeInput.focus();
              return;
            }
            
            if (!confirm("Confirm that the job was completed successfully? Payment will be released to the hustler.")) return;
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = "Confirming...";
            
            try {
              const result = await window.hustlAPI.jobs.confirmComplete(job.id, enteredCode);
              
              // Show green check animation
              const codeInputElement = codeInput;
              codeInputElement.style.borderColor = "#10b981";
              codeInputElement.style.background = "#d1fae5";
              codeInputElement.style.color = "#059669";
              
              // Add checkmark icon
              const checkIcon = document.createElement("div");
              checkIcon.style.cssText = "position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); font-size: 2rem; color: #10b981; animation: scaleIn 0.3s ease-out;";
              checkIcon.textContent = "‚úì";
              checkIcon.style.position = "absolute";
              checkIcon.style.right = "1rem";
              checkIcon.style.top = "50%";
              checkIcon.style.transform = "translateY(-50%)";
              checkIcon.style.fontSize = "2rem";
              checkIcon.style.color = "#10b981";
              
              // Add scale animation
              if (!document.getElementById('checkAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'checkAnimationStyle';
                style.textContent = `
                  @keyframes scaleIn {
                    0% { transform: translateY(-50%) scale(0); }
                    50% { transform: translateY(-50%) scale(1.2); }
                    100% { transform: translateY(-50%) scale(1); }
                  }
                `;
                document.head.appendChild(style);
              }
              
              codeSection.style.position = "relative";
              if (!codeSection.querySelector('.check-icon')) {
                checkIcon.className = "check-icon";
                codeSection.appendChild(checkIcon);
              }
              
              showToast("‚úì Job confirmed! Payment has been released to the hustler.", 5000);
              
              // Close the job details modal first
              setTimeout(() => {
                overlay.remove();
                document.body.style.overflow = "";
                
                // Refresh jobs list and profile to show updated status (COMPLETED with purple badge)
                renderJobs();
                renderProfile();
                
                // Job is now COMPLETED - both parties can review each other
                // Auto-open review modal for customer to review hustler
                if (job.hustlerId) {
                  setTimeout(() => {
                    showReviewModal(job.id, job.hustlerId, job.hustler?.name || "Hustler");
                  }, 500);
                }
              }, 1500);
              
              // Note: Hustler can also review customer - they'll see the option when they view the job
            } catch (error) {
              // Reset code input on error
              if (codeInput) {
                codeInput.style.borderColor = "#ef4444";
                codeInput.style.background = "#fef2f2";
                setTimeout(() => {
                  codeInput.style.borderColor = "#93c5fd";
                  codeInput.style.background = "#f0f9ff";
                }, 2000);
              }
              showToast("Error: " + (error.message || "Failed to confirm completion"));
              confirmBtn.disabled = false;
              confirmBtn.textContent = "‚úì Confirm & Release Payment";
            }
          });
          buttonRow.appendChild(confirmBtn);
          
          // Report issue button
          const reportBtn = document.createElement("button");
          reportBtn.className = "btn";
          reportBtn.style.background = "#fee2e2";
          reportBtn.style.color = "#991b1b";
          reportBtn.style.border = "1px solid #fecaca";
          reportBtn.textContent = "‚ö† Report Issue";
          reportBtn.addEventListener("click", () => {
            const reason = prompt("What's the issue? (e.g., job not done, poor quality, wrong work)");
            if (reason) {
              showToast("Issue reported. Our team will review this. Payment is on hold until resolved.");
              // In production, this would call an API endpoint to create a dispute
            }
          });
          buttonRow.appendChild(reportBtn);
          
          confirmBanner.appendChild(buttonRow);
          actionsSection.appendChild(confirmBanner);
        }
        
        
        const canDelete = job.status === "OPEN" && !job.hustlerId;
        
        if (canDelete) {
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "btn";
          deleteBtn.style.background = "#ef4444";
          deleteBtn.style.color = "#fff";
          deleteBtn.textContent = "Delete Job";
          deleteBtn.addEventListener("click", async () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            try {
              await window.hustlAPI.jobs.delete(job.id);
              showToast("Job deleted.");
              overlay.remove();
              document.body.style.overflow = "";
              renderJobs();
            } catch (error) {
              showToast("Error: " + (error.message || "Cannot delete job"));
            }
          });
          actionsSection.appendChild(deleteBtn);
        } else if (job.status !== "OPEN" || job.hustlerId) {
          const cancelBtn = document.createElement("button");
          cancelBtn.className = "btn outline";
          cancelBtn.textContent = "Cancel Job";
          cancelBtn.addEventListener("click", async () => {
            if (!confirm("Cancel this job? A record will be kept.")) return;
            try {
              await window.hustlAPI.jobs.cancel(job.id);
              showToast("Job cancelled.");
              overlay.remove();
              document.body.style.overflow = "";
              renderJobs();
            } catch (error) {
              showToast("Error: " + (error.message || "Cannot cancel job"));
            }
          });
          actionsSection.appendChild(cancelBtn);
        }
      }

      // Review button for completed jobs - show for BOTH customers and hustlers
      const jobStatusUpper = (job.status || "").toUpperCase();
      if (jobStatusUpper === "COMPLETED" && user) {
        // Check if user is customer or hustler
        const isCustomer = user.id === job.customerId;
        const isHustler = user.id === job.hustlerId;
        
        if (isCustomer || isHustler) {
          const revieweeId = isCustomer ? job.hustlerId : job.customerId;
          const revieweeName = isCustomer 
            ? (job.hustler?.name || job.hustler?.username || "Hustler")
            : (job.customer?.name || job.customer?.username || "Customer");
          
          if (revieweeId) {
            // Check if user has already reviewed
            let hasReviewed = false;
            try {
              const existingReviews = await window.hustlAPI.reviews.getJobReviews(job.id);
              hasReviewed = existingReviews.some(r => r.reviewerId === user.id && r.revieweeId === revieweeId);
            } catch (error) {
              console.error("Error checking reviews:", error);
              // Continue to show button - let API handle duplicate check
            }
            
            // Only show review section if user hasn't reviewed yet
            if (!hasReviewed) {
              const reviewSection = document.createElement("div");
              reviewSection.style.marginTop = "1.5rem";
              reviewSection.style.padding = "1rem";
              reviewSection.style.background = "#f0fdf4";
              reviewSection.style.borderRadius = "8px";
              reviewSection.style.border = "1px solid #86efac";
              
              const reviewTitle = document.createElement("div");
              reviewTitle.style.fontWeight = "600";
              reviewTitle.style.marginBottom = "0.5rem";
              reviewTitle.style.color = "#059669";
              reviewTitle.textContent = "‚≠ê Leave a Review";
              reviewSection.appendChild(reviewTitle);
              
              const reviewText = document.createElement("div");
              reviewText.style.fontSize = "0.9rem";
              reviewText.style.marginBottom = "0.75rem";
              reviewText.style.color = "#047857";
              reviewText.textContent = `Share your experience with ${revieweeName}. Your review helps build trust in the Hustl community.`;
              reviewSection.appendChild(reviewText);
              
              const reviewBtn = document.createElement("button");
              reviewBtn.className = "btn btn-primary";
              reviewBtn.style.width = "100%";
              reviewBtn.textContent = "üí¨ Leave Review";
              reviewBtn.addEventListener("click", () => {
                // Show review modal
                overlay.remove();
                document.body.style.overflow = "";
                setTimeout(() => {
                  showReviewModal(job.id, revieweeId, revieweeName);
                }, 300);
              });
              reviewSection.appendChild(reviewBtn);
              
              content.appendChild(reviewSection);
            }
          }
        }
      }

      // Hustler View: Start Code Input and Job Actions (show for ASSIGNED jobs)
      // requirements and startCodeUsed already declared above at lines 4066-4067, reuse them
      
      if (user && userMode === "hustler" && job.hustlerId === user.id && 
          (jobStatusUpper === "ASSIGNED" || jobStatusUpper === "PAID" || jobStatusUpper === "AWAITING_CUSTOMER_CONFIRM")) {
        const hustlerActions = document.createElement("div");
        hustlerActions.style.marginTop = "1.5rem";
        hustlerActions.style.padding = "1rem";
        hustlerActions.style.background = "#f0f9ff";
        hustlerActions.style.borderRadius = "8px";
        hustlerActions.style.border = "1px solid #bae6fd";
        
        const hustlerTitle = document.createElement("div");
        hustlerTitle.style.fontWeight = "600";
        hustlerTitle.style.marginBottom = "0.5rem";
        hustlerTitle.textContent = "Job Actions";
        hustlerActions.appendChild(hustlerTitle);
        
        // Start Code Section - Show for ALL jobs when ASSIGNED and not started yet
        if (jobStatusUpper === "ASSIGNED" && !startCodeUsed) {
          const startCodeSection = document.createElement("div");
          startCodeSection.style.marginBottom = "1rem";
          startCodeSection.style.padding = "0.75rem";
          startCodeSection.style.background = "#fff";
          startCodeSection.style.borderRadius = "6px";
          startCodeSection.style.border = "2px solid #3b82f6";
          
          const startCodeTitle = document.createElement("div");
          startCodeTitle.style.fontWeight = "600";
          startCodeTitle.style.marginBottom = "0.5rem";
          startCodeTitle.style.color = "#1e40af";
          startCodeTitle.textContent = "üîê Start Job with 4-Digit Code";
          startCodeSection.appendChild(startCodeTitle);
          
          const startCodeDesc = document.createElement("div");
          startCodeDesc.style.fontSize = "0.8rem";
          startCodeDesc.style.color = "#6b7280";
          startCodeDesc.style.marginBottom = "0.75rem";
          startCodeDesc.textContent = "The customer will give you a 4-digit code to officially start the job. Enter it below:";
          startCodeSection.appendChild(startCodeDesc);
          
          const startCodeInput = document.createElement("input");
          startCodeInput.type = "text";
          startCodeInput.placeholder = "Enter 4-digit start code";
          startCodeInput.maxLength = 4;
          startCodeInput.style.width = "100%";
          startCodeInput.style.padding = "0.75rem";
          startCodeInput.style.fontSize = "1.2rem";
          startCodeInput.style.textAlign = "center";
          startCodeInput.style.letterSpacing = "0.2em";
          startCodeInput.style.border = "2px solid #3b82f6";
          startCodeInput.style.borderRadius = "6px";
          startCodeInput.style.fontWeight = "600";
          startCodeInput.style.marginBottom = "0.5rem";
          startCodeInput.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
          });
          startCodeSection.appendChild(startCodeInput);
          
          const startBtn = document.createElement("button");
          startBtn.className = "btn btn-primary";
          startBtn.style.width = "100%";
          startBtn.textContent = "‚ñ∂ Start Job";
          startBtn.addEventListener("click", async () => {
            const code = startCodeInput.value.trim();
            if (!code || code.length !== 4) {
              showToast("Please enter the 4-digit start code from the customer");
              return;
            }
            if (!confirm("Start the job? This will activate the job and disable refunds.")) return;
            startBtn.disabled = true;
            startBtn.textContent = "Starting...";
            try {
              await window.hustlAPI.jobs.startJob(job.id, code);
              showToast("‚úì Job started successfully!");
              overlay.remove();
              document.body.style.overflow = "";
              openJobDetails(job.id); // Refresh modal
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to start job"));
              startBtn.disabled = false;
              startBtn.textContent = "‚ñ∂ Start Job";
            }
          });
          startCodeSection.appendChild(startBtn);
          
          hustlerActions.appendChild(startCodeSection);
        }
        
        // Job Timer Section (ONLY for hourly jobs that have been started)
        if (job.payType === "hourly" && startCodeUsed) {
          // requirements already declared above, reuse it
          const startedAt = requirements.startedAt;
          const endedAt = requirements.endedAt;
          const hoursWorked = requirements.hoursWorked;
          
          // Timer display container
          const timerContainer = document.createElement("div");
          timerContainer.id = `jobTimer_${job.id}`;
          timerContainer.style.marginBottom = "1rem";
          timerContainer.style.padding = "0.75rem";
          timerContainer.style.background = "#fff";
          timerContainer.style.borderRadius = "6px";
          timerContainer.style.border = "1px solid #e5e7eb";
          
          if (startedAt && !endedAt) {
          // Job is in progress - show live timer
          const timerDisplay = document.createElement("div");
          timerDisplay.style.fontSize = "1.1rem";
          timerDisplay.style.fontWeight = "600";
          timerDisplay.style.color = "#059669";
          timerDisplay.style.textAlign = "center";
          timerDisplay.id = `timerDisplay_${job.id}`;
          
          const updateTimer = () => {
            const startTime = new Date(startedAt);
            const now = new Date();
            const elapsed = now - startTime;
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            timerDisplay.textContent = `‚è±Ô∏è Time Elapsed: ${hours}h ${minutes}m ${seconds}s`;
          };
          
          updateTimer();
          const timerInterval = setInterval(updateTimer, 1000);
          overlay.addEventListener("remove", () => clearInterval(timerInterval));
          
          timerContainer.appendChild(timerDisplay);
          
          const timerLabel = document.createElement("div");
          timerLabel.style.fontSize = "0.8rem";
          timerLabel.style.color = "#6b7280";
          timerLabel.style.textAlign = "center";
          timerLabel.style.marginTop = "0.25rem";
          timerLabel.textContent = "Job in progress...";
          timerContainer.appendChild(timerLabel);
          
          // End Job button
          const endBtn = document.createElement("button");
          endBtn.className = "btn";
          endBtn.style.width = "100%";
          endBtn.style.marginTop = "0.75rem";
          endBtn.style.background = "#f59e0b";
          endBtn.style.color = "#fff";
          endBtn.textContent = "‚èπ End Job";
          endBtn.addEventListener("click", async () => {
            if (!confirm("End the job timer? This will calculate your total hours worked.")) return;
            endBtn.disabled = true;
            endBtn.textContent = "Ending...";
            try {
              await window.hustlAPI.jobs.endJob(job.id);
              showToast("‚úì Job timer ended. Hours worked calculated.");
              overlay.remove();
              document.body.style.overflow = "";
              openJobDetails(job.id); // Refresh modal
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to end job"));
              endBtn.disabled = false;
              endBtn.textContent = "‚èπ End Job";
            }
          });
          timerContainer.appendChild(endBtn);
        } else if (startedAt && endedAt) {
          // Job timer completed
          const completedDisplay = document.createElement("div");
          completedDisplay.style.fontSize = "0.95rem";
          completedDisplay.style.color = "#059669";
          completedDisplay.style.textAlign = "center";
          const startTime = new Date(startedAt);
          const endTime = new Date(endedAt);
          const totalMs = endTime - startTime;
          const totalHours = (totalMs / (1000 * 60 * 60)).toFixed(2);
          completedDisplay.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">‚úì Job Timer Completed</div>
            <div style="font-size: 0.85rem; color: #6b7280;">
              Started: ${new Date(startedAt).toLocaleTimeString()}<br>
              Ended: ${new Date(endedAt).toLocaleTimeString()}<br>
              ${hoursWorked ? `<strong>Total: ${hoursWorked} hours</strong>` : `<strong>Total: ${totalHours} hours</strong>`}
            </div>
          `;
          timerContainer.appendChild(completedDisplay);
        } else {
          // Job not started - show start button with code input
          const startCodeInput = document.createElement("input");
          startCodeInput.type = "text";
          startCodeInput.placeholder = "Enter 4-digit start code";
          startCodeInput.maxLength = 4;
          startCodeInput.style.width = "100%";
          startCodeInput.style.padding = "0.75rem";
          startCodeInput.style.fontSize = "1.2rem";
          startCodeInput.style.textAlign = "center";
          startCodeInput.style.letterSpacing = "0.2em";
          startCodeInput.style.border = "2px solid #3b82f6";
          startCodeInput.style.borderRadius = "6px";
          startCodeInput.style.fontWeight = "600";
          startCodeInput.style.marginBottom = "0.5rem";
          startCodeInput.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/\D/g, ""); // Only numbers
          });
          timerContainer.appendChild(startCodeInput);
          
          const startBtn = document.createElement("button");
          startBtn.className = "btn btn-primary";
          startBtn.style.width = "100%";
          startBtn.textContent = "‚ñ∂ Start Job (Enter Code)";
          startBtn.addEventListener("click", async () => {
            const code = startCodeInput.value.trim();
            if (!code || code.length !== 4) {
              showToast("Please enter the 4-digit start code from the customer");
              return;
            }
            if (!confirm("Start the job? This will activate the timer and cancellation penalties.")) return;
            startBtn.disabled = true;
            startBtn.textContent = "Starting...";
            try {
              await window.hustlAPI.jobs.startJob(job.id, code);
              showToast("‚úì Job started! Timer is now active.");
              overlay.remove();
              document.body.style.overflow = "";
              openJobDetails(job.id); // Refresh modal to show timer
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to start job"));
              startBtn.disabled = false;
              startBtn.textContent = "‚ñ∂ Start Job (Enter Code)";
            }
          });
          timerContainer.appendChild(startBtn);
          
          const timerHint = document.createElement("div");
          timerHint.style.fontSize = "0.75rem";
          timerHint.style.color = "#6b7280";
          timerHint.style.marginTop = "0.5rem";
          timerHint.style.textAlign = "center";
          timerHint.textContent = "Get the 4-digit start code from the customer to begin";
          timerContainer.appendChild(timerHint);
          }
          
          hustlerActions.appendChild(timerContainer);
        }
        
        // Job Status Updates Section (for all jobs - quick updates to customer)
        const statusUpdateContainer = document.createElement("div");
        statusUpdateContainer.style.marginBottom = "1rem";
        statusUpdateContainer.style.padding = "0.75rem";
        statusUpdateContainer.style.background = "#fef3c7";
        statusUpdateContainer.style.borderRadius = "6px";
        statusUpdateContainer.style.border = "1px solid #fbbf24";
        
        const statusTitle = document.createElement("div");
        statusTitle.style.fontWeight = "600";
        statusTitle.style.marginBottom = "0.5rem";
        statusTitle.style.color = "#92400e";
        statusTitle.textContent = "üì± Quick Status Update";
        statusUpdateContainer.appendChild(statusTitle);
        
        const statusDesc = document.createElement("div");
        statusDesc.style.fontSize = "0.8rem";
        statusDesc.style.color = "#78350f";
        statusDesc.style.marginBottom = "0.75rem";
        statusDesc.textContent = "Let the customer know your status (they'll see this in job details)";
        statusUpdateContainer.appendChild(statusDesc);
        
        const statusButtons = document.createElement("div");
        statusButtons.style.display = "grid";
        statusButtons.style.gridTemplateColumns = "repeat(2, 1fr)";
        statusButtons.style.gap = "0.5rem";
        
        const statusOptions = [
          { text: "üöó On the way", value: "on_the_way", emoji: "üöó" },
          { text: "üèÅ Starting", value: "starting", emoji: "üèÅ" },
          { text: "‚ö° Almost done", value: "almost_done", emoji: "‚ö°" },
          { text: "‚úÖ Just finished", value: "just_finished", emoji: "‚úÖ" },
        ];
        
        statusOptions.forEach(option => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.style.background = "#fff";
          btn.style.color = "#92400e";
          btn.style.border = "1px solid #fbbf24";
          btn.style.padding = "0.5rem";
          btn.style.fontSize = "0.85rem";
          btn.textContent = option.text;
          btn.addEventListener("click", async () => {
            try {
              await window.hustlAPI.jobs.updateStatus(job.id, option.value);
              showToast(`‚úì Status updated: ${option.text}`);
              // Refresh job details to show updated status
              overlay.remove();
              document.body.style.overflow = "";
              openJobDetails(job.id);
            } catch (error) {
              showToast("Error: " + (error.message || "Failed to update status"));
            }
          });
          statusButtons.appendChild(btn);
        });
        
        statusUpdateContainer.appendChild(statusButtons);
        hustlerActions.appendChild(statusUpdateContainer);
        
        const completeBtn = document.createElement("button");
        completeBtn.className = "btn btn-primary";
        completeBtn.style.width = "100%";
        completeBtn.style.minHeight = "48px";
        completeBtn.style.fontSize = "1rem";
        completeBtn.style.fontWeight = "600";
        completeBtn.textContent = "‚úì Mark Job as Complete";
        
        const handleComplete = async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (!confirm("Mark this job as complete? You'll receive a verification code to share with the customer.")) return;
          
          completeBtn.disabled = true;
          completeBtn.style.opacity = "0.6";
          completeBtn.style.cursor = "not-allowed";
          completeBtn.textContent = "Marking complete...";
          
          try {
            const result = await window.hustlAPI.jobs.complete(job.id);
            const verificationCode = result.requirements?.verificationCode || result.verificationCode;
            
            // Reset button state
            completeBtn.disabled = false;
            completeBtn.style.opacity = "1";
            completeBtn.style.cursor = "pointer";
            completeBtn.textContent = "‚úì Completed";
            
            if (verificationCode) {
              // Show verification code popup modal immediately
              showVerificationCodeModal(verificationCode, job.id, job.title);
              showToast(`‚úì Job marked complete! Your verification code: ${verificationCode}. Share this with the customer.`, 8000);
            } else {
              showToast("Job marked as complete! Waiting for customer confirmation.");
            }
            // Refresh to show updated status
            renderJobs();
            // Refresh job details if modal is still open
            setTimeout(() => {
              if (document.getElementById("jobModalOverlay")) {
                openJobDetails(job.id);
              }
            }, 500);
          } catch (error) {
            showToast("Error: " + (error.message || "Failed to mark job complete"));
            completeBtn.disabled = false;
            completeBtn.style.opacity = "1";
            completeBtn.style.cursor = "pointer";
            completeBtn.textContent = "‚úì Mark Job as Complete";
          }
        };
        
        completeBtn.addEventListener("click", handleComplete);
        completeBtn.addEventListener("touchend", handleComplete); // Mobile touch support
        hustlerActions.appendChild(completeBtn);
        
        content.appendChild(hustlerActions);
      }
      
      // Show status message if hustler already marked complete
      const completeStatusCheck = (job.status || "").toUpperCase();
      if (user && userMode === "hustler" && job.hustlerId === user.id && (completeStatusCheck === "COMPLETED_BY_HUSTLER" || completeStatusCheck === "AWAITING_CUSTOMER_CONFIRM")) {
        const statusMsg = document.createElement("div");
        statusMsg.style.marginTop = "1.5rem";
        statusMsg.style.padding = "1rem";
        statusMsg.style.background = "#dcfce7";
        statusMsg.style.borderRadius = "8px";
        statusMsg.style.border = "1px solid #86efac";
        
        const verificationCode = job.requirements?.verificationCode || job.verificationCode;
        
        statusMsg.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 0.5rem; color: #059669;">‚úì Job Marked Complete</div>
          <div style="font-size: 0.9rem; margin-bottom: ${verificationCode ? '0.75rem' : '0'};">
            Waiting for customer to confirm completion. Once they confirm, your payment will be immediately released.
          </div>
          ${verificationCode ? `
            <div style="margin-top: 0.75rem; padding: 1rem; background: #fff; border-radius: 8px; border: 3px solid #059669; position: relative;">
              <div style="font-size: 0.9rem; font-weight: 700; margin-bottom: 0.75rem; color: #047857; text-align: center;">üîê Your Verification Code:</div>
              <div id="hustlerCodeDisplay_${job.id}" style="font-size: 2rem; font-weight: 700; text-align: center; letter-spacing: 0.3em; color: #059669; font-family: monospace; padding: 1rem; background: #f0fdf4; border-radius: 6px; margin-bottom: 0.75rem;">
                ${verificationCode}
              </div>
              <button id="copyCodeBtn_${job.id}" class="btn btn-primary" style="width: 100%; min-height: 48px; font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem;">
                üìã Copy Code
              </button>
              <div style="font-size: 0.8rem; color: #047857; text-align: center; line-height: 1.5;">
                Share this code with the customer so they can confirm completion and release your payment
              </div>
            </div>
          ` : ''}
        `;
        
        // Add copy code functionality
        if (verificationCode) {
          const copyBtn = statusMsg.querySelector(`#copyCodeBtn_${job.id}`);
          if (copyBtn) {
            copyBtn.addEventListener("click", async () => {
              try {
                await navigator.clipboard.writeText(verificationCode);
                copyBtn.textContent = "‚úì Copied!";
                copyBtn.style.background = "#10b981";
                showToast("‚úì Code copied to clipboard!");
                setTimeout(() => {
                  copyBtn.textContent = "üìã Copy Code";
                  copyBtn.style.background = "";
                }, 2000);
              } catch (error) {
                // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = verificationCode;
                textArea.style.position = "fixed";
                textArea.style.opacity = "0";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                  document.execCommand('copy');
                  copyBtn.textContent = "‚úì Copied!";
                  copyBtn.style.background = "#10b981";
                  showToast("‚úì Code copied to clipboard!");
                  setTimeout(() => {
                    copyBtn.textContent = "üìã Copy Code";
                    copyBtn.style.background = "";
                  }, 2000);
                } catch (err) {
                  showToast("Failed to copy. Please copy manually: " + verificationCode);
                }
                document.body.removeChild(textArea);
              }
            });
          }
        }
        
        content.appendChild(statusMsg);
      }

      if (actionsSection.children.length > 0) {
        content.appendChild(actionsSection);
      }

      // Add content to modal, modal to overlay, overlay to body
      modal.appendChild(content);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Prevent body scroll when modal is open
      document.body.style.overflow = "hidden";
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) {
          overlay.remove();
          document.body.style.overflow = "";
        }
      });
    }
    // Confirmation page function (after payment success)
    window.showConfirmationPage = async function(jobId, offerId) {
      try {
        const job = await window.hustlAPI.jobs.get(jobId);
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!job || !user) return;
        
        // Find the accepted offer
        let offer = null;
        try {
          const offers = await window.hustlAPI.offers.list(jobId);
          offer = offers.find(o => o.id === offerId || o.status === 'ACCEPTED');
        } catch (error) {
          console.error("Error fetching offer:", error);
        }
        
        const hustler = offer?.hustler || job.hustler;
        if (!hustler) return;
        
        // Create confirmation overlay
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(15,23,42,0.75)";
        overlay.style.display = "flex";
        overlay.style.alignItems = "center";
        overlay.style.justifyContent = "center";
        overlay.style.zIndex = "200";
        
        const modal = document.createElement("div");
        modal.className = "card";
        modal.style.maxWidth = "600px";
        modal.style.width = "90%";
        modal.style.maxHeight = "90vh";
        modal.style.overflow = "auto";
        
        const header = document.createElement("div");
        header.className = "card-header";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = "‚úì Payment Successful!";
        header.appendChild(title);
        modal.appendChild(header);
        
        const contentDiv = document.createElement("div");
        contentDiv.style.padding = "1.5rem";
        
        // Success message
        const successMsg = document.createElement("div");
        successMsg.style.padding = "1rem";
        successMsg.style.background = "#dcfce7";
        successMsg.style.borderRadius = "6px";
        successMsg.style.marginBottom = "1.5rem";
        successMsg.innerHTML = `
          <div style="font-weight: 600; color: #166534; margin-bottom: 0.5rem;">‚úì Hustler Accepted!</div>
          <div style="color: #166534;">You've successfully hired <strong>${hustler.name || hustler.username}</strong> for "${job.title}".</div>
        `;
        contentDiv.appendChild(successMsg);
        
        // Job details
        const jobDetails = document.createElement("div");
        jobDetails.style.marginBottom = "1.5rem";
        jobDetails.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 0.5rem;">Job Details</div>
          <div class="muted">${job.title}</div>
          <div class="muted">${job.address || "Address TBD"}</div>
        `;
        contentDiv.appendChild(jobDetails);
        
        // Contact section
        const contactSection = document.createElement("div");
        contactSection.style.marginBottom = "1.5rem";
        contactSection.style.padding = "1rem";
        contactSection.style.background = "#f9fafb";
        contactSection.style.borderRadius = "6px";
        
        const contactTitle = document.createElement("div");
        contactTitle.style.fontWeight = "600";
        contactTitle.style.marginBottom = "0.75rem";
        contactTitle.textContent = "Get in Touch";
        contactSection.appendChild(contactTitle);
        
        const contactInfo = document.createElement("div");
        contactInfo.className = "muted";
        contactInfo.style.marginBottom = "1rem";
        contactInfo.textContent = `You can now message ${hustler.name || hustler.username} directly.`;
        contactSection.appendChild(contactInfo);
        
        // Message button
        const messageBtn = document.createElement("button");
        messageBtn.className = "btn btn-primary";
        messageBtn.style.width = "100%";
        messageBtn.textContent = "üí¨ Open Messages";
        messageBtn.addEventListener("click", () => {
          overlay.remove();
          document.body.style.overflow = "";
          setView("messages");
          // Find and select the conversation
          setTimeout(() => {
            const threads = document.querySelectorAll('[data-thread-id]');
            const thread = Array.from(threads).find(t => t.dataset.jobId === jobId);
            if (thread) {
              thread.click();
            }
          }, 500);
        });
        contactSection.appendChild(messageBtn);
        contentDiv.appendChild(contactSection);
        
        // View profile button
        const viewProfileBtn = document.createElement("button");
        viewProfileBtn.className = "btn outline";
        viewProfileBtn.style.width = "100%";
        viewProfileBtn.style.marginBottom = "0.5rem";
        viewProfileBtn.textContent = "üë§ View Hustler Profile";
        viewProfileBtn.addEventListener("click", () => {
          openUserProfile(hustler.id);
        });
        contentDiv.appendChild(viewProfileBtn);
        
        // Close button
        const closeBtn = document.createElement("button");
        closeBtn.className = "btn outline";
        closeBtn.style.width = "100%";
        closeBtn.textContent = "Done";
        closeBtn.addEventListener("click", () => {
          overlay.remove();
          document.body.style.overflow = "";
          // Force refresh everything
          setTimeout(() => {
            renderJobs();
            renderAll();
          }, 100);
        });
        contentDiv.appendChild(closeBtn);
        
        modal.appendChild(contentDiv);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.style.overflow = "hidden";
        
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            overlay.remove();
            document.body.style.overflow = "";
            renderJobs();
          }
        });
      } catch (error) {
        console.error("Error showing confirmation:", error);
        showToast("Payment successful! Check your messages to contact the hustler.");
        renderJobs();
      }
    };
    
    // Payment modal function - accepts offer after payment succeeds
    async function showPaymentModal(jobId, offerId = null) {
      try {
        const job = await window.hustlAPI.jobs.get(jobId);
        if (!job) {
          showToast("Job not found.");
          return;
        }
        
        // Calculate payment amounts (3% customer fee)
        const jobAmount = Number(job.amount || 0);
        const customerFee = Math.min(Math.max(jobAmount * 0.03, 1), 10); // 3% min $1, max $10
        const total = jobAmount + customerFee;
        
        // Create modal overlay
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(15,23,42,0.55)";
        overlay.style.display = "flex";
        overlay.style.alignItems = "center";
        overlay.style.justifyContent = "center";
        overlay.style.zIndex = "100";
        
        const modal = document.createElement("div");
        modal.className = "card";
        modal.style.maxWidth = "500px";
        modal.style.width = "90%";
        modal.style.maxHeight = "90vh";
        modal.style.overflow = "auto";
        
        const header = document.createElement("div");
        header.className = "card-header";
        const title = document.createElement("div");
        title.className = "card-title";
        title.textContent = offerId ? "Pay & Accept Hustler" : "Complete Payment";
        header.appendChild(title);
        modal.appendChild(header);
        
        const content = document.createElement("div");
        content.style.padding = "1.5rem";
        
        // Job summary
        const jobSummary = document.createElement("div");
        jobSummary.style.marginBottom = "1rem";
        jobSummary.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 0.5rem;">${job.title}</div>
          <div class="muted">${job.category} ‚Ä¢ ${job.address || "Address TBD"}</div>
        `;
        content.appendChild(jobSummary);
        
        // Payment details
        const paymentDetails = document.createElement("div");
        paymentDetails.style.marginBottom = "1.5rem";
        paymentDetails.style.padding = "1rem";
        paymentDetails.style.background = "#f9fafb";
        paymentDetails.style.borderRadius = "6px";
        
        // Build payment details with team size info
        let paymentDetailsHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Job Amount:</span>
            <span>$${jobAmount.toFixed(2)}</span>
          </div>`;
        
        // Add team size info if applicable
        if (teamSize > 1) {
          if (job.payType === "hourly") {
            const hourlyRate = Number(job.hourlyRate) || 0;
            const estHours = job.estHours || 0;
            paymentDetailsHTML += `
              <div class="muted" style="font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                üë• Team: ${teamSize} people at $${hourlyRate.toFixed(2)}/hr each = $${(hourlyRate * teamSize).toFixed(2)}/hr total ¬∑ Max ${estHours}h = $${jobAmount.toFixed(2)}<br>
                <strong>You hire 1 person who brings ${teamSize - 1} friend${teamSize - 1 > 1 ? 's' : ''}. No refund if finished early.</strong>
              </div>`;
          } else {
            paymentDetailsHTML += `
              <div class="muted" style="font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem; background: #fef3c7; border-radius: 4px;">
                üë• Team: ${teamSize} people (you hire 1 person who brings ${teamSize - 1} friend${teamSize - 1 > 1 ? 's' : ''})
              </div>`;
          }
        }
        
        paymentDetailsHTML += `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Service Fee (3%):</span>
            <span>$${customerFee.toFixed(2)}</span>
          </div>
          <div style="display: flex; justify-content: space-between; font-weight: 600; padding-top: 0.5rem; border-top: 1px solid var(--border);">
            <span>Total:</span>
            <span>$${total.toFixed(2)}</span>
          </div>`;
        
        paymentDetails.innerHTML = paymentDetailsHTML;
        content.appendChild(paymentDetails);
        
        // Payment button
        const payBtn = document.createElement("button");
        payBtn.className = "btn btn-primary";
        payBtn.style.width = "100%";
        payBtn.textContent = offerId ? `Pay $${total.toFixed(2)} & Accept` : `Pay $${total.toFixed(2)}`;
        payBtn.addEventListener("click", async () => {
          payBtn.disabled = true;
          payBtn.textContent = "Redirecting to payment...";
          try {
            // If offerId is provided, redirect to Stripe checkout
            if (offerId) {
              const response = await fetch('/payments/checkout/offer/' + offerId, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('hustl_token')}`,
                },
              });
              
              if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('Checkout error:', errorData);
                
                // TEMPORARILY DISABLED - Stripe requirement check bypassed for testing
                /*
                if (errorData.requiresStripe) {
                  showToast("‚ö†Ô∏è This hustler needs to connect their Stripe account first. They've been notified via email.");
                  overlay.remove();
                  document.body.style.overflow = "";
                  renderJobs();
                  return;
                }
                */
                
                // Better error messages - check for active jobs limit
                let errorMsg = errorData.error || errorData.message || 'Failed to create checkout session';
                if (response.status === 403) {
                  errorMsg = "You don't have permission to checkout this offer. Make sure you're logged in as the customer who posted this job.";
                } else if (response.status === 401) {
                  errorMsg = "Please log in to continue.";
                } else if (response.status === 400) {
                  // Check for active jobs limit error
                  if (errorData.error && errorData.error.includes('active jobs') || 
                      errorData.currentActiveJobs !== undefined) {
                    // Show special popup for active jobs limit
                    overlay.remove();
                    document.body.style.overflow = "";
                    showActiveJobsLimitModal(errorData.currentActiveJobs || 2, errorData.maxActiveJobs || 2);
                    return;
                  }
                  errorMsg = errorData.message || errorData.error || "Invalid request. The offer may have already been accepted or declined.";
                } else if (response.status === 500) {
                  errorMsg = "Server error. Please check the console for details and try again.";
                  console.error("Server error details:", errorData);
                }
                
                showToast("Error: " + errorMsg);
                payBtn.disabled = false;
                payBtn.textContent = offerId ? `Pay $${total.toFixed(2)} & Accept` : `Pay $${total.toFixed(2)}`;
                return;
              }
              
              const data = await response.json();
              if (data.url) {
                // Redirect to Stripe checkout
                window.location.href = data.url;
              } else {
                throw new Error('No checkout URL received');
              }
            } else {
              // Otherwise just process payment
              await window.hustlAPI.payments.confirm(jobId);
              showToast("Payment processed successfully!");
              overlay.remove();
              document.body.style.overflow = "";
              renderJobs();
            }
          } catch (error) {
            showToast("Error: " + (error.message || "Payment failed"));
            payBtn.disabled = false;
            payBtn.textContent = offerId ? `Pay $${total.toFixed(2)} & Accept` : `Pay $${total.toFixed(2)}`;
          }
        });
        content.appendChild(payBtn);
        
        // Close button
        const closeBtn = document.createElement("button");
        closeBtn.className = "btn outline";
        closeBtn.style.width = "100%";
        closeBtn.style.marginTop = "0.5rem";
        closeBtn.textContent = "Cancel";
        closeBtn.addEventListener("click", () => {
          overlay.remove();
          document.body.style.overflow = "";
        });
        content.appendChild(closeBtn);
        
        modal.appendChild(content);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.style.overflow = "hidden";
        
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            overlay.remove();
            document.body.style.overflow = "";
          }
        });
      } catch (error) {
        showToast("Error loading payment: " + (error.message || "Unknown error"));
      }
    }

    // Show active jobs limit modal (when hustler has 2 active jobs)
    function showActiveJobsLimitModal(currentActive, maxActive) {
      const overlay = document.createElement("div");
      overlay.style.position = "fixed";
      overlay.style.inset = "0";
      overlay.style.background = "rgba(15,23,42,0.75)";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.zIndex = "10000";
      overlay.style.padding = "1rem";
      
      const modal = document.createElement("div");
      modal.style.background = "white";
      modal.style.borderRadius = "16px";
      modal.style.padding = "2rem";
      modal.style.maxWidth = "500px";
      modal.style.width = "100%";
      modal.style.boxShadow = "0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04)";
      
      modal.innerHTML = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
          <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
          <h2 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">
            Active Jobs Limit Reached
          </h2>
          <p style="font-size: 1rem; color: #6b7280; line-height: 1.5;">
            You already have ${currentActive} active job${currentActive !== 1 ? 's' : ''}. Complete one to take another.
          </p>
        </div>
        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
          <div style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">üí° How to continue:</div>
          <ul style="text-align: left; color: #78350f; margin: 0; padding-left: 1.25rem; line-height: 1.6;">
            <li>Go to your profile and find your active jobs</li>
            <li>Complete one of your current jobs</li>
            <li>Once completed and paid, you can accept new jobs</li>
          </ul>
        </div>
        <button id="activeJobsLimitCloseBtn" class="btn btn-primary" style="width: 100%; min-height: 48px; font-size: 1rem; font-weight: 600;">
          Got it
        </button>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      document.body.style.overflow = "hidden";
      
      const closeBtn = modal.querySelector('#activeJobsLimitCloseBtn');
      const closeModal = () => {
        overlay.remove();
        document.body.style.overflow = "";
        // Redirect to profile to see active jobs
        setView('profile');
      };
      
      closeBtn.addEventListener('click', closeModal);
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal();
      });
    }

   
    /* ---------- Messages view ---------- */

    // Track last viewed timestamp per thread to determine unread messages
    function getLastViewedTimestamp(threadId) {
      const key = `lastViewed_${threadId}`;
      const timestamp = localStorage.getItem(key);
      return timestamp ? parseInt(timestamp, 10) : 0;
    }

    function setLastViewedTimestamp(threadId) {
      const key = `lastViewed_${threadId}`;
      localStorage.setItem(key, Date.now().toString());
    }

    // Count conversations with unread messages (optimized - loads messages in parallel)
    async function countUnreadMessages() {
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          updateMessageBadge(0);
          return;
        }

        const threads = await window.hustlAPI.messages.getThreads();
        
        // Filter out deleted conversations immediately
        const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
        const activeThreads = threads.filter(t => !deleted.includes(t.jobId));
        
        // Load messages for all threads in parallel (much faster)
        const messagePromises = activeThreads.map(thread => 
          window.hustlAPI.messages.getMessages(thread.id).catch(() => [])
        );
        
        const allMessagesArrays = await Promise.all(messagePromises);
        
        let conversationsWithUnread = 0;

        activeThreads.forEach((thread, index) => {
          const messages = allMessagesArrays[index] || [];
          const lastViewed = getLastViewedTimestamp(thread.id);
          
          // Check if this conversation has any unread messages
          const hasUnread = messages.some(m => {
            const isFromMe = m.senderId === user.id || (m.sender && m.sender.id === user.id);
            if (isFromMe) return false; // Don't count own messages
            
            const messageTime = m.createdAt ? new Date(m.createdAt).getTime() : 0;
            return messageTime > lastViewed;
          });

          if (hasUnread) {
            conversationsWithUnread++;
          }
        });

        updateMessageBadge(conversationsWithUnread);
      } catch (error) {
        console.error("Error counting unread messages:", error);
        updateMessageBadge(0);
      }
    }
    
    // Get unread count for a specific thread
    async function getUnreadCountForThread(threadId, userId) {
      try {
        const lastViewed = getLastViewedTimestamp(threadId);
        const messages = await window.hustlAPI.messages.getMessages(threadId);
        
        return messages.filter(m => {
          const isFromMe = m.senderId === userId || (m.sender && m.sender.id === userId);
          if (isFromMe) return false;
          const messageTime = m.createdAt ? new Date(m.createdAt).getTime() : 0;
          return messageTime > lastViewed;
        }).length;
      } catch (error) {
        console.error("Error getting unread count for thread:", error);
        return 0;
      }
    }

    // Update the badge on Messages tab
    function updateMessageBadge(count) {
      const desktopTab = document.querySelector('.nav-tab[data-view="messages"]');
      const mobileTab = document.querySelector('.mobile-menu-item[data-view="messages"]');
      
      if (desktopTab) {
        desktopTab.setAttribute('data-badge-count', count);
      }
      if (mobileTab) {
        mobileTab.setAttribute('data-badge-count', count);
      }
    }

    async function renderMessagesView() {
      const user = await window.hustlAPI.auth.getCurrentUser();
      const convList = document.getElementById("conversationList");
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      if (!convList) return;
      
      // Setup archive/delete view toggles
      const showArchivedBtn = document.getElementById("showArchivedBtn");
      const showDeletedBtn = document.getElementById("showDeletedBtn");
      if (showArchivedBtn) {
        showArchivedBtn.onclick = () => {
          showArchivedConversations = !showArchivedConversations;
          showDeletedConversations = false;
          showArchivedBtn.textContent = showArchivedConversations ? "üì¶ Hide Archived" : "üì¶ Show Archived";
          showArchivedBtn.style.background = showArchivedConversations ? "#dbeafe" : "#f3f4f6";
          showArchivedBtn.style.color = showArchivedConversations ? "#1e40af" : "#6b7280";
          if (showDeletedBtn) {
            showDeletedBtn.textContent = "üóë Show Deleted";
            showDeletedBtn.style.background = "#fee2e2";
            showDeletedBtn.style.color = "#991b1b";
          }
          renderMessagesView();
        };
      }
      if (showDeletedBtn) {
        showDeletedBtn.onclick = () => {
          showDeletedConversations = !showDeletedConversations;
          showArchivedConversations = false;
          showDeletedBtn.textContent = showDeletedConversations ? "üóë Hide Deleted" : "üóë Show Deleted";
          showDeletedBtn.style.background = showDeletedConversations ? "#fecaca" : "#fee2e2";
          showDeletedBtn.style.color = "#991b1b";
          if (showArchivedBtn) {
            showArchivedBtn.textContent = "üì¶ Show Archived";
            showArchivedBtn.style.background = "#f3f4f6";
            showArchivedBtn.style.color = "#6b7280";
          }
          renderMessagesView();
        };
      }

      // Not logged in: nothing to show
      if (!user) {
        convList.innerHTML =
          "<div class='muted'>Log in to see your job conversations.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        return;
      }

      // Load jobs from API
      // For messages, we need all jobs, so we'll fetch multiple pages if needed
      let allJobs = [];
      try {
        // Fetch first page with a larger limit to get more jobs at once
        let response = await window.hustlAPI.jobs.list({ page: 1, limit: 100 });
        
        // Handle paginated response
        if (response && typeof response === 'object' && 'jobs' in response) {
          allJobs = response.jobs || [];
          
          // If there are more pages, fetch them (up to a reasonable limit)
          if (response.pagination && response.pagination.hasMore) {
            let currentPage = 2;
            const maxPages = 10; // Limit to prevent infinite loops
            
            while (currentPage <= maxPages) {
              try {
                const nextResponse = await window.hustlAPI.jobs.list({ page: currentPage, limit: 100 });
                if (nextResponse && typeof nextResponse === 'object' && 'jobs' in nextResponse) {
                  allJobs = allJobs.concat(nextResponse.jobs || []);
                  if (!nextResponse.pagination || !nextResponse.pagination.hasMore) {
                    break;
                  }
                } else {
                  break;
                }
              } catch (pageError) {
                console.error(`Error loading page ${currentPage} for messages:`, pageError);
                break;
              }
              currentPage++;
            }
          }
        } else if (Array.isArray(response)) {
          // Fallback: if API returns array directly (old format)
          allJobs = response;
        }
        
        // Ensure allJobs is always an array
        if (!Array.isArray(allJobs)) {
          console.warn("jobs.list() did not return an array, defaulting to empty array");
          allJobs = [];
        }
      } catch (error) {
        console.error("Error loading jobs for messages:", error);
        allJobs = []; // Ensure it's always an array
      }

      // Get threads from API
      let threads = [];
      try {
        threads = await window.hustlAPI.messages.getThreads();
      } catch (error) {
        console.error("Error loading threads:", error);
      }

      // Get offers to find jobs where hustler applied (even if not accepted yet)
      // OPTIMIZED: Load offers in parallel instead of sequentially
      let allOffers = [];
      try {
        // Filter jobs that might have offers (only jobs where user is customer or hustler)
        const relevantJobs = allJobs.filter(j => j.customerId === user.id || j.hustlerId === user.id);
        
        // Load all offers in parallel (much faster)
        const offerPromises = relevantJobs.map(job => 
          window.hustlAPI.offers.list(job.id)
            .then(offers => offers.map(o => ({ ...o, jobId: job.id })))
            .catch(() => []) // Ignore errors for jobs we can't access offers for
        );
        
        const offerArrays = await Promise.all(offerPromises);
        allOffers = offerArrays.flat(); // Flatten all offers into single array
      } catch (error) {
        console.error("Error loading offers for messages:", error);
      }

      // Filter archived and deleted conversations based on view mode
      const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
      const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
      
      // Jobs that have threads OR have offers (hustler applied) OR are assigned
      // This includes jobs where hustler applied but not yet accepted, and assigned jobs
      const jobsWithThreads = allJobs.filter((j) => {
        // Show/hide based on view mode
        if (showArchivedConversations) {
          // Only show archived
          return archived.includes(j.id) && !deleted.includes(j.id);
        } else if (showDeletedConversations) {
          // Only show deleted
          return deleted.includes(j.id);
        } else {
          // Normal view - hide archived and deleted
          if (archived.includes(j.id) || deleted.includes(j.id)) {
            return false;
          }
        }
        // Jobs where user is customer and hustler applied (has offers) OR is assigned
        if (j.customerId === user.id) {
          const hasOffers = allOffers.some(o => o.jobId === j.id);
          const isAssigned = j.hustlerId && (j.status === "ASSIGNED" || j.status === "PAID" || j.status === "COMPLETED_BY_HUSTLER" || j.status === "AWAITING_CUSTOMER_CONFIRM");
          return hasOffers || isAssigned; // Show if has offers OR is assigned/paid
        }
        // Jobs where user is hustler and they applied or were accepted
        if (j.hustlerId === user.id) {
          return true; // Show all assigned jobs for hustler
        }
        // Check if user has an offer for this job (hustler applied)
        const userOffer = allOffers.find(o => o.jobId === j.id && o.hustlerId === user.id);
        return !!userOffer; // Show if user applied
      });

      convList.innerHTML = "";

      if (jobsWithThreads.length === 0) {
        convList.innerHTML =
          "<div class='muted' style='padding: 2rem; text-align: center;'>No conversations yet.<br><small style='font-size: 0.85rem; color: #9ca3af; margin-top: 0.5rem; display: block;'>Start a conversation by applying to a job or posting one.</small></div>";
        if (convTitle) convTitle.textContent = "Select a conversation";
        if (convSummary) convSummary.textContent = "";
        if (convMessages) convMessages.innerHTML = "";
        activeConversationJobId = null;
        return;
      }

      // If nothing is selected yet, auto-open the first job
      if (!activeConversationJobId) {
        activeConversationJobId = jobsWithThreads[0].id;
      }

      // Fetch full job details for each job to get customer/hustler info
      const jobsWithDetails = await Promise.all(
        jobsWithThreads.map(async (job) => {
          try {
            const fullJob = await window.hustlAPI.jobs.get(job.id);
            return fullJob || job;
          } catch (error) {
            console.error(`Error fetching job ${job.id}:`, error);
            return job;
          }
        })
      );

      // Show applications quick access for customers
      const applicationsSection = document.getElementById("applicationsQuickAccess");
      const applicationsList = document.getElementById("applicationsQuickList");
      if (applicationsSection && applicationsList && userMode === "customer") {
        const openJobsWithApplications = jobsWithDetails.filter(j => 
          j.status === "OPEN" && 
          j.customerId === user.id && 
          !j.hustlerId &&
          allOffers.some(o => o.jobId === j.id)
        );
        
        if (openJobsWithApplications.length > 0) {
          applicationsSection.style.display = "block";
          applicationsList.innerHTML = "";
          
          openJobsWithApplications.forEach(job => {
            const jobOffers = allOffers.filter(o => o.jobId === job.id);
            const item = document.createElement("div");
            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.style.alignItems = "center";
            item.style.padding = "0.5rem";
            item.style.marginBottom = "0.25rem";
            item.style.background = "rgba(255,255,255,0.6)";
            item.style.borderRadius = "6px";
            item.style.cursor = "pointer";
            
            const left = document.createElement("div");
            left.style.flex = "1";
            const jobTitle = document.createElement("div");
            jobTitle.style.fontWeight = "600";
            jobTitle.textContent = job.title;
            left.appendChild(jobTitle);
            const countText = document.createElement("div");
            countText.style.fontSize = "0.8rem";
            countText.style.color = "#92400e";
            countText.textContent = `${jobOffers.length} ${jobOffers.length === 1 ? 'application' : 'applications'}`;
            left.appendChild(countText);
            item.appendChild(left);
            
            const viewBtn = document.createElement("button");
            viewBtn.className = "small-btn";
            viewBtn.style.background = "#92400e";
            viewBtn.style.color = "#fff";
            viewBtn.style.padding = "0.35rem 0.75rem";
            viewBtn.style.fontSize = "0.8rem";
            viewBtn.textContent = "View";
            viewBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              setView("jobs");
              setTimeout(() => openJobDetails(job.id), 100);
            });
            item.appendChild(viewBtn);
            
            item.addEventListener("click", () => {
              setView("jobs");
              setTimeout(() => openJobDetails(job.id), 100);
            });
            
            applicationsList.appendChild(item);
          });
        } else {
          applicationsSection.style.display = "none";
        }
      } else if (applicationsSection) {
        applicationsSection.style.display = "none";
      }

      // Check unread status for each conversation
      const conversationsWithUnreadInfo = await Promise.all(
        jobsWithDetails.map(async (job) => {
          const thread = threads.find(t => t.jobId === job.id);
          let unreadCount = 0;
          let hasUnread = false;
          
          if (thread) {
            unreadCount = await getUnreadCountForThread(thread.id, user.id);
            hasUnread = unreadCount > 0;
          }
          
          return { job, unreadCount, hasUnread };
        })
      );

      conversationsWithUnreadInfo.forEach(({ job, unreadCount, hasUnread }) => {
        // Determine the other person
        const otherId = job.customerId === user.id ? job.hustlerId : job.customerId;
        let otherUser = job.customerId === user.id ? job.hustler : job.customer;
        
        // If still no user data, try thread data
        if (!otherUser && otherId) {
          const thread = threads.find(t => t.jobId === job.id);
          if (thread) {
            otherUser = job.customerId === user.id ? thread.userB : thread.userA;
          }
        }

        const item = document.createElement("div");
        item.className = "job-card";
        item.style.cursor = "pointer";
        item.dataset.jobId = job.id;

        // Highlight the active conversation
        if (job.id === activeConversationJobId) {
          item.style.borderColor = "#2563eb";
          item.style.boxShadow = "0 0 0 1px #2563eb20";
        }

        const top = document.createElement("div");
        top.className = "job-card-top";

        const title = document.createElement("div");
        title.className = "job-title";
        title.textContent = job.title;
        top.appendChild(title);

        const status = document.createElement("span");
        status.className = "badge";
        const jobStatus = (job.status || "OPEN").toUpperCase();
        if (jobStatus === "OPEN") {
          status.classList.add("status-open");
          status.textContent = "Open";
        } else if (jobStatus === "ASSIGNED") {
          status.classList.add("status-assigned");
          status.textContent = "Assigned";
        } else {
          status.classList.add("status-completed");
          status.textContent = "Completed";
        }
        top.appendChild(status);
        item.appendChild(top);

        const meta = document.createElement("div");
        meta.className = "job-meta";
        const otherName = otherUser?.name || otherUser?.username || "User";
        const createdDate = job.createdAt ? new Date(job.createdAt).getTime() : Date.now();
        
        // Show "With [Other User's Name]" or "X applied" status
        let metaText = `With ${otherName}`;
        
        // If job is open and user is customer, show "X applied" instead
        if (job.status === "OPEN" && job.customerId === user.id && !job.hustlerId) {
          const jobOffers = allOffers.filter(o => o.jobId === job.id);
          if (jobOffers.length > 0) {
            const hustlerName = jobOffers[0].hustler?.name || jobOffers[0].hustler?.username || "Hustler";
            metaText = `${hustlerName} applied`;
          }
        }
        
        // Add "New message" indicator if there are unread messages
        if (hasUnread) {
          metaText += ` ¬∑ <span style="color: #ef4444; font-weight: 600;">New message</span>`;
        }
        
        meta.innerHTML = `${metaText} ¬∑ ${timeAgo(createdDate)}`;
        item.appendChild(meta);

        // Archive/Delete buttons
        const actionsRow = document.createElement("div");
        actionsRow.style.display = "flex";
        actionsRow.style.gap = "0.5rem";
        actionsRow.style.marginTop = "0.5rem";
        actionsRow.style.justifyContent = "flex-end";
        
        // Archive/Unarchive button
        const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
        const isArchived = archived.includes(job.id);
        const archiveBtn = document.createElement("button");
        archiveBtn.className = "small-btn";
        archiveBtn.style.background = isArchived ? "#dbeafe" : "#f3f4f6";
        archiveBtn.style.color = isArchived ? "#1e40af" : "#6b7280";
        archiveBtn.style.padding = "0.25rem 0.5rem";
        archiveBtn.style.fontSize = "0.75rem";
        archiveBtn.textContent = isArchived ? "üì¶ Unarchive" : "üì¶ Archive";
        archiveBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const archived = JSON.parse(localStorage.getItem("archivedConversations") || "[]");
          if (isArchived) {
            const index = archived.indexOf(job.id);
            if (index > -1) {
              archived.splice(index, 1);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation unarchived");
              renderMessagesView();
            }
          } else {
            if (!archived.includes(job.id)) {
              archived.push(job.id);
              localStorage.setItem("archivedConversations", JSON.stringify(archived));
              showToast("Conversation archived");
              renderMessagesView();
            }
          }
        });
        actionsRow.appendChild(archiveBtn);
        
        // Delete/Restore button (available for all jobs)
        const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
        const isDeleted = deleted.includes(job.id);
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "small-btn";
        deleteBtn.style.background = isDeleted ? "#fecaca" : "#fee2e2";
        deleteBtn.style.color = "#991b1b";
        deleteBtn.style.padding = "0.25rem 0.5rem";
        deleteBtn.style.fontSize = "0.75rem";
        deleteBtn.textContent = isDeleted ? "‚Ü© Restore" : "üóë Delete";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const deleted = JSON.parse(localStorage.getItem("deletedConversations") || "[]");
          if (isDeleted) {
            const index = deleted.indexOf(job.id);
            if (index > -1) {
              deleted.splice(index, 1);
              localStorage.setItem("deletedConversations", JSON.stringify(deleted));
              showToast("Conversation restored");
              // Update notification count after restoration
              countUnreadMessages();
              renderMessagesView();
            }
          } else {
            if (confirm("Delete this conversation? This will hide it from your messages list. You can restore it later.")) {
              if (!deleted.includes(job.id)) {
                deleted.push(job.id);
                localStorage.setItem("deletedConversations", JSON.stringify(deleted));
                showToast("Conversation deleted");
                // Update notification count after deletion
                countUnreadMessages();
                renderMessagesView();
              }
            }
          }
        });
        actionsRow.appendChild(deleteBtn);
        
        item.appendChild(actionsRow);

        item.addEventListener("click", () => {
          activeConversationJobId = job.id;
          // On mobile, switch to conversation view
          const isMobile = window.innerWidth <= 768;
          if (isMobile) {
            const messagesView = document.getElementById("view-messages");
            if (messagesView) {
              messagesView.classList.add("mobile-conversation-open");
            }
          }
          // Re-render list (to update highlight) + right-hand chat
          renderMessagesView();
        });

        convList.appendChild(item);
      });

      // Finally, render the messages for the active conversation
      renderConversation();
      
      // Re-initialize conversation input (in case it was re-rendered)
      initConversationInput();
      
      // Update unread count after rendering messages view
      countUnreadMessages();
    }



    async function renderConversation() {
      const user = await window.hustlAPI.auth.getCurrentUser();
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      
      if (!activeConversationJobId || !user) {
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        return;
      }

      // Fetch job details
      let job;
      try {
        job = await window.hustlAPI.jobs.get(activeConversationJobId);
      } catch (error) {
        console.error("Error loading job:", error);
        convTitle.textContent = "Error loading conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        return;
      }

      if (!job) {
        convTitle.textContent = "Job not found";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        return;
      }

      convTitle.textContent = job.title;
      
      // Build summary with clickable job link
      const categoryEmoji = {
        moving: "üöö",
        yard: "üåø",
        cleaning: "üßπ",
        furniture: "üõ†",
        handyman: "üîß",
        painting: "üé®",
        landscaping: "üå≥",
        petcare: "üêï",
        event: "üéâ",
        tech: "üíª",
      };
      const catText = categoryEmoji[job.category] || "‚≠ê";
      const payText = job.payType === "flat" 
        ? `$${(Number(job.amount) || 0).toFixed(2)} flat`
        : `$${(Number(job.hourlyRate) || 0).toFixed(2)}/hr ¬∑ max ${job.estHours || 0}h`;
      
      // Create clickable job summary
      convSummary.innerHTML = `
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
          <span>${catText} ${job.category || "other"} ¬∑ ${payText}</span>
          <button class="small-btn" style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; font-size: 0.75rem; border: none; border-radius: 4px; cursor: pointer;" id="viewJobFromMessagesBtn">
            üìã View Job
          </button>
        </div>
      `;
      
      // Add click handler for view job button
      const viewJobBtn = document.getElementById("viewJobFromMessagesBtn");
      if (viewJobBtn) {
        viewJobBtn.addEventListener("click", () => {
          // Close messages view and open job details
          setView("jobs");
          setTimeout(() => {
            openJobDetails(activeConversationJobId);
          }, 100);
        });
      }

      // Fetch messages from thread
      convMessages.innerHTML = "<div class='muted'>Loading messages...</div>";
      
      let messages = [];
      try {
        // Find thread for this job
        const threads = await window.hustlAPI.messages.getThreads();
        const thread = threads.find(t => t.jobId === activeConversationJobId);
        
        if (thread) {
          messages = await window.hustlAPI.messages.getMessages(thread.id);
        }
      } catch (error) {
        console.error("Error loading messages:", error);
      }

      convMessages.innerHTML = "";

      // Add payment reminder banner if job is not paid yet
      const isCustomer = job.customerId === user.id;
      const jobDate = job.date ? new Date(job.date) : null;
      const isJobDateApproaching = jobDate && jobDate.getTime() < Date.now() + (24 * 60 * 60 * 1000); // Within 24 hours
      
      // Check if payment is completed (job status would be ASSIGNED or later if paid)
      const needsPayment = job.status === "OPEN" || (job.status === "ASSIGNED" && !job.payment);
      
      if (needsPayment && job.hustlerId) {
        const paymentBanner = document.createElement("div");
        paymentBanner.style.padding = "0.75rem";
        paymentBanner.style.marginBottom = "1rem";
        paymentBanner.style.borderRadius = "6px";
        paymentBanner.style.background = isJobDateApproaching ? "#fef3c7" : "#eff6ff";
        paymentBanner.style.border = `1px solid ${isJobDateApproaching ? "#fbbf24" : "#bfdbfe"}`;
        paymentBanner.style.fontSize = "0.9rem";
        
        if (isCustomer) {
          paymentBanner.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">üí∞ Payment Required</div>
            <div>${isJobDateApproaching ? "‚ö†Ô∏è " : ""}Payment must be completed before the job date. <strong>Complete payment to secure your hustler.</strong></div>
          `;
        } else {
          paymentBanner.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.25rem;">üí∞ Payment Status</div>
            <div>${isJobDateApproaching ? "‚ö†Ô∏è " : ""}Payment must be completed by the customer before the job date. You'll receive payment after the job is completed.</div>
          `;
        }
        convMessages.appendChild(paymentBanner);
      }

      if (messages.length === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.style.padding = "1rem";
        empty.textContent = "No messages yet. Start the conversation!";
        convMessages.appendChild(empty);
      } else {
        messages.forEach((m) => {
          const isMe = m.senderId === user.id || (m.sender && m.sender.id === user.id);
          
          // Create message row (like iMessage/WhatsApp)
          const messageRow = document.createElement("div");
          messageRow.style.cssText = `
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-direction: ${isMe ? 'row-reverse' : 'row'};
            max-width: 85%;
            ${isMe ? 'margin-left: auto;' : 'margin-right: auto;'}
          `;
          
          // Get sender user for photo
          let senderUser = null;
          if (isMe) {
            senderUser = user;
          } else if (job.customerId === m.senderId) {
            senderUser = job.customer;
          } else if (job.hustlerId === m.senderId) {
            senderUser = job.hustler;
          }
          
          if (!senderUser && m.senderId) {
            senderUser = m.sender || null;
          }
          
          // Profile photo (show for received messages, or both on desktop)
          if (!isMe || window.innerWidth > 768) {
            const messagePhoto = document.createElement("div");
            messagePhoto.style.cssText = `
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: var(--primary-soft);
              border: 2px solid var(--border);
              display: flex;
              align-items: center;
              justify-content: center;
              color: var(--primary);
              font-weight: 600;
              font-size: 0.75rem;
              flex-shrink: 0;
              overflow: hidden;
            `;
            
            if (senderUser && typeof getProfilePhoto === 'function') {
              const photo = getProfilePhoto(senderUser, 'small');
              if (photo) {
                messagePhoto.appendChild(photo.cloneNode(true));
              } else {
                const name = senderUser.name || senderUser.username || 'U';
                messagePhoto.textContent = name.charAt(0).toUpperCase();
              }
            } else {
              const senderName = (m.sender?.name || m.sender?.username || 'User');
              messagePhoto.textContent = senderName.charAt(0).toUpperCase();
            }
            
            messageRow.appendChild(messagePhoto);
          }
          
          // Message bubble wrapper (bubble + timestamp)
          const bubbleWrapper = document.createElement("div");
          bubbleWrapper.style.cssText = `
            display: flex;
            flex-direction: column;
            align-items: ${isMe ? 'flex-end' : 'flex-start'};
            flex: 1;
            min-width: 0;
          `;
          
          // Message bubble (like normal text message)
          const messageBubble = document.createElement("div");
          messageBubble.style.cssText = `
            padding: 0.625rem 0.875rem;
            border-radius: ${isMe ? '18px 18px 4px 18px' : '18px 18px 18px 4px'};
            max-width: 100%;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
            font-size: 0.95rem;
            ${isMe 
              ? 'background: var(--primary); color: white;' 
              : 'background: #e5e7eb; color: var(--text-main);'
            }
          `;
          messageBubble.textContent = m.body || m.text || "";
          bubbleWrapper.appendChild(messageBubble);
          
          // Timestamp (small, below message)
          const timestamp = document.createElement("div");
          timestamp.style.cssText = `
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            padding: 0 0.5rem;
          `;
          timestamp.textContent = timeAgo(m.createdAt ? new Date(m.createdAt).getTime() : Date.now());
          bubbleWrapper.appendChild(timestamp);
          
          messageRow.appendChild(bubbleWrapper);
          convMessages.appendChild(messageRow);
        });
      }
      
      // Only auto-scroll on desktop, not mobile (to prevent annoying scroll to bottom)
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) {
        convMessages.scrollTop = convMessages.scrollHeight;
      } else {
        // On mobile, scroll to top or stay where user was
        // Only scroll to bottom if user explicitly sent a message
        const shouldScrollToBottom = convMessages.dataset.shouldScroll === "true";
        if (shouldScrollToBottom) {
          setTimeout(() => {
            convMessages.scrollTop = convMessages.scrollHeight;
            convMessages.dataset.shouldScroll = "false";
          }, 100);
        }
      }
      
      // Mark this thread as viewed (update last viewed timestamp)
      if (activeConversationJobId) {
        try {
          const threads = await window.hustlAPI.messages.getThreads();
          const thread = threads.find(t => t.jobId === activeConversationJobId);
          if (thread) {
            setLastViewedTimestamp(thread.id);
            // Update unread count after marking as read
            countUnreadMessages();
          }
        } catch (error) {
          console.error("Error marking thread as viewed:", error);
        }
      }
    }

    async function initConversationInput() {
      const sendBtn = document.getElementById("conversationSendButton");
      const input = document.getElementById("conversationInput");
      
      // Remove old listeners by cloning
      const newSendBtn = sendBtn.cloneNode(true);
      sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      
      newSendBtn.addEventListener("click", async () => {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        if (!activeConversationJobId) {
          showToast("Select a conversation first.");
          return;
        }
        
        const text = newInput.value.trim();
        if (!text) return;
        
        try {
          // Find thread for this job
          const threads = await window.hustlAPI.messages.getThreads();
          const thread = threads.find(t => t.jobId === activeConversationJobId);
          
          if (!thread) {
            showToast("Thread not found. The job may not be assigned yet.");
            return;
          }
          
          // Send message
          await window.hustlAPI.messages.sendMessage(thread.id, text);
          newInput.value = "";
          
          // Mark that we should scroll to bottom (user sent a message)
          const convMessages = document.getElementById("conversationMessages");
          if (convMessages) {
            convMessages.dataset.shouldScroll = "true";
          }
          
          // Refresh messages
          renderConversation();
          
          // Update unread count (in case recipient views it)
          countUnreadMessages();
        } catch (error) {
          showToast("Error sending message: " + (error.message || "Unknown error"));
        }
      });
      
      // Also send on Enter key
      newInput.addEventListener("keypress", async (e) => {
        if (e.key === "Enter") {
          newSendBtn.click();
        }
      });
    }

    /* ---------- Profile ---------- */

    async function renderProfile(userOverride = null) {
  // Use provided user or fetch from API
  let user = userOverride;
  if (!user) {
    user = await window.hustlAPI.auth.getCurrentUser();
  }
  
  const container = document.getElementById("profileContent");
  const jobsList = document.getElementById("profileJobsList");
  if (!container || !jobsList) return;

  if (!user) {
    container.innerHTML =
      "<div class='muted'>Log in to see your profile.</div>";
    jobsList.innerHTML = "";
    return;
  }

  // Load jobs from API - OPTIMIZED: Use /my-jobs endpoint (only fetches user's jobs, not all jobs!)
  let allJobs = [];
  try {
    // Use optimized endpoint that only returns jobs for this user (much faster with thousands of jobs!)
    if (window.hustlAPI.jobs.listMyJobs) {
      allJobs = await window.hustlAPI.jobs.listMyJobs({ limit: 100 });
      
      // Ensure it's an array
      if (!Array.isArray(allJobs)) {
        console.warn("jobs.listMyJobs() did not return an array, defaulting to empty array");
        allJobs = [];
      }
    } else {
      // Fallback: Use regular list with filters (less efficient but works)
      console.warn("listMyJobs not available, using fallback");
      const response = await window.hustlAPI.jobs.list({ page: 1, limit: 100 });
      if (response && typeof response === 'object' && 'jobs' in response) {
        allJobs = response.jobs || [];
      } else if (Array.isArray(response)) {
        allJobs = response;
      }
    }
  } catch (error) {
    console.error("Error loading jobs for profile:", error);
    allJobs = []; // Ensure it's always an array
  }

  // Filter jobs related to this user
  const activeJobs = allJobs.filter(
    (j) =>
      j.status !== "COMPLETED" &&
      j.status !== "CANCELLED" &&
      (j.customerId === user.id || j.hustlerId === user.id)
  );
  const completedJobs = allJobs.filter(
    (j) =>
      (j.status === "COMPLETED" || j.status === "PAID") &&
      (j.customerId === user.id || j.hustlerId === user.id)
  );

  const totalEarned = allJobs.reduce((sum, j) => {
    if (j.hustlerId === user.id && j.status === "PAID") {
      const amount = Number(j.amount) || 0;
      return sum + Math.round(amount * 0.85); // 85% after platform fee
    }
    return sum;
  }, 0);

  container.innerHTML = "";

  // Modern profile header with gradient
  const profileHeader = document.createElement("div");
  profileHeader.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
  profileHeader.style.borderRadius = "16px";
  profileHeader.style.padding = "2rem 1.5rem";
  profileHeader.style.marginBottom = "1.5rem";
  profileHeader.style.color = "white";
  profileHeader.style.textAlign = "center";
  profileHeader.style.position = "relative";

  const avatarWrapper = document.createElement("div");
  avatarWrapper.style.position = "relative";
  avatarWrapper.style.display = "inline-block";
  avatarWrapper.style.marginBottom = "1rem";

  const avatar = document.createElement("div");
  avatar.style.width = "100px";
  avatar.style.height = "100px";
  avatar.style.borderRadius = "50%";
  avatar.style.background = "rgba(255,255,255,0.2)";
  avatar.style.border = "4px solid rgba(255,255,255,0.3)";
  avatar.style.display = "flex";
  avatar.style.alignItems = "center";
  avatar.style.justifyContent = "center";
  avatar.style.fontSize = "2.5rem";
  avatar.style.fontWeight = "600";
  avatar.style.color = "white";
  avatar.style.margin = "0 auto";
  avatar.style.overflow = "hidden";
  
  // Display photo - prioritize photoUrl from API, fallback to avatarDataUrl
  // Add cache-busting query parameter to ensure fresh image loads after upload
  if (user.photoUrl) {
    const img = document.createElement("img");
    img.loading = "lazy"; // Lazy load profile photos
    // Add timestamp to force browser to reload image (cache busting)
    const separator = user.photoUrl.includes('?') ? '&' : '?';
    const photoUrlWithCacheBust = user.photoUrl + separator + '_cb=' + Date.now();
    img.src = photoUrlWithCacheBust;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    img.onerror = function() {
      // If image fails to load with cache bust, try original URL
      this.src = user.photoUrl;
    };
    avatar.appendChild(img);
  } else if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.loading = "lazy"; // Lazy load avatar
    img.src = user.avatarDataUrl;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  
  // Upload button overlay
  const uploadOverlay = document.createElement("div");
  uploadOverlay.style.position = "absolute";
  uploadOverlay.style.bottom = "0";
  uploadOverlay.style.right = "0";
  uploadOverlay.style.width = "36px";
  uploadOverlay.style.height = "36px";
  uploadOverlay.style.borderRadius = "50%";
  uploadOverlay.style.background = "#2563eb";
  uploadOverlay.style.border = "3px solid white";
  uploadOverlay.style.display = "flex";
  uploadOverlay.style.alignItems = "center";
  uploadOverlay.style.justifyContent = "center";
  uploadOverlay.style.cursor = "pointer";
  uploadOverlay.style.fontSize = "1.2rem";
  uploadOverlay.innerHTML = "üì∑";
  uploadOverlay.title = "Change photo";
  
  const hiddenFileInput = document.createElement("input");
  hiddenFileInput.id = "avatarUploadInput";
  hiddenFileInput.type = "file";
  hiddenFileInput.accept = "image/*";
  hiddenFileInput.style.display = "none";
  
  uploadOverlay.addEventListener("click", () => hiddenFileInput.click());
  avatarWrapper.appendChild(avatar);
  avatarWrapper.appendChild(uploadOverlay);
  avatarWrapper.appendChild(hiddenFileInput);
  profileHeader.appendChild(avatarWrapper);
  
  const nameEl = document.createElement("div");
  nameEl.style.fontSize = "1.5rem";
  nameEl.style.fontWeight = "700";
  nameEl.style.marginBottom = "0.25rem";
  nameEl.textContent = user.name || user.username || "User";
  profileHeader.appendChild(nameEl);
  
  const emailEl = document.createElement("div");
  emailEl.style.fontSize = "0.9rem";
  emailEl.style.opacity = "0.9";
  emailEl.textContent = user.email;
  profileHeader.appendChild(emailEl);
  
  const roles = user.roles || [];
  if (roles.length > 0) {
    const roleBadge = document.createElement("div");
    roleBadge.style.display = "inline-block";
    roleBadge.style.marginTop = "0.5rem";
    roleBadge.style.padding = "0.25rem 0.75rem";
    roleBadge.style.background = "rgba(255,255,255,0.2)";
    roleBadge.style.borderRadius = "12px";
    roleBadge.style.fontSize = "0.85rem";
    roleBadge.style.fontWeight = "500";
    roleBadge.textContent = roles[0];
    profileHeader.appendChild(roleBadge);
  }
  
  container.appendChild(profileHeader);

  // Profile completion reminder (for Hustlers)
  const hasHustlerRole = user.roles?.some(r => r.toUpperCase() === 'HUSTLER');
  const hasPhoto = !!(user.photoUrl || user.avatarDataUrl);
  const hasBio = !!(user.bio && user.bio.trim().length > 0);
  const hasZip = !!(user.zip && user.zip.trim().length === 5);
  const profileComplete = hasPhoto && hasBio && hasZip;
  
  if (hasHustlerRole && !profileComplete) {
    const reminderCard = document.createElement("div");
    reminderCard.style.background = "linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)";
    reminderCard.style.border = "2px solid #fbbf24";
    reminderCard.style.borderRadius = "12px";
    reminderCard.style.padding = "1.25rem";
    reminderCard.style.marginBottom = "1.5rem";
    reminderCard.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)";
    
    const reminderTitle = document.createElement("div");
    reminderTitle.style.fontSize = "1.1rem";
    reminderTitle.style.fontWeight = "700";
    reminderTitle.style.color = "#78350f";
    reminderTitle.style.marginBottom = "0.75rem";
    reminderTitle.innerHTML = "üí° Complete Your Profile to Get More Jobs!";
    reminderCard.appendChild(reminderTitle);
    
    const reminderList = document.createElement("div");
    reminderList.style.fontSize = "0.95rem";
    reminderList.style.color = "#92400e";
    reminderList.style.lineHeight = "1.7";
    
    const items = [];
    if (!hasPhoto) {
      items.push("üì∑ <strong>Add a profile photo</strong> - Customers are more likely to hire hustlers with photos");
    }
    if (!hasBio) {
      items.push("‚úçÔ∏è <strong>Write a bio</strong> - Tell customers about your experience, skills, and what jobs you like");
    }
    if (!hasZip) {
      items.push("üìç <strong>Set your location</strong> - Add your zip code so we can show you nearby jobs first");
    }
    
    if (items.length > 0) {
      reminderList.innerHTML = `
        <div style="margin-bottom: 0.5rem;"><strong>Complete these to increase your chances:</strong></div>
        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
          ${items.map(item => `<li style="margin-bottom: 0.4rem;">${item}</li>`).join('')}
        </ul>
        <div style="margin-top: 0.75rem; font-size: 0.9rem; font-weight: 600;">
          Studies show that hustlers with complete profiles get 3x more job offers!
        </div>
      `;
    }
    
    reminderCard.appendChild(reminderList);
    container.appendChild(reminderCard);
  }

  // Profile form section
  const formSection = document.createElement("div");
  formSection.style.background = "white";
  formSection.style.borderRadius = "12px";
  formSection.style.padding = "1.5rem";
  formSection.style.marginBottom = "1rem";
  formSection.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)";
  
  // Name field
  const nameField = document.createElement("div");
  nameField.style.marginBottom = "1.25rem";
  const nameLabel = document.createElement("label");
  nameLabel.style.display = "block";
  nameLabel.style.fontWeight = "600";
  nameLabel.style.marginBottom = "0.5rem";
  nameLabel.style.color = "#1f2937";
  nameLabel.textContent = "Name";
  nameField.appendChild(nameLabel);
  const nameInput = document.createElement("input");
  nameInput.id = "profileNameInput";
  nameInput.type = "text";
  nameInput.value = user.name || "";
  nameInput.style.width = "100%";
  nameInput.style.padding = "0.75rem";
  nameInput.style.border = "1px solid #e5e7eb";
  nameInput.style.borderRadius = "8px";
  nameInput.style.fontSize = "1rem";
  nameField.appendChild(nameInput);
  formSection.appendChild(nameField);
  
  // Gender field
  const genderField = document.createElement("div");
  genderField.style.marginBottom = "1.25rem";
  const genderLabel = document.createElement("label");
  genderLabel.style.display = "block";
  genderLabel.style.fontWeight = "600";
  genderLabel.style.marginBottom = "0.5rem";
  genderLabel.style.color = "#1f2937";
  genderLabel.textContent = "Gender";
  genderLabel.htmlFor = "profileGenderInput";
  genderField.appendChild(genderLabel);
  const genderSelect = document.createElement("select");
  genderSelect.id = "profileGenderInput";
  genderSelect.style.width = "100%";
  genderSelect.style.padding = "0.75rem";
  genderSelect.style.border = "1px solid #e5e7eb";
  genderSelect.style.borderRadius = "8px";
  genderSelect.style.fontSize = "1rem";
  genderSelect.style.fontFamily = "inherit";
  genderSelect.style.background = "white";
  const genderOptions = [
    { value: "", text: "Select..." },
    { value: "male", text: "Male" },
    { value: "female", text: "Female" },
    { value: "other", text: "Other" },
    { value: "prefer_not_to_say", text: "Prefer not to say" },
  ];
  genderOptions.forEach(opt => {
    const option = document.createElement("option");
    option.value = opt.value;
    option.textContent = opt.text;
    if (user.gender === opt.value) option.selected = true;
    genderSelect.appendChild(option);
  });
  genderField.appendChild(genderSelect);
  formSection.appendChild(genderField);
  
  // Location/Zipcode field (for default location filtering)
  const locationField = document.createElement("div");
  locationField.style.marginBottom = "1.25rem";
  const locationLabel = document.createElement("label");
  locationLabel.style.display = "block";
  locationLabel.style.fontWeight = "600";
  locationLabel.style.marginBottom = "0.5rem";
  locationLabel.style.color = "#1f2937";
  locationLabel.textContent = "üìç Your Location (Zip Code)";
  locationLabel.htmlFor = "profileZipInput";
  locationField.appendChild(locationLabel);
  const locationHelper = document.createElement("div");
  locationHelper.style.fontSize = "0.85rem";
  locationHelper.style.color = "#6b7280";
  locationHelper.style.marginBottom = "0.5rem";
  locationHelper.style.lineHeight = "1.5";
  locationHelper.innerHTML = `
    <div style="margin-bottom: 0.25rem;">This helps us show you nearby jobs first. Your zip code is used as the default location for job filtering.</div>
    <div style="color: #059669; font-weight: 500;">‚úì Make sure your zip code is accurate for the best job matches!</div>
  `;
  locationField.appendChild(locationHelper);
  const zipInput = document.createElement("input");
  zipInput.id = "profileZipInput";
  zipInput.type = "text";
  zipInput.placeholder = "37011";
  zipInput.maxLength = 5;
  zipInput.pattern = "[0-9]{5}";
  zipInput.style.width = "100%";
  zipInput.style.padding = "0.75rem";
  zipInput.style.border = "1px solid #e5e7eb";
  zipInput.style.borderRadius = "8px";
  zipInput.style.fontSize = "1rem";
  zipInput.style.fontFamily = "inherit";
  zipInput.value = user.zip || "";
  locationField.appendChild(zipInput);
  formSection.appendChild(locationField);
  
  // Bio field
  const bioField = document.createElement("div");
  bioField.style.marginBottom = "1.25rem";
  const bioLabel = document.createElement("label");
  bioLabel.style.display = "block";
  bioLabel.style.fontWeight = "600";
  bioLabel.style.marginBottom = "0.5rem";
  bioLabel.style.color = "#1f2937";
  bioLabel.textContent = "About you";
  bioLabel.htmlFor = "profileBioInput";
  bioField.appendChild(bioLabel);
  const bioInput = document.createElement("textarea");
  bioInput.id = "profileBioInput";
  bioInput.placeholder = "Tell people a little about yourself. Jobs you like, if you have a truck, experience, etc.";
  bioInput.style.width = "100%";
  bioInput.style.minHeight = "100px";
  bioInput.style.padding = "0.75rem";
  bioInput.style.border = "1px solid #e5e7eb";
  bioInput.style.borderRadius = "8px";
  bioInput.style.fontSize = "0.95rem";
  bioInput.style.fontFamily = "inherit";
  bioInput.style.resize = "vertical";
  bioField.appendChild(bioInput);
  formSection.appendChild(bioField);
  
  // Save button with feedback
  const saveButtonWrapper = document.createElement("div");
  const saveBtn = document.createElement("button");
  saveBtn.id = "saveProfileButton";
  saveBtn.className = "btn btn-primary";
  saveBtn.style.width = "100%";
  saveBtn.style.minHeight = "48px";
  saveBtn.style.fontSize = "1rem";
  saveBtn.style.fontWeight = "600";
  saveBtn.textContent = "Save Profile";
  
  const saveStatus = document.createElement("div");
  saveStatus.id = "saveStatus";
  saveStatus.style.marginTop = "0.75rem";
  saveStatus.style.textAlign = "center";
  saveStatus.style.fontSize = "0.9rem";
  saveStatus.style.fontWeight = "500";
  saveStatus.style.minHeight = "1.5rem";
  
  saveButtonWrapper.appendChild(saveBtn);
  saveButtonWrapper.appendChild(saveStatus);
  formSection.appendChild(saveButtonWrapper);
  
  container.appendChild(formSection);
  
  // Prefill bio
  setTimeout(() => {
    if (bioInput) {
      bioInput.value = user.bio || "";
    }
  }, 0);
// --- Stripe Connect (for hustlers) ---
// hasHustlerRole already declared above for profile reminder card
if (hasHustlerRole) {
  const stripeConnectWrap = document.createElement("div");
  stripeConnectWrap.className = "field";
  stripeConnectWrap.style.marginTop = "0.6rem";
  stripeConnectWrap.style.padding = "1rem";
  stripeConnectWrap.style.background = "#f0f9ff";
  stripeConnectWrap.style.borderRadius = "8px";
  stripeConnectWrap.style.border = "1px solid #bae6fd";
  
  const stripeTitle = document.createElement("div");
  stripeTitle.style.fontWeight = "600";
  stripeTitle.style.marginBottom = "0.5rem";
  stripeTitle.textContent = "üí≥ Stripe Payment Setup";
  stripeConnectWrap.appendChild(stripeTitle);
  
  const stripeDesc = document.createElement("div");
  stripeDesc.style.fontSize = "0.9rem";
  stripeDesc.style.marginBottom = "1rem";
  stripeDesc.style.color = "#64748b";
  stripeDesc.innerHTML = "<strong>You must create and link your Stripe account to receive money.</strong> Connect your Stripe account to receive automatic payments. No more manual Venmo/Zelle transfers!";
  stripeConnectWrap.appendChild(stripeDesc);
  
  // Check Stripe status
  let stripeStatus = { connected: false };
  try {
    stripeStatus = await window.hustlAPI.stripeConnect.getStatus();
  } catch (error) {
    console.error("Error checking Stripe status:", error);
  }
  
  if (stripeStatus.connected) {
    const connectedMsg = document.createElement("div");
    connectedMsg.style.padding = "0.75rem";
    connectedMsg.style.background = "#dcfce7";
    connectedMsg.style.borderRadius = "6px";
    connectedMsg.style.marginBottom = "0.75rem";
    connectedMsg.style.border = "1px solid #86efac";
    connectedMsg.innerHTML = `
      <div style="font-weight: 600; color: #059669; margin-bottom: 0.25rem;">‚úì Stripe Account Connected</div>
      <div style="font-size: 0.85rem; color: #047857;">You'll receive payments automatically when jobs are completed.</div>
    `;
    stripeConnectWrap.appendChild(connectedMsg);
    
    const manageBtn = document.createElement("button");
    manageBtn.className = "btn outline";
    manageBtn.textContent = "Manage Stripe Account";
    manageBtn.addEventListener("click", async () => {
      try {
        const linkData = await window.hustlAPI.stripeConnect.getOnboardingLink();
        window.open(linkData.url, "_blank");
      } catch (error) {
        showToast("Error: " + (error.message || "Failed to get Stripe link"));
      }
    });
    stripeConnectWrap.appendChild(manageBtn);
  } else {
    const connectBtn = document.createElement("button");
    connectBtn.className = "btn btn-primary";
    connectBtn.textContent = "Connect Stripe Account";
    connectBtn.addEventListener("click", async () => {
      connectBtn.disabled = true;
      connectBtn.textContent = "Setting up...";
      
      try {
        // Create account if doesn't exist
        if (!stripeStatus.accountId) {
          await window.hustlAPI.stripeConnect.createAccount();
          // Wait a moment for the account to be saved
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Get onboarding link
        const linkData = await window.hustlAPI.stripeConnect.getOnboardingLink();
        
        // Open Stripe onboarding in new window
        window.open(linkData.url, "_blank");
        
        showToast("Opening Stripe setup. Complete the form to connect your account.");
        connectBtn.disabled = false;
        connectBtn.textContent = "Connect Stripe Account";
        
        // Refresh profile after a delay to check if connected
        setTimeout(() => {
          renderProfile();
        }, 3000);
      } catch (error) {
        console.error("Stripe Connect error:", error);
        let errorMsg = error.message || "Failed to connect Stripe";
        if (error.error === 'Forbidden' || error.message?.includes('hustler')) {
          errorMsg = "You must be a hustler to connect Stripe. Make sure you're logged in as a hustler.";
        } else if (error.error === 'Stripe account already connected') {
          errorMsg = "Stripe account already connected. Refreshing...";
          setTimeout(() => renderProfile(), 1000);
        }
        showToast("Error: " + errorMsg);
        connectBtn.disabled = false;
        connectBtn.textContent = "Connect Stripe Account";
      }
    });
    stripeConnectWrap.appendChild(connectBtn);
  }
  
  container.appendChild(stripeConnectWrap);
}

  // if user already has a bio, prefill
setTimeout(() => {
  const bioInput = document.getElementById("profileBioInput");
  if (bioInput) {
    bioInput.value = user.bio || "";
  }
}, 0);
  // stats row
  const statsRow = document.createElement("div");
  statsRow.className = "stat-row";

  const statActive = document.createElement("div");
  statActive.className = "stat-card";
  statActive.innerHTML =
    "<div class='stat-label'>Active jobs</div><div class='stat-value'>" +
    activeJobs.length +
    "</div><div class='linkish' id='activeJobsLink'>View</div>";
  statsRow.appendChild(statActive);

  const statCompleted = document.createElement("div");
  statCompleted.className = "stat-card";
  statCompleted.innerHTML =
    "<div class='stat-label'>Completed jobs</div><div class='stat-value'>" +
    completedJobs.length +
    "</div>";
  statsRow.appendChild(statCompleted);

  const statEarned = document.createElement("div");
  statEarned.className = "stat-card";
  statEarned.innerHTML =
    "<div class='stat-label'>Estimated total earned (as Hustler)</div><div class='stat-value'>" +
    formatMoney(totalEarned) +
    "</div>";
  statsRow.appendChild(statEarned);

  container.appendChild(statsRow);

  const note = document.createElement("div");
  note.className = "muted";
  note.textContent =
    "These estimates are based on your completed and paid jobs.";
  container.appendChild(note);

  // Reviews section (collapsible)
  const reviewsSection = document.createElement("div");
  reviewsSection.style.marginTop = "1.5rem";
  reviewsSection.style.marginBottom = "1rem";
  
  const reviewsHeader = document.createElement("div");
  reviewsHeader.style.display = "flex";
  reviewsHeader.style.alignItems = "center";
  reviewsHeader.style.justifyContent = "space-between";
  reviewsHeader.style.padding = "0.75rem 1rem";
  reviewsHeader.style.background = "#f9fafb";
  reviewsHeader.style.borderRadius = "8px";
  reviewsHeader.style.cursor = "pointer";
  reviewsHeader.style.userSelect = "none";
  reviewsHeader.style.border = "1px solid #e5e7eb";
  reviewsHeader.style.transition = "all 0.2s";
  
  const reviewsTitle = document.createElement("div");
  reviewsTitle.style.fontWeight = "600";
  reviewsTitle.style.color = "#1f2937";
  
  // Load reviews
  let userReviews = [];
  try {
    userReviews = await window.hustlAPI.reviews.getUserReviews(user.id);
  } catch (error) {
    console.error("Error loading reviews:", error);
  }
  
  reviewsTitle.textContent = `‚≠ê Reviews`;
  
  const reviewsCount = document.createElement("span");
  reviewsCount.textContent = `(${userReviews.length})`;
  reviewsCount.style.marginLeft = "0.5rem";
  reviewsCount.style.color = "#6b7280";
  reviewsCount.style.fontSize = "0.9rem";
  reviewsTitle.appendChild(reviewsCount);
  
  const reviewsArrow = document.createElement("span");
  reviewsArrow.textContent = "‚ñº";
  reviewsArrow.style.transition = "transform 0.2s";
  reviewsArrow.style.color = "#6b7280";
  
  reviewsHeader.appendChild(reviewsTitle);
  reviewsHeader.appendChild(reviewsArrow);
  
  const reviewsContent = document.createElement("div");
  reviewsContent.id = "reviewsContent";
  reviewsContent.style.display = "none";
  reviewsContent.style.marginTop = "0.5rem";
  reviewsContent.style.paddingLeft = "0.5rem";
  
  // Toggle function
  reviewsHeader.addEventListener("click", () => {
    const isOpen = reviewsContent.style.display !== "none";
    reviewsContent.style.display = isOpen ? "none" : "block";
    reviewsArrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
    reviewsHeader.style.background = isOpen ? "#f9fafb" : "#f3f4f6";
  });
  
  if (userReviews.length === 0) {
    const noReviews = document.createElement("div");
    noReviews.className = "muted";
    noReviews.style.padding = "0.75rem";
    noReviews.textContent = "No reviews yet.";
    reviewsContent.appendChild(noReviews);
  } else {
    userReviews.slice(0, 10).forEach(review => {
      const reviewCard = document.createElement("div");
      reviewCard.style.padding = "1rem";
      reviewCard.style.marginTop = "0.75rem";
      reviewCard.style.background = "#f9fafb";
      reviewCard.style.borderRadius = "8px";
      reviewCard.style.border = "1px solid var(--border)";
      
      const stars = "‚òÖ".repeat(review.stars) + "‚òÜ".repeat(5 - review.stars);
      reviewCard.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
          <div>
            <div style="font-weight: 600; margin-bottom: 0.25rem;">${review.reviewer.name}</div>
            <div style="color: #fbbf24; font-size: 0.9rem;">${stars}</div>
          </div>
          <div class="muted" style="font-size: 0.75rem;">${timeAgo(new Date(review.createdAt).getTime())}</div>
        </div>
        <div style="color: var(--text-main); line-height: 1.5;">${review.text}</div>
        ${review.job ? `<div class="muted" style="margin-top: 0.5rem; font-size: 0.8rem;">For: ${review.job.title}</div>` : ''}
      `;
      
      reviewsContent.appendChild(reviewCard);
    });
  }
  
  reviewsSection.appendChild(reviewsHeader);
  reviewsSection.appendChild(reviewsContent);
  container.appendChild(reviewsSection);

  // ----- RIGHT SIDE: JOBS -----
  jobsList.innerHTML = "";

  // A) Jobs you posted (collapsible)
  const postedSection = document.createElement("div");
  postedSection.style.marginBottom = "1rem";
  
  const postedHeader = document.createElement("div");
  postedHeader.style.display = "flex";
  postedHeader.style.alignItems = "center";
  postedHeader.style.justifyContent = "space-between";
  postedHeader.style.padding = "0.75rem 1rem";
  postedHeader.style.background = "#f9fafb";
  postedHeader.style.borderRadius = "8px";
  postedHeader.style.cursor = "pointer";
  postedHeader.style.userSelect = "none";
  postedHeader.style.border = "1px solid #e5e7eb";
  postedHeader.style.transition = "all 0.2s";
  
  const postedTitle = document.createElement("div");
  postedTitle.style.fontWeight = "600";
  postedTitle.style.color = "#1f2937";
  postedTitle.textContent = "üìù Jobs you posted";
  
  const postedCount = document.createElement("span");
  const myPostedJobs = allJobs.filter((j) => j.customerId === user.id)
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  postedCount.textContent = `(${myPostedJobs.length})`;
  postedCount.style.marginLeft = "0.5rem";
  postedCount.style.color = "#6b7280";
  postedCount.style.fontSize = "0.9rem";
  postedTitle.appendChild(postedCount);
  
  const postedArrow = document.createElement("span");
  postedArrow.textContent = "‚ñº";
  postedArrow.style.transition = "transform 0.2s";
  postedArrow.style.color = "#6b7280";
  
  postedHeader.appendChild(postedTitle);
  postedHeader.appendChild(postedArrow);
  
  const postedContent = document.createElement("div");
  postedContent.id = "postedJobsContent";
  postedContent.style.display = "none";
  postedContent.style.marginTop = "0.5rem";
  postedContent.style.paddingLeft = "0.5rem";
  
  // Toggle function
  postedHeader.addEventListener("click", () => {
    const isOpen = postedContent.style.display !== "none";
    postedContent.style.display = isOpen ? "none" : "block";
    postedArrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
    postedHeader.style.background = isOpen ? "#f9fafb" : "#f3f4f6";
  });
  
  // Filter out COMPLETED jobs from posted jobs (they're done and reviewed)
  const activePostedJobs = myPostedJobs.filter((j) => {
    const status = (j.status || "").toUpperCase();
    return status !== "COMPLETED";
  });
  
  const limitedPostedJobs = activePostedJobs.slice(0, 10);
  if (limitedPostedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.padding = "0.75rem";
    empty.textContent = "You haven't posted any jobs yet.";
    postedContent.appendChild(empty);
  } else {
    limitedPostedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;
      card.style.marginBottom = "0.5rem";

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You posted this ¬∑ " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      postedContent.appendChild(card);
    });
  }
  
  postedSection.appendChild(postedHeader);
  postedSection.appendChild(postedContent);
  jobsList.appendChild(postedSection);

  // B) Jobs you're doing as a Hustler (collapsible)
  const doingSection = document.createElement("div");
  doingSection.style.marginBottom = "1rem";
  
  const doingHeader = document.createElement("div");
  doingHeader.style.display = "flex";
  doingHeader.style.alignItems = "center";
  doingHeader.style.justifyContent = "space-between";
  doingHeader.style.padding = "0.75rem 1rem";
  doingHeader.style.background = "#f9fafb";
  doingHeader.style.borderRadius = "8px";
  doingHeader.style.cursor = "pointer";
  doingHeader.style.userSelect = "none";
  doingHeader.style.border = "1px solid #e5e7eb";
  doingHeader.style.transition = "all 0.2s";
  
  const doingTitle = document.createElement("div");
  doingTitle.style.fontWeight = "600";
  doingTitle.style.color = "#1f2937";
  doingTitle.textContent = "üí™ Jobs you're doing";
  
  // Include active jobs (ASSIGNED, PAID, AWAITING_CUSTOMER_CONFIRM, COMPLETED_BY_HUSTLER)
  // Exclude COMPLETED jobs (they're done and reviewed)
  const myHustlerJobs = allJobs.filter(
    (j) => {
      const status = (j.status || "").toUpperCase();
      return j.hustlerId === user.id && 
             status !== "COMPLETED" &&
             (status === "ASSIGNED" || status === "PAID" || status === "AWAITING_CUSTOMER_CONFIRM" || status === "COMPLETED_BY_HUSTLER");
    }
  )
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  const doingCount = document.createElement("span");
  doingCount.textContent = `(${myHustlerJobs.length})`;
  doingCount.style.marginLeft = "0.5rem";
  doingCount.style.color = "#6b7280";
  doingCount.style.fontSize = "0.9rem";
  doingTitle.appendChild(doingCount);
  
  const doingArrow = document.createElement("span");
  doingArrow.textContent = "‚ñº";
  doingArrow.style.transition = "transform 0.2s";
  doingArrow.style.color = "#6b7280";
  
  doingHeader.appendChild(doingTitle);
  doingHeader.appendChild(doingArrow);
  
  const doingContent = document.createElement("div");
  doingContent.id = "doingJobsContent";
  doingContent.style.display = "none";
  doingContent.style.marginTop = "0.5rem";
  doingContent.style.paddingLeft = "0.5rem";
  
  // Toggle function
  doingHeader.addEventListener("click", () => {
    const isOpen = doingContent.style.display !== "none";
    doingContent.style.display = isOpen ? "none" : "block";
    doingArrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
    doingHeader.style.background = isOpen ? "#f9fafb" : "#f3f4f6";
  });
  
  const limitedHustlerJobs = myHustlerJobs.slice(0, 10);
  if (limitedHustlerJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.style.padding = "0.75rem";
    empty.textContent = "You haven't been accepted on any jobs yet.";
    doingContent.appendChild(empty);
  } else {
    limitedHustlerJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;
      card.style.marginBottom = "0.5rem";

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You're the Hustler ¬∑ " + timeAgo(job.createdAt);
      card.appendChild(meta);

      // Action buttons (Archive)
      const actionsRow = document.createElement("div");
      actionsRow.style.display = "flex";
      actionsRow.style.gap = "0.5rem";
      actionsRow.style.marginTop = "0.5rem";
      actionsRow.style.justifyContent = "flex-end";
      
      // Archive button (soft delete - hides from feeds)
      const archiveBtn = document.createElement("button");
      archiveBtn.className = "btn outline btn-small";
      archiveBtn.style.fontSize = "0.85rem";
      archiveBtn.style.padding = "0.4rem 0.75rem";
      archiveBtn.textContent = "üì¶ Archive";
      archiveBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        if (!confirm(`Archive "${job.title}"? It will be hidden from feeds but can be restored later.`)) return;
        
        archiveBtn.disabled = true;
        archiveBtn.textContent = "Archiving...";
        try {
          await window.hustlAPI.jobs.archive(job.id);
          showToast("‚úì Job archived");
          renderProfile(); // Refresh profile to remove archived job
        } catch (error) {
          showToast("Error: " + (error.message || "Failed to archive job"));
          archiveBtn.disabled = false;
          archiveBtn.textContent = "üì¶ Archive";
        }
      });
      actionsRow.appendChild(archiveBtn);
      
      card.appendChild(actionsRow);
      
      card.addEventListener("click", (e) => {
        // Don't open details if clicking action buttons
        if (e.target.closest('button')) return;
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      doingContent.appendChild(card);
    });
  }
  
  doingSection.appendChild(doingHeader);
  doingSection.appendChild(doingContent);
  jobsList.appendChild(doingSection);

  // C) Jobs you've applied for (as Hustler) - collapsible
  // hasHustlerRole already declared above for Stripe Connect section
  if (hasHustlerRole) {
    const appliedSection = document.createElement("div");
    appliedSection.style.marginBottom = "1rem";
    
    const appliedHeader = document.createElement("div");
    appliedHeader.style.display = "flex";
    appliedHeader.style.alignItems = "center";
    appliedHeader.style.justifyContent = "space-between";
    appliedHeader.style.padding = "0.75rem 1rem";
    appliedHeader.style.background = "#f9fafb";
    appliedHeader.style.borderRadius = "8px";
    appliedHeader.style.cursor = "pointer";
    appliedHeader.style.userSelect = "none";
    appliedHeader.style.border = "1px solid #e5e7eb";
    appliedHeader.style.transition = "all 0.2s";
    
    const appliedTitle = document.createElement("div");
    appliedTitle.style.fontWeight = "600";
    appliedTitle.style.color = "#1f2937";
    appliedTitle.textContent = "üìã Jobs you've applied for";
    
    const appliedArrow = document.createElement("span");
    appliedArrow.textContent = "‚ñº";
    appliedArrow.style.transition = "transform 0.2s";
    appliedArrow.style.color = "#6b7280";
    
    appliedHeader.appendChild(appliedTitle);
    appliedHeader.appendChild(appliedArrow);
    
    const appliedContent = document.createElement("div");
    appliedContent.id = "appliedJobsContent";
    appliedContent.style.display = "none";
    appliedContent.style.marginTop = "0.5rem";
    appliedContent.style.paddingLeft = "0.5rem";
    
    // Toggle function
    appliedHeader.addEventListener("click", () => {
      const isOpen = appliedContent.style.display !== "none";
      appliedContent.style.display = isOpen ? "none" : "block";
      appliedArrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
      appliedHeader.style.background = isOpen ? "#f9fafb" : "#f3f4f6";
    });

    // Fetch all user offers in ONE API call (optimized - was making 20+ separate calls!)
    const appliedJobsData = [];
    try {
      const token = localStorage.getItem("hustl_token");
      if (token && window.hustlAPI.offers.listUserOffers) {
        // Use optimized endpoint - get all user offers in one call
        const userOffers = await window.hustlAPI.offers.listUserOffers();
        
        // Create a map of jobId -> offer for quick lookup
        const offersByJobId = new Map();
        userOffers.forEach(offer => {
          offersByJobId.set(offer.jobId, offer);
        });
        
        // Match offers with jobs
        for (const job of allJobs) {
          if (job.customerId === user.id) continue; // Skip jobs user posted
          
          const userOffer = offersByJobId.get(job.id);
          if (!userOffer) continue; // No offer for this job
          
          // Only show if:
          // 1. Offer is PENDING or ACCEPTED (not declined)
          // 2. Job is still OPEN or user was accepted (not assigned to someone else)
          const offerStatus = (userOffer.status || "PENDING").toUpperCase();
          const jobStatus = (job.status || "OPEN").toUpperCase();
          
          if (offerStatus === "DECLINED") {
            // Don't show declined offers
            continue;
          }
          
          if (offerStatus === "ACCEPTED" || job.hustlerId === user.id) {
            // User was accepted - show it
            appliedJobsData.push({ job, offer: userOffer });
          } else if (jobStatus === "OPEN" && offerStatus === "PENDING") {
            // Still pending - show it
            appliedJobsData.push({ job, offer: userOffer });
          } else if (jobStatus === "ASSIGNED" && job.hustlerId !== user.id) {
            // Someone else was hired - don't show it
            continue;
          } else {
            appliedJobsData.push({ job, offer: userOffer });
          }
        }
      }
    } catch (error) {
      console.error('Error fetching user offers:', error);
      // Fallback: silently fail, don't show applied jobs section
    }

    // Sort and limit to 10 most recent
    appliedJobsData.sort((a, b) => {
      const aDate = a.offer.createdAt ? new Date(a.offer.createdAt).getTime() : 0;
      const bDate = b.offer.createdAt ? new Date(b.offer.createdAt).getTime() : 0;
      return bDate - aDate;
    });
    const limitedAppliedJobs = appliedJobsData.slice(0, 10);

    // Update count in header
    const appliedCount = document.createElement("span");
    appliedCount.textContent = `(${limitedAppliedJobs.length})`;
    appliedCount.style.marginLeft = "0.5rem";
    appliedCount.style.color = "#6b7280";
    appliedCount.style.fontSize = "0.9rem";
    appliedTitle.appendChild(appliedCount);
    
    if (limitedAppliedJobs.length === 0) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.padding = "0.75rem";
      empty.textContent = "You haven't applied to any jobs yet.";
      appliedContent.appendChild(empty);
    } else {
      limitedAppliedJobs.forEach(({ job, offer }) => {
        const card = document.createElement("div");
        card.className = "job-card";
        card.dataset.jobId = job.id;
        card.style.cursor = "pointer";
        card.style.marginBottom = "0.5rem";

        const top = document.createElement("div");
        top.className = "job-card-top";

        const title = document.createElement("div");
        title.className = "job-title";
        title.textContent = job.title;
        top.appendChild(title);

        const status = document.createElement("span");
        status.className = "badge";
        const offerStatus = (offer.status || "PENDING").toUpperCase();
        if (offerStatus === "ACCEPTED") {
          status.classList.add("status-assigned");
          status.textContent = "‚úì Accepted";
        } else if (offerStatus === "PENDING") {
          status.style.background = "#dbeafe";
          status.style.color = "#1e40af";
          status.textContent = "Applied";
        } else {
          status.textContent = offerStatus;
        }
        top.appendChild(status);

        card.appendChild(top);

        const meta = document.createElement("div");
        meta.className = "job-meta";
        const createdDate = job.createdAt ? new Date(job.createdAt).getTime() : Date.now();
        const appliedDate = offer.createdAt ? new Date(offer.createdAt).getTime() : createdDate;
        meta.textContent = "You applied ¬∑ " + timeAgo(appliedDate);
        card.appendChild(meta);

        card.addEventListener("click", () => {
          setView("jobs");
          setTimeout(() => openJobDetails(job.id), 20);
        });

        appliedContent.appendChild(card);
      });
    }
    
    appliedSection.appendChild(appliedHeader);
    appliedSection.appendChild(appliedContent);
    jobsList.appendChild(appliedSection);
  }

  // hook up avatar upload (old handler - will be replaced by new one below)

  // Hook up profile save with better feedback
  const nameInputEl = document.getElementById("profileNameInput");
  const bioInputEl = document.getElementById("profileBioInput");
  const genderInputEl = document.getElementById("profileGenderInput");
  const zipInputEl = document.getElementById("profileZipInput");
  const saveProfileBtn = document.getElementById("saveProfileButton");
  const saveStatusEl = document.getElementById("saveStatus");
  
  if (saveProfileBtn) {
    saveProfileBtn.addEventListener("click", async () => {
      const name = nameInputEl?.value.trim() || "";
      const bio = bioInputEl?.value.trim() || "";
      const gender = genderInputEl?.value || "";
      const zip = zipInputEl?.value.trim() || "";
      
      if (!name) {
        saveStatusEl.textContent = "‚ö†Ô∏è Please enter your name";
        saveStatusEl.style.color = "#dc2626";
        return;
      }
      
      // Validate zip code if provided
      if (zip && (zip.length !== 5 || !/^\d{5}$/.test(zip))) {
        saveStatusEl.textContent = "‚ö†Ô∏è Please enter a valid 5-digit zip code";
        saveStatusEl.style.color = "#dc2626";
        return;
      }
      
      // Disable button and show loading
      saveProfileBtn.disabled = true;
      saveProfileBtn.style.opacity = "0.6";
      saveProfileBtn.textContent = "Saving...";
      saveStatusEl.textContent = "";
      
      try {
        // Update via API - include bio, gender, and zip
        const updateData = { name };
        if (bio) updateData.bio = bio;
        if (gender) updateData.gender = gender;
        if (zip) updateData.zip = zip;
        else if (zip === "") updateData.zip = null; // Allow clearing zip
        
        const updatedUser = await window.hustlAPI.users.update(updateData);
        
        // Update local state
        user.name = updatedUser.name;
        user.bio = updatedUser.bio || bio;
        user.gender = updatedUser.gender || gender;
        user.zip = updatedUser.zip || zip || null;
        saveState();
        
        // Show success
        saveProfileBtn.textContent = "‚úì Saved!";
        saveStatusEl.textContent = "Profile saved successfully";
        saveStatusEl.style.color = "#059669";
        
        // Update local state with zip
        if (updatedUser.zip !== undefined) {
          user.zip = updatedUser.zip;
        }
        
        // Refresh profile to show updates
        setTimeout(() => {
          renderProfile();
        }, 500);
        
        // Reset button after 2 seconds
        setTimeout(() => {
          saveProfileBtn.textContent = "Save Profile";
          saveProfileBtn.disabled = false;
          saveProfileBtn.style.opacity = "1";
        }, 2000);
      } catch (error) {
        console.error("Error saving profile:", error);
        saveProfileBtn.textContent = "Save Profile";
        saveStatusEl.textContent = "‚ùå Error: " + (error.message || "Failed to save");
        saveStatusEl.style.color = "#dc2626";
        saveProfileBtn.disabled = false;
        saveProfileBtn.style.opacity = "1";
      }
    });
  }
  
  // Avatar upload handler
  const avatarInput = document.getElementById("avatarUploadInput");
  if (avatarInput) {
    avatarInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showToast("Image is too large. Please use an image under 5MB.");
        e.target.value = "";
        return;
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showToast("Please select an image file.");
        e.target.value = "";
        return;
      }
      
      try {
        // Show loading state with spinner
        avatarInput.disabled = true;
        
        // Create and show loading spinner overlay
        const loadingOverlay = document.createElement("div");
        loadingOverlay.id = "photoUploadLoading";
        loadingOverlay.style.cssText = "position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;";
        loadingOverlay.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 2rem; text-align: center; max-width: 300px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
            <div style="width: 48px; height: 48px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">Uploading photo...</div>
            <div style="font-size: 0.9rem; color: #6b7280;">Please wait</div>
          </div>
        `;
        
        // Add spin animation if not already in style
        if (!document.getElementById('photoUploadSpinnerStyle')) {
          const style = document.createElement('style');
          style.id = 'photoUploadSpinnerStyle';
          style.textContent = `
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(loadingOverlay);
        showToast("Uploading profile photo...");
        
        // Upload to R2
        let publicUrl;
        try {
          const uploadResult = await window.hustlAPI.uploads.uploadFile(file);
          publicUrl = uploadResult.publicUrl;
          console.log("Upload successful, publicUrl:", publicUrl);
          
          // Validate URL format before sending
          if (!publicUrl || (!publicUrl.startsWith('http://') && !publicUrl.startsWith('https://') && !publicUrl.startsWith('data:'))) {
            throw new Error("Invalid photo URL format received from upload service");
          }
        } catch (uploadError) {
          console.error("R2 upload error:", uploadError);
          throw new Error("Failed to upload image: " + (uploadError.message || "Upload service error"));
        }
        
        // Update user profile with photo URL
        try {
          const updatedUser = await window.hustlAPI.users.update({ photoUrl: publicUrl });
          
          // Update local user state - update the user in the state array
          const currentUser = getCurrentUser();
          if (currentUser) {
            currentUser.photoUrl = updatedUser.photoUrl;
            currentUser.avatarDataUrl = null;
            // Also update in state.users array
            const userIndex = state.users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
              state.users[userIndex].photoUrl = updatedUser.photoUrl;
              state.users[userIndex].avatarDataUrl = null;
            }
            
            // Update localStorage user data immediately
            localStorage.setItem('hustl_user', JSON.stringify(currentUser));
          }
          saveState();
          
          // Clear currentUser cache to force refresh
          if (window.hustlAPI && window.hustlAPI.auth) {
            window.hustlAPI.auth.currentUser = updatedUser;
          }
          
          showToast("‚úì Profile photo updated!");
          
          // Immediately refresh profile view with updated user
          renderProfile(updatedUser);
          
          // Force re-render of all views that show profile photos
          if (document.getElementById("view-profile")?.style.display !== "none") {
            renderProfile(updatedUser);
          }
          
          // Refresh messages view if visible (to update profile photos in chat)
          if (document.getElementById("view-messages")?.style.display !== "none") {
            renderMessagesView();
          }
          
          // Refresh jobs view if visible (to update profile photos in job cards)
          if (document.getElementById("view-jobs")?.style.display !== "none") {
            renderJobs();
          }
          
          // Also refresh auth pill to show updated photo
          renderAuthPill();
          
          // Remove loading overlay
          const loadingOverlay = document.getElementById("photoUploadLoading");
          if (loadingOverlay) loadingOverlay.remove();
          
          // Show success message
          showToast("‚úì Profile photo updated successfully!");
        } catch (updateError) {
          console.error("Profile update error:", updateError);
          // Remove loading overlay on error
          const loadingOverlay = document.getElementById("photoUploadLoading");
          if (loadingOverlay) loadingOverlay.remove();
          throw new Error("Failed to update profile: " + (updateError.message || "Update error"));
        }
      } catch (error) {
        console.error("Error uploading profile photo:", error);
        // Remove loading overlay on error
        const loadingOverlay = document.getElementById("photoUploadLoading");
        if (loadingOverlay) loadingOverlay.remove();
        showToast("Error: " + (error.message || "Failed to upload photo. Please try again."));
        e.target.value = "";
      } finally {
        avatarInput.disabled = false;
      }
    });
  }

  // hook up "View active jobs"
  const activeLink = document.getElementById("activeJobsLink");
  if (activeLink) {
    activeLink.addEventListener("click", () => {
      setView("jobs");
      activeJobsStatusFilter = "open";
      renderJobs(true); // Reset pagination when filter changes
    });
  }
}

    /* ---------- Feedback ---------- */

    // Initialize step-by-step guide toggle
    function initStepByStepGuide() {
      const toggle = document.getElementById("stepByStepToggle");
      const content = document.getElementById("stepByStepContent");
      const arrow = document.getElementById("stepByStepArrow");
      
      if (toggle && content && arrow) {
        toggle.addEventListener("click", () => {
          const isOpen = content.style.display !== "none";
          content.style.display = isOpen ? "none" : "block";
          arrow.style.transform = isOpen ? "rotate(0deg)" : "rotate(180deg)";
          toggle.style.background = isOpen ? "#f9fafb" : "#f3f4f6";
        });
      }
    }

    // Initialize home notice dismissal
    function initHomeNotice() {
      const dismissBtn = document.getElementById("dismissHomeNotice");
      const noticeCard = document.getElementById("homeNoticeCard");
      
      if (dismissBtn && noticeCard) {
        // Check if user has already dismissed it
        if (localStorage.getItem("homeNoticeDismissed") === "true") {
          noticeCard.style.display = "none";
          return;
        }
        
        dismissBtn.addEventListener("click", () => {
          noticeCard.style.display = "none";
          localStorage.setItem("homeNoticeDismissed", "true");
        });
      }
    }

    // Initialize "How it works" toggle (always dropdown)
    function initHowItWorksToggle() {
      const toggle = document.getElementById("howItWorksToggle");
      const content = document.getElementById("howItWorksContent");
      const arrow = document.getElementById("howItWorksArrow");
      
      if (toggle && content && arrow) {
        // Always start closed
        content.style.display = "none";
        arrow.style.display = "block";
        
        // Single-tap toggle (no double-tap needed) - use passive listener
        toggle.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const isOpen = content.style.display !== "none";
          if (isOpen) {
            content.style.display = "none";
            arrow.style.transform = "rotate(0deg)";
            toggle.style.background = "#f9fafb";
          } else {
            content.style.display = "block";
            arrow.style.transform = "rotate(180deg)";
            toggle.style.background = "#f3f4f6";
          }
        }, { passive: true }); // Passive listener for better mobile performance
      }
    }


    async function initFeedback() {
      const btn = document.getElementById("feedbackButton");
      btn.addEventListener("click", async () => {
        const name = document.getElementById("feedbackName").value.trim();
        const email = document.getElementById("feedbackEmail").value.trim();
        const message = document
          .getElementById("feedbackMessage")
          .value.trim();
        if (!message) {
          showToast("Please type a bit of feedback first.");
          return;
        }
        
        // Disable button and show loading
        btn.disabled = true;
        btn.textContent = "Sending...";
        
        try {
          // Send feedback via API (emails to team.hustlapp@outlook.com)
          await window.hustlAPI.feedback.send(name, email, message);
          
          // Clear form
          document.getElementById("feedbackName").value = "";
          document.getElementById("feedbackEmail").value = "";
          document.getElementById("feedbackMessage").value = "";
          
          showToast("‚úì Feedback sent! Thank you.");
        } catch (error) {
          console.error("Error sending feedback:", error);
          showToast("Error sending feedback: " + (error.message || "Please try again."));
        } finally {
          btn.disabled = false;
          btn.textContent = "Send feedback";
        }
      });
    }

   /* ---------- Footer links ---------- */

function initFooterLinks() {
  const termsLink = document.getElementById("footerTermsLink");
  const privacyLink = document.getElementById("footerPrivacyLink");
  
  if (termsLink) {
    termsLink.style.cursor = "pointer";
    termsLink.style.textDecoration = "underline";
    termsLink.addEventListener("click", () => {
      // Open Terms page in new tab
      window.open("terms.html", "_blank");
    });
  }

  if (privacyLink) {
    privacyLink.style.cursor = "pointer";
    privacyLink.style.textDecoration = "underline";
    privacyLink.addEventListener("click", () => {
      // Open Privacy page in new tab
      window.open("privacy.html", "_blank");
    });
  }
}

   /* ---------- Public profile popup ---------- */
async function openUserProfile(userId) {
  // Fetch user from API
  let user;
  try {
    user = await window.hustlAPI.users.get(userId);
  } catch (error) {
    showToast("User not found.");
    return;
  }
  
  if (!user) {
    showToast("User not found.");
    return;
  }

  // remove any existing popup
  const existing = document.getElementById("profilePopupOverlay");
  if (existing) existing.remove();

  const overlay = document.createElement("div");
  overlay.id = "profilePopupOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(15,23,42,0.55)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "2000";

  const card = document.createElement("div");
  card.className = "card";
  card.style.maxWidth = "360px";
  card.style.width = "90%";

  // Header
  const header = document.createElement("div");
  header.className = "card-header";
  const title = document.createElement("div");
  title.className = "card-title";
  title.textContent = user.name || "Profile";
  const closeBtn = document.createElement("button");
  closeBtn.className = "small-btn outline";
  closeBtn.textContent = "Close";
  closeBtn.addEventListener("click", () => overlay.remove());
  header.appendChild(title);
  header.appendChild(closeBtn);
  card.appendChild(header);

  // Avatar + basic info (role only, no money / jobs / email)
  const row = document.createElement("div");
  row.className = "profile-row";

  const avatar = document.createElement("div");
  avatar.className = "profile-avatar";
  if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.src = user.avatarDataUrl;
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  row.appendChild(avatar);

  const info = document.createElement("div");
  info.innerHTML =
    "<span class='muted'>" +
    (user.role === "hustler" ? "Hustler" : "Customer") +
    "</span>";
  row.appendChild(info);

  card.appendChild(row);

  // Gender (if available)
  if (user.gender) {
    const genderWrap = document.createElement("div");
    genderWrap.className = "field";
    genderWrap.style.marginTop = "0.6rem";
    const genderLabel = document.createElement("div");
    genderLabel.className = "stat-label";
    genderLabel.textContent = "Gender";
    genderWrap.appendChild(genderLabel);
    const genderText = document.createElement("div");
    genderText.className = "about-text";
    const genderMap = {
      'male': 'Male',
      'female': 'Female',
      'other': 'Other',
      'prefer_not_to_say': 'Prefer not to say'
    };
    genderText.textContent = genderMap[user.gender] || user.gender;
    genderWrap.appendChild(genderText);
    card.appendChild(genderWrap);
  }

  // Bio / description
  const bioWrap = document.createElement("div");
  bioWrap.className = "field";
  bioWrap.style.marginTop = "0.6rem";

  const bioLabel = document.createElement("div");
  bioLabel.className = "stat-label";
  bioLabel.textContent = "About this person";
  bioWrap.appendChild(bioLabel);

  const bioText = document.createElement("div");
  bioText.className = "about-text";
  bioText.textContent =
    user.bio || "This person hasn't added anything about themselves yet.";
  bioWrap.appendChild(bioText);

  card.appendChild(bioWrap);

  // Reviews
  const reviewsWrap = document.createElement("div");
  reviewsWrap.className = "field";
  reviewsWrap.style.marginTop = "0.6rem";

  const reviewLabel = document.createElement("div");
  reviewLabel.className = "stat-label";
  reviewLabel.textContent = "Reviews";
  reviewsWrap.appendChild(reviewLabel);

  const reviews = user.reviews || [];
  if (reviews.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "No reviews yet.";
    reviewsWrap.appendChild(empty);
  } else {
    reviews.forEach((r) => {
      const rCard = document.createElement("div");
      rCard.className = "stat-card";
      rCard.style.marginTop = "0.35rem";

      const top = document.createElement("div");
      top.className = "stat-value";
      top.style.fontSize = "0.8rem";
      top.textContent = (r.rating ? "‚òÖ".repeat(r.rating) + " ¬∑ " : "") + (r.fromName || "Someone on Hustl");
      rCard.appendChild(top);

      const body = document.createElement("div");
      body.className = "muted";
      body.style.marginTop = "0.2rem";
      body.textContent = r.text || "";
      rCard.appendChild(body);

      reviewsWrap.appendChild(rCard);
    });
  }

  card.appendChild(reviewsWrap);

  overlay.appendChild(card);
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.remove();
  });

  document.body.appendChild(overlay);
}


    /* ---------- Owner view ---------- */

    function renderOwnerView() {
      const user = getCurrentUser();
      const tab = document.getElementById("ownerTab");
      const view = document.getElementById("view-owner");
      const paidList = document.getElementById("ownerPaidList");
      const assignedList = document.getElementById("ownerAssignedList");

      const isOwner = !!(user && user.email && user.email.toLowerCase() === "team.hustlapp@outlook.com");
      if (tab) tab.style.display = isOwner ? "" : "none";
      if (!isOwner) {
        if (view) view.style.display = "none";
        return;
      }

      // Paid jobs
      const paidJobs = state.jobs.filter(j => j.paymentStatus === "paid");
      if (paidList) {
        paidList.innerHTML = "";
        if (paidJobs.length === 0) {
          paidList.innerHTML = "<div class='muted'>No paid jobs yet.</div>";
        } else {
          paidJobs.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
           const custUser = state.users.find(u => u.id === j.postedByUserId);
const hustUser = state.users.find(u => u.id === j.acceptedHustlerId);
const cust = custUser?.name || "Customer";
const hust = hustUser?.name || "Hustler";

let payoutInfo = "";
if (hustUser && hustUser.payoutMethod && hustUser.payoutHandle) {
  const label =
    hustUser.payoutMethod === "venmo" ? "Venmo" :
    hustUser.payoutMethod === "cashapp" ? "Cash App" :
    hustUser.payoutMethod === "zelle" ? "Zelle" : "Payout";
  payoutInfo = ` ¬∑ ${label}: ${hustUser.payoutHandle}`;
}

meta.textContent =
  `Paid ${formatMoney(j.chargedAmount || 0)} ¬∑ Your fee ${formatMoney(j.platformFeeAmount || 0)} ¬∑ ${cust} ‚Üí ${hust}${payoutInfo}`;
            row.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "job-card-actions";

            const left = document.createElement("div");
            const payoutBadge = document.createElement("span");
            payoutBadge.className = "badge";
            if (j.adminPayoutDone) {
              payoutBadge.classList.add("status-completed");
              payoutBadge.textContent = "Payout marked done";
            } else {
              payoutBadge.classList.add("status-assigned");
              payoutBadge.textContent = "Payout pending";
            }
            left.appendChild(payoutBadge);

            const right = document.createElement("div");
            const markBtn = document.createElement("button");
            markBtn.className = "small-btn";
            markBtn.textContent = j.adminPayoutDone ? "Unmark payout" : "Mark payout done";
            markBtn.addEventListener("click", () => {
              j.adminPayoutDone = !j.adminPayoutDone;
              saveState();
              showToast(j.adminPayoutDone ? "Marked payout done." : "Payout unmarked.");
              renderOwnerView();
            });
            right.appendChild(markBtn);

            actions.appendChild(left);
            actions.appendChild(right);
            row.appendChild(actions);

            paidList.appendChild(row);
          });
        }
      }

      // Assigned but not paid
      const assigned = state.jobs.filter(j => j.status === "assigned" && j.paymentStatus !== "paid");
      if (assignedList) {
        assignedList.innerHTML = "";
        if (assigned.length === 0) {
          assignedList.innerHTML = "<div class='muted'>No assigned-but-unpaid jobs.</div>";
        } else {
          assigned.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
            const cust = state.users.find(u => u.id === j.postedByUserId)?.name || "Customer";
            const hust = state.users.find(u => u.id === j.acceptedHustlerId)?.name || "Hustler";
            meta.textContent = `Assigned ¬∑ ${cust} ‚Üî ${hust} ¬∑ posted ${timeAgo(j.createdAt)}`;
            row.appendChild(meta);

            assignedList.appendChild(row);
          });
        }
      }
    }

    /* ---------- MOBILE JOB CARD CREATOR (Simplified for Mobile) ---------- */
    function createMobileJobCard(job, user, userMode) {
      const card = document.createElement("div");
      card.className = "mobile-job-card";
      
      // Header: Title + Pay
      const header = document.createElement("div");
      header.className = "mobile-job-card-header";
      
      const title = document.createElement("div");
      title.className = "mobile-job-card-title";
      title.textContent = job.title || "Untitled Job";
      
      const pay = document.createElement("div");
      pay.className = "mobile-job-card-pay";
      if (job.payType === "flat") {
        pay.textContent = `$${(Number(job.amount) || 0).toFixed(2)}`;
      } else {
        const hr = Number(job.hourlyRate) || 0;
        const maxH = job.estHours || 0;
        const maxTotal = hr * maxH;
        pay.textContent = `$${hr.toFixed(2)}/hr (up to $${maxTotal.toFixed(2)})`;
      }
      
      header.appendChild(title);
      header.appendChild(pay);
      card.appendChild(header);
      
      // Category badge
      const categoryBadge = document.createElement("div");
      categoryBadge.style.cssText = "display: inline-block; padding: 0.25rem 0.5rem; background: #e0e7ff; color: #4338ca; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem;";
      const cat = job.category === "moving" ? "üöö Moving" : 
                  job.category === "yard" ? "üåø Yard Work" :
                  job.category === "cleaning" ? "üßπ Cleaning" :
                  job.category === "furniture" ? "üõ† Furniture" :
                  job.category === "handyman" ? "üîß Handyman" :
                  job.category === "painting" ? "üé® Painting" :
                  job.category === "landscaping" ? "üå≥ Landscaping" :
                  job.category === "petcare" ? "üêï Pet Care" :
                  job.category === "event" ? "üéâ Event Help" :
                  job.category === "tech" ? "üíª Tech Support" :
                  "‚≠ê Other";
      categoryBadge.textContent = cat;
      card.appendChild(categoryBadge);
      
      // Meta: Distance + Time posted + Location
      const meta = document.createElement("div");
      meta.className = "mobile-job-card-meta";
      meta.style.cssText = "display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-muted);";
      
      // Distance
      if (job.distance !== null && job.distance !== undefined) {
        const distance = document.createElement("div");
        const distanceText = job.distanceFormatted || `${job.distance.toFixed(1)} mi`;
        distance.innerHTML = `üìç ${distanceText} away`;
        meta.appendChild(distance);
      }
      
      // Location (zip/city)
      const requirements = job.requirements || {};
      const pickupZip = requirements.pickupZip || '';
      const pickupCity = requirements.pickupCity || job.customer?.city || '';
      if (pickupZip || pickupCity) {
        const location = document.createElement("div");
        location.innerHTML = `üìç ${pickupCity || ''}${pickupCity && pickupZip ? ', ' : ''}${pickupZip || ''}`;
        meta.appendChild(location);
      }
      
      // Time posted
      const time = document.createElement("div");
      const createdMs = job.createdAt ? new Date(job.createdAt).getTime() : Date.now();
      time.innerHTML = `‚è∞ ${timeAgo(createdMs)}`;
      meta.appendChild(time);
      
      // Pay type indicator
      const payType = document.createElement("div");
      payType.style.cssText = "font-weight: 600; color: var(--primary);";
      if (job.payType === "flat") {
        payType.innerHTML = "üíµ Flat Rate";
      } else {
        const hr = Number(job.hourlyRate) || 0;
        const maxH = job.estHours || 0;
        payType.innerHTML = `‚è± Hourly (${maxH}h max)`;
      }
      meta.appendChild(payType);
      
      card.appendChild(meta);
      
      // Applicant count (if available)
      if (job._count && job._count.offers !== undefined && job._count.offers > 0) {
        const applicantBadge = document.createElement("div");
        applicantBadge.style.cssText = "display: inline-block; padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem;";
        applicantBadge.innerHTML = `üë• ${job._count.offers} ${job._count.offers === 1 ? 'person applied' : 'people applied'}`;
        card.appendChild(applicantBadge);
      }
      
      // Photo indicator (if job has photos)
      if (job.photos && job.photos.length > 0) {
        const photoBadge = document.createElement("div");
        photoBadge.style.cssText = "display: inline-block; padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 0.5rem; margin-left: 0.5rem;";
        photoBadge.innerHTML = `üì∏ ${job.photos.length} photo${job.photos.length > 1 ? 's' : ''}`;
        card.appendChild(photoBadge);
      }
      
      // Description preview (show more lines - 3-4 lines)
      const description = job.description || '';
      if (description) {
        const descPreview = document.createElement("div");
        descPreview.style.cssText = "font-size: 0.9rem; color: var(--text-main); margin-top: 0.75rem; line-height: 1.5; max-height: 4.5em; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;";
        descPreview.textContent = description;
        card.appendChild(descPreview);
      }
      
      // Actions: View Job button + Seen button (for hustlers)
      const actions = document.createElement("div");
      actions.className = "mobile-job-card-actions";
      
      const viewBtn = document.createElement("button");
      viewBtn.className = "mobile-job-card-view-btn";
      viewBtn.textContent = "View Job";
      viewBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openJobDetails(job.id);
      });
      actions.appendChild(viewBtn);
      
      // "Seen" button for hustlers
      if (user && userMode === "hustler" && (job.status || "").toUpperCase() === "OPEN" && job.customerId !== user.id) {
        const seenBtn = document.createElement("button");
        seenBtn.className = "mobile-job-card-seen-btn";
        seenBtn.textContent = "‚úì Seen";
        seenBtn.title = "Remove this job from your feed";
        seenBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          dismissJob(job.id);
        });
        actions.appendChild(seenBtn);
      }
      
      card.appendChild(actions);
      
      // Click entire card to view job (except buttons)
      card.addEventListener("click", (e) => {
        if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) {
          openJobDetails(job.id);
        }
      });
      
      return card;
    }

    /* ---------- PROFILE PHOTO HELPER (Shows photos everywhere) ---------- */
    function getProfilePhoto(user, size = 'medium') {
      if (!user) return null;
      
      const sizes = {
        small: { width: 32, height: 32, fontSize: '0.75rem' },
        medium: { width: 40, height: 40, fontSize: '0.9rem' },
        large: { width: 80, height: 80, fontSize: '1.5rem' },
      };
      
      const sizeConfig = sizes[size] || sizes.medium;
      const photo = document.createElement('div');
      photo.className = `profile-photo profile-photo-${size}`;
      photo.style.cssText = `
        width: ${sizeConfig.width}px;
        height: ${sizeConfig.height}px;
        border-radius: 50%;
        background: var(--primary-soft);
        border: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        font-weight: 600;
        font-size: ${sizeConfig.fontSize};
        flex-shrink: 0;
        overflow: hidden;
      `;
      
      // Get user initial (first letter of name or username)
      const name = user.name || user.username || 'U';
      const initial = name.charAt(0).toUpperCase();
      photo.setAttribute('data-initial', initial);
      photo.textContent = initial;
      
      // If user has photo URL, add image
      if (user.photoUrl) {
        const img = document.createElement('img');
        img.loading = "lazy"; // Lazy load profile photos
        // Add cache-busting for profile photos
        const separator = user.photoUrl.includes('?') ? '&' : '?';
        img.src = user.photoUrl + separator + '_cb=' + Date.now();
        img.alt = name;
        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        img.onerror = () => {
          // If image fails to load, show initial (fallback to original URL first)
          if (img.src !== user.photoUrl) {
            img.src = user.photoUrl;
          } else {
            img.style.display = 'none';
          }
        };
        photo.appendChild(img);
      }
      
      return photo;
    }

    /* ---------- Main render ---------- */

    // Optimized renderAll - only render what's needed with performance monitoring
    async function renderAll() {
      perfMonitor?.start('renderAll');
      try {
        renderAuthPill();
        renderAuthSectionVisibility();
        renderOwnerView();

        // Only render the active view (performance optimization)
        if (activeView === "jobs") {
          perfMonitor?.start('renderJobs');
          await renderJobs();
          perfMonitor?.end('renderJobs');
        } else if (activeView === "messages") {
          perfMonitor?.start('renderMessages');
          if (typeof renderMessagesView === 'function') {
            renderMessagesView();
          }
          perfMonitor?.end('renderMessages');
        } else if (activeView === "profile") {
          perfMonitor?.start('renderProfile');
          if (typeof renderProfile === 'function') {
            await renderProfile();
          }
          perfMonitor?.end('renderProfile');
        } else if (activeView === "owner") {
          renderOwnerView();
        }
        
        // Always update unread message count (works even when not on messages view)
        // Optimize: only if user is logged in
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (user) {
          countUnreadMessages();
          
          // Check for new accepted jobs and show notification (for hustlers)
          if (userMode === "hustler") {
            // Use Promise.all for parallel execution
            Promise.all([
              checkNewAcceptedJobs(),
              updateMyHustlesBadge(user.id)
            ]).catch(err => console.error('Error in background tasks:', err));
          }
        }
      } catch (error) {
        const message = errorHandler?.handle(error, 'Rendering') || error.message || 'Rendering error';
        console.error('RenderAll error:', error);
        showToast(message);
      } finally {
        perfMonitor?.end('renderAll');
      }
    }
    
    // Update "My Hustles" tab badge with count
    async function updateMyHustlesBadge(userId) {
      try {
        const myHustlesTab = document.querySelector('[data-tab="my-hustles"]');
        if (!myHustlesTab) return;
        
        const allJobs = await window.hustlAPI.jobs.list({ page: 1, limit: 100 });
        const jobsArray = allJobs?.jobs || allJobs || [];
        const assignedCount = jobsArray.filter(j => j.hustlerId === userId && (j.status === "ASSIGNED" || j.status === "PAID")).length;
        
        // Check for newly accepted offers (within last 24 hours)
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        const newAcceptedCount = jobsArray.filter(j => {
          if (j.hustlerId === userId && (j.status === "ASSIGNED" || j.status === "PAID")) {
            const assignedAt = j.requirements?.assignedAt;
            if (assignedAt) {
              const assignedTime = new Date(assignedAt).getTime();
              return assignedTime > oneDayAgo;
            }
          }
          return false;
        }).length;
        
        // Update tab text with count and badge
        if (assignedCount > 0) {
          myHustlesTab.innerHTML = `My Hustles${newAcceptedCount > 0 ? ` <span style="background: #10b981; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; font-weight: 600; margin-left: 4px;">${newAcceptedCount} new</span>` : ` <span style="background: #6b7280; color: white; border-radius: 10px; padding: 2px 6px; font-size: 0.7rem; font-weight: 600; margin-left: 4px;">${assignedCount}</span>`}`;
        } else {
          myHustlesTab.textContent = "My Hustles";
        }
      } catch (error) {
        console.error("Error updating My Hustles badge:", error);
      }
    }
    
    // Check if hustler has newly accepted jobs and show notification
    async function checkNewAcceptedJobs() {
      try {
        const user = await window.hustlAPI.auth.getCurrentUser();
        if (!user || userMode !== "hustler") return;
        
        // Get all jobs
        const response = await window.hustlAPI.jobs.list({ page: 1, limit: 100 });
        const jobsArray = response?.jobs || response || [];
        
        // Find assigned jobs that were assigned in the last 24 hours
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        const newAcceptedJobs = jobsArray.filter(j => {
          if (j.hustlerId === user.id && (j.status === "ASSIGNED" || j.status === "PAID")) {
            const assignedAt = j.requirements?.assignedAt;
            if (assignedAt) {
              const assignedTime = new Date(assignedAt).getTime();
              return assignedTime > oneDayAgo;
            }
          }
          return false;
        });
        
        // Check if we've already notified about these jobs
        const lastNotified = localStorage.getItem("lastAcceptedJobsNotification");
        const notifiedJobIds = lastNotified ? JSON.parse(lastNotified) : [];
        
        // Find jobs we haven't notified about yet
        const unNotifiedJobs = newAcceptedJobs.filter(j => !notifiedJobIds.includes(j.id));
        
        if (unNotifiedJobs.length > 0) {
          // üöÄ MOBILE: Show "YOU'RE HIRED!" banner for each newly accepted job (mobile-optimized)
          unNotifiedJobs.forEach(job => {
            // Show banner (mobile-optimized, full-screen on mobile)
            if (typeof showHiredBanner === 'function') {
              showHiredBanner(job.id, job.title);
            } else {
              // Fallback to toast if banner function not available
              showToast(`üéâ You've been accepted for "${job.title}"! Check "My Hustles" tab.`);
            }
            
            // Mark as notified
            notifiedJobIds.push(job.id);
          });
          
          // Save all notified job IDs
          const allNotifiedIds = [...notifiedJobIds, ...unNotifiedJobs.map(j => j.id)];
          localStorage.setItem("lastAcceptedJobsNotification", JSON.stringify(allNotifiedIds));
        }
      } catch (error) {
        console.error("Error checking new accepted jobs:", error);
      }
    }

    /* ---------- Mode Toggle ---------- */
    
    function initModeToggle() {
      const customerBtn = document.getElementById("modeCustomerBtn");
      const hustlerBtn = document.getElementById("modeHustlerBtn");
      
      if (customerBtn) {
        customerBtn.addEventListener("click", () => {
          userMode = "customer";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
      
      if (hustlerBtn) {
        hustlerBtn.addEventListener("click", () => {
          userMode = "hustler";
          localStorage.setItem("hustl_userMode", userMode);
          renderAll();
        });
      }
    }

    /* ---------- Init ---------- */

    function initNav() {
      // Regular nav tabs
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const v = tab.dataset.view;
          setView(v);
        });
      });

      // Mobile menu items
      document.querySelectorAll(".mobile-menu-item").forEach((item) => {
        item.addEventListener("click", () => {
          const view = item.dataset.view;
          if (view) setView(view);
        });
      });

      // Mobile menu button toggle
      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      const mobileMenu = document.getElementById("mobileMenu");
      const ownerTab = document.getElementById("ownerTab");
      const mobileMenuOwner = document.getElementById("mobileMenuOwner");
      
      // Sync owner tab visibility between desktop and mobile
      function syncOwnerTab() {
        if (ownerTab && mobileMenuOwner) {
          mobileMenuOwner.style.display = ownerTab.style.display;
        }
      }
      
      if (mobileMenuBtn && mobileMenu) {
        // Show/hide mobile menu button based on screen size
        function updateMobileMenuVisibility() {
          if (window.innerWidth <= 768) {
            mobileMenuBtn.style.display = "block";
            syncOwnerTab();
          } else {
            mobileMenuBtn.style.display = "none";
            mobileMenu.classList.remove("show");
          }
        }
        
        // Initial check - run immediately and on load
        updateMobileMenuVisibility();
        window.addEventListener("resize", updateMobileMenuVisibility);
        
        // Also check on page load in case script runs before DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', updateMobileMenuVisibility);
        } else {
          updateMobileMenuVisibility();
        }
        
        // Toggle menu on click
        mobileMenuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const isShowing = mobileMenu.classList.contains("show");
          if (isShowing) {
            mobileMenu.classList.remove("show");
            mobileMenu.style.display = "none";
          } else {
            mobileMenu.classList.add("show");
            mobileMenu.style.display = "block";
          }
        });
        
        // Close menu when clicking outside
        document.addEventListener("click", (e) => {
          if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
            mobileMenu.classList.remove("show");
            mobileMenu.style.display = "none";
          }
        });
      }

      document
        .getElementById("homeCtaPost")
        .addEventListener("click", () => {
          setView("post");
          const formCard = document.getElementById("jobFormCard");
          if (formCard) {
            formCard.scrollIntoView({ behavior: "smooth" });
          }
        });
      document
        .getElementById("homeCtaBrowse")
        .addEventListener("click", () => setView("jobs"));

      document
        .getElementById("jobsStatusFilter")
        .querySelectorAll("span")
        .forEach((el) => {
          el.addEventListener("click", () => {
            activeJobsStatusFilter = el.dataset.status;
            document
              .getElementById("jobsStatusFilter")
              .querySelectorAll("span")
              .forEach((s) =>
                s.classList.toggle("active", s.dataset.status === activeJobsStatusFilter)
              );
            renderJobs();
          });
        });
      
      // Tab switching for jobs view
      const jobsTabs = document.getElementById("jobsTabs");
      if (jobsTabs) {
        // Remove old listeners by re-adding them
        jobsTabs.querySelectorAll(".job-tab").forEach((tab) => {
          const newTab = tab.cloneNode(true);
          tab.parentNode.replaceChild(newTab, tab);
            newTab.addEventListener("click", () => {
            jobsTabs.querySelectorAll(".job-tab").forEach((t) => t.classList.remove("active"));
            newTab.classList.add("active");
            renderJobs(true); // Reset pagination when changing tabs
          });
        });
      }
      
      // Date/time filter handlers
      const jobsDateFilter = document.getElementById("jobsDateFilter");
      const jobsTimeFilter = document.getElementById("jobsTimeFilter");
      if (jobsDateFilter) {
        jobsDateFilter.addEventListener("change", () => {
          renderJobs(true); // Reset pagination when filter changes
        });
      }
      if (jobsTimeFilter) {
        jobsTimeFilter.addEventListener("change", () => {
          renderJobs(true); // Reset pagination when filter changes
        });
      }
      
      // Location button - get user's current location
      const setMyLocationBtn = document.getElementById("setMyLocationBtn");
      const locationStatus = document.getElementById("locationStatus");
      if (setMyLocationBtn) {
        setMyLocationBtn.addEventListener("click", () => {
          if (!navigator.geolocation) {
            locationStatus.textContent = "Geolocation is not supported by your browser.";
            return;
          }
          
          setMyLocationBtn.disabled = true;
          setMyLocationBtn.textContent = "Getting location...";
          locationStatus.textContent = "Requesting location permission...";
          
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                timestamp: Date.now()
              };
              localStorage.setItem('userLocation', JSON.stringify(location));
              locationStatus.textContent = `‚úì Location set! Showing jobs within selected distance.`;
              setMyLocationBtn.disabled = false;
              setMyLocationBtn.textContent = "üìç Use My Location";
              renderJobs(true); // Reset pagination when location changes
            },
            (error) => {
              locationStatus.textContent = `Error: ${error.message}. Please enable location permissions.`;
              setMyLocationBtn.disabled = false;
              setMyLocationBtn.textContent = "üìç Use My Location";
            }
          );
        });
      }
      
      // Radius filter change handler
      const jobsRadiusFilter = document.getElementById("jobsRadiusFilter");
      const currentRadiusDisplay = document.getElementById("currentRadiusDisplay");
      if (jobsRadiusFilter) {
        jobsRadiusFilter.addEventListener("change", () => {
          const radius = jobsRadiusFilter.value || '25';
          if (currentRadiusDisplay) {
            currentRadiusDisplay.textContent = `${radius} miles`;
          }
          renderJobs(true); // Reset pagination when radius changes
        });
        
        // Set initial display value
        if (currentRadiusDisplay && jobsRadiusFilter.value) {
          currentRadiusDisplay.textContent = `${jobsRadiusFilter.value} miles`;
        }
      }
      
      // Distance filter change handler (legacy - keep for backwards compatibility)
      const jobsDistanceFilter = document.getElementById("jobsDistanceFilter");
      if (jobsDistanceFilter) {
        jobsDistanceFilter.addEventListener("change", () => {
          const userLocation = JSON.parse(localStorage.getItem('userLocation') || 'null');
          if (jobsDistanceFilter.value && (!userLocation || !userLocation.lat)) {
            if (locationStatus) locationStatus.textContent = "‚ö†Ô∏è Please set your location first using 'Use My Location' button.";
          } else {
            if (locationStatus) locationStatus.textContent = "";
            renderJobs(true); // Reset pagination when filter changes
          }
        });
      }
      
      // Location filter change handler - apply immediately on change
      const jobsLocationFilter = document.getElementById("jobsLocationFilter");
      if (jobsLocationFilter) {
        jobsLocationFilter.addEventListener("blur", () => {
          // Apply filter when user leaves the field
          const locationValue = cleanAddress(jobsLocationFilter.value);
          if (locationValue) {
            // If it's a ZIP code, save it
            if (locationValue.length === 5 && /^\d{5}$/.test(locationValue)) {
              localStorage.setItem('savedZipFilter', locationValue);
            }
            renderJobs(true); // Reset pagination when location changes
          } else {
            // Clear filter if empty
            localStorage.removeItem('savedZipFilter');
            renderJobs(true);
          }
        });
        
        jobsLocationFilter.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            jobsZipFilter.blur(); // Trigger blur event to apply filter
          }
        });
        
        // Load saved zip filter on page load
        const savedZip = localStorage.getItem('savedZipFilter');
        if (savedZip && jobsZipFilter) {
          jobsZipFilter.value = savedZip;
        }
      }
      
      // Check for newly accepted offers and show notification to Hustlers
      async function checkForAcceptedOffers() {
        try {
          const user = await window.hustlAPI.auth.getCurrentUser();
          if (!user) return;
          
          // Only check for Hustlers
          const isHustler = user.roles?.some(r => r.toUpperCase() === 'HUSTLER');
          if (!isHustler) return;
          
          // Get user's jobs where they are the hustler
          const token = localStorage.getItem("hustl_token");
          const response = await fetch("/jobs?status=ASSIGNED", {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          
          if (response.ok) {
            const data = await response.json();
            const jobs = Array.isArray(data) ? data : (data.jobs || []);
            
            // Find jobs where this user is the hustler and was recently assigned (within last 24 hours)
            const now = Date.now();
            const twentyFourHoursAgo = now - 24 * 60 * 60 * 1000;
            
            const newlyAcceptedJobs = jobs.filter(job => {
              if (job.hustlerId !== user.id) return false;
              if (!job.updatedAt) return false;
              
              const updatedAt = new Date(job.updatedAt).getTime();
              return updatedAt > twentyFourHoursAgo;
            });
            
            // Check if we've already shown notification for these jobs
            const shownNotifications = JSON.parse(localStorage.getItem('shownJobNotifications') || '[]');
            const unshownJobs = newlyAcceptedJobs.filter(job => !shownNotifications.includes(job.id));
            
            // Show notification for the most recent one
            if (unshownJobs.length > 0) {
              const job = unshownJobs[0]; // Most recent
              showHustlerPickedNotification(job);
              
              // Mark as shown
              shownNotifications.push(job.id);
              localStorage.setItem('shownJobNotifications', JSON.stringify(shownNotifications));
            }
          }
        } catch (error) {
          console.error('Error checking for accepted offers:', error);
        }
      }
      
      // Show notification when Hustler is picked
      async function showHustlerPickedNotification(job) {
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(15,23,42,0.85)";
        overlay.style.display = "flex";
        overlay.style.alignItems = "center";
        overlay.style.justifyContent = "center";
        overlay.style.zIndex = "10000";
        overlay.style.padding = "1rem";
        
        const modal = document.createElement("div");
        modal.className = "card";
        modal.style.maxWidth = "500px";
        modal.style.width = "100%";
        modal.style.background = "linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)";
        modal.style.border = "3px solid #10b981";
        modal.style.boxShadow = "0 20px 25px -5px rgba(0,0,0,0.3)";
        
        const header = document.createElement("div");
        header.className = "card-header";
        header.style.background = "transparent";
        header.style.borderBottom = "none";
        
        const title = document.createElement("div");
        title.className = "card-title";
        title.style.fontSize = "1.5rem";
        title.style.color = "#047857";
        title.innerHTML = "üéâ Congratulations!";
        header.appendChild(title);
        modal.appendChild(header);
        
        const content = document.createElement("div");
        content.style.padding = "1.5rem";
        
        const message = document.createElement("div");
        message.style.marginBottom = "1.5rem";
        message.style.lineHeight = "1.7";
        message.style.color = "#065f46";
        message.innerHTML = `
          <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.75rem;">
            You were picked as the Hustler for this job!
          </div>
          <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: #047857;">
            "${job.title || 'Job'}"
          </div>
          <div style="font-size: 0.95rem; color: #065f46;">
            Check your email for details. You can now view the job details, message the customer, and get started!
          </div>
        `;
        content.appendChild(message);
        
        const buttonRow = document.createElement("div");
        buttonRow.style.display = "flex";
        buttonRow.style.gap = "0.75rem";
        buttonRow.style.flexDirection = "column";
        
        const viewJobBtn = document.createElement("button");
        viewJobBtn.className = "btn btn-primary";
        viewJobBtn.style.width = "100%";
        viewJobBtn.style.background = "#047857";
        viewJobBtn.style.border = "none";
        viewJobBtn.textContent = "üëâ View Job Details";
        viewJobBtn.addEventListener("click", () => {
          overlay.remove();
          document.body.style.overflow = "";
          setTimeout(() => {
            setView("jobs");
            openJobDetails(job.id);
          }, 100);
        });
        buttonRow.appendChild(viewJobBtn);
        
        const closeBtn = document.createElement("button");
        closeBtn.className = "btn outline";
        closeBtn.style.width = "100%";
        closeBtn.textContent = "Got it!";
        closeBtn.addEventListener("click", () => {
          overlay.remove();
          document.body.style.overflow = "";
        });
        buttonRow.appendChild(closeBtn);
        
        content.appendChild(buttonRow);
        modal.appendChild(content);
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        document.body.style.overflow = "hidden";
        
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            overlay.remove();
            document.body.style.overflow = "";
          }
        });
      }
      
      // Check for accepted offers when jobs view loads
      setTimeout(() => {
        if (activeView === "jobs") {
          checkForAcceptedOffers();
        }
      }, 1000);
      
      // Load More button handler
      const loadMoreJobsBtn = document.getElementById("loadMoreJobsBtn");
      if (loadMoreJobsBtn) {
        loadMoreJobsBtn.addEventListener("click", () => {
          if (jobsPagination.hasMore) {
            currentJobsPage++;
            loadMoreJobsBtn.disabled = true;
            loadMoreJobsBtn.textContent = "Loading...";
            renderJobs(false).then(() => {
              loadMoreJobsBtn.disabled = false;
              loadMoreJobsBtn.textContent = "Load More Jobs";
            }).catch(() => {
              loadMoreJobsBtn.disabled = false;
              loadMoreJobsBtn.textContent = "Load More Jobs";
            });
          }
        });
      }
      
      // Check if location is already set
      const userLocation = JSON.parse(localStorage.getItem('userLocation') || 'null');
      if (userLocation && userLocation.lat) {
        locationStatus.textContent = "‚úì Location set. Select distance to filter jobs.";
      }
    }
    
    function handleStripeReturn() {
      // Handle payment success redirect - show confirmation page
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('payment') === 'success') {
        const offerId = urlParams.get('offerId');
        const jobId = urlParams.get('jobId');
        const testMode = urlParams.get('test_mode') === 'true';
        
        if (offerId && jobId) {
          // Show confirmation page
          if (window.showConfirmationPage) {
            window.showConfirmationPage(jobId, offerId);
          } else {
            if (testMode) {
              showToast("‚úì Offer accepted! (Test Mode - No real payment)");
            } else {
              showToast("Payment successful! Hustler accepted.");
            }
            // Force refresh jobs list
            setTimeout(() => {
              renderJobs();
              renderAll();
            }, 500);
          }
        }
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
    
    async function startPayment(jobId) {
      const job = state.jobs.find((j) => j.id === jobId);
      const user = getCurrentUser();

      if (!job || !user || user.id !== job.postedByUserId) {
        showToast("Only the customer who posted can pay for this job.");
        return;
      }

      if (!job.acceptedHustlerId) {
        showToast("Accept a Hustler before paying.");
        return;
      }

      // Calculate total
      let total = 0;
      if (job.paymentType === "flat") {
        total = job.flatAmount || 0;
      } else {
        total = (job.hourlyRate || 0) * (job.maxHours || 0);
      }

      if (total <= 0) {
        showToast("Job total must be greater than zero.");
        return;
      }

      // Stripe expects amount in cents
      const platformPercent = 0.16; // 16% cut
      const platformFee = Math.round(total * platformPercent);
      const amountToCharge = total * 100; // Convert to cents

      try {
        const res = await fetch("http://localhost:3000/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amountTotalCents: amountToCharge,
            customerEmail: user.email,
            description: `Hustl job payment for: ${job.title}`,
          }),
        });

        const data = await res.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          showToast("Failed to start Stripe Checkout session.");
        }
      } catch (err) {
        console.error("Payment error:", err);
        showToast("Error connecting to payment server.");
      }
    }

// Simple cleanup function - can be called from console or keyboard
window.clearStuckOverlays = function() {
  // Remove all possible overlay elements
  const selectors = [
    '.modal-overlay',
    '[id^="jobModalOverlay"]',
    '#verificationCodeModal',
    '[id^="jobDetailsOverlay"]',
    '[class*="overlay"]',
    '[class*="modal"]'
  ];
  
  selectors.forEach(selector => {
    try {
      document.querySelectorAll(selector).forEach(el => {
        if (el && el.parentNode) {
          el.remove();
        }
      });
    } catch(e) {
      console.log('Error removing:', selector, e);
    }
  });
  
  // Reset body styles
  if (document.body) {
    document.body.style.overflow = '';
    document.body.style.pointerEvents = '';
  }
  
  // Remove any inline styles that might block
  document.querySelectorAll('*').forEach(el => {
    if (el.style && el.style.pointerEvents === 'none' && el.style.position === 'fixed') {
      el.style.pointerEvents = '';
    }
  });
  
  console.log('Cleared stuck overlays - page should be clickable now');
};

// IMMEDIATE cleanup - run right away, don't wait for load
// Run immediately to prevent stuck overlays from blocking the page
(function() {
  try {
    // Remove all blocking elements immediately
    const selectors = [
      '.modal-overlay',
      '[id^="jobModalOverlay"]',
      '#verificationCodeModal',
      '[id^="jobDetailsOverlay"]',
      '.overlay',
      '[class*="overlay"]',
      '[class*="modal-backdrop"]'
    ];
    
    selectors.forEach(selector => {
      try {
        document.querySelectorAll(selector).forEach(el => {
          if (el && el.parentNode) {
            el.remove();
          }
        });
      } catch(e) {
        // Ignore errors
      }
    });
    
    // Reset body styles immediately
    if (document.body) {
      document.body.style.overflow = '';
      document.body.style.pointerEvents = '';
      document.body.style.position = '';
    }
    
    // Also reset html element
    if (document.documentElement) {
      document.documentElement.style.overflow = '';
    }
  } catch(e) {
    // Ignore errors during cleanup
  }
})();

// Aggressive cleanup on page load - remove any stuck overlays
window.addEventListener('load', function() {
  setTimeout(function() {
    window.clearStuckOverlays();
  }, 100);
  // Run again after a longer delay to catch any late-loading overlays
  setTimeout(function() {
    window.clearStuckOverlays();
  }, 500);
});

// Also run on DOMContentLoaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(window.clearStuckOverlays, 50);
    setTimeout(window.clearStuckOverlays, 200);
  });
} else {
  setTimeout(window.clearStuckOverlays, 50);
  setTimeout(window.clearStuckOverlays, 200);
}

// Periodic cleanup every 5 seconds to catch any stuck overlays
setInterval(function() {
  // Only cleanup if no active modals should be open
  // Check if there are any modals that shouldn't be there
  const overlays = document.querySelectorAll('.modal-overlay, [id^="jobModalOverlay"]');
  const bodyOverflow = document.body.style.overflow;
  
  // If body is set to hidden overflow but there are no visible modals, something is stuck
  if (bodyOverflow === 'hidden' && overlays.length === 0) {
    window.clearStuckOverlays();
  }
}, 5000);

// Keyboard shortcut: Press Escape multiple times or Ctrl+Shift+C to clear
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    // Try to close any open modal first
    const modals = document.querySelectorAll('.modal-overlay, [id^="jobModalOverlay"]');
    if (modals.length > 0) {
      modals.forEach(m => {
        if (m && m.parentNode) {
          m.remove();
        }
      });
      if (document.body) {
        document.body.style.overflow = '';
        document.body.style.pointerEvents = '';
      }
    }
  }
  if (e.ctrlKey && e.shiftKey && e.key === 'C') {
    e.preventDefault();
    window.clearStuckOverlays();
    alert('Overlays cleared!');
  }
});

// Note: Emergency fix button removed - page is working correctly

// Review Modal Function
async function showReviewModal(jobId, revieweeId, revieweeName) {
  // Remove any existing review modals
  document.querySelectorAll('[id^="reviewModalOverlay"]').forEach(ov => {
    if (ov && ov.parentNode) ov.remove();
  });
  
  const overlay = document.createElement("div");
  overlay.id = "reviewModalOverlay";
  overlay.className = "modal-overlay";
  overlay.style.zIndex = "10000";
  
  const modal = document.createElement("div");
  modal.className = "modal-content";
  modal.style.maxWidth = "500px";
  modal.style.width = "90%";
  modal.style.padding = "1.5rem";
  
  const title = document.createElement("h2");
  title.style.margin = "0 0 1rem 0";
  title.textContent = "Leave a Review";
  modal.appendChild(title);
  
  const subtitle = document.createElement("div");
  subtitle.className = "muted";
  subtitle.style.marginBottom = "1.5rem";
  subtitle.textContent = `How was your experience with ${revieweeName}?`;
  modal.appendChild(subtitle);
  
  // Star rating
  const starsContainer = document.createElement("div");
  starsContainer.style.marginBottom = "1rem";
  starsContainer.style.display = "flex";
  starsContainer.style.gap = "0.5rem";
  starsContainer.style.justifyContent = "center";
  
  let selectedStars = 0;
  const stars = [];
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement("button");
    star.textContent = "‚òÖ";
    star.style.fontSize = "2rem";
    star.style.background = "none";
    star.style.border = "none";
    star.style.cursor = "pointer";
    star.style.color = "#d1d5db";
    star.style.padding = "0";
    star.dataset.rating = i;
    
    star.addEventListener("mouseenter", () => {
      for (let j = 1; j <= i; j++) {
        stars[j - 1].style.color = "#fbbf24";
      }
    });
    
    star.addEventListener("mouseleave", () => {
      stars.forEach((s, idx) => {
        s.style.color = idx < selectedStars ? "#fbbf24" : "#d1d5db";
      });
    });
    
    star.addEventListener("click", () => {
      selectedStars = i;
      stars.forEach((s, idx) => {
        s.style.color = idx < selectedStars ? "#fbbf24" : "#d1d5db";
      });
    });
    
    stars.push(star);
    starsContainer.appendChild(star);
  }
  modal.appendChild(starsContainer);
  
  // Review text
  const textLabel = document.createElement("label");
  textLabel.textContent = "Your review (min 10 characters):";
  textLabel.style.display = "block";
  textLabel.style.marginBottom = "0.5rem";
  textLabel.style.fontWeight = "600";
  modal.appendChild(textLabel);
  
  const textArea = document.createElement("textarea");
  textArea.placeholder = "Tell others about your experience...";
  textArea.style.width = "100%";
  textArea.style.minHeight = "100px";
  textArea.style.padding = "0.75rem";
  textArea.style.border = "1px solid var(--border)";
  textArea.style.borderRadius = "6px";
  textArea.style.fontFamily = "inherit";
  textArea.style.fontSize = "0.9rem";
  textArea.style.marginBottom = "1rem";
  modal.appendChild(textArea);
  
  // Buttons
  const buttonRow = document.createElement("div");
  buttonRow.style.display = "flex";
  buttonRow.style.gap = "0.5rem";
  
  const submitBtn = document.createElement("button");
  submitBtn.className = "btn btn-primary";
  submitBtn.style.flex = "1";
  submitBtn.textContent = "Submit Review";
  
  submitBtn.addEventListener("click", async () => {
    if (selectedStars === 0) {
      showToast("Please select a star rating");
      return;
    }
    
    const text = textArea.value.trim();
    if (text.length < 10) {
      showToast("Please write at least 10 characters");
      textArea.focus();
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    
    try {
      const token = localStorage.getItem("hustl_token");
      if (!token) {
        throw new Error("You must be logged in to submit a review");
      }
      
      const response = await fetch("/reviews", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          jobId,
          revieweeId,
          stars: selectedStars,
          text,
          photos: []
        })
      });
      
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || "Failed to submit review");
      }
      
      showToast("‚úì Review submitted! Thank you.");
      
      // Close the review modal
      overlay.remove();
      document.body.style.overflow = "";
      
      // Refresh jobs list and profile to update job status
      renderJobs();
      renderProfile();
    } catch (error) {
      console.error("Error submitting review:", error);
      showToast("Error: " + (error.message || "Failed to submit review"));
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Review";
    }
  });
  
  buttonRow.appendChild(submitBtn);
  
  const skipBtn = document.createElement("button");
  skipBtn.className = "btn outline";
  skipBtn.textContent = "Skip";
  skipBtn.addEventListener("click", () => {
    overlay.remove();
    document.body.style.overflow = "";
    renderJobs();
  });
  buttonRow.appendChild(skipBtn);
  
  modal.appendChild(buttonRow);
  
  // Close button
  const closeBtn = document.createElement("button");
  closeBtn.className = "modal-close";
  closeBtn.innerHTML = "√ó";
  closeBtn.addEventListener("click", () => {
    overlay.remove();
    document.body.style.overflow = "";
  });
  modal.appendChild(closeBtn);
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  document.body.style.overflow = "hidden";
  
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) {
      overlay.remove();
      document.body.style.overflow = "";
    }
  });
  
  // Focus textarea
  setTimeout(() => textArea.focus(), 100);
}

    // Initialize back button handlers for mobile messages
    function initMobileMessageBackButtons() {
      const messagesBackBtn = document.getElementById("messagesBackBtn");
      const conversationBackBtn = document.getElementById("conversationBackBtn");
      
      if (messagesBackBtn) {
        messagesBackBtn.addEventListener("click", () => {
          // Go back to previous view (home or jobs)
          setView("home");
        });
      }
      
      if (conversationBackBtn) {
        conversationBackBtn.addEventListener("click", () => {
          // Go back to conversation list
          const messagesView = document.getElementById("view-messages");
          if (messagesView) {
            messagesView.classList.remove("mobile-conversation-open");
            activeConversationJobId = null;
            renderMessagesView();
          }
        });
      }
    }
    
    // Initialize back buttons when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMobileMessageBackButtons);
    } else {
      initMobileMessageBackButtons();
    }

// Run body cleanup on load
(function() {
  try {
    var stuck = document.querySelectorAll('.modal-overlay, [id*="Modal"], [id*="Overlay"], [class*="overlay"], [class*="modal"]');
    stuck.forEach(function(e) { if(e && e.parentNode) e.remove(); });
    if(document.body) {
      document.body.style.cssText = 'overflow: visible !important; pointer-events: auto !important;';
    }
    if(document.documentElement) {
      document.documentElement.style.cssText = 'overflow: visible !important; pointer-events: auto !important;';
    }
    document.querySelectorAll('*').forEach(function(el) {
      if(el.style && el.style.pointerEvents === 'none') {
        el.style.pointerEvents = 'auto';
      }
    });
  } catch(e) {
    console.error('Body cleanup error (non-fatal):', e);
  }
})();

// Boot
loadState();
// Load saved mode
const savedMode = localStorage.getItem("hustl_userMode");
if (savedMode === "customer" || savedMode === "hustler") {
  userMode = savedMode;
}
// Initialize everything - wrapped in try/catch to prevent blocking errors
try {
  initAgeGate();
  initNav();
  initAuthCard();
  initJobsForm();
  initConversationInput();
  initFeedback();
  initStepByStepGuide();
  initHomeNotice();
  initHowItWorksToggle();
  initFooterLinks();
  initModeToggle(); // Make sure mode toggle is initialized
  checkAgeGate();
  handleStripeReturn();
  checkAutoCompleteJobs();
  setInterval(checkAutoCompleteJobs, 60 * 1000);
  
  // Periodically update unread message count (every 30 seconds)
  setInterval(() => {
    countUnreadMessages();
  }, 30 * 1000);
  
  // Initial unread count check on page load
  setTimeout(() => {
    countUnreadMessages();
  }, 1000);
  
  // Initialize notifications
  initNotifications();
  
  // Initialize search
  initJobSearch();
  
  // Initialize onboarding tour
  checkOnboardingTour();
  
  // Initialize error handling
  initErrorHandling();
  
  renderAll();
} catch (error) {
  console.error("Initialization error:", error);
  // Still try to render even if some init fails
  renderAll();
}

// ========== NOTIFICATIONS SYSTEM ==========
let notificationsPollInterval = null;
let readNotificationIds = JSON.parse(localStorage.getItem('readNotificationIds') || '[]');

function initNotifications() {
  const user = getCurrentUser();
  const container = document.getElementById('notificationsContainer');
  
  if (!user || !container) {
    if (container) container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  loadNotifications();
  
  // Poll for new notifications every 30 seconds
  notificationsPollInterval = setInterval(() => {
    loadNotifications();
  }, 30 * 1000);
}

async function loadNotifications() {
  try {
    const data = await window.hustlAPI.notifications.list();
    if (!data || !data.notifications) return;
    
    const notifications = data.notifications || [];
    const unreadCount = notifications.filter(n => !readNotificationIds.includes(n.id)).length;
    
    // Update badge
    const badge = document.getElementById('notificationsBadge');
    if (badge) {
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }
    
    // Store notifications for dropdown
    window.currentNotifications = notifications;
    
    // Render dropdown if open
    const dropdown = document.getElementById('notificationsDropdown');
    if (dropdown && dropdown.style.display !== 'none') {
      renderNotificationsDropdown();
    }
  } catch (error) {
    console.error('Error loading notifications:', error);
  }
}

function toggleNotificationsDropdown() {
  const dropdown = document.getElementById('notificationsDropdown');
  if (!dropdown) return;
  
  if (dropdown.style.display === 'none' || !dropdown.style.display) {
    dropdown.style.display = 'block';
    renderNotificationsDropdown();
  } else {
    dropdown.style.display = 'none';
  }
}

function renderNotificationsDropdown() {
  const list = document.getElementById('notificationsList');
  const empty = document.getElementById('notificationsEmpty');
  if (!list || !empty) return;
  
  const notifications = window.currentNotifications || [];
  
  if (notifications.length === 0) {
    list.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  
  list.style.display = 'block';
  empty.style.display = 'none';
  
  list.innerHTML = notifications.map(notif => {
    const isRead = readNotificationIds.includes(notif.id);
    const timeAgo = formatTimeAgo(new Date(notif.createdAt));
    return `
      <div class="notification-item ${!isRead ? 'unread' : ''}" onclick="handleNotificationClick('${notif.id}', '${(notif.link || '').replace(/'/g, "\\'")}')">
        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
          <div class="notification-icon">${notif.icon || 'üîî'}</div>
          <div class="notification-content" style="flex: 1;">
            <div class="notification-title">${escapeHtml(notif.title)}</div>
            <div class="notification-message">${escapeHtml(notif.message || '')}</div>
            <div class="notification-time">${timeAgo}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

async function handleNotificationClick(notificationId, link) {
  // Mark as read
  if (!readNotificationIds.includes(notificationId)) {
    readNotificationIds.push(notificationId);
    localStorage.setItem('readNotificationIds', JSON.stringify(readNotificationIds));
    
    try {
      await window.hustlAPI.notifications.markRead(notificationId);
    } catch (error) {
      console.error('Error marking notification as read:', error);
    }
    
    // Reload notifications to update badge
    loadNotifications();
    renderNotificationsDropdown();
  }
  
  // Navigate if link provided
  if (link && link !== 'undefined') {
    if (link.startsWith('/')) {
      // Internal link - extract view name
      const match = link.match(/\/(\w+)/);
      if (match) {
        setView(match[1]);
      }
    } else if (link.startsWith('http')) {
      window.location.href = link;
    }
  }
  
  // Close dropdown
  const dropdown = document.getElementById('notificationsDropdown');
  if (dropdown) dropdown.style.display = 'none';
}

async function markAllNotificationsRead() {
  try {
    await window.hustlAPI.notifications.markAllRead();
    
    // Mark all current notifications as read locally
    const notifications = window.currentNotifications || [];
    notifications.forEach(n => {
      if (!readNotificationIds.includes(n.id)) {
        readNotificationIds.push(n.id);
      }
    });
    
    localStorage.setItem('readNotificationIds', JSON.stringify(readNotificationIds));
    loadNotifications();
    renderNotificationsDropdown();
  } catch (error) {
    console.error('Error marking all notifications as read:', error);
  }
}

function formatTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return diffMins + 'm ago';
  if (diffHours < 24) return diffHours + 'h ago';
  if (diffDays < 7) return diffDays + 'd ago';
  return date.toLocaleDateString();
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Close notifications dropdown when clicking outside
document.addEventListener('click', (e) => {
  const container = document.getElementById('notificationsContainer');
  const dropdown = document.getElementById('notificationsDropdown');
  if (container && dropdown && !container.contains(e.target)) {
    dropdown.style.display = 'none';
  }
});

// Wire up notifications bell click
document.addEventListener('DOMContentLoaded', () => {
  const bell = document.getElementById('notificationsBell');
  if (bell) {
    bell.addEventListener('click', toggleNotificationsDropdown);
  }
});

// ========== SEARCH FUNCTIONALITY ==========
let searchDebounceTimeout = null;

function initJobSearch() {
  const searchInput = document.getElementById('jobsSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  
  if (!searchInput) return;
  
  // Search on input with debounce
  searchInput.addEventListener('input', (e) => {
    clearTimeout(searchDebounceTimeout);
    searchDebounceTimeout = setTimeout(() => {
      const value = e.target.value.trim();
      
      // Show/hide clear button
      if (clearBtn) {
        clearBtn.style.display = value ? 'block' : 'none';
      }
      
      // Trigger job reload if we're on jobs view
      if (document.getElementById('view-jobs')?.style.display !== 'none') {
        renderJobs(true); // Reset and reload
      }
    }, 300); // 300ms debounce
  });
  
  // Search on Enter key
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(searchDebounceTimeout);
      if (document.getElementById('view-jobs')?.style.display !== 'none') {
        renderJobs(true);
      }
    }
  });
}

function clearJobSearch() {
  const searchInput = document.getElementById('jobsSearchInput');
  const clearBtn = document.getElementById('clearSearchBtn');
  
  if (searchInput) {
    searchInput.value = '';
  }
  if (clearBtn) {
    clearBtn.style.display = 'none';
  }
  
  // Reload jobs
  if (document.getElementById('view-jobs')?.style.display !== 'none') {
    renderJobs(true);
  }
}

// ========== ERROR HANDLING HELPERS ==========
function initErrorHandling() {
  // Enhanced error messages already added via showToast override below
  // Loading states handled via button clicks
}

function setButtonLoading(button, loading) {
  if (!button) return;
  
  if (loading) {
    button.classList.add('btn-loading');
    button.disabled = true;
    button.dataset.originalText = button.textContent;
    button.textContent = 'Loading...';
  } else {
    button.classList.remove('btn-loading');
    button.disabled = false;
    if (button.dataset.originalText) {
      button.textContent = button.dataset.originalText;
      delete button.dataset.originalText;
    }
  }
}

// Override showToast to use better error handling
const originalShowToast = showToast;
window.showToast = function(msg) {
  // Convert errors to user-friendly messages
  if (typeof msg === 'string') {
    const lowerMsg = msg.toLowerCase();
    if (lowerMsg.includes('network') || lowerMsg.includes('fetch')) {
      msg = 'Connection error. Please check your internet and try again.';
    } else if (lowerMsg.includes('unauthorized') || lowerMsg.includes('401')) {
      msg = 'Please log in to continue.';
    } else if (lowerMsg.includes('forbidden') || lowerMsg.includes('403')) {
      msg = 'You don\'t have permission to do that.';
    } else if (lowerMsg.includes('not found') || lowerMsg.includes('404')) {
      msg = 'Item not found.';
    } else if (lowerMsg.includes('server error') || lowerMsg.includes('500')) {
      msg = 'Server error. Please try again later.';
    }
  }
  
  originalShowToast(msg);
};

// ========== USER ONBOARDING TOUR ==========
function checkOnboardingTour() {
  const tourCompleted = localStorage.getItem('onboardingTourCompleted');
  const user = getCurrentUser();
  
  if (!user || tourCompleted === 'true') {
    return; // Don't show tour if completed or not logged in
  }
  
  // Show tour on first login if not completed
  setTimeout(() => {
    showOnboardingTour();
  }, 2000); // Wait 2 seconds after page load
}

function showOnboardingTour() {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
  
  const modal = document.createElement('div');
  modal.style.cssText = 'background: white; border-radius: 12px; padding: 2rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);';
  
  let currentStep = 0;
  const steps = [
    {
      title: 'üëã Welcome to Hustl!',
      content: `
        <p style="margin: 1rem 0; line-height: 1.6;">
          Hustl connects customers who need help with hustlers ready to work. Let's take a quick tour of the main features!
        </p>
      `,
    },
    {
      title: 'üè† Home',
      content: `
        <p style="margin: 1rem 0; line-height: 1.6;">
          Start here! The home page shows an overview of how Hustl works. You can switch between <strong>Customer</strong> mode (to post jobs) and <strong>Hustler</strong> mode (to find jobs).
        </p>
      `,
    },
    {
      title: 'üíº Jobs',
      content: `
        <p style="margin: 1rem 0; line-height: 1.6;">
          Browse available jobs in your area. Jobs are sorted by distance, so the closest ones appear first. Use the search bar to find specific types of work.
        </p>
      `,
    },
    {
      title: '‚ûï Post a Job',
      content: `
        <p style="margin: 1rem 0; line-height: 1.6;">
          As a customer, post jobs you need done. Be specific about what you need, when you need it, and how much you'll pay. Hustlers will apply!
        </p>
      `,
    },
    {
      title: 'üí¨ Messages',
      content: `
        <p style="margin: 1rem 0; line-height: 1.6;">
          Communicate with hustlers or customers directly in the app. Each conversation is tied to a specific job.
        </p>
      `,
    },
    {
      title: 'üë§ Profile',
      content: `
        <p style="margin: 1rem 0; line-height: 1.6;">
          Complete your profile! Add a photo, bio, and location. Complete profiles get 3x more job offers. The bell icon shows your notifications.
        </p>
      `,
    },
  ];
  
  function renderStep() {
    const step = steps[currentStep];
    modal.innerHTML = `
      <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">${step.title}</h2>
      ${step.content}
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; gap: 1rem;">
        <button id="skipTourBtn" style="background: transparent; border: 1px solid #e5e7eb; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Skip Tour</button>
        <div style="display: flex; gap: 0.5rem;">
          <button id="prevTourBtn" style="background: #f3f4f6; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; ${currentStep === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${currentStep === 0 ? 'disabled' : ''}>Previous</button>
          <button id="nextTourBtn" style="background: #2563eb; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
            ${currentStep === steps.length - 1 ? 'Get Started!' : 'Next'}
          </button>
        </div>
      </div>
      <div style="text-align: center; margin-top: 1rem; font-size: 0.85rem; color: #6b7280;">
        ${currentStep + 1} of ${steps.length}
      </div>
    `;
    
    overlay.innerHTML = '';
    overlay.appendChild(modal);
    if (!document.body.contains(overlay)) {
      document.body.appendChild(overlay);
    }
    
    // Event listeners
    document.getElementById('skipTourBtn').onclick = () => {
      localStorage.setItem('onboardingTourCompleted', 'true');
      overlay.remove();
    };
    
    const prevBtn = document.getElementById('prevTourBtn');
    if (prevBtn) {
      prevBtn.onclick = () => {
        if (currentStep > 0) {
          currentStep--;
          renderStep();
        }
      };
    }
    
    document.getElementById('nextTourBtn').onclick = () => {
      if (currentStep < steps.length - 1) {
        currentStep++;
        renderStep();
      } else {
        localStorage.setItem('onboardingTourCompleted', 'true');
        overlay.remove();
      }
    };
  }
  
  renderStep();
  
  // Close on overlay click
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      localStorage.setItem('onboardingTourCompleted', 'true');
      overlay.remove();
    }
  });
}

// Expose functions globally
window.clearJobSearch = clearJobSearch;
window.toggleNotificationsDropdown = toggleNotificationsDropdown;
window.markAllNotificationsRead = markAllNotificationsRead;
window.handleNotificationClick = handleNotificationClick;
  </script>
</body>
</html>


