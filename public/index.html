
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Hustl ‚Äì Local help, real hustle [v2.0]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --text-main: #0f172a;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
      --radius: 10px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    
    /* VERSION 2.0 - PAGINATION UPDATE */

    a {
      color: inherit;
      text-decoration: none;
    }

    button {
      cursor: pointer;
      font-family: inherit;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-mark {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.08em;
      font-size: 0.9rem;
    }

    .logo-text-main {
      font-weight: 800;
      font-size: 1.15rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .logo-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .nav-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      font-size: 0.85rem;
    }

    .nav-tab {
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
    }

    .nav-tab.active {
      background: var(--primary-soft);
      color: var(--primary);
      border-color: var(--primary);
    }

    .auth-pill {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
    }

    .auth-pill button {
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.7rem;
      margin-left: 0.5rem;
    }

    main {
      flex: 1;
      padding: 1rem;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 1rem;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.04);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      color: var(--text-muted);
      background: #f9fafb;
    }

    .badge.hot {
      background: #fef2f2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .badge.status-open {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: var(--success);
    }

    .badge.status-assigned {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: var(--primary);
    }

    .badge.status-completed {
      background: #f5f3ff;
      border-color: #ddd6fe;
      color: #6d28d9;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .hero-heading {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .hero-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }

    .hero-cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.45rem 0.95rem;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .step-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .step-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .step-emoji {
      margin-right: 0.25rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.3rem;
    }

    .pill {
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      border: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .field {
      margin-bottom: 0.6rem;
    }

    label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      margin-bottom: 0.15rem;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 0.35rem 0.45rem;
      font-size: 0.8rem;
      font-family: inherit;
      background: #f9fafb;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .field-inline {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }

    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 0.2rem;
    }

    .job-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .job-card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.25rem;
    }

    .job-title {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .job-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .small-btn {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
    }

    .small-btn.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .job-detail {
      margin-top: 0.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.75rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }
/* High-contrast styling just for the job detail panel */
.job-detail-contrast {
  background: #111827;           /* light dark slate */
  color: #e5e7eb;                /* light text */
  border-color: #0b1220;
  box-shadow: 0 16px 40px rgba(0,0,0,0.35);
}

/* labels & muted text inside the dark panel */
.job-detail-contrast .detail-label { 
  color: #93c5fd;                /* soft blue for labels */
}

.job-detail-contrast .muted {
  color: #cbd5e1;                /* lighter muted */
}

/* buttons inside the dark panel */
.job-detail-contrast .small-btn.outline {
  border-color: #334155;
  color: #e5e7eb;
  background: transparent;
}
.job-detail-contrast .small-btn {
  background: #1f2937;           /* subtle dark chip */
  color: #e5e7eb;
}

/* links inside the dark panel */
.job-detail-contrast .linkish {
  color: #93c5fd;
}

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.3rem;
    }

    .detail-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .detail-value {
      font-weight: 500;
    }

    .chat-box {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.6rem;
      margin-top: 0.5rem;
      background: #fff;
    }

    .chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .chat-msg {
      font-size: 0.75rem;
      padding: 0.3rem 0.45rem;
      border-radius: 999px;
      max-width: 85%;
    }

    .chat-msg.me {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
    }

    .chat-msg.them {
      align-self: flex-start;
      background: #e5e7eb;
      color: var(--text-main);
    }

    .chat-meta {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.4rem;
    }

    .chat-input-row input {
      flex: 1;
    }

    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .stat-card {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 0.5rem;
      background: #f9fafb;
      font-size: 0.8rem;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .stat-value {
      font-weight: 600;
    }

    .profile-avatar {
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-muted);
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }

   .linkish {
  color: var(--primary);
  font-size: 0.75rem;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
  text-decoration-thickness: 1.5px;
  font-weight: 600;
}
.linkish:hover {
  text-decoration-thickness: 2px;
  opacity: 0.9;
}

    .job-status-group {
      margin-top: 0.25rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .job-status-group span {
      margin-right: 0.35rem;
      cursor: pointer;
    }

    .job-status-group span.active {
      color: var(--primary);
      font-weight: 600;
    }

    .feedback-note {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .about-text {
      font-size: 0.8rem;
      color: var(--text-main);
      line-height: 1.45;
      white-space: pre-line;
    }

    .legal-subtitle {
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 0.6rem;
    }

    .legal-text {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.5;
    }

    footer {
      border-top: 1px solid var(--border);
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: #111827;
      color: #e5e7eb;
    }

    .footer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }

    .footer-links span {
      cursor: pointer;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background: #111827;
      color: #f9fafb;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-size: 0.75rem;
      z-index: 50;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .age-gate-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.84);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .age-gate-card {
      background: #ffffff;
      padding: 1.2rem;
      border-radius: 14px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }

    .age-gate-card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.1rem;
    }

    .age-gate-card p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.7rem;
    }

    .age-gate-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 0.3rem;
    }

    @media (max-width: 800px) {
      header {
        flex-wrap: wrap;
        align-items: flex-start;
      }
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .jobs-list {
        max-height: none; /* let the page scroll instead of tiny inner scroll */
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="logo-row">
        <div class="logo-mark">H</div>
        <div>
         <div class="logo-text-main">
  HUSTL<span class="logo-tm">‚Ñ¢</span>
</div>
          <div class="logo-sub">Local help. Real hustle. Knoxville TN.</div>
        </div>
      </div>
      <nav class="nav-tabs">
        <button class="nav-tab active" data-view="home">Home</button>
        <button class="nav-tab" data-view="jobs">Jobs</button>
        <button class="nav-tab" data-view="post">Post a job</button>
        <button class="nav-tab" data-view="messages">Messages</button>
        <button class="nav-tab" data-view="profile">Profile</button>
        <button class="nav-tab" data-view="owner" id="ownerTab" style="display:none;">Owner</button>
        <button class="nav-tab" data-view="feedback">Feedback</button>
        <button class="nav-tab" data-view="about">About</button>
      </nav>
      <div class="auth-pill" id="authPill">
        Not signed in
        <button id="openAuthButton">Sign in / Create account</button>
      </div>
    </header>

    <main>
      <!-- AUTH CARD -->
      <section id="authSection" class="card" style="margin-bottom: 0.8rem;">
        <div class="card-header">
          <div class="card-title" id="authCardTitle">Create account</div>
          <div class="muted" id="authModeToggle">
            Already have an account?
            <span class="linkish" data-auth-mode="login">Log in</span>
          </div>
        </div>
        <div id="authBodyCreate">
          <div class="field-inline">
            <div class="field">
              <label for="createName">Name</label>
              <input id="createName" type="text" placeholder="Example: Jack Ready" />
            </div>
            <div class="field">
              <label for="createEmail">Email</label>
              <input id="createEmail" type="email" placeholder="you@example.com" />
            </div>
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="createPassword">Password (demo only)</label>
              <input id="createPassword" type="password" placeholder="At least 6 characters" />
            </div>
            <div class="field">
              <label for="createRole">Role</label>
              <select id="createRole">
                <option value="customer">Customer (post jobs)</option>
                <option value="hustler">Hustler (do jobs)</option>
              </select>
            </div>
          </div>
<!-- Payout preferences (required) -->
<div class="section-title" style="margin-top:0.6rem;">Payout preference</div>
<div class="field-inline">
  <div class="field">
    <label for="createPayoutMethod">Method (required)</label>
    <select id="createPayoutMethod">
      <option value="">Choose one</option>
      <option value="venmo">Venmo</option>
      <option value="cashapp">Cash App</option>
      <option value="zelle">Zelle</option>
    </select>
  </div>
  <div class="field">
    <label for="createPayoutHandle">Handle / Account (required)</label>
    <input id="createPayoutHandle" type="text" placeholder="@your-handle or phone/email for Zelle" />
  </div>
</div>
<div class="field">
  <label for="createPayoutName">Full name for payout (required only for Zelle)</label>
  <input id="createPayoutName" type="text" placeholder="Legal/Bank name used on the payout" />
</div>

          <div class="muted" style="margin-bottom:0.4rem;">
            This is a prototype ‚Äì accounts and passwords are stored only on this device for testing.
          </div>
          <button class="btn btn-primary" id="createAccountButton">Create account</button>
        </div>

        <div id="authBodyLogin" style="display:none;">
          <div class="field-inline">
            <div class="field">
              <label for="loginEmail">Email</label>
              <input id="loginEmail" type="email" placeholder="you@example.com" />
            </div>
            <div class="field">
              <label for="loginPassword">Password</label>
              <input id="loginPassword" type="password" placeholder="Your password" />
            </div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            This just matches what you used when creating your prototype account.
          </div>
          <button class="btn btn-primary" id="loginButton">Log in</button>
        </div>
      </section>

      <!-- HOME VIEW -->
      <section id="view-home">
        <div class="layout-grid">
          <div class="card">
            <div class="hero-heading">Find help or extra cash in a few taps.</div>
            <div class="hero-sub">
              Hustl connects people in Knoxville with local Hustlers for moving, dump runs,
              yard work, errands, and more ‚Äì with a simple flat fee and a 12% platform cut.
            </div>
            <div class="hero-cta-row">
              <button class="btn btn-primary" id="homeCtaPost">Post a job</button>
              <button class="btn btn-ghost" id="homeCtaBrowse">Browse jobs</button>
            </div>
            <div class="section-title">How Hustl works</div>
            <div class="step-row">
              <div class="step-card">
                <div class="step-title">
                  <span class="step-emoji">üìù</span>Post a job
                </div>
                <div>
                  Say what you need, where it is, and what you‚Äôll pay. Pick a category and add a note.
                </div>
              </div>
              <div class="step-card">
                <div class="step-title">
                  <span class="step-emoji">üí™</span>Hustlers apply
                </div>
                <div>
                  People nearby apply with a short message and can suggest a slightly different price.
                </div>
              </div>
              <div class="step-card">
                <div class="step-title">
                  <span class="step-emoji">‚úÖ</span>Accept and pay
                </div>
                <div>
                  You pick your Hustler. Once you accept, payment runs through Hustl (test mode here),
                  and then you handle the job together.
                </div>
              </div>
            </div>
            <div class="section-title" style="margin-top:0.8rem;">Why this exists</div>
            <div class="about-text">
Hustl was made because I want to see people be able to take off on side hustles.
I want to see college students and locals make more money on the side while still
having freedom. I did a lot of jobs like this myself and there was never a simple,
local way to find them. Hustl is my way of putting all those jobs in one place so
anyone can hop on, do solid work, and get paid.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Quick facts</div>
            </div>
            <ul class="muted" style="list-style:disc;margin-left:1rem;font-size:0.8rem;">
              <li>Currently focused on Knoxville, TN and nearby areas.</li>
              <li>Hustl takes a 15% cut on each job. The rest goes to the Hustler.</li>
              <li>Customers and Hustlers can chat inside each job to work out details.</li>
              <li>You must be 18+ to use Hustl. This prototype runs in your browser only.</li>
            </ul>
            <div class="section-title" style="margin-top:0.8rem;">Example categories</div>
            <div class="pill-row">
              <div class="pill">üöö Moving & dump runs</div>
              <div class="pill">üåø Yard work</div>
              <div class="pill">üßπ Clean-up & organizing</div>
              <div class="pill">üõ† Furniture & set-up</div>
              <div class="pill">‚≠ê Other local odd jobs</div>
            </div>
          </div>
        </div>
      </section>

      <!-- POST JOB VIEW (separate page) -->
      <section id="view-post" style="display:none;">
        <div class="card" id="jobFormCard">
          <div class="card-header">
            <div class="card-title">Post a job</div>
            <span class="badge">Customer only</span>
          </div>
          <div class="muted" style="margin-bottom:0.5rem;">
            You must be logged in as a <strong>Customer</strong> to post jobs. Hustlers will see them in the Jobs list.
          </div>

          <div class="field">
            <label for="jobTitle">Job title</label>
            <input id="jobTitle" type="text" placeholder="Example: Dump run from West Knoxville" />
          </div>

          <div class="field">
            <label for="jobCategory">Category</label>
            <select id="jobCategory">
              <option value="">Choose a category</option>
              <option value="moving">üöö Moving / Hauling</option>
              <option value="yard">üåø Yard work / Outdoor</option>
              <option value="cleaning">üßπ Cleaning / Organizing</option>
              <option value="furniture">üõ† Furniture / Assembly</option>
              <option value="other">‚≠ê Other</option>
            </select>
          </div>

          <div class="field">
            <label for="jobDescription">Description</label>
            <textarea id="jobDescription" placeholder="What needs to be done? Stairs, heavy items, timing, access, etc."></textarea>
          </div>

          <div class="field-inline">
            <div class="field">
              <label for="pickupArea">Pickup area / neighborhood</label>
              <input id="pickupArea" type="text" placeholder="Example: West Knoxville near UTK" />
            </div>
            <div class="field">
              <label for="pickupCity">City</label>
              <input id="pickupCity" type="text" placeholder="Example: Knoxville, TN" />
            </div>
          </div>

          <div class="field">
            <label for="pickupAddress">Pickup address (optional)</label>
            <input id="pickupAddress" type="text" placeholder="Street address (shared in chat or after accept)" />
          </div>

          <div class="field">
            <label>
              <input type="checkbox" id="jobOnSiteOnly" />
              This job happens only at the pickup location (no separate dropoff).
            </label>
          </div>

          <div id="dropoffFields">
            <div class="field-inline">
              <div class="field">
                <label for="dropoffArea">Dropoff area / neighborhood</label>
                <input id="dropoffArea" type="text" placeholder="Example: Fountain City" />
              </div>
              <div class="field">
                <label for="dropoffCity">Dropoff city</label>
                <input id="dropoffCity" type="text" placeholder="Example: Knoxville, TN" />
              </div>
            </div>
            <div class="field">
              <label for="dropoffAddress">Dropoff address (optional)</label>
              <input id="dropoffAddress" type="text" placeholder="Street address (shared in chat or after accept)" />
            </div>
          </div>

          <div class="section-title" style="margin-top:0.5rem;">Payment</div>
          <div class="field-inline">
            <div class="field">
              <label for="paymentType">Payment type</label>
              <select id="paymentType">
                <option value="flat">Flat amount (one-time)</option>
                <option value="hourly">Hourly + max hours</option>
              </select>
            </div>
            <div class="field" id="flatAmountField">
              <label for="flatAmount">Pay ($ flat)</label>
              <input id="flatAmount" type="number" min="0" step="1" value="80" />
            </div>
          </div>

          <div class="field-inline" id="hourlyFields" style="display:none;">
            <div class="field">
              <label for="hourlyRate">Hourly rate ($/hr)</label>
              <input id="hourlyRate" type="number" min="0" step="1" value="20" />
            </div>
            <div class="field">
              <label for="maxHours">Max hours</label>
              <input id="maxHours" type="number" min="1" step="1" value="3" />
            </div>
          </div>

          <div class="field">
            <label for="jobNotes">Extra notes (optional)</label>
            <textarea id="jobNotes" placeholder="Parking, gate codes, equipment, pets, any special requests."></textarea>
          </div>

          <div class="field">
            <label for="jobPhoto">Optional photo (not uploaded in this demo)</label>
            <input id="jobPhoto" type="file" accept="image/*" />
          </div>

          <button class="btn btn-primary" id="postJobButton">Post job to Hustl</button>

          <div class="muted" style="margin-top:0.4rem;">
            In this prototype, your job is stored only in this browser so you can test flows. In a live version,
            this would send email confirmations and save to a shared database.
          </div>
        </div>
      </section>

      <!-- JOBS VIEW -->
      <section id="view-jobs" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title" id="jobsCardTitle">Jobs near you (demo)</div>
            <span class="muted" id="jobsFilterSummary"></span>
          </div>
          <div class="job-status-group" id="jobsStatusFilter">
            <span data-status="all" class="active">All</span>
            <span data-status="open">Open</span>
            <span data-status="assigned">Assigned</span>
            <span data-status="completed">Completed</span>
          </div>
          <div class="jobs-list" id="jobsList"></div>
          <div id="jobDetailContainer"></div>
        </div>
      </section>

      <!-- MESSAGES VIEW -->
      <section id="view-messages" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Messages</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Each conversation is tied to a specific job. Think of it like texting, but only about that job.
            </div>
            <div class="jobs-list" id="conversationList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title" id="conversationTitle">Select a conversation</div>
            </div>
            <div id="conversationJobSummary" class="muted" style="margin-bottom:0.5rem;"></div>
            <div class="chat-box">
              <div class="chat-messages" id="conversationMessages"></div>
              <div class="chat-input-row">
                <input id="conversationInput" type="text" placeholder="Type a message..." />
                <button class="btn btn-primary" id="conversationSendButton">Send</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROFILE VIEW -->
      <section id="view-profile" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Your profile</div>
            </div>
            <div id="profileContent"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Your jobs</div>
            </div>
            <div class="jobs-list" id="profileJobsList"></div>
          </div>
        </div>
      </section>

      <!-- OWNER VIEW -->
      <section id="view-owner" style="display:none;">
        <div class="layout-grid">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Owner dashboard (demo)</div>
            </div>
            <div class="muted" style="margin-bottom:0.4rem;">
              Shows paid jobs, your 15% fee, and whether you‚Äôve sent the Hustler their payout.
            </div>
            <div id="ownerPaidList"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Assigned but not paid yet</div>
            </div>
            <div id="ownerAssignedList"></div>
          </div>
        </div>
      </section>

      <!-- FEEDBACK VIEW -->
      <section id="view-feedback" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Send feedback to Hustl</div>
          </div>
          <div class="muted" style="margin-bottom:0.4rem;">
            This isn‚Äôt a public review wall. It‚Äôs a private way to send feedback directly to the Hustl team
            (<strong>team.hustlapp@outlook.com</strong>) about bugs, ideas, or issues.
          </div>
          <div class="field-inline">
            <div class="field">
              <label for="feedbackName">Name (optional)</label>
              <input id="feedbackName" type="text" placeholder="Your name or leave blank" />
            </div>
            <div class="field">
              <label for="feedbackEmail">Email (optional)</label>
              <input id="feedbackEmail" type="email" placeholder="So we can reply if needed" />
            </div>
          </div>
          <div class="field">
            <label for="feedbackMessage">Feedback</label>
            <textarea id="feedbackMessage" placeholder="Tell us what‚Äôs working, what‚Äôs confusing, or what you‚Äôd love to see."></textarea>
          </div>
          <button class="btn btn-primary" id="feedbackButton">Send feedback</button>
          <div class="feedback-note">
            In this prototype, feedback is just stored on your device and not actually emailed. In a live version,
            this would send to the Hustl team inbox and be used to improve the app.
          </div>
        </div>
      </section>

          <!-- ABOUT / LEGAL VIEW -->
      <section id="view-about" style="display:none;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">About Hustl</div>
          </div>
          <div class="about-text">
Hustl was built in Knoxville, Tennessee with a simple goal:  
make it easier for people to help each other and make real money on the side.

If you need help ‚Äì moving a couch, doing a dump run, cleaning out a garage,
tackling yard work, or knocking out random errands ‚Äì you shouldn‚Äôt have to
blast group chats or scroll through sketchy posts. You should be able to
describe the job, set a fair price, and connect with someone local who‚Äôs
ready to work.

If you‚Äôre a Hustler, Hustl is a way to turn your time, truck, or muscle into
extra cash on your own schedule. No long-term commitments, no complicated
contracts ‚Äì just clear jobs, clear payouts, and a straightforward platform fee.

Hustl is also about supporting small, local businesses and solo operators.
As the platform grows, the same tools that help with one-time jobs can help
people build regular clients, repeat work, and real side-income here in the
community.

Post a job, apply to one, show up, do solid work, and get paid ‚Äì that‚Äôs the
heart of Hustl.
          </div>
        </div>
      </section>

    </main>

    <footer>
      <div class="footer-row">
        <div>¬© 2025 Hustl. All rights reserved.</div>
        <div class="footer-links">
          <span id="footerTermsLink">Terms of Use</span>
          <span>‚Ä¢</span>
          <span id="footerPrivacyLink">Privacy Policy</span>
          <span>‚Ä¢</span>
          <span>team.hustlapp@outlook.com</span>
          <span>¬∑</span>
          <span>@team.hustlapp</span>
        </div>
      </div>
    </footer>

       <div class="toast" id="toast"></div>

    <!-- Age gate disabled: popup hidden -->
    <div class="age-gate-overlay" id="ageGate" style="display:none;">
      <div class="age-gate-card">
        <h2>Are you 18 or older?</h2>
        <p>
          Hustl is for adults only. By continuing, you confirm that you are at least 18 years old
          and understand this is a prototype, not a fully live service.
        </p>
        <div class="age-gate-buttons">
          <button class="btn btn-primary" id="ageYesButton">Yes, I‚Äôm 18+</button>
          <button class="btn btn-ghost" id="ageNoButton">No</button>
        </div>
        <div class="muted" style="margin-top:0.4rem;">
          If you tap ‚ÄúNo‚Äù, we‚Äôll just hide the app. You can come back when you‚Äôre older.
        </div>
      </div>
    </div>
  </div>

<!-- Backend API Configuration -->
<script>
  // Set your Railway backend URL here
  window.HUSTL_CONFIG = {
    API_URL: 'https://hustl-production.up.railway.app' // Railway backend URL
  };
  
  // Auto-detect localhost for development
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    window.HUSTL_CONFIG.API_URL = 'http://localhost:4000';
  }
</script>
<script src="/api-integration.js?v=2"></script>
<script>
  // Backend API configuration - using NestJS API with Neon database
  // No Supabase needed - we use Railway backend with Neon PostgreSQL
  
  const STORAGE_KEY = "hustl_state_v3";
    // Get backend URL from config or default
    const BACKEND_URL = (window.HUSTL_CONFIG && window.HUSTL_CONFIG.API_URL) || 
                        (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                          ? 'http://localhost:4000' 
                          : 'https://hustl-production.up.railway.app');

    // üîî Auto-complete after 72 hours of no customer response
    const AUTO_COMPLETE_HOURS = 72;
    const AUTO_COMPLETE_MS = AUTO_COMPLETE_HOURS * 60 * 60 * 1000;

    let state = {
      users: [],
      currentUserId: null,
      jobs: [],
      feedback: [],
    };

    let activeView = "home";
    let activeJobsStatusFilter = "all";
    let activeConversationJobId = null;
    
    // Pagination state
    let currentJobsPage = 1;
    let jobsPagination = { hasMore: false };
    let allLoadedJobs = []; // Always initialize as empty array

    /* ---------- Utilities ---------- */

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          state = JSON.parse(raw);
        }
      } catch (e) {
        console.error("Error loading state", e);
      }
    }

    function getCurrentUser() {
      return state.users.find((u) => u.id === state.currentUserId) || null;
    }

    function generateId(prefix) {
      return (
        prefix +
        "_" +
        Date.now().toString(36) +
        "_" +
        Math.random().toString(36).slice(2, 8)
      );
    }

    function formatMoney(amount) {
      const n = Number(amount) || 0;
      return "$" + n.toFixed(2);
    }

    function timeAgo(timestamp) {
      if (!timestamp) return "";
      const now = Date.now();
      const diffMs = now - timestamp;
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return "just now";
      if (diffMin < 60) return diffMin + " min ago";
      const diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return diffHr + " hr ago";
      const diffDay = Math.floor(diffHr / 24);
      if (diffDay === 1) return "yesterday";
      return diffDay + " days ago";
    }

    let toastTimeout = null;
    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        el.classList.remove("show");
      }, 2200);
    }

    // ‚è± Auto-complete checker: if Hustler marked finished and no dispute + no response in time
    function checkAutoCompleteJobs() {
      const now = Date.now();
      let changed = false;

      state.jobs.forEach((job) => {
        if (
          job &&
          job.status === "assigned" &&
          job.completionRequestedAt &&
          !job.dispute &&
          !job.autoCompleted
        ) {
          if (now - job.completionRequestedAt >= AUTO_COMPLETE_MS) {
            job.status = "completed";// If there's a hustler, this will now appear in Owner payout queue
if (job.acceptedHustlerId) {
  console.log("Job moved to payout queue:", job.id);
}

            job.autoCompleted = true;
            changed = true;
          }
        }
      });

      if (changed) {
        saveState();
        renderAll();
      }
    }

    /* ---------- Age gate (disabled) ---------- */

    function checkAgeGate() {
      // Always keep it hidden
      const overlay = document.getElementById("ageGate");
      if (overlay) overlay.style.display = "none";
    }

    function initAgeGate() {
      // No-op ‚Äì age gate disabled
    }

    /* ---------- View navigation ---------- */

    function setView(view) {
      activeView = view;
      document
        .querySelectorAll("[id^='view-']")
        .forEach((sec) => (sec.style.display = "none"));
      const target = document.getElementById("view-" + view);
      if (target) target.style.display = "block";

      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.view === view);
      });

      renderAll();
    }

    /* ---------- Auth visibility ---------- */

    async function renderAuthSectionVisibility() {
  const authSection = document.getElementById("authSection");
  const user = await window.hustlAPI.auth.getCurrentUser();
  authSection.style.display = user ? "none" : "block";
}

    
/* ---------- Auth ---------- */

async function renderAuthPill() {
  const pill = document.getElementById("authPill");
  const user = await window.hustlAPI.auth.getCurrentUser();

  if (!user) {
    pill.innerHTML =
      'Not signed in <button id="openAuthButton">Sign in / Create account</button>';

    const openBtn = document.getElementById("openAuthButton");
    if (openBtn) {
      openBtn.addEventListener("click", () => {
        document
          .getElementById("authSection")
          .scrollIntoView({ behavior: "smooth" });
      });
    }
  } else {
    const displayName = user.name || user.email;
    const role = user.roles && user.roles.length > 0 ? user.roles[0].toLowerCase() : "user";
    pill.innerHTML =
      `Signed in as <strong>${displayName}</strong> ¬∑ ${role}` +
      '<button id="logoutButton">Log out</button>';

    const logoutBtn = document.getElementById("logoutButton");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        await window.hustlAPI.auth.signOut();
        showToast("Logged out.");
        renderAll();
      });
    }
  }
}

function initAuthCard() {
  const authTitle = document.getElementById("authCardTitle");
  const authToggle = document.getElementById("authModeToggle");
  const authBodyCreate = document.getElementById("authBodyCreate");
  const authBodyLogin = document.getElementById("authBodyLogin");
  let mode = "create";

  function wireToggle() {
    const span = authToggle.querySelector("span.linkish");
    if (span) {
      span.addEventListener("click", (e) => {
        const m = e.target.dataset.authMode;
        setMode(m);
      });
    }
  }

  function setMode(next) {
    mode = next;
    if (mode === "create") {
      authTitle.textContent = "Create account";
      authBodyCreate.style.display = "";
      authBodyLogin.style.display = "none";
      authToggle.innerHTML =
        'Already have an account? <span class="linkish" data-auth-mode="login">Log in</span>';
    } else {
      authTitle.textContent = "Log in";
      authBodyCreate.style.display = "none";
      authBodyLogin.style.display = "";
      authToggle.innerHTML =
        'Need a new account? <span class="linkish" data-auth-mode="create">Create one</span>';
    }
    wireToggle();
  }

  setMode("create");

document.getElementById("createAccountButton").addEventListener("click", async () => {
  const name = document.getElementById("createName").value.trim();
  const email = document.getElementById("createEmail").value.trim();
  const password = document.getElementById("createPassword").value.trim();
  const role = document.getElementById("createRole").value;

  const payoutMethod = document.getElementById("createPayoutMethod").value;
  const payoutHandle = document.getElementById("createPayoutHandle").value.trim();
  const payoutName = document.getElementById("createPayoutName").value.trim();

  if (!name || !email || !password) {
    showToast("Please fill name, email, and password.");
    return;
  }
  if (password.length < 8) {
    showToast("Password should be at least 8 characters.");
    return;
  }
  if (!payoutMethod) {
    showToast("Choose a payout method.");
    return;
  }
  if (!payoutHandle) {
    showToast("Enter your payout handle/account.");
    return;
  }
  if (payoutMethod === "zelle" && !payoutName) {
    showToast("Enter the payout name for Zelle.");
    return;
  }

  // Generate username from email (take part before @, make alphanumeric)
  let username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '');
  // Ensure it's at least 3 characters and max 20
  if (username.length < 3) {
    username = username + '123';
  }
  if (username.length > 20) {
    username = username.substring(0, 20);
  }
  // Add random suffix to ensure uniqueness
  const randomSuffix = Math.floor(Math.random() * 1000);
  username = username + randomSuffix;

  try {
    // Use backend API for signup (simple - no city/zip needed)
    const result = await window.hustlAPI.auth.signUp(
      email,
      password,
      name,
      username,
      role
    );

    showToast("Account created.");
    setView("jobs");
    renderAll();
  } catch (error) {
    console.error("Sign up error:", error);
    // Filter out any city/zip related error messages
    let errorMsg = error.message || "Unknown error";
    const lowerMsg = errorMsg.toLowerCase();
    if (lowerMsg.includes('zip') || lowerMsg.includes('city') || lowerMsg.includes('location')) {
      errorMsg = "Account creation failed. Please try again.";
    }
    showToast("Sign up error: " + errorMsg);
  }
});

  document
    .getElementById("loginButton")
    .addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password =
        document.getElementById("loginPassword").value.trim();
      if (!email || !password)
        return showToast("Enter email and password.");

      try {
        await window.hustlAPI.auth.signIn(email, password);
        showToast("Logged in.");
        setView("jobs");
        renderAll();
      } catch (error) {
        showToast("Login error: " + (error.message || "Unknown error"));
      }
    });
}

    /* ---------- Jobs ---------- */

    function clearJobForm() {
      document.getElementById("jobTitle").value = "";
      document.getElementById("jobCategory").value = "";
      document.getElementById("jobDescription").value = "";
      document.getElementById("pickupArea").value = "";
      document.getElementById("pickupCity").value = "";
      document.getElementById("pickupAddress").value = "";
      document.getElementById("jobOnSiteOnly").checked = false;
      document.getElementById("dropoffArea").value = "";
      document.getElementById("dropoffCity").value = "";
      document.getElementById("dropoffAddress").value = "";
      document.getElementById("paymentType").value = "flat";
      document.getElementById("flatAmount").value = "80";
      document.getElementById("hourlyRate").value = "20";
      document.getElementById("maxHours").value = "3";
      document.getElementById("jobNotes").value = "";
      document.getElementById("jobPhoto").value = "";
      document.getElementById("flatAmountField").style.display = "block";
      document.getElementById("hourlyFields").style.display = "none";
      document.getElementById("dropoffFields").style.display = "block";
    }
    function initJobsForm() {
      const jobOnSiteOnly = document.getElementById("jobOnSiteOnly");
      const dropoffFields = document.getElementById("dropoffFields");
      jobOnSiteOnly.addEventListener("change", () => {
        dropoffFields.style.display = jobOnSiteOnly.checked ? "none" : "block";
      });

      const paymentTypeSelect = document.getElementById("paymentType");
      const flatField = document.getElementById("flatAmountField");
      const hourlyFields = document.getElementById("hourlyFields");
      paymentTypeSelect.addEventListener("change", () => {
        if (paymentTypeSelect.value === "flat") {
          flatField.style.display = "block";
          hourlyFields.style.display = "none";
        } else {
          flatField.style.display = "none";
          hourlyFields.style.display = "grid";
        }
      });

      document
        .getElementById("postJobButton")
        .addEventListener("click", async () => {
          const user = await window.hustlAPI.auth.getCurrentUser();
          if (!user)
            return showToast(
              "You must be logged in as a Customer to post jobs."
            );

          const userRole = user.roles && user.roles.length > 0 ? user.roles[0].toLowerCase() : null;
          if (userRole !== "customer")
            return showToast("Switch your role to Customer to post.");

          const title = document.getElementById("jobTitle").value.trim();
          const category = document.getElementById("jobCategory").value;
          const desc = document.getElementById("jobDescription").value.trim();
          const pickupArea = document
            .getElementById("pickupArea")
            .value.trim();
          const pickupCity = document
            .getElementById("pickupCity")
            .value.trim();
          const pickupAddress = document
            .getElementById("pickupAddress")
            .value.trim();
          const onSiteOnly =
            document.getElementById("jobOnSiteOnly").checked;
          const dropoffArea = document
            .getElementById("dropoffArea")
            .value.trim();
          const dropoffCity = document
            .getElementById("dropoffCity")
            .value.trim();
          const dropoffAddress = document
            .getElementById("dropoffAddress")
            .value.trim();
          const paymentType =
            document.getElementById("paymentType").value;
          const flatAmount = Number(
            document.getElementById("flatAmount").value
          );
          const hourlyRate = Number(
            document.getElementById("hourlyRate").value
          );
          const maxHours = Number(
            document.getElementById("maxHours").value
          );
          const notes = document
            .getElementById("jobNotes")
            .value.trim();

          if (!title || !category || !desc)
            return showToast(
              "Please fill title, category, and description."
            );

          let flat_amount_cents = null,
            hourly_rate_cents = null;
          if (paymentType === "flat") {
            if (!flatAmount || flatAmount <= 0)
              return showToast("Flat amount must be > 0.");
            flat_amount_cents = Math.round(flatAmount * 100);
          } else {
            if (
              !hourlyRate ||
              hourlyRate <= 0 ||
              !maxHours ||
              maxHours <= 0
            )
              return showToast(
                "Hourly rate and max hours must be valid."
              );
            hourly_rate_cents = Math.round(hourlyRate * 100);
          }

          try {
            const jobData = {
              title,
              category,
              description: desc,
              pickup_area: pickupArea,
              pickup_city: pickupCity,
              pickup_address: pickupAddress,
              on_site_only: onSiteOnly,
              dropoff_area: onSiteOnly ? null : dropoffArea,
              dropoff_city: onSiteOnly ? null : dropoffCity,
              dropoff_address: onSiteOnly ? null : dropoffAddress,
              payment_type: paymentType,
              flat_amount_cents,
              hourly_rate_cents,
              max_hours: paymentType === "hourly" ? maxHours : null,
              notes,
            };

            await window.hustlAPI.jobs.create(jobData);

            showToast("Job posted.");
            setView("jobs");
            clearJobForm();
            renderJobs();
          } catch (error) {
            console.error("Post job error:", error);
            showToast("Post error: " + (error.message || "Unknown error"));
          }
        });
    }

    
async function renderJobs(reset = false) {
  console.log('üîµ NEW RENDERJOBS VERSION LOADED - v2.0');
  const jobsList = document.getElementById("jobsList");
  const jobsCardTitle = document.getElementById("jobsCardTitle");
  const jobsFilterSummary = document.getElementById("jobsFilterSummary");

  // Reset pagination if needed
  if (reset) {
    currentJobsPage = 1;
    allLoadedJobs = [];
    if (jobsList) jobsList.innerHTML = ""; // Clear existing jobs
  }

  try {
    // Get saved zip filter
    const savedZip = localStorage.getItem('savedZipFilter') || '';
    
    // Build filters for API
    const filters = {
      page: currentJobsPage,
      limit: 20,
    };
    
    if (savedZip) {
      filters.zip = savedZip;
    }

    // Load jobs from API (use window.hustlAPI if available, otherwise fallback)
    let response;
    if (window.hustlAPI && window.hustlAPI.jobs) {
      response = await window.hustlAPI.jobs.list(filters);
    } else {
      // Fallback: Try direct API call
      const params = new URLSearchParams();
      if (filters.page) params.append('page', filters.page);
      if (filters.limit) params.append('limit', filters.limit);
      if (filters.zip) params.append('zip', filters.zip);
      
      const apiResponse = await fetch(`${BACKEND_URL}/api/jobs?${params.toString()}`);
      response = await apiResponse.json();
    }
    
    // Handle paginated response - ensure we always have an array
    let newJobs = [];
    if (response) {
      console.log('[renderJobs] Response type:', typeof response, 'Is array:', Array.isArray(response));
      // New API format: response has jobs and pagination properties
      if (response.jobs && Array.isArray(response.jobs)) {
        newJobs = response.jobs;
        if (response.pagination) {
          jobsPagination = response.pagination;
        }
        console.log('[renderJobs] Using response.jobs, length:', newJobs.length);
      } else if (Array.isArray(response)) {
        // Old format: response is directly an array
        newJobs = response;
        console.log('[renderJobs] Using response as array, length:', newJobs.length);
      } else if (Array.isArray(response.data)) {
        // Alternative format: response.data is an array
        newJobs = response.data;
        console.log('[renderJobs] Using response.data, length:', newJobs.length);
      } else {
        console.warn('[renderJobs] Unexpected response format:', response);
      }
    } else {
      console.warn('[renderJobs] No response received');
    }
    
    console.log('[renderJobs] newJobs is array:', Array.isArray(newJobs), 'length:', newJobs.length);
    
    const pagination = (response && response.pagination) || jobsPagination || { hasMore: false };
    
    // Ensure allLoadedJobs is always an array
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('[renderJobs] allLoadedJobs was not an array, resetting');
      allLoadedJobs = [];
    }
    
    // Ensure newJobs is an array before spreading
    if (!Array.isArray(newJobs)) {
      console.warn('[renderJobs] newJobs was not an array, resetting');
      newJobs = [];
    }
    
    // Append new jobs to existing list
    allLoadedJobs = [...allLoadedJobs, ...newJobs];
    console.log('[renderJobs] allLoadedJobs after append, length:', allLoadedJobs.length, 'is array:', Array.isArray(allLoadedJobs));
    jobsPagination = pagination;

    // Filter by status (client-side) - ensure filteredJobs is always an array
    // Double-check allLoadedJobs is an array before filtering
    if (!Array.isArray(allLoadedJobs)) {
      console.warn('allLoadedJobs is not an array, resetting to empty array');
      allLoadedJobs = [];
    }
    
    let filteredJobs = allLoadedJobs;
    if (activeJobsStatusFilter === "all") {
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => j.status !== "COMPLETED") : [];
    } else if (activeJobsStatusFilter) {
      filteredJobs = Array.isArray(allLoadedJobs) ? allLoadedJobs.filter((j) => j.status === activeJobsStatusFilter) : [];
    }
    
    // Final safety check
    if (!Array.isArray(filteredJobs)) {
      console.warn('filteredJobs is not an array, resetting to empty array');
      filteredJobs = [];
    }

    // Get user role for card title
    let role = null;
    try {
      if (window.hustlAPI && window.hustlAPI.auth) {
        const user = await window.hustlAPI.auth.getCurrentUser();
        role = user?.roles?.[0] || null;
      }
    } catch (e) {
      console.error("Error getting user role:", e);
    }
    
    // Update card title
    let cardTitle = "Jobs near you";
    if (role === "CUSTOMER" || role === "customer") cardTitle = "Your jobs & local jobs";
    if (role === "HUSTLER" || role === "hustler") cardTitle = "Jobs you can apply for";
    if (jobsCardTitle) jobsCardTitle.textContent = cardTitle;

    // Update summary
    if (jobsFilterSummary) {
      jobsFilterSummary.textContent = filteredJobs.length === 0 
        ? "No jobs yet." 
        : `Showing ${filteredJobs.length} job(s)${pagination.total ? ` of ${pagination.total}` : ''}`;
    }

    if (filteredJobs.length === 0 && currentJobsPage === 1) {
      if (jobsList) jobsList.innerHTML = "<div class='muted'>No jobs found.</div>";
      return;
    }

    // Render each job card (only new ones if not resetting)
    filteredJobs.forEach((job) => {
      // Check if job card already exists
      if (!reset) {
        const existingCard = jobsList?.querySelector(`[data-job-id="${job.id}"]`);
        if (existingCard) return; // Skip if already rendered
      }

      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      // Top row: title and pay
      const titleRow = document.createElement("div");
      titleRow.className = "job-card-top";

      const titleEl = document.createElement("div");
      titleEl.className = "job-title";
      titleEl.textContent = job.title;
      titleRow.appendChild(titleEl);

      const pay = document.createElement("div");
      pay.className = "job-title";

      if (job.payType === "flat") {
        const total = job.amount || 0;
        pay.textContent = `$${total.toFixed(2)}`;
      } else {
        const hr = job.hourlyRate || 0;
        const maxH = job.estHours || 0;
        pay.textContent = `$${hr.toFixed(2)}/hr ¬∑ max ${maxH}h`;
      }
      titleRow.appendChild(pay);
      card.appendChild(titleRow);

      // Category + time
      const meta = document.createElement("div");
      meta.className = "job-meta";

      const cat =
        job.category === "moving"
          ? "üöö moving"
          : job.category === "yard"
          ? "üåø yard"
          : job.category === "cleaning"
          ? "üßπ cleaning"
          : job.category === "furniture"
          ? "üõ† furniture"
          : "‚≠ê other";

      const createdMs = job.createdAt
        ? new Date(job.createdAt).getTime()
        : Date.now();

      meta.textContent = `${cat} ‚Ä¢ posted ${timeAgo(createdMs)}`;
      card.appendChild(meta);

      // Location line
      const loc = document.createElement("div");
      loc.className = "job-meta";

      const requirements = job.requirements || {};
      if (requirements.onSiteOnly || job.onSiteOnly) {
        loc.textContent = `üìç ${requirements.pickupArea || requirements.pickupCity || job.address || "TBD"} ‚Ä¢ On-site only`;
      } else {
        const pick = requirements.pickupArea || requirements.pickupCity || "TBD";
        const drop = requirements.dropoffArea || requirements.dropoffCity || "TBD";
        loc.textContent = `üìç Pickup: ${pick} ‚Üí Dropoff: ${drop}`;
      }
      card.appendChild(loc);

      // Actions row
      const actions = document.createElement("div");
      actions.className = "job-card-actions";

      const left = document.createElement("div");
      const statusBadge = document.createElement("span");
      statusBadge.className = "badge";

      if (job.status === "OPEN" || job.status === "open") {
        statusBadge.classList.add("status-open");
        statusBadge.textContent = "Open";
      } else if (job.status === "ASSIGNED" || job.status === "assigned") {
        statusBadge.classList.add("status-assigned");
        statusBadge.textContent = "Assigned";
      } else if (job.status === "COMPLETED" || job.status === "completed") {
        statusBadge.classList.add("status-completed");
        statusBadge.style.backgroundColor = "#9333ea";
        statusBadge.style.color = "#ffffff";
        statusBadge.textContent = "‚úì Completed!";
      } else {
        statusBadge.textContent = job.status || "Open";
      }

      left.appendChild(statusBadge);
      actions.appendChild(left);

      const right = document.createElement("div");
      const viewBtn = document.createElement("button");
      viewBtn.className = "small-btn outline";
      viewBtn.textContent = "View";
      viewBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        openJobDetails(job.id);
      });
      right.appendChild(viewBtn);
      actions.appendChild(right);

      card.appendChild(actions);

      // Clicking the whole card opens details
      card.addEventListener("click", () => openJobDetails(job.id));

      if (jobsList) jobsList.appendChild(card);
    });

    // Add "Load More" button if there are more pages
    const existingLoadMore = jobsList?.querySelector("#loadMoreJobsBtn");
    if (existingLoadMore) {
      existingLoadMore.remove();
    }

    if (pagination.hasMore && jobsList) {
      const loadMoreBtn = document.createElement("button");
      loadMoreBtn.id = "loadMoreJobsBtn";
      loadMoreBtn.className = "btn btn-primary";
      loadMoreBtn.style.width = "100%";
      loadMoreBtn.style.marginTop = "1rem";
      loadMoreBtn.textContent = "Load More Jobs";
      loadMoreBtn.addEventListener("click", async () => {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = "Loading...";
        currentJobsPage++;
        await renderJobs(false); // Don't reset, just append
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = "Load More Jobs";
      });
      jobsList.appendChild(loadMoreBtn);
    }

  } catch (error) {
    console.error("Error loading jobs:", error);
    if (jobsList) {
      jobsList.innerHTML = "<div class='muted'>Error loading jobs. Please try again.</div>";
    }
  }
}

    function openJobDetails(jobId, options = {}) {
      const job = state.jobs.find((j) => j.id === jobId);
      const container = document.getElementById("jobDetailContainer");
      const user = getCurrentUser();
      if (!job || !container) return;

      container.innerHTML = "";
      const detail = document.createElement("div");
      detail.className = "job-detail job-detail-contrast";


      const headerRow = document.createElement("div");
      headerRow.className = "detail-row";
      const title = document.createElement("div");
      title.innerHTML =
        "<strong>" +
        job.title +
        "</strong><br><span class='muted'>" +
        (job.category === "moving"
          ? "üöö moving / hauling"
          : job.category === "yard"
          ? "üåø yard / outdoor"
          : job.category === "cleaning"
          ? "üßπ cleaning / organizing"
          : job.category === "furniture"
          ? "üõ† furniture / setup"
          : "‚≠ê other") +
        " ‚Ä¢ " +
        (job.paymentType === "flat"
          ? formatMoney(job.flatAmount || 0) + " flat"
          : formatMoney(job.hourlyRate || 0) +
            "/hr ¬∑ max " +
            (job.maxHours || 0) +
            "h") +
        " ‚Ä¢ posted " +
        timeAgo(job.createdAt) +
        "</span>";
      headerRow.appendChild(title);

      const closeBtn = document.createElement("button");
      closeBtn.className = "small-btn outline";
      closeBtn.textContent = "Close";
      closeBtn.addEventListener("click", () => {
        container.innerHTML = "";
      });
      headerRow.appendChild(closeBtn);
      detail.appendChild(headerRow);

      const whoRow = document.createElement("div");
      whoRow.className = "detail-row";

      // Posted by (clickable profile)
      const left = document.createElement("div");
      const poster = state.users.find((u) => u.id === job.postedByUserId);
      const postedByWrap = document.createElement("div");
      postedByWrap.innerHTML = "<div class='detail-label'>Posted by</div>";
      const postedVal = document.createElement("div");
      postedVal.className = "detail-value";
      if (poster) {
        const link = document.createElement("span");
        link.className = "linkish";
        link.textContent = poster.name || "Unknown";
        link.addEventListener("click", () => openUserProfile(poster.id));
        postedVal.appendChild(link);
      } else {
        postedVal.textContent = "Unknown";
      }
      left.appendChild(postedByWrap);
      left.appendChild(postedVal);
      whoRow.appendChild(left);

           const right = document.createElement("div");
      let statusText =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";

      if (job.paymentStatus === "paid") {
        statusText += " ¬∑ Paid";
      }

      let statusHtml =
        "<div class='detail-label'>Status</div><div class='detail-value'>" +
        statusText +
        "</div>";

      if (job.status === "completed") {
        if (job.autoCompleted) {
          statusHtml +=
            "<div class='muted'>Job was auto-completed after no response from the customer.</div>";
        } else {
          statusHtml +=
            "<div class='muted'>Job marked done by the customer.</div>";
        }
      }

      right.innerHTML = statusHtml;
      whoRow.appendChild(right);
      detail.appendChild(whoRow);

      const locRow = document.createElement("div");
      locRow.className = "detail-row";
      const locLeft = document.createElement("div");
      locLeft.innerHTML =
        "<div class='detail-label'>Pickup</div><div class='detail-value'>" +
        (job.pickupArea || job.pickupCity || "TBD") +
        "</div>";
      locRow.appendChild(locLeft);

      const locRight = document.createElement("div");
      locRight.innerHTML =
        "<div class='detail-label'>Dropoff</div><div class='detail-value'>" +
        (job.onSiteOnly
          ? "On-site only"
          : job.dropoffArea || job.dropoffCity || "TBD") +
        "</div>";
      locRow.appendChild(locRight);
      detail.appendChild(locRow);

      const desc = document.createElement("div");
      desc.className = "muted";
      desc.style.marginTop = "0.35rem";
      desc.textContent = job.description || "";
      detail.appendChild(desc);

      if (job.notes) {
        const notesEl = document.createElement("div");
        notesEl.className = "muted";
        notesEl.style.marginTop = "0.25rem";
        notesEl.textContent = "Notes: " + job.notes;
        detail.appendChild(notesEl);
      }

      // Info when Hustler has marked job finished
      if (job.completionRequestedAt && job.status === "assigned" && !job.dispute) {
        const compInfo = document.createElement("div");
        compInfo.className = "muted";
        compInfo.style.marginTop = "0.25rem";
        compInfo.textContent =
          "Hustler marked this job as finished " +
          timeAgo(job.completionRequestedAt) +
          ". Waiting for the customer to confirm or report a problem.";
        detail.appendChild(compInfo);
      }

      // Dispute box (if any issue has been reported)
      if (job.dispute) {
        const dBox = document.createElement("div");
        dBox.className = "stat-card";
        dBox.style.marginTop = "0.4rem";
        const who =
          job.dispute.openedBy === "hustler"
            ? "Hustler"
            : "Customer";
        let html =
          "<div class='stat-label'>Issue reported</div>" +
          "<div class='muted'>" +
          who +
          " reported: " +
          (job.dispute.reason || "Issue") +
          "</div>";
        if (job.dispute.message) {
          html +=
            "<div class='muted' style='margin-top:0.2rem;'>" +
            job.dispute.message +
            "</div>";
        }
        dBox.innerHTML = html;
        detail.appendChild(dBox);
      }

            // Payment summary for customer
      if (user && user.id === job.postedByUserId) {
        const payBox = document.createElement("div");
        payBox.className = "stat-card";
        payBox.style.marginTop = "0.4rem";

        let total = 0;
        if (job.paymentType === "flat") {
          total = job.flatAmount || 0;
        } else {
          total = (job.hourlyRate || 0) * (job.maxHours || 0);
        }
        const platformPercent = 0.15;
        const platformFee = Math.round(total * platformPercent);
        const hustlerPayout = total - platformFee;

        let html =
          "<div class='stat-label'>Payment breakdown (demo)</div>" +
          "<div class='stat-value'>" +
          formatMoney(total) +
          " total</div>" +
          "<div class='muted'>Hustl fee (15%): " +
          formatMoney(platformFee) +
          " ¬∑ Hustler receives approx " +
          formatMoney(hustlerPayout) +
          "</div>";

        if (job.paymentStatus === "paid") {
          html +=
            "<div class='muted' style='margin-top:0.25rem;'>Marked as paid in this prototype only ‚Äì no real money moved.</div>";
        }

        payBox.innerHTML = html;
        detail.appendChild(payBox);

        if (
          job.status === "assigned" &&
          job.paymentStatus !== "paid" &&
          job.acceptedHustlerId
        ) {
          const btnRow = document.createElement("div");
          btnRow.style.marginTop = "0.4rem";
          const payBtn = document.createElement("button");
          payBtn.className = "btn btn-primary";
          payBtn.textContent = "Pay & lock in this job (Stripe test)";
          payBtn.addEventListener("click", () => startPayment(job.id));
          btnRow.appendChild(payBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.style.marginLeft = "0.5rem";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          btnRow.appendChild(deleteBtn);

          detail.appendChild(btnRow);
        } else if (
          job.status === "open" &&
          job.paymentStatus !== "paid"
        ) {
          const deleteRow = document.createElement("div");
          deleteRow.style.marginTop = "0.4rem";
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn outline";
          deleteBtn.textContent = "Delete job";
          deleteBtn.addEventListener("click", () => {
            if (!confirm("Delete this job? This cannot be undone.")) return;
            state.jobs = state.jobs.filter((j) => j.id !== job.id);
            saveState();
            showToast("Job deleted.");
            container.innerHTML = "";
            renderAll();
          });
          deleteRow.appendChild(deleteBtn);
          detail.appendChild(deleteRow);
        }
      }

            // Applicants & accept button (customer)
      if (user && user.id === job.postedByUserId) {
        const appsBox = document.createElement("div");
        appsBox.className = "stat-card";
        appsBox.style.marginTop = "0.5rem";

        if (!job.applicants || job.applicants.length === 0) {
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div><div class='muted'>No Hustlers have applied yet.</div>";
        } else {
          const hasAccepted = !!job.acceptedHustlerId;
          appsBox.innerHTML =
            "<div class='stat-label'>Applicants</div>" +
            (hasAccepted
              ? "<div class='muted'>You‚Äôve already accepted a Hustler for this job.</div>"
              : "<div class='muted'>Tap accept to assign.</div>");

          job.applicants.forEach((a) => {
            const u = state.users.find((x) => x.id === a.userId);
            const isAccepted = job.acceptedHustlerId === a.userId;

            const row = document.createElement("div");
            row.style.display = "flex";
            row.style.justifyContent = "space-between";
            row.style.alignItems = "center";
            row.style.marginTop = "0.25rem";
            row.style.gap = "0.4rem";

            const leftPart = document.createElement("div");

            // clickable name + role chip
            const line1 = document.createElement("div");
            const nameEl = document.createElement("span");
            nameEl.className = "linkish";
            nameEl.textContent = u?.name || "Unknown";
            if (u) {
              nameEl.addEventListener("click", () => openUserProfile(u.id));
            }
            line1.appendChild(nameEl);
            const roleChip = document.createElement("span");
            roleChip.className = "muted";
            roleChip.textContent =
              " ¬∑ " + (u?.role === "hustler" ? "Hustler" : "Customer");
            line1.appendChild(roleChip);

            const line2 = document.createElement("div");
            line2.className = "muted";
            line2.textContent =
              (a.message || "") +
              (a.suggestedPrice
                ? " ¬∑ suggested " + formatMoney(a.suggestedPrice)
                : "");

            const line3 = document.createElement("div");
            line3.className = "muted";
            line3.style.fontSize = "0.7rem";
            line3.style.marginTop = "0.1rem";
            line3.textContent = u?.bio
              ? "About: " + u.bio
              : "About: (no bio yet)";

            leftPart.appendChild(line1);
            leftPart.appendChild(line2);
            leftPart.appendChild(line3);
            row.appendChild(leftPart);

            const rightPart = document.createElement("div");

            if (isAccepted) {
              const badge = document.createElement("span");
              badge.className = "badge status-assigned";
              badge.textContent = "Hustler accepted";
              rightPart.appendChild(badge);
            } else if (!hasAccepted) {
              const acceptBtn = document.createElement("button");
              acceptBtn.className = "small-btn";
              acceptBtn.textContent = "Accept this Hustler";
              acceptBtn.addEventListener("click", () => {
                job.acceptedHustlerId = a.userId;
                job.status = "assigned";
                saveState();
                showToast("Hustler accepted for this job.");
                renderAll();
                openJobDetails(job.id);
              });
              rightPart.appendChild(acceptBtn);
            } else {
              const note = document.createElement("span");
              note.className = "muted";
              note.textContent = "Not selected";
              rightPart.appendChild(note);
            }

            row.appendChild(rightPart);
            appsBox.appendChild(row);
          });
        }
        detail.appendChild(appsBox);
      }


      // Apply area (hustler)
      if (
        user &&
        user.role === "hustler" &&
        job.status === "open" &&
        job.postedByUserId !== user.id
      ) {
        const already = job.applicants?.some((a) => a.userId === user.id);
        const applyBox = document.createElement("div");
        applyBox.className = "stat-card";
        applyBox.style.marginTop = "0.5rem";

        if (already) {
          applyBox.innerHTML =
            "<div class='stat-label'>Your application</div><div class='muted'>You‚Äôve already applied. Use job chat to send updates.</div>";
        } else {
          applyBox.innerHTML =
            "<div class='stat-label'>Apply for this job</div>";
          const msgField = document.createElement("textarea");
          msgField.placeholder =
            "Tell them when you can do it, if you have a truck, etc.";
          msgField.style.marginTop = "0.25rem";

          const priceField = document.createElement("input");
          priceField.type = "number";
          priceField.min = "0";
          priceField.step = "1";
          priceField.placeholder = "Suggested flat price (optional)";
          priceField.style.marginTop = "0.25rem";

          const btn = document.createElement("button");
          btn.className = "btn btn-primary";
          btn.style.marginTop = "0.4rem";
          btn.textContent = "Apply as a Hustler";
          btn.addEventListener("click", () => {
            const msg = msgField.value.trim();
            const suggestedPrice = Number(priceField.value) || null;
            job.applicants = job.applicants || [];
            job.applicants.push({
              userId: user.id,
              message: msg,
              suggestedPrice,
              createdAt: Date.now(),
            });
            saveState();
            showToast("Applied for job.");
            renderAll();
            openJobDetails(job.id);
          });

          applyBox.appendChild(msgField);
          applyBox.appendChild(priceField);
          applyBox.appendChild(btn);
        }

        detail.appendChild(applyBox);

        if (options.focusApply) {
          setTimeout(() => {
            applyBox.scrollIntoView({ behavior: "smooth" });
          }, 50);
        }
      }

      // Job chat
      const chatBox = document.createElement("div");
      chatBox.className = "chat-box";
      const messagesList = document.createElement("div");
      messagesList.className = "chat-messages";
      job.chatMessages = job.chatMessages || [];
      job.chatMessages.forEach((m) => {
        const msgEl = document.createElement("div");
        msgEl.className =
          "chat-msg " + (m.fromUserId === (user && user.id) ? "me" : "them");
        msgEl.textContent = m.text;
        messagesList.appendChild(msgEl);

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const sender = state.users.find((u) => u.id === m.fromUserId);
        meta.innerHTML = "";
        if (sender) {
          const link = document.createElement("span");
          link.className = "linkish";
          link.textContent = sender.name || "Unknown";
          link.addEventListener("click", () => openUserProfile(sender.id));
          meta.appendChild(link);
        } else {
          meta.append("Unknown");
        }
        meta.append(" ¬∑ " + timeAgo(m.createdAt));

        messagesList.appendChild(meta);
      });
      chatBox.appendChild(messagesList);

      const chatRow = document.createElement("div");
      chatRow.className = "chat-input-row";
      const chatInput = document.createElement("input");
      chatInput.type = "text";
      chatInput.placeholder =
        user && user.id
          ? "Type a quick update or question..."
          : "Log in to send messages.";
      if (!user) chatInput.disabled = true;

      const sendBtn = document.createElement("button");
      sendBtn.className = "btn btn-primary";
      sendBtn.textContent = "Send";
      if (!user) sendBtn.disabled = true;
      sendBtn.addEventListener("click", () => {
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        const txt = chatInput.value.trim();
        if (!txt) return;
        job.chatMessages.push({
          id: generateId("m"),
          jobId: job.id,
          fromUserId: user.id,
          text: txt,
          createdAt: Date.now(),
        });
        chatInput.value = "";
        saveState();
        openJobDetails(job.id);
      });

      chatRow.appendChild(chatInput);
      chatRow.appendChild(sendBtn);
      chatBox.appendChild(chatRow);

      detail.appendChild(chatBox);

      // Hustler actions around completion
      if (
        user &&
        job.status === "assigned" &&
        user.id === job.acceptedHustlerId
      ) {
        const hustlerRow = document.createElement("div");
        hustlerRow.style.marginTop = "0.45rem";

        if (!job.completionRequestedAt && !job.dispute) {
          const markFinishedBtn = document.createElement("button");
          markFinishedBtn.className = "small-btn";
          markFinishedBtn.textContent = "Mark job finished";
          markFinishedBtn.addEventListener("click", () => {
            job.completionRequestedAt = Date.now();
            job.completionRequesterId = user.id;
            job.autoCompleted = false;
            saveState();
            showToast("Marked finished. Customer will be asked to confirm or report a problem.");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(markFinishedBtn);
        } else if (job.completionRequestedAt && !job.dispute) {
          const nudge = document.createElement("div");
          nudge.className = "muted";
          nudge.style.marginBottom = "0.25rem";
          nudge.textContent =
            "Waiting for the customer to confirm. If it has been a while, you can flag an issue.";
          hustlerRow.appendChild(nudge);

          const disputeBtn = document.createElement("button");
          disputeBtn.className = "small-btn outline";
          disputeBtn.textContent = "Customer won‚Äôt confirm completion";
          disputeBtn.addEventListener("click", () => {
            const reason = prompt(
              "Briefly describe the issue (for example, 'Customer not responding')."
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "hustler",
              reason: reason || "Customer not confirming completion",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          hustlerRow.appendChild(disputeBtn);
        }

        if (hustlerRow.children.length > 0) {
          detail.appendChild(hustlerRow);
        }
      }

      // Complete / dispute buttons (customer)
      if (
        user &&
        user.id === job.postedByUserId &&
        job.status === "assigned"
      ) {
        const completeRow = document.createElement("div");
        completeRow.style.marginTop = "0.45rem";

        if (job.completionRequestedAt && !job.dispute) {
          const confirmBtn = document.createElement("button");
          confirmBtn.className = "small-btn";
          confirmBtn.textContent = "Confirm completion";
          confirmBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(confirmBtn);

          const problemBtn = document.createElement("button");
          problemBtn.className = "small-btn outline";
          problemBtn.style.marginLeft = "0.4rem";
          problemBtn.textContent = "Problem with job";
          problemBtn.addEventListener("click", () => {
            const reason = prompt(
              "What went wrong? (e.g., not done, poor quality, other)"
            );
            const message = prompt(
              "Optional: add more details for Hustl support in a live version."
            );
            job.dispute = {
              openedBy: "customer",
              reason: reason || "Issue with job",
              message: message || "",
              openedAt: Date.now(),
            };
            saveState();
            showToast("Issue recorded on this job (demo only).");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(problemBtn);
        } else if (!job.dispute) {
          const completeBtn = document.createElement("button");
          completeBtn.className = "small-btn";
          completeBtn.textContent = "Mark job complete";
          completeBtn.addEventListener("click", () => {
            job.status = "completed";
            job.completionRequestedAt = null;
            job.completionRequesterId = null;
            job.autoCompleted = false;
            saveState();
            showToast("Marked job as completed.");
            renderAll();
            openJobDetails(job.id);
          });
          completeRow.appendChild(completeBtn);
        }

        if (completeRow.children.length > 0) {
          detail.appendChild(completeRow);
        }
      }

      container.appendChild(detail);
    }
    // Demo-only: no real Stripe redirect handling in this prototype
    function handleStripeReturn() {
      // In a real app, you'd look at URL params from Stripe here.
      // For this demo, we do nothing so the rest of the app can run.
    }

   
    /* ---------- Messages view ---------- */

    function renderMessagesView() {
      const user = getCurrentUser();
      const convList = document.getElementById("conversationList");
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      if (!convList) return;

      // Not logged in: nothing to show
      if (!user) {
        convList.innerHTML =
          "<div class='muted'>Log in to see your job conversations.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        return;
      }

      // Jobs that involve this user in ANY way
      const myJobs = state.jobs.filter(
        (j) =>
          j.postedByUserId === user.id ||
          j.acceptedHustlerId === user.id ||
          (j.applicants || []).some((a) => a.userId === user.id)
      );

      convList.innerHTML = "";

      if (myJobs.length === 0) {
        convList.innerHTML =
          "<div class='muted'>No jobs yet. Post or apply to a job to start messaging.</div>";
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        activeConversationJobId = null;
        return;
      }

      // If nothing is selected yet, auto-open the first job
      if (!activeConversationJobId) {
        activeConversationJobId = myJobs[0].id;
      }

      myJobs.forEach((job) => {
        const otherId =
          user.id === job.postedByUserId
            ? job.acceptedHustlerId
            : job.postedByUserId;
        const otherUser =
          otherId && state.users.find((u) => u.id === otherId);

        const item = document.createElement("div");
        item.className = "job-card";
        item.style.cursor = "pointer";
        item.dataset.jobId = job.id;

        // Highlight the active conversation
        if (job.id === activeConversationJobId) {
          item.style.borderColor = "#2563eb";
          item.style.boxShadow = "0 0 0 1px #2563eb20";
        }

        const top = document.createElement("div");
        top.className = "job-card-top";

        const title = document.createElement("div");
        title.className = "job-title";
        title.textContent = job.title;
        top.appendChild(title);

        const status = document.createElement("span");
        status.className = "badge";
        status.textContent =
          job.status === "open"
            ? "Open"
            : job.status === "assigned"
            ? "Assigned"
            : "Completed";
        top.appendChild(status);
        item.appendChild(top);

        const meta = document.createElement("div");
        meta.className = "job-meta";
        meta.textContent =
          (otherUser
            ? "With " + otherUser.name + " ¬∑ "
            : "Job chat ¬∑ ") + timeAgo(job.createdAt);
        item.appendChild(meta);

        item.addEventListener("click", () => {
          activeConversationJobId = job.id;
          // Re-render list (to update highlight) + right-hand chat
          renderMessagesView();
        });

        convList.appendChild(item);
      });

      // Finally, render the messages for the active conversation
      renderConversation();
    }



    function renderConversation() {
      const user = getCurrentUser();
      const job = state.jobs.find((j) => j.id === activeConversationJobId);
      const convTitle = document.getElementById("conversationTitle");
      const convSummary = document.getElementById("conversationJobSummary");
      const convMessages = document.getElementById("conversationMessages");
      if (!job || !user) {
        convTitle.textContent = "Select a conversation";
        convSummary.textContent = "";
        convMessages.innerHTML = "";
        return;
      }

      convTitle.textContent = job.title;
      convSummary.textContent =
        (job.category === "moving"
          ? "üöö moving / hauling ¬∑ "
          : job.category === "yard"
          ? "üåø yard ¬∑ "
          : job.category === "cleaning"
          ? "üßπ cleaning ¬∑ "
          : job.category === "furniture"
          ? "üõ† furniture ¬∑ "
          : "‚≠ê other ¬∑ ") +
        (job.paymentType === "flat"
          ? formatMoney(job.flatAmount || 0) + " flat"
          : formatMoney(job.hourlyRate || 0) +
            "/hr ¬∑ max " +
            (job.maxHours || 0) +
            "h");

      convMessages.innerHTML = "";
      job.chatMessages = job.chatMessages || [];
      job.chatMessages.forEach((m) => {
        const bubble = document.createElement("div");
        bubble.className =
          "chat-msg " + (m.fromUserId === user.id ? "me" : "them");
        bubble.textContent = m.text;
        convMessages.appendChild(bubble);
        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const sender = state.users.find((u) => u.id === m.fromUserId);
        meta.innerHTML = "";
        if (sender) {
          const link = document.createElement("span");
          link.className = "linkish";
          link.textContent = sender.name || "Unknown";
          link.addEventListener("click", () => openUserProfile(sender.id));
          meta.appendChild(link);
        } else {
          meta.append("Unknown");
        }
        meta.append(" ¬∑ " + timeAgo(m.createdAt));

        convMessages.appendChild(meta);
      });
      convMessages.scrollTop = convMessages.scrollHeight;
    }

    function initConversationInput() {
      const sendBtn = document.getElementById("conversationSendButton");
      const input = document.getElementById("conversationInput");
      sendBtn.addEventListener("click", () => {
        const user = getCurrentUser();
        if (!user) {
          showToast("Log in to send messages.");
          return;
        }
        const job = state.jobs.find((j) => j.id === activeConversationJobId);
        if (!job) return;
        const text = input.value.trim();
        if (!text) return;
        job.chatMessages = job.chatMessages || [];
        job.chatMessages.push({
          id: generateId("m"),
          jobId: job.id,
          fromUserId: user.id,
          text,
          createdAt: Date.now(),
        });
        input.value = "";
        saveState();
        renderConversation();
      });
    }

    /* ---------- Profile ---------- */

    function renderProfile() {
  const user = getCurrentUser();
  const container = document.getElementById("profileContent");
  const jobsList = document.getElementById("profileJobsList");
  if (!container || !jobsList) return;

  if (!user) {
    container.innerHTML =
      "<div class='muted'>Log in to see your profile.</div>";
    jobsList.innerHTML = "";
    return;
  }

  // figure out jobs related to this user
  const activeJobs = state.jobs.filter(
    (j) =>
      j.status !== "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );
  const completedJobs = state.jobs.filter(
    (j) =>
      j.status === "completed" &&
      (j.postedByUserId === user.id || j.acceptedHustlerId === user.id)
  );

  const totalEarned = state.jobs.reduce((sum, j) => {
    if (j.acceptedHustlerId === user.id && j.paymentStatus === "paid") {
      return sum + (j.hustlerPayoutAmount || 0);
    }
    return sum;
  }, 0);

  const totalSpent = state.jobs.reduce((sum, j) => {
    if (j.postedByUserId === user.id && j.paymentStatus === "paid") {
      return sum + (j.chargedAmount || 0);
    }
    return sum;
  }, 0);

  container.innerHTML = "";

  // top row: avatar + basic info
  const profileRow = document.createElement("div");
  profileRow.className = "profile-row";

  const avatar = document.createElement("div");
  avatar.className = "profile-avatar";
  if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.src = user.avatarDataUrl;
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  profileRow.appendChild(avatar);

  const info = document.createElement("div");
  info.innerHTML =
    "<strong>" +
    user.name +
    "</strong><br><span class='muted'>" +
    user.email +
    "</span><br><span class='muted'>" +
    (user.role === "customer" ? "Customer" : "Hustler") +
    "</span>";
  profileRow.appendChild(info);

  container.appendChild(profileRow);

  // avatar upload
  const avatarUploadField = document.createElement("div");
  avatarUploadField.className = "field";
  avatarUploadField.innerHTML =
    "<label>Profile photo (demo)</label>" +
    "<input id='avatarUploadInput' type='file' accept='image/*' />";
  container.appendChild(avatarUploadField);

  // about you / bio
  const bioField = document.createElement("div");
  bioField.className = "field";
  bioField.innerHTML =
    "<label for='profileBioInput'>About you (profile bio)</label>" +
    "<textarea id='profileBioInput' placeholder='Tell people a little about yourself. Jobs you like, if you have a truck, experience, etc.'></textarea>" +
    "<button class='btn btn-primary' id='saveBioButton' style='margin-top:0.35rem;'>Save profile</button>";
  container.appendChild(bioField);
// --- Payout preferences (edit in Profile) ---
const payoutWrap = document.createElement("div");
payoutWrap.className = "field";
payoutWrap.style.marginTop = "0.6rem";
payoutWrap.innerHTML = `
  <label>Payout preferences</label>
  <div class="field-inline">
    <div class="field">
      <label for="profilePayoutMethod">Payout method</label>
      <select id="profilePayoutMethod">
        <option value="">Choose one</option>
        <option value="venmo">Venmo</option>
        <option value="cashapp">Cash App</option>
        <option value="zelle">Zelle</option>
      </select>
    </div>
    <div class="field">
      <label for="profilePayoutHandle">Payout handle / account</label>
      <input id="profilePayoutHandle" type="text" placeholder="@username (Venmo/Cash App) or email/phone (Zelle)" />
    </div>
  </div>
  <div class="field" style="margin-top:0.35rem;">
    <label for="profilePayoutName">Payout name (optional; required for Zelle)</label>
    <input id="profilePayoutName" type="text" placeholder="Full name that shows on Zelle (optional for Venmo/Cash App)" />
  </div>
  <button class="btn btn-primary" id="savePayoutButton" style="margin-top:0.35rem;">Save payout preferences</button>
`;
container.appendChild(payoutWrap);

  // if user already has a bio, prefill
setTimeout(() => {
  const bioInput = document.getElementById("profileBioInput");
  if (bioInput) {
    bioInput.value = user.bio || "";
  }

  // Prefill payout fields
  const pm = document.getElementById("profilePayoutMethod");
  const ph = document.getElementById("profilePayoutHandle");
  const pn = document.getElementById("profilePayoutName");
  const payout = user.payout || {};
  if (pm) pm.value = payout.method || "";
  if (ph) ph.value = payout.handle || "";
  if (pn) pn.value = payout.name || "";
}, 0);
  // stats row
  const statsRow = document.createElement("div");
  statsRow.className = "stat-row";

  const statActive = document.createElement("div");
  statActive.className = "stat-card";
  statActive.innerHTML =
    "<div class='stat-label'>Active jobs</div><div class='stat-value'>" +
    activeJobs.length +
    "</div><div class='linkish' id='activeJobsLink'>View</div>";
  statsRow.appendChild(statActive);

  const statCompleted = document.createElement("div");
  statCompleted.className = "stat-card";
  statCompleted.innerHTML =
    "<div class='stat-label'>Completed jobs</div><div class='stat-value'>" +
    completedJobs.length +
    "</div>";
  statsRow.appendChild(statCompleted);

  const statEarned = document.createElement("div");
  statEarned.className = "stat-card";
  statEarned.innerHTML =
    "<div class='stat-label'>Estimated total earned (as Hustler)</div><div class='stat-value'>" +
    formatMoney(totalEarned) +
    "</div>";
  statsRow.appendChild(statEarned);

  const statSpent = document.createElement("div");
  statSpent.className = "stat-card";
  statSpent.innerHTML =
    "<div class='stat-label'>Estimated total spent (as Customer)</div><div class='stat-value'>" +
    formatMoney(totalSpent) +
    "</div>";
  statsRow.appendChild(statSpent);

  container.appendChild(statsRow);

  const note = document.createElement("div");
  note.className = "muted";
  note.textContent =
    "These estimates are based on jobs marked paid/completed in this demo on your device only.";
  container.appendChild(note);

  // ----- RIGHT SIDE: JOBS -----
  jobsList.innerHTML = "";

  // A) Jobs you posted
  const postedHeader = document.createElement("div");
  postedHeader.className = "section-title";
  postedHeader.textContent = "Jobs you posted";
  jobsList.appendChild(postedHeader);

  const myPostedJobs = state.jobs.filter((j) => j.postedByUserId === user.id);
  if (myPostedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven‚Äôt posted any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myPostedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You posted this ¬∑ " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // B) Jobs you're doing as a Hustler
  const doingHeader = document.createElement("div");
  doingHeader.className = "section-title";
  doingHeader.style.marginTop = "0.8rem";
  doingHeader.textContent = "Jobs you‚Äôre doing as a Hustler";
  jobsList.appendChild(doingHeader);

  const myHustlerJobs = state.jobs.filter(
    (j) => j.acceptedHustlerId === user.id
  );

  if (myHustlerJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven‚Äôt been accepted on any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myHustlerJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent = "You‚Äôre the Hustler ¬∑ " + timeAgo(job.createdAt);
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // C) Jobs you've applied for
  const appliedHeader = document.createElement("div");
  appliedHeader.className = "section-title";
  appliedHeader.style.marginTop = "0.8rem";
  appliedHeader.textContent = "Jobs you‚Äôve applied for";
  jobsList.appendChild(appliedHeader);

  const myAppliedJobs = state.jobs.filter((j) =>
    (j.applicants || []).some((a) => a.userId === user.id)
  );

  if (myAppliedJobs.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "You haven‚Äôt applied for any jobs yet.";
    jobsList.appendChild(empty);
  } else {
    myAppliedJobs.forEach((job) => {
      const card = document.createElement("div");
      card.className = "job-card";
      card.dataset.jobId = job.id;

      const top = document.createElement("div");
      top.className = "job-card-top";

      const title = document.createElement("div");
      title.className = "job-title";
      title.textContent = job.title;
      top.appendChild(title);

      const status = document.createElement("span");
      status.className = "badge";
      status.textContent =
        job.status === "open"
          ? "Open"
          : job.status === "assigned"
          ? "Assigned"
          : "Completed";
      top.appendChild(status);

      card.appendChild(top);

      const meta = document.createElement("div");
      meta.className = "job-meta";
      meta.textContent =
        "You applied ¬∑ " +
        timeAgo(job.createdAt) +
        (job.acceptedHustlerId === user.id
          ? " ¬∑ (accepted)"
          : job.status === "assigned"
          ? " ¬∑ (assigned to someone else)"
          : "");
      card.appendChild(meta);

      card.addEventListener("click", () => {
        setView("jobs");
        setTimeout(() => openJobDetails(job.id), 20);
      });

      jobsList.appendChild(card);
    });
  }

  // hook up avatar upload
  const avatarInput = document.getElementById("avatarUploadInput");
  if (avatarInput) {
    avatarInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        user.avatarDataUrl = ev.target.result;
        saveState();
        renderProfile();
      };
      reader.readAsDataURL(file);
    });
  }

  // hook up bio save
  const bioInput = document.getElementById("profileBioInput");
  const saveBioBtn = document.getElementById("saveBioButton");
  if (bioInput && saveBioBtn) {
    saveBioBtn.addEventListener("click", () => {
      user.bio = bioInput.value.trim();
      saveState();
      showToast("Profile updated.");
    });
  }
// hook up payout save
const payoutMethodEl = document.getElementById("profilePayoutMethod");
const payoutHandleEl = document.getElementById("profilePayoutHandle");
const payoutNameEl   = document.getElementById("profilePayoutName");
const savePayoutBtn  = document.getElementById("savePayoutButton");

if (savePayoutBtn && payoutMethodEl && payoutHandleEl && payoutNameEl) {
  savePayoutBtn.addEventListener("click", () => {
    const method = payoutMethodEl.value;
    const handle = (payoutHandleEl.value || "").trim();
    const name   = (payoutNameEl.value || "").trim();

    if (!method) {
      showToast("Choose a payout method.");
      return;
    }
    if (!handle) {
      showToast("Enter your payout handle/account.");
      return;
    }
    if (method === "zelle" && !name) {
      showToast("Enter the payout name used on your Zelle account.");
      return;
    }

    user.payout = {
      method,                     // "venmo" | "cashapp" | "zelle"
      handle,                     // @handle or phone/email
      name: name || null          // optional (but required for Zelle above)
    };
    saveState();
    showToast("Payout preferences saved.");
  });
}

  // hook up "View active jobs"
  const activeLink = document.getElementById("activeJobsLink");
  if (activeLink) {
    activeLink.addEventListener("click", () => {
      setView("jobs");
      activeJobsStatusFilter = "open";
      renderJobs(true); // Reset pagination when filter changes
    });
  }
}

    /* ---------- Feedback ---------- */

    function initFeedback() {
      const btn = document.getElementById("feedbackButton");
      btn.addEventListener("click", () => {
        const name = document.getElementById("feedbackName").value.trim();
        const email = document.getElementById("feedbackEmail").value.trim();
        const message = document
          .getElementById("feedbackMessage")
          .value.trim();
        if (!message) {
          showToast("Please type a bit of feedback first.");
          return;
        }
        state.feedback.push({
          id: generateId("f"),
          name,
          email,
          message,
          createdAt: Date.now(),
        });
        saveState();
        document.getElementById("feedbackMessage").value = "";
        showToast("Feedback saved (demo). In a live app this would email Hustl.");
      });
    }

   /* ---------- Footer links ---------- */

function initFooterLinks() {
  document
    .getElementById("footerTermsLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });

  document
    .getElementById("footerPrivacyLink")
    .addEventListener("click", () => {
      // Go to a separate Terms page
      window.location.href = "terms.html";
    });
}

   /* ---------- Public profile popup ---------- */
function openUserProfile(userId) {
  const user = state.users.find((u) => u.id === userId);
  if (!user) return showToast("User not found (demo).");

  // remove any existing popup
  const existing = document.getElementById("profilePopupOverlay");
  if (existing) existing.remove();

  const overlay = document.createElement("div");
  overlay.id = "profilePopupOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(15,23,42,0.55)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.zIndex = "80";

  const card = document.createElement("div");
  card.className = "card";
  card.style.maxWidth = "360px";
  card.style.width = "90%";

  // Header
  const header = document.createElement("div");
  header.className = "card-header";
  const title = document.createElement("div");
  title.className = "card-title";
  title.textContent = user.name || "Profile";
  const closeBtn = document.createElement("button");
  closeBtn.className = "small-btn outline";
  closeBtn.textContent = "Close";
  closeBtn.addEventListener("click", () => overlay.remove());
  header.appendChild(title);
  header.appendChild(closeBtn);
  card.appendChild(header);

  // Avatar + basic info (role only, no money / jobs / email)
  const row = document.createElement("div");
  row.className = "profile-row";

  const avatar = document.createElement("div");
  avatar.className = "profile-avatar";
  if (user.avatarDataUrl) {
    const img = document.createElement("img");
    img.src = user.avatarDataUrl;
    avatar.appendChild(img);
  } else {
    avatar.textContent = user.name ? user.name[0].toUpperCase() : "?";
  }
  row.appendChild(avatar);

  const info = document.createElement("div");
  info.innerHTML =
    "<span class='muted'>" +
    (user.role === "hustler" ? "Hustler" : "Customer") +
    "</span>";
  row.appendChild(info);

  card.appendChild(row);

  // Bio / description
  const bioWrap = document.createElement("div");
  bioWrap.className = "field";
  bioWrap.style.marginTop = "0.6rem";

  const bioLabel = document.createElement("div");
  bioLabel.className = "stat-label";
  bioLabel.textContent = "About this person";
  bioWrap.appendChild(bioLabel);

  const bioText = document.createElement("div");
  bioText.className = "about-text";
  bioText.textContent =
    user.bio || "This person hasn‚Äôt added anything about themselves yet.";
  bioWrap.appendChild(bioText);

  card.appendChild(bioWrap);

  // Reviews (demo only ‚Äì will show once we start filling user.reviews)
  const reviewsWrap = document.createElement("div");
  reviewsWrap.className = "field";
  reviewsWrap.style.marginTop = "0.6rem";

  const reviewLabel = document.createElement("div");
  reviewLabel.className = "stat-label";
  reviewLabel.textContent = "Reviews";
  reviewsWrap.appendChild(reviewLabel);

  const reviews = user.reviews || [];
  if (reviews.length === 0) {
    const empty = document.createElement("div");
    empty.className = "muted";
    empty.textContent = "No reviews yet.";
    reviewsWrap.appendChild(empty);
  } else {
    reviews.forEach((r) => {
      const rCard = document.createElement("div");
      rCard.className = "stat-card";
      rCard.style.marginTop = "0.35rem";

      const top = document.createElement("div");
      top.className = "stat-value";
      top.style.fontSize = "0.8rem";
      top.textContent = (r.rating ? "‚òÖ".repeat(r.rating) + " ¬∑ " : "") + (r.fromName || "Someone on Hustl");
      rCard.appendChild(top);

      const body = document.createElement("div");
      body.className = "muted";
      body.style.marginTop = "0.2rem";
      body.textContent = r.text || "";
      rCard.appendChild(body);

      reviewsWrap.appendChild(rCard);
    });
  }

  card.appendChild(reviewsWrap);

  overlay.appendChild(card);
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) overlay.remove();
  });

  document.body.appendChild(overlay);
}


    /* ---------- Owner view ---------- */

    function renderOwnerView() {
      const user = getCurrentUser();
      const tab = document.getElementById("ownerTab");
      const view = document.getElementById("view-owner");
      const paidList = document.getElementById("ownerPaidList");
      const assignedList = document.getElementById("ownerAssignedList");

      const isOwner = !!(user && user.email && user.email.toLowerCase() === "team.hustlapp@outlook.com");
      if (tab) tab.style.display = isOwner ? "" : "none";
      if (!isOwner) {
        if (view) view.style.display = "none";
        return;
      }

      // Paid jobs
      const paidJobs = state.jobs.filter(j => j.paymentStatus === "paid");
      if (paidList) {
        paidList.innerHTML = "";
        if (paidJobs.length === 0) {
          paidList.innerHTML = "<div class='muted'>No paid jobs yet.</div>";
        } else {
          paidJobs.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
           const custUser = state.users.find(u => u.id === j.postedByUserId);
const hustUser = state.users.find(u => u.id === j.acceptedHustlerId);
const cust = custUser?.name || "Customer";
const hust = hustUser?.name || "Hustler";

let payoutInfo = "";
if (hustUser && hustUser.payoutMethod && hustUser.payoutHandle) {
  const label =
    hustUser.payoutMethod === "venmo" ? "Venmo" :
    hustUser.payoutMethod === "cashapp" ? "Cash App" :
    hustUser.payoutMethod === "zelle" ? "Zelle" : "Payout";
  payoutInfo = ` ¬∑ ${label}: ${hustUser.payoutHandle}`;
}

meta.textContent =
  `Paid ${formatMoney(j.chargedAmount || 0)} ¬∑ Your fee ${formatMoney(j.platformFeeAmount || 0)} ¬∑ ${cust} ‚Üí ${hust}${payoutInfo}`;
            row.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "job-card-actions";

            const left = document.createElement("div");
            const payoutBadge = document.createElement("span");
            payoutBadge.className = "badge";
            if (j.adminPayoutDone) {
              payoutBadge.classList.add("status-completed");
              payoutBadge.textContent = "Payout marked done";
            } else {
              payoutBadge.classList.add("status-assigned");
              payoutBadge.textContent = "Payout pending";
            }
            left.appendChild(payoutBadge);

            const right = document.createElement("div");
            const markBtn = document.createElement("button");
            markBtn.className = "small-btn";
            markBtn.textContent = j.adminPayoutDone ? "Unmark payout" : "Mark payout done";
            markBtn.addEventListener("click", () => {
              j.adminPayoutDone = !j.adminPayoutDone;
              saveState();
              showToast(j.adminPayoutDone ? "Marked payout done." : "Payout unmarked.");
              renderOwnerView();
            });
            right.appendChild(markBtn);

            actions.appendChild(left);
            actions.appendChild(right);
            row.appendChild(actions);

            paidList.appendChild(row);
          });
        }
      }

      // Assigned but not paid
      const assigned = state.jobs.filter(j => j.status === "assigned" && j.paymentStatus !== "paid");
      if (assignedList) {
        assignedList.innerHTML = "";
        if (assigned.length === 0) {
          assignedList.innerHTML = "<div class='muted'>No assigned-but-unpaid jobs.</div>";
        } else {
          assigned.forEach(j => {
            const row = document.createElement("div");
            row.className = "job-card";

            const title = document.createElement("div");
            title.className = "job-title";
            title.textContent = j.title;
            row.appendChild(title);

            const meta = document.createElement("div");
            meta.className = "job-meta";
            const cust = state.users.find(u => u.id === j.postedByUserId)?.name || "Customer";
            const hust = state.users.find(u => u.id === j.acceptedHustlerId)?.name || "Hustler";
            meta.textContent = `Assigned ¬∑ ${cust} ‚Üî ${hust} ¬∑ posted ${timeAgo(j.createdAt)}`;
            row.appendChild(meta);

            assignedList.appendChild(row);
          });
        }
      }
    }

    /* ---------- Main render ---------- */

    function renderAll() {
      renderAuthPill();
      renderAuthSectionVisibility();
      renderOwnerView();

      if (activeView === "jobs") {
        renderJobs();
      } else if (activeView === "messages") {
        renderMessagesView();
      } else if (activeView === "profile") {
        renderProfile();
      } else if (activeView === "owner") {
        renderOwnerView();
      }
    }

    /* ---------- Init ---------- */

    function initNav() {
      document.querySelectorAll(".nav-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const v = tab.dataset.view;
          setView(v);
        });
      });

      document
        .getElementById("homeCtaPost")
        .addEventListener("click", () => {
          setView("post");
          const formCard = document.getElementById("jobFormCard");
          if (formCard) {
            formCard.scrollIntoView({ behavior: "smooth" });
          }
        });
      document
        .getElementById("homeCtaBrowse")
        .addEventListener("click", () => setView("jobs"));

      document
        .getElementById("jobsStatusFilter")
        .querySelectorAll("span")
        .forEach((el) => {
          el.addEventListener("click", () => {
            activeJobsStatusFilter = el.dataset.status;
            document
              .getElementById("jobsStatusFilter")
              .querySelectorAll("span")
              .forEach((s) =>
                s.classList.toggle("active", s.dataset.status === activeJobsStatusFilter)
              );
            renderJobs(true); // Reset pagination when filter changes
          });
        });
    }
async function startPayment(jobId) {
  const job = state.jobs.find((j) => j.id === jobId);
  const user = getCurrentUser();

  if (!job || !user || user.id !== job.postedByUserId) {
    showToast("Only the customer who posted can pay for this job.");
    return;
  }

  if (!job.acceptedHustlerId) {
    showToast("Accept a Hustler before paying.");
    return;
  }

  // Calculate total
  let total = 0;
  if (job.paymentType === "flat") {
    total = job.flatAmount || 0;
  } else {
    total = (job.hourlyRate || 0) * (job.maxHours || 0);
  }

  if (total <= 0) {
    showToast("Job total must be greater than zero.");
    return;
  }

  // Stripe expects amount in cents
  const platformPercent = 0.15; // 15% cut
  const platformFee = Math.round(total * platformPercent);
  const amountToCharge = total * 100; // Convert to cents

  try {
    const res = await fetch("http://localhost:8080/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        amountTotalCents: amountToCharge,
        customerEmail: user.email,
        description: `Hustl job payment for: ${job.title}`,
      }),
    });

    const data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      showToast("Failed to start Stripe Checkout session.");
    }
  } catch (err) {
    console.error("Payment error:", err);
    showToast("Error connecting to payment server.");
  }
}

    // Boot
    loadState();
    initAgeGate();
    initNav();
    initAuthCard();
    initJobsForm();
    initConversationInput();
    initFeedback();
    initFooterLinks();
    checkAgeGate();
    handleStripeReturn();
    checkAutoCompleteJobs();
    setInterval(checkAutoCompleteJobs, 60 * 1000);
    renderAll();
  </script>
</body>
</html>


