// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  HUSTLER
  ADMIN
}

enum IdVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum JobStatus {
  OPEN
  REQUESTED
  ASSIGNED
  SCHEDULED
  IN_PROGRESS
  COMPLETED_BY_HUSTLER
  AWAITING_CUSTOMER_CONFIRM
  PAID
  CANCELLED
  EXPIRED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum PaymentStatus {
  PREAUTHORIZED
  CAPTURED
  REFUNDED
  VOIDED
}

model User {
  id                    String                @id @default(cuid())
  email                 String                @unique
  passwordHash          String                @map("password_hash")
  name                  String
  username              String                @unique
  city                  String
  zip                   String
  photoUrl              String?               @map("photo_url")
  bio                   String?               @db.Text
  gender                String?               // "male", "female", "other", "prefer_not_to_say"
  tools                 String?               @db.Text // Tools/equipment user has available
  roles                 UserRole[]            @default([CUSTOMER])
  ratingAvg             Float                 @default(0) @map("rating_avg")
  ratingCount           Int                   @default(0) @map("rating_count")
  idVerified            Boolean               @default(false) @map("id_verified")
  stripeAccountId      String?               @map("stripe_account_id") // Stripe Connect account ID
  emailVerified         Boolean               @default(false) @map("email_verified")
  emailVerificationCode String?               @map("email_verification_code")
  emailVerificationExpiry DateTime?           @map("email_verification_expiry")
  referralCode          String?               @unique @map("referral_code")
  referredByUserId      String?               @map("referred_by_user_id")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relations
  jobsAsCustomer        Job[]                 @relation("CustomerJobs")
  jobsAsHustler         Job[]                 @relation("HustlerJobs")
  locationUpdates       LocationUpdate[]      @relation("UserLocationUpdates")
  offers                Offer[]               @relation("UserOffers")
  reviewsReceived       Review[]              @relation("Reviewee")
  reviewsGiven          Review[]              @relation("Reviewer")
  messagesSent          Message[]             @relation("UserMessages")
  threadsAsA            Thread[]              @relation("UserA")
  threadsAsB            Thread[]              @relation("UserB")
  paymentsAsCustomer    Payment[]             @relation("CustomerPayments")
  paymentsAsHustler     Payment[]             @relation("HustlerPayments")
  payouts               Payout[]              @relation("HustlerPayouts")
  referrals            Referral[]            @relation("Referrer")
  referredBy            User?                 @relation("ReferredBy", fields: [referredByUserId], references: [id])
  referredUsers         User[]                @relation("ReferredBy")
  referredAs            Referral?             @relation("ReferredUser")

  @@index([email])
  @@index([username])
  @@index([city, zip])
  @@index([referralCode])
  @@index([referredByUserId])
  @@map("users")
}

model Job {
  id                    String                @id @default(cuid())
  customerId            String                @map("customer_id")
  title                 String
  category              String
  description           String                @db.Text
  photos                String[]              @default([])
  address               String
  lat                   Float?
  lng                   Float?
  // Approximate location (for privacy - shown before acceptance)
  approximateLat        Float?                 @map("approximate_lat")
  approximateLng        Float?                 @map("approximate_lng")
  // Exact address (only shared after acceptance)
  exactAddress          String?                @map("exact_address") @db.Text
  date                  DateTime
  startTime             DateTime              @map("start_time")
  endTime               DateTime              @map("end_time")
  payType               String                @map("pay_type") // "flat" | "hourly"
  amount                Decimal               @db.Decimal(10, 2)
  hourlyRate            Decimal?              @map("hourly_rate") @db.Decimal(10, 2)
  estHours              Int?                  @map("est_hours")
  requirements          Json                  // { vehicle, stairs, team_size }
  status                JobStatus             @default(OPEN)
  hustlerId             String?               @map("hustler_id")
  // Verification codes (6-digit codes for safety)
  startCode             String?               @map("start_code")          // 6-digit code customer gives hustler to start job
  startCodeVerified     Boolean               @default(false) @map("start_code_verified")
  startCodeExpiresAt    DateTime?             @map("start_code_expires_at") // 78 hours from acceptance
  completionCode        String?               @map("completion_code")     // 6-digit code hustler gives customer to complete
  completionCodeVerified Boolean              @default(false) @map("completion_verified")
  // Legacy fields (deprecated, kept for migration)
  arrivalCode           String?               @map("arrival_code")
  arrivalCodeVerified   Boolean               @default(false) @map("arrival_verified")
  // Recurring job fields
  parentJobId           String?               @map("parent_job_id")
  recurrenceType        String?               @map("recurrence_type") // "weekly" | "monthly" | null
  recurrenceEndDate     DateTime?             @map("recurrence_end_date")
  recurrencePaused      Boolean               @default(false) @map("recurrence_paused")
  nextRecurrenceDate    DateTime?             @map("next_recurrence_date")
  expiresAt             DateTime?             @map("expires_at") // Job expiration timestamp (UTC)
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relations
  customer              User                  @relation("CustomerJobs", fields: [customerId], references: [id])
  hustler               User?                 @relation("HustlerJobs", fields: [hustlerId], references: [id])
  offers                Offer[]
  thread                Thread?
  payment                Payment?
  payout                 Payout?
  reviews                Review[]
  locationUpdates        LocationUpdate[]
  parentJob             Job?                  @relation("RecurringJobs", fields: [parentJobId], references: [id])
  recurringJobs         Job[]                 @relation("RecurringJobs")

  @@index([customerId])
  @@index([hustlerId])
  @@index([status])
  @@index([category])
  @@index([date])
  @@index([lat, lng])
  @@index([approximateLat, approximateLng])
  @@index([parentJobId])
  @@index([recurrenceType])
  @@index([nextRecurrenceDate])
  @@map("jobs")
}

model Offer {
  id                    String                @id @default(cuid())
  jobId                 String                @map("job_id")
  hustlerId             String                @map("hustler_id")
  note                  String?               @db.Text
  proposedAmount        Decimal?              @map("proposed_amount") @db.Decimal(10, 2)
  status                OfferStatus           @default(PENDING)
  createdAt             DateTime              @default(now()) @map("created_at")

  // Relations
  job                   Job                   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  hustler               User                  @relation("UserOffers", fields: [hustlerId], references: [id])

  @@index([jobId])
  @@index([hustlerId])
  @@index([status])
  @@map("offers")
}

model Thread {
  id                    String                @id @default(cuid())
  jobId                 String                @unique @map("job_id")
  userAId               String                @map("user_a_id")
  userBId               String                @map("user_b_id")
  lastMessageAt         DateTime?             @map("last_message_at")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relations
  job                   Job                   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userA                 User                  @relation("UserA", fields: [userAId], references: [id])
  userB                 User                  @relation("UserB", fields: [userBId], references: [id])
  messages               Message[]

  @@index([userAId, userBId])
  @@index([jobId])
  @@map("threads")
}

model Message {
  id                    String                @id @default(cuid())
  threadId              String                @map("thread_id")
  senderId              String                @map("sender_id")
  body                  String                @db.Text
  attachments           String[]              @default([])
  read                  Boolean               @default(false)
  readAt                DateTime?             @map("read_at")
  readBy                String?               @map("read_by")
  createdAt             DateTime              @default(now()) @map("created_at")

  // Relations
  thread                Thread                @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender                User                  @relation("UserMessages", fields: [senderId], references: [id])

  @@index([threadId])
  @@index([senderId])
  @@index([createdAt])
  @@index([read])
  @@map("messages")
}

model Review {
  id                    String                @id @default(cuid())
  reviewerId            String                @map("reviewer_id")
  revieweeId            String                @map("reviewee_id")
  jobId                 String                @map("job_id")
  stars                 Int                   // 1-5
  text                  String                @db.Text
  photos                String[]              @default([])
  isHidden              Boolean               @default(false) @map("is_hidden")
  createdAt             DateTime              @default(now()) @map("created_at")

  // Relations
  reviewer              User                  @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewee              User                  @relation("Reviewee", fields: [revieweeId], references: [id])
  job                   Job                   @relation(fields: [jobId], references: [id])

  @@index([reviewerId])
  @@index([revieweeId])
  @@index([jobId])
  @@index([isHidden])
  @@map("reviews")
}

model Payment {
  id                    String                @id @default(cuid())
  jobId                 String                @unique @map("job_id")
  customerId            String                @map("customer_id")
  hustlerId             String                @map("hustler_id")
  amount                Decimal               @db.Decimal(10, 2)
  tip                   Decimal               @default(0) @db.Decimal(10, 2)
  feeCustomer           Decimal               @map("fee_customer") @db.Decimal(10, 2)
  feeHustler            Decimal               @map("fee_hustler") @db.Decimal(10, 2)
  platformFee           Decimal?              @map("platform_fee") @db.Decimal(10, 2) // Platform fee (12% of amount)
  total                 Decimal               @db.Decimal(10, 2)
  status                PaymentStatus         @default(PREAUTHORIZED)
  providerId            String?               @map("provider_id") // Stripe payment intent ID
  tipPaymentIntentId    String?               @map("tip_payment_intent_id") // Stripe payment intent ID for tip
  receiptUrl            String?               @map("receipt_url")
  refundAmount          Decimal?              @map("refund_amount") @db.Decimal(10, 2)
  refundReason          String?               @map("refund_reason") @db.Text
  tipAddedAt            DateTime?             @map("tip_added_at")
  capturedAt            DateTime?              @map("captured_at")
  created_at            DateTime              @default(now()) @map("created_at")

  // Relations
  job                   Job                   @relation(fields: [jobId], references: [id])
  customer              User                  @relation("CustomerPayments", fields: [customerId], references: [id])
  hustler               User                  @relation("HustlerPayments", fields: [hustlerId], references: [id])

  @@index([customerId])
  @@index([hustlerId])
  @@index([status])
  @@index([providerId])
  @@index([capturedAt])
  @@map("payments")
}

model Referral {
  id                    String                @id @default(cuid())
  referrerId            String                @map("referrer_id")
  referredUserId        String                @unique @map("referred_user_id")
  rewardAmount          Decimal               @default(0) @map("reward_amount") @db.Decimal(10, 2)
  rewardStatus          String                @default("PENDING") @map("reward_status") // PENDING, EARNED, PAID
  referredUserCompletedJob Boolean            @default(false) @map("referred_user_completed_job")
  createdAt             DateTime              @default(now()) @map("created_at")
  rewardedAt            DateTime?             @map("rewarded_at")
  paidAt                DateTime?             @map("paid_at")

  // Relations
  referrer              User                  @relation("Referrer", fields: [referrerId], references: [id])
  referredUser          User                  @relation("ReferredUser", fields: [referredUserId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@index([rewardStatus])
  @@map("referrals")
}

model LocationUpdate {
  id                    String                @id @default(cuid())
  jobId                 String                @map("job_id")
  hustlerId             String                @map("hustler_id")
  lat                   Float
  lng                   Float
  accuracy              Float?                // GPS accuracy in meters
  heading               Float?                // Direction in degrees (0-360)
  speed                 Float?                // Speed in m/s
  timestamp             DateTime              @default(now()) @map("timestamp")
  createdAt             DateTime              @default(now()) @map("created_at")

  // Relations
  job                   Job                   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  hustler               User                  @relation("UserLocationUpdates", fields: [hustlerId], references: [id])

  @@index([jobId])
  @@index([hustlerId])
  @@index([timestamp])
  @@map("location_updates")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Payout {
  id                    String                @id @default(cuid())
  hustlerId             String                @map("hustler_id")
  jobId                 String                @unique @map("job_id")
  amount                Decimal               @db.Decimal(10, 2) // Gross amount before fees
  platformFee           Decimal               @map("platform_fee") @db.Decimal(10, 2) // 12% platform fee
  netAmount             Decimal               @map("net_amount") @db.Decimal(10, 2) // Amount after platform fee
  status                PayoutStatus          @default(PENDING)
  payoutProviderId      String?               @map("payout_provider_id") // Stripe transfer ID
  payoutMethod          String                @default("STRIPE_TRANSFER") @map("payout_method")
  createdAt             DateTime              @default(now()) @map("created_at")
  completedAt           DateTime?             @map("completed_at")

  // Relations
  hustler               User                  @relation("HustlerPayouts", fields: [hustlerId], references: [id])
  job                   Job                   @relation("JobPayouts", fields: [jobId], references: [id])

  @@index([hustlerId])
  @@index([jobId])
  @@index([status])
  @@index([completedAt])
  @@map("payouts")
}

enum AuditActionType {
  REFUND
  PAYOUT
  PAYMENT_CAPTURE
  PAYMENT_VOID
  JOB_CANCEL
  JOB_COMPLETE
  USER_BAN
  USER_UNBAN
  ADMIN_ACTION
}

enum AuditResourceType {
  PAYMENT
  PAYOUT
  JOB
  USER
  OFFER
}

model AuditLog {
  id                    String                @id @default(cuid())
  actorId               String                @map("actor_id") // User ID who performed the action
  actionType            AuditActionType       @map("action_type")
  resourceType          AuditResourceType     @map("resource_type")
  resourceId            String                @map("resource_id")
  details               Json                  // Additional details about the action
  createdAt             DateTime              @default(now()) @map("created_at")

  @@index([actorId])
  @@index([actionType])
  @@index([resourceType])
  @@index([resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

